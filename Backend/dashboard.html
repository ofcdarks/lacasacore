<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - La Casa Dark Core</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Premium: Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- √çcones (Lucide Icons) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* --- ESTILOS GLOBAIS --- */
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            /* Desativa a sele√ß√£o de texto */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Padr√£o */
        }
        .brand-title {
            font-weight: 500;
            color: #6b7280;
        }
        .brand-title-core {
            font-weight: 800;
            color: #f59e0b;
            letter-spacing: 0.05em;
        }

        /* --- COMPONENTES DE UI --- */
        .loader {
            border: 4px solid #374151; /* gray-700 */
            border-top: 4px solid #f59e0b; /* amber-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .btn-spinner {
             border: 2px solid #f3f4f6; /* gray-100 */
             border-top: 2px solid #f59e0b; /* amber-500 */
             border-radius: 50%;
             width: 16px;
             height: 16px;
             animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- FORMUL√ÅRIOS E INPUTS --- */
        select.styled-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em;
            padding-right: 2.5rem; /* Espa√ßo para a seta */
        }
        
        optgroup {
            font-weight: 700;
            font-style: normal;
            background-color: #1f2937; /* gray-800 */
            color: #f59e0b; /* amber-500 */
        }
        option {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            padding: 8px;
        }

        /* --- MENSAGENS E ALERTAS --- */
        .error-message {
            background-color: #450a0a;
            color: #fecaca;
            border: 1px solid #991b1b;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.875rem;
            display: none;
        }
        .success-message {
            background-color: #064e3b;
            color: #d1fae5;
            border: 1px solid #047857;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
        }
        
        /* --- SEPARA√á√ÉO DE VIEWS --- */
        [id^="view-"] {
            position: relative;
            isolation: isolate;
        }
        
        [id^="view-"]:not(.active) {
            display: none !important;
        }
        
        .admin-tab-content {
            position: relative;
            isolation: isolate;
        }
        
        .admin-tab-content:not([style*="display: block"]) {
            display: none !important;
        }
        .success-message ul {
            margin-top: 8px;
            list-style: disc;
            padding-left: 20px;
        }
        .success-message li.valid {
            color: #a7f3d0;
        }
        .success-message li.invalid {
            color: #fecaca;
            font-weight: 600;
        }

        /* --- ANIMA√á√ïES PARA MODAL --- */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-scale-in {
            animation: scaleIn 0.3s ease-out forwards;
            opacity: 0;
            transform: scale(0.9);
        }

        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }

        /* --- CARDS E LAYOUT (AN√ÅLISE) --- */
        .niche-tag {
            background-color: #3f3f46;
            color: #d4d4d8;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #52525b;
        }
        .niche-tag strong {
            color: #f59e0b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            display: block;
            margin-bottom: 2px;
        }
        
        /* Estilos para abas do admin */
        .admin-tab-btn.active {
            border-bottom-color: #f59e0b !important;
            color: #f59e0b !important;
        }
        
        /* Anima√ß√£o pulsante para bot√µes de comprar cr√©ditos */
        @keyframes pulse-credits {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
                transform: scale(1.02);
            }
        }
        
        .btn-credits-pulse {
            animation: pulse-credits 2s ease-in-out infinite;
        }
        
        /* Modal customizado */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease-out;
        }
        
        .custom-modal {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.98) 0%, rgba(15, 15, 15, 0.98) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(245, 158, 11, 0.2);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            position: relative;
        }
        
        .custom-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .custom-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .custom-modal-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .custom-modal-close:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .custom-modal-body {
            padding: 24px;
        }
        
        .custom-modal-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .custom-modal-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.2s;
        }
        
        .custom-modal-input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        .custom-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .custom-modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .custom-modal-btn-primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000000;
        }
        
        .custom-modal-btn-primary:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .custom-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .custom-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Notifica√ß√µes */
        .notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }
        
        .notification {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.98) 0%, rgba(15, 15, 15, 0.98) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6), 0 0 20px rgba(245, 158, 11, 0.15);
            animation: slideInRight 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f59e0b, #d97706);
            animation: shimmer 2s linear infinite;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .notification-icon {
            width: 20px;
            height: 20px;
            color: #f59e0b;
        }
        
        .notification-title {
            font-weight: 700;
            color: #ffffff;
            font-size: 14px;
        }
        
        .notification-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.5;
        }
        
        .notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .notification-close:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Responsividade Mobile */
        @media (max-width: 1024px) {
            .admin-tab-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
            .admin-tab-btn i {
                width: 14px;
                height: 14px;
            }
        }
        
        @media (max-width: 768px) {
            /* Sidebar mobile */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            
            /* Tabelas responsivas */
            table {
                font-size: 0.75rem;
            }
            table th, table td {
                padding: 0.5rem 0.25rem;
            }
            
            /* Cards em grid */
            .grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Admin tabs */
            .admin-tabs-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .admin-tabs-nav::-webkit-scrollbar {
                display: none;
            }
            .admin-tab-btn {
                white-space: nowrap;
                font-size: 0.7rem;
                padding: 0.5rem;
                min-width: fit-content;
            }
            
            /* Modais */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 1rem;
            }
            
            /* Notifica√ß√µes */
            .notification {
                width: calc(100% - 2rem);
                max-width: 400px;
            }
        }
        
        @media (max-width: 640px) {
            .notification-container {
                right: 10px;
                bottom: 10px;
                max-width: calc(100% - 20px);
            }
        }
    </style>
</head>
<body class="bg-black text-gray-300">

    <!-- Script de Prote√ß√£o de Rota -->
    <script>
        const token = localStorage.getItem('core_token');
        if (!token || token === 'undefined') {
            localStorage.removeItem('core_token');
            window.location.href = 'la-casa-dark-core-auth.html';
        }
    </script>

    <!-- Overlay para o menu mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 hidden md:hidden"></div>

    <div class="flex min-h-screen">
        <!-- Barra Lateral (Sidebar) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-900 border-r border-gray-800 p-6 flex flex-col
                         transform -translate-x-full transition-transform duration-300 ease-in-out
                         md:relative md:translate-x-0 md:flex">
            <!-- Logo -->
            <div class="text-center mb-10">
                <h1 class="text-2xl brand-title">
                    La Casa Dark
                    <span class="brand-title-core">CORE</span>
                </h1>
            </div>
            
            <!-- Navega√ß√£o -->
            <nav id="main-nav" class="flex-1 space-y-2">
                <a href="#" data-view="inicio" class="flex items-center space-x-3 px-4 py-3 bg-amber-600 text-black rounded-lg font-bold">
                    <i data-lucide="layout-dashboard"></i>
                    <span>In√≠cio</span>
                </a>
                <a href="#" data-view="analisador" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="youtube"></i>
                    <span>Analisador de V√≠deos</span>
                </a>
                <a href="#" data-view="explorar-nicho" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="compass"></i>
                    <span>Explorar Nicho</span>
                </a>
                <a href="#" data-view="historico" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="history"></i>
                    <span>Pastas e Hist√≥rico</span>
                </a>
                
                <a href="#" data-view="canais" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="target"></i>
                    <span>Canais Monitorados</span>
                </a>
                
                <a href="#" data-view="analytics" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="bar-chart-2"></i>
                    <span>Analytics</span>
                </a>
                
                <a href="#" data-view="biblioteca" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="book-open"></i>
                    <span>Biblioteca Virais</span>
                </a>
                
                <a href="#" data-view="viral-agents" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="bot"></i>
                    <span>Agentes Virais</span>
                </a>
                
                <a href="#" data-view="prompts-imagens" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="image"></i>
                    <span>Prompts e Imagens</span>
                </a>
                
                <a href="#" data-view="gerador-voz" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="mic"></i>
                    <span>Gerador de Voz</span>
                </a>
                
                <a href="#" data-view="imagens-lote" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="images"></i>
                    <span>Imagens em Lote</span>
                </a>
                
                <a href="#" data-view="gerador-video" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="video"></i>
                    <span>Gerador de V√≠deo</span>
                </a>
                
                <a href="#" data-view="youtube-integration" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="youtube"></i>
                    <span>Integra√ß√£o YouTube</span>
                </a>
                
                <a href="#" data-view="configuracoes" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="settings"></i>
                    <span>Configura√ß√µes</span>
                </a>
                
                <!-- Exibi√ß√£o de Cr√©ditos no Sidebar -->
                <div class="mt-4 px-4 py-3 bg-gray-800 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="coins" class="w-4 h-4 text-yellow-500"></i>
                            <span class="text-xs font-medium text-gray-400">Cr√©ditos</span>
                        </div>
                    </div>
                    <p class="text-lg font-bold text-yellow-400" id="sidebar-user-credits-balance">0.00</p>
                    <div class="mt-2 space-y-2">
                        <a href="javascript:void(0)" id="sidebar-buy-credits-btn" class="block w-full px-3 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-xs font-semibold rounded-lg transition duration-200 text-center cursor-pointer btn-credits-pulse">
                            <i data-lucide="zap" class="w-3 h-3 inline-block mr-1"></i>
                            Comprar Cr√©ditos
                        </a>
                        <button id="sidebar-view-credits-history" class="w-full text-xs text-yellow-400 hover:text-yellow-300 underline text-left">
                        Ver Hist√≥rico
                    </button>
                    </div>
                </div>
                
                <!-- Armazenamento no Sidebar -->
                <div class="mt-4 px-4 py-3 bg-gray-800 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="hard-drive" class="w-4 h-4 text-indigo-500"></i>
                            <span class="text-xs font-medium text-gray-400">Armazenamento</span>
                        </div>
                    </div>
                    <p class="text-sm font-bold text-white" id="sidebar-storage-used">0 MB</p>
                    <p class="text-xs text-gray-500" id="sidebar-storage-limit">de 10 MB</p>
                    <div class="mt-2">
                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                            <div class="bg-indigo-500 h-1.5 rounded-full transition-all duration-300" id="sidebar-storage-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Link do Painel Admin (Oculto por padr√£o) -->
                <a href="#" data-view="admin" id="admin-nav-link" style="display: none;"
                   class="flex items-center space-x-3 px-4 py-3 text-red-400 hover:bg-gray-800 hover:text-red-300 rounded-lg transition duration-200 font-medium">
                    <i data-lucide="shield-check"></i>
                    <span>Painel Admin</span>
                </a>
            </nav>

            <!-- Logout -->
            <div>
                <button id="logout-button" class="flex items-center space-x-3 px-4 py-3 w-full text-left text-red-500 hover:bg-red-900 hover:text-red-300 rounded-lg transition duration-200 font-medium">
                    <i data-lucide="log-out"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <!-- Conte√∫do Principal -->
        <main class="flex-1 p-6 md:p-10 w-full overflow-x-hidden max-w-7xl mx-auto">

            <!-- Header Mobile com bot√£o Hamburger -->
            <header class="mb-6 md:hidden flex items-center justify-between">
                <button id="hamburger-button" class="p-2 text-gray-400 hover:text-white rounded-lg">
                    <i data-lucide="menu" class="h-6 w-6"></i>
                </button>
                <div class="text-center">
                    <h1 class="text-xl brand-title">
                        La Casa Dark
                        <span class="brand-title-core">CORE</span>
                    </h1>
                </div>
                <div class="w-8"></div> <!-- Espa√ßador -->
            </header>

            <!-- VIS√ÉO 1: In√≠cio (Vis√≠vel por padr√£o) -->
            <div id="view-inicio">
                <header class="mb-8">
                    <h1 id="welcome-heading" class="text-3xl md:text-4xl font-bold text-white">Bem-vindo!</h1>
                    <p class="text-lg text-gray-400">Aqui est√° o resumo da sua opera√ß√£o.</p>
                </header>

                <!-- Dashboard de Estat√≠sticas -->
                <div id="dashboard-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                    <!-- Card: Total de V√≠deos -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-amber-500/20 rounded-lg">
                                <i data-lucide="video" class="w-6 h-6 text-amber-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Total de V√≠deos</h3>
                        <p class="text-3xl font-bold text-white" id="stat-total-videos">0</p>
                    </div>

                    <!-- Card: Total de Views -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-500/20 rounded-lg">
                                <i data-lucide="eye" class="w-6 h-6 text-blue-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Total de Views</h3>
                        <p class="text-3xl font-bold text-white" id="stat-total-views">0</p>
                    </div>

                    <!-- Card: Receita Total -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-green-500/20 rounded-lg">
                                <i data-lucide="dollar-sign" class="w-6 h-6 text-green-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Receita Total</h3>
                        <p class="text-3xl font-bold text-white" id="stat-total-revenue">$0</p>
                    </div>

                    <!-- Card: Cr√©ditos -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-yellow-500/20 rounded-lg">
                                <i data-lucide="coins" class="w-6 h-6 text-yellow-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Cr√©ditos Dispon√≠veis</h3>
                        <p class="text-3xl font-bold text-white" id="stat-credits-balance">0.00</p>
                        <div class="mt-3 space-y-2">
                            <a href="javascript:void(0)" id="main-buy-credits-btn" class="block w-full px-4 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-sm font-semibold rounded-lg transition duration-200 text-center cursor-pointer btn-credits-pulse">
                                <i data-lucide="zap" class="w-4 h-4 inline-block mr-1"></i>
                                Comprar Cr√©ditos
                            </a>
                            <button id="view-credits-history-btn" class="w-full text-xs text-yellow-400 hover:text-yellow-300 underline text-center">Ver Hist√≥rico</button>
                        </div>
                    </div>

                    <!-- Card: Armazenamento -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-indigo-500/20 rounded-lg">
                                <i data-lucide="hard-drive" class="w-6 h-6 text-indigo-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Armazenamento</h3>
                        <p class="text-3xl font-bold text-white" id="stat-storage-used">0 MB</p>
                        <p class="text-xs text-gray-500 mt-1" id="stat-storage-limit">de 10 MB</p>
                        <div class="mt-3">
                            <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                                <div class="bg-indigo-500 h-2 rounded-full transition-all duration-300" id="stat-storage-progress" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-400 text-center" id="stat-storage-percentage">0% usado</p>
                        </div>
                    </div>

                    <!-- Card: V√≠deos Virais -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-purple-500/20 rounded-lg">
                                <i data-lucide="trending-up" class="w-6 h-6 text-purple-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">V√≠deos Virais</h3>
                        <p class="text-3xl font-bold text-white" id="stat-viral-videos">0</p>
                    </div>
                </div>

                <!-- Grid de Informa√ß√µes Adicionais -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- M√©tricas Adicionais -->
                    <div class="lg:col-span-2 bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-amber-500"></i>
                            M√©tricas de Performance
                        </h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">CTR M√©dio</p>
                                <p class="text-2xl font-bold text-white" id="stat-avg-ctr">0%</p>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">Total de Likes</p>
                                <p class="text-2xl font-bold text-white" id="stat-total-likes">0</p>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">Total de Coment√°rios</p>
                                <p class="text-2xl font-bold text-white" id="stat-total-comments">0</p>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">RPM M√©dio</p>
                                <p class="text-2xl font-bold text-white" id="stat-avg-rpm">$0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Atividade Recente -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="activity" class="w-5 h-5 mr-2 text-amber-500"></i>
                            Atividade Recente
                        </h2>
                        <div id="recent-activity" class="space-y-3">
                            <div class="text-center text-gray-400 py-4">
                                <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                                <p class="text-sm">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dicas da IA e Pr√≥ximos Passos -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Dicas da IA - Coluna Direita Compacta -->
                    <div class="lg:col-span-1 bg-gradient-to-br from-amber-900/30 to-amber-800/20 border border-amber-700/50 rounded-lg p-4">
                        <h2 class="text-lg font-semibold text-white mb-3 flex items-center">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-amber-400"></i>
                            Dicas da IA
                        </h2>
                        <div id="ai-tips" class="space-y-2 max-h-[500px] overflow-y-auto pr-2" style="scrollbar-width: thin; scrollbar-color: rgba(251, 191, 36, 0.5) transparent;">
                            <div class="bg-gray-800/50 rounded-lg p-3 border border-amber-700/30">
                                <div class="flex items-start space-x-2">
                                    <i data-lucide="loader" class="w-4 h-4 text-amber-400 mt-0.5 animate-spin flex-shrink-0"></i>
                                    <p class="text-gray-300 text-xs">Analisando seus dados para gerar dicas personalizadas...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pr√≥ximos Passos - Colunas Centrais -->
                    <div class="lg:col-span-2 bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="target" class="w-5 h-5 mr-2 text-amber-500"></i>
                            Pr√≥ximos Passos
                        </h2>
                        <div id="next-steps" class="space-y-3">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="flex items-start space-x-3">
                                    <i data-lucide="loader" class="w-5 h-5 text-amber-500 mt-0.5 animate-spin"></i>
                                    <p class="text-gray-300 text-sm">Carregando pr√≥ximos passos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- V√≠deos Recentes -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                        <i data-lucide="clock" class="w-5 h-5 mr-2 text-amber-500"></i>
                        V√≠deos Recentes
                    </h2>
                    <div id="recent-videos" class="space-y-3">
                        <div class="text-center text-gray-400 py-4">
                            <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                            <p class="text-sm">Carregando v√≠deos recentes...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 2: Analisador (Oculto por padr√£o) -->
            <div id="view-analisador" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Analisador de T√≠tulos Virais</h1>
                    <p class="text-lg text-gray-400">Cole uma URL de v√≠deo e o motor de IA para gerar t√≠tulos.</p>
                </header>

                <div id="analisador-success-message" class="success-message mb-6"></div>

                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                    <form id="analisador-form" class="space-y-6">
                        <!-- URL do V√≠deo -->
                        <div>
                            <label for="video-url" class="block text-sm font-medium mb-2">URL do V√≠deo Viral</label>
                            <input type="url" id="video-url" name="video-url" required
                                   placeholder="https://www.youtube.com/watch?v=..."
                                   class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Motor de IA -->
                            <div>
                                <label for="model-select" class="block text-sm font-medium mb-2">Motor de IA</label>
                                <select id="model-select" name="model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="all">Comparar (Multimodal)</option>
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                        <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            
                            <!-- Salvar em... (Canais/Pastas) -->
                            <div>
                                <label for="folder-select" class="block text-sm font-medium mb-2">Salvar em... (Opcional)</label>
                                <select id="folder-select" name="folder-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="">Hist√≥rico Geral</option>
                                    <!-- Pastas ser√£o carregadas aqui -->
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <button type="submit" id="analisar-button" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black w-full">
                                <span>Analisar e Gerar T√≠tulos</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </div>
                    </form>

                    <!-- √Årea de Loading e Resultados -->
                    <div id="analisador-loading" class="mt-8 flex-col items-center justify-center" style="display: none;">
                        <div class="loader"></div>
                        <p class="text-amber-500 mt-4 font-semibold">Analisando... Isso pode levar alguns segundos.</p>
                    </div>

                    <!-- Caixa de erro para o analisador -->
                    <div id="analisador-error" class="error-message mt-8"></div>

                    <!-- Div de resultados (T√≠tulos) -->
                    <div id="analisador-resultados" class="mt-8" style="display: none;">
                        <!-- O Sum√°rio do V√≠deo + An√°lise + T√≠tulos ser√£o inseridos aqui -->
                    </div>
                    
                    <!-- Gerador de Thumbnail (Layout UX Revisado) -->
                    <div id="thumbnail-generator" class="mt-8" style="display: none;">
                        <hr class="border-gray-700 mb-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Gerador de Ideias de Thumbnail</h3>
                        
                        <div class="mb-4">
                            <label for="thumb-title-select" class="block text-sm font-medium mb-2">1. Usar o T√≠tulo</label>
                            <select id="thumb-title-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <!-- Options ser√£o populadas via JS -->
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="thumb-model-select" class="block text-sm font-medium mb-2">2. Modelo de IA</label>
                            <select id="thumb-model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="thumb-rule-select" class="block text-sm font-medium mb-2">Regra de Thumbnail Viral (IA escolher√° automaticamente se n√£o selecionar)</label>
                            <select id="thumb-rule-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <option value="auto" selected>ü§ñ IA Escolhe Automaticamente (Recomendado)</option>
                                <option value="rule1">1Ô∏è‚É£ Regra da Clareza Imediata (1 segundo)</option>
                                <option value="rule2">2Ô∏è‚É£ Regra do Assunto √önico</option>
                                <option value="rule3">3Ô∏è‚É£ Regra do Rosto Grande</option>
                                <option value="rule4">4Ô∏è‚É£ Regra do Contraste Brutal</option>
                                <option value="rule5">5Ô∏è‚É£ Regra da Cor Estrat√©gica</option>
                                <option value="rule6">6Ô∏è‚É£ Regra dos Ter√ßos</option>
                                <option value="rule7">7Ô∏è‚É£ Regra do Texto Ultra Curto</option>
                                <option value="rule8">8Ô∏è‚É£ Regra do Zoom Emocional</option>
                                <option value="rule9">9Ô∏è‚É£ Regra do Mist√©rio</option>
                                <option value="rule10">üîü Regra dos Pontos de Fuga</option>
                                <option value="rule11">1Ô∏è‚É£1Ô∏è‚É£ Regra do Espa√ßo Negativo</option>
                                <option value="rule12">1Ô∏è‚É£2Ô∏è‚É£ Regra da Coer√™ncia com o T√≠tulo</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">A IA analisar√° o t√≠tulo e escolher√° a melhor regra automaticamente. Voc√™ pode for√ßar uma regra espec√≠fica se desejar.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label for="thumb-language" class="block text-sm font-medium mb-2">3. Idioma</label>
                                <select id="thumb-language" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="Portugu√™s" selected>Portugu√™s</option>
                                    <option value="Ingl√™s">Ingl√™s</option>
                                    <option value="Espanhol">Espanhol</option>
                                </select>
                            </div>

                            <div>
                                <label for="thumb-phrases" class="block text-sm font-medium mb-2">4. Frases</label>
                                <select id="thumb-phrases" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="true" selected>Com Frases</option>
                                    <option value="false">Sem Frases</option>
                                </select>
                            </div>

                            <div>
                                <label for="thumb-style" class="block text-sm font-medium mb-2">5. Estilo de Arte</label>
                                <select id="thumb-style" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <optgroup label="üé® Estilos Realistas">
                                        <option value="photorealistic" selected>üì∏ Foto Realista - Ultra HD, detalhes perfeitos</option>
                                        <option value="cinematic">üé¨ Cinematogr√°fico - Estilo Hollywood, dram√°tico</option>
                                        <option value="documentary">üìπ Document√°rio - Natural, aut√™ntico</option>
                                        <option value="cinematic-narrative">üé≠ Narrativa Cinematogr√°fica - Storytelling visual</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Art√≠sticos">
                                        <option value="anime">üå∏ Anime - Estilo japon√™s animado</option>
                                        <option value="cartoon">üé® Desenho Animado - Colorido e expressivo</option>
                                        <option value="cartoon-premium">‚ú® Cartoon Premium - Alta qualidade animada</option>
                                        <option value="fantasy">‚ú® Fantasia - M√°gico e √©pico</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Minimalistas">
                                        <option value="tech-minimalist">üíª Tech Minimalista - Design limpo e moderno</option>
                                        <option value="spiritual-minimalist">üßò Espiritual Minimalista - Sereno e zen</option>
                                        <option value="stick-figure">üë§ Desenho de Palitos - Minimalista, linhas simples</option>
                                        <option value="whiteboard">üìã Quadro Branco - Educativo e limpo</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Especiais">
                                        <option value="viral-vibrant">üî• Viral Vibrante - Alto contraste, cores saturadas</option>
                                        <option value="modern-documentary">üì∫ Document√°rio Moderno - Din√¢mico e contempor√¢neo</option>
                                        <option value="analog-horror">üéûÔ∏è Terror Anal√≥gico - Qualidade VHS, textura granulada</option>
                                        <option value="dark-theater">üé≠ Teatro Sombrio - Ilumina√ß√£o dram√°tica de palco</option>
                                        <option value="naturalist-drama">üé¨ Drama Naturalista - Realista e emocional</option>
                                        <option value="spiritual-neorealism">‚ú® Neo-realismo Espiritual - Realismo transcendente</option>
                                        <option value="psychological-surrealism">üåÄ Surrealismo Psicol√≥gico - Imagens on√≠ricas</option>
                                        <option value="fragmented-memory">üß© Mem√≥ria Fragmentada - Est√©tica de colagem</option>
                                        <option value="fragmented-narrative">üìñ Narrativa Fragmentada - Estilo colagem</option>
                                        <option value="dream-real">üí≠ Sonho-Real - Espa√ßo liminar entre sonho e realidade</option>
                                        <option value="vhs-nostalgic">üìº VHS Nost√°lgico - Est√©tica retro anos 80/90</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="thumb-custom-prompt" class="block text-sm font-medium mb-2">6. Prompt Personalizado (Opcional)</label>
                            <textarea id="thumb-custom-prompt" rows="4" placeholder="Digite aqui instru√ß√µes espec√≠ficas para a gera√ß√£o da thumbnail. Deixe vazio para usar o prompt padr√£o." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                            <p class="text-xs text-gray-400 mt-1">Use este campo para personalizar como a IA deve gerar as thumbnails. Ex: "Foco em cores vibrantes", "Estilo minimalista", etc.</p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="thumb-no-phrases" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500">
                                <span class="text-sm text-gray-300">Gerar thumbnail sem frase de gancho (apenas imagem, sem texto)</span>
                            </label>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button type="button" id="btn-generate-thumbs" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black">
                                <span>Gerar 2 Ideias</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                            <button type="button" id="btn-generate-more-thumbs" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Gerar Mais 2 Ideias</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </div>
                    </div>


                    <!-- √Årea de loading e resultados para Ideias de Thumbnail -->
                    <div id="thumbnail-ideas-loading" class="mt-6 flex-col items-center justify-center" style="display: none;">
                        <div class="loader"></div>
                        <p class="text-amber-500 mt-4 font-semibold">A gerar ideias de thumbnail (x2)...</p>
                    </div>
                    
                    <div id="thumbnail-ideas-results" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6" style="display: none;">
                        <!-- As 2 ideias de thumbnail ser√£o inseridas aqui -->
                    </div>

                </div>
            </div>

            <!-- VIS√ÉO 3: Explorar Nicho (NOVA) -->
            <div id="view-explorar-nicho" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Explorador de Nichos</h1>
                    <p class="text-lg text-gray-400">Encontre subnichos promissores e analise a concorr√™ncia para o seu novo canal.</p>
                </header>

                <div id="niche-success-message" class="success-message mb-6"></div>
                <div id="niche-error-message" class="error-message mb-6"></div>

                <div class="space-y-8">
                    <!-- Etapa 1: Encontrar Subnicho -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                        <h2 class="text-2xl font-semibold text-white mb-1">Etapa 1: Encontrar um Subnicho</h2>
                        <p class="text-gray-400 mb-6">Descubra oportunidades com alta demanda e baixa concorr√™ncia.</p>
                        
                        <form id="find-subniche-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="niche-principal" class="block text-sm font-medium mb-2">Nicho Principal</label>
                                    <input type="text" id="niche-principal" required placeholder="Ex: Hist√≥ria, Culin√°ria, Finan√ßas" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                </div>
                                <div>
                                    <label for="ideia-inicial" class="block text-sm font-medium mb-2">Subnicho que voc√™ pensou (concorrido)</label>
                                    <input type="text" id="ideia-inicial" required placeholder="Ex: Segunda Guerra Mundial" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                </div>
                            </div>
                            <div>
                                <label for="niche-model-select" class="block text-sm font-medium mb-2">Motor de IA</label>
                                <select id="niche-model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            <button type="submit" id="btn-find-subniche" class="w-full py-3 px-4 rounded-lg font-bold bg-amber-600 hover:bg-amber-500 text-black flex items-center justify-center space-x-2">
                                <span>Encontrar Subnichos</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </form>
                        <div id="subniche-loading" class="mt-6 text-center" style="display: none;">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4 text-amber-500">A procurar subnichos...</p>
                        </div>
                        <div id="subniche-results" class="mt-6 prose prose-invert max-w-none prose-p:text-gray-300 prose-strong:text-white prose-headings:text-amber-400"></div>
                    </div>

                    <!-- Etapa 2: Analisar Concorrente -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                        <h2 class="text-2xl font-semibold text-white mb-1">Etapa 2: Analisar Canal Concorrente</h2>
                        <p class="text-gray-400 mb-6">Obtenha um plano estrat√©gico completo baseado em um canal de sucesso.</p>
                        
                        <form id="analyze-competitor-form" class="space-y-6">
                             <div>
                                <label for="competitor-url" class="block text-sm font-medium mb-2">URL do Canal Concorrente</label>
                                <input type="url" id="competitor-url" required placeholder="https://www.youtube.com/@canaldesucesso" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                             <div>
                                <label for="competitor-model-select" class="block text-sm font-medium mb-2">Motor de IA</label>
                                <select id="competitor-model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            <button type="submit" id="btn-analyze-competitor" class="w-full py-3 px-4 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center space-x-2">
                                <span>Gerar Plano Estrat√©gico</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </form>
                        <div id="competitor-loading" class="mt-6 text-center" style="display: none;">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4 text-amber-500">Analisando canal... Isso pode levar um minuto.</p>
                        </div>
                        <div id="competitor-analysis-results" class="mt-6 prose prose-invert max-w-none prose-p:text-gray-300 prose-strong:text-white prose-headings:text-amber-400 prose-li:text-gray-300"></div>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 4: Pastas e Hist√≥rico (Layout UX Revisado) -->
            <div id="view-historico" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Pastas e Hist√≥rico</h1>
                    <p class="text-lg text-gray-400">Crie pastas (canais) e reveja suas an√°lises salvas.</p>
                </header>
                
                <div id="historico-success-message" class="success-message mb-6"></div>
                <div id="historico-error-message" class="error-message mb-6"></div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <div class="md:col-span-1 space-y-4">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-white mb-4">Minhas Pastas (Canais)</h2>
                            <form id="new-folder-form" class="flex space-x-2">
                                <input type="text" id="new-folder-name" placeholder="Nome do novo canal..." class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" required>
                                <button type="submit" class="py-2 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </form>
                            <ul id="folder-list" class="mt-4 space-y-2">
                                <!-- Lista de pastas/canais -->
                            </ul>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-white" id="history-title">Hist√≥rico Geral</h2>
                                <div class="flex items-center space-x-2">
                                    <button id="delete-selected-history" class="py-1 px-3 rounded-lg bg-red-800 hover:bg-red-700 text-white text-xs font-bold flex items-center space-x-1.5 hidden">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                        <span>Excluir Selecionados</span>
                                    </button>
                                    <button id="clear-history-filter" class="text-sm text-amber-500 hover:text-amber-400" style="display: none;">
                                        Ver Hist√≥rico Geral
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtros -->
                            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                                <input type="text" id="history-search" placeholder="Buscar por t√≠tulo..." class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <select id="history-niche-filter" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="">Todos os Nichos</option>
                                </select>
                                <select id="history-date-filter" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="">Todas as Datas</option>
                                    <option value="today">Hoje</option>
                                    <option value="week">Esta Semana</option>
                                    <option value="month">Este M√™s</option>
                                    <option value="year">Este Ano</option>
                                </select>
                            </div>
                            
                            <div class="overflow-x-auto rounded-lg border border-gray-800">
                                <table id="history-table" class="w-full text-left border-collapse">
                                    <thead>
                                        <tr>
                                            <th class="p-3 w-4 border-b border-gray-700 bg-gray-800"><input type="checkbox" id="select-all-history" class="bg-gray-700 border-gray-600 rounded"></th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">T√≠tulo Original</th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">Nicho</th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">Data</th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body">
                                        <!-- Hist√≥rico carregado aqui -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagina√ß√£o -->
                            <div id="history-pagination" class="mt-4 flex items-center justify-between" style="display: none;">
                                <div class="text-sm text-gray-400" id="history-pagination-info"></div>
                                <div class="flex items-center space-x-2" id="history-pagination-controls"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIS√ÉO 5: Canais Monitorados -->
            <div id="view-canais" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Canais Monitorados</h1>
                    <p class="text-lg text-gray-400">Adicione canais do YouTube para monitorar novos v√≠deos.</p>
                </header>

                <div id="canais-success-message" class="success-message mb-6"></div>
                <div id="canais-error-message" class="error-message mb-6"></div>
                <div id="canais-limit-message" class="error-message mb-4" style="display: none;"></div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-4">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-white mb-4">Adicionar Novo Canal</h2>
                            <form id="new-channel-form" class="space-y-4">
                                <div>
                                    <label for="new-channel-name" class="block text-sm font-medium mb-2">Nome do Canal</label>
                                    <input type="text" id="new-channel-name" placeholder="Ex: Canal Dark" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" required>
                                </div>
                                <div>
                                    <label for="new-channel-url" class="block text-sm font-medium mb-2">URL do Canal</label>
                                    <input type="url" id="new-channel-url" placeholder="https://www.youtube.com/@canal" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" required>
                                </div>
                                <button type="submit" id="btn-add-channel" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black w-full">
                                    <span>Adicionar Canal</span>
                                    <div class="btn-spinner hidden"></div>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-white mb-4">Meus Canais Monitorados</h2>
                            <div class="overflow-x-auto rounded-lg border border-gray-800">
                                <table id="channel-table" class="w-full text-left border-collapse">
                                    <thead>
                                        <tr>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">Nome</th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">URL</th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="channel-table-body">
                                        <!-- Canais carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o de V√≠deos Fixados -->
                <div class="mt-8 bg-black border border-gray-800 rounded-lg p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                        <h2 class="text-xl font-semibold text-white">V√≠deos Fixados</h2>
                        <div class="flex items-center gap-3">
                            <label for="pinned-channel-select" class="text-sm text-gray-400 whitespace-nowrap">Canal:</label>
                            <select id="pinned-channel-select" class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent flex-1 min-w-[200px]">
                                <option value="">Todos os Canais</option>
                                <!-- Canais ser√£o carregados aqui -->
                            </select>
                        </div>
                    </div>
                    <div id="pinned-videos-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-gray-400 col-span-full text-center py-8">Nenhum v√≠deo fixado ainda. Fixe v√≠deos ao buscar v√≠deos de um canal.</p>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 6: Analytics Dashboard -->
            <div id="view-analytics" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">üìä Analytics e Performance</h1>
                    <p class="text-lg text-gray-400">Acompanhe o desempenho dos seus v√≠deos e veja quanto dinheiro voc√™ est√° gerando</p>
                </header>

                <div id="analytics-error-message" class="error-message mb-6"></div>
                <div id="analytics-success-message" class="success-message mb-6"></div>

                <!-- Cards de M√©tricas Principais -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-green-900 to-green-800 border border-green-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="trending-up" class="w-8 h-8 text-green-400"></i>
                            <span class="text-2xl font-bold text-white" id="stats-total-views">0</span>
                        </div>
                        <p class="text-green-200 text-sm">Total de Visualiza√ß√µes</p>
                    </div>

                    <div class="bg-gradient-to-br from-blue-900 to-blue-800 border border-blue-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="target" class="w-8 h-8 text-blue-400"></i>
                            <span class="text-2xl font-bold text-white" id="stats-avg-ctr">0%</span>
                        </div>
                        <p class="text-blue-200 text-sm">CTR M√©dio</p>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-800 border border-yellow-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="dollar-sign" class="w-8 h-8 text-yellow-400"></i>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-white" id="stats-total-revenue">$0</span>
                                <span class="text-lg font-semibold text-yellow-200 block" id="stats-total-revenue-brl">R$ 0</span>
                            </div>
                        </div>
                        <p class="text-yellow-200 text-sm">Receita Estimada</p>
                        <p class="text-yellow-300 text-xs mt-1" id="stats-rpm">RPM: $0 / R$ 0</p>
                    </div>

                    <div class="bg-gradient-to-br from-purple-900 to-purple-800 border border-purple-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="zap" class="w-8 h-8 text-purple-400"></i>
                            <span class="text-2xl font-bold text-white" id="stats-viral-videos">0</span>
                        </div>
                        <p class="text-purple-200 text-sm">V√≠deos Virais (1M+)</p>
                    </div>
                </div>

                <!-- Lista de V√≠deos Trackados -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-4">V√≠deos Recentes</h2>
                    <div class="space-y-4" id="analytics-videos-list">
                        <p class="text-gray-400">Nenhum v√≠deo trackado ainda. Publique um v√≠deo usando nossos t√≠tulos/thumbnails e registre o tracking.</p>
                    </div>
                </div>

                <!-- Gerenciamento de Canais -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-white">Meus Canais (1-10)</h2>
                        <button onclick="showAddChannelModal()" class="py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Adicionar Canal
                        </button>
                    </div>
                    <div id="channels-list" class="space-y-3">
                        <p class="text-gray-400">Carregando canais...</p>
                    </div>
                </div>

                <!-- Modal para Registrar Novo V√≠deo -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Registrar Novo V√≠deo Publicado</h2>
                    <form id="register-video-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Canal</label>
                            <select id="register-video-channel" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                <option value="">Selecione um canal (opcional)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">URL do V√≠deo no YouTube</label>
                            <input type="url" id="register-video-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">T√≠tulo Usado</label>
                            <input type="text" id="register-video-title" placeholder="T√≠tulo que voc√™ usou no v√≠deo" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">CTR Previsto (%)</label>
                                <input type="number" id="register-video-ctr" placeholder="25" min="0" max="100" step="0.1" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Views Previstas</label>
                                <input type="number" id="register-video-views" placeholder="1000000" min="0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                        </div>
                        <button type="submit" class="py-3 px-6 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black w-full">
                            <i data-lucide="plus"></i>
                            <span>Registrar V√≠deo</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Modal para Adicionar/Editar Canal -->
            <div id="channel-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-md w-full mx-4">
                    <h2 class="text-2xl font-bold text-white mb-4" id="channel-modal-title">Adicionar Canal</h2>
                    <form id="channel-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Canal *</label>
                            <input type="text" id="channel-name" required class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" placeholder="Ex: Meu Canal de Tech">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">URL do Canal</label>
                            <input type="url" id="channel-url" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" placeholder="https://www.youtube.com/@...">
                            <p class="text-gray-500 text-xs mt-1">Digite a URL e os campos ser√£o preenchidos automaticamente</p>
                            <input type="hidden" id="channel-id-hidden">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                            <input type="text" id="channel-niche" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" placeholder="Ex: Tecnologia, Educa√ß√£o, Entretenimento">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Idioma</label>
                                <select id="channel-language" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="pt-BR">Portugu√™s (BR)</option>
                                    <option value="en-US">English (US)</option>
                                    <option value="es-ES">Espa√±ol</option>
                                    <option value="fr-FR">Fran√ßais</option>
                                    <option value="de-DE">Deutsch</option>
                                    <option value="it-IT">Italiano</option>
                                    <option value="ja-JP">Êó•Êú¨Ë™û</option>
                                    <option value="ko-KR">ÌïúÍµ≠Ïñ¥</option>
                                    <option value="zh-CN">‰∏≠Êñá</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Pa√≠s</label>
                                <select id="channel-country" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="BR">Brasil</option>
                                    <option value="US">Estados Unidos</option>
                                    <option value="ES">Espanha</option>
                                    <option value="FR">Fran√ßa</option>
                                    <option value="DE">Alemanha</option>
                                    <option value="IT">It√°lia</option>
                                    <option value="JP">Jap√£o</option>
                                    <option value="KR">Coreia do Sul</option>
                                    <option value="CN">China</option>
                                    <option value="MX">M√©xico</option>
                                    <option value="AR">Argentina</option>
                                    <option value="CO">Col√¥mbia</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="submit" class="flex-1 py-3 px-6 bg-amber-600 hover:bg-amber-500 text-black rounded-lg font-bold">Salvar</button>
                            <button type="button" onclick="hideChannelModal()" class="flex-1 py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- VIS√ÉO 7: Biblioteca Virais -->
            <div id="view-biblioteca" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">üìö Biblioteca de T√≠tulos e Thumbnails Virais</h1>
                    <p class="text-lg text-gray-400">Acesse todos os t√≠tulos e thumbnails que geraram milh√µes de views</p>
                </header>

                <div id="biblioteca-error-message" class="error-message mb-6"></div>
                <div id="biblioteca-success-message" class="success-message mb-6"></div>

                <div class="mb-6 flex space-x-4 border-b border-gray-800">
                    <button id="biblioteca-tab-titles" class="px-4 py-2 font-semibold text-amber-500 border-b-2 border-amber-500">
                        T√≠tulos Virais
                    </button>
                    <button id="biblioteca-tab-thumbnails" class="px-4 py-2 font-semibold text-gray-400 hover:text-white">
                        Thumbnails Virais
                    </button>
                    <button id="biblioteca-tab-agents" class="px-4 py-2 font-semibold text-gray-400 hover:text-white">
                        Agentes de Roteiro
                    </button>
                    <button id="biblioteca-tab-scripts" class="px-4 py-2 font-semibold text-gray-400 hover:text-white">
                        Roteiros Gerados
                    </button>
                </div>

                <!-- Filtros -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="biblioteca-search" placeholder="Buscar..." class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                        <select id="biblioteca-niche-filter" class="styled-select px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                            <option value="">Todos os Nichos</option>
                        </select>
                        <select id="biblioteca-views-filter" class="styled-select px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                            <option value="">Todas as Views</option>
                            <option value="1000000">1M+ views</option>
                            <option value="5000000">5M+ views</option>
                            <option value="10000000">10M+ views</option>
                        </select>
                        <button id="biblioteca-favorites-only" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 hover:bg-gray-700 flex items-center justify-center space-x-2">
                            <i data-lucide="heart"></i>
                            <span>Apenas Favoritos</span>
                        </button>
                    </div>
                </div>

                <!-- Lista de T√≠tulos -->
                <div id="biblioteca-titles-section" class="space-y-4">
                    <div class="grid grid-cols-1 gap-4" id="biblioteca-titles-list">
                        <p class="text-gray-400">Carregando t√≠tulos...</p>
                    </div>
                </div>

                <!-- Lista de Thumbnails -->
                <div id="biblioteca-thumbnails-section" class="space-y-4" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="biblioteca-thumbnails-list">
                        <p class="text-gray-400">Carregando thumbnails...</p>
                    </div>
                </div>

                <!-- Lista de Agentes de Roteiro -->
                <div id="biblioteca-agents-section" class="space-y-4" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="biblioteca-agents-list">
                        <p class="text-gray-400">Carregando agentes...</p>
                    </div>
                </div>

                <!-- Lista de Roteiros Gerados -->
                <div id="biblioteca-scripts-section" class="space-y-4" style="display: none;">
                    <!-- Bot√£o de apagar selecionados -->
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-2">
                            <button id="select-all-scripts" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 hover:bg-gray-700 transition-colors text-sm">
                                Selecionar Todos
                            </button>
                            <button id="delete-selected-scripts" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors text-sm flex items-center space-x-2" style="display: none;">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Apagar Selecionados (<span id="selected-count">0</span>)</span>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4" id="biblioteca-scripts-list">
                        <p class="text-gray-400">Carregando roteiros...</p>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 7.5: Agentes Virais -->
            <div id="view-viral-agents" style="display: none;">
                <header class="mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl md:text-4xl font-bold text-white">ü§ñ Agentes Virais</h1>
                            <p class="text-lg text-gray-400">Crie e gerencie agentes de IA personalizados com mem√≥ria, instru√ß√µes e arquivos</p>
                        </div>
                        <button onclick="openCreateViralAgentModal()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 flex items-center space-x-2">
                            <i data-lucide="plus"></i>
                            <span>Novo Agente</span>
                        </button>
                    </div>
                </header>

                <div id="viral-agents-success-message" class="success-message mb-6" style="display: none;"></div>
                <div id="viral-agents-error-message" class="error-message mb-6" style="display: none;"></div>

                <!-- View: Lista de Agentes -->
                <div id="viral-agents-list-view">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="viral-agents-list">
                        <div class="text-center py-12">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin text-gray-400"></i>
                            <p class="text-gray-400">Carregando agentes...</p>
                        </div>
                    </div>
                </div>

                <!-- View: Detalhes do Agente -->
                <div id="viral-agents-detail-view" style="display: none;">
                    <div class="flex gap-6">
                        <!-- Conte√∫do Principal -->
                        <div class="flex-1">
                            <!-- Header do Agente -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-4">
                                    <button onclick="showViralAgentsListView()" class="text-gray-400 hover:text-white transition">
                                        <i data-lucide="arrow-left"></i>
                                    </button>
                                    <div>
                                        <h2 id="viral-agent-name-header" class="text-2xl font-bold text-white"></h2>
                                        <p id="viral-agent-description-header" class="text-gray-400 text-sm"></p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleViralAgentFavorite()" id="viral-favorite-btn" class="p-2 rounded-lg hover:bg-gray-800 transition">
                                        <i data-lucide="star"></i>
                                    </button>
                                    <button onclick="openEditViralAgentModal()" class="p-2 rounded-lg hover:bg-gray-800 transition">
                                        <i data-lucide="settings"></i>
                                    </button>
                                    <button onclick="deleteViralAgent()" class="p-2 rounded-lg hover:bg-red-900 transition text-red-400">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Abas -->
                            <div class="flex gap-2 mb-6 border-b border-gray-800">
                                <button onclick="showViralChatTab()" id="viral-tab-chat" class="px-4 py-2 font-semibold border-b-2 border-amber-500 text-amber-500">
                                    Chat
                                </button>
                                <button onclick="showViralConversationsTab()" id="viral-tab-conversations" class="px-4 py-2 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white">
                                    Conversas
                                </button>
                            </div>

                            <!-- Tab: Chat -->
                            <div id="viral-tab-content-chat" class="tab-content">
                                <div class="bg-gray-900 border border-gray-800 rounded-lg" style="height: 600px; display: flex; flex-direction: column;">
                                    <div class="flex-1 overflow-y-auto p-6 space-y-4" id="viral-chat-messages">
                                        <!-- Mensagens ser√£o carregadas aqui -->
                                    </div>
                                    <div class="p-4 border-t border-gray-800 flex gap-3">
                                        <input 
                                            type="text" 
                                            id="viral-chat-input" 
                                            placeholder="Digite sua mensagem..."
                                            class="flex-1 px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-500"
                                            onkeypress="if(event.key === 'Enter') sendViralMessage()"
                                        >
                                        <button onclick="sendViralMessage()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200">
                                            <i data-lucide="send"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Conversas -->
                            <div id="viral-tab-content-conversations" class="tab-content" style="display: none;">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-white">Conversas Anteriores</h3>
                                    <button onclick="createNewViralConversation()" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white hover:bg-gray-700 transition text-sm flex items-center space-x-2">
                                        <i data-lucide="plus"></i>
                                        <span>Nova Conversa</span>
                                    </button>
                                </div>
                                <div id="viral-conversations-list" class="space-y-2">
                                    <!-- Conversas ser√£o carregadas aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="w-80">
                            <!-- Mem√≥ria -->
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-amber-500">Mem√≥ria</span>
                                        <span class="text-xs text-gray-500 flex items-center gap-1">
                                            <i data-lucide="lock" class="w-3 h-3"></i>
                                            Apenas voc√™
                                        </span>
                                    </div>
                                    <button onclick="editViralMemory()" class="text-gray-400 hover:text-white">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <p id="viral-agent-memory" class="text-xs text-gray-300 whitespace-pre-wrap line-clamp-4" style="max-height: 120px; overflow: hidden; text-overflow: ellipsis;"></p>
                                <p class="text-xs text-gray-500 mt-2" id="viral-memory-updated"></p>
                            </div>

                            <!-- Instru√ß√µes -->
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-amber-500">Instru√ß√µes</span>
                                    <button onclick="editViralInstructions()" class="text-gray-400 hover:text-white">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <p id="viral-agent-instructions" class="text-xs text-gray-300 whitespace-pre-wrap line-clamp-4" style="max-height: 120px; overflow: hidden; text-overflow: ellipsis;"></p>
                            </div>

                            <!-- Arquivos -->
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm font-bold text-amber-500">Arquivos</span>
                                    <button onclick="addViralFile()" class="text-gray-400 hover:text-white">
                                        <i data-lucide="plus"></i>
                                    </button>
                                </div>
                                <div id="viral-agent-files" class="space-y-2 mb-3">
                                    <!-- Arquivos ser√£o carregados aqui -->
                                </div>
                                <div class="text-xs text-gray-500">
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div id="viral-storage-bar" class="bg-amber-500 h-2 rounded-full" style="width: 1%"></div>
                                    </div>
                                    <p class="mt-1" id="viral-storage-text">1% da capacidade do projeto utilizada</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 8: Gerador de Voz -->
            <div id="view-gerador-voz" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">üéôÔ∏è Gerador de Voz</h1>
                    <p class="text-lg text-gray-400">Transforme roteiros em narra√ß√µes de alta qualidade para qualquer dura√ß√£o.</p>
                </header>

                <div id="tts-success-message" class="success-message mb-6" style="display: none;"></div>
                <div id="tts-error-message" class="error-message mb-6" style="display: none;"></div>

                <!-- Modal de Progresso de Gera√ß√£o de Voz -->
                <div id="tts-progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20">
                                <i data-lucide="mic" class="w-10 h-10 text-amber-400 animate-pulse"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Gerando Narra√ß√£o</h3>
                            <p class="text-gray-300 text-sm" id="tts-progress-status">Iniciando...</p>
                        </div>
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-white font-bold text-lg" id="tts-progress-counter">0/0</span>
                                <span class="text-amber-400 font-bold text-2xl" id="tts-progress-percentage">0%</span>
                            </div>
                            <div class="w-full bg-gray-800/50 rounded-full h-3 overflow-hidden border border-gray-700/50 relative">
                                <div class="h-full bg-gradient-to-r from-amber-500 via-yellow-400 to-amber-500 rounded-full transition-all duration-300 ease-out" id="tts-progress-bar" style="width: 0%; background-size: 200% 100%; animation: shimmer 2s infinite;"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-300" id="tts-progress-details">Aguarde enquanto geramos sua narra√ß√£o...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal de Teste de Voz -->
                <div id="tts-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10000] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-white">üéôÔ∏è Teste de Voz</h3>
                            <button id="tts-preview-modal-close" class="text-gray-400 hover:text-white transition">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="mb-6">
                            <div id="tts-preview-loading" class="text-center py-8 hidden">
                                <div class="inline-block loader"></div>
                                <p class="text-gray-400 mt-4">Gerando preview...</p>
                            </div>
                            <audio id="tts-preview-player" class="w-full" style="display: none;" controls></audio>
                            <div id="tts-preview-error" class="text-red-400 text-sm text-center mt-4 hidden"></div>
                        </div>
                        <div class="flex gap-3">
                            <button id="tts-preview-modal-close-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Conclus√£o -->
                <div id="tts-complete-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-green-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-green-600/20 rounded-full mb-4 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Narra√ß√£o Gerada!</h3>
                            <p class="text-gray-300 text-sm">Sua narra√ß√£o est√° pronta para download.</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="tts-close-modal-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                            <a id="tts-download-link" href="#" download class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-lg transition duration-200 text-center">
                                Download
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Modal de Partes (FFmpeg n√£o dispon√≠vel) -->
                <div id="tts-parts-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10002] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20">
                                <i data-lucide="file-audio" class="w-12 h-12 text-amber-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Partes Geradas</h3>
                            <p class="text-gray-300 text-sm mb-2">FFmpeg n√£o est√° dispon√≠vel para concatena√ß√£o autom√°tica.</p>
                            <p class="text-gray-400 text-xs">Baixe cada parte e use um software de √°udio para combin√°-las.</p>
                        </div>
                        <div id="tts-parts-list" class="space-y-3 mb-6">
                            <!-- Partes ser√£o inseridas aqui dinamicamente -->
                        </div>
                        <div class="flex gap-3">
                            <button id="tts-parts-close-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Formul√°rio de Gera√ß√£o de Voz -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 space-y-6">
                        <div>
                            <label for="tts-script-input" class="block text-sm font-medium text-gray-300 mb-2">Roteiro Completo</label>
                            <textarea id="tts-script-input" rows="10" placeholder="Cole ou importe o roteiro completo aqui... (sem limite de caracteres)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <button id="tts-import-last-script" class="text-sm font-medium text-blue-400 hover:text-blue-300 hover:underline">
                                    Importar √∫ltimo roteiro gerado
                                </button>
                                <div class="flex items-center gap-2">
                                    <p id="tts-duration-hint" class="text-sm text-gray-400">Adicione o roteiro para calcular a dura√ß√£o.</p>
                                    <p id="tts-char-count" class="text-sm text-gray-400"></p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="tts-voice-select" class="block text-sm font-medium text-gray-300 mb-2">Voz da Narra√ß√£o</label>
                                <div class="flex items-center gap-3">
                                    <select id="tts-voice-select" class="flex-1 min-w-0 max-w-[calc(100%-140px)] px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 truncate" title="">
                                        <option value="">Carregando vozes...</option>
                                    </select>
                                    <button id="tts-preview-btn" type="button" class="flex-shrink-0 px-4 py-3 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold transition shadow-lg hover:shadow-amber-500/50 flex items-center gap-2 whitespace-nowrap" title="Testar Voz">
                                        <i data-lucide="play" class="w-5 h-5"></i>
                                        <span>Testar</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="tts-provider-select" class="block text-sm font-medium text-gray-300 mb-2">Provedor de Voz</label>
                                <select id="tts-provider-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="laozhang" selected>DarkVoz (Padr√£o)</option>
                                    <option value="voice_premium">Voz Premium</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Escolha o provedor de gera√ß√£o de voz</p>
                            </div>
                        </div>

                        <!-- Controles espec√≠ficos do DarkVoz -->
                        <div id="darkvoz-controls" class="mb-6">
                            <div>
                                <label for="tts-speed-select" class="block text-sm font-medium text-gray-300 mb-2">Velocidade de Fala</label>
                                <select id="tts-speed-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="0.25">0.25x (Muito Lento)</option>
                                    <option value="0.5">0.5x (Lento)</option>
                                    <option value="0.75">0.75x (Um pouco lento)</option>
                                    <option value="1.0" selected>1.0x (Normal)</option>
                                    <option value="1.25">1.25x (Um pouco r√°pido)</option>
                                    <option value="1.5">1.5x (R√°pido)</option>
                                    <option value="1.75">1.75x (Muito r√°pido)</option>
                                    <option value="2.0">2.0x (M√°ximo)</option>
                                    <option value="2.5">2.5x (M√°ximo)</option>
                                    <option value="3.0">3.0x (M√°ximo)</option>
                                    <option value="4.0">4.0x (M√°ximo)</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Velocidade de reprodu√ß√£o da voz (0.25x a 4.0x)</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="tts-style-preset" class="block text-sm font-medium text-gray-300 mb-2">Estilo de Narra√ß√£o (Predefini√ß√µes)</label>
                                <select id="tts-style-preset" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="">Selecione um estilo...</option>
                                    <option value="natural">Natural e Conversacional</option>
                                    <option value="energetic">Energ√©tico e Animado</option>
                                    <option value="calm">Calmo e Profissional</option>
                                    <option value="dramatic">Dram√°tico e Expressivo</option>
                                </select>
                            </div>
                            <div>
                                <label for="tts-style-instructions" class="block text-sm font-medium text-gray-300 mb-2">Instru√ß√µes de Estilo (Personalizado)</label>
                                <textarea id="tts-style-instructions" rows="3" placeholder="Selecione um estilo ou escreva suas pr√≥prias instru√ß√µes..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-3">
                            <button id="tts-generate-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold text-white bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 focus:outline-none focus:ring-4 focus:ring-amber-300 transition">
                                Gerar Narra√ß√£o
                            </button>
                            <button id="tts-reset-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold bg-gray-700 hover:bg-gray-600 text-gray-200 transition">
                                Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 9: Imagens em Lote -->
            <div id="view-imagens-lote" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">üñºÔ∏è Imagens em Lote</h1>
                    <p class="text-lg text-gray-400">Gere m√∫ltiplas imagens de uma vez a partir de prompts em arquivo TXT</p>
                </header>

                <div id="imagens-lote-success-message" class="success-message mb-6"></div>
                <div id="imagens-lote-error-message" class="error-message mb-6"></div>

                <!-- Modal de Confirma√ß√£o de Gera√ß√£o -->
                <div id="batch-confirm-generation-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-blue-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500/30 to-blue-600/20 rounded-full mb-4 ring-4 ring-blue-500/20">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-blue-400"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-2">Confirmar Gera√ß√£o de Imagens</h3>
                            <p class="text-gray-300 text-sm" id="batch-confirm-modal-message">Voc√™ est√° prestes a gerar imagens.</p>
                        </div>
                        
                        <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-4 mb-6">
                            <div class="flex items-center gap-3">
                                <i data-lucide="info" class="w-5 h-5 text-blue-400 flex-shrink-0"></i>
                                <div class="text-sm text-gray-300">
                                    <p class="font-semibold text-blue-300 mb-1" id="batch-confirm-modal-count">0 imagens</p>
                                    <p class="text-gray-400">Este processo pode levar alguns minutos. As imagens ser√£o geradas automaticamente em paralelo.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="batch-confirm-modal-cancel" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Cancelar
                            </button>
                            <button id="batch-confirm-modal-confirm" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-blue-500/30">
                                Confirmar e Gerar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Conclus√£o de Gera√ß√£o -->
                <div id="batch-image-gen-complete-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-green-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-green-600/20 rounded-full mb-4 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">Gera√ß√£o Conclu√≠da!</h3>
                            <p class="text-gray-300 text-sm" id="batch-image-gen-duration">Tempo total: 0 segundos</p>
                        </div>
                        
                        <div class="bg-green-900/20 border border-green-700/50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-green-300 font-semibold" id="batch-image-gen-success-count">0 sucesso</span>
                                <span class="text-red-300 font-semibold" id="batch-image-gen-failed-count">0 erros</span>
                            </div>
                            <p class="text-xs text-gray-400 text-center">Todas as imagens foram processadas</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="batch-close-image-gen-modal-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                            <button id="batch-view-generated-images-btn" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-blue-500/30">
                                Ver Imagens
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o Principal: Prompts para Imagens -->
                <div class="bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-700 rounded-lg p-6 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-400"></i>
                        <h2 class="text-xl font-semibold text-white">üí° Prompts para Imagens</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Cole ou fa√ßa upload de um arquivo TXT com os prompts das imagens (um por linha). As imagens ser√£o geradas em lote.</p>
                    
                    <div class="relative">
                        <textarea id="batch-image-prompts-textarea" rows="8" placeholder="Cole os prompts aqui (um por linha) ou fa√ßa upload de um arquivo TXT...&#10;&#10;Exemplo:&#10;CENA 1: Opening scene with tense and mysterious music on a black screen.&#10;CENA 2: A person walking through a dark corridor..." class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                        <button type="button" id="batch-upload-txt-btn" class="absolute top-2 right-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium transition duration-200 flex items-center gap-2">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Upload TXT
                        </button>
                        <input type="file" id="batch-txt-file-input" accept=".txt" class="hidden">
                    </div>
                    
                    <div class="mt-3 flex items-center justify-between">
                        <p class="text-sm text-gray-400" id="batch-prompts-count-display">0 prompts</p>
                        <p class="text-xs text-gray-500">Dica: Voc√™ pode colar prompts ou fazer upload de um arquivo TXT</p>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Modelo de Imagem</label>
                            <select id="batch-image-model-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="flux-pro">Flux Pro</option>
                                <option value="flux-dev">Flux Dev</option>
                                <option value="dalle-3">DALL-E 3</option>
                                <option value="midjourney">Midjourney</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Estilo</label>
                            <select id="batch-image-style-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="photorealistic">üì∏ Foto Realista - Ultra HD</option>
                                <option value="cinematic">üé¨ Cinematogr√°fico</option>
                                <option value="anime">üå∏ Anime</option>
                                <option value="cartoon">üé® Desenho Animado</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="batch-btn-generate-images" class="mt-4 w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-lg transition duration-200 flex items-center justify-center gap-2">
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                        <span>Gerar Todas as Imagens</span>
                    </button>
                </div>

                <!-- Painel de Progresso -->
                <div id="batch-image-gen-progress-panel" class="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-4" style="display: none;">
                    <!-- Conte√∫do ser√° inserido dinamicamente -->
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div id="batch-imagefx-actions" class="mb-4 space-y-2" style="display: none;">
                    <div class="flex gap-2">
                        <button id="batch-select-all-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-700 text-gray-200 hover:bg-gray-600">
                            Selecionar Tudo
                        </button>
                        <button id="batch-deselect-all-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-700 text-gray-200 hover:bg-gray-600">
                            Desmarcar Todas
                        </button>
                        <button id="batch-download-selected-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-500">
                            Baixar Selecionadas
                        </button>
                    </div>
                    <button id="batch-clear-all-images-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-500">
                        Limpar Imagens Geradas
                    </button>
                </div>

                <!-- Grid de Imagens Geradas -->
                <div id="batch-generated-images-output" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 min-h-0">
                    <p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>
                </div>
            </div>

            <!-- VIS√ÉO 10: Gerador de V√≠deo -->
            <div id="view-gerador-video" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">üé¨ Gerador de V√≠deo</h1>
                    <p class="text-lg text-gray-400">Crie v√≠deos incr√≠veis com IA usando Veo da Google</p>
                </header>

                <div id="video-success-message" class="success-message mb-6" style="display: none;"></div>
                <div id="video-error-message" class="error-message mb-6" style="display: none;"></div>

                <!-- Modal de Progresso -->
                <div id="video-progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-indigo-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-500/30 to-indigo-600/20 rounded-full mb-4 ring-4 ring-indigo-500/20">
                                <div class="w-10 h-10 border-4 border-t-transparent border-indigo-400 rounded-full animate-spin"></div>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Gerando V√≠deo</h3>
                            <p class="text-gray-300 text-sm" id="video-progress-status">Iniciando gera√ß√£o...</p>
                        </div>
                        <div class="mb-6">
                            <div class="w-full bg-gray-800/50 rounded-full h-3 overflow-hidden border border-gray-700/50 relative">
                                <div class="h-full bg-gradient-to-r from-amber-500 via-orange-500 to-amber-500 rounded-full transition-all duration-500" id="video-progress-bar" style="width: 0%;"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-xs font-semibold text-white" id="video-progress-percentage">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-300" id="video-progress-details">Isso pode levar alguns minutos. Por favor, aguarde...</p>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Formul√°rio de Gera√ß√£o -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 space-y-6">
                        <!-- Modo fixo: Texto para V√≠deo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Modo de Gera√ß√£o</label>
                            <input type="text" value="Texto para V√≠deo" readonly class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 cursor-not-allowed">
                        </div>

                        <!-- Upload de M√≠dia (condicional baseado no modo) -->
                        <div id="video-media-uploads" class="hidden">
                            <!-- Frames to Video -->
                            <div id="frames-upload-section" class="hidden space-y-4">
                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Frame Inicial</label>
                                        <div class="relative">
                                            <input type="file" id="video-start-frame" accept="image/*" class="hidden">
                                            <button type="button" id="video-start-frame-btn" class="w-full h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                                <i data-lucide="image" class="w-8 h-8 mb-2"></i>
                                                <span class="text-sm">Adicionar Frame Inicial</span>
                                            </button>
                                            <div id="video-start-frame-preview" class="hidden mt-2 relative">
                                                <img id="video-start-frame-img" class="w-full h-32 object-cover rounded-lg">
                                                <button type="button" id="video-start-frame-remove" class="absolute top-2 right-2 p-1 bg-red-600 rounded-full text-white">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Frame Final (Opcional)</label>
                                        <div class="relative">
                                            <input type="file" id="video-end-frame" accept="image/*" class="hidden">
                                            <button type="button" id="video-end-frame-btn" class="w-full h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                                <i data-lucide="image" class="w-8 h-8 mb-2"></i>
                                                <span class="text-sm">Adicionar Frame Final</span>
                                            </button>
                                            <div id="video-end-frame-preview" class="hidden mt-2 relative">
                                                <img id="video-end-frame-img" class="w-full h-32 object-cover rounded-lg">
                                                <button type="button" id="video-end-frame-remove" class="absolute top-2 right-2 p-1 bg-red-600 rounded-full text-white">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="video-loop-checkbox" class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="video-loop-checkbox" class="ml-2 text-sm text-gray-300">Criar v√≠deo em loop (usar frame inicial como final)</label>
                                </div>
                            </div>

                            <!-- References to Video -->
                            <div id="references-upload-section" class="hidden space-y-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Imagens de Refer√™ncia (m√°x. 3)</label>
                                <div id="video-reference-images" class="flex gap-4 flex-wrap">
                                    <button type="button" id="video-add-reference-btn" class="w-32 h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                        <i data-lucide="plus" class="w-8 h-8 mb-2"></i>
                                        <span class="text-xs">Adicionar</span>
                                    </button>
                                </div>
                                <input type="file" id="video-reference-input" accept="image/*" multiple class="hidden">
                            </div>

                            <!-- Extend Video -->
                            <div id="extend-video-section" class="hidden space-y-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">V√≠deo de Entrada (deve ser 720p gerado pelo Veo)</label>
                                <input type="file" id="video-input-video" accept="video/*" class="hidden">
                                <button type="button" id="video-input-video-btn" class="w-full h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                    <i data-lucide="video" class="w-8 h-8 mb-2"></i>
                                    <span class="text-sm">Adicionar V√≠deo</span>
                                </button>
                                <div id="video-input-video-preview" class="hidden mt-2">
                                    <video id="video-input-video-preview-player" class="w-full h-48 rounded-lg" controls></video>
                                    <button type="button" id="video-input-video-remove" class="mt-2 px-4 py-2 bg-red-600 rounded-lg text-white text-sm">
                                        Remover V√≠deo
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Prompt -->
                        <div>
                            <label for="video-prompt-input" class="block text-sm font-medium text-gray-300 mb-2">Descri√ß√£o do V√≠deo</label>
                            <textarea id="video-prompt-input" rows="4" placeholder="Descreva o v√≠deo que voc√™ quer criar..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
                        </div>

                        <!-- Configura√ß√µes Avan√ßadas -->
                        <div class="border-t border-gray-700 pt-4">
                            <button type="button" id="video-settings-toggle" class="flex items-center justify-between w-full text-sm font-medium text-gray-300 hover:text-white mb-4">
                                <span>Configura√ß√µes Avan√ßadas</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div id="video-settings-panel" class="hidden space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Modelo</label>
                                        <select id="video-model-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="veo-3.1-fast" selected>Veo Fast</option>
                                            <option value="sora_video2-15s">Sora 2 - 15s (Portrait)</option>
                                            <option value="sora_video2-landscape-15s">Sora 2 - 15s (Landscape)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Propor√ß√£o</label>
                                        <select id="video-aspect-ratio-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="16:9">Landscape (16:9)</option>
                                            <option value="9:16">Portrait (9:16)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Resolu√ß√£o</label>
                                        <select id="video-resolution-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="720p">720p</option>
                                            <option value="1080p">1080p</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√µes de A√ß√£o -->
                        <div class="flex gap-3">
                            <button id="video-generate-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition">
                                Gerar V√≠deo
                            </button>
                            <button id="video-reset-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold bg-gray-700 hover:bg-gray-600 text-gray-200 transition">
                                Limpar Tudo
                            </button>
                        </div>
                    </div>

                    <!-- Resultado do V√≠deo -->
                    <div id="video-result-section" class="hidden bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-2xl font-bold text-white mb-4">V√≠deo Gerado!</h2>
                        <div class="w-full max-w-2xl mx-auto aspect-video rounded-lg overflow-hidden bg-black mb-6">
                            <video id="video-result-player" class="w-full h-full object-contain" controls></video>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4">
                            <button id="video-retry-btn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition">
                                <i data-lucide="refresh-cw" class="w-5 h-5 inline mr-2"></i>
                                Tentar Novamente
                            </button>
                            <button id="video-extend-btn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="sparkles" class="w-5 h-5 inline mr-2"></i>
                                Estender V√≠deo
                            </button>
                            <a id="video-download-link" href="#" download class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition inline-flex items-center">
                                <i data-lucide="download" class="w-5 h-5 inline mr-2"></i>
                                Download
                            </a>
                            <button id="video-new-btn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                                Novo V√≠deo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 10: Integra√ß√£o YouTube -->
            <div id="view-youtube-integration" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">üé¨ Integra√ß√£o com YouTube</h1>
                    <p class="text-lg text-gray-400">Publique v√≠deos automaticamente, monitore tend√™ncias e gerencie seu canal</p>
                </header>

                <div id="youtube-integration-error-message" class="error-message mb-6"></div>
                <div id="youtube-integration-success-message" class="success-message mb-6"></div>

                <!-- Tabs de Navega√ß√£o -->
                <div class="border-b border-gray-700 mb-6">
                    <nav class="flex space-x-8">
                        <button onclick="switchYouTubeTab('channels')" id="youtube-tab-channels" class="youtube-tab-button py-4 px-1 border-b-2 border-amber-500 font-medium text-sm text-amber-500">
                            <i data-lucide="tv" class="w-4 h-4 inline mr-2"></i> Canais
                        </button>
                        <button onclick="switchYouTubeTab('schedule')" id="youtube-tab-schedule" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i> Agendamento
                        </button>
                        <button onclick="switchYouTubeTab('trends')" id="youtube-tab-trends" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i> Tend√™ncias
                        </button>
                        <button onclick="switchYouTubeTab('competitors')" id="youtube-tab-competitors" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i> Competidores
                        </button>
                        <button onclick="switchYouTubeTab('suggestions')" id="youtube-tab-suggestions" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i> Sugest√µes IA
                        </button>
                        <button onclick="switchYouTubeTab('alerts')" id="youtube-tab-alerts" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i> Alertas
                        </button>
                    </nav>
                </div>

                <!-- TAB 1: Canais Conectados -->
                <div id="youtube-tab-content-channels" class="youtube-tab-content">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-white">Canais Conectados</h2>
                            <button id="btn-connect-youtube" class="py-2 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-red-600 hover:bg-red-500 text-white text-sm">
                                <i data-lucide="plus"></i>
                                <span>Adicionar Canal</span>
                            </button>
                        </div>
                        <div id="youtube-channels-list" class="space-y-3 mb-4">
                            <p class="text-gray-400">Carregando canais...</p>
                        </div>
                        <div id="youtube-integration-status" class="text-gray-400"></div>
                    </div>

                    <!-- Publica√ß√µes Agendadas -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">Publica√ß√µes Agendadas</h2>
                        <div id="scheduled-posts-list" class="space-y-4">
                            <p class="text-gray-400">Nenhuma publica√ß√£o agendada.</p>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Agendamento Inteligente -->
                <div id="youtube-tab-content-schedule" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">ü§ñ Agendamento Inteligente</h2>
                        <p class="text-gray-400 mb-6">A IA sugere o melhor hor√°rio para publicar baseado no seu nicho</p>
                        
                        <form id="suggest-time-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                                <input type="text" id="suggest-time-niche" placeholder="Ex: Entretenimento, Educa√ß√£o, Tecnologia" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Subnicho (Opcional)</label>
                                <input type="text" id="suggest-time-subniche" placeholder="Ex: Gaming, Finan√ßas Pessoais" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i> Sugerir Melhor Hor√°rio
                            </button>
                        </form>
                        
                        <div id="suggested-time-result" class="mt-6 hidden">
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-white font-semibold mb-2">‚è∞ Hor√°rio Sugerido</h3>
                                <p id="suggested-time" class="text-amber-400 text-2xl font-bold mb-2"></p>
                                <p id="suggested-days" class="text-gray-300 mb-3"></p>
                                <p id="suggested-explanation" class="text-gray-400 text-sm"></p>
                                <div id="suggested-alternatives" class="mt-3">
                                    <p class="text-gray-400 text-sm mb-2">Hor√°rios alternativos:</p>
                                    <div id="alternative-times" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üè∑Ô∏è Gerador Autom√°tico de Tags e Descri√ß√£o</h2>
                        <p class="text-gray-400 mb-6">Gere automaticamente tags e descri√ß√£o otimizadas para SEO usando IA</p>
                        
                        <form id="generate-metadata-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">T√≠tulo do V√≠deo</label>
                                <input type="text" id="metadata-title" placeholder="Digite o t√≠tulo do v√≠deo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Modelo de IA</label>
                                <select id="metadata-model" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="gpt-4o">GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho (Opcional)</label>
                                <input type="text" id="metadata-niche" placeholder="Ex: Entretenimento" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Descri√ß√£o do Conte√∫do (Opcional)</label>
                                <textarea id="metadata-description" rows="3" placeholder="Descreva brevemente o conte√∫do do v√≠deo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500"></textarea>
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="wand-2" class="w-4 h-4 inline mr-2"></i> Gerar Metadata
                            </button>
                        </form>
                        
                        <div id="generated-metadata-result" class="mt-6 hidden">
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 space-y-4">
                                <div>
                                    <h3 class="text-white font-semibold mb-2">Descri√ß√£o Otimizada:</h3>
                                    <textarea id="generated-description" rows="6" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm" readonly></textarea>
                                    <button onclick="copyToClipboard('generated-description')" class="mt-2 py-1 px-3 bg-gray-600 hover:bg-gray-500 text-white rounded text-xs">
                                        <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i> Copiar
                                    </button>
                                </div>
                                <div>
                                    <h3 class="text-white font-semibold mb-2">Tags Otimizadas:</h3>
                                    <div id="generated-tags" class="flex flex-wrap gap-2 mb-2"></div>
                                    <button onclick="copyTagsToClipboard()" class="py-1 px-3 bg-gray-600 hover:bg-gray-500 text-white rounded text-xs">
                                        <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i> Copiar Tags
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: An√°lise de Tend√™ncias -->
                <div id="youtube-tab-content-trends" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üìà An√°lise Autom√°tica de Tend√™ncias</h2>
                        <p class="text-gray-400 mb-6">Escanee o YouTube por v√≠deos virais recentes no seu nicho</p>
                        
                        <form id="scan-trends-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                                    <input type="text" id="trends-niche" placeholder="Ex: Entretenimento, Educa√ß√£o" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Subnicho (Opcional)</label>
                                    <input type="text" id="trends-subniche" placeholder="Ex: Gaming, Finan√ßas" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                </div>
                            </div>
                            
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-300 mb-3">üîç Filtros de Busca</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Idioma</label>
                                        <select id="trends-language" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="pt">Portugu√™s (Brasil)</option>
                                            <option value="en">Ingl√™s</option>
                                            <option value="es">Espanhol</option>
                                            <option value="fr">Franc√™s</option>
                                            <option value="de">Alem√£o</option>
                                            <option value="it">Italiano</option>
                                            <option value="ja">Japon√™s</option>
                                            <option value="ko">Coreano</option>
                                            <option value="zh">Chin√™s</option>
                                            <option value="ru">Russo</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Ordenar por</label>
                                        <select id="trends-order-by" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="viewCount">Mais Visualiza√ß√µes</option>
                                            <option value="date">Mais Recente</option>
                                            <option value="rating">Melhor Avalia√ß√£o</option>
                                            <option value="relevance">Mais Relevante</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Dura√ß√£o do V√≠deo</label>
                                        <select id="trends-duration" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="any">Qualquer Dura√ß√£o</option>
                                            <option value="short">Curto (&lt; 4 min)</option>
                                            <option value="medium">M√©dio (4-20 min)</option>
                                            <option value="long">Longo (&gt; 20 min)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Per√≠odo de Publica√ß√£o</label>
                                        <select id="trends-published-after" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="1">√öltimas 24 horas</option>
                                            <option value="3">√öltimos 3 dias</option>
                                            <option value="7" selected>√öltimos 7 dias</option>
                                            <option value="14">√öltimos 14 dias</option>
                                            <option value="30">√öltimos 30 dias</option>
                                            <option value="90">√öltimos 90 dias</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-300 mb-3">üìä Filtros de Performance</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Views M√≠nimas</label>
                                        <input type="number" id="trends-min-views" value="0" min="0" step="1000" placeholder="Ex: 10000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                        <p class="text-xs text-gray-500 mt-1">Deixe 0 para desabilitar</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Views por Dia M√≠nimas</label>
                                        <input type="number" id="trends-min-views-per-day" value="0" min="0" step="100" placeholder="Ex: 1000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                        <p class="text-xs text-gray-500 mt-1">Deixe 0 para desabilitar</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">N√∫mero de Resultados</label>
                                <input type="number" id="trends-max-results" value="10" min="1" max="50" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            
                            <button type="submit" class="w-full py-2 px-4 bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white rounded-lg font-semibold transition-all shadow-lg shadow-amber-500/30">
                                <i data-lucide="search" class="w-4 h-4 inline mr-2"></i> Escanear Tend√™ncias
                            </button>
                        </form>
                    </div>

                    <div id="trends-results" class="space-y-4">
                        <!-- Resultados ser√£o inseridos aqui -->
                    </div>
                </div>

                <!-- TAB 4: Monitoramento de Competidores -->
                <div id="youtube-tab-content-competitors" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üë• Monitoramento de Competidores</h2>
                        <p class="text-gray-400 mb-6">Adicione canais competidores para monitoramento autom√°tico</p>
                        
                        <form id="monitor-competitor-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">URL ou ID do Canal Competidor</label>
                                <input type="text" id="competitor-channel-id" placeholder="https://youtube.com/@canal ou UC..." class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Canal (Opcional)</label>
                                <input type="text" id="competitor-channel-name" placeholder="Nome do canal" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho (Opcional)</label>
                                <input type="text" id="competitor-niche" placeholder="Ex: Entretenimento" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="competitor-auto-analyze" checked class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500">
                                <label for="competitor-auto-analyze" class="ml-2 text-sm text-gray-300">An√°lise autom√°tica ativada</label>
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i> Adicionar Competidor
                            </button>
                        </form>
                    </div>

                    <div id="monitored-competitors-list" class="space-y-4">
                        <p class="text-gray-400">Carregando competidores monitorados...</p>
                    </div>
                </div>

                <!-- TAB 5: Sugest√µes IA -->
                <div id="youtube-tab-content-suggestions" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">‚ú® Sugest√µes Autom√°ticas de V√≠deos</h2>
                        <p class="text-gray-400 mb-6">A IA analisa tend√™ncias e sugere novos v√≠deos com potencial viral</p>
                        
                        <form id="generate-suggestions-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                                <input type="text" id="suggestions-niche" placeholder="Ex: Entretenimento" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Subnicho (Opcional)</label>
                                <input type="text" id="suggestions-subniche" placeholder="Ex: Gaming" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i> Gerar Sugest√µes
                            </button>
                        </form>
                    </div>

                    <div id="ai-suggestions-list" class="space-y-4">
                        <p class="text-gray-400">Carregando sugest√µes...</p>
                    </div>
                </div>

                <!-- TAB 6: Alertas Virais -->
                <div id="youtube-tab-content-alerts" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üîî Alertas de V√≠deos Virais</h2>
                        <p class="text-gray-400 mb-6">Notifica√ß√µes sobre v√≠deos virais de competidores monitorados</p>
                        
                        <div id="viral-alerts-list" class="space-y-4">
                            <p class="text-gray-400">Carregando alertas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 8: Prompts e Imagens -->
            <div id="view-prompts-imagens" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">üé® Prompts para Cenas e Gerador de Imagens</h1>
                    <p class="text-lg text-gray-400">Gere prompts de cena do seu roteiro e crie todas as imagens com apenas 1 clique!</p>
                </header>

                <div id="prompts-imagens-success-message" class="success-message mb-6"></div>
                <div id="prompts-imagens-error-message" class="error-message mb-6"></div>

                <!-- Modal de Progresso de Gera√ß√£o -->
                <!-- Modal de Progresso de Prompts -->
                <div id="scene-prompts-progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20">
                                <i data-lucide="sparkles" class="w-10 h-10 text-amber-400 animate-spin"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-amber-400 to-yellow-400 bg-clip-text text-transparent">Gerando Prompts de Cena</h3>
                            <p class="text-gray-300 text-sm" id="progress-modal-status">Iniciando...</p>
                        </div>
                        
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-white font-bold text-lg" id="progress-modal-counter">0/0</span>
                                <span class="text-amber-400 font-bold text-2xl" id="progress-modal-percentage">0%</span>
                            </div>
                            <div class="w-full bg-gray-800/50 rounded-full h-3 overflow-hidden border border-gray-700/50">
                                <div class="h-full bg-gradient-to-r from-amber-500 via-yellow-400 to-amber-500 rounded-full transition-all duration-500 ease-out relative" id="progress-modal-bar" style="width: 0%; background-size: 200% 100%; animation: shimmer 2s infinite;">
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent animate-shimmer"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <p class="text-sm text-gray-300" id="progress-modal-details">Aguarde enquanto geramos seus prompts...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal de Confirma√ß√£o de Gera√ß√£o -->
                <div id="confirm-generation-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-amber-400"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-2">Confirmar Gera√ß√£o de Imagens</h3>
                            <p class="text-gray-300 text-sm" id="confirm-modal-message">Voc√™ est√° prestes a gerar imagens.</p>
                        </div>
                        
                        <div class="bg-amber-900/20 border border-amber-700/50 rounded-lg p-4 mb-6">
                            <div class="flex items-center gap-3">
                                <i data-lucide="info" class="w-5 h-5 text-amber-400 flex-shrink-0"></i>
                                <div class="text-sm text-gray-300">
                                    <p class="font-semibold text-amber-300 mb-1" id="confirm-modal-count">0 imagens</p>
                                    <p class="text-gray-400">Este processo pode levar alguns minutos. As imagens ser√£o geradas automaticamente em paralelo.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="confirm-modal-cancel" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Cancelar
                            </button>
                            <button id="confirm-modal-confirm" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-amber-500/30">
                                Confirmar e Gerar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Conclus√£o de Gera√ß√£o -->
                <div id="image-gen-complete-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-green-600/20 rounded-full mb-4 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">Gera√ß√£o Conclu√≠da!</h3>
                            <p class="text-gray-300 text-sm" id="image-gen-duration">Tempo total: 0 segundos</p>
                        </div>
                        
                        <div class="bg-green-900/20 border border-green-700/50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-green-300 font-semibold" id="image-gen-success-count">0 sucesso</span>
                                <span class="text-red-300 font-semibold" id="image-gen-failed-count">0 erros</span>
                            </div>
                            <p class="text-xs text-gray-400 text-center">Todas as imagens foram processadas</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="close-image-gen-modal-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                            <button id="view-generated-images-btn" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-amber-500/30">
                                Ver Imagens
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lightbox para Visualizar Imagens -->
                <div id="image-lightbox" class="fixed inset-0 bg-black/95 backdrop-blur-sm z-[10000] hidden flex items-center justify-center p-4">
                    <div class="relative w-full h-full max-w-7xl max-h-[90vh] flex flex-col">
                        <!-- Bot√£o Fechar -->
                        <button id="lightbox-close" class="absolute top-4 right-4 z-50 w-12 h-12 bg-gray-900/80 hover:bg-gray-800 rounded-full flex items-center justify-center text-white transition-all shadow-lg">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Navega√ß√£o Anterior -->
                        <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 z-50 w-12 h-12 bg-gray-900/80 hover:bg-gray-800 rounded-full flex items-center justify-center text-white transition-all shadow-lg">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Navega√ß√£o Pr√≥xima -->
                        <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 z-50 w-12 h-12 bg-gray-900/80 hover:bg-gray-800 rounded-full flex items-center justify-center text-white transition-all shadow-lg">
                            <i data-lucide="chevron-right" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Contador -->
                        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-50 bg-gray-900/80 px-4 py-2 rounded-full text-white text-sm font-semibold">
                            <span id="lightbox-counter">1 / 1</span>
                        </div>
                        
                        <!-- Imagem -->
                        <div class="flex-1 flex items-center justify-center p-8">
                            <img id="lightbox-image" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
                        </div>
                        
                        <!-- Informa√ß√µes -->
                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-50 bg-gray-900/80 px-6 py-3 rounded-lg text-white text-sm max-w-2xl text-center">
                            <p id="lightbox-info" class="font-semibold">Cena 1</p>
                        </div>
                    </div>
                </div>

                <!-- Modal de Sele√ß√£o de Agente -->
                <div id="select-agent-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center">
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border-2 border-blue-500 rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-white">Selecionar Agente e Roteiro</h3>
                            <button onclick="closeAgentModal()" class="text-gray-400 hover:text-white">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto">
                            <div id="agents-list" class="space-y-3">
                                <p class="text-gray-400 text-center py-8">Carregando agentes...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    @keyframes shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                    .animate-shimmer {
                        animation: shimmer 2s infinite;
                    }
                </style>

                <!-- Se√ß√£o 1: Gerar Prompts de Cena -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-4">üìù Passo 1: Gerar Prompts de Cena</h2>
                    <p class="text-gray-400 mb-6">Cole o seu roteiro completo e gere prompts otimizados para cada cena do v√≠deo.</p>
                    
                    <form id="scene-prompts-form" class="space-y-4">
                        <div>
                            <label for="scene-script-text" class="block text-sm font-medium text-gray-300 mb-2">Roteiro Completo</label>
                            <textarea id="scene-script-text" rows="10" placeholder="Cole o roteiro completo aqui..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                            <div class="flex items-center justify-between mt-1">
                                <p class="text-xs text-gray-400" id="scene-word-count">0 palavras</p>
                                <button type="button" id="btn-import-last-script" class="text-xs px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded transition duration-200">
                                    Importar Roteiro do Agente
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="scene-generation-mode" class="block text-sm font-medium text-gray-300 mb-2">Modo de Gera√ß√£o</label>
                                <select id="scene-generation-mode" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="automatic">Gera√ß√£o Autom√°tica de Cenas</option>
                                    <option value="manual">Gera√ß√£o Manual por Palavras</option>
                                </select>
                            </div>
                            <div>
                                <label for="scene-model-select" class="block text-sm font-medium text-gray-300 mb-2">Modelo de IA</label>
                                <select id="scene-model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campo para modo manual -->
                        <div id="manual-mode-settings" class="hidden">
                            <div class="flex items-center gap-4">
                                <label for="scene-words-per-scene" class="block text-sm font-medium text-gray-300">Gerar a cada</label>
                                <input type="number" id="scene-words-per-scene" value="100" min="50" max="500" step="10" class="w-24 px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <span class="text-sm text-gray-300">palavras</span>
                            </div>
                        </div>

                        <!-- Estimativa de cenas -->
                        <div id="scene-estimate-box" class="bg-blue-900/30 border border-blue-700 rounded-lg p-4">
                            <p class="text-sm text-gray-300 mb-1">Total de cenas estimado:</p>
                            <p class="text-xs text-gray-400 mb-2">Baseado no n√∫mero de palavras do roteiro</p>
                            <p class="text-2xl font-bold text-blue-400" id="estimated-scenes-count">0 cenas</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="scene-style-select" class="block text-sm font-medium text-gray-300 mb-2">Estilo da Cena</label>
                                <select id="scene-style-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <optgroup label="üé® Estilos Realistas">
                                        <option value="photorealistic">üì∏ Foto Realista - Ultra HD, detalhes perfeitos</option>
                                        <option value="cinematic">üé¨ Cinematogr√°fico - Estilo Hollywood, dram√°tico</option>
                                        <option value="documentary">üìπ Document√°rio - Natural, aut√™ntico</option>
                                        <option value="cinematic-narrative">üé≠ Narrativa Cinematogr√°fica - Storytelling visual</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Art√≠sticos">
                                        <option value="anime">üå∏ Anime - Estilo japon√™s animado</option>
                                        <option value="cartoon">üé® Desenho Animado - Colorido e expressivo</option>
                                        <option value="cartoon-premium">‚ú® Cartoon Premium - Alta qualidade animada</option>
                                        <option value="fantasy">‚ú® Fantasia - M√°gico e √©pico</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Minimalistas">
                                        <option value="stick-figure">üë§ Desenho de Palitos - Simples e minimalista</option>
                                        <option value="whiteboard">üìù Quadro Branco - Explicativo e limpo</option>
                                        <option value="tech-minimalist">üíª Tech Minimalista - Moderno e clean</option>
                                        <option value="spiritual-minimalist">üßò Narrativa Espiritual Minimalista - Sereno</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Vibrantes">
                                        <option value="viral-vibrant">üî• Viral Vibrante - Alto contraste, cores intensas</option>
                                        <option value="modern-documentary">üì∫ Document√°rio Moderno - Din√¢mico e atual</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Dram√°ticos">
                                        <option value="analog-horror">üëª Terror Anal√≥gico - Est√©tica VHS, sombrio</option>
                                        <option value="dark-theater">üé™ Teatro Sombrio - Dram√°tico e intenso</option>
                                        <option value="naturalist-drama">üé≠ Drama Naturalista - Realista e emocional</option>
                                    </optgroup>
                                    <optgroup label="üé® Estilos Experimentais 2025">
                                        <option value="spiritual-neorealism">üåü Neo-Realismo Espiritual - Transcendente</option>
                                        <option value="psychological-surrealism">üåÄ Surrealismo Psicol√≥gico - On√≠rico</option>
                                        <option value="fragmented-memory">üß© Mem√≥ria Fragmentada - Narrativa quebrada</option>
                                        <option value="fragmented-narrative">üìñ Narrativa Fragmentada - Estilo colagem</option>
                                        <option value="dream-real">üí≠ Sonho-Real - Limiar entre sonho e realidade</option>
                                        <option value="vhs-nostalgic">üìº VHS Nost√°lgico - Est√©tica anos 80/90</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- Personagens Consistentes -->
                        <div>
                            <label for="scene-characters" class="block text-sm font-medium text-gray-300 mb-2">Personagens Consistentes (Opcional)</label>
                            <textarea id="scene-characters" rows="3" placeholder="Ex: Jo√£o, um homem de 40 anos, cabelo grisalho, √≥culos. Maria, uma jovem de 25, cabelo longo e ruivo." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                            <button type="button" id="btn-detect-characters" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-medium transition duration-200">
                                Detectar Personagens (IA)
                            </button>
                        </div>

                        <button type="submit" id="btn-generate-scene-prompts" class="w-full py-3 px-4 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition duration-300 flex items-center justify-center space-x-2">
                            <i data-lucide="sparkles"></i>
                            <span>Gerar Prompts de Cena</span>
                        </button>
                    </form>

                    <!-- Resultados dos Prompts -->
                    <div id="scene-prompts-results" class="mt-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Prompts Gerados</h3>
                            <button id="download-prompts-btn" class="px-4 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-amber-500/30 flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                Baixar Prompts
                            </button>
                        </div>
                        <div id="scene-prompts-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Se√ß√£o 2: Gerar Todas as Imagens -->
                <div class="bg-gradient-to-r from-purple-900 to-pink-900 border border-purple-700 rounded-lg p-6 mb-6" id="generate-all-images-section" style="display: none;">
                    <h2 class="text-xl font-semibold text-white mb-4">üé® Passo 2: Gerar Todas as Imagens</h2>
                    <p class="text-gray-300 mb-4">Gere todas as imagens para o seu v√≠deo com apenas 1 clique!</p>
                    
                    <div class="flex items-center justify-between bg-white/10 rounded-lg p-4 mb-4">
                        <div>
                            <p class="text-white font-semibold" id="total-prompts-count">0 prompts prontos</p>
                            <p class="text-gray-300 text-sm">Todas as imagens ser√£o geradas automaticamente</p>
                        </div>
                        <button id="btn-generate-all-images" class="px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm border-2 border-white/30 rounded-lg font-semibold text-white transition-all duration-200 flex items-center gap-2">
                            <i data-lucide="image"></i>
                            <span>Gerar Todas as Imagens</span>
                        </button>
                    </div>

                    <!-- Painel de Progresso (estilo DARKSCRIPT) -->
                    <div id="image-gen-progress-panel" class="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-4" style="display: none;">
                        <!-- Conte√∫do ser√° inserido dinamicamente -->
                    </div>

                    <!-- Bot√µes de A√ß√£o (estilo DARKSCRIPT) -->
                    <div id="imagefx-actions" class="mb-4 space-y-2" style="display: none;">
                        <div class="flex gap-2">
                            <button id="select-all-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-700 text-gray-200 hover:bg-gray-600">
                                Selecionar Tudo
                            </button>
                            <button id="download-selected-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-500">
                                Baixar Selecionadas
                            </button>
                        </div>
                        <button id="clear-all-images-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-500">
                            Limpar Imagens Geradas
                        </button>
                    </div>

                    <!-- Grid de Imagens Geradas (estilo DARKSCRIPT) -->
                    <div id="generated-images-output" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>
                    </div>
                </div>

                <!-- Se√ß√£o 3: Hist√≥rico de Prompts -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">üìö Hist√≥rico de Prompts Gerados</h2>
                    <p class="text-gray-400 mb-4">Visualize e reutilize prompts de cenas anteriores</p>
                    
                    <div id="scene-prompts-history" class="space-y-3">
                        <p class="text-gray-400">Carregando hist√≥rico...</p>
                    </div>
                </div>
            </div>

            <!-- VIS√ÉO 9: Configura√ß√µes -->
            <div id="view-configuracoes" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Configura√ß√µes</h1>
                    <p class="text-lg text-gray-400">Gerencie as suas chaves de API para habilitar as ferramentas da plataforma.</p>
                </header>
                
                <div id="config-success-message" class="success-message mb-6"></div>
                <div id="config-error-message" class="error-message mb-6"></div>

                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                    <form id="config-form" class="space-y-6 max-w-2xl mx-auto">
                        
                        <h2 class="text-xl font-semibold text-white">Chaves de API de Texto (Obrigat√≥rio)</h2>
                        <p class="text-sm text-gray-400 -mt-4">As suas chaves s√£o salvas de forma segura e encriptada.</p>

                        <div>
                            <label for="key-claude" class="block text-sm font-medium mb-2">Claude AI API Key (Preferencial)</label>
                            <input type="password" id="key-claude" placeholder="Cole a sua chave (sk-ant-...)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        </div>

                        <div>
                            <label for="key-gemini" class="block text-sm font-medium mb-2">Gemini API Key</label>
                            <input type="password" id="key-gemini" placeholder="Cole a sua chave (AI...)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        </div>

                        <div>
                            <label for="key-openai" class="block text-sm font-medium mb-2">OpenAI (GPT) API Key</label>
                            <input type="password" id="key-openai" placeholder="Cole a sua chave (sk-...)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        </div>

                        <div>
                            <label for="key-youtube" class="block text-sm font-medium mb-2">YouTube Data API v3 Key</label>
                            <input type="password" id="key-youtube" placeholder="Cole a sua chave do YouTube Data API v3 (AIza...)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <p class="text-xs text-gray-400 mt-1">Necess√°ria para buscar dados de v√≠deos do YouTube. Obtenha em: <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-amber-500 hover:text-amber-400 underline">Google Cloud Console</a></p>
                        </div>

                        <hr class="border-gray-700">

                        <h2 class="text-xl font-semibold text-white">Configura√ß√µes de Midia (Opcional)</h2>
                        <div>
                            <label for="key-imagefx" class="block text-sm font-medium mb-2">ImageFX Cookies (JSON)</label>
                            <textarea id="key-imagefx" rows="4" placeholder="Cole o JSON dos cookies aqui..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" style="font-family: monospace;"></textarea>
                        </div>

                        <hr class="border-gray-700">

                        <h2 class="text-xl font-semibold text-white">Prefer√™ncias de Uso</h2>
                        <div class="bg-blue-900/20 border border-blue-700 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <input type="checkbox" id="pref-use-credits" class="mt-1 w-5 h-5 bg-gray-800 border-gray-700 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                                <div class="flex-1">
                                    <label for="pref-use-credits" class="block text-sm font-medium text-white mb-1">
                                        Usar cr√©ditos mesmo tendo API pr√≥pria
                                    </label>
                                    <p class="text-xs text-gray-400">
                                        Se marcado, o sistema usar√° seus cr√©ditos ao inv√©s das suas chaves de API quando ambas estiverem dispon√≠veis.
                                    </p>
                                    <div id="pref-status-message" class="mt-2 text-sm text-blue-300 hidden">
                                        <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="border-gray-700">

                        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                            <button type="submit" id="btn-save-all" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black flex-1">
                                <span class="btn-text">Salvar Configura√ß√µes</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                            <button type="button" id="btn-validate-all" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white flex-1">
                                <span class="btn-text">Validar APIs</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            
            <!-- VIS√ÉO 7: Painel Admin (Oculto) -->
            <div id="view-admin" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Painel Administrativo</h1>
                    <p class="text-lg text-gray-400">Gerir utilizadores, cr√©ditos e APIs da aplica√ß√£o.</p>
                </header>
                
                <div id="admin-success-message" class="success-message mb-6"></div>
                <div id="admin-error-message" class="error-message mb-6"></div>
            
                <!-- Sistema de Abas -->
                <div class="mb-6 border-b border-gray-700">
                    <nav class="flex space-x-1 overflow-x-auto">
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors active" data-tab="users">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                            Utilizadores
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="credits">
                            <i data-lucide="coins" class="w-4 h-4 inline mr-2"></i>
                            Cr√©ditos
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="apis">
                            <i data-lucide="key" class="w-4 h-4 inline mr-2"></i>
                            APIs
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="pixel">
                            <i data-lucide="target" class="w-4 h-4 inline mr-2"></i>
                            Pixel/Ads
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="payments">
                            <i data-lucide="credit-card" class="w-4 h-4 inline mr-2"></i>
                            Pagamentos
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="subscriptions">
                            <i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i>
                            Assinaturas
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="storage">
                            <i data-lucide="hard-drive" class="w-4 h-4 inline mr-2"></i>
                            Armazenamento
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="notifications">
                            <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i>
                            Notifica√ß√µes
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="plan-permissions">
                            <i data-lucide="shield" class="w-4 h-4 inline mr-2"></i>
                            Permiss√µes de Planos
                        </button>
                    </nav>
                </div>

                <!-- Aba: Utilizadores -->
                <div id="admin-tab-users" class="admin-tab-content space-y-8">
                    <!-- Estatisticas da Aplicacao -->
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-4">Estatisticas da Aplicacao</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Total de Utilizadores</p>
                                <p id="stats-total-users" class="text-3xl font-bold text-white mt-1">...</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Ativacao Pendente</p>
                                <p id="stats-pending-users" class="text-3xl font-bold text-yellow-400 mt-1">...</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Online Agora (15min)</p>
                                <p id="stats-online-users" class="text-3xl font-bold text-green-400 mt-1">...</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Logins (24h)</p>
                                <p id="stats-logins-24h" class="text-3xl font-bold text-white mt-1">...</p>
                            </div>
                        </div>
                        <button id="btn-approve-all" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                            Aprovar Todos os Utilizadores Pendentes
                        </button>
                    </div>
            
                    <!-- Gerenciamento de Utilizadores -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">Gerenciamento de Utilizadores</h2>
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <input id="admin-search-input" type="search" placeholder="Buscar por email, whatsapp ou nome..." class="w-full md:w-1/3 px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="flex items-center gap-4">
                                <select id="admin-status-filter" class="styled-select px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Todos</option>
                                    <option value="active">Ativos</option>
                                    <option value="pending">Pendentes</option>
                                    <option value="blocked">Bloqueados</option>
                                </select>
                                <select class="styled-select px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option>10 por pagina</option>
                                    <option>25 por pagina</option>
                                    <option>50 por pagina</option>
                                </select>
                            </div>
                        </div>
            
                        <div class="overflow-x-auto rounded-lg border border-gray-700">
                            <table id="admin-user-table" class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 w-4"><input type="checkbox" class="bg-gray-700 border-gray-600 rounded"></th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Email</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Whatsapp</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Cargo</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Plano</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Tags</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Acoes</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-table-body">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex justify-end items-center mt-4">
                            <nav class="flex items-center space-x-2 text-sm">
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">Anterior</a>
                                <a href="#" class="px-3 py-1 rounded-md bg-blue-600 text-white">1</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">2</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">3</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">4</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">5</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">Proximo</a>
                            </nav>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Aba: Cr√©ditos -->
                <div id="admin-tab-credits" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- 1. Configura√ß√µes Globais -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">‚öôÔ∏è Configura√ß√µes Globais</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Saldo Inicial (cr√©ditos dados automaticamente a novos usu√°rios)</label>
                                <input type="number" id="initial-bonus-credits" step="0.01" min="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 250">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Multiplicador de Custo para Gera√ß√£o de Voz (TTS)</label>
                                <input type="number" id="tts-credits-multiplier" step="0.1" min="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 2.0">
                                <p class="text-xs text-gray-400 mt-1">Ex: 2.0 = dobra o custo, 0.5 = metade do custo.</p>
                            </div>
                            <button id="save-global-settings" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                Salvar Configura√ß√µes
                            </button>
                        </div>
                    </div>

                    <!-- 2. Consultar Saldo -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üîç Consultar Saldo</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Buscar por Email, Nome ou WhatsApp</label>
                                <input type="text" id="consult-balance-search" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: usuario@email.com, nome ou 5511999999999">
                            </div>
                            <button id="consult-balance-btn" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                Ver Saldo
                            </button>
                            <div id="consult-balance-result" class="hidden mt-4 p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <p class="text-white font-semibold" id="consult-balance-user-info"></p>
                                <p class="text-yellow-400 text-2xl font-bold mt-2" id="consult-balance-amount"></p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Buscar Usu√°rios -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üë• Buscar Usu√°rios</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Buscar por Email, Nome ou WhatsApp</label>
                                <input type="text" id="search-users-input" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Digite para buscar usu√°rios...">
                            </div>
                            <button id="search-users-btn" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                Buscar Usu√°rios
                            </button>
                            <div id="search-users-results" class="mt-4 hidden">
                                <!-- Resultados da busca ser√£o inseridos aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- 4. Adicionar Cr√©ditos (Individual) -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">‚ûï Adicionar Cr√©ditos (Individual)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Buscar Usu√°rio (Email, Nome ou WhatsApp)</label>
                                <input type="text" id="add-credits-user-search" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Digite para buscar...">
                                <div id="add-credits-user-results" class="mt-2 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Quantidade de Cr√©ditos</label>
                                <input type="number" id="add-credits-amount" step="0.01" min="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 1000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Descri√ß√£o (opcional)</label>
                                <input type="text" id="add-credits-description" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: B√¥nus inicial">
                            </div>
                            <button id="add-credits-btn" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                Adicionar Cr√©ditos
                            </button>
                        </div>
                    </div>

                    <!-- 5. Usu√°rios com Saldo Dispon√≠vel -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-white">üí∞ Usu√°rios com Saldo Dispon√≠vel</h2>
                            <button id="refresh-credits-table" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition">
                                Atualizar
                            </button>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Saldo M√≠nimo</label>
                            <input type="number" id="min-balance-filter" step="0.01" min="0" value="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 w-4"><input type="checkbox" id="select-all-users" class="bg-gray-700 border-gray-600 rounded"></th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">EMAIL</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">WHATSAPP</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">TAGS</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">SALDO</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">√öLTIMA ATUALIZA√á√ÉO</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-credits-table-body">
                                    <tr>
                                        <td colspan="7" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagina√ß√£o -->
                        <div class="flex justify-end items-center mt-4">
                            <nav class="flex items-center space-x-2 text-sm" id="credits-pagination">
                                <!-- Pagina√ß√£o ser√° inserida aqui -->
                            </nav>
                        </div>
                    </div>

                    <!-- 6. Estat√≠sticas e Relat√≥rios de Cr√©ditos -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üìä Estat√≠sticas e Relat√≥rios de Cr√©ditos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Data Inicial</label>
                                <input type="date" id="stats-start-date" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Data Final</label>
                                <input type="date" id="stats-end-date" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button id="load-statistics-btn" class="flex-1 px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition">
                                Carregar Estat√≠sticas
                            </button>
                            <button id="export-credits-btn" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                Exportar
                            </button>
                        </div>
                        <div id="statistics-results" class="mt-6 hidden">
                            <!-- Resultados das estat√≠sticas ser√£o inseridos aqui -->
                        </div>
                    </div>
                </div>

                <!-- Aba: APIs -->
                <div id="admin-tab-apis" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configura√ß√£o de Voz Premium (GenAIPro) - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üéôÔ∏è Configura√ß√£o de Voz Premium</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API</label>
                                <div class="flex gap-2">
                                    <input type="text" id="voice-premium-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API aqui">
                                    <button id="check-voice-premium-balance" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Verificar Saldo
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Ap√≥s verificar o saldo, voc√™ poder√° salvar a chave e adicionar cr√©ditos aos usu√°rios.</p>
                                <div id="voice-premium-balance-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-400">Saldo Dispon√≠vel</p>
                                            <p class="text-2xl font-bold text-yellow-400 mt-1" id="voice-premium-balance-amount">0.00</p>
                                        </div>
                                        <button id="save-voice-premium-api" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                            Salvar Chave
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> Ap√≥s salvar a chave, voc√™ poder√° adicionar saldo aos usu√°rios atrav√©s do sistema de cr√©ditos.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√£o de Chave de Voz OpenAI - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üó£Ô∏è Configura√ß√£o de Chave de Voz OpenAI</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API OpenAI</label>
                                <div class="flex gap-2">
                                    <input type="text" id="openai-voice-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API OpenAI aqui">
                                    <button id="validate-openai-voice-api-key" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Validar
                                    </button>
                                    <button id="save-openai-voice-api-key" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar Chave
                                    </button>
                                </div>
                                <div id="openai-voice-api-key-validation-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div id="openai-voice-api-key-validation-message" class="text-sm"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Use esta chave para gerar vozes com a API OpenAI. Se configurada aqui, ser√° usada automaticamente quando o provider de voz for "OpenAI".</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√£o de API de V√≠deo (Gemini/Veo) - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üé• Configura√ß√£o de API de V√≠deo (Gemini/Veo)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API para V√≠deo</label>
                                <div class="flex gap-2">
                                    <input type="text" id="video-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave do Gemini (Veo) aqui">
                                    <button id="validate-video-api-key" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Validar
                                    </button>
                                    <button id="save-video-api-key" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar Chave
                                    </button>
                                </div>
                                <div id="video-api-key-validation-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div id="video-api-key-validation-message" class="text-sm"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Esta chave ser√° usada para gerar v√≠deos com o modelo Veo quando o usu√°rio preferir usar API pr√≥pria. Caso n√£o configure, ser√° usada a chave do usu√°rio ou o provedor externo quando dispon√≠vel.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√£o de Chave de Voz (Google Cloud/Gemini) - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üé§ Configura√ß√£o de Chave de Voz</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API para Voz (Google Cloud/Gemini)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="voice-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API do Google Cloud ou Gemini aqui">
                                    <button id="validate-voice-api-key" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Validar
                                    </button>
                                    <button id="save-voice-api-key" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar Chave
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Esta chave ser√° usada prioritariamente para TTS quando o usu√°rio escolher usar API pr√≥pria do Gemini. Se n√£o configurada, ser√° usada a chave do usu√°rio.</p>
                                <div id="voice-api-key-validation-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div id="voice-api-key-validation-message" class="text-sm"></div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> Esta chave √© usada quando o usu√°rio seleciona "Gemini" como provider de voz e tem prefer√™ncia para usar API pr√≥pria. Se configurada aqui, ser√° usada ao inv√©s da chave do usu√°rio.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√£o de DarkVoz - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">ü§ñ Configura√ß√£o de DarkVoz</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API</label>
                                <div class="flex gap-2">
                                    <input type="text" id="laozhang-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API do DarkVoz aqui">
                                    <button id="check-laozhang-api" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Verificar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Configure a chave de API do DarkVoz para usar os servi√ßos dispon√≠veis na plataforma.</p>
                                <div id="laozhang-api-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-400">Status da API</p>
                                            <p class="text-lg font-bold text-green-400 mt-1" id="laozhang-api-status">V√°lida</p>
                                        </div>
                                        <button id="save-laozhang-api" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                            Salvar Chave
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="laozhang-use-as-default" class="w-5 h-5 bg-gray-800 border-gray-700 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                                    <div>
                                        <span class="text-sm font-medium text-gray-300">Usar DarkVoz como padr√£o para todas as fun√ß√µes</span>
                                        <p class="text-xs text-gray-400 mt-1">Quando ativado, todas as chamadas de IA usar√£o o DarkVoz, independente das prefer√™ncias do usu√°rio.</p>
                                    </div>
                                </label>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> A chave do DarkVoz ser√° usada para acessar as APIs dispon√≠veis na plataforma La Casa Dark Core. Ative a op√ß√£o acima para usar como padr√£o em todas as fun√ß√µes.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gerenciamento de Outras APIs -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-white">Gerenciamento de APIs</h2>
                            <button id="btn-add-api" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                                Adicionar API
                            </button>
                        </div>

                        <!-- Lista de APIs -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Nome</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Modelo</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Cr√©ditos/Unidade</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-apis-table-body">
                                    <tr>
                                        <td colspan="5" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Aba: Pixel/Ads -->
                <div id="admin-tab-pixel" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configura√ß√£o de Facebook Pixel -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üìä Facebook Pixel</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Pixel ID do Facebook</label>
                                <div class="flex gap-2">
                                    <input type="text" id="facebook-pixel-id" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 1234567890123456">
                                    <button id="save-facebook-pixel" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Encontre seu Pixel ID no Gerenciador de Eventos do Facebook. Formato: 15-16 d√≠gitos num√©ricos.</p>
                                <div id="facebook-pixel-status" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                                        <span class="text-sm text-green-400">Pixel configurado com sucesso!</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> O Facebook Pixel permite rastrear convers√µes e otimizar campanhas. Configure o Pixel ID para come√ßar a rastrear eventos na plataforma.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o de Google Ads -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üéØ Google Ads (Conversion Tracking)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">ID de Convers√£o do Google Ads</label>
                                <div class="flex gap-2">
                                    <input type="text" id="google-ads-id" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: AW-123456789">
                                    <button id="save-google-ads" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Encontre seu ID de convers√£o no Google Ads. Formato: AW- seguido de n√∫meros.</p>
                                <div id="google-ads-status" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                                        <span class="text-sm text-green-400">Google Ads configurado com sucesso!</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> Configure o ID de convers√£o para rastrear assinaturas e convers√µes de planos na plataforma.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Status Geral -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üìà Status de Rastreamento</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Facebook Pixel</span>
                                    <span id="facebook-pixel-status-badge" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">N√£o configurado</span>
                                </div>
                                <p id="facebook-pixel-id-display" class="text-sm text-gray-500 mt-1">-</p>
                            </div>
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Google Ads</span>
                                    <span id="google-ads-status-badge" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">N√£o configurado</span>
                                </div>
                                <p id="google-ads-id-display" class="text-sm text-gray-500 mt-1">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o de Webhook WhatsApp -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üì± Webhook WhatsApp (Mensagens Autom√°ticas)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Token de Acesso do WhatsApp Business API</label>
                                <div class="flex gap-2">
                                    <input type="password" id="whatsapp-token" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole seu token aqui">
                                    <button id="toggle-whatsapp-token" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button id="save-whatsapp-token" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Token de acesso da API do WhatsApp Business. Configure para enviar mensagens autom√°ticas.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">N√∫mero do WhatsApp Business (ID)</label>
                                <input type="text" id="whatsapp-number-id" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 123456789012345">
                                <p class="text-xs text-gray-400 mt-1">ID do n√∫mero de telefone do WhatsApp Business.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">URL do Webhook (para receber eventos)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="whatsapp-webhook-url" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" value="/api/whatsapp/webhook" readonly>
                                    <button id="copy-webhook-url" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="copy" class="w-4 h-4 inline mr-2"></i>
                                        Copiar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Configure esta URL no painel do WhatsApp Business para receber eventos.</p>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> Configure o webhook do WhatsApp para enviar mensagens autom√°ticas quando usu√°rios se registram, cancelam planos ou fazem compras.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Templates de Email -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üìß Templates de Email Autom√°tico</h2>
                        <div class="space-y-6">
                            <!-- Template: Registro -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Bem-vindo (Registro)</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-register-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Bem-vindo √† La Casa Dark Core!" value="Bem-vindo √† La Casa Dark Core!">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-register-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Ol√° {{nome}},

Bem-vindo √† La Casa Dark Core! Estamos muito felizes em t√™-lo conosco.

Sua conta foi criada com sucesso e voc√™ j√° pode come√ßar a usar todas as funcionalidades da plataforma.

Seus cr√©ditos iniciais: {{creditos_iniciais}}

Acesse sua conta: {{link_acesso}}

Qualquer d√∫vida, estamos √† disposi√ß√£o!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Vari√°veis dispon√≠veis: {{nome}}, {{email}}, {{creditos_iniciais}}, {{link_acesso}}</p>
                                    </div>
                                    <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('register')">
                                        Salvar Template
                                    </button>
                                </div>
                            </div>

                            <!-- Template: Cancelamento -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Cancelamento de Plano</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-cancel-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Sua assinatura foi cancelada" value="Sua assinatura foi cancelada">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-cancel-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Ol√° {{nome}},

Recebemos sua solicita√ß√£o de cancelamento da assinatura {{plano}}.

Sua assinatura ser√° cancelada em: {{data_cancelamento}}

Voc√™ continuar√° tendo acesso at√©: {{data_fim_acesso}}

Esperamos v√™-lo novamente em breve!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Vari√°veis dispon√≠veis: {{nome}}, {{email}}, {{plano}}, {{data_cancelamento}}, {{data_fim_acesso}}</p>
                                    </div>
                                    <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('cancel')">
                                        Salvar Template
                                    </button>
                                </div>
                            </div>

                            <!-- Template: Pagamento -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Confirma√ß√£o de Pagamento</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-payment-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Pagamento confirmado!" value="Pagamento confirmado!">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-payment-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Ol√° {{nome}},

Seu pagamento foi confirmado com sucesso!

Detalhes da transa√ß√£o:
- Plano: {{plano}}
- Valor: {{valor}}
- Data: {{data_pagamento}}
- Pr√≥xima cobran√ßa: {{proxima_cobranca}}

Obrigado por confiar em n√≥s!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Vari√°veis dispon√≠veis: {{nome}}, {{email}}, {{plano}}, {{valor}}, {{data_pagamento}}, {{proxima_cobranca}}</p>
                                    </div>
                                    <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('payment')">
                                        Salvar Template
                                    </button>
                                </div>
                            </div>

                            <!-- Template: Compra de Pacote -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Compra de Pacote de Cr√©ditos</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-package-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Pacote de cr√©ditos adquirido!" value="Pacote de cr√©ditos adquirido!">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-package-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Ol√° {{nome}},

Seu pacote de cr√©ditos foi adquirido com sucesso!

Detalhes da compra:
- Pacote: {{pacote}}
- Cr√©ditos: {{creditos}}
- Valor: {{valor}}
- Data: {{data_compra}}
- Saldo atual: {{saldo_atual}}

Aproveite seus cr√©ditos!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Vari√°veis dispon√≠veis: {{nome}}, {{email}}, {{pacote}}, {{creditos}}, {{valor}}, {{data_compra}}, {{saldo_atual}}</p>
                                    </div>
                                    <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('package')">
                                        Salvar Template
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Template: Senha Provis√≥ria -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Senha Provis√≥ria</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-password_reset-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Sua senha provis√≥ria" value="Sua senha provis√≥ria - La Casa Dark Core">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-password_reset-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Ol√° {{nome}},

Uma senha provis√≥ria foi gerada para sua conta.

Senha provis√≥ria: {{senha_provisoria}}

Por favor, altere esta senha ap√≥s fazer login pela primeira vez.

Acesse sua conta: {{link_acesso}}

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Vari√°veis dispon√≠veis: {{nome}}, {{email}}, {{senha_provisoria}}, {{link_acesso}}</p>
                                    </div>
                                    <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('password_reset')">
                                        Salvar Template
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Templates de Assinatura por Plano -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Emails de Assinatura por Plano</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-700 text-white">Opcional</span>
                                </div>
                                <p class="text-sm text-gray-400 mb-4">Configure templates personalizados para cada plano. Se n√£o configurar, ser√° usado o template gen√©rico de "Confirma√ß√£o de Pagamento".</p>
                                
                                <div class="space-y-4">
                                    <!-- START CREATOR Mensal -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">START CREATOR (Mensal)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-start-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-start-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- TURBO MAKER Mensal -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">TURBO MAKER (Mensal)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-turbo-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-turbo-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- MASTER PRO Mensal -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">MASTER PRO (Mensal)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-master-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-master-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- START CREATOR Anual -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">START CREATOR (Anual)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-start-annual-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-start-annual-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- TURBO MAKER Anual -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">TURBO MAKER (Anual)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-turbo-annual-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-turbo-annual-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- MASTER PRO Anual -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">MASTER PRO (Anual)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-master-annual-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-master-annual-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition mt-4" onclick="saveAllSubscriptionTemplates()">
                                    Salvar Todos os Templates de Assinatura
                                </button>
                                <p class="text-xs text-gray-400 mt-2">Vari√°veis dispon√≠veis: {{nome}}, {{email}}, {{plano}}, {{valor}}, {{data_pagamento}}, {{proxima_cobranca}}, {{creditos}}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o de SMTP -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">‚öôÔ∏è Configura√ß√£o de SMTP (Envio de Emails)</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Servidor SMTP</label>
                                    <input type="text" id="smtp-host" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: smtp.gmail.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Porta</label>
                                    <input type="number" id="smtp-port" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 587" value="587">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Email de Envio</label>
                                <input type="email" id="smtp-email" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="noreply@lacasadarkcore.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Senha do Email</label>
                                <div class="flex gap-2">
                                    <input type="password" id="smtp-password" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Senha do email">
                                    <button id="toggle-smtp-password" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="smtp-secure" class="w-5 h-5 bg-gray-800 border-gray-700 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                                    <span class="text-sm font-medium text-gray-300">Usar TLS/SSL</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="save-smtp-config" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                Salvar Configura√ß√£o SMTP
                            </button>
                                <button id="test-smtp-config" class="w-full px-4 py-3 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                    Enviar Email de Teste
                                </button>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> Configure o SMTP para enviar emails autom√°ticos. Para Gmail, use uma senha de app. Para outros provedores, consulte a documenta√ß√£o.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Pagamentos (Stripe) -->
                <div id="admin-tab-payments" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configura√ß√£o de Stripe -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üí≥ Configura√ß√£o do Stripe</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave P√∫blica (Publishable Key)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="stripe-publishable-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: pk_live_... ou pk_test_...">
                                    <button id="save-stripe-publishable" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Chave p√∫blica do Stripe. Use pk_test_ para testes ou pk_live_ para produ√ß√£o.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave Secreta (Secret Key)</label>
                                <div class="flex gap-2">
                                    <input type="password" id="stripe-secret-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: sk_live_... ou sk_test_...">
                                    <button id="toggle-stripe-secret" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button id="save-stripe-secret" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Chave secreta do Stripe. Mantenha esta chave em seguran√ßa. Use sk_test_ para testes ou sk_live_ para produ√ß√£o.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Webhook Secret</label>
                                <div class="flex gap-2">
                                    <input type="password" id="stripe-webhook-secret" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: whsec_...">
                                    <button id="toggle-stripe-webhook" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button id="save-stripe-webhook" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Secret do webhook do Stripe para validar eventos. Configure o webhook no painel do Stripe apontando para: <code class="bg-gray-900 px-2 py-1 rounded">/api/stripe/webhook</code></p>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>üí° Dica:</strong> Configure primeiro as chaves de API, depois configure os planos abaixo. O webhook √© necess√°rio para processar pagamentos recorrentes e atualiza√ß√µes de assinatura.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o de Planos Stripe -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üì¶ Configura√ß√£o de Planos</h2>
                        <p class="text-sm text-gray-400 mb-6">Configure os Price IDs do Stripe para cada plano. Crie os produtos e pre√ßos no painel do Stripe e cole os IDs aqui.</p>
                        
                        <!-- Planos Mensais -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Planos Mensais</h3>
                            <div class="space-y-4">
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">FREE</h4>
                                            <p class="text-sm text-gray-400">R$ 0,00 - 100 cr√©ditos/m√™s</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Gratuito</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe (opcional - para upgrades)</label>
                                        <input type="text" id="stripe-plan-free" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_... (deixe vazio se for gratuito)">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">START CREATOR</h4>
                                            <p class="text-sm text-gray-400">R$ 79,90 - 1.000 cr√©ditos/m√™s</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-start" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-amber-500 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">TURBO MAKER</h4>
                                            <p class="text-sm text-gray-400">R$ 99,90 - 2.500 cr√©ditos/m√™s</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-amber-500 text-black">MAIS POPULAR</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-turbo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">MASTER PRO</h4>
                                            <p class="text-sm text-gray-400">R$ 149,90 - 5.000 cr√©ditos/m√™s</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-600 text-white">PRO</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-master" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Planos Anuais -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Planos Anuais</h3>
                            <div class="space-y-4">
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">START CREATOR ANUAL</h4>
                                            <p class="text-sm text-gray-400">R$ 699,00 - 12.000 cr√©ditos/ano</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-start-annual" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-amber-500 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">TURBO MAKER ANUAL</h4>
                                            <p class="text-sm text-gray-400">R$ 999,00 - 30.000 cr√©ditos/ano</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-amber-500 text-black">MAIS POPULAR</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-turbo-annual" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">MASTER PRO ANUAL</h4>
                                            <p class="text-sm text-gray-400">R$ 1.499,00 - 60.000 cr√©ditos/ano</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-600 text-white">PRO</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-master-annual" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pacotes de Cr√©ditos -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Pacotes de Cr√©ditos</h3>
                            <div class="space-y-4">
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">1.000 Cr√©ditos</h4>
                                            <p class="text-sm text-gray-400">R$ 79,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-1000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">2.500 Cr√©ditos</h4>
                                            <p class="text-sm text-gray-400">R$ 99,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-2500" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">5.000 Cr√©ditos</h4>
                                            <p class="text-sm text-gray-400">R$ 149,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-5000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">10.000 Cr√©ditos</h4>
                                            <p class="text-sm text-gray-400">R$ 249,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-10000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">20.000 Cr√©ditos</h4>
                                            <p class="text-sm text-gray-400">R$ 399,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-20000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="save-all-stripe-plans" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Salvar Todas as Configura√ß√µes de Planos
                        </button>
                    </div>

                    <!-- Status do Stripe -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üîê Status da Configura√ß√£o</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Chave P√∫blica</span>
                                    <span id="stripe-publishable-status" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">N√£o configurado</span>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Chave Secreta</span>
                                    <span id="stripe-secret-status" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">N√£o configurado</span>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Webhook</span>
                                    <span id="stripe-webhook-status" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">N√£o configurado</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Assinaturas -->
                <div id="admin-tab-subscriptions" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Filtros e A√ß√µes -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Per√≠odo</label>
                                <select id="subscriptions-period-filter" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                                    <option value="7">√öltimos 7 dias</option>
                                    <option value="30" selected>√öltimos 30 dias</option>
                                    <option value="90">√öltimos 90 dias</option>
                                    <option value="365">√öltimo ano</option>
                                    <option value="all">Todo o per√≠odo</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                                <select id="subscriptions-status-filter" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                                    <option value="all">Todas</option>
                                    <option value="active">Ativas</option>
                                    <option value="canceled">Canceladas</option>
                                    <option value="past_due">Atrasadas</option>
                                    <option value="trialing">Em teste</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                            <button id="refresh-subscriptions" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2 shadow-lg hover:shadow-xl active:scale-95">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Atualizar</span>
                            </button>
                                <button id="export-subscriptions" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Resumo Geral -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-4">üìä Resumo Geral</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Receita Total</span>
                                    <i data-lucide="dollar-sign" class="w-5 h-5 text-green-400"></i>
                                </div>
                                <p id="summary-total-revenue" class="text-2xl font-bold text-white">R$ 0,00</p>
                                <p class="text-xs text-gray-500 mt-1">Todas as receitas acumuladas</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Receita Mensal</span>
                                    <i data-lucide="calendar" class="w-5 h-5 text-blue-400"></i>
                                </div>
                                <p id="summary-monthly-revenue" class="text-2xl font-bold text-white">R$ 0,00</p>
                                <p class="text-xs text-gray-500 mt-1">Receita do m√™s atual</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Total de Assinaturas</span>
                                    <i data-lucide="users" class="w-5 h-5 text-purple-400"></i>
                                </div>
                                <p id="summary-total-subscriptions" class="text-2xl font-bold text-white">0</p>
                                <p class="text-xs text-gray-500 mt-1">Todas as assinaturas (ativas + canceladas)</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Taxa de Convers√£o</span>
                                    <i data-lucide="trending-up" class="w-5 h-5 text-amber-400"></i>
                                </div>
                                <p id="summary-conversion-rate" class="text-2xl font-bold text-white">0%</p>
                                <p class="text-xs text-gray-500 mt-1">Taxa de convers√£o em assinaturas</p>
                            </div>
                        </div>
                    </div>

                    <!-- M√©tricas Principais (KPIs) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-800 border border-blue-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-blue-200 font-medium">MRR</span>
                                <i data-lucide="trending-up" class="w-5 h-5 text-blue-200"></i>
                            </div>
                            <p id="kpi-mrr" class="text-3xl font-bold text-white mb-2">R$ 0,00</p>
                            <div id="kpi-mrr-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-blue-300">Receita Recorrente Mensal</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-800 border border-green-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-green-200 font-medium">ARR</span>
                                <i data-lucide="dollar-sign" class="w-5 h-5 text-green-200"></i>
                            </div>
                            <p id="kpi-arr" class="text-3xl font-bold text-white mb-2">R$ 0,00</p>
                            <div id="kpi-arr-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-green-300">Receita Recorrente Anual</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-800 border border-purple-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-purple-200 font-medium">Assinantes Ativos</span>
                                <i data-lucide="users" class="w-5 h-5 text-purple-200"></i>
                            </div>
                            <p id="kpi-active-subscribers" class="text-3xl font-bold text-white mb-2">0</p>
                            <div id="kpi-active-subscribers-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-purple-300">Total de assinantes ativos</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-600 to-amber-800 border border-amber-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-amber-200 font-medium">Churn Rate</span>
                                <i data-lucide="alert-circle" class="w-5 h-5 text-amber-200"></i>
                            </div>
                            <p id="kpi-churn-rate" class="text-3xl font-bold text-white mb-2">0%</p>
                            <div id="kpi-churn-rate-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-amber-300">Taxa de cancelamento</p>
                        </div>
                    </div>

                    <!-- M√©tricas Secund√°rias e Mensais -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-blue-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Novos Assinantes</span>
                                <i data-lucide="user-plus" class="w-5 h-5 text-blue-400"></i>
                            </div>
                            <p id="kpi-new-subscribers" class="text-2xl font-bold text-white">0</p>
                            <p class="text-xs text-gray-500 mt-1">No per√≠odo selecionado</p>
                        </div>
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-red-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Cancelamentos</span>
                                <i data-lucide="user-x" class="w-5 h-5 text-red-400"></i>
                            </div>
                            <p id="kpi-cancellations" class="text-2xl font-bold text-white">0</p>
                            <p class="text-xs text-gray-500 mt-1">No per√≠odo selecionado</p>
                        </div>
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-green-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">LTV (Lifetime Value)</span>
                                <i data-lucide="briefcase" class="w-5 h-5 text-green-400"></i>
                            </div>
                            <p id="kpi-ltv" class="text-2xl font-bold text-white">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">Valor m√©dio por cliente</p>
                        </div>
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-purple-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Tempo M√©dio</span>
                                <i data-lucide="clock" class="w-5 h-5 text-purple-400"></i>
                            </div>
                            <p id="kpi-avg-duration" class="text-2xl font-bold text-white">0 dias</p>
                            <p class="text-xs text-gray-500 mt-1">Dura√ß√£o m√©dia das assinaturas</p>
                        </div>
                    </div>

                    <!-- M√©tricas Mensais Detalhadas -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">üìÖ An√°lise Mensal</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Receita do M√™s</span>
                                    <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i>
                                </div>
                                <p id="monthly-revenue" class="text-xl font-bold text-white">R$ 0,00</p>
                                <p class="text-xs text-gray-500 mt-1">M√™s atual</p>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Novos (M√™s)</span>
                                    <i data-lucide="arrow-up" class="w-4 h-4 text-green-400"></i>
                                </div>
                                <p id="monthly-new" class="text-xl font-bold text-white">0</p>
                                <p class="text-xs text-gray-500 mt-1">Novos assinantes este m√™s</p>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Cancelados (M√™s)</span>
                                    <i data-lucide="arrow-down" class="w-4 h-4 text-red-400"></i>
                                </div>
                                <p id="monthly-canceled" class="text-xl font-bold text-white">0</p>
                                <p class="text-xs text-gray-500 mt-1">Cancelamentos este m√™s</p>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Crescimento</span>
                                    <i data-lucide="trending-up" class="w-4 h-4 text-amber-400"></i>
                                </div>
                                <p id="monthly-growth" class="text-xl font-bold text-white">0%</p>
                                <p class="text-xs text-gray-500 mt-1">Crescimento mensal</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficos -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Gr√°fico MRR ao longo do tempo -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">MRR ao Longo do Tempo</h3>
                            <div class="w-full" style="height: 400px; position: relative;">
                                <canvas id="mrr-chart" style="max-height: 400px;"></canvas>
                            </div>
                        </div>
                        <!-- Gr√°fico de Assinantes -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">Evolu√ß√£o de Assinantes</h3>
                            <div class="w-full" style="height: 400px; position: relative;">
                                <canvas id="subscribers-chart" style="max-height: 400px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Gr√°fico de Distribui√ß√£o por Plano -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 overflow-hidden">
                            <h3 class="text-lg font-semibold text-white mb-4">Distribui√ß√£o por Plano</h3>
                            <div class="relative" style="height: 300px; overflow: hidden;">
                                <canvas id="plans-distribution-chart"></canvas>
                            </div>
                        </div>
                        <!-- Gr√°fico de Churn Rate -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 overflow-hidden">
                            <h3 class="text-lg font-semibold text-white mb-4">Churn Rate Mensal</h3>
                            <div class="relative" style="height: 300px; overflow: hidden;">
                                <canvas id="churn-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Assinaturas -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Lista de Assinaturas</h3>
                            <div class="flex gap-2">
                                <input type="text" id="subscriptions-search" placeholder="Buscar por email ou nome..." class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 text-sm">
                                <button id="export-subscriptions" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition text-sm">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Usu√°rio</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Plano</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Valor Mensal</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">In√≠cio</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Pr√≥xima Cobran√ßa</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Dura√ß√£o</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Total Pago</th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptions-table-body">
                                    <tr>
                                        <td colspan="8" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagina√ß√£o -->
                        <div class="flex justify-end items-center mt-4">
                            <nav class="flex items-center space-x-2 text-sm" id="subscriptions-pagination">
                                <!-- Pagina√ß√£o ser√° inserida aqui -->
                            </nav>
                        </div>
                    </div>

                    <!-- Relat√≥rios e An√°lises -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Relat√≥rio de Receitas -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">üí∞ Relat√≥rio de Receitas</h3>
                                <button id="export-revenue-report" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                                    Exportar
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita Total Acumulada</span>
                                    <span id="report-total-revenue" class="text-lg font-bold text-white">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita dos √öltimos 30 Dias</span>
                                    <span id="report-30d-revenue" class="text-lg font-bold text-green-400">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita dos √öltimos 90 Dias</span>
                                    <span id="report-90d-revenue" class="text-lg font-bold text-blue-400">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita do Ano</span>
                                    <span id="report-year-revenue" class="text-lg font-bold text-purple-400">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Ticket M√©dio</span>
                                    <span id="report-avg-ticket" class="text-lg font-bold text-amber-400">R$ 0,00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Relat√≥rio de Assinaturas -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">üìä Relat√≥rio de Assinaturas</h3>
                                <button id="export-subscriptions-report" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                                    Exportar
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Total de Assinaturas</span>
                                    <span id="report-total-subs" class="text-lg font-bold text-white">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Assinaturas Ativas</span>
                                    <span id="report-active-subs" class="text-lg font-bold text-green-400">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Assinaturas Canceladas</span>
                                    <span id="report-canceled-subs" class="text-lg font-bold text-red-400">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Taxa de Reten√ß√£o</span>
                                    <span id="report-retention-rate" class="text-lg font-bold text-blue-400">0%</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Taxa de Churn</span>
                                    <span id="report-churn-rate" class="text-lg font-bold text-amber-400">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights e An√°lises -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">üí° Insights e An√°lises</h3>
                        <div id="subscriptions-insights" class="space-y-4">
                            <div class="p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">Carregando insights...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Armazenamento -->
                <div id="admin-tab-storage" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Estat√≠sticas do Servidor -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                            <i data-lucide="server" class="w-6 h-6 mr-2 text-indigo-500"></i>
                            Estat√≠sticas do Servidor
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Espa√ßo Total</span>
                                    <i data-lucide="hard-drive" class="w-5 h-5 text-blue-400"></i>
                                </div>
                                <p id="server-total-space" class="text-2xl font-bold text-white">0 GB</p>
                                <p class="text-xs text-gray-500 mt-1">Capacidade total do servidor</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Espa√ßo Usado (Usu√°rios)</span>
                                    <i data-lucide="database" class="w-5 h-5 text-yellow-400"></i>
                                </div>
                                <p id="server-users-storage" class="text-2xl font-bold text-white">0 GB</p>
                                <p class="text-xs text-gray-500 mt-1">Total usado por todos os usu√°rios</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Arquivos Tempor√°rios</span>
                                    <i data-lucide="folder" class="w-5 h-5 text-green-400"></i>
                                </div>
                                <p id="server-temp-storage" class="text-2xl font-bold text-white">0 MB</p>
                                <p class="text-xs text-gray-500 mt-1">Pasta temp_audio</p>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Usu√°rios e Armazenamento -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-white flex items-center">
                                <i data-lucide="users" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                Armazenamento por Usu√°rio
                            </h2>
                            <div class="flex gap-2">
                                <input type="text" id="storage-search" placeholder="Buscar por email ou nome..." class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 text-sm">
                                <button id="refresh-storage-stats" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition text-sm">
                                    <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                                    Atualizar
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Usu√°rio</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Plano</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Usado</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Limite</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Uso</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="storage-table-body">
                                    <tr>
                                        <td colspan="6" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Aba: Notifica√ß√µes -->
                <div id="admin-tab-notifications" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configura√ß√£o de Notifica√ß√µes -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="settings" class="w-5 h-5 mr-2 text-indigo-500"></i>
                            Configura√ß√£o de Notifica√ß√µes
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i data-lucide="shopping-cart" class="w-4 h-4 mr-2 text-green-500"></i>
                                    Notifica√ß√µes de Compra
                                </h3>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notif-purchase-enabled" class="mr-2">
                                        <span class="text-gray-300">Ativar notifica√ß√µes de compra</span>
                                    </label>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Intervalo entre notifica√ß√µes (segundos)</label>
                                        <input type="number" id="notif-purchase-interval" value="5" min="1" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Mensagem padr√£o</label>
                                        <textarea id="notif-purchase-message" rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white" placeholder="Ex: {name} acabou de comprar {plan}">üéâ {name} acabou de comprar o plano {plan}!</textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i data-lucide="user-plus" class="w-4 h-4 mr-2 text-blue-500"></i>
                                    Notifica√ß√µes de Novos Usu√°rios
                                </h3>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notif-user-enabled" class="mr-2">
                                        <span class="text-gray-300">Ativar notifica√ß√µes de novos usu√°rios</span>
                                    </label>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Intervalo entre notifica√ß√µes (segundos)</label>
                                        <input type="number" id="notif-user-interval" value="5" min="1" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Mensagem padr√£o</label>
                                        <textarea id="notif-user-message" rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white" placeholder="Ex: {name} acabou de se cadastrar">üëã {name} acabou de se cadastrar na plataforma!</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button id="save-notifications-config" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Salvar Configura√ß√µes
                            </button>
                            <button id="test-notification-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i>
                                Testar Notifica√ß√£o
                            </button>
                        </div>
                    </div>

                    <!-- Usu√°rios Fict√≠cios -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="users" class="w-5 h-5 mr-2 text-purple-500"></i>
                            Usu√°rios Fict√≠cios
                        </h2>
                        <div class="mb-4 flex gap-3">
                            <button id="add-fake-user-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                                Adicionar Usu√°rio Fict√≠cio
                            </button>
                            <button id="create-bulk-users-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                                Criar 100 Usu√°rios (50 Compra + 50 Novo)
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Nome</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Email</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Tipo</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="fake-users-table-body">
                                    <tr>
                                        <td colspan="5" class="p-4 text-center text-gray-400">Nenhum usu√°rio fict√≠cio cadastrado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controles de Loop -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="play-circle" class="w-5 h-5 mr-2 text-amber-500"></i>
                            Controles de Loop
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">Notifica√ß√µes de Compra</h3>
                                <div class="space-y-3">
                                    <button id="start-purchase-loop" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                                        Iniciar Loop
                                    </button>
                                    <button id="stop-purchase-loop" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition" disabled>
                                        <i data-lucide="stop-circle" class="w-4 h-4 inline mr-2"></i>
                                        Parar Loop
                                    </button>
                                    <div class="text-sm text-gray-400">
                                        Status: <span id="purchase-loop-status" class="text-gray-300">Parado</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">Notifica√ß√µes de Novos Usu√°rios</h3>
                                <div class="space-y-3">
                                    <button id="start-user-loop" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                                        Iniciar Loop
                                    </button>
                                    <button id="stop-user-loop" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition" disabled>
                                        <i data-lucide="stop-circle" class="w-4 h-4 inline mr-2"></i>
                                        Parar Loop
                                    </button>
                                    <div class="text-sm text-gray-400">
                                        Status: <span id="user-loop-status" class="text-gray-300">Parado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Permiss√µes de Planos -->
                <div id="admin-tab-plan-permissions" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configura√ß√£o de Cr√©ditos por Plano -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="coins" class="w-5 h-5 mr-2 text-yellow-500"></i>
                            Cr√©ditos Mensais por Plano
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="plan-credits-list">
                            <!-- Ser√° preenchido via JavaScript -->
                        </div>
                    </div>

                    <!-- Permiss√µes por Plano -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="shield" class="w-5 h-5 mr-2 text-indigo-500"></i>
                            Permiss√µes de Funcionalidades por Plano
                        </h2>
                        <div id="plan-permissions-list" class="space-y-6">
                            <!-- Ser√° preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal para V√≠deos do Canal -->
    <div id="channel-videos-modal" class="fixed inset-0 bg-black/70 z-40 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-white">√öltimos V√≠deos do Canal</h2>
                <button id="modal-close-btn" class="p-2 text-gray-400 hover:text-white rounded-full">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="modal-loading" class="text-center py-8" style="display: none;">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-amber-500">A procurar v√≠deos...</p>
            </div>
            <div id="modal-error" class="error-message" style="display: none;"></div>
            <div id="modal-video-list" class="overflow-y-auto flex-1 space-y-6 pr-2">
                <!-- Lista de v√≠deos ser√° inserida aqui -->
            </div>
        </div>
    </div>

    <!-- Container de Notifica√ß√µes -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Modal Customizado (substitui prompt/confirm) -->
    <div id="custom-modal-overlay" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="custom-modal-title">
                    <i data-lucide="alert-circle" class="w-5 h-5"></i>
                    <span id="custom-modal-title-text">Confirma√ß√£o</span>
                </h3>
                <button class="custom-modal-close" id="custom-modal-close">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="custom-modal-body">
                <p class="custom-modal-message" id="custom-modal-message"></p>
                <input type="text" id="custom-modal-input" class="custom-modal-input" style="display: none;" placeholder="">
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="custom-modal-cancel">Cancelar</button>
                <button class="custom-modal-btn custom-modal-btn-primary" id="custom-modal-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Utilizador (Admin) -->
    <div id="edit-user-modal" class="fixed inset-0 bg-black/70 z-40 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Editar Utilizador</h2>
                <button id="edit-user-modal-close-btn" class="p-2 text-gray-400 hover:text-white rounded-full">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label for="edit-user-name" class="block text-sm font-medium mb-2">Nome</label>
                    <input type="text" id="edit-user-name" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div>
                    <label for="edit-user-email" class="block text-sm font-medium mb-2">Email (n√£o pode ser alterado)</label>
                    <input type="email" id="edit-user-email" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-400 cursor-not-allowed" readonly>
                </div>
                <div>
                    <label for="edit-user-whatsapp" class="block text-sm font-medium mb-2">WhatsApp</label>
                    <input type="text" id="edit-user-whatsapp" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-user-role" class="block text-sm font-medium mb-2">Cargo</label>
                        <select id="edit-user-role" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="user">Utilizador</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-user-status" class="block text-sm font-medium mb-2">Status</label>
                        <select id="edit-user-status" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="pending">Pendente</option>
                            <option value="active">Ativo</option>
                            <option value="blocked">Bloqueado</option>
                        </select>
                    </div>
                </div>
                <div class="pt-4">
                    <button type="submit" id="btn-save-user" class="w-full py-3 px-4 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center space-x-2">
                        <span>Salvar Altera√ß√µes</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Personalizado para Mensagens -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[100]" style="display: none;">
        <div id="custom-modal-box" class="bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div id="custom-modal-icon-container" class="w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-amber-500"></i>
                    </div>
                    <h3 id="custom-modal-title" class="text-xl font-bold text-white">Aviso</h3>
                </div>
                <button id="custom-modal-close" class="text-gray-400 hover:text-white transition-colors p-1 rounded hover:bg-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <p id="custom-modal-message" class="text-gray-300 leading-relaxed"></p>
            </div>
            <div class="flex justify-end">
                <button id="custom-modal-ok" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors shadow-lg">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Criar Agente de Roteiro -->
    <div id="create-agent-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Criar Agente de Roteiro</h3>
                <button id="btn-close-agent-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="create-agent-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Agente</label>
                    <input type="text" id="agent-name-input" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Nicho</label>
                        <input type="text" id="agent-niche-input" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Subnicho</label>
                        <input type="text" id="agent-subniche-input" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">
                        Transcri√ß√£o Manual (Opcional)
                        <span class="text-xs text-gray-400 ml-2">Cole aqui a transcri√ß√£o do v√≠deo se a autom√°tica n√£o funcionar</span>
                    </label>
                    <textarea id="agent-manual-transcript" rows="8" placeholder="Cole aqui a transcri√ß√£o completa do v√≠deo..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                    <p class="text-xs text-gray-400 mt-1">Se voc√™ colar uma transcri√ß√£o manual aqui, ela ser√° usada em vez da transcri√ß√£o autom√°tica.</p>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="btn-cancel-agent" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                    <button type="submit" id="btn-submit-agent" class="py-2 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-semibold flex items-center space-x-2">
                        <span>Criar Agente</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o da F√≥rmula do Agente -->
    <div id="agent-formula-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-amber-500 rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-2xl font-semibold text-white">Revisar F√≥rmula do Agente</h3>
                    <p class="text-sm text-gray-400">A IA vai replicar exatamente os elementos abaixo no novo agente.</p>
                </div>
                <button id="agent-formula-close" class="text-gray-400 hover:text-white">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div id="agent-formula-content" class="space-y-4 text-sm text-gray-200">
                <!-- Conte√∫do preenchido dinamicamente -->
            </div>
            <div class="mt-6 flex flex-col md:flex-row md:justify-end gap-3">
                <button id="agent-formula-cancel" class="w-full md:w-auto px-4 py-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-semibold">Voltar e editar</button>
                <button id="agent-formula-confirm" class="w-full md:w-auto px-4 py-3 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold flex items-center justify-center gap-2">
                    <i data-lucide="check-circle"></i>
                    <span>Confirmar e Criar Agente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Trocar Senha (Admin) -->
    <div id="change-password-modal" class="fixed inset-0 bg-black/70 z-40 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Trocar Senha</h2>
                <button id="change-password-modal-close-btn" class="p-2 text-gray-400 hover:text-white rounded-full">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form id="change-password-form" class="space-y-4">
                <input type="hidden" id="change-password-user-id">
                <p class="text-sm text-gray-400">A definir nova senha para <strong id="change-password-user-email" class="text-amber-400"></strong>.</p>
                <div>
                    <label for="new-password" class="block text-sm font-medium mb-2">Nova Senha (m√≠nimo 6 caracteres)</label>
                    <input type="password" id="new-password" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required minlength="6">
                </div>
                <div class="pt-4">
                    <button type="submit" id="btn-save-password" class="w-full py-3 px-4 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center space-x-2">
                        <span>Definir Nova Senha</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
        
            // URLs da API - Detecta automaticamente a porta do backend
            // Se estiver rodando no live-server (porta 5500) ou n√£o estiver na porta 5001, usa o backend na porta 5001
            const currentPort = window.location.port;
            const isBackendPort = currentPort === '5001' || currentPort === '';
            const API_BASE = isBackendPort 
                ? '' 
                : `http://${window.location.hostname}:5001`;
            
            console.log('API_BASE configurado:', API_BASE, { currentPort, isBackendPort });

            // Vari√°veis globais para progresso de roteiro
            let scriptProgressSource = null;
            let scriptProgressFallbackInterval = null;
            let currentProgressSessionId = null;

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error('Script Lucide (√≠cones) n√£o carregou a tempo.');
            }

            const userToken = localStorage.getItem('core_token');

            let currentAnalysisData = {
                videoId: null,
                niche: null,
                subniche: null,
                model: null,
                generatedTitles: []
            };
            
            let userFolders = [];
            
            // Fun√ß√£o global para formatar nome do modelo sem mostrar fornecedor
            window.formatModelNameForDisplay = function(model) {
                if (!model) return 'N/A';
                // Remover prefixos de fornecedores
                if (model.includes('laozhang-gpt-4o') || model.includes('gpt-4o')) return 'GPT-4o';
                if (model.includes('claude-3-7-sonnet') || model.includes('sonnet-3-7')) return '3.7 Sonnet';
                if (model.includes('claude-sonnet-4') || model.includes('sonnet-4')) return 'Sonnet 4';
                if (model.includes('claude-opus-4') || model.includes('opus-4')) return 'Opus 4';
                if (model.includes('claude-3-5-haiku') || model.includes('haiku-3-5')) return '3.5 Haiku';
                if (model.includes('claude-3-opus') || model.includes('opus-3')) return '3 Opus';
                if (model.includes('gemini-2.5-pro') || model.includes('2.5-pro')) return '2.5 Pro';
                if (model.includes('gemini-2.5-flash') || model.includes('2.5-flash')) return '2.5 Flash';
                if (model.includes('gemini-2.0-flash') || model.includes('2.0-flash')) return '2.0 Flash';
                if (model.includes('gpt-4o')) return 'GPT-4o';
                if (model.includes('gpt-4o-mini')) return 'GPT-4o Mini';
                if (model.includes('gpt-4-turbo')) return 'GPT-4 Turbo';
                // Remover prefixos de fornecedores
                let cleanModel = model.replace(/^(laozhang-|claude-|gemini-|gpt-)/i, '');
                return cleanModel.replace(/^(claude|gemini|gpt|laozhang)-/i, '');
            };

            // --- FUN√á√ïES GLOBAIS DE MENSAGEM (Gen√©ricas) ---
            // Fun√ß√£o para mostrar modal personalizado
            function showCustomModal(title, message, type = 'info') {
                const modal = document.getElementById('custom-modal');
                const modalTitle = document.getElementById('custom-modal-title');
                const modalMessage = document.getElementById('custom-modal-message');
                const modalClose = document.getElementById('custom-modal-close');
                const modalOk = document.getElementById('custom-modal-ok');
                const modalBox = document.getElementById('custom-modal-box');
                const modalIconContainer = document.getElementById('custom-modal-icon-container');

                if (!modal || !modalTitle || !modalMessage) {
                    console.error('[Modal] Elementos n√£o encontrados');
                    alert(title + ': ' + message); // Fallback
                    return;
                }

                // Configurar t√≠tulo e mensagem
                modalTitle.textContent = title;
                modalMessage.textContent = message;

                // Configurar cores baseado no tipo
                if (type === 'error') {
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'alert-circle');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-red-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition-colors';
                    }
                } else if (type === 'success') {
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'check-circle');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-green-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-green-600 hover:bg-green-500 text-white font-semibold rounded-lg transition-colors';
                    }
                } else {
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'info');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors';
                    }
                }

                // Mostrar modal
                modal.style.display = 'flex';
                
                // Atualizar √≠cones
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Fechar modal ao clicar em OK ou X
                const closeModal = () => {
                    modal.style.display = 'none';
                };

                if (modalClose) {
                    modalClose.onclick = closeModal;
                }
                if (modalOk) {
                    modalOk.onclick = closeModal;
                }

                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                };
            }

            // ================================================
            // SISTEMA DE MODAL CUSTOMIZADO
            // ================================================
            
            function showCustomConfirm(message, title = 'Confirma√ß√£o') {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('custom-modal-overlay');
                    const titleEl = document.getElementById('custom-modal-title-text');
                    const messageEl = document.getElementById('custom-modal-message');
                    const inputEl = document.getElementById('custom-modal-input');
                    const confirmBtn = document.getElementById('custom-modal-confirm');
                    const cancelBtn = document.getElementById('custom-modal-cancel');
                    const closeBtn = document.getElementById('custom-modal-close');
                    
                    // Configurar modal
                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    inputEl.style.display = 'none';
                    confirmBtn.textContent = 'Confirmar';
                    
                    // Mostrar modal
                    overlay.style.display = 'flex';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Handlers
                    const cleanup = () => {
                        overlay.style.display = 'none';
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        closeBtn.onclick = null;
                    };
                    
                    confirmBtn.onclick = () => {
                        cleanup();
                        resolve(true);
                    };
                    
                    cancelBtn.onclick = () => {
                        cleanup();
                        resolve(false);
                    };
                    
                    closeBtn.onclick = () => {
                        cleanup();
                        resolve(false);
                    };
                });
            }
            
            function showCustomPrompt(message, defaultValue = '', title = 'Entrada') {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('custom-modal-overlay');
                    const titleEl = document.getElementById('custom-modal-title-text');
                    const messageEl = document.getElementById('custom-modal-message');
                    const inputEl = document.getElementById('custom-modal-input');
                    const confirmBtn = document.getElementById('custom-modal-confirm');
                    const cancelBtn = document.getElementById('custom-modal-cancel');
                    const closeBtn = document.getElementById('custom-modal-close');
                    
                    // Configurar modal
                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    inputEl.style.display = 'block';
                    inputEl.value = defaultValue;
                    inputEl.focus();
                    inputEl.select();
                    confirmBtn.textContent = 'OK';
                    
                    // Mostrar modal
                    overlay.style.display = 'flex';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Handlers
                    const cleanup = () => {
                        overlay.style.display = 'none';
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        closeBtn.onclick = null;
                        inputEl.onkeydown = null;
                    };
                    
                    const handleConfirm = () => {
                        const value = inputEl.value;
                        cleanup();
                        resolve(value);
                    };
                    
                    const handleCancel = () => {
                        cleanup();
                        resolve(null);
                    };
                    
                    confirmBtn.onclick = handleConfirm;
                    cancelBtn.onclick = handleCancel;
                    closeBtn.onclick = handleCancel;
                    
                    inputEl.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleConfirm();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            handleCancel();
                        }
                    };
                });
            }
            
            // ================================================
            // SISTEMA DE NOTIFICA√á√ïES
            // ================================================
            
            function showNotification(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('notification-container');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = 'notification';
                
                const icons = {
                    info: 'info',
                    success: 'check-circle',
                    warning: 'alert-triangle',
                    error: 'x-circle',
                    user: 'user-plus',
                    purchase: 'shopping-cart'
                };
                
                const icon = icons[type] || 'info';
                
                notification.innerHTML = `
                    <button class="notification-close">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                    <div class="notification-header">
                        <i data-lucide="${icon}" class="notification-icon"></i>
                        <span class="notification-title">${title}</span>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                container.appendChild(notification);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // Auto-remover ap√≥s dura√ß√£o
                if (duration > 0) {
                    setTimeout(() => {
                        notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                        setTimeout(() => notification.remove(), 300);
                    }, duration);
                }
                
                // Bot√£o de fechar
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                });
            }
            
            // Polling para notifica√ß√µes
            let notificationPollInterval = null;
            
            function startNotificationPolling() {
                if (notificationPollInterval) return;
                
                // Rastrear notifica√ß√µes j√° exibidas para evitar duplicatas
                const displayedNotifications = new Set();
                
                notificationPollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/notifications/pending`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (response.ok) {
                            const notifications = await response.json();
                            notifications.forEach(notif => {
                                // S√≥ exibir se ainda n√£o foi exibida nesta sess√£o
                                if (!displayedNotifications.has(notif.id)) {
                                    showNotification(notif.title, notif.message, notif.type, notif.duration || 5000);
                                    displayedNotifications.add(notif.id);
                                    
                                    // Marcar como lida apenas ap√≥s o tempo de exibi√ß√£o
                                    setTimeout(() => {
                                        fetch(`${API_BASE}/api/notifications/${notif.id}/read`, {
                                            method: 'POST',
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        }).catch(() => {});
                                        // Remover do set ap√≥s marcar como lida para permitir nova exibi√ß√£o se necess√°rio
                                        displayedNotifications.delete(notif.id);
                                    }, notif.duration || 5000);
                                }
                            });
                        }
                    } catch (err) {
                        console.error('Erro ao buscar notifica√ß√µes:', err);
                    }
                }, 2000); // Verificar a cada 2 segundos para melhor responsividade
            }
            
            function stopNotificationPolling() {
                if (notificationPollInterval) {
                    clearInterval(notificationPollInterval);
                    notificationPollInterval = null;
                }
            }
            
            // Fun√ß√£o para mostrar modal de loading gen√©rico
            function showLoadingModal(message = 'Processando...', icon = 'sparkles') {
                // Remover modal existente se houver
                const existingModal = document.getElementById('generic-loading-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const modal = document.createElement('div');
                modal.id = 'generic-loading-modal';
                modal.className = 'custom-modal-overlay';
                modal.innerHTML = `
                    <div class="custom-modal">
                        <div class="custom-modal-header">
                            <div class="custom-modal-title">
                                <i data-lucide="${icon}" class="w-5 h-5 text-amber-400 animate-spin"></i>
                                <span>${message}</span>
                            </div>
                        </div>
                        <div class="custom-modal-body">
                            <div class="flex items-center justify-center py-8">
                                <div class="loader"></div>
                            </div>
                            <p class="custom-modal-message text-center">Aguarde enquanto processamos sua solicita√ß√£o...</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            // Fun√ß√£o para esconder modal de loading
            function hideLoadingModal() {
                const modal = document.getElementById('generic-loading-modal');
                if (modal) {
                    modal.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => modal.remove(), 200);
                }
            }
            
            function showMessage(elementId, message, isError = false) {
                const msgBox = document.getElementById(elementId);
                if (!msgBox) return;
                
                msgBox.innerHTML = message;
                msgBox.style.display = 'block';
                
                const successId = isError ? elementId.replace('error', 'success') : '';
                const errorId = !isError ? elementId.replace('success', 'error') : '';
                
                if (successId && document.getElementById(successId)) {
                    document.getElementById(successId).style.display = 'none';
                }
                if (errorId && document.getElementById(errorId)) {
                    document.getElementById(errorId).style.display = 'none';
                }
                
                setTimeout(() => { msgBox.style.display = 'none'; }, 5000);
            }
            
            function hideMessage(elementId) {
                const msgBox = document.getElementById(elementId);
                if (msgBox) {
                    msgBox.style.display = 'none';
                }
            }

            function setButtonLoading(button, isLoading) {
                if (!button) return;
                const text = button.querySelector('span');
                const spinner = button.querySelector('.btn-spinner');
                button.disabled = isLoading;
                if (isLoading) {
                    if (text) text.style.display = 'none';
                    if (spinner) spinner.style.display = 'block';
                } else {
                    if (text) text.style.display = 'inline';
                    if (spinner) spinner.style.display = 'none';
                }
            }
            
            // Helper function to render nested objects/arrays as HTML lists
            function renderObjectAsList(obj, depth = 0) {
                if (typeof obj !== 'object' || obj === null) {
                    return `<span class="text-gray-300">${String(obj)}</span>`;
                }
                
                if (Array.isArray(obj)) {
                    let html = '<ul class="list-disc list-inside pl-6 space-y-2 mt-2">';
                    obj.forEach((item, index) => {
                        html += '<li class="text-gray-300">';
                        if (typeof item === 'object' && item !== null) {
                            html += renderObjectAsList(item, depth + 1);
                        } else {
                            html += `<span class="text-gray-300">${String(item)}</span>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                    return html;
                }
                
                let html = '<div class="space-y-3 mt-2">';
                for (const key in obj) {
                    const value = obj[key];
                    const title = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    html += '<div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">';
                    html += `<h4 class="text-amber-400 font-semibold mb-2 text-lg">${title}</h4>`;
                    
                    if (typeof value === 'object' && value !== null) {
                        html += renderObjectAsList(value, depth + 1);
                    } else {
                        html += `<p class="text-gray-300 leading-relaxed">${String(value)}</p>`;
                    }
                    html += '</div>';
                }
                html += '</div>';
                return html;
            }
            
            function formatNicheRecommendation(data) {
                if (typeof data === 'string') {
                    // Tentar parsear se for JSON string
                    try {
                        const parsed = JSON.parse(data);
                        return formatNicheRecommendation(parsed);
                    } catch (e) {
                        // Se n√£o for JSON, retornar como texto formatado
                        return `<div class="prose prose-invert max-w-none"><p class="text-gray-300 whitespace-pre-wrap">${data.replace(/\n/g, '<br>')}</p></div>`;
                    }
                }
                
                if (typeof data !== 'object' || data === null) {
                    return `<p class="text-gray-300">${String(data)}</p>`;
                }
                
                let html = '<div class="space-y-4">';
                
                // Subnicho Recomendado
                if (data.subnicho_recomendado) {
                    html += `
                        <div class="bg-gradient-to-r from-amber-900/30 to-amber-800/20 rounded-lg p-6 border border-amber-700/50">
                            <h3 class="text-2xl font-bold text-amber-400 mb-2">üéØ Subnicho Recomendado</h3>
                            <p class="text-xl text-white font-semibold">${data.subnicho_recomendado}</p>
                        </div>
                    `;
                }
                
                // An√°lise de Potencial
                if (data.analise_potencial) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">üí° An√°lise de Potencial</h3>
                            <p class="text-gray-300 leading-relaxed">${data.analise_potencial}</p>
                        </div>
                    `;
                }
                
                // An√°lise de Concorr√™ncia
                if (data.analise_concorrencia) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">üìä An√°lise de Concorr√™ncia</h3>
                            <p class="text-gray-300 leading-relaxed">${data.analise_concorrencia}</p>
                        </div>
                    `;
                }
                
                // Potencial de Viraliza√ß√£o
                if (data.potencial_viralizacao) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">üöÄ Potencial de Viraliza√ß√£o</h3>
                            <p class="text-gray-300 leading-relaxed">${data.potencial_viralizacao}</p>
                        </div>
                    `;
                }
                
                // Estrat√©gias de Conte√∫do
                if (data.estrategias_conteudo && Array.isArray(data.estrategias_conteudo)) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">üìù Estrat√©gias de Conte√∫do</h3>
                            <ul class="list-disc list-inside space-y-2 pl-4">
                                ${data.estrategias_conteudo.map(strategy => `<li class="text-gray-300">${strategy}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Sugest√µes de T√≠tulos e Thumbnails
                if (data.sugestoes_titulos_thumbnails) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-4">üé® Sugest√µes de T√≠tulos e Thumbnails</h3>
                            
                            ${data.sugestoes_titulos_thumbnails.titulos && Array.isArray(data.sugestoes_titulos_thumbnails.titulos) ? `
                                <div class="mb-4">
                                    <h4 class="text-lg font-semibold text-white mb-2">üìå T√≠tulos Virais</h4>
                                    <ul class="list-disc list-inside space-y-2 pl-4">
                                        ${data.sugestoes_titulos_thumbnails.titulos.map(title => `<li class="text-gray-300">${title}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${data.sugestoes_titulos_thumbnails.thumbnails && Array.isArray(data.sugestoes_titulos_thumbnails.thumbnails) ? `
                                <div>
                                    <h4 class="text-lg font-semibold text-white mb-2">üñºÔ∏è Thumbnails</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${data.sugestoes_titulos_thumbnails.thumbnails.map((thumb, idx) => `
                                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                                <h5 class="text-amber-400 font-semibold mb-2">Thumbnail ${idx + 1}</h5>
                                                <p class="text-gray-300 text-sm mb-1"><strong>Imagem:</strong> ${thumb.imagem || 'N/A'}</p>
                                                <p class="text-gray-300 text-sm mb-1"><strong>Texto:</strong> ${thumb.texto || 'N/A'}</p>
                                                <p class="text-gray-300 text-sm"><strong>Cores:</strong> ${thumb.cores || 'N/A'}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
            }

            function createWhatsAppLink(whatsapp) {
                if (!whatsapp) {
                    return 'N/A';
                }
                // Remove all non-digit characters
                const number = whatsapp.replace(/\D/g, '');
                if (!number) {
                    return whatsapp; // Return original if it's just weird characters
                }
                return `<a href="https://wa.me/${number}" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline">${whatsapp}</a>`;
            }

            // Fun√ß√µes auxiliares (definidas cedo para uso em todas as fun√ß√µes)
            function formatNumber(num) {
                const n = parseFloat(num) || 0;
                if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                return Math.floor(n).toString();
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }


            // --- L√ìGICA DE ADMIN ---
            const editUserModal = document.getElementById('edit-user-modal');
            const editUserModalCloseBtn = document.getElementById('edit-user-modal-close-btn');
            const editUserForm = document.getElementById('edit-user-form');
            const changePasswordModal = document.getElementById('change-password-modal');
            const changePasswordModalCloseBtn = document.getElementById('change-password-modal-close-btn');
            const changePasswordForm = document.getElementById('change-password-form');

            function showEditUserModal(user) {
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-whatsapp').value = user.whatsapp || '';
                document.getElementById('edit-user-role').value = user.isAdmin ? 'admin' : 'user';
                
                const statusSelect = document.getElementById('edit-user-status');
                if (user.isBlocked) {
                    statusSelect.value = 'blocked';
                } else if (!user.isApproved) {
                    statusSelect.value = 'pending';
                } else {
                    statusSelect.value = 'active';
                }

                editUserModal.style.display = 'flex';
            }

            function hideEditUserModal() {
                editUserModal.style.display = 'none';
            }

            function showChangePasswordModal(user) {
                document.getElementById('change-password-user-id').value = user.id;
                document.getElementById('change-password-user-email').innerText = user.email;
                document.getElementById('new-password').value = '';
                changePasswordModal.style.display = 'flex';
            }

            function hideChangePasswordModal() {
                changePasswordModal.style.display = 'none';
            }

            if (editUserModalCloseBtn) editUserModalCloseBtn.addEventListener('click', hideEditUserModal);
            if (changePasswordModalCloseBtn) changePasswordModalCloseBtn.addEventListener('click', hideChangePasswordModal);

            if (editUserModal) editUserModal.addEventListener('click', (e) => {
                if (e.target === editUserModal) hideEditUserModal();
            });
            if (changePasswordModal) changePasswordModal.addEventListener('click', (e) => {
                if (e.target === changePasswordModal) hideChangePasswordModal();
            });

            if (editUserForm) {
                editUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userId = document.getElementById('edit-user-id').value;
                    const name = document.getElementById('edit-user-name').value;
                    const whatsapp = document.getElementById('edit-user-whatsapp').value;
                    const isAdmin = document.getElementById('edit-user-role').value === 'admin';
                    const status = document.getElementById('edit-user-status').value;
                    
                    const isApproved = status !== 'pending';
                    const isBlocked = status === 'blocked';

                    const btn = document.getElementById('btn-save-user');
                    setButtonLoading(btn, true);

                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ name, whatsapp, isAdmin, isApproved, isBlocked })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro ao atualizar utilizador.');
                        showMessage('admin-success-message', data.msg);
                        hideEditUserModal();
                        loadAdminUsers();
                        loadAdminStats();
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });
            }

            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userId = document.getElementById('change-password-user-id').value;
                    const newPassword = document.getElementById('new-password').value;
                    const btn = document.getElementById('btn-save-password');
                    setButtonLoading(btn, true);

                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/${userId}/password`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ password: newPassword })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro ao trocar senha.');
                        showMessage('admin-success-message', data.msg);
                        hideChangePasswordModal();
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });
            }

            async function toggleUserBlockStatus(userId, isBlocked) {
                const confirmed = await showCustomConfirm(`Tem certeza que deseja ${isBlocked ? 'bloquear' : 'desbloquear'} este utilizador?`);
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users/${userId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isBlocked: isBlocked })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro ao alterar status.');
                    showMessage('admin-success-message', data.msg);
                    loadAdminUsers();
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }

            async function deleteUser(userId) {
                const confirmed = await showCustomConfirm('Tem certeza que deseja EXCLUIR este utilizador? Esta a√ß√£o √© irrevers√≠vel.');
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro ao excluir utilizador.');
                    showMessage('admin-success-message', data.msg);
                    loadAdminUsers();
                    loadAdminStats();
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }

            async function checkUserRoleAndLoadAdmin() {
                if (!userToken) return;
                try {
                    console.log('Verificando autentica√ß√£o do usu√°rio...', { API_BASE, hasToken: !!userToken });
                    const response = await fetch(`${API_BASE}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    console.log('Resposta de /api/auth/me:', { status: response.status, ok: response.ok });
                    
                    if (!response.ok) {
                        // S√≥ redireciona se for erro de autentica√ß√£o (401/403), n√£o erro de rede (404)
                        if (response.status === 401 || response.status === 403) {
                            console.warn('Erro de autentica√ß√£o. Redirecionando para login...');
                            localStorage.removeItem('core_token');
                            window.location.href = 'la-casa-dark-core-auth.html';
                            return;
                        } else if (response.status === 404) {
                            console.error('Endpoint n√£o encontrado. Verifique se o servidor est√° rodando e se a URL da API est√° correta.');
                            console.error('API_BASE:', API_BASE, 'URL completa:', `${API_BASE}/api/auth/me`);
                            // N√£o redireciona em caso de 404, apenas mostra erro no console
                            return;
                        } else {
                            console.error('Erro ao verificar autentica√ß√£o:', response.status, response.statusText);
                            return;
                        }
                    }
                    const userData = await response.json();
                    console.log('Dados do usu√°rio carregados:', { name: userData.name, isAdmin: userData.isAdmin });
                    
                    // Atualiza a mensagem de boas-vindas
                    const welcomeHeading = document.getElementById('welcome-heading');
                    if (welcomeHeading && userData.name) {
                        const firstName = userData.name.split(' ')[0]; // Pega s√≥ o primeiro nome
                        welcomeHeading.innerText = `Bem-vindo, ${firstName}!`;
                    }

                    // Mostra o link do painel admin se o utilizador for admin
                    if (userData.isAdmin) {
                        document.getElementById('admin-nav-link').style.display = 'flex';
                    }
                } catch (err) { console.error('Erro ao verificar status do utilizador:', err); }
            }

            async function loadAdminStats() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/stats`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao buscar estat√≠sticas.');
                    const stats = await response.json();
                    document.getElementById('stats-total-users').innerText = stats.totalUsers;
                    document.getElementById('stats-pending-users').innerText = stats.pendingUsers;
                    document.getElementById('stats-online-users').innerText = stats.onlineUsers;
                    document.getElementById('stats-logins-24h').innerText = stats.logins24h;
                } catch (err) {
                    console.error('Erro ao carregar estat√≠sticas do admin:', err);
                }
            }

            async function loadAdminUsers() {
                const search = document.getElementById('admin-search-input').value;
                const status = document.getElementById('admin-status-filter').value;
                let url = `${API_BASE}/api/admin/users?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (status) url += `status=${status}&`;

                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao buscar utilizadores.');
                    const users = await response.json();
                    const tableBody = document.getElementById('admin-user-table-body');
                    if (!tableBody) return;
                    
                    tableBody.innerHTML = ''; 
                    users.forEach((user) => {
                        let statusText, statusClass;
                        if (user.isBlocked) {
                            statusText = 'Bloqueado';
                            statusClass = 'bg-red-500/20 text-red-400';
                        } else if (!user.isApproved) {
                            statusText = 'Pendente';
                            statusClass = 'bg-yellow-500/20 text-yellow-400';
                        } else {
                            statusText = 'Ativo';
                            statusClass = 'bg-green-500/20 text-green-400';
                        }

                        const roleText = user.isAdmin ? 'Admin' : 'Utilizador';
                        const tags = 'N/A'; // Placeholder for tags
                        const whatsappLink = createWhatsAppLink(user.whatsapp);
                        
                        // Formatar plano
                        const planName = user.subscription_plan || user.plan || 'plan-free';
                        const planLabels = {
                            'plan-free': 'FREE',
                            'plan-start': 'START',
                            'plan-turbo': 'TURBO',
                            'plan-master': 'MASTER',
                            'plan-start-annual': 'START ANUAL',
                            'plan-turbo-annual': 'TURBO ANUAL',
                            'plan-master-annual': 'MASTER ANUAL'
                        };
                        const planLabel = planLabels[planName] || planName;
                        const planColors = {
                            'plan-free': 'bg-gray-600/50 text-gray-300',
                            'plan-start': 'bg-blue-600/50 text-blue-300',
                            'plan-turbo': 'bg-yellow-600/50 text-yellow-300',
                            'plan-master': 'bg-purple-600/50 text-purple-300',
                            'plan-start-annual': 'bg-blue-700/50 text-blue-200',
                            'plan-turbo-annual': 'bg-yellow-700/50 text-yellow-200',
                            'plan-master-annual': 'bg-purple-700/50 text-purple-200'
                        };
                        const planColor = planColors[planName] || 'bg-gray-600/50 text-gray-300';

                        tableBody.innerHTML += `
                            <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                <td class="p-3"><input type="checkbox" class="bg-gray-700 border-gray-600 rounded"></td>
                                <td class="p-3 text-sm text-gray-200">${user.email}</td>
                                <td class="p-3 text-sm">${whatsappLink}</td>
                                <td class="p-3 text-sm text-gray-400">${roleText}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${planColor}">
                                        ${planLabel}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                        ${statusText}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-600/50 text-gray-300">
                                        ${tags}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <div class="flex space-x-2">
                                        <button title="Editar" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-blue-500 btn-admin-action" data-action="edit" data-user='${JSON.stringify(user)}'>
                                            <i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="Trocar Senha" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-amber-500 btn-admin-action" data-action="change-password" data-user='${JSON.stringify(user)}'>
                                            <i data-lucide="key" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="${user.isBlocked ? 'Desbloquear' : 'Bloquear'}" class="p-2 rounded-md hover:bg-gray-700 transition-colors ${user.isBlocked ? 'text-green-500' : 'text-red-500'} btn-admin-action" data-action="toggle-block" data-id="${user.id}" data-is-blocked="${user.isBlocked}">
                                            <i data-lucide="${user.isBlocked ? 'unlock' : 'lock'}" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="Alterar Plano" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-purple-500 btn-admin-action" data-action="change-plan" data-id="${user.id}" data-user='${JSON.stringify(user)}'>
                                            <i data-lucide="credit-card" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="Excluir" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-red-600 btn-admin-action" data-action="delete" data-id="${user.id}">
                                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) { console.error('Erro ao carregar utilizadores admin:', err); }
            }
            
            // Sistema de Abas do Admin
            function initAdminTabs() {
                const tabButtons = document.querySelectorAll('.admin-tab-btn');
                const tabContents = document.querySelectorAll('.admin-tab-content');
                
                tabButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetTab = btn.dataset.tab;
                        
                        // Remove active de todos os bot√µes
                        tabButtons.forEach(b => {
                            b.classList.remove('active', 'border-amber-500', 'text-white');
                            b.classList.add('text-gray-400');
                        });
                        
                        // Adiciona active ao bot√£o clicado
                        btn.classList.add('active', 'border-amber-500', 'text-white');
                        btn.classList.remove('text-gray-400');
                        
                        // Esconde todos os conte√∫dos
                        tabContents.forEach(content => {
                            content.style.display = 'none';
                        });
                        
                        // Mostra o conte√∫do da aba selecionada
                        const targetContent = document.getElementById(`admin-tab-${targetTab}`);
                        if (targetContent) {
                            targetContent.style.display = 'block';
                            
                            // Carrega dados espec√≠ficos da aba
                            if (targetTab === 'credits') {
                                loadAdminCredits();
                            } else if (targetTab === 'apis') {
                                loadAdminApis();
                            } else if (targetTab === 'pixel') {
                                loadAdminPixel();
                            } else if (targetTab === 'payments') {
                                loadAdminPayments();
                            } else if (targetTab === 'subscriptions') {
                                attachSubscriptionsListeners();
                                loadAdminSubscriptions();
                            } else if (targetTab === 'storage') {
                                loadAdminStorage();
                            } else if (targetTab === 'notifications') {
                                loadAdminNotifications();
                            } else if (targetTab === 'plan-permissions') {
                                loadAdminPlanPermissions();
                            } else if (targetTab === 'config') {
                                // Carregar configura√ß√µes SMTP quando a aba de configura√ß√µes for aberta
                                if (typeof loadSMTPConfig === 'function') {
                                    loadSMTPConfig();
                                }
                            }
                        }
                    });
                });
                
                // Ativa a primeira aba por padr√£o
                if (tabButtons.length > 0) {
                    tabButtons[0].click();
                }
            }
            
            // Fun√ß√£o para carregar e gerenciar notifica√ß√µes
            let purchaseLoopInterval = null;
            let userLoopInterval = null;
            
            async function loadAdminNotifications() {
                try {
                    // Carregar status dos loops
                    const statusResponse = await fetch(`${API_BASE}/api/admin/notifications/loop/status`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (statusResponse.ok) {
                        const status = await statusResponse.json();
                        // Restaurar estado dos loops se estiverem ativos
                        if (status.purchase && status.purchase.is_active) {
                            document.getElementById('purchase-loop-status').textContent = 'Em execu√ß√£o';
                            document.getElementById('start-purchase-loop').disabled = true;
                            document.getElementById('stop-purchase-loop').disabled = false;
                        }
                        if (status.user && status.user.is_active) {
                            document.getElementById('user-loop-status').textContent = 'Em execu√ß√£o';
                            document.getElementById('start-user-loop').disabled = true;
                            document.getElementById('stop-user-loop').disabled = false;
                        }
                    }
                    
                    // Carregar configura√ß√µes
                    const configResponse = await fetch(`${API_BASE}/api/admin/notifications/config`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (configResponse.ok) {
                        const config = await configResponse.json();
                        document.getElementById('notif-purchase-enabled').checked = config.purchase_enabled;
                        document.getElementById('notif-purchase-interval').value = config.purchase_interval;
                        document.getElementById('notif-purchase-message').value = config.purchase_message;
                        document.getElementById('notif-user-enabled').checked = config.user_enabled;
                        document.getElementById('notif-user-interval').value = config.user_interval;
                        document.getElementById('notif-user-message').value = config.user_message;
                    }
                    
                    // Carregar usu√°rios fict√≠cios
                    await loadFakeUsers();
                    
                    // Bot√£o para criar usu√°rios em massa
                    const createBulkUsersBtn = document.getElementById('create-bulk-users-btn');
                    if (createBulkUsersBtn) {
                        // Remover listener antigo se existir
                        const newBtn = createBulkUsersBtn.cloneNode(true);
                        createBulkUsersBtn.parentNode.replaceChild(newBtn, createBulkUsersBtn);
                        newBtn.addEventListener('click', createBulkUsers);
                    }
                    
                    // Remover event listeners antigos para evitar duplica√ß√£o
                    const oldSaveBtn = document.getElementById('save-notifications-config');
                    const oldAddBtn = document.getElementById('add-fake-user-btn');
                    const oldStartPurchase = document.getElementById('start-purchase-loop');
                    const oldStopPurchase = document.getElementById('stop-purchase-loop');
                    const oldStartUser = document.getElementById('start-user-loop');
                    const oldStopUser = document.getElementById('stop-user-loop');
                    
                    // Clonar e substituir para remover listeners antigos
                    if (oldSaveBtn) {
                        const newSaveBtn = oldSaveBtn.cloneNode(true);
                        oldSaveBtn.parentNode.replaceChild(newSaveBtn, oldSaveBtn);
                    }
                    if (oldAddBtn) {
                        const newAddBtn = oldAddBtn.cloneNode(true);
                        oldAddBtn.parentNode.replaceChild(newAddBtn, oldAddBtn);
                    }
                    if (oldStartPurchase) {
                        const newStartPurchase = oldStartPurchase.cloneNode(true);
                        oldStartPurchase.parentNode.replaceChild(newStartPurchase, oldStartPurchase);
                    }
                    if (oldStopPurchase) {
                        const newStopPurchase = oldStopPurchase.cloneNode(true);
                        oldStopPurchase.parentNode.replaceChild(newStopPurchase, oldStopPurchase);
                    }
                    if (oldStartUser) {
                        const newStartUser = oldStartUser.cloneNode(true);
                        oldStartUser.parentNode.replaceChild(newStartUser, oldStartUser);
                    }
                    if (oldStopUser) {
                        const newStopUser = oldStopUser.cloneNode(true);
                        oldStopUser.parentNode.replaceChild(newStopUser, oldStopUser);
                    }
                    
                    // Adicionar event listeners
                    document.getElementById('save-notifications-config')?.addEventListener('click', saveNotificationsConfig);
                    document.getElementById('test-notification-btn')?.addEventListener('click', testNotification);
                    document.getElementById('add-fake-user-btn')?.addEventListener('click', showAddFakeUserModal);
                    document.getElementById('start-purchase-loop')?.addEventListener('click', startPurchaseLoop);
                    document.getElementById('stop-purchase-loop')?.addEventListener('click', stopPurchaseLoop);
                    document.getElementById('start-user-loop')?.addEventListener('click', startUserLoop);
                    document.getElementById('stop-user-loop')?.addEventListener('click', stopUserLoop);
                } catch (err) {
                    console.error('Erro ao carregar notifica√ß√µes:', err);
                    showMessage('admin-error-message', 'Erro ao carregar configura√ß√µes de notifica√ß√µes', true);
                }
            }
            
            // Fun√ß√£o para testar notifica√ß√£o
            async function testNotification() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/notifications/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            title: 'Teste de Notifica√ß√£o',
                            message: 'Esta √© uma notifica√ß√£o de teste! üéâ',
                            type: 'info',
                            user_id: null
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Notifica√ß√£o de teste criada! Ela aparecer√° em alguns segundos.');
                        // For√ßar busca imediata de notifica√ß√µes
                        setTimeout(async () => {
                            try {
                                const notifResponse = await fetch(`${API_BASE}/api/notifications/pending`, {
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                if (notifResponse.ok) {
                                    const notifications = await notifResponse.json();
                                    if (notifications && notifications.length > 0) {
                                        notifications.forEach(notif => {
                                            showNotification(notif.title, notif.message, notif.type, 5000);
                                            fetch(`${API_BASE}/api/notifications/${notif.id}/read`, {
                                                method: 'POST',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            }).catch(() => {});
                                        });
                                    }
                                }
                            } catch (err) {
                                console.error('Erro ao buscar notifica√ß√£o de teste:', err);
                            }
                        }, 1000);
                    } else {
                        throw new Error('Erro ao criar notifica√ß√£o de teste');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }
            
            async function saveNotificationsConfig() {
                try {
                    const config = {
                        purchase_enabled: document.getElementById('notif-purchase-enabled').checked,
                        purchase_interval: parseInt(document.getElementById('notif-purchase-interval').value),
                        purchase_message: document.getElementById('notif-purchase-message').value,
                        user_enabled: document.getElementById('notif-user-enabled').checked,
                        user_interval: parseInt(document.getElementById('notif-user-interval').value),
                        user_message: document.getElementById('notif-user-message').value
                    };
                    
                    const response = await fetch(`${API_BASE}/api/admin/notifications/config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify(config)
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Configura√ß√µes salvas com sucesso!');
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar configura√ß√µes');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }
            
            async function loadFakeUsers() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        const tbody = document.getElementById('fake-users-table-body');
                        if (!tbody) return;
                        
                        tbody.innerHTML = '';
                        
                        if (users.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhum usu√°rio fict√≠cio cadastrado</td></tr>';
                        } else {
                            users.forEach(user => {
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-3 text-sm text-white">${user.name}</td>
                                        <td class="p-3 text-sm text-gray-300">${user.email}</td>
                                        <td class="p-3">
                                            <div class="flex flex-col gap-1">
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.type === 'purchase' ? 'bg-green-700 text-white' : 'bg-blue-700 text-white'}">
                                                    ${user.type === 'purchase' ? 'Compra' : 'Usu√°rio'}
                                                </span>
                                                ${user.plan_name ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-700 text-white">${user.plan_name}</span>` : ''}
                                            </div>
                                        </td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.is_active ? 'bg-green-700 text-white' : 'bg-gray-700 text-gray-300'}">
                                                ${user.is_active ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </td>
                                        <td class="p-3">
                                            <button class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded btn-delete-fake-user" data-id="${user.id}">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Event listeners para deletar
                            document.querySelectorAll('.btn-delete-fake-user').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const id = btn.dataset.id;
                                    const confirmed = await showCustomConfirm('Tem certeza que deseja deletar este usu√°rio fict√≠cio?');
                                    if (!confirmed) return;
                                    
                                    try {
                                        const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users/${id}`, {
                                            method: 'DELETE',
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        });
                                        
                                        if (response.ok) {
                                            showMessage('admin-success-message', 'Usu√°rio fict√≠cio deletado com sucesso!');
                                            loadFakeUsers();
                                        } else {
                                            throw new Error('Erro ao deletar usu√°rio fict√≠cio');
                                        }
                                    } catch (err) {
                                        showMessage('admin-error-message', err.message, true);
                                    }
                                });
                            });
                        }
                        
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                } catch (err) {
                    console.error('Erro ao carregar usu√°rios fict√≠cios:', err);
                }
            }
            
            // Fun√ß√£o para criar usu√°rios em massa
            async function createBulkUsers() {
                const confirmed = await showCustomConfirm(
                    'Isso criar√° 100 usu√°rios fict√≠cios (50 para compras e 50 para novos usu√°rios). Deseja continuar?',
                    'Criar Usu√°rios em Massa'
                );
                if (!confirmed) return;
                
                const emails = [
                    'carlos.ventura@gmail.com', 'ana.clarice@gmail.com', 'lucas.araujo@gmail.com', 'mariana.teixeira@gmail.com', 'pedro.mendes@gmail.com',
                    'julia.freitas@gmail.com', 'victor.cardoso@gmail.com', 'renata.costa@gmail.com', 'felipe.andrade@gmail.com', 'larissa.dias@gmail.com',
                    'rodrigo.silveira@hotmail.com', 'tamara.ramos@hotmail.com', 'eduardo.santos@hotmail.com', 'bianca.motta@hotmail.com', 'igor.felix@hotmail.com',
                    'aline.martins@hotmail.com', 'caio.monteiro@hotmail.com', 'priscila.souza@hotmail.com', 'daniel.bernardo@hotmail.com', 'gabriela.torres@hotmail.com',
                    'joao.castro@uol.com.br', 'rafaela.lima@uol.com.br', 'diego.siqueira@uol.com.br', 'carolina.amaral@uol.com.br', 'ricardo.prado@uol.com.br',
                    'elisa.nogueira@uol.com.br', 'tiago.rodrigues@uol.com.br', 'beatriz.vasconcelos@uol.com.br', 'henrique.moraes@uol.com.br', 'fabiana.dias@uol.com.br',
                    'sofia.santana@gmail.com', 'bruno.pereira@gmail.com', 'luciana.castro@gmail.com', 'marcelo.correia@gmail.com', 'patricia.monteiro@gmail.com',
                    'leonardo.silva@hotmail.com', 'isabela.nunes@hotmail.com', 'adriano.almeida@hotmail.com', 'cristina.mello@hotmail.com', 'vitor.macedo@hotmail.com',
                    'micaela.luz@uol.com.br', 'rogerio.martins@uol.com.br', 'eduarda.pinho@uol.com.br', 'fernando.reis@uol.com.br', 'jessica.moraes@uol.com.br',
                    'alexandre.campos@gmail.com', 'natasha.coelho@hotmail.com', 'brenda.macedo@uol.com.br', 'enzo.guimaraes@gmail.com', 'helena.souza@hotmail.com'
                ];
                
                // Fun√ß√£o para extrair primeiro nome do email
                const getFirstName = (email) => {
                    if (!email || typeof email !== 'string') {
                        return 'Usu√°rio';
                    }
                    try {
                        const namePart = email.split('@')[0];
                        if (!namePart) return 'Usu√°rio';
                        const parts = namePart.split('.');
                        const firstName = parts[0] || namePart;
                        return firstName.charAt(0).toUpperCase() + firstName.slice(1);
                    } catch (err) {
                        console.error('Erro ao extrair nome do email:', email, err);
                        return 'Usu√°rio';
                    }
                };
                
                // Criar lista de usu√°rios
                const users = [];
                
                // Primeiros 50 para compras (com planos aleat√≥rios)
                for (let i = 0; i < 50 && i < emails.length; i++) {
                    const email = emails[i];
                    if (email && typeof email === 'string') {
                        users.push({
                            name: getFirstName(email),
                            email: email,
                            type: 'purchase',
                            plan_name: null // Aleat√≥rio
                        });
                    }
                }
                
                // √öltimos 50 para novos usu√°rios
                for (let i = 50; i < emails.length; i++) {
                    const email = emails[i];
                    if (email && typeof email === 'string') {
                        users.push({
                            name: getFirstName(email),
                            email: email,
                            type: 'user',
                            plan_name: null
                        });
                    }
                }
                
                if (users.length === 0) {
                    showMessage('admin-error-message', 'Nenhum email v√°lido encontrado!', true);
                    return;
                }
                
                try {
                    showMessage('admin-success-message', `Criando ${users.length} usu√°rios... Aguarde.`);
                    
                    console.log('[BULK USERS] Total de usu√°rios a criar:', users.length);
                    console.log('[BULK USERS] Primeiros 3:', users.slice(0, 3));
                    
                    const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ bulk: true, users })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showMessage('admin-success-message', `${result.created || users.length} usu√°rios fict√≠cios criados com sucesso!`);
                        loadFakeUsers();
                    } else {
                        throw new Error(result.message || 'Erro ao criar usu√°rios');
                    }
                } catch (err) {
                    console.error('[BULK USERS] Erro completo:', err);
                    showMessage('admin-error-message', err.message || 'Erro ao criar usu√°rios', true);
                }
            }
            
            async function showAddFakeUserModal() {
                const name = await showCustomPrompt('Nome do usu√°rio fict√≠cio:', '', 'Adicionar Usu√°rio Fict√≠cio');
                if (!name) return;
                
                const email = await showCustomPrompt('Email do usu√°rio fict√≠cio:', `fake${Date.now()}@example.com`, 'Adicionar Usu√°rio Fict√≠cio');
                if (!email) return;
                
                // Criar modal para selecionar tipo e plano
                const modal = document.getElementById('custom-modal-overlay');
                const messageEl = document.getElementById('custom-modal-message');
                const inputEl = document.getElementById('custom-modal-input');
                const titleEl = document.getElementById('custom-modal-title-text');
                
                titleEl.textContent = 'Adicionar Usu√°rio Fict√≠cio';
                messageEl.innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Tipo de notifica√ß√£o:</label>
                            <select id="temp-type-select" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                <option value="purchase">Compra</option>
                                <option value="user">Usu√°rio Novo</option>
                            </select>
                        </div>
                        <div id="plan-select-container" style="display: none;">
                            <label class="block text-sm text-gray-400 mb-2">Plano (para notifica√ß√µes de compra):</label>
                            <select id="temp-plan-select" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                <option value="">Aleat√≥rio</option>
                                <option value="START CREATOR">START CREATOR</option>
                                <option value="TURBO MAKER">TURBO MAKER</option>
                                <option value="MASTER PRO">MASTER PRO</option>
                            </select>
                        </div>
                    </div>
                `;
                inputEl.style.display = 'none';
                
                modal.style.display = 'flex';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                const typeSelect = document.getElementById('temp-type-select');
                const planSelect = document.getElementById('temp-plan-select');
                const planContainer = document.getElementById('plan-select-container');
                
                // Mostrar/ocultar sele√ß√£o de plano baseado no tipo
                typeSelect.addEventListener('change', () => {
                    planContainer.style.display = typeSelect.value === 'purchase' ? 'block' : 'none';
                });
                
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
                const closeBtn = document.getElementById('custom-modal-close');
                
                const cleanup = () => {
                    modal.style.display = 'none';
                    messageEl.innerHTML = '';
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    closeBtn.onclick = null;
                    typeSelect.onchange = null;
                };
                
                confirmBtn.onclick = async () => {
                    const type = typeSelect.value;
                    const planName = type === 'purchase' ? planSelect.value : null;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ name, email, type, plan_name: planName || null })
                        });
                        
                        if (response.ok) {
                            showMessage('admin-success-message', 'Usu√°rio fict√≠cio criado com sucesso!');
                            loadFakeUsers();
                        } else {
                            const error = await response.json();
                            throw new Error(error.message || 'Erro ao criar usu√°rio fict√≠cio');
                        }
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    }
                    cleanup();
                };
                
                cancelBtn.onclick = cleanup;
                closeBtn.onclick = cleanup;
            }
            
            async function startPurchaseLoop() {
                if (purchaseLoopInterval) return;
                
                const enabled = document.getElementById('notif-purchase-enabled').checked;
                if (!enabled) {
                    showMessage('admin-error-message', 'Ative as notifica√ß√µes de compra primeiro!', true);
                    return;
                }
                
                const interval = parseInt(document.getElementById('notif-purchase-interval').value) * 1000;
                const message = document.getElementById('notif-purchase-message').value;
                
                // Buscar usu√°rios fict√≠cios de compra
                const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: 'Erro ao buscar usu√°rios fict√≠cios' }));
                    throw new Error(error.message || 'Erro ao buscar usu√°rios fict√≠cios');
                }
                
                const users = await response.json();
                const purchaseUsers = users.filter(u => u.type === 'purchase' && u.is_active);
                
                if (purchaseUsers.length === 0) {
                    showMessage('admin-error-message', 'Nenhum usu√°rio fict√≠cio de compra cadastrado!', true);
                    return;
                }
                
                // Fun√ß√£o para criar notifica√ß√£o de compra
                const createPurchaseNotification = async () => {
                    // Selecionar usu√°rio aleat√≥rio
                    const randomUserIndex = Math.floor(Math.random() * purchaseUsers.length);
                    const user = purchaseUsers[randomUserIndex];
                    
                    // Usar plano do usu√°rio fict√≠cio ou plano aleat√≥rio
                    const planNames = ['START CREATOR', 'TURBO MAKER', 'MASTER PRO'];
                    const plan = user.plan_name || planNames[Math.floor(Math.random() * planNames.length)];
                    
                    const notificationMessage = message
                        .replace('{name}', user.name)
                        .replace('{plan}', plan);
                    
                    // Criar notifica√ß√£o global (user_id = null)
                    await fetch(`${API_BASE}/api/admin/notifications/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            title: 'Nova Compra!',
                            message: notificationMessage,
                            type: 'purchase',
                            user_id: null
                        })
                    });
                };
                
                // Criar primeira notifica√ß√£o imediatamente
                createPurchaseNotification();
                
                // Agendar pr√≥xima notifica√ß√£o com intervalo aleat√≥rio
                const scheduleNext = () => {
                    // Intervalo aleat√≥rio entre 50% e 150% do intervalo configurado
                    const minInterval = interval * 0.5;
                    const maxInterval = interval * 1.5;
                    const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval) + minInterval);
                    
                    purchaseLoopInterval = setTimeout(async () => {
                        await createPurchaseNotification();
                        scheduleNext();
                    }, randomInterval);
                };
                
                scheduleNext();
                
                document.getElementById('start-purchase-loop').disabled = true;
                document.getElementById('stop-purchase-loop').disabled = false;
                document.getElementById('purchase-loop-status').textContent = 'Em execu√ß√£o';
            }
            
            function stopPurchaseLoop() {
                if (purchaseLoopInterval) {
                    clearTimeout(purchaseLoopInterval);
                    purchaseLoopInterval = null;
                }
                document.getElementById('start-purchase-loop').disabled = false;
                document.getElementById('stop-purchase-loop').disabled = true;
                document.getElementById('purchase-loop-status').textContent = 'Parado';
            }
            
            async function startUserLoop() {
                if (userLoopInterval) return;
                
                const enabled = document.getElementById('notif-user-enabled').checked;
                if (!enabled) {
                    showMessage('admin-error-message', 'Ative as notifica√ß√µes de novos usu√°rios primeiro!', true);
                    return;
                }
                
                const interval = parseInt(document.getElementById('notif-user-interval').value);
                const message = document.getElementById('notif-user-message').value;
                
                // Salvar estado no banco de dados
                try {
                    await fetch(`${API_BASE}/api/admin/notifications/loop/start`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            loop_type: 'user',
                            interval_seconds: interval
                        })
                    });
                } catch (err) {
                    console.error('Erro ao salvar estado do loop:', err);
                }
                
                // Buscar usu√°rios fict√≠cios de usu√°rio
                const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: 'Erro ao buscar usu√°rios fict√≠cios' }));
                    throw new Error(error.message || 'Erro ao buscar usu√°rios fict√≠cios');
                }
                
                const users = await response.json();
                const userUsers = users.filter(u => u.type === 'user' && u.is_active);
                
                if (userUsers.length === 0) {
                    showMessage('admin-error-message', 'Nenhum usu√°rio fict√≠cio de novo usu√°rio cadastrado!', true);
                    return;
                }
                
                // Fun√ß√£o para criar notifica√ß√£o de novo usu√°rio
                const createUserNotification = async () => {
                    // Selecionar usu√°rio aleat√≥rio
                    const randomUserIndex = Math.floor(Math.random() * userUsers.length);
                    const user = userUsers[randomUserIndex];
                    
                    const notificationMessage = message.replace('{name}', user.name);
                    
                    // Criar notifica√ß√£o global (user_id = null)
                    await fetch(`${API_BASE}/api/admin/notifications/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            title: 'Novo Usu√°rio!',
                            message: notificationMessage,
                            type: 'user',
                            user_id: null
                        })
                    });
                };
                
                // Criar primeira notifica√ß√£o imediatamente
                createUserNotification();
                
                // Agendar pr√≥xima notifica√ß√£o com intervalo aleat√≥rio
                const scheduleNext = () => {
                    // Intervalo aleat√≥rio entre 50% e 150% do intervalo configurado
                    const intervalMs = interval * 1000;
                    const minInterval = intervalMs * 0.5;
                    const maxInterval = intervalMs * 1.5;
                    const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval) + minInterval);
                    
                    userLoopInterval = setTimeout(async () => {
                        await createUserNotification();
                        scheduleNext();
                    }, randomInterval);
                };
                
                scheduleNext();
                
                document.getElementById('start-user-loop').disabled = true;
                document.getElementById('stop-user-loop').disabled = false;
                document.getElementById('user-loop-status').textContent = 'Em execu√ß√£o';
            }
            
            async function stopUserLoop() {
                if (userLoopInterval) {
                    clearTimeout(userLoopInterval);
                    userLoopInterval = null;
                }
                
                // Salvar estado no banco de dados
                try {
                    await fetch(`${API_BASE}/api/admin/notifications/loop/stop`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            loop_type: 'user'
                        })
                    });
                } catch (err) {
                    console.error('Erro ao salvar estado do loop:', err);
                }
                
                document.getElementById('start-user-loop').disabled = false;
                document.getElementById('stop-user-loop').disabled = true;
                document.getElementById('user-loop-status').textContent = 'Parado';
            }

            // Fun√ß√£o para carregar permiss√µes de planos
            async function loadAdminPlanPermissions() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/plan-permissions`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) throw new Error('Erro ao carregar permiss√µes');
                    
                    const permissions = await response.json();
                    
                    // Carregar cr√©ditos
                    const planNames = ['plan-free', 'plan-start', 'plan-turbo', 'plan-master', 
                                     'plan-start-annual', 'plan-turbo-annual', 'plan-master-annual'];
                    const planLabels = {
                        'plan-free': 'FREE',
                        'plan-start': 'START CREATOR',
                        'plan-turbo': 'TURBO MAKER',
                        'plan-master': 'MASTER PRO',
                        'plan-start-annual': 'START ANUAL',
                        'plan-turbo-annual': 'TURBO ANUAL',
                        'plan-master-annual': 'MASTER ANUAL'
                    };
                    
                    // Renderizar cr√©ditos
                    const creditsList = document.getElementById('plan-credits-list');
                    if (creditsList) {
                        creditsList.innerHTML = '';
                        planNames.forEach(planName => {
                            const planData = permissions[planName] || { monthly_credits: 0 };
                            creditsList.innerHTML += `
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <h3 class="text-lg font-semibold text-white mb-2">${planLabels[planName] || planName}</h3>
                                    <input type="number" id="credits-${planName}" value="${planData.monthly_credits || 0}" 
                                           class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white mb-2">
                                    <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg btn-save-credits" 
                                            data-plan="${planName}">
                                        Salvar Cr√©ditos
                                    </button>
                                </div>
                            `;
                        });
                        
                        // Event listeners para salvar cr√©ditos
                        document.querySelectorAll('.btn-save-credits').forEach(btn => {
                            btn.addEventListener('click', async () => {
                                const planName = btn.dataset.plan;
                                const credits = parseInt(document.getElementById(`credits-${planName}`).value);
                                
                                try {
                                    const response = await fetch(`${API_BASE}/api/admin/plan-credits/${planName}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${userToken}`
                                        },
                                        body: JSON.stringify({ monthly_credits: credits })
                                    });
                                    
                                    if (response.ok) {
                                        showMessage('admin-success-message', `Cr√©ditos do plano ${planLabels[planName]} atualizados!`);
                                    } else {
                                        throw new Error('Erro ao salvar cr√©ditos');
                                    }
                                } catch (err) {
                                    showMessage('admin-error-message', err.message, true);
                                }
                            });
                        });
                    }
                    
                    // Renderizar permiss√µes
                    const features = [
                        { name: 'video_analyzer', label: 'Analisador de V√≠deos' },
                        { name: 'niche_explorer', label: 'Explorar Nicho' },
                        { name: 'script_generator', label: 'Gerador de Roteiro' },
                        { name: 'voice_generator', label: 'Gerador de Voz' },
                        { name: 'image_generator', label: 'Gerador de Imagens' },
                        { name: 'video_generator', label: 'Gerador de V√≠deo' },
                        { name: 'youtube_integration', label: 'Integra√ß√£o YouTube' },
                        { name: 'api_propria', label: 'API Pr√≥pria' },
                        { name: 'batch_images', label: 'Imagens em Lote' },
                        { name: 'analytics', label: 'Analytics' },
                        { name: 'viral_library', label: 'Biblioteca Virais' }
                    ];
                    
                    const permissionsList = document.getElementById('plan-permissions-list');
                    if (permissionsList) {
                        permissionsList.innerHTML = '';
                        
                        planNames.forEach(planName => {
                            const planData = permissions[planName] || { features: {} };
                            permissionsList.innerHTML += `
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-xl font-semibold text-white mb-4">${planLabels[planName] || planName}</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        ${features.map(feature => {
                                            const isAllowed = planData.features && planData.features[feature.name] === true;
                                            return `
                                                <label class="flex items-center p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-750 transition">
                                                    <input type="checkbox" 
                                                           class="mr-3 w-4 h-4 text-amber-500 rounded focus:ring-amber-500" 
                                                           ${isAllowed ? 'checked' : ''}
                                                           data-plan="${planName}" 
                                                           data-feature="${feature.name}">
                                                    <span class="text-gray-300">${feature.label}</span>
                                                </label>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        });
                        
                        // Event listeners para checkboxes
                        document.querySelectorAll('input[type="checkbox"][data-plan]').forEach(checkbox => {
                            checkbox.addEventListener('change', async () => {
                                const planName = checkbox.dataset.plan;
                                const featureName = checkbox.dataset.feature;
                                const isAllowed = checkbox.checked;
                                
                                try {
                                    const response = await fetch(`${API_BASE}/api/admin/plan-permissions/${planName}/${featureName}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${userToken}`
                                        },
                                        body: JSON.stringify({ is_allowed: isAllowed })
                                    });
                                    
                                    if (response.ok) {
                                        showMessage('admin-success-message', 'Permiss√£o atualizada com sucesso!');
                                    } else {
                                        checkbox.checked = !isAllowed; // Reverter
                                        throw new Error('Erro ao atualizar permiss√£o');
                                    }
                                } catch (err) {
                                    showMessage('admin-error-message', err.message, true);
                                }
                            });
                        });
                    }
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar permiss√µes:', err);
                    showMessage('admin-error-message', 'Erro ao carregar permiss√µes de planos', true);
                }
            }

            // Vari√°veis para pagina√ß√£o de cr√©ditos
            let currentCreditsPage = 1;
            const creditsPerPage = 20;
            
            // Carregar configura√ß√µes globais
            async function loadGlobalSettings() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        document.getElementById('initial-bonus-credits').value = settings.initial_bonus_credits || 0;
                        document.getElementById('tts-credits-multiplier').value = settings.tts_credits_multiplier || 1.0;
                    }
                } catch (err) {
                    console.error('Erro ao carregar configura√ß√µes:', err);
                }
            }
            
            // Salvar configura√ß√µes globais
            document.getElementById('save-global-settings')?.addEventListener('click', async () => {
                try {
                    const initialBonus = parseFloat(document.getElementById('initial-bonus-credits').value) || 0;
                    const ttsMultiplier = parseFloat(document.getElementById('tts-credits-multiplier').value) || 1.0;
                    
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                initial_bonus_credits: initialBonus,
                                tts_credits_multiplier: ttsMultiplier
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Configura√ß√µes salvas com sucesso');
                    } else {
                        throw new Error('Erro ao salvar configura√ß√µes');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Consultar saldo
            document.getElementById('consult-balance-btn')?.addEventListener('click', async () => {
                const identifier = document.getElementById('consult-balance-search').value.trim();
                if (!identifier) {
                    showMessage('admin-error-message', 'Digite um email, nome ou WhatsApp', true);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/credits/balance`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ identifier })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('consult-balance-user-info').textContent = `${data.user.email} (${data.user.name || 'N/A'})`;
                        document.getElementById('consult-balance-amount').textContent = `${parseFloat(data.balance || 0).toFixed(2)} cr√©ditos`;
                        document.getElementById('consult-balance-result').classList.remove('hidden');
                    } else {
                        const error = await response.json();
                        showMessage('admin-error-message', error.message || 'Usu√°rio n√£o encontrado', true);
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Buscar usu√°rios
            document.getElementById('search-users-btn')?.addEventListener('click', async () => {
                const search = document.getElementById('search-users-input').value.trim();
                if (!search) {
                    showMessage('admin-error-message', 'Digite algo para buscar', true);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users?search=${encodeURIComponent(search)}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        const resultsDiv = document.getElementById('search-users-results');
                        resultsDiv.classList.remove('hidden');
                        
                        if (users.length === 0) {
                            resultsDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum usu√°rio encontrado</p>';
                        } else {
                            resultsDiv.innerHTML = `
                                <div class="space-y-2">
                                    ${users.map(user => `
                                        <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                            <p class="text-white font-semibold">${user.email}</p>
                                            <p class="text-gray-400 text-sm">${user.name || 'N/A'} - ${user.whatsapp || 'N/A'}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Adicionar cr√©ditos individual
            let selectedUserIdForCredits = null;
            
            document.getElementById('add-credits-user-search')?.addEventListener('input', async (e) => {
                const search = e.target.value.trim();
                if (search.length < 2) {
                    document.getElementById('add-credits-user-results').classList.add('hidden');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users?search=${encodeURIComponent(search)}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        const resultsDiv = document.getElementById('add-credits-user-results');
                        resultsDiv.classList.remove('hidden');
                        
                        if (users.length === 0) {
                            resultsDiv.innerHTML = '<p class="text-gray-400 text-sm">Nenhum usu√°rio encontrado</p>';
                        } else {
                            resultsDiv.innerHTML = `
                                <div class="space-y-1 bg-gray-900 rounded-lg p-2 border border-gray-700">
                                    ${users.slice(0, 5).map(user => `
                                        <button class="w-full text-left p-2 hover:bg-gray-800 rounded text-sm text-white user-select-btn" data-user-id="${user.id}" data-user-email="${user.email}">
                                            ${user.email} - ${user.name || 'N/A'}
                                        </button>
                                    `).join('')}
                                </div>
                            `;
                            
                            document.querySelectorAll('.user-select-btn').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    selectedUserIdForCredits = btn.dataset.userId;
                                    document.getElementById('add-credits-user-search').value = btn.dataset.userEmail;
                                    resultsDiv.classList.add('hidden');
                                });
                            });
                        }
                    }
                } catch (err) {
                    console.error('Erro ao buscar usu√°rios:', err);
                }
            });
            
            document.getElementById('add-credits-btn')?.addEventListener('click', async () => {
                if (!selectedUserIdForCredits) {
                    showMessage('admin-error-message', 'Selecione um usu√°rio primeiro', true);
                    return;
                }
                
                const amount = parseFloat(document.getElementById('add-credits-amount').value);
                const description = document.getElementById('add-credits-description').value;
                
                if (!amount || amount <= 0) {
                    showMessage('admin-error-message', 'Digite uma quantidade v√°lida', true);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/credits/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            user_id: selectedUserIdForCredits,
                            amount: amount,
                            description: description || 'Cr√©ditos adicionados pelo administrador'
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Cr√©ditos adicionados com sucesso');
                        document.getElementById('add-credits-amount').value = '';
                        document.getElementById('add-credits-description').value = '';
                        document.getElementById('add-credits-user-search').value = '';
                        selectedUserIdForCredits = null;
                        loadAdminCreditsTable();
                    } else {
                        throw new Error('Erro ao adicionar cr√©ditos');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Carregar tabela de usu√°rios com cr√©ditos
            async function loadAdminCreditsTable(page = 1) {
                try {
                    const minBalance = parseFloat(document.getElementById('min-balance-filter')?.value || 0);
                    const offset = (page - 1) * creditsPerPage;
                    
                    const response = await fetch(`${API_BASE}/api/admin/credits/users-with-balance?min_balance=${minBalance}&limit=${creditsPerPage}&offset=${offset}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const tbody = document.getElementById('admin-credits-table-body');
                        tbody.innerHTML = '';
                        
                        if (data.users.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">Nenhum usu√°rio encontrado</td></tr>';
                        } else {
                            data.users.forEach(user => {
                                const lastUpdated = user.last_updated 
                                    ? new Date(user.last_updated).toLocaleString('pt-BR')
                                    : 'N/A';
                                
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-3"><input type="checkbox" class="user-checkbox bg-gray-700 border-gray-600 rounded" data-user-id="${user.id}"></td>
                                        <td class="p-3 text-sm text-gray-200">${user.email}</td>
                                        <td class="p-3 text-sm text-gray-200">${user.whatsapp || 'N/A'}</td>
                                        <td class="p-3 text-sm text-gray-200">N/A</td>
                                        <td class="p-3 text-sm font-bold text-yellow-400">${parseFloat(user.balance || 0).toFixed(2)}</td>
                                        <td class="p-3 text-sm text-gray-400">${lastUpdated}</td>
                                        <td class="p-3">
                                            <div class="flex gap-2">
                                                <button class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded btn-edit-user-credits" data-user-id="${user.id}" data-user-email="${user.email}">
                                                    Editar
                                                </button>
                                                <button class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded btn-reset-user-credits" data-user-id="${user.id}">
                                                    Zerar
                                                </button>
                                                <button class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded btn-history-user-credits" data-user-id="${user.id}">
                                                    Hist√≥rico
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Event listeners
                            document.querySelectorAll('.btn-edit-user-credits').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const userId = btn.dataset.userId;
                                    const userEmail = btn.dataset.userEmail;
                                    showManageCreditsModal(userId, userEmail);
                                });
                            });
                            
                            document.querySelectorAll('.btn-reset-user-credits').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const userId = btn.dataset.userId;
                                    const confirmed = await showCustomConfirm('Tem certeza que deseja zerar os cr√©ditos deste usu√°rio?');
                                    if (!confirmed) return;
                                    
                                    try {
                                        const response = await fetch(`${API_BASE}/api/admin/credits/reset`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${userToken}`
                                            },
                                            body: JSON.stringify({ user_id: userId })
                                        });
                                        
                                        if (response.ok) {
                                            showMessage('admin-success-message', 'Cr√©ditos zerados com sucesso');
                                            loadAdminCreditsTable(currentCreditsPage);
                                        } else {
                                            throw new Error('Erro ao zerar cr√©ditos');
                                        }
                                    } catch (err) {
                                        showMessage('admin-error-message', err.message, true);
                                    }
                                });
                            });
                            
                            document.querySelectorAll('.btn-history-user-credits').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const userId = btn.dataset.userId;
                                    try {
                                        const response = await fetch(`${API_BASE}/api/admin/credits/transactions/${userId}`, {
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        });
                                        
                                        if (response.ok) {
                                            const data = await response.json();
                                            showCreditsHistoryModal(data.data, userId);
                                        }
                                    } catch (err) {
                                        showMessage('admin-error-message', err.message, true);
                                    }
                                });
                            });
                            
                            // Pagina√ß√£o
                            const totalPages = Math.ceil(data.total / creditsPerPage);
                            const paginationDiv = document.getElementById('credits-pagination');
                            if (paginationDiv) {
                                let paginationHtml = '';
                                if (currentCreditsPage > 1) {
                                    paginationHtml += `<a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700 prev-page">Anterior</a>`;
                                }
                                for (let i = 1; i <= totalPages && i <= 5; i++) {
                                    paginationHtml += `<a href="#" class="px-3 py-1 rounded-md ${i === currentCreditsPage ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'} page-link" data-page="${i}">${i}</a>`;
                                }
                                if (currentCreditsPage < totalPages) {
                                    paginationHtml += `<a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700 next-page">Pr√≥ximo</a>`;
                                }
                                paginationDiv.innerHTML = paginationHtml;
                                
                                document.querySelectorAll('.page-link').forEach(link => {
                                    link.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        currentCreditsPage = parseInt(link.dataset.page);
                                        loadAdminCreditsTable(currentCreditsPage);
                                    });
                                });
                                
                                document.querySelector('.prev-page')?.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (currentCreditsPage > 1) {
                                        currentCreditsPage--;
                                        loadAdminCreditsTable(currentCreditsPage);
                                    }
                                });
                                
                                document.querySelector('.next-page')?.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (currentCreditsPage < totalPages) {
                                        currentCreditsPage++;
                                        loadAdminCreditsTable(currentCreditsPage);
                                    }
                                });
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar tabela de cr√©ditos:', err);
                }
            }
            
            // Carregar cr√©ditos no admin
            async function loadAdminCredits() {
                await loadGlobalSettings();
                await loadAdminCreditsTable();
                
                // Carregar estat√≠sticas
                try {
                    const statsResponse = await fetch(`${API_BASE}/api/admin/credits/statistics`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        document.getElementById('admin-total-credits').textContent = parseFloat(stats.totalDistributed || 0).toFixed(2);
                        document.getElementById('admin-users-with-credits').textContent = stats.usersWithCredits || 0;
                        document.getElementById('admin-credits-used').textContent = parseFloat(stats.creditsUsed30Days || 0).toFixed(2);
                    }
                } catch (err) {
                    console.error('Erro ao carregar estat√≠sticas:', err);
                }
            }
            
            // Atualizar tabela quando mudar filtro de saldo m√≠nimo
            document.getElementById('min-balance-filter')?.addEventListener('change', () => {
                currentCreditsPage = 1;
                loadAdminCreditsTable();
            });
            
            // Bot√£o atualizar
            document.getElementById('refresh-credits-table')?.addEventListener('click', () => {
                loadAdminCreditsTable(currentCreditsPage);
            });
            
            // Carregar estat√≠sticas
            document.getElementById('load-statistics-btn')?.addEventListener('click', async () => {
                const startDate = document.getElementById('stats-start-date').value;
                const endDate = document.getElementById('stats-end-date').value;
                
                try {
                    let url = `${API_BASE}/api/admin/credits/statistics?`;
                    if (startDate) url += `startDate=${startDate}&`;
                    if (endDate) url += `endDate=${endDate}`;
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const stats = await response.json();
                        const resultsDiv = document.getElementById('statistics-results');
                        resultsDiv.classList.remove('hidden');
                        
                        resultsDiv.innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400">Total de Opera√ß√µes</p>
                                    <p class="text-2xl font-bold text-white mt-1">${stats.summary?.total_operations || 0}</p>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400">Total de Cr√©ditos Usados</p>
                                    <p class="text-2xl font-bold text-white mt-1">${parseFloat(stats.summary?.total_credits || 0).toFixed(2)}</p>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400">Usu√°rios √önicos</p>
                                    <p class="text-2xl font-bold text-white mt-1">${stats.summary?.unique_users || 0}</p>
                                </div>
                            </div>
                            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                <h3 class="text-lg font-semibold text-white mb-4">Top 10 Usu√°rios</h3>
                                <div class="space-y-2">
                                    ${(stats.byUser || []).slice(0, 10).map(user => `
                                        <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                                            <span class="text-white text-sm">${user.email}</span>
                                            <span class="text-yellow-400 font-bold">${parseFloat(user.total_credits || 0).toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Exportar cr√©ditos
            document.getElementById('export-credits-btn')?.addEventListener('click', async () => {
                const startDate = document.getElementById('stats-start-date').value;
                const endDate = document.getElementById('stats-end-date').value;
                
                try {
                    let url = `${API_BASE}/api/admin/credits/export?format=csv`;
                    if (startDate) url += `&startDate=${startDate}`;
                    if (endDate) url += `&endDate=${endDate}`;
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `creditos_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Exporta√ß√£o realizada com sucesso');
                    } else {
                        throw new Error('Erro ao exportar');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Modal de hist√≥rico de cr√©ditos (Admin)
            function showCreditsHistoryModal(transactions, userId) {
                const modalHtml = `
                    <div id="user-credits-history-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white">Hist√≥rico de Transa√ß√µes</h2>
                                <div class="flex items-center gap-3">
                                    ${transactions.length > 0 ? `
                                        <button id="clear-user-history-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-colors flex items-center gap-2" data-user-id="${userId}">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            Zerar Hist√≥rico
                                        </button>
                                    ` : ''}
                                <button id="close-user-history-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${transactions.length === 0 
                                    ? '<p class="text-gray-400 text-center py-8">Nenhuma transa√ß√£o encontrada</p>'
                                    : transactions.map(t => {
                                        const isCredit = t.isCredit || t.transaction_type === 'credit' || t.amount > 0;
                                        const amount = Math.abs(parseFloat(t.amount || 0));
                                        const date = new Date(t.created_at);
                                        
                                        // Informa√ß√µes da opera√ß√£o
                                        let operationDetails = '';
                                        if (t.operation) {
                                            const op = t.operation;
                                            operationDetails = `
                                                <div class="mt-2 pt-2 border-t border-gray-700">
                                                    <div class="flex flex-wrap gap-2 text-xs">
                                                        ${op.typeName ? `<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">${op.typeName}</span>` : ''}
                                                        ${op.model && op.model !== 'N/A' ? `<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded">${op.model}</span>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }
                                        
                                        return `
                                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <span class="text-lg font-bold ${isCredit ? 'text-green-400' : 'text-red-400'}">
                                                                ${isCredit ? '+' : '-'} ${amount.toFixed(2)} cr√©ditos
                                                            </span>
                                                            ${isCredit 
                                                                ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded">Cr√©dito</span>'
                                                                : '<span class="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded">D√©bito</span>'
                                                            }
                                                        </div>
                                                        <p class="text-white font-medium mb-1">${t.description || 'Transa√ß√£o'}</p>
                                                        ${operationDetails}
                                                        <p class="text-gray-500 text-xs mt-2">
                                                            <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                                            ${date.toLocaleString('pt-BR', { 
                                                                day: '2-digit', 
                                                                month: '2-digit', 
                                                                year: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                document.getElementById('close-user-history-modal')?.addEventListener('click', () => {
                    document.getElementById('user-credits-history-modal')?.remove();
                });
                
                // Bot√£o para zerar hist√≥rico
                document.getElementById('clear-user-history-btn')?.addEventListener('click', async () => {
                    const btn = document.getElementById('clear-user-history-btn');
                    const userId = btn.dataset.userId;
                    
                    // Confirmar a√ß√£o
                    const confirmed = await showStyledConfirm(
                        'Tem certeza que deseja zerar todo o hist√≥rico de transa√ß√µes deste usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.',
                        'Zerar Hist√≥rico'
                    );
                    
                    if (!confirmed) return;
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Zerando...';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        
                        const response = await fetch(`${API_BASE}/api/admin/credits/transactions/${userId}/clear`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${userToken}`
                            }
                        });
                        
                        if (response.ok) {
                            showStyledAlert('Hist√≥rico de transa√ß√µes zerado com sucesso!', 'Sucesso');
                            // Fechar modal e recarregar hist√≥rico
                            document.getElementById('user-credits-history-modal')?.remove();
                            // Recarregar hist√≥rico se necess√°rio
                            const historyBtn = document.querySelector(`.btn-history-user-credits[data-user-id="${userId}"]`);
                            if (historyBtn) {
                                historyBtn.click();
                            }
                        } else {
                            const error = await response.json();
                            throw new Error(error.message || 'Erro ao zerar hist√≥rico');
                        }
                    } catch (err) {
                        showStyledAlert(err.message || 'Erro ao zerar hist√≥rico de transa√ß√µes', 'Erro');
                        btn.disabled = false;
                        btn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i> Zerar Hist√≥rico';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                });
            }
            
            // Carregar configura√ß√£o de Voz Premium
            async function loadVoicePremiumConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/api-providers`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const apis = await response.json();
                        const voicePremiumApi = apis.find(api => api.provider === 'genaipro' || api.provider === 'voice_premium');
                        
                        if (voicePremiumApi) {
                            // Mostrar chave parcialmente mascarada
                            const apiKeyInput = document.getElementById('voice-premium-api-key');
                            const maskedKey = voicePremiumApi.api_key.length > 10 
                                ? voicePremiumApi.api_key.substring(0, 8) + '...' + voicePremiumApi.api_key.substring(voicePremiumApi.api_key.length - 4)
                                : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                            apiKeyInput.value = maskedKey;
                            apiKeyInput.setAttribute('data-saved-key', voicePremiumApi.api_key);
                            apiKeyInput.setAttribute('readonly', 'readonly');
                            apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            // Adicionar bot√£o para editar
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                apiKeyInput.removeAttribute('readonly');
                                apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                apiKeyInput.value = voicePremiumApi.api_key;
                                apiKeyInput.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            
                            const checkBtn = document.getElementById('check-voice-premium-balance');
                            if (checkBtn && !checkBtn.nextElementSibling?.classList.contains('edit-voice-key-btn')) {
                                checkBtn.insertAdjacentElement('afterend', editBtn);
                                editBtn.classList.add('edit-voice-key-btn');
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configura√ß√£o Voz Premium:', err);
                }
            }
            
            // Verificar saldo da API Voz Premium
            document.getElementById('check-voice-premium-balance')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-premium-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('check-voice-premium-balance');
                btn.disabled = true;
                btn.textContent = 'Verificando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/voice-premium/check-balance`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('[Admin] Resposta de verifica√ß√£o de saldo:', data);
                        
                        const resultDiv = document.getElementById('voice-premium-balance-result');
                        resultDiv.classList.remove('hidden');
                        
                        if (data.balance !== null && data.balance !== undefined) {
                            const balanceValue = parseFloat(data.balance);
                            document.getElementById('voice-premium-balance-amount').textContent = `${balanceValue.toFixed(2)} cr√©ditos`;
                            document.getElementById('voice-premium-balance-amount').classList.remove('text-gray-400');
                            document.getElementById('voice-premium-balance-amount').classList.add('text-yellow-400');
                        } else {
                            document.getElementById('voice-premium-balance-amount').textContent = 'N/A';
                            document.getElementById('voice-premium-balance-amount').classList.remove('text-yellow-400');
                            document.getElementById('voice-premium-balance-amount').classList.add('text-gray-400');
                        }
                        
                        showMessage('admin-success-message', data.message || 'Saldo verificado com sucesso');
                    } else {
                        const error = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
                        console.error('[Admin] Erro ao verificar saldo:', error);
                        showMessage('admin-error-message', error.message || 'Erro ao verificar saldo', true);
                        
                        // Mostrar resultado mesmo com erro (pode ser que a chave seja v√°lida)
                        const resultDiv = document.getElementById('voice-premium-balance-result');
                        resultDiv.classList.remove('hidden');
                        document.getElementById('voice-premium-balance-amount').textContent = 'N/A';
                    }
                } catch (err) {
                    showMessage('admin-error-message', 'Erro ao verificar saldo: ' + err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Verificar Saldo';
                }
            });
            
            // Salvar chave da API Voz Premium
            document.getElementById('save-voice-premium-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-premium-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-voice-premium-api');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/voice-premium/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ 
                            api_key: apiKey,
                            name: 'Voz Premium'
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de API Voz Premium salva com sucesso');
                        // Mascarar chave na interface
                        const maskedKey = apiKey.length > 10 
                            ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                            : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        apiKeyInput.value = maskedKey;
                        apiKeyInput.setAttribute('data-saved-key', apiKey);
                        apiKeyInput.setAttribute('readonly', 'readonly');
                        apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                        
                        // Recarregar lista de APIs
                        loadAdminApis();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar configura√ß√£o de Chave de Voz
            async function loadVoiceApiKeyConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const voiceApiKey = settings.voice_api_key;
                        
                        if (voiceApiKey) {
                            const apiKeyInput = document.getElementById('voice-api-key');
                            if (apiKeyInput) {
                                const maskedKey = voiceApiKey.length > 10 
                                    ? voiceApiKey.substring(0, 8) + '...' + voiceApiKey.substring(voiceApiKey.length - 4)
                                    : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                                apiKeyInput.value = maskedKey;
                                apiKeyInput.setAttribute('data-saved-key', voiceApiKey);
                                apiKeyInput.setAttribute('readonly', 'readonly');
                                apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                                
                                // Adicionar bot√£o para editar
                                const existingEditBtn = apiKeyInput.parentElement.querySelector('.edit-voice-key-btn');
                                if (existingEditBtn) {
                                    existingEditBtn.remove();
                                }
                                
                                const editBtn = document.createElement('button');
                                editBtn.textContent = 'Editar';
                                editBtn.className = 'edit-voice-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                                editBtn.addEventListener('click', () => {
                                    apiKeyInput.removeAttribute('readonly');
                                    apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                    apiKeyInput.value = voiceApiKey;
                                    apiKeyInput.removeAttribute('data-saved-key');
                                    editBtn.remove();
                                });
                                
                                // Inserir bot√£o ap√≥s o input
                                const inputContainer = apiKeyInput.parentElement;
                                inputContainer.insertBefore(editBtn, apiKeyInput.nextSibling);
                            }
                        } else {
                            const apiKeyInput = document.getElementById('voice-api-key');
                            if (apiKeyInput) {
                                apiKeyInput.value = '';
                                apiKeyInput.removeAttribute('readonly');
                                apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                apiKeyInput.removeAttribute('data-saved-key');
                                const existingEditBtn = apiKeyInput.parentElement.querySelector('.edit-voice-key-btn');
                                if (existingEditBtn) existingEditBtn.remove();
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configura√ß√£o de chave de voz:', err);
                }
            }
            
            // Validar chave de API de Voz
            document.getElementById('validate-voice-api-key')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('validate-voice-api-key');
                const resultDiv = document.getElementById('voice-api-key-validation-result');
                const messageDiv = document.getElementById('voice-api-key-validation-message');
                
                btn.disabled = true;
                btn.textContent = 'Validando...';
                resultDiv.classList.remove('hidden');
                messageDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Validando chave...</p>';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/voice-api-key/validate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        messageDiv.innerHTML = `
                            <p class="text-green-400 font-semibold">‚úÖ ${data.message || 'Chave v√°lida!'}</p>
                            ${data.type ? `<p class="text-gray-400 text-xs mt-1">Tipo: ${data.type}</p>` : ''}
                            ${data.warning ? `<p class="text-yellow-400 text-xs mt-1">‚ö†Ô∏è ${data.warning}</p>` : ''}
                        `;
                        resultDiv.classList.remove('border-gray-700');
                        resultDiv.classList.add('border-green-700');
                    } else {
                        messageDiv.innerHTML = `
                            <p class="text-red-400 font-semibold">‚ùå ${data.message || 'Chave inv√°lida'}</p>
                            ${data.error ? `<p class="text-gray-400 text-xs mt-1">${data.error}</p>` : ''}
                        `;
                        resultDiv.classList.remove('border-gray-700');
                        resultDiv.classList.add('border-red-700');
                    }
                } catch (err) {
                    messageDiv.innerHTML = `<p class="text-red-400 font-semibold">‚ùå Erro ao validar: ${err.message}</p>`;
                    resultDiv.classList.remove('border-gray-700');
                    resultDiv.classList.add('border-red-700');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Validar';
                }
            });
            
            // Carregar chave de voz OpenAI
            async function loadOpenAiVoiceKeyConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const openAiKey = settings.openai_voice_api_key;
                        const input = document.getElementById('openai-voice-api-key');
                        if (!input) return;
                        
                        const applyMask = (key) => {
                            if (!key) return '';
                            return key.length > 10 ? key.substring(0, 8) + '...' + key.substring(key.length - 4) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        };
                        
                        const cleanupEditBtn = () => {
                            const existing = input.parentElement.querySelector('.edit-openai-voice-key-btn');
                            if (existing) existing.remove();
                        };
                        
                        if (openAiKey) {
                            input.value = applyMask(openAiKey);
                            input.setAttribute('data-saved-key', openAiKey);
                            input.setAttribute('readonly', 'readonly');
                            input.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            cleanupEditBtn();
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'edit-openai-voice-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                input.removeAttribute('readonly');
                                input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                input.value = openAiKey;
                                input.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            input.parentElement.insertBefore(editBtn, input.nextSibling);
                        } else {
                            cleanupEditBtn();
                            input.value = '';
                            input.removeAttribute('readonly');
                            input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                            input.removeAttribute('data-saved-key');
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar chave OpenAI:', err);
                }
            }
            
            // Validar chave OpenAI
            document.getElementById('validate-openai-voice-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('openai-voice-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('validate-openai-voice-api-key');
                const resultDiv = document.getElementById('openai-voice-api-key-validation-result');
                const messageDiv = document.getElementById('openai-voice-api-key-validation-message');
                
                btn.disabled = true;
                btn.textContent = 'Validando...';
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('border-red-700', 'border-green-700');
                messageDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Validando chave...</p>';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/openai-voice/validate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        messageDiv.innerHTML = `<p class="text-green-400 font-semibold">‚úÖ ${data.message || 'Chave v√°lida!'}</p>`;
                        resultDiv.classList.add('border-green-700');
                    } else {
                        messageDiv.innerHTML = `<p class="text-red-400 font-semibold">‚ùå ${data.message || 'Chave inv√°lida'}</p>`;
                        resultDiv.classList.add('border-red-700');
                    }
                } catch (err) {
                    messageDiv.innerHTML = `<p class="text-red-400 font-semibold">‚ùå Erro ao validar: ${err.message}</p>`;
                    resultDiv.classList.add('border-red-700');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Validar';
                }
            });
            
            // Salvar chave OpenAI
            document.getElementById('save-openai-voice-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('openai-voice-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-openai-voice-api-key');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                openai_voice_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave OpenAI salva com sucesso');
                        await loadOpenAiVoiceKeyConfig();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar chave de v√≠deo
            async function loadVideoApiKeyConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const videoKey = settings.video_api_key;
                        const input = document.getElementById('video-api-key');
                        if (!input) return;
                        
                        const applyMask = (key) => {
                            if (!key) return '';
                            return key.length > 10 ? key.substring(0, 8) + '...' + key.substring(key.length - 4) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        };
                        
                        const cleanupEditBtn = () => {
                            const existing = input.parentElement.querySelector('.edit-video-key-btn');
                            if (existing) existing.remove();
                        };
                        
                        if (videoKey) {
                            input.value = applyMask(videoKey);
                            input.setAttribute('data-saved-key', videoKey);
                            input.setAttribute('readonly', 'readonly');
                            input.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            cleanupEditBtn();
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'edit-video-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                input.removeAttribute('readonly');
                                input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                input.value = videoKey;
                                input.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            input.parentElement.insertBefore(editBtn, input.nextSibling);
                        } else {
                            cleanupEditBtn();
                            input.value = '';
                            input.removeAttribute('readonly');
                            input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                            input.removeAttribute('data-saved-key');
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar chave de v√≠deo:', err);
                }
            }
            
            document.getElementById('validate-video-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('video-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('validate-video-api-key');
                const resultDiv = document.getElementById('video-api-key-validation-result');
                const messageDiv = document.getElementById('video-api-key-validation-message');
                
                btn.disabled = true;
                btn.textContent = 'Validando...';
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('border-red-700', 'border-green-700');
                messageDiv.innerHTML = '<p class="text-yellow-400">‚è≥ Validando chave...</p>';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/video-api/validate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        messageDiv.innerHTML = `<p class="text-green-400 font-semibold">‚úÖ ${data.message || 'Chave v√°lida!'}</p>`;
                        resultDiv.classList.add('border-green-700');
                    } else {
                        messageDiv.innerHTML = `<p class="text-red-400 font-semibold">‚ùå ${data.message || 'Chave inv√°lida'}</p>`;
                        resultDiv.classList.add('border-red-700');
                    }
                } catch (err) {
                    messageDiv.innerHTML = `<p class="text-red-400 font-semibold">‚ùå Erro ao validar: ${err.message}</p>`;
                    resultDiv.classList.add('border-red-700');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Validar';
                }
            });
            
            document.getElementById('save-video-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('video-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-video-api-key');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                video_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de v√≠deo salva com sucesso');
                        await loadVideoApiKeyConfig();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Salvar chave de API de Voz
            document.getElementById('save-voice-api-key')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-voice-api-key');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                voice_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de API de Voz salva com sucesso');
                        // Mascarar chave na interface
                        const maskedKey = apiKey.length > 10 
                            ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                            : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        apiKeyInput.value = maskedKey;
                        apiKeyInput.setAttribute('data-saved-key', apiKey);
                        apiKeyInput.setAttribute('readonly', 'readonly');
                        apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                        
                        // Adicionar bot√£o para editar
                        const existingEditBtn = apiKeyInput.parentElement.querySelector('.edit-voice-key-btn');
                        if (existingEditBtn) {
                            existingEditBtn.remove();
                        }
                        
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Editar';
                        editBtn.className = 'edit-voice-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                        editBtn.addEventListener('click', () => {
                            apiKeyInput.removeAttribute('readonly');
                            apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                            apiKeyInput.value = apiKey;
                            apiKeyInput.removeAttribute('data-saved-key');
                            editBtn.remove();
                        });
                        
                        // Inserir bot√£o ap√≥s o input
                        const inputContainer = apiKeyInput.parentElement;
                        inputContainer.insertBefore(editBtn, apiKeyInput.nextSibling);
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar configura√ß√£o de Laozhang.ai
            async function loadLaozhangConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const laozhangApiKey = settings.laozhang_api_key;
                        const laozhangUseAsDefault = settings.laozhang_use_as_default || false;
                        
                        // Carregar checkbox de usar como padr√£o
                        const defaultCheckbox = document.getElementById('laozhang-use-as-default');
                        if (defaultCheckbox) {
                            defaultCheckbox.checked = laozhangUseAsDefault;
                        }
                        
                        if (laozhangApiKey) {
                            const apiKeyInput = document.getElementById('laozhang-api-key');
                            const maskedKey = laozhangApiKey.length > 10 
                                ? laozhangApiKey.substring(0, 8) + '...' + laozhangApiKey.substring(laozhangApiKey.length - 4)
                                : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                            apiKeyInput.value = maskedKey;
                            apiKeyInput.setAttribute('data-saved-key', laozhangApiKey);
                            apiKeyInput.setAttribute('readonly', 'readonly');
                            apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            // Adicionar bot√£o para editar
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                apiKeyInput.removeAttribute('readonly');
                                apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                apiKeyInput.value = laozhangApiKey;
                                apiKeyInput.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            
                            const checkBtn = document.getElementById('check-laozhang-api');
                            if (checkBtn && !checkBtn.nextElementSibling?.classList.contains('edit-laozhang-key-btn')) {
                                checkBtn.insertAdjacentElement('afterend', editBtn);
                                editBtn.classList.add('edit-laozhang-key-btn');
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configura√ß√£o Laozhang.ai:', err);
                }
            }
            
            // Salvar configura√ß√£o de usar como padr√£o
            document.getElementById('laozhang-use-as-default')?.addEventListener('change', async (e) => {
                const useAsDefault = e.target.checked;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                laozhang_use_as_default: useAsDefault
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', useAsDefault 
                            ? 'API configurada como padr√£o para todas as fun√ß√µes' 
                            : 'API removida como padr√£o', false);
                    } else {
                        throw new Error('Erro ao salvar configura√ß√£o');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                    // Reverter checkbox em caso de erro
                    e.target.checked = !useAsDefault;
                }
            });
            
            // Verificar chave da API Laozhang.ai
            document.getElementById('check-laozhang-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('laozhang-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('check-laozhang-api');
                btn.disabled = true;
                btn.textContent = 'Verificando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/laozhang/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const resultDiv = document.getElementById('laozhang-api-result');
                        resultDiv.classList.remove('hidden');
                        
                        if (data.success) {
                            document.getElementById('laozhang-api-status').textContent = 'V√°lida';
                            document.getElementById('laozhang-api-status').classList.remove('text-red-400');
                            document.getElementById('laozhang-api-status').classList.add('text-green-400');
                            showMessage('admin-success-message', data.message || 'Chave de API v√°lida');
                        } else {
                            document.getElementById('laozhang-api-status').textContent = 'Inv√°lida';
                            document.getElementById('laozhang-api-status').classList.remove('text-green-400');
                            document.getElementById('laozhang-api-status').classList.add('text-red-400');
                            showMessage('admin-error-message', data.message || 'Chave de API inv√°lida', true);
                        }
                    } else {
                        const error = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
                        showMessage('admin-error-message', error.message || 'Erro ao verificar chave', true);
                        const resultDiv = document.getElementById('laozhang-api-result');
                        resultDiv.classList.remove('hidden');
                        document.getElementById('laozhang-api-status').textContent = 'Erro';
                        document.getElementById('laozhang-api-status').classList.remove('text-green-400');
                        document.getElementById('laozhang-api-status').classList.add('text-red-400');
                    }
                } catch (err) {
                    console.error('[Admin] Erro ao verificar chave Laozhang.ai:', err);
                    showMessage('admin-error-message', 'Erro ao verificar chave: ' + err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Verificar';
                }
            });
            
            // Salvar chave da API Laozhang.ai
            document.getElementById('save-laozhang-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('laozhang-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-laozhang-api');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                laozhang_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de API salva com sucesso');
                        // Mascarar chave na interface
                        const maskedKey = apiKey.length > 10 
                            ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                            : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                        apiKeyInput.value = maskedKey;
                        apiKeyInput.setAttribute('data-saved-key', apiKey);
                        apiKeyInput.setAttribute('readonly', 'readonly');
                        apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar APIs no admin
            async function loadAdminApis() {
                await loadVoicePremiumConfig();
                await loadVoiceApiKeyConfig();
                await loadOpenAiVoiceKeyConfig();
                await loadVideoApiKeyConfig();
                await loadLaozhangConfig();
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/api-providers`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const apis = await response.json();
                        // Filtrar APIs que n√£o s√£o Voz Premium (para n√£o mostrar GenAIPro)
                        const otherApis = apis.filter(api => api.provider !== 'genaipro' && api.provider !== 'voice_premium');
                        const tbody = document.getElementById('admin-apis-table-body');
                        tbody.innerHTML = '';
                        
                        if (otherApis.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhuma outra API cadastrada</td></tr>';
                        } else {
                            otherApis.forEach(api => {
                                const statusBadge = api.is_active 
                                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-400">Ativa</span>'
                                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-500/20 text-red-400">Inativa</span>';
                                const defaultBadge = api.is_default 
                                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-500/20 text-blue-400 ml-2">Padr√£o</span>'
                                    : '';
                                
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-3 text-sm text-gray-200">${api.name}</td>
                                        <td class="p-3 text-sm text-gray-200">${api.model}</td>
                                        <td class="p-3 text-sm text-gray-200">${parseFloat(api.credits_per_unit || 0).toFixed(2)}</td>
                                        <td class="p-3">${statusBadge}${defaultBadge}</td>
                                        <td class="p-3">
                                            <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded btn-edit-api mr-2" data-api='${JSON.stringify(api)}'>
                                                Editar
                                            </button>
                                            <button class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded btn-delete-api" data-api-id="${api.id}">
                                                Excluir
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                        }
                        
                        // Event listeners
                        document.querySelectorAll('.btn-edit-api').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const api = JSON.parse(btn.dataset.api);
                                showEditApiModal(api);
                            });
                        });
                        
                        document.querySelectorAll('.btn-delete-api').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const apiId = btn.dataset.apiId;
                                deleteApi(apiId);
                            });
                        });
                    }
                } catch (err) {
                    console.error('Erro ao carregar APIs:', err);
                }
            }
            
            // Modal para gerenciar cr√©ditos
            async function showManageCreditsModal(userId, userEmail) {
                try {
                    // Carregar saldo atual
                    const balanceResponse = await fetch(`${API_BASE}/api/admin/credits/balance/${userId}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const balanceData = await balanceResponse.json();
                    const currentBalance = balanceData.balance || 0;
                    
                    const modalHtml = `
                        <div id="manage-credits-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                            <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-bold text-white">Gerenciar Cr√©ditos</h2>
                                    <button id="close-manage-credits-modal" class="text-gray-400 hover:text-white">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <div class="mb-4">
                                    <p class="text-sm text-gray-400 mb-1">Usu√°rio:</p>
                                    <p class="text-white font-semibold">${userEmail}</p>
                                </div>
                                <div class="mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400 mb-1">Saldo Atual:</p>
                                    <p class="text-2xl font-bold text-yellow-400">${parseFloat(currentBalance).toFixed(2)}</p>
                                </div>
                                <form id="manage-credits-form" class="space-y-4">
                                    <input type="hidden" id="manage-credits-user-id" value="${userId}">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Adicionar Cr√©ditos</label>
                                        <input type="number" id="manage-credits-amount" step="0.01" min="0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Descri√ß√£o (opcional)</label>
                                        <input type="text" id="manage-credits-description" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: B√¥nus promocional">
                                    </div>
                                    <div class="flex gap-3 pt-4">
                                        <button type="button" id="reset-credits-btn" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                                            Zerar
                                        </button>
                                        <button type="button" id="cancel-manage-credits" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                            Adicionar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    document.getElementById('close-manage-credits-modal')?.addEventListener('click', () => {
                        document.getElementById('manage-credits-modal')?.remove();
                    });
                    
                    document.getElementById('cancel-manage-credits')?.addEventListener('click', () => {
                        document.getElementById('manage-credits-modal')?.remove();
                    });
                    
                    document.getElementById('reset-credits-btn')?.addEventListener('click', async () => {
                        if (!confirm('Tem certeza que deseja zerar os cr√©ditos deste usu√°rio?')) return;
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/credits/reset`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({ user_id: userId })
                            });
                            
                            if (response.ok) {
                                showMessage('admin-success-message', 'Cr√©ditos zerados com sucesso');
                                document.getElementById('manage-credits-modal')?.remove();
                                loadAdminCredits();
                            } else {
                                throw new Error('Erro ao zerar cr√©ditos');
                            }
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                        }
                    });
                    
                    document.getElementById('manage-credits-form')?.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const amount = parseFloat(document.getElementById('manage-credits-amount').value);
                        const description = document.getElementById('manage-credits-description').value;
                        
                        if (!amount || amount <= 0) {
                            showMessage('admin-error-message', 'Valor inv√°lido', true);
                            return;
                        }
                        
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/credits/add`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({
                                    user_id: userId,
                                    amount: amount,
                                    description: description || 'Cr√©ditos adicionados pelo administrador'
                                })
                            });
                            
                            if (response.ok) {
                                showMessage('admin-success-message', 'Cr√©ditos adicionados com sucesso');
                                document.getElementById('manage-credits-modal')?.remove();
                                loadAdminCredits();
                            } else {
                                throw new Error('Erro ao adicionar cr√©ditos');
                            }
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                        }
                    });
                } catch (err) {
                    console.error('Erro ao carregar modal de cr√©ditos:', err);
                }
            }
            
            // Modal para adicionar API
            function showAddApiModal() {
                // Implementar modal de adicionar API
                const modalHtml = `
                    <div id="add-api-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white">Adicionar Nova API</h2>
                                <button id="close-add-api-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <form id="add-api-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Nome</label>
                                        <input type="text" id="api-name" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                    <div style="display: none;">
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Provedor</label>
                                        <select id="api-provider" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                            <option value="openai">OpenAI</option>
                                            <option value="gemini">Gemini</option>
                                            <option value="claude">Claude</option>
                                            <option value="voice_premium">Voz Premium</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo</label>
                                    <input type="text" id="api-model" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="ex: gpt-4, gemini-pro, etc">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Chave de API</label>
                                    <input type="text" id="api-key" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Cr√©ditos/Unidade</label>
                                        <input type="number" id="api-credits-per-unit" step="0.01" value="1.0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Tamanho Unidade</label>
                                        <input type="number" id="api-unit-size" value="1000" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Markup</label>
                                        <input type="number" id="api-markup" step="0.01" value="1.0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="api-is-active" checked class="mr-2">
                                        <span class="text-gray-300">Ativa</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="api-is-default" class="mr-2">
                                        <span class="text-gray-300">API Padr√£o</span>
                                    </label>
                                </div>
                                <div class="flex justify-end gap-3 pt-4">
                                    <button type="button" id="cancel-add-api" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                        Adicionar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                document.getElementById('close-add-api-modal')?.addEventListener('click', () => {
                    document.getElementById('add-api-modal')?.remove();
                });
                
                document.getElementById('cancel-add-api')?.addEventListener('click', () => {
                    document.getElementById('add-api-modal')?.remove();
                });
                
                document.getElementById('add-api-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/api-providers`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                name: document.getElementById('api-name').value,
                                provider: document.getElementById('api-provider').value,
                                model: document.getElementById('api-model').value,
                                api_key: document.getElementById('api-key').value,
                                credits_per_unit: parseFloat(document.getElementById('api-credits-per-unit').value),
                                unit_size: parseInt(document.getElementById('api-unit-size').value),
                                markup: parseFloat(document.getElementById('api-markup').value),
                                is_active: document.getElementById('api-is-active').checked ? 1 : 0,
                                is_default: document.getElementById('api-is-default').checked ? 1 : 0
                            })
                        });
                        
                        if (response.ok) {
                            showMessage('admin-success-message', 'API adicionada com sucesso');
                            document.getElementById('add-api-modal')?.remove();
                            loadAdminApis();
                        } else {
                            throw new Error('Erro ao adicionar API');
                        }
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    }
                });
            }
            
            // Carregar configura√ß√µes de Pixel/Ads
            async function loadAdminPixel() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/pixel-config`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const config = await response.json();
                        if (config.facebook_pixel_id) {
                            document.getElementById('facebook-pixel-id').value = config.facebook_pixel_id;
                            document.getElementById('facebook-pixel-status').classList.remove('hidden');
                            document.getElementById('facebook-pixel-status-badge').textContent = 'Configurado';
                            document.getElementById('facebook-pixel-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                            document.getElementById('facebook-pixel-id-display').textContent = config.facebook_pixel_id;
                        }
                        if (config.google_ads_id) {
                            document.getElementById('google-ads-id').value = config.google_ads_id;
                            document.getElementById('google-ads-status').classList.remove('hidden');
                            document.getElementById('google-ads-status-badge').textContent = 'Configurado';
                            document.getElementById('google-ads-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                            document.getElementById('google-ads-id-display').textContent = config.google_ads_id;
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configura√ß√µes de Pixel:', err);
                }
            }

            // Salvar Facebook Pixel
            document.getElementById('save-facebook-pixel')?.addEventListener('click', async () => {
                const pixelId = document.getElementById('facebook-pixel-id').value.trim();
                if (!pixelId) {
                    showMessage('admin-error-message', 'Digite o Pixel ID do Facebook', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/pixel-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ facebook_pixel_id: pixelId })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Facebook Pixel configurado com sucesso!');
                        document.getElementById('facebook-pixel-status').classList.remove('hidden');
                        document.getElementById('facebook-pixel-status-badge').textContent = 'Configurado';
                        document.getElementById('facebook-pixel-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        document.getElementById('facebook-pixel-id-display').textContent = pixelId;
                    } else {
                        throw new Error('Erro ao salvar configura√ß√£o');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar Google Ads
            document.getElementById('save-google-ads')?.addEventListener('click', async () => {
                const adsId = document.getElementById('google-ads-id').value.trim();
                if (!adsId) {
                    showMessage('admin-error-message', 'Digite o ID de convers√£o do Google Ads', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/pixel-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ google_ads_id: adsId })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Google Ads configurado com sucesso!');
                        document.getElementById('google-ads-status').classList.remove('hidden');
                        document.getElementById('google-ads-status-badge').textContent = 'Configurado';
                        document.getElementById('google-ads-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        document.getElementById('google-ads-id-display').textContent = adsId;
                    } else {
                        throw new Error('Erro ao salvar configura√ß√£o');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Carregar configura√ß√µes de Stripe
            async function loadAdminPayments() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const config = await response.json();
                        if (config.publishable_key) {
                            document.getElementById('stripe-publishable-key').value = config.publishable_key;
                            document.getElementById('stripe-publishable-status').textContent = 'Configurado';
                            document.getElementById('stripe-publishable-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        }
                        if (config.secret_key) {
                            document.getElementById('stripe-secret-key').value = config.secret_key;
                            document.getElementById('stripe-secret-status').textContent = 'Configurado';
                            document.getElementById('stripe-secret-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        }
                        if (config.webhook_secret) {
                            document.getElementById('stripe-webhook-secret').value = config.webhook_secret;
                            document.getElementById('stripe-webhook-status').textContent = 'Configurado';
                            document.getElementById('stripe-webhook-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        }
                        // Carregar planos
                        if (config.plans) {
                            Object.keys(config.plans).forEach(planKey => {
                                const input = document.getElementById(`stripe-${planKey}`);
                                if (input && config.plans[planKey]) {
                                    input.value = config.plans[planKey];
                                }
                            });
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configura√ß√µes do Stripe:', err);
                }
            }

            // Salvar chave p√∫blica do Stripe
            document.getElementById('save-stripe-publishable')?.addEventListener('click', async () => {
                const key = document.getElementById('stripe-publishable-key').value.trim();
                if (!key) {
                    showMessage('admin-error-message', 'Digite a chave p√∫blica do Stripe', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ publishable_key: key })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave p√∫blica salva com sucesso!');
                        document.getElementById('stripe-publishable-status').textContent = 'Configurado';
                        document.getElementById('stripe-publishable-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                    } else {
                        throw new Error('Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar chave secreta do Stripe
            document.getElementById('save-stripe-secret')?.addEventListener('click', async () => {
                const key = document.getElementById('stripe-secret-key').value.trim();
                if (!key) {
                    showMessage('admin-error-message', 'Digite a chave secreta do Stripe', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ secret_key: key })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave secreta salva com sucesso!');
                        document.getElementById('stripe-secret-status').textContent = 'Configurado';
                        document.getElementById('stripe-secret-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                    } else {
                        throw new Error('Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar webhook secret do Stripe
            document.getElementById('save-stripe-webhook')?.addEventListener('click', async () => {
                const secret = document.getElementById('stripe-webhook-secret').value.trim();
                if (!secret) {
                    showMessage('admin-error-message', 'Digite o secret do webhook', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ webhook_secret: secret })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Webhook secret salvo com sucesso!');
                        document.getElementById('stripe-webhook-status').textContent = 'Configurado';
                        document.getElementById('stripe-webhook-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                    } else {
                        throw new Error('Erro ao salvar webhook');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar todos os planos do Stripe
            document.getElementById('save-all-stripe-plans')?.addEventListener('click', async () => {
                const plans = {};
                
                // Planos mensais
                const freeInput = document.getElementById('stripe-plan-free');
                if (freeInput && freeInput.value.trim()) plans['plan-free'] = freeInput.value.trim();
                
                const startInput = document.getElementById('stripe-plan-start');
                if (startInput && startInput.value.trim()) plans['plan-start'] = startInput.value.trim();
                
                const turboInput = document.getElementById('stripe-plan-turbo');
                if (turboInput && turboInput.value.trim()) plans['plan-turbo'] = turboInput.value.trim();
                
                const masterInput = document.getElementById('stripe-plan-master');
                if (masterInput && masterInput.value.trim()) plans['plan-master'] = masterInput.value.trim();
                
                // Planos anuais
                const startAnnualInput = document.getElementById('stripe-plan-start-annual');
                if (startAnnualInput && startAnnualInput.value.trim()) plans['plan-start-annual'] = startAnnualInput.value.trim();
                
                const turboAnnualInput = document.getElementById('stripe-plan-turbo-annual');
                if (turboAnnualInput && turboAnnualInput.value.trim()) plans['plan-turbo-annual'] = turboAnnualInput.value.trim();
                
                const masterAnnualInput = document.getElementById('stripe-plan-master-annual');
                if (masterAnnualInput && masterAnnualInput.value.trim()) plans['plan-master-annual'] = masterAnnualInput.value.trim();
                
                // Pacotes
                const pkg1000Input = document.getElementById('stripe-package-1000');
                if (pkg1000Input && pkg1000Input.value.trim()) plans['package-1000'] = pkg1000Input.value.trim();
                
                const pkg2500Input = document.getElementById('stripe-package-2500');
                if (pkg2500Input && pkg2500Input.value.trim()) plans['package-2500'] = pkg2500Input.value.trim();
                
                const pkg5000Input = document.getElementById('stripe-package-5000');
                if (pkg5000Input && pkg5000Input.value.trim()) plans['package-5000'] = pkg5000Input.value.trim();
                
                const pkg10000Input = document.getElementById('stripe-package-10000');
                if (pkg10000Input && pkg10000Input.value.trim()) plans['package-10000'] = pkg10000Input.value.trim();
                
                const pkg20000Input = document.getElementById('stripe-package-20000');
                if (pkg20000Input && pkg20000Input.value.trim()) plans['package-20000'] = pkg20000Input.value.trim();

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ plans })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Todos os planos foram salvos com sucesso!');
                    } else {
                        throw new Error('Erro ao salvar planos');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Toggle visibilidade de senhas
            document.getElementById('toggle-stripe-secret')?.addEventListener('click', () => {
                const input = document.getElementById('stripe-secret-key');
                input.type = input.type === 'password' ? 'text' : 'password';
            });

            document.getElementById('toggle-stripe-webhook')?.addEventListener('click', () => {
                const input = document.getElementById('stripe-webhook-secret');
                input.type = input.type === 'password' ? 'text' : 'password';
            });

            // ========== CONFIGURA√á√ïES DE WHATSAPP E EMAIL ==========
            
            // Toggle visibilidade de senhas
            document.getElementById('toggle-whatsapp-token')?.addEventListener('click', () => {
                const input = document.getElementById('whatsapp-token');
                if (input) input.type = input.type === 'password' ? 'text' : 'password';
            });

            document.getElementById('toggle-smtp-password')?.addEventListener('click', () => {
                const input = document.getElementById('smtp-password');
                if (input) input.type = input.type === 'password' ? 'text' : 'password';
            });

            // Salvar token do WhatsApp
            document.getElementById('save-whatsapp-token')?.addEventListener('click', async () => {
                const token = document.getElementById('whatsapp-token')?.value.trim();
                const numberId = document.getElementById('whatsapp-number-id')?.value.trim();
                
                if (!token || !numberId) {
                    showMessage('admin-error-message', 'Preencha o token e o n√∫mero do WhatsApp', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/whatsapp-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ token, number_id: numberId })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Configura√ß√£o do WhatsApp salva com sucesso!');
                    } else {
                        throw new Error('Erro ao salvar configura√ß√£o');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Copiar URL do webhook
            document.getElementById('copy-webhook-url')?.addEventListener('click', () => {
                const url = document.getElementById('whatsapp-webhook-url')?.value;
                if (url) {
                    navigator.clipboard.writeText(window.location.origin + url).then(() => {
                        showMessage('admin-success-message', 'URL copiada para a √°rea de transfer√™ncia!');
                    });
                }
            });

            // Salvar templates de email
            // Fun√ß√£o para salvar todos os templates de assinatura
            window.saveAllSubscriptionTemplates = async function() {
                const subscriptionPlans = [
                    'plan-start',
                    'plan-turbo',
                    'plan-master',
                    'plan-start-annual',
                    'plan-turbo-annual',
                    'plan-master-annual'
                ];
                
                let saved = 0;
                let errors = 0;
                
                for (const planKey of subscriptionPlans) {
                    const templateType = `subscription_${planKey}`;
                    const subjectInput = document.getElementById(`email-template-${templateType}-subject`);
                    const bodyInput = document.getElementById(`email-template-${templateType}-body`);
                    
                    if (subjectInput && bodyInput && (subjectInput.value.trim() || bodyInput.value.trim())) {
                        try {
                            const subject = subjectInput.value.trim() || `Assinatura ${planKey} confirmada`;
                            const body = bodyInput.value.trim() || '';
                            
                            const response = await fetch('/api/admin/email-templates', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    template_type: templateType,
                                    subject: subject,
                                    body: body
                                })
                            });
                            
                            if (response.ok) {
                                saved++;
                            } else {
                                errors++;
                            }
                        } catch (error) {
                            console.error(`Erro ao salvar template ${templateType}:`, error);
                            errors++;
                        }
                    }
                }
                
                if (saved > 0) {
                    alert(`‚úÖ ${saved} template(s) de assinatura salvos com sucesso!${errors > 0 ? `\n‚ö†Ô∏è ${errors} erro(s) ao salvar.` : ''}`);
                } else if (errors > 0) {
                    alert(`‚ùå Erro ao salvar templates. Verifique o console.`);
                } else {
                    alert('‚ÑπÔ∏è Nenhum template preenchido para salvar.');
                }
            };
            
            window.saveEmailTemplate = async function(templateType) {
                const subjectEl = document.getElementById(`email-template-${templateType}-subject`);
                const bodyEl = document.getElementById(`email-template-${templateType}-body`);
                
                if (!subjectEl || !bodyEl) return;
                
                const subject = subjectEl.value.trim();
                const body = bodyEl.value.trim();
                
                if (!subject || !body) {
                    showMessage('admin-error-message', 'Preencha o assunto e o corpo do email', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/email-templates`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ 
                            template_type: templateType,
                            subject,
                            body
                        })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', `Template de ${templateType} salvo com sucesso!`);
                    } else {
                        throw new Error('Erro ao salvar template');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            };

            // Carregar configura√ß√µes SMTP
            async function loadSMTPConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/smtp-config`, {
                        headers: {
                            'Authorization': `Bearer ${userToken}`
                        }
                    });

                    if (response.ok) {
                        const config = await response.json();
                        console.log('[SMTP] Configura√ß√µes carregadas:', config);
                        
                        if (config.host) document.getElementById('smtp-host').value = config.host;
                        if (config.port) document.getElementById('smtp-port').value = config.port;
                        if (config.email) document.getElementById('smtp-email').value = config.email;
                        if (config.password) document.getElementById('smtp-password').value = config.password;
                        if (config.secure !== undefined) document.getElementById('smtp-secure').checked = config.secure;
                    } else {
                        console.error('[SMTP] Erro ao carregar configura√ß√µes:', response.status);
                    }
                } catch (err) {
                    console.error('[SMTP] Erro ao carregar configura√ß√µes:', err);
                }
            }

            // Salvar configura√ß√£o SMTP
            document.getElementById('save-smtp-config')?.addEventListener('click', async () => {
                const host = document.getElementById('smtp-host')?.value.trim();
                const port = parseInt(document.getElementById('smtp-port')?.value) || 587;
                const email = document.getElementById('smtp-email')?.value.trim();
                const password = document.getElementById('smtp-password')?.value.trim();
                const secure = document.getElementById('smtp-secure')?.checked;
                
                if (!host || !email) {
                    showMessage('admin-error-message', 'Preencha pelo menos o servidor SMTP e o email', true);
                    return;
                }

                // Se a senha estiver vazia, n√£o enviar (manter a atual)
                const dataToSend = { host, port, email, secure };
                if (password) {
                    dataToSend.password = password;
                }

                try {
                    const button = document.getElementById('save-smtp-config');
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = 'Salvando...';

                    const response = await fetch(`${API_BASE}/api/admin/smtp-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify(dataToSend)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage('admin-success-message', result.message || 'Configura√ß√£o SMTP salva com sucesso!');
                        // Recarregar configura√ß√µes para garantir sincroniza√ß√£o
                        setTimeout(() => loadSMTPConfig(), 500);
                    } else {
                        throw new Error(result.message || 'Erro ao salvar configura√ß√£o SMTP');
                    }
                } catch (err) {
                    console.error('[SMTP] Erro ao salvar:', err);
                    showMessage('admin-error-message', err.message || 'Erro ao salvar configura√ß√£o SMTP', true);
                } finally {
                    const button = document.getElementById('save-smtp-config');
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Salvar Configura√ß√£o SMTP';
                    }
                }
            });
            
            // Testar configura√ß√£o SMTP
            document.getElementById('test-smtp-config')?.addEventListener('click', async () => {
                const email = document.getElementById('smtp-email')?.value.trim();
                
                if (!email) {
                    showMessage('admin-error-message', 'Configure o email de envio antes de testar', true);
                    return;
                }

                try {
                    const button = document.getElementById('test-smtp-config');
                    const originalText = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Enviando teste...';

                    const response = await fetch(`${API_BASE}/api/admin/smtp-config/test`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ testEmail: email })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage('admin-success-message', result.message || 'Email de teste enviado com sucesso! Verifique sua caixa de entrada.', false);
                    } else {
                        throw new Error(result.message || 'Erro ao enviar email de teste');
                    }
                } catch (err) {
                    console.error('[SMTP Test] Erro:', err);
                    showMessage('admin-error-message', err.message || 'Erro ao enviar email de teste. Verifique as configura√ß√µes SMTP.', true);
                } finally {
                    const button = document.getElementById('test-smtp-config');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> Enviar Email de Teste';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });
            
            // Carregar configura√ß√µes SMTP quando a aba de configura√ß√µes for aberta
            if (document.getElementById('smtp-host')) {
                loadSMTPConfig();
            }

            // ========== ABA DE ASSINATURAS ==========
            let mrrChart = null;
            let subscribersChart = null;
            let plansDistributionChart = null;
            let churnChart = null;

            // Carregar dados de assinaturas
            let isLoadingSubscriptions = false;
            // Fun√ß√£o para carregar dados de armazenamento
            async function loadAdminStorage() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/storage/stats`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao buscar estat√≠sticas de armazenamento.');
                    const data = await response.json();
                    
                    // Atualizar estat√≠sticas do servidor
                    const totalSpaceGB = (data.serverTotalSpace / (1024 * 1024 * 1024)).toFixed(2);
                    document.getElementById('server-total-space').textContent = `${totalSpaceGB} GB`;
                    
                    const usersStorageGB = (data.totalUsersStorage / (1024 * 1024 * 1024)).toFixed(2);
                    document.getElementById('server-users-storage').textContent = `${usersStorageGB} GB`;
                    
                    const tempStorageMB = (data.tempAudioSize / (1024 * 1024)).toFixed(2);
                    document.getElementById('server-temp-storage').textContent = `${tempStorageMB} MB`;
                    
                    // Preencher tabela de usu√°rios
                    const tableBody = document.getElementById('storage-table-body');
                    if (!tableBody) return;
                    
                    tableBody.innerHTML = '';
                    
                    if (data.users && data.users.length > 0) {
                        data.users.forEach((user) => {
                            const usedMB = (user.storageUsed / (1024 * 1024)).toFixed(2);
                            const limitMB = (user.storageLimit / (1024 * 1024)).toFixed(0);
                            const limitGB = (user.storageLimit / (1024 * 1024 * 1024)).toFixed(1);
                            const percentage = Math.min(user.percentage, 100);
                            
                            let limitDisplay = limitMB;
                            if (user.storageLimit >= 1024 * 1024 * 1024) {
                                limitDisplay = `${limitGB} GB`;
                            } else {
                                limitDisplay = `${limitMB} MB`;
                            }
                            
                            let progressColor = 'bg-indigo-500';
                            if (percentage >= 90) progressColor = 'bg-red-500';
                            else if (percentage >= 70) progressColor = 'bg-yellow-500';
                            
                            const planDisplay = user.plan === 'plan-free' ? 'FREE' :
                                                user.plan === 'plan-start' ? 'START' :
                                                user.plan === 'plan-turbo' ? 'TURBO' :
                                                user.plan === 'plan-master' ? 'MASTER' :
                                                user.plan.includes('annual') ? user.plan.replace('plan-', '').replace('-annual', '').toUpperCase() + ' ANUAL' :
                                                user.plan;
                            
                            tableBody.innerHTML += `
                                <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td class="p-3">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-white">${user.name || user.email}</span>
                                            <span class="text-xs text-gray-400">${user.email}</span>
                                            ${user.isAdmin ? '<span class="text-xs text-red-400 font-semibold">ADMIN</span>' : ''}
                                        </div>
                                    </td>
                                    <td class="p-3">
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-600/50 text-gray-300">
                                            ${planDisplay}
                                        </span>
                                    </td>
                                    <td class="p-3 text-sm text-white">${usedMB} MB</td>
                                    <td class="p-3 text-sm text-gray-300">${limitDisplay}</td>
                                    <td class="p-3">
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div class="${progressColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                                        </div>
                                        <span class="text-xs text-gray-400 mt-1 block">${percentage.toFixed(1)}%</span>
                                    </td>
                                    <td class="p-3">
                                        <div class="flex space-x-2">
                                            <button title="Zerar Armazenamento" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-red-500 btn-storage-reset" data-user-id="${user.userId}" data-user-email="${user.email}">
                                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                            </button>
                                            <button title="Alterar Limite" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-blue-500 btn-storage-limit" data-user-id="${user.userId}" data-user-email="${user.email}" data-current-limit="${user.storageLimit}">
                                                <i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">Nenhum usu√°rio encontrado</td></tr>';
                    }
                    
                    // Adicionar event listeners aos bot√µes
                    document.querySelectorAll('.btn-storage-reset').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const userId = btn.dataset.userId;
                            const userEmail = btn.dataset.userEmail;
                            const confirmed = await showCustomConfirm(`Tem certeza que deseja ZERAR o armazenamento do usu√°rio ${userEmail}? Esta a√ß√£o n√£o pode ser desfeita.`);
                            if (!confirmed) return;
                            
                            try {
                                const response = await fetch(`${API_BASE}/api/admin/storage/reset/${userId}`, {
                                    method: 'PUT',
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.message || 'Erro ao zerar armazenamento');
                                
                                showMessage('admin-success-message', `Armazenamento zerado com sucesso! ${result.deletedFiles} arquivos deletados, ${(result.freedSpace / (1024 * 1024)).toFixed(2)} MB liberados.`);
                                loadAdminStorage();
                            } catch (err) {
                                showMessage('admin-error-message', err.message, true);
                            }
                        });
                    });
                    
                    document.querySelectorAll('.btn-storage-limit').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const userId = btn.dataset.userId;
                            const userEmail = btn.dataset.userEmail;
                            const currentLimit = parseInt(btn.dataset.currentLimit);
                            const currentLimitGB = (currentLimit / (1024 * 1024 * 1024)).toFixed(1);
                            const currentLimitMB = (currentLimit / (1024 * 1024)).toFixed(0);
                            
                            const currentLimitText = currentLimit >= 1024 * 1024 * 1024 ? currentLimitGB + ' GB' : currentLimitMB + ' MB';
                            const newLimit = await showCustomPrompt(
                                `Alterar limite de armazenamento para ${userEmail}\n\nLimite atual: ${currentLimitText}\n\nDigite o novo limite (ex: 500MB, 1GB, 2000MB, etc):`,
                                currentLimit >= 1024 * 1024 * 1024 ? `${currentLimitGB}GB` : `${currentLimitMB}MB`,
                                'Alterar Limite de Armazenamento'
                            );
                            
                            if (!newLimit) return;
                            
                            try {
                                const response = await fetch(`${API_BASE}/api/admin/storage/limit/${userId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Authorization': `Bearer ${userToken}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ storageLimit: newLimit })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.message || 'Erro ao alterar limite');
                                
                                showMessage('admin-success-message', result.message);
                                loadAdminStorage();
                            } catch (err) {
                                showMessage('admin-error-message', err.message, true);
                            }
                        });
                    });
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar armazenamento:', err);
                    const tableBody = document.getElementById('storage-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-400">Erro ao carregar dados: ' + err.message + '</td></tr>';
                    }
                }
            }

            async function loadAdminSubscriptions() {
                if (isLoadingSubscriptions) return; // Prevenir m√∫ltiplas chamadas simult√¢neas
                isLoadingSubscriptions = true;
                
                try {
                    const period = document.getElementById('subscriptions-period-filter')?.value || '30';
                    const status = document.getElementById('subscriptions-status-filter')?.value || 'all';
                    
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions?period=${period}&status=${status}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        updateSubscriptionKPIs(data.kpis);
                        updateSubscriptionCharts(data.charts);
                        updateSubscriptionTable(data.subscriptions);
                        updateSubscriptionInsights(data.insights);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || 'Erro ao carregar dados de assinaturas');
                    }
                } catch (err) {
                    console.error('Erro ao carregar assinaturas:', err);
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    isLoadingSubscriptions = false;
                }
            }

            // Atualizar KPIs
            function updateSubscriptionKPIs(kpis) {
                if (!kpis) return;
                
                // KPIs principais
                const mrrEl = document.getElementById('kpi-mrr');
                const mrrChangeEl = document.getElementById('kpi-mrr-change');
                if (mrrEl) mrrEl.textContent = formatCurrency(kpis.mrr || 0);
                if (mrrChangeEl) mrrChangeEl.innerHTML = formatChange(kpis.mrr_change);
                
                const arrEl = document.getElementById('kpi-arr');
                const arrChangeEl = document.getElementById('kpi-arr-change');
                if (arrEl) arrEl.textContent = formatCurrency(kpis.arr || 0);
                if (arrChangeEl) arrChangeEl.innerHTML = formatChange(kpis.arr_change);
                
                const activeSubsEl = document.getElementById('kpi-active-subscribers');
                const activeSubsChangeEl = document.getElementById('kpi-active-subscribers-change');
                if (activeSubsEl) activeSubsEl.textContent = formatNumber(kpis.active_subscribers || 0);
                if (activeSubsChangeEl) activeSubsChangeEl.innerHTML = formatChange(kpis.active_subscribers_change);
                
                const churnEl = document.getElementById('kpi-churn-rate');
                const churnChangeEl = document.getElementById('kpi-churn-rate-change');
                if (churnEl) churnEl.textContent = `${(kpis.churn_rate || 0).toFixed(2)}%`;
                if (churnChangeEl) churnChangeEl.innerHTML = formatChange(kpis.churn_rate_change);
                
                // KPIs secund√°rios
                document.getElementById('kpi-new-subscribers').textContent = formatNumber(kpis.new_subscribers || 0);
                document.getElementById('kpi-cancellations').textContent = formatNumber(kpis.cancellations || 0);
                document.getElementById('kpi-ltv').textContent = formatCurrency(kpis.ltv || 0);
                document.getElementById('kpi-avg-duration').textContent = `${kpis.avg_duration || 0} dias`;
            }

            // Atualizar gr√°ficos
            function updateSubscriptionCharts(charts) {
                if (!charts) return;
                
                // Gr√°fico MRR
                const mrrCtx = document.getElementById('mrr-chart');
                if (mrrCtx) {
                    if (mrrChart) mrrChart.destroy();
                    mrrChart = new Chart(mrrCtx, {
                        type: 'line',
                        data: {
                            labels: charts.mrr?.labels || [],
                            datasets: [{
                                label: 'MRR',
                                data: charts.mrr?.data || [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: { 
                                        color: '#d1d5db',
                                        font: { size: 12 },
                                        padding: 15
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgb(59, 130, 246)',
                                    borderWidth: 1,
                                    padding: 12
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 11 },
                                        padding: 10,
                                        callback: (value) => 'R$ ' + value.toFixed(2)
                                    }
                                },
                                x: { 
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 10 },
                                        padding: 8,
                                        maxRotation: 0,
                                        minRotation: 0
                                    } 
                                }
                            }
                        }
                    });
                }
                
                // Gr√°fico de Assinantes
                const subscribersCtx = document.getElementById('subscribers-chart');
                if (subscribersCtx) {
                    if (subscribersChart) subscribersChart.destroy();
                    subscribersChart = new Chart(subscribersCtx, {
                        type: 'line',
                        data: {
                            labels: charts.subscribers?.labels || [],
                            datasets: [{
                                label: 'Assinantes Ativos',
                                data: charts.subscribers?.data || [],
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: { 
                                        color: '#d1d5db',
                                        font: { size: 12 },
                                        padding: 15
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgb(16, 185, 129)',
                                    borderWidth: 1,
                                    padding: 12
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 11 },
                                        padding: 10,
                                        stepSize: 1
                                    }
                                },
                                x: { 
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 10 },
                                        padding: 8,
                                        maxRotation: 0,
                                        minRotation: 0
                                    } 
                                }
                            }
                        }
                    });
                }
                
                // Gr√°fico de Distribui√ß√£o por Plano
                const plansCtx = document.getElementById('plans-distribution-chart');
                if (plansCtx) {
                    if (plansDistributionChart) plansDistributionChart.destroy();
                    plansDistributionChart = new Chart(plansCtx, {
                        type: 'doughnut',
                        data: {
                            labels: charts.plans_distribution?.labels || [],
                            datasets: [{
                                data: charts.plans_distribution?.data || [],
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(139, 92, 246, 0.8)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom',
                                    labels: { color: '#d1d5db', padding: 15 }
                                }
                            }
                        }
                    });
                }
                
                // Gr√°fico de Churn
                const churnCtx = document.getElementById('churn-chart');
                if (churnCtx) {
                    if (churnChart) churnChart.destroy();
                    churnChart = new Chart(churnCtx, {
                        type: 'bar',
                        data: {
                            labels: charts.churn?.labels || [],
                            datasets: [{
                                label: 'Churn Rate (%)',
                                data: charts.churn?.data || [],
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderColor: 'rgb(245, 158, 11)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#d1d5db' } }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#9ca3af', callback: (value) => value + '%' }
                                },
                                x: { ticks: { color: '#9ca3af' } }
                            }
                        }
                    });
                }
            }

            // Atualizar tabela de assinaturas
            function updateSubscriptionTable(subscriptions) {
                const tbody = document.getElementById('subscriptions-table-body');
                if (!tbody) return;
                
                if (!subscriptions || subscriptions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-400">Nenhuma assinatura encontrada</td></tr>';
                    return;
                }
                
                tbody.innerHTML = subscriptions.map(sub => {
                    const statusBadge = {
                        'active': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-400">Ativa</span>',
                        'canceled': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-500/20 text-red-400">Cancelada</span>',
                        'past_due': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-500/20 text-yellow-400">Atrasada</span>',
                        'trialing': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-500/20 text-blue-400">Em Teste</span>'
                    }[sub.status] || '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-500/20 text-gray-400">' + sub.status + '</span>';
                    
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                            <td class="p-3 text-sm text-gray-200">${sub.user_email || 'N/A'}</td>
                            <td class="p-3 text-sm text-gray-200">${sub.plan_name || 'N/A'}</td>
                            <td class="p-3">${statusBadge}</td>
                            <td class="p-3 text-sm text-gray-200">${formatCurrency(sub.monthly_amount || 0)}</td>
                            <td class="p-3 text-sm text-gray-200">${formatDate(sub.start_date)}</td>
                            <td class="p-3 text-sm text-gray-200">${formatDate(sub.next_billing_date)}</td>
                            <td class="p-3 text-sm text-gray-200">${sub.duration_days || 0} dias</td>
                            <td class="p-3 text-sm text-gray-200">${formatCurrency(sub.total_paid || 0)}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Atualizar insights
            function updateSubscriptionInsights(insights) {
                const container = document.getElementById('subscriptions-insights');
                if (!container || !insights) return;
                
                container.innerHTML = insights.map(insight => `
                    <div class="p-4 bg-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-900/20 border border-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-700 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i data-lucide="${insight.icon || 'info'}" class="w-5 h-5 text-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-400 mt-0.5"></i>
                            <div>
                                <p class="text-sm font-semibold text-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-300">${insight.title}</p>
                                <p class="text-sm text-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-200 mt-1">${insight.message}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Fun√ß√µes auxiliares
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            }

            function formatChange(change) {
                if (change === null || change === undefined || change === 0) return '<span class="text-gray-400">-</span>';
                const sign = change >= 0 ? '+' : '';
                const color = change >= 0 ? 'text-green-400' : 'text-red-400';
                const icon = change >= 0 ? '‚Üë' : '‚Üì';
                return `<span class="${color} flex items-center gap-1"><span>${icon}</span><span>${sign}${Math.abs(change).toFixed(2)}%</span></span>`;
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString('pt-BR');
            }

            // Event listeners (apenas uma vez, usando flags)
            let subscriptionsListenersAttached = false;
            function attachSubscriptionsListeners() {
                if (subscriptionsListenersAttached) return;
                subscriptionsListenersAttached = true;
                
                const periodFilter = document.getElementById('subscriptions-period-filter');
                const statusFilter = document.getElementById('subscriptions-status-filter');
                const refreshBtn = document.getElementById('refresh-subscriptions');
                const searchInput = document.getElementById('subscriptions-search');
                const exportBtn = document.getElementById('export-subscriptions');
                
                if (periodFilter) {
                    periodFilter.removeEventListener('change', loadAdminSubscriptions);
                    periodFilter.addEventListener('change', loadAdminSubscriptions);
                }
                if (statusFilter) {
                    statusFilter.removeEventListener('change', loadAdminSubscriptions);
                    statusFilter.addEventListener('change', loadAdminSubscriptions);
                }
                if (refreshBtn) {
                    refreshBtn.removeEventListener('click', loadAdminSubscriptions);
                    refreshBtn.addEventListener('click', loadAdminSubscriptions);
                }
                if (searchInput) {
                    searchInput.removeEventListener('input', handleSubscriptionsSearch);
                    searchInput.addEventListener('input', handleSubscriptionsSearch);
                }
                if (exportBtn) {
                    exportBtn.removeEventListener('click', handleExportSubscriptions);
                    exportBtn.addEventListener('click', handleExportSubscriptions);
                }
            }
            
            function handleSubscriptionsSearch(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#subscriptions-table-body tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }
            
            async function handleExportSubscriptions() {
                try {
                    const period = document.getElementById('subscriptions-period-filter')?.value || '30';
                    const status = document.getElementById('subscriptions-status-filter')?.value || 'all';
                    
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions/export?period=${period}&status=${status}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `assinaturas_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Exporta√ß√£o realizada com sucesso');
                    } else {
                        throw new Error('Erro ao exportar');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }

            // Exportar relat√≥rio de receitas
            document.getElementById('export-revenue-report')?.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions/report/revenue`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `relatorio_receitas_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Relat√≥rio de receitas exportado com sucesso');
                    } else {
                        throw new Error('Erro ao exportar relat√≥rio');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Exportar relat√≥rio de assinaturas
            document.getElementById('export-subscriptions-report')?.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions/report/subscriptions`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `relatorio_assinaturas_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Relat√≥rio de assinaturas exportado com sucesso');
                    } else {
                        throw new Error('Erro ao exportar relat√≥rio');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Modal para editar API
            function showEditApiModal(api) {
                // Similar ao showAddApiModal mas preenchendo os campos
                showAddApiModal();
                // Preencher campos com dados da API
                setTimeout(() => {
                    document.getElementById('api-name').value = api.name;
                    document.getElementById('api-provider').value = api.provider;
                    document.getElementById('api-model').value = api.model;
                    document.getElementById('api-key').value = api.api_key;
                    document.getElementById('api-credits-per-unit').value = api.credits_per_unit;
                    document.getElementById('api-unit-size').value = api.unit_size;
                    document.getElementById('api-markup').value = api.markup;
                    document.getElementById('api-is-active').checked = api.is_active === 1;
                    document.getElementById('api-is-default').checked = api.is_default === 1;
                    
                    // Mudar t√≠tulo e a√ß√£o do formul√°rio
                    document.querySelector('#add-api-modal h2').textContent = 'Editar API';
                    const form = document.getElementById('add-api-form');
                    form.removeEventListener('submit', form._submitHandler);
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/api-providers/${api.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({
                                    name: document.getElementById('api-name').value,
                                    provider: document.getElementById('api-provider').value,
                                    model: document.getElementById('api-model').value,
                                    api_key: document.getElementById('api-key').value,
                                    credits_per_unit: parseFloat(document.getElementById('api-credits-per-unit').value),
                                    unit_size: parseInt(document.getElementById('api-unit-size').value),
                                    markup: parseFloat(document.getElementById('api-markup').value),
                                    is_active: document.getElementById('api-is-active').checked ? 1 : 0,
                                    is_default: document.getElementById('api-is-default').checked ? 1 : 0
                                })
                            });
                            
                            if (response.ok) {
                                showMessage('admin-success-message', 'API atualizada com sucesso');
                                document.getElementById('add-api-modal')?.remove();
                                loadAdminApis();
                            } else {
                                throw new Error('Erro ao atualizar API');
                            }
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                        }
                    });
                }, 100);
            }
            
            // Deletar API
            async function deleteApi(apiId) {
                const confirmed = await showCustomConfirm('Tem certeza que deseja excluir esta API?');
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/api-providers/${apiId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        showMessage('admin-success-message', 'API exclu√≠da com sucesso');
                        loadAdminApis();
                    } else {
                        throw new Error('Erro ao excluir API');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }
            
            function setupAdminListeners() {
                const adminUserTableBody = document.getElementById('admin-user-table-body');
                if (adminUserTableBody) {
                    adminUserTableBody.addEventListener('click', (e) => {
                        const button = e.target.closest('.btn-admin-action');
                        if (!button) return;

                        const action = button.dataset.action;
                        const userId = button.dataset.id;
                        const user = JSON.parse(button.dataset.user || '{}');

                        switch (action) {
                            case 'edit':
                                showEditUserModal(user);
                                break;
                            case 'change-password':
                                showChangePasswordModal(user);
                                break;
                            case 'toggle-block':
                                const isBlocked = button.dataset.isBlocked === 'true';
                                toggleUserBlockStatus(userId, !isBlocked);
                                break;
                            case 'change-plan':
                                changeUserPlan(user);
                                break;
                            case 'delete':
                                deleteUser(userId);
                                break;
                        }
                    });
                }
                
                // Fun√ß√£o para alterar plano do usu√°rio
                async function changeUserPlan(user) {
                    const plans = [
                        { value: 'plan-free', label: 'FREE' },
                        { value: 'plan-start', label: 'START CREATOR' },
                        { value: 'plan-turbo', label: 'TURBO MAKER' },
                        { value: 'plan-master', label: 'MASTER PRO' },
                        { value: 'plan-start-annual', label: 'START ANUAL' },
                        { value: 'plan-turbo-annual', label: 'TURBO ANUAL' },
                        { value: 'plan-master-annual', label: 'MASTER ANUAL' }
                    ];
                    
                    const currentPlan = user.subscription_plan || user.plan || 'plan-free';
                    const currentPlanLabel = plans.find(p => p.value === currentPlan)?.label || currentPlan;
                    
                    const planOptions = plans.map(p => 
                        `<option value="${p.value}" ${p.value === currentPlan ? 'selected' : ''}>${p.label}</option>`
                    ).join('');
                    
                    const message = `Alterar plano do usu√°rio ${user.email}\n\nPlano atual: ${currentPlanLabel}\n\nSelecione o novo plano:`;
                    
                    // Criar select tempor√°rio
                    const selectHtml = `
                        <select id="temp-plan-select" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white mt-3">
                            ${planOptions}
                        </select>
                    `;
                    
                    // Usar modal customizado com select
                    const modal = document.getElementById('custom-modal-overlay');
                    const messageEl = document.getElementById('custom-modal-message');
                    const inputEl = document.getElementById('custom-modal-input');
                    const titleEl = document.getElementById('custom-modal-title-text');
                    
                    titleEl.textContent = 'Alterar Plano';
                    messageEl.innerHTML = message + selectHtml;
                    inputEl.style.display = 'none';
                    
                    modal.style.display = 'flex';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    const select = document.getElementById('temp-plan-select');
                    
                    const confirmBtn = document.getElementById('custom-modal-confirm');
                    const cancelBtn = document.getElementById('custom-modal-cancel');
                    const closeBtn = document.getElementById('custom-modal-close');
                    
                    const cleanup = () => {
                        modal.style.display = 'none';
                        messageEl.innerHTML = '';
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        closeBtn.onclick = null;
                    };
                    
                    confirmBtn.onclick = async () => {
                        const newPlan = select.value;
                        if (newPlan === currentPlan) {
                            cleanup();
                            return;
                        }
                        
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/users/${user.id}/plan`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({ plan: newPlan })
                            });
                            
                            const data = await response.json();
                            if (!response.ok) throw new Error(data.message || 'Erro ao alterar plano');
                            
                            showMessage('admin-success-message', `Plano alterado com sucesso para ${plans.find(p => p.value === newPlan)?.label || newPlan}`);
                            loadAdminUsers();
                            cleanup();
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                            cleanup();
                        }
                    };
                    
                    cancelBtn.onclick = cleanup;
                    closeBtn.onclick = cleanup;
                }
                
                // Bot√£o adicionar API
                document.getElementById('btn-add-api')?.addEventListener('click', () => {
                    showAddApiModal();
                });

                document.getElementById('admin-search-input').addEventListener('input', loadAdminUsers);
                document.getElementById('admin-status-filter').addEventListener('change', loadAdminUsers);
                
                // Listeners para aba de armazenamento
                document.getElementById('refresh-storage-stats')?.addEventListener('click', loadAdminStorage);
                document.getElementById('storage-search')?.addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#storage-table-body tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(search) ? '' : 'none';
                    });
                });
                document.getElementById('btn-approve-all').addEventListener('click', async () => {
                    const confirmed = await showCustomConfirm('Tem a certeza que deseja aprovar todos os utilizadores pendentes?');
                    if (!confirmed) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/approve-all`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg);
                        showMessage('admin-success-message', data.msg);
                        loadAdminUsers();
                        loadAdminStats();
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    }
                });
            }


            // --- L√ìGICA DE NAVEGA√á√ÉO SPA ---
            const navLinks = document.querySelectorAll('#main-nav a');
            const views = document.querySelectorAll('main > div[id^="view-"]');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const hamburgerButton = document.getElementById('hamburger-button');

            // Event delegation para links de navega√ß√£o - DEVE SER CONFIGURADO PRIMEIRO
            const mainNav = document.getElementById('main-nav');
            if (mainNav) {
                mainNav.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (!link) return;
                    
                    // Se o link tem data-view, usar navega√ß√£o SPA
                    if (link.hasAttribute('data-view')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const viewName = link.getAttribute('data-view');
                        navigateToView(viewName);
                        return false;
                    }
                    // Se n√£o tem data-view, deixar o link funcionar normalmente (navega√ß√£o externa)
                    // N√£o fazer preventDefault, permitir navega√ß√£o normal
                }, true); // Usar capture phase para garantir que executa primeiro
            }

            // Fun√ß√£o auxiliar para atualizar o dashboard se estiver na tela de in√≠cio
            function refreshDashboardIfVisible() {
                const inicioView = document.getElementById('view-inicio');
                if (inicioView && inicioView.style.display !== 'none') {
                    loadDashboard();
                    loadCreditsBalance();
                }
            }
            
            function navigateToView(viewName, params = {}) {
                if (!viewName) return;

                // Esconder todas as views primeiro
                views.forEach(view => { 
                    if (view) {
                        view.style.display = 'none';
                        // Garantir que n√£o h√° conte√∫do misturado
                        view.classList.remove('active');
                    }
                });
                
                // Mostrar apenas a view ativa
                const activeView = document.getElementById('view-' + viewName);
                if (activeView) {
                    activeView.style.display = 'block';
                    activeView.classList.add('active');
                }

                navLinks.forEach(navLink => {
                    if (navLink) {
                        navLink.classList.remove('bg-amber-600', 'text-black', 'font-bold');
                        navLink.classList.add('text-gray-400', 'hover:bg-gray-800', 'hover:text-white', 'font-medium');
                    }
                });
                const link = document.querySelector(`a[data-view="${viewName}"]`);
                if (link) {
                    link.classList.add('bg-amber-600', 'text-black', 'font-bold');
                    link.classList.remove('text-gray-400', 'hover:bg-gray-800', 'hover:text-white', 'font-medium');
                }
                
                if (window.innerWidth < 768) { 
                    if (sidebar) sidebar.classList.add('-translate-x-full');
                    if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
                }
                
                // Carrega dados espec√≠ficos da view
                if (viewName === 'admin') {
                    loadAdminStats();
                    loadAdminUsers();
                    // Inicializar sistema de abas
                    initAdminTabs();
                }
                
                if (viewName === 'gerador-voz') {
                    // Garantir que apenas o gerador de voz seja exibido
                    const adminView = document.getElementById('view-admin');
                    if (adminView) adminView.style.display = 'none';
                    
                    // Carregar vozes quando acessar o gerador
                    setTimeout(() => {
                        loadTtsVoices();
                        toggleDarkVozControls();
                    }, 100);
                }
                
                if (viewName === 'configuracoes') {
                    // Carregar prefer√™ncias do usu√°rio
                    loadUserPreferences();
                }
                if (viewName === 'gerador-video') {
                    console.log('[Dashboard] ========== NAVEGANDO PARA GERADOR DE V√çDEO ==========');
                    console.log('[Dashboard] View name:', viewName);
                    console.log('[Dashboard] Fun√ß√£o initVideoGenerator existe?', typeof initVideoGenerator);
                    // Aguardar um pouco para garantir que o DOM est√° pronto
                    setTimeout(() => {
                        console.log('[Dashboard] Chamando initVideoGenerator...');
                        if (typeof initVideoGenerator === 'function') {
                            initVideoGenerator();
                        } else {
                            console.error('[Dashboard] ‚ùå initVideoGenerator n√£o √© uma fun√ß√£o!');
                        }
                    }, 300);
                }
                
                if (viewName === 'inicio') {
                    loadDashboard(); // Recarregar dashboard quando voltar para a tela inicial
                    loadCreditsBalance(); // Carregar saldo de cr√©ditos
                    startDashboardAutoRefresh(); // Iniciar atualiza√ß√£o autom√°tica
                } else {
                    stopDashboardAutoRefresh(); // Parar atualiza√ß√£o quando sair da tela de in√≠cio
                }
                if (viewName === 'historico') {
                    loadHistoryNiches();
                    loadFolders().then(() => {
                        if (params.folderId) {
                            const folderName = userFolders.find(f => f.id == params.folderId)?.name || 'Desconhecida';
                            historyTitle.innerText = `Hist√≥rico em: ${folderName}`;
                            clearHistoryFilterBtn.style.display = 'inline';
                            loadHistory(params.folderId, 1, currentHistoryLimit);
                        } else {
                            loadHistory(null, 1, currentHistoryLimit);
                        }
                    });
                }
                if (viewName === 'canais') {
                    loadMonitoredChannels();
                    loadPinnedVideos(null); // null = mostrar todos os canais
                }
                if (viewName === 'gerador-voz') {
                    setTimeout(() => {
                        loadTtsVoices();
                    }, 100);
                }
                if (viewName === 'analisador' || viewName === 'explorar-nicho') {
                    loadFolders();
                }
                if (viewName === 'analytics') {
                    loadAnalytics();
                    loadChannels();
                }
                if (viewName === 'biblioteca') {
                    loadBibliotecaNiches();
                    loadBibliotecaTitles();
                    // Garantir que a tab de agentes est√° dispon√≠vel
                    if (currentBibliotecaTab === 'agents') {
                        loadBibliotecaAgents();
                    }
                }
                if (viewName === 'viral-agents') {
                    loadViralAgents();
                }
                if (viewName === 'youtube-integration') {
                    loadYouTubeIntegrationStatus();
                    loadScheduledPosts();
                    loadMonitoredCompetitors();
                    loadAISuggestions();
                    loadViralAlerts();
                    switchYouTubeTab('channels'); // Definir tab padr√£o
                } else {
                    // Parar atualiza√ß√£o autom√°tica quando sair da view de YouTube
                    if (youtubeChannelsRefreshInterval) {
                        clearInterval(youtubeChannelsRefreshInterval);
                        youtubeChannelsRefreshInterval = null;
                    }
                }
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Fun√ß√£o auxiliar para formatar n√∫meros
            function formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }

            // === FUNCIONALIDADES PARTE 2: AUTOMA√á√ÉO YOUTUBE ===

            // Fun√ß√£o para trocar de tab no YouTube Integration
            window.switchYouTubeTab = function(tabName) {
                document.querySelectorAll('.youtube-tab-content').forEach(content => content.style.display = 'none');
                document.querySelectorAll('.youtube-tab-button').forEach(btn => {
                    btn.classList.remove('border-amber-500', 'text-amber-500');
                    btn.classList.add('border-transparent', 'text-gray-400');
                });
                const content = document.getElementById(`youtube-tab-content-${tabName}`);
                if (content) content.style.display = 'block';
                const button = document.getElementById(`youtube-tab-${tabName}`);
                if (button) {
                    button.classList.add('border-amber-500', 'text-amber-500');
                    button.classList.remove('border-transparent', 'text-gray-400');
                }
                if (tabName === 'competitors') loadMonitoredCompetitors();
                else if (tabName === 'suggestions') {
                    loadAISuggestions();
                    // Garantir que o event listener est√° anexado quando a tab √© aberta
                    setTimeout(() => {
                        if (typeof setupSuggestionsForm === 'function') {
                            setupSuggestionsForm();
                        }
                    }, 100);
                } else if (tabName === 'alerts') loadViralAlerts();
            };

            // A.1 - Agendamento Inteligente
            const suggestTimeForm = document.getElementById('suggest-time-form');
            if (suggestTimeForm) {
                suggestTimeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    showLoadingModal('Analisando melhor hor√°rio para publicar...', 'calendar');
                    
                    try {
                        const token = localStorage.getItem('core_token');
                        const response = await fetch(`${API_BASE}/api/youtube/suggest-best-time`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                niche: document.getElementById('suggest-time-niche').value,
                                subniche: document.getElementById('suggest-time-subniche').value
                            })
                        });
                        if (!response.ok) throw new Error('Falha ao sugerir hor√°rio');
                        const data = await response.json();
                        const resultDiv = document.getElementById('suggested-time-result');
                        if (resultDiv) {
                            document.getElementById('suggested-time').textContent = data.suggestedTime;
                            document.getElementById('suggested-days').textContent = `Melhores dias: ${data.suggestedDays.join(', ')}`;
                            document.getElementById('suggested-explanation').textContent = data.explanation;
                            const altDiv = document.getElementById('alternative-times');
                            if (altDiv && data.alternativeTimes) {
                                altDiv.innerHTML = data.alternativeTimes.map(t => 
                                    `<span class="px-3 py-1 bg-gray-700 text-gray-300 rounded text-sm">${t}</span>`
                                ).join('');
                            }
                            resultDiv.classList.remove('hidden');
                        }
                    } catch (err) {
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            // A.3 - Gerador de Metadata
            const generateMetadataForm = document.getElementById('generate-metadata-form');
            if (generateMetadataForm) {
                console.log('[Metadata Generator] Form encontrado, anexando event listener');
                generateMetadataForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[Metadata Generator] Form submetido');
                    
                    const title = document.getElementById('metadata-title').value;
                    const model = document.getElementById('metadata-model').value;
                    const modelName = model === 'gpt-4o' ? 'GPT-4o' : model === 'claude-3-7-sonnet-20250219' ? 'Claude 3.7 Sonnet' : 'Gemini 2.5 Pro';
                    
                    showLoadingModal(`Gerando metadata com ${modelName}...`, 'wand-2');
                    
                    try {
                        const niche = document.getElementById('metadata-niche').value;
                        const videoDescription = document.getElementById('metadata-description').value;
                        
                        console.log('[Metadata Generator] Dados:', { title, model, niche, videoDescription });
                        
                        if (!title) {
                            hideLoadingModal();
                            throw new Error('T√≠tulo do v√≠deo √© obrigat√≥rio');
                        }
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            hideLoadingModal();
                            throw new Error('Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.');
                        }
                        
                        console.log('[Metadata Generator] Enviando requisi√ß√£o...');
                        const response = await fetch(`${API_BASE}/api/youtube/generate-metadata`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                title: title,
                                model: model,
                                niche: niche,
                                videoDescription: videoDescription
                            })
                        });
                        
                        console.log('[Metadata Generator] Resposta recebida:', response.status, response.ok);
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ msg: 'Falha ao gerar metadata' }));
                            hideLoadingModal();
                            throw new Error(errorData.msg || 'Falha ao gerar metadata');
                        }
                        
                        const data = await response.json();
                        console.log('[Metadata Generator] Dados recebidos:', data);
                        
                        hideLoadingModal();
                        
                        const resultDiv = document.getElementById('generated-metadata-result');
                        if (resultDiv) {
                            const descriptionField = document.getElementById('generated-description');
                            if (descriptionField) {
                                descriptionField.value = data.description || '';
                            }
                            const tagsDiv = document.getElementById('generated-tags');
                            if (tagsDiv && data.tags && Array.isArray(data.tags)) {
                                tagsDiv.innerHTML = data.tags.map(tag => 
                                    `<span class="px-3 py-1 bg-amber-600/20 text-amber-400 rounded text-sm border border-amber-600/30">${tag}</span>`
                                ).join('');
                            }
                            resultDiv.classList.remove('hidden');
                            showMessage('youtube-integration-success-message', `Metadata gerada com sucesso usando ${modelName}!`);
                        } else {
                            console.error('[Metadata Generator] resultDiv n√£o encontrado');
                        }
                    } catch (err) {
                        console.error('[Metadata Generator] Erro:', err);
                        hideLoadingModal();
                        showMessage('youtube-integration-error-message', err.message || 'Erro ao gerar metadata', true);
                    }
                });
            } else {
                console.warn('[Metadata Generator] Form n√£o encontrado!');
            }

            window.copyToClipboard = function(elementId) {
                const el = document.getElementById(elementId);
                if (el) { el.select(); document.execCommand('copy'); showMessage('youtube-integration-success-message', 'Copiado!'); }
            };
            window.copyTagsToClipboard = function() {
                const tags = Array.from(document.querySelectorAll('#generated-tags span')).map(s => s.textContent).join(', ');
                navigator.clipboard.writeText(tags).then(() => showMessage('youtube-integration-success-message', 'Tags copiadas!'));
            };

            // B.2 - An√°lise de Tend√™ncias
            const scanTrendsForm = document.getElementById('scan-trends-form');
            if (scanTrendsForm) {
                scanTrendsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    showLoadingModal('Escanando tend√™ncias no YouTube...', 'search');
                    
                    try {
                        const token = localStorage.getItem('core_token');
                        const response = await fetch(`${API_BASE}/api/youtube/scan-trends`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                niche: document.getElementById('trends-niche').value,
                                subniche: document.getElementById('trends-subniche').value,
                                maxResults: parseInt(document.getElementById('trends-max-results').value || 10),
                                minViews: parseInt(document.getElementById('trends-min-views').value || 0),
                                minViewsPerDay: parseInt(document.getElementById('trends-min-views-per-day').value || 0),
                                language: document.getElementById('trends-language').value || 'pt',
                                orderBy: document.getElementById('trends-order-by').value || 'viewCount',
                                publishedAfter: parseInt(document.getElementById('trends-published-after').value || 7),
                                videoDuration: document.getElementById('trends-duration').value || 'any',
                                videoDefinition: 'any'
                            })
                        });
                        if (!response.ok) {
                            hideLoadingModal();
                            throw new Error('Falha ao escanear tend√™ncias');
                        }
                        const data = await response.json();
                        
                        hideLoadingModal();
                        
                        const resultsDiv = document.getElementById('trends-results');
                        if (resultsDiv) {
                            if (data.trends && data.trends.length > 0) {
                                resultsDiv.innerHTML = data.trends.map(t => {
                                    const isViral = t.isViral !== false; // Assume viral se n√£o especificado
                                    return `
                                    <div class="bg-gray-800 border ${isViral ? 'border-amber-500' : 'border-gray-700'} rounded-lg p-4 hover:bg-gray-750 transition-colors">
                                        <div class="flex items-start space-x-4">
                                            ${t.thumbnailUrl ? `<img src="${t.thumbnailUrl}" alt="${t.title}" class="w-32 h-24 object-cover rounded cursor-pointer" onclick="window.open('${t.url}', '_blank')">` : ''}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <h3 class="text-white font-semibold"><a href="${t.url}" target="_blank" class="hover:text-amber-400">${t.title}</a></h3>
                                                    ${isViral ? '<span class="bg-amber-500 text-black text-xs font-bold px-2 py-1 rounded">VIRAL</span>' : '<span class="bg-gray-600 text-gray-300 text-xs font-semibold px-2 py-1 rounded">RELEVANTE</span>'}
                                                </div>
                                                <p class="text-gray-400 text-sm mb-2">üì∫ ${t.channelName}</p>
                                                <div class="flex flex-wrap gap-4 text-sm">
                                                    <span class="text-gray-300">üëÅÔ∏è ${typeof formatNumber === 'function' ? formatNumber(t.views) : t.views.toLocaleString('pt-BR')} views</span>
                                                    <span class="text-gray-300">üìä ${typeof formatNumber === 'function' ? formatNumber(t.viewsPerDay) : t.viewsPerDay.toLocaleString('pt-BR')} views/dia</span>
                                                    <span class="text-gray-300">üìÖ ${t.daysSince} ${t.daysSince === 1 ? 'dia' : 'dias'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                }).join('');
                            } else {
                                resultsDiv.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhum v√≠deo encontrado para este nicho. Tente ajustar os termos de busca ou aumentar o n√∫mero de resultados.</p>';
                            }
                        }
                        
                        // Mostrar mensagem de sucesso ou informa√ß√£o
                        if (data.msg) {
                            showMessage('youtube-integration-success-message', data.msg);
                        } else if (data.count > 0) {
                            showMessage('youtube-integration-success-message', `${data.count} v√≠deo(s) encontrado(s).`);
                        }
                    } catch (err) {
                        hideLoadingModal();
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            // B.3 - Monitoramento de Competidores
            const monitorCompetitorForm = document.getElementById('monitor-competitor-form');
            if (monitorCompetitorForm) {
                monitorCompetitorForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    showLoadingModal('Adicionando competidor para monitoramento...', 'users');
                    
                    try {
                        const token = localStorage.getItem('core_token');
                        const response = await fetch(`${API_BASE}/api/youtube/monitor-competitor`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                competitorChannelId: document.getElementById('competitor-channel-id').value,
                                competitorChannelName: document.getElementById('competitor-channel-name').value,
                                niche: document.getElementById('competitor-niche').value,
                                autoAnalyze: document.getElementById('competitor-auto-analyze').checked
                            })
                        });
                        if (!response.ok) {
                            hideLoadingModal();
                            throw new Error('Falha ao adicionar competidor');
                        }
                        const data = await response.json();
                        
                        hideLoadingModal();
                        showMessage('youtube-integration-success-message', data.msg);
                        monitorCompetitorForm.reset();
                        loadMonitoredCompetitors();
                    } catch (err) {
                        hideLoadingModal();
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            async function loadMonitoredCompetitors() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/monitored-competitors`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar competidores');
                    const data = await response.json();
                    const listDiv = document.getElementById('monitored-competitors-list');
                    if (listDiv) {
                        if (data.competitors && data.competitors.length > 0) {
                            listDiv.innerHTML = data.competitors.map(c => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-white font-semibold">${c.competitor_channel_name || c.competitor_channel_id}</h3>
                                            <p class="text-gray-400 text-sm">${c.niche || 'Nicho n√£o especificado'}</p>
                                            <p class="text-gray-500 text-xs">Frequ√™ncia: ${c.check_frequency || 'daily'}</p>
                                        </div>
                                        <button onclick="removeCompetitor(${c.id})" class="py-2 px-3 bg-red-600 hover:bg-red-500 text-white rounded text-sm">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            listDiv.innerHTML = '<p class="text-gray-400">Nenhum competidor monitorado.</p>';
                        }
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar competidores:', err);
                }
            }

            window.removeCompetitor = async function(id) {
                if (!confirm('Remover este competidor?')) return;
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/monitor-competitor/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao remover');
                    showMessage('youtube-integration-success-message', 'Competidor removido!');
                    loadMonitoredCompetitors();
                } catch (err) {
                    showMessage('youtube-integration-error-message', err.message, true);
                }
            };

            // B.4 - Sugest√µes Autom√°ticas
            function setupSuggestionsForm() {
                const generateSuggestionsForm = document.getElementById('generate-suggestions-form');
                if (generateSuggestionsForm && !generateSuggestionsForm.hasAttribute('data-listener-attached')) {
                    console.log('[Sugest√µes IA] Form encontrado, anexando event listener');
                    generateSuggestionsForm.setAttribute('data-listener-attached', 'true');
                    generateSuggestionsForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Sugest√µes IA] Form submetido');
                        
                        showLoadingModal('Gerando sugest√µes de v√≠deos com IA...', 'sparkles');
                        
                        try {
                            const niche = document.getElementById('suggestions-niche').value;
                            const subniche = document.getElementById('suggestions-subniche').value;
                            
                            console.log('[Sugest√µes IA] Dados:', { niche, subniche });
                            
                            if (!niche) {
                                hideLoadingModal();
                                throw new Error('Nicho √© obrigat√≥rio para gerar sugest√µes');
                            }
                            
                            const token = localStorage.getItem('core_token');
                            if (!token) {
                                hideLoadingModal();
                                throw new Error('Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.');
                            }
                            
                            console.log('[Sugest√µes IA] Enviando requisi√ß√£o...');
                            const response = await fetch(`${API_BASE}/api/youtube/generate-suggestions`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                                body: JSON.stringify({ 
                                    niche: niche,
                                    subniche: subniche || null
                                })
                            });
                            
                            console.log('[Sugest√µes IA] Resposta recebida:', response.status, response.ok);
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ msg: 'Falha ao gerar sugest√µes' }));
                                hideLoadingModal();
                                throw new Error(errorData.msg || 'Falha ao gerar sugest√µes');
                            }
                            
                            const data = await response.json();
                            console.log('[Sugest√µes IA] Dados recebidos:', data);
                            
                            hideLoadingModal();
                            showMessage('youtube-integration-success-message', data.msg || `${data.count || 0} sugest√£o(√µes) gerada(s).`);
                            loadAISuggestions();
                        } catch (err) {
                            console.error('[Sugest√µes IA] Erro:', err);
                            hideLoadingModal();
                            showMessage('youtube-integration-error-message', err.message || 'Erro ao gerar sugest√µes', true);
                        }
                    });
                } else if (!generateSuggestionsForm) {
                    console.warn('[Sugest√µes IA] Form n√£o encontrado!');
                }
            }
            
            // Configurar o form inicialmente
            setupSuggestionsForm();

            async function loadAISuggestions() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/ai-suggestions?limit=20`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar sugest√µes');
                    const data = await response.json();
                    const listDiv = document.getElementById('ai-suggestions-list');
                    if (listDiv) {
                        if (data.suggestions && data.suggestions.length > 0) {
                            listDiv.innerHTML = data.suggestions.map(s => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h3 class="text-white font-semibold mb-2">${s.title}</h3>
                                            <p class="text-gray-400 text-sm mb-2">${s.description || ''}</p>
                                            <p class="text-gray-500 text-xs mb-2">${s.reason || ''}</p>
                                            <div class="flex items-center space-x-4 text-xs">
                                                <span class="text-amber-400">‚≠ê Prioridade: ${s.priority}/10</span>
                                                <span class="text-gray-500">${s.niche || ''}</span>
                                            </div>
                                        </div>
                                        <button onclick="markSuggestionViewed(${s.id})" class="ml-4 py-2 px-3 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">
                                            <i data-lucide="check" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            listDiv.innerHTML = '<p class="text-gray-400">Nenhuma sugest√£o dispon√≠vel.</p>';
                        }
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar sugest√µes:', err);
                }
            }

            window.markSuggestionViewed = async function(id) {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/ai-suggestions/${id}/viewed`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao marcar');
                    loadAISuggestions();
                } catch (err) {
                    showMessage('youtube-integration-error-message', err.message, true);
                }
            };

            // B.1 - Alertas Virais
            async function loadViralAlerts() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/viral-alerts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar alertas');
                    const data = await response.json();
                    const listDiv = document.getElementById('viral-alerts-list');
                    if (listDiv) {
                        if (data.alerts && data.alerts.length > 0) {
                            listDiv.innerHTML = data.alerts.map(a => `
                                <div class="bg-gray-800 border border-amber-600/30 rounded-lg p-4">
                                    <h3 class="text-white font-semibold mb-2">
                                        <a href="${a.video_url || '#'}" target="_blank" class="hover:text-amber-400">${a.video_title || 'V√≠deo Viral'}</a>
                                    </h3>
                                    <p class="text-gray-400 text-sm mb-2">Canal: ${a.competitor_channel_name || a.competitor_channel_id}</p>
                                    <div class="flex flex-wrap gap-4 text-sm">
                                        <span class="text-gray-300">üëÅÔ∏è ${formatNumber(a.views || 0)} views</span>
                                        <span class="text-gray-300">üìä ${formatNumber(a.views_per_day || 0)} views/dia</span>
                                    </div>
                                    <p class="text-gray-500 text-xs mt-2">${new Date(a.detected_at).toLocaleString('pt-BR')}</p>
                                </div>
                            `).join('');
                        } else {
                            listDiv.innerHTML = '<p class="text-gray-400">Nenhum alerta viral no momento.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar alertas:', err);
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.getAttribute('data-view');
                    navigateToView(viewName);
                });
            });

            if (hamburgerButton) {
                hamburgerButton.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.remove('-translate-x-full');
                    if (sidebarOverlay) sidebarOverlay.classList.remove('hidden');
                });
            }
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.add('-translate-x-full');
                    if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
                });
            }

            // --- L√≥gica de Download ---
            function downloadThumbnail(url, title) {
                fetch(url)
                    .then(response => response.blob())
                    .then(blob => {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `thumbnail_${title.replace(/[^a-z0-9]/gi, '_')}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    })
                    .catch(err => {
                        console.error("Erro ao baixar thumbnail:", err);
                        alert("Falha ao baixar thumbnail.");
                    });
            }
            
            function downloadBase64Image(base64Data, title) {
                const link = document.createElement('a');
                link.href = base64Data;
                link.download = `generated_thumb_${title.replace(/[^a-z0-9]/gi, '_')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }


            // --- L√ìGICA DO ANALISADOR DE V√çDEOS ---
            const analisadorForm = document.getElementById('analisador-form');
            const loadingSpinner = document.getElementById('analisador-loading');
            const resultadosDiv = document.getElementById('analisador-resultados');
            const analisarButton = document.getElementById('analisar-button');
            const errorBox = document.getElementById('analisador-error'); 
            const folderSelect = document.getElementById('folder-select');
            
            const thumbGeneratorDiv = document.getElementById('thumbnail-generator');
            const thumbTitleSelect = document.getElementById('thumb-title-select');
            const thumbModelSelect = document.getElementById('thumb-model-select');
            const thumbLanguageSelect = document.getElementById('thumb-language');
            const thumbPhrasesSelect = document.getElementById('thumb-phrases');
            const thumbStyleSelect = document.getElementById('thumb-style');
            const btnGenerateThumbs = document.getElementById('btn-generate-thumbs');
            const btnGenerateMoreThumbs = document.getElementById('btn-generate-more-thumbs');

            const thumbLoadingSpinner = document.getElementById('thumbnail-ideas-loading');
            const thumbResultadosDiv = document.getElementById('thumbnail-ideas-results');
            

            async function handleTitleAnalysis(event) {
                if (event) event.preventDefault();
                
                const videoUrl = document.getElementById('video-url').value;
                const model = document.getElementById('model-select').value;
                const folderId = folderSelect.value;
                
                if (loadingSpinner) loadingSpinner.style.display = 'flex';
                if (resultadosDiv) {
                    resultadosDiv.style.display = 'none';
                    resultadosDiv.innerHTML = '';
                }
                if (thumbGeneratorDiv) thumbGeneratorDiv.style.display = 'none';
                if (thumbResultadosDiv) {
                    thumbResultadosDiv.style.display = 'none';
                    thumbResultadosDiv.innerHTML = '';
                }
                if (errorBox) errorBox.style.display = 'none'; 
                setButtonLoading(analisarButton, true);
                
                currentAnalysisData = {};

                try {
                    console.log('Iniciando an√°lise...', { API_BASE, videoUrl, model, folderId });
                    
                    // Extrair videoId ANTES de qualquer requisi√ß√£o
                    let videoId;
                    try {
                        videoId = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)?.[1];
                        if (!videoId) {
                            throw new Error('URL do YouTube inv√°lida. Use o formato: https://www.youtube.com/watch?v=...');
                        }
                        console.log('[Title Analysis] VideoId extra√≠do:', videoId);
                    } catch (err) {
                        throw new Error('N√£o foi poss√≠vel extrair o ID do v√≠deo da URL fornecida.');
                    }
                    
                    // Verificar se laozhang.ai est√° configurada como padr√£o
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Title Analysis] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                    }
                    
                    // Usar rota /laozhang se configurada como padr√£o
                    const endpoint = useLaozhang ? '/api/analyze/titles/laozhang' : '/api/analyze/titles';
                    console.log(`[Title Analysis] Usando endpoint: ${endpoint} (laozhang: ${useLaozhang})`);
                    
                    // Se model === 'all', fazer 3 requisi√ß√µes paralelas (Comparar Multimodal)
                    if (model === 'all') {
                        console.log('[Title Analysis] Modo Compara√ß√£o Multimodal ativado - fazendo 3 requisi√ß√µes paralelas');
                        
                        const models = ['gpt-4o', 'claude-3-7-sonnet-20250219', 'gemini-2.5-pro'];
                        const modelNames = {
                            'gpt-4o': 'GPT-4o',
                            'claude-3-7-sonnet-20250219': 'Claude 3.7 Sonnet',
                            'gemini-2.5-pro': 'Gemini 2.5 Pro'
                        };
                        
                        // Fazer 3 requisi√ß√µes em paralelo
                        const promises = models.map(async (modelKey) => {
                            try {
                                console.log(`[Compara√ß√£o] Iniciando requisi√ß√£o para: ${modelNames[modelKey]}`);
                                // Se usar laozhang, enviar o modelo espec√≠fico para que ele use o modelo correto
                                const requestBody = useLaozhang 
                                    ? { videoUrl, model: modelKey, folderId: folderId || null }
                                    : { videoUrl, model: modelKey, folderId: folderId || null };
                                    
                                const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}` 
                        },
                        body: JSON.stringify(requestBody)
                                });
                                
                                const text = await response.text();
                                console.log(`[Compara√ß√£o] Resposta de ${modelNames[modelKey]} - Status: ${response.status}, Length: ${text.length}`);
                                
                                if (!text || text.trim() === '') {
                                    throw new Error(`Resposta vazia para ${modelNames[modelKey]}`);
                                }
                                
                                const contentType = response.headers.get('content-type');
                                let data;
                                
                                if (contentType && contentType.includes('application/json')) {
                                    data = JSON.parse(text);
                                } else {
                                    throw new Error(`Resposta n√£o √© JSON para ${modelNames[modelKey]}`);
                                }
                                
                                if (!response.ok) {
                                    throw new Error(data.msg || `Erro ${response.status} para ${modelNames[modelKey]}`);
                                }
                                
                                console.log(`[Compara√ß√£o] Dados de ${modelNames[modelKey]}:`, {
                                    niche: data.niche,
                                    subniche: data.subniche,
                                    titulosCount: data.titulosSugeridos?.length || 0
                                });
                                
                                return {
                                    model: modelKey,
                                    modelName: modelNames[modelKey],
                                    data: data,
                                    success: true
                                };
                            } catch (error) {
                                console.error(`[Title Analysis] Erro no modelo ${modelNames[modelKey]}:`, error);
                                return {
                                    model: modelKey,
                                    modelName: modelNames[modelKey],
                                    error: error.message,
                                    success: false
                                };
                            }
                        });
                        
                        // Aguardar todas as 3 requisi√ß√µes
                        const results = await Promise.all(promises);
                        
                        // Pegar o primeiro resultado com sucesso para usar como base
                        const firstSuccess = results.find(r => r.success);
                        
                        if (!firstSuccess) {
                            throw new Error('Todos os modelos falharam. Verifique suas configura√ß√µes de API.');
                        }
                        
                        // Usar os dados do primeiro modelo com sucesso para a interface principal
                        const mainData = firstSuccess.data;
                        
                        // Combinar todos os t√≠tulos dos 3 modelos
                        const allTitles = [];
                        results.forEach(result => {
                            if (result.success && result.data.titulosSugeridos) {
                                result.data.titulosSugeridos.forEach(titulo => {
                                    allTitles.push({
                                        ...titulo,
                                        model: result.modelName // Adicionar o nome do modelo
                                    });
                                });
                            }
                        });
                        
                        // Criar objeto de dados combinado
                        const combinedData = {
                            ...mainData,
                            titulosSugeridos: allTitles, // Todos os t√≠tulos dos 3 modelos
                            modelUsed: 'Compara√ß√£o (3 modelos)'
                        };
                        
                        currentAnalysisData = {
                            videoId: videoId,
                            niche: mainData.niche,
                            subniche: mainData.subniche,
                            model: 'Compara√ß√£o (3 modelos)',
                            generatedTitles: allTitles,
                            videoDetails: mainData.videoDetails
                        };
                        
                        // Renderizar interface completa normal (mesma de sempre)
                        populateAnalysisResults(combinedData, videoUrl);
                        
                        if (combinedData.folderId) {
                            const folderName = userFolders.find(f => f.id == combinedData.folderId)?.name || 'pasta selecionada';
                            showMessage('analisador-success-message', `An√°lise salva com sucesso na pasta: <strong>${folderName}</strong>`);
                        }
                        
                        // Atualizar dashboard se estiver vis√≠vel
                        refreshDashboardIfVisible();
                        
                        if (mainData.folderId) {
                            const folderName = userFolders.find(f => f.id == mainData.folderId)?.name || 'pasta selecionada';
                            showMessage('analisador-success-message', `An√°lise comparativa salva com sucesso na pasta: <strong>${folderName}</strong>`);
                        }
                        
                        // Atualizar dashboard se estiver vis√≠vel
                        refreshDashboardIfVisible();
                        
                    } else {
                        // Fluxo normal para um √∫nico modelo
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}` 
                            },
                            body: JSON.stringify({ 
                                videoUrl, 
                                model: useLaozhang ? null : model, // N√£o enviar model se usar laozhang
                            folderId: folderId || null
                        }) 
                    });
                    
                    // Ler o texto da resposta uma √∫nica vez
                    const text = await response.text();
                    console.log('Resposta recebida:', { status: response.status, ok: response.ok, textLength: text.length });
                    
                    // Verificar se h√° conte√∫do
                    if (!text || text.trim() === '') {
                        throw new Error('O servidor retornou uma resposta vazia. Verifique se o servidor est√° funcionando corretamente.');
                    }
                    
                    // Verificar se a resposta √© JSON antes de tentar parsear
                    const contentType = response.headers.get('content-type');
                    let data;
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            data = JSON.parse(text);
                        } catch (parseError) {
                            console.error('Erro ao parsear JSON:', parseError, 'Texto recebido:', text.substring(0, 500));
                            throw new Error('Erro ao processar resposta do servidor. Verifique se o servidor est√° funcionando corretamente.');
                        }
                    } else {
                        throw new Error(`Erro no servidor: ${text.substring(0, 200)}`);
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.msg || 'Erro desconhecido no servidor.');
                    }
                    
                    // Verificar se os dados est√£o completos antes de processar
                    if (!data.videoDetails) {
                        throw new Error('Resposta do servidor incompleta: videoDetails n√£o encontrado.');
                    }
                    
                    // Garantir que as propriedades de receita existem
                    if (typeof data.videoDetails.estimatedRevenueUSD === 'undefined') {
                        console.warn('[Frontend] estimatedRevenueUSD n√£o encontrado, usando valor padr√£o');
                        data.videoDetails.estimatedRevenueUSD = 0;
                    }
                    if (typeof data.videoDetails.estimatedRevenueBRL === 'undefined') {
                        data.videoDetails.estimatedRevenueBRL = 0;
                    }
                    if (typeof data.videoDetails.rpmUSD === 'undefined') {
                        data.videoDetails.rpmUSD = 2.0;
                    }
                    if (typeof data.videoDetails.rpmBRL === 'undefined') {
                        data.videoDetails.rpmBRL = 11.0;
                    }
                    
                    console.log('[Frontend] Dados recebidos:', {
                        hasVideoDetails: !!data.videoDetails,
                        hasEstimatedRevenueUSD: typeof data.videoDetails.estimatedRevenueUSD !== 'undefined',
                        estimatedRevenueUSD: data.videoDetails.estimatedRevenueUSD,
                        hasTitulos: !!data.titulosSugeridos,
                        titulosCount: data.titulosSugeridos?.length || 0
                    });
                    
                    currentAnalysisData = {
                        videoId: data.videoDetails.videoId,
                        niche: data.niche,
                        subniche: data.subniche,
                        model: model, 
                        generatedTitles: data.titulosSugeridos
                    };

                    populateAnalysisResults(data, videoUrl);

                    if (data.folderId) {
                        const folderName = userFolders.find(f => f.id == data.folderId)?.name || 'pasta selecionada';
                        showMessage('analisador-success-message', `An√°lise salva com sucesso na pasta: <strong>${folderName}</strong>`);
                    }
                    
                    // Atualizar dashboard se estiver vis√≠vel
                    refreshDashboardIfVisible();
                    }

                } catch (error) {
                    console.error('Erro ao analisar v√≠deo:', error);
                    
                    let errorMessage = 'Erro desconhecido ao analisar o v√≠deo.';
                    
                    // Tratar diferentes tipos de erro
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.name === 'TypeError') {
                        errorMessage = 'N√£o foi poss√≠vel conectar ao servidor. Verifique se o servidor est√° rodando na porta 5001. Abra o terminal e execute: cd Backend && node server.js';
                    } else if (error.message.includes('inv√°lido') || error.message.includes('expirado') || error.message.includes('configurada')) {
                        errorMessage = error.message;
                        setTimeout(() => navigateToView('configuracoes'), 2000);
                    } else if (error.message.includes('Resource exhausted') || error.message.includes('429')) {
                        errorMessage = 'Limite de requisi√ß√µes atingido para a API. Aguarde alguns minutos ou use outro modelo de IA (Claude ou OpenAI).';
                    } else if (error.message.includes('401') || error.message.includes('403')) {
                        errorMessage = 'Erro de autentica√ß√£o. Fa√ßa login novamente.';
                        setTimeout(() => {
                            localStorage.removeItem('core_token');
                            window.location.href = 'la-casa-dark-core-auth.html';
                        }, 2000);
                    } else {
                        errorMessage = `Falha na an√°lise: ${error.message}`;
                    }
                    
                    if (errorBox) {
                        errorBox.innerText = errorMessage;
                        errorBox.style.display = 'block';
                    }
                } finally {
                    if (loadingSpinner) loadingSpinner.style.display = 'none';
                    setButtonLoading(analisarButton, false);
                }
            }
            
            function populateAnalysisResults(data, videoUrl) {
                try {
                    if (!resultadosDiv) {
                        console.error('[Frontend] resultadosDiv n√£o encontrado');
                        return;
                    }
                    
                    if (!data || !data.videoDetails) {
                        throw new Error('Dados incompletos: videoDetails n√£o encontrado');
                    }
                    
                    resultadosDiv.style.display = 'block';
                    
                    document.getElementById('video-url').value = videoUrl || data.originalVideoUrl || '';
                    
                    // Garantir que todas as propriedades existem antes de usar
                    const videoDetails = data.videoDetails || {};
                    const views = videoDetails.views || 0;
                    const comments = videoDetails.comments || 0;
                    const days = videoDetails.days || 0;
                    const title = videoDetails.title || 'Sem t√≠tulo';
                    const thumbnailUrl = videoDetails.thumbnailUrl || '';
                    const translatedTitle = videoDetails.translatedTitle || '';
                    
                    // Extrair valores de receita e RPM de forma segura
                    const revenueUSD = videoDetails.estimatedRevenueUSD || 0;
                    const revenueBRL = videoDetails.estimatedRevenueBRL || 0;
                    const rpmUSD = videoDetails.rpmUSD || 0;
                    const rpmBRL = videoDetails.rpmBRL || 0;
                    
                    const viewsFormatted = new Intl.NumberFormat('pt-BR').format(views);
                    const commentsFormatted = new Intl.NumberFormat('pt-BR').format(comments);
                    
                    let videoSummaryHtml = `
                        <div class="flex flex-col md:flex-row items-start space-y-4 md:space-y-0 md:space-x-6 mb-6 bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <img src="${thumbnailUrl}" alt="Thumbnail do v√≠deo" class="w-full md:w-48 rounded-lg object-cover">
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-white mb-2">${title}</h3>
                                ${translatedTitle ? `
                                <p class="text-base text-gray-400 mb-3 italic">${translatedTitle}</p>
                                ` : ''}
                                <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-300">
                                    <span class="flex items-center space-x-1.5">
                                        <i data-lucide="eye" class="w-4 h-4 text-amber-500"></i>
                                        <span>${viewsFormatted} views</span>
                                    </span>
                                    <span class="flex items-center space-x-1.5">
                                        <i data-lucide="calendar-days" class="w-4 h-4 text-amber-500"></i>
                                        <span>${days} dias</span>
                                    </span>
                                    <span class="flex items-center space-x-1.5">
                                        <i data-lucide="message-square" class="w-4 h-4 text-amber-500"></i>
                                        <span>${commentsFormatted} coment√°rios</span>
                                    </span>
                                </div>
                                <div class="bg-gray-900/50 p-3 rounded-lg mb-3 border border-gray-700">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                        <div>
                                            <span class="text-gray-400 block mb-1">Receita Estimada:</span>
                                            ${revenueUSD > 0 ? `<span class="text-yellow-400 font-semibold">$${Math.round(revenueUSD)}</span>` : '<span class="text-gray-500">N/A</span>'}
                                            ${revenueBRL > 0 ? `<span class="text-yellow-300 block">R$ ${Math.round(revenueBRL)}</span>` : ''}
                                        </div>
                                        <div>
                                            <span class="text-gray-400 block mb-1">RPM (por 1K views):</span>
                                            ${rpmUSD > 0 ? `<span class="text-green-400 font-semibold">$${rpmUSD.toFixed(2)}</span>` : '<span class="text-gray-500">N/A</span>'}
                                            ${rpmBRL > 0 ? `<span class="text-green-300 block">R$ ${rpmBRL.toFixed(2)}</span>` : ''}
                                        </div>
                                    </div>
                                    ${data.niche ? `<p class="text-gray-500 text-xs mt-2">* Valores baseados no nicho "${data.niche}"</p>` : ''}
                                </div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button id="btn-download-thumb" data-url="${thumbnailUrl}" data-title="${title}" class="py-1 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white text-xs">
                                        <i data-lucide="download" class="w-4 h-4 mr-1.5"></i>
                                        Baixar Thumbnail Original
                                    </button>
                                    <button id="btn-load-transcript" class="py-1 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black text-xs">
                                        <i data-lucide="file-text" class="w-4 h-4 mr-1.5"></i>
                                        Carregar Transcri√ß√£o
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    let nicheHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="niche-tag flex justify-between items-center">
                                <div>
                                    <strong>Nicho Detetado</strong>
                                    <span id="detected-niche">${data.niche || 'N/A'}</span>
                                </div>
                                <button title="Copiar Nicho" class="btn-copy p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${data.niche || ''}">
                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                            <div class="niche-tag flex justify-between items-center">
                                <div>
                                    <strong>Subnicho Detetado</strong>
                                    <span id="detected-subniche">${data.subniche || 'N/A'}</span>
                                </div>
                                <button title="Copiar Subnicho" class="btn-copy p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${data.subniche || ''}">
                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-6">
                            <h4 class="text-lg font-semibold text-white mb-2">An√°lise do T√≠tulo Original</h4>
                            <p class="text-sm text-gray-300 mb-2">
                                <strong>Motivo do Sucesso:</strong> ${data.analiseOriginal.motivoSucesso || 'N/A'}
                            </p>
                            <p class="text-sm text-gray-300">
                                <strong>F√≥rmula:</strong> <code class="text-amber-400">${data.analiseOriginal.formulaTitulo || 'N/A'}</code>
                            </p>
                        </div>

                        <!-- Se√ß√£o de Transcri√ß√£o e Agente de Roteiro -->
                        <div id="transcript-section" class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-6">
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                                    <h4 class="text-lg font-semibold text-white">üìù Transcri√ß√£o Completa do V√≠deo</h4>
                                    <span class="text-xs text-gray-400">Cole o roteiro manualmente ou clique em "Carregar Transcri√ß√£o"</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Assim que o campo estiver preenchido, o bot√£o "Criar Agente de Roteiro" ser√° liberado automaticamente.</p>
                            </div>
                            <div id="transcript-container">
                                <textarea id="full-transcript-text" class="w-full h-64 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 text-sm resize-none" placeholder="Cole aqui a transcri√ß√£o completa do v√≠deo ou aguarde o carregamento autom√°tico."></textarea>
                                <p class="text-xs text-gray-500 mt-2">Voc√™ pode colar manualmente o roteiro completo, colar direto da √°rea de transfer√™ncia ou utilizar o bot√£o de transcri√ß√£o autom√°tica ap√≥s analisar o v√≠deo.</p>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    <button id="btn-paste-transcript" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="clipboard-paste" class="w-4 h-4"></i>
                                        <span>Colar do Clipboard</span>
                                    </button>
                                    <button id="btn-copy-transcript" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                        <span>Copiar Transcri√ß√£o</span>
                                    </button>
                                    <button id="btn-clear-transcript" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="eraser" class="w-4 h-4"></i>
                                        <span>Limpar Campo</span>
                                    </button>
                                    <button id="btn-analyze-transcript" class="py-2 px-4 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                                        <span>Analisar F√≥rmula Viral</span>
                                    </button>
                                    <button id="btn-create-agent" class="py-2 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-semibold text-sm flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                                        <span>Criar Agente de Roteiro</span>
                                    </button>
                                </div>
                                <div id="transcript-insights-panel" class="mt-5 bg-gray-900/60 border border-gray-800 rounded-lg p-4">
                                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                                        <div>
                                            <h5 class="text-base font-semibold text-white">F√≥rmula de Sucesso Detectada</h5>
                                    <p id="transcript-insights-status" class="text-xs text-gray-400">1) Cole ou carregue o roteiro. 2) Clique em ‚ÄúAnalisar F√≥rmula Viral‚Äù.</p>
                                        </div>
                                    </div>
                                    <div id="transcript-insights-loading" class="hidden text-sm text-amber-400 mt-3">
                                        <div class="flex items-center space-x-2">
                                            <div class="loader w-4 h-4 border-2 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
                                            <span>A IA est√° estudando o roteiro completo...</span>
                                        </div>
                                    </div>
                                    <div id="transcript-insights-error" class="hidden text-sm text-red-400 mt-3"></div>
                                    <div id="transcript-insights-content" class="hidden mt-4 space-y-4 text-sm text-gray-100"></div>
                                </div>
                            </div>
                            <div id="transcript-loading" class="text-center py-4 hidden">
                                <p class="text-amber-400 text-sm mb-3 font-semibold">Transcrevendo v√≠deo em tempo real...</p>
                                <div class="w-full bg-gray-800/70 h-3 rounded-full overflow-hidden">
                                    <div id="transcript-progress-bar" class="bg-amber-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="transcript-progress-text" class="text-xs text-gray-400 mt-2">Preparando download do √°udio...</p>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">T√≠tulos Gerados ${data.modelUsed && data.modelUsed.includes('Compara√ß√£o') ? '<span class="text-amber-400">(Compara√ß√£o Multimodal - 3 Modelos)</span>' : `(Modelo: ${formatModelNameForDisplay(data.modelUsed)})`}</h3>
                            <button type="button" id="btn-generate-more-titles" class="py-1 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white text-xs">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-1.5"></i>
                                <span>Gerar Mais T√≠tulos</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </div>
                    `;
                    
                    let titlesHtml = '<ul id="generated-titles-list" class="space-y-4">';
                    thumbTitleSelect.innerHTML = '';
                    
                    data.titulosSugeridos.forEach((titleObj, index) => {
                        let scoreColor = 'bg-gray-600 text-gray-200';
                        if (titleObj.pontuacao >= 8) scoreColor = 'bg-green-600 text-green-100';
                        else if (titleObj.pontuacao >= 5) scoreColor = 'bg-yellow-600 text-yellow-100';
                        else if (titleObj.pontuacao > 0) scoreColor = 'bg-red-600 text-red-100';
                        
                        const escapedTitle = titleObj.titulo.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                        const isCheckedClass = titleObj.is_checked ? 'opacity-60' : '';
                        const isCheckedLabelClass = titleObj.is_checked ? 'line-through' : '';

                        titlesHtml += `
                            <li class="bg-gray-800 p-4 rounded-lg border border-gray-700 transition-opacity ${isCheckedClass}">
                                <div class="flex items-center space-x-3 flex-1">
                                    <input type="checkbox" id="check-${index}" class="title-checkbox form-checkbox h-5 w-5 bg-gray-700 border-gray-600 rounded text-amber-600 focus:ring-amber-500" data-title-id="${titleObj.id}" ${titleObj.is_checked ? 'checked' : ''}>
                                    <label for="check-${index}" class="text-gray-100 font-medium transition-all ${isCheckedLabelClass}">
                                        ${titleObj.model ? `<span class="text-amber-500 font-semibold text-xs px-2 py-0.5 bg-amber-500/20 rounded border border-amber-500/30">${titleObj.model}</span> ` : ''}${titleObj.titulo}
                                    </label>
                                </div>
                                <div class="flex items-center justify-between mt-2 pl-8">
                                    <p class="text-sm text-gray-400 flex-1">
                                        ${titleObj.explicacao || ''}
                                    </p>
                                    <div class="flex items-center ml-4">
                                        ${titleObj.pontuacao > 0 ? `<span class="text-xs font-bold px-2 py-0.5 rounded-full whitespace-nowrap ${scoreColor}">${titleObj.pontuacao}/10</span>` : ''}
                                        <button title="Copiar T√≠tulo" class="btn-copy p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${escapedTitle}">
                                            <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                    </div>
                                </div>
                            </li>
                        `;
                        
                        const option = document.createElement('option');
                        option.value = escapedTitle;
                        option.innerText = escapedTitle;
                        if (titleObj.is_checked) {
                            option.selected = true;
                        }
                        thumbTitleSelect.appendChild(option);
                    });
                    titlesHtml += '</ul>';
                    
                    resultadosDiv.innerHTML = videoSummaryHtml + nicheHtml + titlesHtml;
                    resultadosDiv.style.display = 'block'; // Garantir que est√° vis√≠vel
                    
                    // Debug: verificar se a se√ß√£o de transcri√ß√£o est√° no HTML
                    console.log('[DEBUG] Se√ß√£o de transcri√ß√£o no HTML:', resultadosDiv.innerHTML.includes('Transcri√ß√£o Completa'));
                    console.log('[DEBUG] Video ID:', data.videoDetails.videoId);
                    console.log('[DEBUG] Tamanho do HTML gerado:', resultadosDiv.innerHTML.length);
                    console.log('[DEBUG] HTML cont√©m "btn-load-transcript":', resultadosDiv.innerHTML.includes('btn-load-transcript'));
                    
                    // Verificar se a se√ß√£o de transcri√ß√£o est√° vis√≠vel no DOM
                    setTimeout(() => {
                        const transcriptSection = resultadosDiv.querySelector('[id*="transcript"]') || resultadosDiv.querySelector('button[id="btn-load-transcript"]');
                        console.log('[DEBUG] Se√ß√£o de transcri√ß√£o encontrada no DOM:', !!transcriptSection);
                        if (!transcriptSection) {
                            console.error('[ERRO] Se√ß√£o de transcri√ß√£o N√ÉO encontrada no DOM ap√≥s renderiza√ß√£o!');
                            console.log('[DEBUG] Primeiros 2000 caracteres do HTML:', resultadosDiv.innerHTML.substring(0, 2000));
                        }
                    }, 200);
                    
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }

                    // Inicializar funcionalidades de transcri√ß√£o e agente de roteiro
                    // Aguardar um pouco para garantir que o DOM foi atualizado
                    setTimeout(() => {
                        initializeTranscriptAndAgentFeatures(data.videoDetails.videoId, data.videoDetails.title, data.videoDetails.translatedTitle || data.videoDetails.title, data.niche, data.subniche);
                    }, 100);

                    const downloadBtn = document.getElementById('btn-download-thumb');
                    if (downloadBtn) {
                        downloadBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const url = e.currentTarget.getAttribute('data-url');
                            const title = e.currentTarget.getAttribute('data-title');
                            downloadThumbnail(url, title);
                        });
                    }

                    // O bot√£o de transcri√ß√£o agora √© configurado dentro de initializeTranscriptAndAgentFeatures
                    
                    const btnMoreTitles = document.getElementById('btn-generate-more-titles');
                    if (btnMoreTitles) {
                        btnMoreTitles.addEventListener('click', handleTitleAnalysis);
                    }
                    
                    // Inicializar o modelo de IA com o modelo usado na an√°lise (mas permitir mudan√ßa)
                    if (thumbModelSelect && data.modelUsed) {
                        // Tentar encontrar o modelo correspondente no dropdown
                        const modelValue = data.modelUsed;
                        // Se o modelo usado for "Compara√ß√£o", usar modelo padr√£o
                        if (modelValue.includes('Compara√ß√£o') || modelValue === 'all') {
                            thumbModelSelect.value = 'claude-3-7-sonnet-20250219';
                        } else {
                            // Tentar encontrar o modelo exato ou usar o primeiro dispon√≠vel
                            const option = Array.from(thumbModelSelect.options).find(opt => 
                                opt.value === modelValue || 
                                modelValue.includes(opt.value.split('-')[0]) // Ex: "gemini" em "gemini-2.0-flash"
                            );
                            if (option) {
                                thumbModelSelect.value = option.value;
                            }
                        }
                    }
                    
                    if (thumbGeneratorDiv) thumbGeneratorDiv.style.display = 'block';
                } catch (renderError) {
                    console.error('[Frontend] Erro ao renderizar resultados:', renderError);
                    if (errorBox) {
                        errorBox.innerText = `Erro ao exibir resultados: ${renderError.message}. Verifique o console para mais detalhes.`;
                        errorBox.style.display = 'block';
                    }
                    throw renderError; // Re-lan√ßar para ser capturado pelo catch externo
                }
            }

            // Fun√ß√£o para inicializar funcionalidades de transcri√ß√£o e agente de roteiro
            function initializeTranscriptAndAgentFeatures(videoId, videoTitle, translatedTitle, niche, subniche) {
                console.log('[DEBUG] Inicializando funcionalidades de transcri√ß√£o para videoId:', videoId);
                
                const btnLoadTranscript = document.getElementById('btn-load-transcript');
                const btnCopyTranscript = document.getElementById('btn-copy-transcript');
                const btnCreateAgent = document.getElementById('btn-create-agent');
                const btnAnalyzeTranscript = document.getElementById('btn-analyze-transcript');
                const btnPasteTranscript = document.getElementById('btn-paste-transcript');
                const btnClearTranscript = document.getElementById('btn-clear-transcript');
                const agentFormulaModal = document.getElementById('agent-formula-modal');
                const agentFormulaContent = document.getElementById('agent-formula-content');
                const agentFormulaConfirm = document.getElementById('agent-formula-confirm');
                const agentFormulaCancel = document.getElementById('agent-formula-cancel');
                const agentFormulaClose = document.getElementById('agent-formula-close');
                const transcriptSection = document.getElementById('transcript-section');
                const transcriptContainer = document.getElementById('transcript-container');
                const transcriptLoading = document.getElementById('transcript-loading');
                const transcriptProgressBar = document.getElementById('transcript-progress-bar');
                const transcriptProgressText = document.getElementById('transcript-progress-text');
                const transcriptTextarea = document.getElementById('full-transcript-text');
                const insightsStatus = document.getElementById('transcript-insights-status');
                const insightsContent = document.getElementById('transcript-insights-content');
                const insightsLoading = document.getElementById('transcript-insights-loading');
                const insightsError = document.getElementById('transcript-insights-error');
                const createAgentModal = document.getElementById('create-agent-modal');
                const createAgentForm = document.getElementById('create-agent-form');
                const btnCloseAgentModal = document.getElementById('btn-close-agent-modal');
                const btnCancelAgent = document.getElementById('btn-cancel-agent');
                const btnSubmitAgent = document.getElementById('btn-submit-agent');

                console.log('[DEBUG] Elementos encontrados:', {
                    btnLoadTranscript: !!btnLoadTranscript,
                    btnCopyTranscript: !!btnCopyTranscript,
                    btnCreateAgent: !!btnCreateAgent,
                    transcriptContainer: !!transcriptContainer,
                    createAgentModal: !!createAgentModal
                });

                if (transcriptSection) transcriptSection.style.display = 'block';
                if (transcriptContainer) transcriptContainer.style.display = 'block';

                let currentVideoId = videoId;
                let currentVideoTitle = videoTitle;
                let currentTranslatedTitle = translatedTitle;
                let currentNiche = niche;
                let currentSubniche = subniche;
                let currentViralInsights = null;
                let isAnalyzingViralFormula = false;
                let autoInsightsTriggered = false;
                let hasViralInsights = false;
                let pendingAgentPayload = null;
                let isSubmittingAgent = false;
                let transcriptProgressInterval = null;
                let transcriptProgressValue = 0;
                const MIN_WORDS_FOR_INSIGHTS = 120;

                // ===== FUN√á√ïES DE PROGRESSO DO ROTEIRO MOVIDAS PARA ESCOPO GLOBAL (VER LINHA ~7110) =====

                function resetInsightsUI(message = 'Cole ou carregue o roteiro e clique em "Analisar F√≥rmula Viral".') {
                    currentViralInsights = null;
                    autoInsightsTriggered = false;
                    hasViralInsights = false;
                    if (insightsContent) {
                        insightsContent.innerHTML = '';
                        insightsContent.classList.add('hidden');
                    }
                    if (insightsError) {
                        insightsError.textContent = '';
                        insightsError.classList.add('hidden');
                    }
                    if (insightsStatus && message) {
                        insightsStatus.textContent = message;
                    }
                }

                function renderTranscriptInsights(analysis, provider) {
                    if (!insightsContent || !analysis) return;

                    const motivos = Array.isArray(analysis.motivosVirais) ? analysis.motivosVirais : [];
                    const gatilhos = Array.isArray(analysis.gatilhosEmocionais) ? analysis.gatilhosEmocionais : [];
                    const estrutura = Array.isArray(analysis.estruturaNarrativa) ? analysis.estruturaNarrativa : [];
                    const checklist = Array.isArray(analysis.formulaChecklist) ? analysis.formulaChecklist : [];
                    const sugestoes = Array.isArray(analysis.sugestoesAplicacao) ? analysis.sugestoesAplicacao : [];
                    const alertas = Array.isArray(analysis.alertas) ? analysis.alertas : [];

                    let html = '';

                    if (analysis.resumo) {
                        html += `<p class="text-gray-200">${analysis.resumo}</p>`;
                    }

                    if (motivos.length) {
                        html += `
                            <div>
                                <h6 class="text-sm font-semibold text-amber-400 mb-1">Por que viralizou</h6>
                                <ul class="space-y-1">
                                    ${motivos.map(item => `
                                        <li class="flex items-start space-x-2">
                                            <i data-lucide="check-circle" class="w-4 h-4 text-green-400 mt-0.5"></i>
                                            <span>${item}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (estrutura.length) {
                        html += `
                            <div>
                                <h6 class="text-sm font-semibold text-amber-400 mb-1">Estrutura narrativa</h6>
                                <div class="space-y-1">
                                    ${estrutura.map(step => `
                                        <div class="bg-gray-800/70 rounded-md px-3 py-2">
                                            <p class="text-xs uppercase text-gray-400 tracking-wide">${step.tempoAproximado || ''}</p>
                                            <p class="text-sm font-semibold text-white">${step.etapa || 'Etapa'}</p>
                                            <p class="text-sm text-gray-300">${step.descricao || ''}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (checklist.length) {
                        html += `
                            <div>
                                <h6 class="text-sm font-semibold text-amber-400 mb-1">Checklist da f√≥rmula (ticado pela IA)</h6>
                                <div class="space-y-2">
                                    ${checklist.map(item => {
                                        const statusOk = (item.status || '').toLowerCase() === 'aplicado';
                                        const icon = statusOk ? 'check-circle-2' : 'circle';
                                        const color = statusOk ? 'text-green-400' : 'text-yellow-400';
                                        return `
                                            <div class="flex items-start space-x-3 bg-gray-800/60 rounded-md p-3">
                                                <i data-lucide="${icon}" class="w-5 h-5 ${color} mt-0.5"></i>
                                                <div class="text-sm text-gray-200">
                                                    <p class="font-semibold">${item.item || 'Elemento da f√≥rmula'}</p>
                                                    <p class="text-gray-400 text-xs">${item.porqueFunciona || ''}</p>
                                                    ${item.comoAplicarNoMeuConteudo ? `<p class="text-gray-300 mt-1"><span class="text-amber-400 font-semibold">Como aplicar:</span> ${item.comoAplicarNoMeuConteudo}</p>` : ''}
                                                    ${item.upgradeSugerido ? `<p class="text-gray-300 mt-1"><span class="text-amber-400 font-semibold">Upgrade 10/10:</span> ${item.upgradeSugerido}</p>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (gatilhos.length) {
                        html += `
                            <div>
                                <h6 class="text-sm font-semibold text-amber-400 mb-1">Gatilhos emocionais</h6>
                                <div class="flex flex-wrap gap-2">
                                    ${gatilhos.map(trigger => `
                                        <span class="px-3 py-1 rounded-full bg-gray-800 text-xs text-gray-200 border border-gray-700">${trigger}</span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (analysis.diferencialProposto) {
                        html += `
                            <div class="bg-green-600/20 border border-green-500/40 rounded-lg p-3">
                                <p class="text-sm text-green-200"><strong>Diferencial sugerido 10/10:</strong> ${analysis.diferencialProposto}</p>
                            </div>
                        `;
                    }

                    if (sugestoes.length) {
                        html += `
                            <div>
                                <h6 class="text-sm font-semibold text-amber-400 mb-1">Como aplicar no meu roteiro</h6>
                                <ul class="list-disc pl-5 space-y-1 text-gray-300">
                                    ${sugestoes.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (alertas.length) {
                        html += `
                            <div class="bg-amber-500/10 border border-amber-500/40 rounded-lg p-3">
                                <h6 class="text-sm font-semibold text-amber-300 mb-1">Alertas / pontos de aten√ß√£o</h6>
                                <ul class="list-disc pl-5 text-sm text-amber-100 space-y-1">
                                    ${alertas.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    insightsContent.innerHTML = html || '<p class="text-gray-400">A IA n√£o conseguiu explicar o motivo do viral. Tente novamente.</p>';
                    insightsContent.classList.remove('hidden');
                    hasViralInsights = true;
                    if (insightsStatus) {
                        insightsStatus.textContent = provider
                            ? `Checklist gerado automaticamente (${provider}).`
                            : 'Checklist gerado automaticamente.';
                    }
                    updateCreateAgentAvailability();
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }

                async function requestTranscriptInsights(triggerSource = 'manual') {
                    if (!transcriptTextarea || !transcriptTextarea.value.trim()) {
                        showCustomModal('Roteiro necess√°rio', 'Cole ou carregue a transcri√ß√£o completa antes de analisar a f√≥rmula viral.', 'info');
                        return;
                    }

                    const wordCount = transcriptTextarea.value.trim().split(/\s+/).length;
                    if (wordCount < MIN_WORDS_FOR_INSIGHTS) {
                        showCustomModal('Roteiro muito curto', `Precisamos de pelo menos ${MIN_WORDS_FOR_INSIGHTS} palavras para analisar a f√≥rmula do v√≠deo.`, 'info');
                        return;
                    }

                    if (isAnalyzingViralFormula) return;
                    isAnalyzingViralFormula = true;
                    if (insightsLoading) insightsLoading.classList.remove('hidden');
                    if (insightsError) insightsError.classList.add('hidden');
                    if (btnAnalyzeTranscript) btnAnalyzeTranscript.disabled = true;

                    try {
                    // Verificar se laozhang.ai est√° configurada como padr√£o
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Transcript Analyze] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                    }
                    
                    const endpoint = useLaozhang ? '/api/video/transcript/analyze/laozhang' : '/api/video/transcript/analyze';
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                transcript: transcriptTextarea.value.trim(),
                                videoId: currentVideoId,
                                videoTitle: currentVideoTitle,
                                niche: currentNiche,
                                subniche: currentSubniche
                            })
                        });

                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.msg || 'Erro ao analisar o roteiro.');
                        }

                        currentViralInsights = data;
                        renderTranscriptInsights(data.analysis, data.provider);
                        autoInsightsTriggered = true;
                    } catch (err) {
                        console.error('Erro ao analisar f√≥rmula viral:', err);
                        if (insightsError) {
                            insightsError.textContent = err.message || 'Erro ao analisar o roteiro.';
                            insightsError.classList.remove('hidden');
                        } else {
                            showCustomModal('Erro', err.message || 'Erro ao analisar o roteiro.', 'error');
                        }
                    } finally {
                        isAnalyzingViralFormula = false;
                        if (insightsLoading) insightsLoading.classList.add('hidden');
                        if (btnAnalyzeTranscript) btnAnalyzeTranscript.disabled = false;
                    }
                }

                function autoAnalyzeIfPossible() {
                    if (autoInsightsTriggered) return;
                    if (!transcriptTextarea || !transcriptTextarea.value.trim()) return;
                    const wordCount = transcriptTextarea.value.trim().split(/\s+/).length;
                    if (wordCount < MIN_WORDS_FOR_INSIGHTS) return;
                    autoInsightsTriggered = true;
                    requestTranscriptInsights('auto');
                }

                resetInsightsUI();

                const hasTranscriptContent = () => {
                    return transcriptTextarea && transcriptTextarea.value.trim().length > 0;
                };

                const updateCreateAgentAvailability = () => {
                    if (!btnCreateAgent) return;
                    const hasContent = transcriptTextarea && transcriptTextarea.value.trim().length > 0;
                    const ready = hasContent && hasViralInsights;
                    btnCreateAgent.disabled = !ready;
                    btnCreateAgent.classList.toggle('opacity-50', !ready);
                    btnCreateAgent.classList.toggle('cursor-not-allowed', !ready);
                    if (!hasContent) {
                        btnCreateAgent.setAttribute('title', 'Cole ou carregue a transcri√ß√£o completa para habilitar');
                    } else if (!hasViralInsights) {
                        btnCreateAgent.setAttribute('title', 'Clique em ‚ÄúAnalisar F√≥rmula Viral‚Äù para desbloquear o agente.');
                    } else {
                        btnCreateAgent.removeAttribute('title');
                    }
                };

                const setTranscriptLoadingState = (isLoading, status = 'idle') => {
                    if (transcriptLoading) {
                        transcriptLoading.classList.toggle('hidden', !isLoading);
                        transcriptLoading.style.display = isLoading ? 'block' : 'none';
                    }
                    if (transcriptTextarea) {
                        transcriptTextarea.readOnly = isLoading;
                        transcriptTextarea.classList.toggle('opacity-60', isLoading);
                    }
                    
                    if (isLoading) {
                        transcriptProgressValue = 0;
                        if (transcriptProgressBar) transcriptProgressBar.style.width = '5%';
                        if (transcriptProgressText) transcriptProgressText.textContent = 'Preparando √°udio e detectando idioma...';
                        if (transcriptProgressInterval) clearInterval(transcriptProgressInterval);
                        transcriptProgressInterval = setInterval(() => {
                            transcriptProgressValue = Math.min(95, transcriptProgressValue + (Math.random() * 10) + 5);
                            if (transcriptProgressBar) transcriptProgressBar.style.width = transcriptProgressValue + '%';
                            if (transcriptProgressText) transcriptProgressText.textContent = `Transcrevendo... ${Math.round(transcriptProgressValue)}%`;
                        }, 700);
                    } else {
                        if (transcriptProgressInterval) {
                            clearInterval(transcriptProgressInterval);
                            transcriptProgressInterval = null;
                        }
                        if (transcriptProgressBar) transcriptProgressBar.style.width = '100%';
                        if (transcriptProgressText) {
                            if (status === 'success') {
                                transcriptProgressText.textContent = 'Transcri√ß√£o carregada com sucesso!';
                            } else if (status === 'error') {
                                transcriptProgressText.textContent = 'Erro ao transcrever. Tente novamente.';
                            } else {
                                transcriptProgressText.textContent = '';
                            }
                        }
                        setTimeout(() => {
                            if (transcriptLoading) transcriptLoading.style.display = 'none';
                        }, 600);
                    }
                };

                if (transcriptTextarea) {
                    transcriptTextarea.readOnly = false;
                    transcriptTextarea.addEventListener('input', () => {
                        updateCreateAgentAvailability();
                        resetInsightsUI('O roteiro foi atualizado. Clique em ‚ÄúAnalisar F√≥rmula Viral‚Äù.');
                    });
                }
                updateCreateAgentAvailability();

                if (agentFormulaCancel) {
                    agentFormulaCancel.addEventListener('click', () => {
                        closeAgentFormulaModal();
                    });
                }

                if (agentFormulaClose) {
                    agentFormulaClose.addEventListener('click', () => {
                        closeAgentFormulaModal();
                    });
                }

                if (agentFormulaConfirm) {
                    agentFormulaConfirm.addEventListener('click', () => {
                        const payload = pendingAgentPayload;
                        closeAgentFormulaModal();
                        submitAgentRequest(payload);
                    });
                }

                function buildAgentFormulaPreview(insights) {
                    if (!insights) return '<p class="text-gray-400">Sem dados suficientes para exibir a f√≥rmula.</p>';
                    const analysis = insights.analysis || insights;
                    let html = '';

                    if (analysis.resumo) {
                        html += `<p class="text-base text-white mb-3">${analysis.resumo}</p>`;
                    }

                    if (Array.isArray(analysis.formulaChecklist) && analysis.formulaChecklist.length) {
                        html += `
                            <div>
                                <h4 class="text-sm font-semibold text-amber-400 mb-2">Checklist replicado</h4>
                                <div class="space-y-2">
                                    ${analysis.formulaChecklist.map(item => `
                                        <div class="bg-gray-800/70 rounded-md p-3">
                                            <p class="text-white font-semibold">${item.item || 'Elemento da f√≥rmula'}</p>
                                            <p class="text-gray-300 text-sm">${item.porqueFunciona || ''}</p>
                                            ${item.comoAplicarNoMeuConteudo ? `<p class="text-gray-200 text-xs mt-1"><span class="text-amber-400 font-semibold">Como aplicar:</span> ${item.comoAplicarNoMeuConteudo}</p>` : ''}
                                            ${item.upgradeSugerido ? `<p class="text-gray-200 text-xs mt-1"><span class="text-amber-400 font-semibold">Upgrade 10/10:</span> ${item.upgradeSugerido}</p>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (Array.isArray(analysis.estruturaNarrativa) && analysis.estruturaNarrativa.length) {
                        html += `
                            <div>
                                <h4 class="text-sm font-semibold text-amber-400 mb-2">Estrutura replicada</h4>
                                <div class="space-y-1">
                                    ${analysis.estruturaNarrativa.map(step => `
                                        <div class="bg-gray-800/50 rounded-md px-3 py-2">
                                            <p class="text-xs uppercase text-gray-400 tracking-wide">${step.tempoAproximado || ''}</p>
                                            <p class="text-white font-semibold text-sm">${step.etapa || ''}</p>
                                            <p class="text-gray-300 text-sm">${step.descricao || ''}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (analysis.diferencialProposto) {
                        html += `
                            <div class="bg-green-600/20 border border-green-500/40 rounded-lg p-3">
                                <p class="text-sm text-green-200"><strong>Diferencial 10/10:</strong> ${analysis.diferencialProposto}</p>
                            </div>
                        `;
                    }

                    if (!html) {
                        html = '<p class="text-gray-400">A IA n√£o retornou detalhes da f√≥rmula.</p>';
                    }
                    return html;
                }

                function openAgentFormulaModal(payload) {
                    if (!agentFormulaModal || !agentFormulaContent) {
                        submitAgentRequest(payload);
                        return;
                    }
                    pendingAgentPayload = payload;
                    agentFormulaContent.innerHTML = buildAgentFormulaPreview(currentViralInsights);
                    agentFormulaModal.style.display = 'flex';
                    agentFormulaModal.classList.remove('hidden');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }

                function closeAgentFormulaModal() {
                    pendingAgentPayload = null;
                    if (agentFormulaModal) {
                        agentFormulaModal.style.display = 'none';
                        agentFormulaModal.classList.add('hidden');
                    }
                }

                async function submitAgentRequest(payload) {
                    if (!payload || isSubmittingAgent) return;
                    isSubmittingAgent = true;
                    const spinner = btnSubmitAgent ? btnSubmitAgent.querySelector('.btn-spinner') : null;
                    if (btnSubmitAgent) btnSubmitAgent.disabled = true;
                    if (spinner) spinner.classList.remove('hidden');

                    try {
                        // Verificar se laozhang.ai est√° configurada como padr√£o
                        let useLaozhang = false;
                        try {
                            const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            if (settingsResponse.ok) {
                                const settings = await settingsResponse.json();
                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                            }
                        } catch (err) {
                            console.warn('[Create Agent] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                        }
                        
                        const endpoint = useLaozhang ? '/api/script-agents/create/laozhang' : '/api/script-agents/create';
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.msg || 'Erro ao criar agente.');
                        }

                        await response.json();
                        showCustomModal('Agente viral criado', 'A f√≥rmula foi clonada e aprimorada para o novo agente!', 'success');
                        if (createAgentModal) createAgentModal.style.display = 'none';
                        createAgentForm.reset();

                        if (typeof currentBibliotecaTab !== 'undefined' && currentBibliotecaTab === 'agents') {
                            if (typeof loadBibliotecaAgents === 'function') {
                                loadBibliotecaAgents();
                            }
                        }
                    } catch (err) {
                        console.error('Erro ao criar agente:', err);
                        showCustomModal('Erro ao criar agente', err.message || 'Tente novamente.', 'error');
                    } finally {
                        isSubmittingAgent = false;
                        pendingAgentPayload = null;
                        if (btnSubmitAgent) btnSubmitAgent.disabled = false;
                        if (spinner) spinner.classList.add('hidden');
                    }
                }


                // Carregar transcri√ß√£o
                if (btnLoadTranscript) {
                    btnLoadTranscript.addEventListener('click', async () => {
                        if (!currentVideoId) {
                            alert('ID do v√≠deo n√£o dispon√≠vel.');
                            return;
                        }

                        if (hasTranscriptContent()) {
                            const shouldReplace = confirm('J√° existe um roteiro/transcri√ß√£o preenchido manualmente. Deseja substitu√≠-lo pela transcri√ß√£o autom√°tica?');
                            if (!shouldReplace) {
                                return;
                            }
                        }

                        setTranscriptLoadingState(true);
                        btnLoadTranscript.disabled = true;
                        let transcriptLoaded = false;

                        try {
                            const response = await fetch(`${API_BASE}/api/video/transcript/${currentVideoId}`, {
                                headers: {
                                    'Authorization': `Bearer ${userToken}`
                                }
                            });

                            if (!response.ok) {
                                throw new Error('Erro ao carregar transcri√ß√£o.');
                            }

                            const data = await response.json();
                            if (data.transcript) {
                                transcriptTextarea.value = data.transcript;
                                resetInsightsUI('Gerando checklist automaticamente...');
                                updateCreateAgentAvailability();
                                autoAnalyzeIfPossible();
                                transcriptLoaded = true;
                            } else {
                                alert('Transcri√ß√£o n√£o dispon√≠vel para este v√≠deo.');
                            }
                        } catch (err) {
                            console.error('Erro ao carregar transcri√ß√£o:', err);
                            alert('Erro ao carregar transcri√ß√£o: ' + err.message);
                        } finally {
                            setTranscriptLoadingState(false, transcriptLoaded ? 'success' : 'error');
                            btnLoadTranscript.disabled = false;
                        }
                    });
                }

                if (btnPasteTranscript) {
                    if (!(navigator.clipboard && navigator.clipboard.readText)) {
                        btnPasteTranscript.disabled = true;
                        btnPasteTranscript.classList.add('opacity-50', 'cursor-not-allowed');
                        btnPasteTranscript.title = 'Clipboard API n√£o dispon√≠vel neste navegador. Use Ctrl+V para colar.';
                    } else {
                        btnPasteTranscript.addEventListener('click', async () => {
                            try {
                                const text = await navigator.clipboard.readText();
                                if (!text) {
                                    alert('N√£o encontramos texto na √°rea de transfer√™ncia.');
                                    return;
                                }
                                if (transcriptTextarea) {
                                    transcriptTextarea.value = text.trim();
                                    updateCreateAgentAvailability();
                                    resetInsightsUI('Texto colado. Clique em ‚ÄúAnalisar F√≥rmula Viral‚Äù.');
                                }
                                alert('Transcri√ß√£o colada a partir do clipboard!');
                            } catch (clipboardErr) {
                                console.error('Erro ao ler clipboard:', clipboardErr);
                                alert('N√£o foi poss√≠vel acessar o clipboard. Cole usando Ctrl+V.');
                            }
                        });
                    }
                }

                if (btnAnalyzeTranscript) {
                    btnAnalyzeTranscript.addEventListener('click', (e) => {
                        e.preventDefault();
                        requestTranscriptInsights('manual');
                    });
                }

                if (btnClearTranscript) {
                    btnClearTranscript.addEventListener('click', () => {
                        if (!transcriptTextarea) return;
                        if (!transcriptTextarea.value.trim().length) {
                            return;
                        }
                        const confirmClear = confirm('Tem certeza de que deseja limpar a transcri√ß√£o atual?');
                        if (!confirmClear) return;
                        transcriptTextarea.value = '';
                        updateCreateAgentAvailability();
                        resetInsightsUI();
                    });
                }

                // Copiar transcri√ß√£o
                if (btnCopyTranscript) {
                    btnCopyTranscript.addEventListener('click', async () => {
                        if (!transcriptTextarea || !transcriptTextarea.value.trim()) {
                            alert('Cole ou carregue uma transcri√ß√£o antes de copiar.');
                            return;
                        }
                        try {
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(transcriptTextarea.value);
                            } else {
                                transcriptTextarea.select();
                                document.execCommand('copy');
                            }
                            alert('Transcri√ß√£o copiada para a √°rea de transfer√™ncia!');
                        } catch (copyErr) {
                            console.error('Erro ao copiar transcri√ß√£o:', copyErr);
                            alert('N√£o foi poss√≠vel copiar automaticamente. Selecione e copie manualmente (Ctrl+C).');
                        }
                    });
                }

                // Abrir modal de cria√ß√£o de agente
                if (btnCreateAgent) {
                    btnCreateAgent.addEventListener('click', () => {
                        const hasTranscript = transcriptTextarea && transcriptTextarea.value.trim().length > 0;
                        if (!hasTranscript) {
                            alert('Cole ou carregue a transcri√ß√£o completa antes de criar o agente.');
                            return;
                        }
                        if (!hasViralInsights) {
                            alert('Antes de criar o agente, clique em ‚ÄúAnalisar F√≥rmula Viral‚Äù para que a IA leia o roteiro e gere a estrutura 10/10.');
                            return;
                        }
                        if (createAgentModal) {
                            // Preencher campos do modal com valores atuais
                            const agentNicheInput = document.getElementById('agent-niche-input');
                            const agentSubnicheInput = document.getElementById('agent-subniche-input');
                            const agentManualTranscript = document.getElementById('agent-manual-transcript');
                            
                            if (agentNicheInput) agentNicheInput.value = currentNiche || '';
                            if (agentSubnicheInput) agentSubnicheInput.value = currentSubniche || '';
                            
                            // Preencher transcri√ß√£o manual com a transcri√ß√£o carregada (se dispon√≠vel)
                            if (agentManualTranscript && transcriptTextarea && transcriptTextarea.value) {
                                agentManualTranscript.value = transcriptTextarea.value.trim();
                            }
                            
                            createAgentModal.style.display = 'flex';
                            if (typeof lucide !== 'undefined') {
                                lucide.createIcons();
                            }
                        }
                    });
                }

                // Fechar modal
                if (btnCloseAgentModal) {
                    btnCloseAgentModal.addEventListener('click', () => {
                        if (createAgentModal) createAgentModal.style.display = 'none';
                    });
                }

                if (btnCancelAgent) {
                    btnCancelAgent.addEventListener('click', () => {
                        if (createAgentModal) createAgentModal.style.display = 'none';
                    });
                }

                // Criar agente
                if (createAgentForm) {
                    createAgentForm.addEventListener('submit', async (e) => {
                        e.preventDefault();

                        const agentName = document.getElementById('agent-name-input').value;
                        const agentNiche = document.getElementById('agent-niche-input').value;
                        const agentSubniche = document.getElementById('agent-subniche-input').value;
                        const manualTranscriptField = document.getElementById('agent-manual-transcript');
                        const manualTranscript = manualTranscriptField ? manualTranscriptField.value.trim() : '';

                        if (!agentName) {
                            alert('Por favor, informe o nome do agente.');
                            return;
                        }

                        // Se n√£o houver transcri√ß√£o manual e n√£o houver transcri√ß√£o carregada, avisar
                        const transcriptToSend = manualTranscript || (transcriptTextarea ? transcriptTextarea.value.trim() : '');

                        if (!transcriptToSend) {
                            const useManual = confirm('Nenhuma transcri√ß√£o foi carregada automaticamente e voc√™ n√£o forneceu uma transcri√ß√£o manual. Deseja continuar mesmo assim? O agente ser√° criado sem base de roteiro.');
                            if (!useManual) {
                                return;
                            }
                        }

                        openAgentFormulaModal({
                            videoId: currentVideoId,
                            videoUrl: window.location.href,
                            videoTitle: currentTranslatedTitle || currentVideoTitle,
                            agentName: agentName,
                            niche: agentNiche || currentNiche || null,
                            subniche: agentSubniche || currentSubniche || null,
                            manualTranscript: transcriptToSend || null,
                            viralInsights: currentViralInsights || null
                        });
                    });
                }
            }
            
            if (analisadorForm) {
                analisadorForm.addEventListener('submit', handleTitleAnalysis);
            }

            resultadosDiv.addEventListener('change', async (e) => {
                if (e.target.classList.contains('title-checkbox')) {
                    const checkbox = e.target;
                    const titleId = checkbox.dataset.titleId;
                    const isChecked = checkbox.checked;

                    // Adiciona/remove o estilo visual
                    const listItem = checkbox.closest('li');
                    if (listItem) {
                        listItem.classList.toggle('opacity-60', isChecked);
                        const label = listItem.querySelector('label');
                        if (label) {
                            label.classList.toggle('line-through', isChecked);
                        }
                    }

                    // Atualiza o select se o item for marcado (mas n√£o desatualiza se for desmarcado)
                    if (isChecked) {
                        // Buscar o texto do t√≠tulo - pode estar no label ou no elemento pai
                        const listItem = checkbox.closest('li');
                        let titleText = null;
                        
                        if (listItem) {
                            const label = listItem.querySelector('label');
                        if (label) {
                                titleText = label.innerText.trim();
                            } else {
                                // Se n√£o encontrar label, tentar pegar do pr√≥ximo elemento
                                const nextElement = checkbox.nextElementSibling;
                                if (nextElement) {
                                    titleText = nextElement.innerText.trim();
                                }
                            }
                        }
                        
                        if (titleText) {
                            // Remover o prefixo do modelo se existir (ex: [Gemini 2.5 Pro] T√≠tulo)
                            const modelMatch = titleText.match(/^\[.*?\]\s*(.+)$/);
                            if (modelMatch) {
                                titleText = modelMatch[1];
                            }
                            
                            // Atualizar o select do gerador de thumbnails
                            if (thumbTitleSelect) {
                                // Verificar se o t√≠tulo j√° existe nas op√ß√µes
                                let optionExists = false;
                                for (let i = 0; i < thumbTitleSelect.options.length; i++) {
                                    if (thumbTitleSelect.options[i].value === titleText || thumbTitleSelect.options[i].text === titleText) {
                                        thumbTitleSelect.selectedIndex = i;
                                        optionExists = true;
                                        break;
                                    }
                                }
                                
                                // Se n√£o existir, adicionar como nova op√ß√£o
                                if (!optionExists) {
                                    const newOption = document.createElement('option');
                                    newOption.value = titleText;
                                    newOption.text = titleText;
                                    thumbTitleSelect.appendChild(newOption);
                                    thumbTitleSelect.selectedIndex = thumbTitleSelect.options.length - 1;
                                }
                                
                                // Garantir que o gerador de thumbnails esteja vis√≠vel
                                if (thumbGeneratorDiv) {
                                    thumbGeneratorDiv.style.display = 'block';
                                    // Scroll suave at√© o gerador ap√≥s um pequeno delay
                                    setTimeout(() => {
                                        thumbGeneratorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                    }, 100);
                                }
                                
                                console.log('[Thumbnail] T√≠tulo selecionado automaticamente:', titleText);
                            }
                        }
                    }

                    // Salvar o estado no backend
                    try {
                        const response = await fetch(`${API_BASE}/api/titles/${titleId}/check`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ is_checked: isChecked })
                        });
                        
                        if (response.ok && isChecked) {
                            // Se o t√≠tulo foi marcado, atualizar dashboard
                            refreshDashboardIfVisible();
                        }
                    } catch (err) {
                        console.error("Falha ao salvar o estado do t√≠tulo:", err);
                        // Opcional: reverter a mudan√ßa visual em caso de erro
                        if (listItem) {
                            listItem.classList.toggle('opacity-60', !isChecked);
                            const label = listItem.querySelector('label');
                            if (label) {
                                label.classList.toggle('line-through', !isChecked);
                            }
                        }
                        checkbox.checked = !isChecked;
                    }
                }
            });


            // --- L√≥gica para Gerar Ideias de Thumbnail ---
            async function handleThumbnailGeneration(e) {
                const btn = e.currentTarget;
                setButtonLoading(btn, true);

                if (!currentAnalysisData.videoId) {
                    alert("Erro: Dados da an√°lise original n√£o encontrados. Por favor, analise o v√≠deo novamente.");
                    setButtonLoading(btn, false);
                    return;
                }
                
                const selectedTitle = thumbTitleSelect.value;
                const selectedModel = thumbModelSelect.value;
                const language = thumbLanguageSelect.value;
                const includePhrases = thumbPhrasesSelect.value === 'true';
                const style = thumbStyleSelect.value;
                const selectedRule = document.getElementById('thumb-rule-select')?.value || 'auto';
                const customPrompt = document.getElementById('thumb-custom-prompt')?.value?.trim() || null;
                const noPhrases = document.getElementById('thumb-no-phrases')?.checked || false;

                if (thumbLoadingSpinner) thumbLoadingSpinner.style.display = 'flex';
                if (thumbResultadosDiv) {
                    thumbResultadosDiv.style.display = 'none';
                    thumbResultadosDiv.innerHTML = '';
                }

                try {
                    // Verificar se laozhang.ai est√° configurada como padr√£o
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Thumbnail Analysis] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                    }
                    
                    const endpoint = useLaozhang ? '/api/analyze/thumbnail/laozhang' : '/api/analyze/thumbnail';
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            videoId: currentAnalysisData.videoId,
                            selectedTitle: selectedTitle,
                            model: useLaozhang ? null : selectedModel,
                            selectedModel: selectedModel,
                            niche: currentAnalysisData.niche,
                            subniche: currentAnalysisData.subniche,
                            language: language,
                            includePhrases: noPhrases ? false : includePhrases,
                            style: style,
                            thumbnailRule: selectedRule,
                            customPrompt: customPrompt
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro desconhecido');
                    if (!Array.isArray(data) || data.length === 0) throw new Error("A IA n√£o retornou o array de ideias esperado.");

                    if (thumbResultadosDiv) {
                        thumbResultadosDiv.style.display = 'grid';
                        thumbResultadosDiv.innerHTML = '';
                        
                        data.forEach((idea, index) => {
                            const uniqueId = `thumb-idea-${Date.now()}-${index}`;
                            const tagsString = (idea.seoTags || []).join(', ');
                            
                            let phrasesOptions = (idea.frasesDeGancho || []).map(phrase => `<option value="${phrase}">${phrase}</option>`).join('');
                            if (!phrasesOptions) {
                                phrasesOptions = '<option value="">Sem frases</option>';
                            }

                            // Buscar dados do contexto atual
                            const currentNiche = currentAnalysisData?.niche || '';
                            const currentSubniche = currentAnalysisData?.subniche || '';
                            const currentStyle = document.getElementById('input-style')?.value || '';

                            let thumbHtml = `
                                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-4" id="${uniqueId}" data-niche="${currentNiche}" data-subniche="${currentSubniche}" data-style="${currentStyle}">
                                    <h4 class="text-lg font-semibold text-white">Ideia de Thumbnail ${index + 1}</h4>
                                    
                                    <!-- SEO Section -->
                                    <div class="space-y-3">
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="text-sm font-medium text-amber-400">Descri√ß√£o SEO</label>
                                                <button title="Copiar Descri√ß√£o" class="btn-copy p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${idea.seoDescription || ''}">
                                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                                </button>
                                            </div>
                                            <textarea readonly class="w-full h-24 text-xs p-2 bg-gray-900 border border-gray-700 rounded-md">${idea.seoDescription || 'N/A'}</textarea>
                                        </div>
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="text-sm font-medium text-amber-400">Tags</label>
                                                <button title="Copiar Tags" class="btn-copy p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${tagsString}">
                                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                                </button>
                                            </div>
                                            <p class="text-xs p-2 bg-gray-900 border border-gray-700 rounded-md">${tagsString || 'N/A'}</p>
                                        </div>
                                    </div>
                                    
                                    <hr class="border-gray-700">

                                    <!-- Image Generation Section -->
                                    <div class="space-y-3">
                                        <div>
                                            <label for="hook-select-${uniqueId}" class="text-sm font-medium text-amber-400">Frase de Gancho</label>
                                            <select id="hook-select-${uniqueId}" class="hook-phrase-select styled-select w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm">
                                                ${phrasesOptions}
                                            </select>
                                        </div>
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                            <label class="text-sm font-medium text-amber-400">Descri√ß√£o para IA de Imagem</label>
                                                <button title="Copiar Prompt" class="btn-copy-prompt p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-prompt-text="${(idea.descricaoThumbnail || '').replace(/\[FRASE DE GANCHO AQUI\]/gi, idea.frasesDeGancho && idea.frasesDeGancho[0] ? idea.frasesDeGancho[0] : '')}">
                                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                                </button>
                                            </div>
                                            <p class="image-prompt-text text-sm text-gray-300 mt-1 p-2 bg-gray-900 border border-gray-700 rounded-md whitespace-pre-wrap" data-original-prompt="${idea.descricaoThumbnail || ''}">${(idea.descricaoThumbnail || '').replace(/\[FRASE DE GANCHO AQUI\]/gi, idea.frasesDeGancho && idea.frasesDeGancho[0] ? idea.frasesDeGancho[0] : '')}</p>
                                        </div>
                                    </div>

                                    <button type="button" class="btn-gen-imagefx mt-4 py-2 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white text-sm w-full" data-prompt="${(idea.descricaoThumbnail || '').replace(/\[FRASE DE GANCHO AQUI\]/gi, idea.frasesDeGancho && idea.frasesDeGancho[0] ? idea.frasesDeGancho[0] : '')}">
                                        <span class="btn-text">Gerar Imagem com ImageFX</span>
                                        <div class="btn-spinner hidden"></div>
                                    </button>
                                    
                                    <div class="imagefx-loading mt-4 flex-col items-center justify-center" style="display: none;">
                                        <div class="loader !w-20 !h-20"></div>
                                    </div>
                                    <div class="imagefx-result mt-4" style="display: none;"></div>
                                </div>
                            `;
                            thumbResultadosDiv.innerHTML += thumbHtml;
                        });
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }

                } catch (err) {
                    console.error("Erro ao gerar ideias de thumb:", err);
                    if (thumbResultadosDiv) {
                        thumbResultadosDiv.innerHTML = `<div class="error-message md:col-span-2" style="display: block;">Falha ao gerar ideias: ${err.message}</div>`;
                        thumbResultadosDiv.style.display = 'block';
                    }
                } finally {
                    if (thumbLoadingSpinner) thumbLoadingSpinner.style.display = 'none';
                    setButtonLoading(btn, false);
                }
            }
            
            if (btnGenerateThumbs) {
                btnGenerateThumbs.addEventListener('click', handleThumbnailGeneration);
            }
            if (btnGenerateMoreThumbs) {
                btnGenerateMoreThumbs.addEventListener('click', handleThumbnailGeneration);
            }

            // Event listener for hook phrase selection
            thumbResultadosDiv.addEventListener('change', (e) => {
                if (e.target.classList.contains('hook-phrase-select')) {
                    const select = e.target;
                    const selectedPhrase = select.value;
                    
                    if (!selectedPhrase || selectedPhrase.trim() === '') {
                        console.warn('[Thumbnail] Frase de gancho vazia selecionada');
                        return;
                    }
                    
                    const card = select.closest('.bg-gray-800');
                    if (!card) {
                        console.error('[Thumbnail] Card n√£o encontrado');
                        return;
                    }
                    
                    const promptTextElement = card.querySelector('.image-prompt-text');
                    if (!promptTextElement) {
                        console.error('[Thumbnail] Elemento de prompt n√£o encontrado');
                        return;
                    }
                    
                    const originalPrompt = promptTextElement.dataset.originalPrompt;
                    if (!originalPrompt) {
                        console.error('[Thumbnail] Prompt original n√£o encontrado no data attribute');
                        return;
                    }
                    
                    const generateBtn = card.querySelector('.btn-gen-imagefx');
                    if (!generateBtn) {
                        console.error('[Thumbnail] Bot√£o de gerar imagem n√£o encontrado');
                        return;
                    }
                    
                    const copyBtn = card.querySelector('.btn-copy-prompt');
                    if (!copyBtn) {
                        console.error('[Thumbnail] Bot√£o de copiar prompt n√£o encontrado');
                    }

                    // Substituir placeholder de forma mais robusta (case-insensitive e diferentes varia√ß√µes)
                    let newPrompt = originalPrompt;
                    
                    // Tentar diferentes varia√ß√µes do placeholder
                    const placeholderVariations = [
                        '[FRASE DE GANCHO AQUI]',
                        '[FRASE DE GANCHO AQUI]',
                        '[Frase de Gancho Aqui]',
                        '[frase de gancho aqui]',
                        '[FRASE DE GANCHO]',
                        '[Frase de Gancho]',
                        '[frase de gancho]',
                        'FRASE DE GANCHO AQUI',
                        'Frase de Gancho Aqui',
                        'frase de gancho aqui',
                        'FRASE DE GANCHO',
                        'Frase de Gancho',
                        'frase de gancho'
                    ];
                    
                    let replaced = false;
                    for (const placeholder of placeholderVariations) {
                        if (newPrompt.includes(placeholder)) {
                            newPrompt = newPrompt.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), selectedPhrase);
                            replaced = true;
                            break;
                        }
                    }
                    
                    // Se n√£o encontrou nenhum placeholder, tentar substituir qualquer texto entre colchetes que pare√ßa ser um placeholder
                    if (!replaced) {
                        newPrompt = newPrompt.replace(/\[.*?gancho.*?\]/gi, selectedPhrase);
                        replaced = true;
                    }
                    
                    // Atualizar o texto exibido e o atributo data-prompt do bot√£o
                    promptTextElement.textContent = newPrompt;
                    generateBtn.setAttribute('data-prompt', newPrompt);
                    
                    // Atualizar tamb√©m o bot√£o de copiar
                    if (copyBtn) {
                        copyBtn.setAttribute('data-prompt-text', newPrompt);
                    }
                    
                    console.log('[Thumbnail] Frase de gancho atualizada:', {
                        fraseSelecionada: selectedPhrase,
                        promptAtualizado: newPrompt.substring(0, 100) + '...'
                    });
                }
            });
            
            // Event listener para copiar prompt da imagem
            thumbResultadosDiv.addEventListener('click', (e) => {
                if (e.target.closest('.btn-copy-prompt')) {
                    const copyBtn = e.target.closest('.btn-copy-prompt');
                    const promptText = copyBtn.getAttribute('data-prompt-text');
                    
                    if (promptText) {
                        navigator.clipboard.writeText(promptText).then(() => {
                            // Feedback visual
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 pointer-events-none text-green-500"></i>';
                            copyBtn.classList.add('text-green-500');
                            
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                                copyBtn.classList.remove('text-green-500');
                                if (typeof lucide !== 'undefined') lucide.createIcons();
                            }, 2000);
                        }).catch(err => {
                            console.error('[Thumbnail] Erro ao copiar prompt:', err);
                            alert('Erro ao copiar prompt. Tente selecionar o texto manualmente.');
                        });
                    }
                }
            });


            // --- L√≥gica para Gerar Imagem com ImageFX (via event delegation) ---
            thumbResultadosDiv.addEventListener('click', async (e) => {
                const targetButton = e.target.closest('.btn-gen-imagefx');
                if (!targetButton) return;

                e.preventDefault();
                
                const card = targetButton.closest('.bg-gray-800');
                if (!card) {
                    console.error('[ImageFX] Card n√£o encontrado');
                    return;
                }
                
                // Buscar a frase de gancho selecionada no momento
                const hookSelect = card.querySelector('.hook-phrase-select');
                const selectedPhrase = hookSelect ? hookSelect.value : null;
                
                // Buscar o prompt original
                const promptTextElement = card.querySelector('.image-prompt-text');
                const originalPrompt = promptTextElement ? promptTextElement.dataset.originalPrompt : null;
                
                // Se temos frase selecionada e prompt original, garantir que a substitui√ß√£o est√° correta
                let promptDesc = targetButton.getAttribute('data-prompt');
                
                if (selectedPhrase && originalPrompt && promptDesc) {
                    // Verificar se o prompt j√° tem a frase correta
                    const placeholderVariations = [
                        '[FRASE DE GANCHO AQUI]',
                        '[FRASE DE GANCHO]',
                        '[Frase de Gancho Aqui]',
                        '[frase de gancho aqui]',
                        /\[.*?gancho.*?\]/gi
                    ];
                    
                    let needsUpdate = false;
                    for (const placeholder of placeholderVariations) {
                        if (typeof placeholder === 'string' && promptDesc.includes(placeholder)) {
                            needsUpdate = true;
                            promptDesc = promptDesc.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), selectedPhrase);
                            break;
                        } else if (placeholder instanceof RegExp && placeholder.test(promptDesc)) {
                            needsUpdate = true;
                            promptDesc = promptDesc.replace(placeholder, selectedPhrase);
                            break;
                        }
                    }
                    
                    // Se ainda tem placeholder, fazer substitui√ß√£o final
                    if (promptDesc.includes('[FRASE') || promptDesc.includes('[Frase') || promptDesc.includes('[frase')) {
                        promptDesc = promptDesc.replace(/\[.*?gancho.*?\]/gi, selectedPhrase);
                    }
                    
                    // Atualizar o atributo data-prompt para garantir consist√™ncia
                    if (needsUpdate) {
                        targetButton.setAttribute('data-prompt', promptDesc);
                        if (promptTextElement) {
                            promptTextElement.textContent = promptDesc;
                        }
                    }
                }
                
                const imageFxLoading = card.querySelector('.imagefx-loading');
                const imageFxResult = card.querySelector('.imagefx-result');

                if (!promptDesc || promptDesc === 'N/A' || promptDesc.trim() === '') {
                    alert("Descri√ß√£o da thumbnail n√£o encontrada para gerar a imagem.");
                    console.error('[ImageFX] Prompt inv√°lido:', promptDesc);
                    return;
                }
                
                console.log('[ImageFX] Gerando imagem com prompt:', {
                    fraseSelecionada: selectedPhrase,
                    promptLength: promptDesc.length,
                    promptPreview: promptDesc.substring(0, 150) + '...'
                });
                
                if (imageFxLoading) imageFxLoading.style.display = 'flex';
                if (imageFxResult) imageFxResult.style.display = 'none';
                setButtonLoading(targetButton, true);

                try {
                    // Obter dados do contexto atual (niche, subniche, style, etc.)
                    const nicheData = card.getAttribute('data-niche') || currentAnalysisData?.niche || '';
                    const subnicheData = card.getAttribute('data-subniche') || currentAnalysisData?.subniche || '';
                    const styleData = card.getAttribute('data-style') || document.getElementById('input-style')?.value || '';
                    const views = currentAnalysisData?.videoDetails?.views || 0;
                    
                    const response = await fetch(`${API_BASE}/api/generate/imagefx`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ 
                            prompt: promptDesc,
                            niche: nicheData,
                            subniche: subnicheData,
                            style: styleData,
                            saveToLibrary: true // Salvar automaticamente na biblioteca
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro desconhecido');

                    if (imageFxResult) {
                        const imageUrl = data.imageUrl;
                        const savedToLibrary = data.savedToLibrary || false;
                        const libraryId = data.libraryId || null;
                        
                        imageFxResult.innerHTML = `
                            <img src="${imageUrl}" alt="Imagem gerada" class="rounded-lg w-full mb-3" style="max-height: 400px; object-fit: contain;">
                            <div class="flex gap-2">
                                <button type="button" class="btn-download-image flex-1 py-2 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black text-xs" data-url="${imageUrl}" data-title="${promptDesc.substring(0, 20)}">
                                    <i data-lucide="download" class="w-4 h-4 mr-1.5"></i>
                                    <span>Baixar Imagem</span>
                                </button>
                                <button type="button" class="btn-save-to-library py-2 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold ${savedToLibrary ? 'bg-green-600 hover:bg-green-500' : 'bg-blue-600 hover:bg-blue-500'} text-white text-xs" 
                                        data-image-url="${imageUrl}"
                                        data-prompt="${promptDesc.replace(/"/g, '&quot;')}"
                                        data-niche="${nicheData}"
                                        data-subniche="${subnicheData}"
                                        data-style="${styleData}"
                                        data-views="${views}"
                                        data-library-id="${libraryId || ''}"
                                        ${savedToLibrary ? 'disabled' : ''}>
                                    <i data-lucide="${savedToLibrary ? 'check' : 'save'}" class="w-4 h-4 mr-1.5"></i>
                                    <span>${savedToLibrary ? 'Salvo!' : 'Salvar na Biblioteca'}</span>
                                </button>
                            </div>
                        `;
                        imageFxResult.style.display = 'block';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }

                } catch (err) {
                    console.error("Erro ao gerar imagem com ImageFX:", err);
                     if (imageFxResult) {
                        imageFxResult.innerHTML = `<div class="error-message" style="display: block;">Falha na gera√ß√£o ImageFX: ${err.message}</div>`;
                        imageFxResult.style.display = 'block';
                    }
                } finally {
                    if (imageFxLoading) imageFxLoading.style.display = 'none';
                    setButtonLoading(targetButton, false);
                }
            });
            
            thumbResultadosDiv.addEventListener('click', (e) => {
                // Download de imagem
                const downloadButton = e.target.closest('.btn-download-image');
                if (downloadButton) {
                    e.preventDefault();
                    const url = downloadButton.getAttribute('data-url');
                    const title = downloadButton.getAttribute('data-title');
                    downloadBase64Image(url, title);
                    return;
                }
            });


            // --- L√ìGICA DE PASTAS E HIST√ìRICO ---
            const newFolderForm = document.getElementById('new-folder-form');
            const folderList = document.getElementById('folder-list');
            const historyTableBody = document.getElementById('history-table-body');
            const historyTitle = document.getElementById('history-title');
            const clearHistoryFilterBtn = document.getElementById('clear-history-filter');
            const selectAllHistory = document.getElementById('select-all-history');
            const deleteSelectedBtn = document.getElementById('delete-selected-history');

            async function loadFolders() {
                try {
                    console.log('Carregando pastas...', { API_BASE });
                    const response = await fetch(`${API_BASE}/api/folders`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('Resposta de /api/folders:', { status: response.status, ok: response.ok });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            console.error('Endpoint /api/folders n√£o encontrado. Verifique se o servidor est√° rodando.');
                            console.error('API_BASE:', API_BASE, 'URL completa:', `${API_BASE}/api/folders`);
                            userFolders = []; // Define como array vazio em caso de erro
                            return;
                        }
                        throw new Error('Falha ao carregar pastas.');
                    }
                    userFolders = await response.json();
                    console.log('Pastas carregadas:', userFolders.length);
                    
                    folderSelect.innerHTML = '<option value="">Hist√≥rico Geral</option>';
                    userFolders.forEach(folder => {
                        folderSelect.innerHTML += `<option value="${folder.id}">${folder.name}</option>`;
                    });
                    
                    folderList.innerHTML = '';
                    userFolders.forEach(folder => {
                        folderList.innerHTML += `
                            <li class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-800 group">
                                <a href="#" class="folder-link text-gray-300 flex-1" data-folder-id="${folder.id}" data-folder-name="${folder.name}">
                                    ${folder.name}
                                </a>
                                <button title="Excluir Pasta" class="delete-folder-btn p-1 text-gray-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" data-folder-id="${folder.id}" data-folder-name="${folder.name}">
                                    <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </li>`;
                    });
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                } catch (err) {
                    console.error(err.message);
                }
            }
            
            let currentHistoryPage = 1;
            let currentHistoryLimit = 50;
            let currentHistoryFolderId = null;
            
            async function loadHistory(folderId = null, page = 1, limit = currentHistoryLimit) {
                currentHistoryPage = page;
                currentHistoryLimit = limit;
                currentHistoryFolderId = folderId;
                
                const search = document.getElementById('history-search')?.value || '';
                const niche = document.getElementById('history-niche-filter')?.value || '';
                const dateFilter = document.getElementById('history-date-filter')?.value || '';
                
                let url = `${API_BASE}/api/history?page=${page}&limit=${limit}`;
                if (folderId) {
                    url += `&folderId=${folderId}`;
                }
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                if (niche) {
                    url += `&niche=${encodeURIComponent(niche)}`;
                }
                if (dateFilter) {
                    url += `&dateFilter=${encodeURIComponent(dateFilter)}`;
                }
                
                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar hist√≥rico.');
                    const result = await response.json();
                    
                    // Garantir que history √© sempre um array
                    const history = Array.isArray(result) ? result : (result.data || result.history || result.items || []);
                    const pagination = result.pagination || {};
                    
                    historyTableBody.innerHTML = '';
                    if (!Array.isArray(history) || history.length === 0) {
                        historyTableBody.innerHTML = '<tr><td colspan="5" class="p-3 border-b border-gray-700 bg-gray-900 text-center text-gray-500 py-4">Nenhuma an√°lise encontrada.</td></tr>';
                        document.getElementById('history-pagination').style.display = 'none';
                        return;
                    }
                    
                    history.forEach(item => {
                        const date = new Date(item.analyzed_at).toLocaleDateString('pt-BR');
                        historyTableBody.innerHTML += `
                            <tr>
                                <td class="p-3 border-b border-gray-700 bg-gray-900"><input type="checkbox" class="history-checkbox bg-gray-700 border-gray-600 rounded" data-id="${item.id}"></td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900 max-w-xs truncate">${item.original_title}</td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900">${item.detected_subniche || 'N/A'}</td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900">${date}</td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900 flex space-x-1">
                                    <button title="Carregar An√°lise" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-gray-400 hover:text-amber-500 btn-history-action" data-action="load" data-id="${item.id}">
                                        <i data-lucide="upload" class="pointer-events-none w-4 h-4"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Carregar v√≠deos gerados
                    loadGeneratedVideos();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Atualizar pagina√ß√£o
                    updateHistoryPagination(pagination);
                    
                } catch (err) {
                    console.error('Erro ao carregar hist√≥rico:', err);
                    const errorMessage = err.message || 'Erro desconhecido ao carregar hist√≥rico.';
                    if (historyTableBody) {
                        historyTableBody.innerHTML = `<tr><td colspan="5" class="p-3 border-b border-gray-700 bg-gray-900 text-center text-red-500 py-4">${errorMessage}</td></tr>`;
                    }
                    const paginationEl = document.getElementById('history-pagination');
                    if (paginationEl) paginationEl.style.display = 'none';
                }
            }
            
            // Carregar v√≠deos gerados
            async function loadGeneratedVideos() {
                try {
                    const response = await fetch(`${API_BASE}/api/videos/generated`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar v√≠deos gerados.');
                    const result = await response.json();
                    
                    const videos = result.videos || [];
                    if (videos.length === 0) return;
                    
                    // Adicionar se√ß√£o de v√≠deos gerados antes da tabela de hist√≥rico
                    const historyContainer = document.querySelector('#view-historico .md\\:col-span-2 > div');
                    if (!historyContainer) return;
                    
                    // Verificar se j√° existe a se√ß√£o
                    let videosSection = document.getElementById('generated-videos-section');
                    if (!videosSection) {
                        videosSection = document.createElement('div');
                        videosSection.id = 'generated-videos-section';
                        videosSection.className = 'mb-8';
                        historyContainer.insertBefore(videosSection, historyContainer.firstChild);
                    }
                    
                    videosSection.innerHTML = `
                        <h2 class="text-2xl font-bold text-white mb-4">üé¨ V√≠deos Gerados</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${videos.map(video => {
                                const date = new Date(video.created_at).toLocaleDateString('pt-BR');
                                const promptPreview = video.prompt ? (video.prompt.length > 50 ? video.prompt.substring(0, 50) + '...' : video.prompt) : 'Sem descri√ß√£o';
                                return `
                                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                        <div class="mb-2">
                                            <p class="text-sm text-gray-400 truncate">${promptPreview}</p>
                                            <p class="text-xs text-gray-500 mt-1">${date} ‚Ä¢ ${video.model || 'N/A'}</p>
                                        </div>
                                        <a href="${video.video_uri}" target="_blank" class="text-amber-500 hover:text-amber-400 text-sm font-medium flex items-center gap-2">
                                            <i data-lucide="play" class="w-4 h-4"></i>
                                            Assistir V√≠deo
                                        </a>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (error) {
                    console.error('Erro ao carregar v√≠deos gerados:', error);
                }
            }
            
            function updateHistoryPagination(pagination) {
                const paginationInfo = document.getElementById('history-pagination-info');
                const paginationControls = document.getElementById('history-pagination-controls');
                const paginationContainer = document.getElementById('history-pagination');
                
                if (!pagination || !pagination.total || pagination.totalPages <= 1) {
                    paginationContainer.style.display = 'none';
                    return;
                }
                
                paginationContainer.style.display = 'flex';
                
                // Info
                const start = ((pagination.page - 1) * pagination.limit) + 1;
                const end = Math.min(pagination.page * pagination.limit, pagination.total);
                paginationInfo.textContent = `Mostrando ${start}-${end} de ${pagination.total} an√°lises`;
                
                // Controles
                paginationControls.innerHTML = '';
                
                // Bot√£o Anterior
                if (pagination.hasPrev) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'px-3 py-1 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 hover:bg-gray-700 text-sm';
                    prevBtn.innerHTML = '<i data-lucide="chevron-left" class="w-4 h-4 inline"></i> Anterior';
                    prevBtn.onclick = () => loadHistory(currentHistoryFolderId, pagination.page - 1, currentHistoryLimit);
                    paginationControls.appendChild(prevBtn);
                }
                
                // N√∫meros de p√°gina
                const maxPages = 5;
                let startPage = Math.max(1, pagination.page - Math.floor(maxPages / 2));
                let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);
                if (endPage - startPage < maxPages - 1) {
                    startPage = Math.max(1, endPage - maxPages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `px-3 py-1 rounded-lg text-sm ${i === pagination.page ? 'bg-amber-600 text-black font-bold' : 'bg-gray-800 border border-gray-700 text-gray-200 hover:bg-gray-700'}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => loadHistory(currentHistoryFolderId, i, currentHistoryLimit);
                    paginationControls.appendChild(pageBtn);
                }
                
                // Bot√£o Pr√≥ximo
                if (pagination.hasNext) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'px-3 py-1 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 hover:bg-gray-700 text-sm';
                    nextBtn.innerHTML = 'Pr√≥ximo <i data-lucide="chevron-right" class="w-4 h-4 inline"></i>';
                    nextBtn.onclick = () => loadHistory(currentHistoryFolderId, pagination.page + 1, currentHistoryLimit);
                    paginationControls.appendChild(nextBtn);
                }
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            newFolderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const folderNameInput = document.getElementById('new-folder-name');
                const name = folderNameInput.value;
                if (!name) return;
                
                try {
                    const response = await fetch(`${API_BASE}/api/folders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ name })
                    });
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.msg || 'Erro ao criar pasta.');
                    }
                    folderNameInput.value = '';
                    loadFolders();
                    showMessage('historico-success-message', 'Pasta criada com sucesso!');
                } catch (err) {
                    showMessage('historico-error-message', err.message, true);
                }
            });
            
            folderList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-folder-btn');
                if (deleteBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const folderId = deleteBtn.dataset.folderId;
                    const folderName = deleteBtn.dataset.folderName;
                    if (confirm(`Tem a certeza que deseja excluir a pasta "${folderName}"? As an√°lises dentro dela ser√£o movidas para o Hist√≥rico Geral.`)) {
                        try {
                            const response = await fetch(`${API_BASE}/api/folders/${folderId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            const data = await response.json();
                            if (!response.ok) throw new Error(data.msg);
                            showMessage('historico-success-message', data.msg);
                            loadFolders();
                            if (historyTitle.innerText.includes(folderName)) {
                                historyTitle.innerText = 'Hist√≥rico Geral';
                                clearHistoryFilterBtn.style.display = 'none';
                                loadHistory();
                            }
                        } catch (err) {
                            showMessage('historico-error-message', err.message, true);
                        }
                    }
                    return;
                }

                const link = e.target.closest('.folder-link');
                if (link) {
                    e.preventDefault();
                    const folderId = link.dataset.folderId;
                    const folderName = link.dataset.folderName;
                    historyTitle.innerText = `Hist√≥rico em: ${folderName}`;
                    clearHistoryFilterBtn.style.display = 'inline';
                    loadHistory(folderId, 1, currentHistoryLimit);
                }
            });
            
            clearHistoryFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                historyTitle.innerText = 'Hist√≥rico Geral';
                clearHistoryFilterBtn.style.display = 'none';
                loadHistory(null, 1, currentHistoryLimit);
            });
            
            // Event listeners para filtros
            const historySearch = document.getElementById('history-search');
            const historyNicheFilter = document.getElementById('history-niche-filter');
            const historyDateFilter = document.getElementById('history-date-filter');
            
            if (historySearch) {
                let searchTimeout;
                historySearch.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        loadHistory(currentHistoryFolderId, 1, currentHistoryLimit);
                    }, 500);
                });
            }
            
            if (historyNicheFilter) {
                historyNicheFilter.addEventListener('change', () => {
                    loadHistory(currentHistoryFolderId, 1, currentHistoryLimit);
                });
            }
            
            if (historyDateFilter) {
                historyDateFilter.addEventListener('change', () => {
                    loadHistory(currentHistoryFolderId, 1, currentHistoryLimit);
                });
            }
            
            // Carregar nichos √∫nicos para o filtro
            async function loadHistoryNiches() {
                try {
                    const response = await fetch(`${API_BASE}/api/history/niches`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const niches = data.niches || [];
                        if (historyNicheFilter) {
                            const currentValue = historyNicheFilter.value;
                            historyNicheFilter.innerHTML = '<option value="">Todos os Nichos</option>';
                            niches.forEach(niche => {
                                const option = document.createElement('option');
                                option.value = niche;
                                option.textContent = niche;
                                historyNicheFilter.appendChild(option);
                            });
                            if (currentValue && niches.includes(currentValue)) {
                                historyNicheFilter.value = currentValue;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar nichos do hist√≥rico:', err);
                }
            }
            
            // Filtro de limite por p√°gina
            const historyLimitSelect = document.getElementById('history-limit');
            if (historyLimitSelect) {
                historyLimitSelect.addEventListener('change', (e) => {
                    const newLimit = parseInt(e.target.value);
                    loadHistory(currentHistoryFolderId, 1, newLimit);
                });
            }

            historyTableBody.addEventListener('click', async (e) => {
                const button = e.target.closest('.btn-history-action');
                if (button) {
                    const action = button.dataset.action;
                    const id = button.dataset.id;
                    
                    if (action === 'load') {
                        try {
                            const response = await fetch(`${API_BASE}/api/history/load/${id}`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            const data = await response.json();
                            if (!response.ok) throw new Error(data.msg || 'Falha ao carregar dados.');
                            
                            navigateToView('analisador');
                            
                            if (thumbGeneratorDiv) thumbGeneratorDiv.style.display = 'none';
                            if (thumbResultadosDiv) {
                                thumbResultadosDiv.style.display = 'none';
                                thumbResultadosDiv.innerHTML = '';
                            }
                            
                            populateAnalysisResults(data, data.originalVideoUrl);
                            
                            currentAnalysisData = {
                                videoId: data.videoDetails.videoId,
                                niche: data.niche,
                                subniche: data.subniche,
                                model: data.modelUsed,
                                generatedTitles: data.titulosSugeridos,
                                videoDetails: data.videoDetails // Incluir videoDetails para acesso a views, etc.
                            };
                            
                        } catch (err) {
                            showMessage('analisador-error', `Falha ao carregar an√°lise: ${err.message}`, true);
                        }
                    }
                }

                if (e.target.classList.contains('history-checkbox')) {
                    const checked = document.querySelectorAll('.history-checkbox:checked').length > 0;
                    deleteSelectedBtn.classList.toggle('hidden', !checked);
                }
            });

            selectAllHistory.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.history-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
                deleteSelectedBtn.classList.toggle('hidden', !e.target.checked || checkboxes.length === 0);
            });

            deleteSelectedBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.history-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                if (confirm(`Tem a certeza que deseja excluir ${selectedIds.length} an√°lise(s)?`)) {
                    try {
                        const response = await fetch(`${API_BASE}/api/history`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ ids: selectedIds })
                        });
                        if (!response.ok) throw new Error('Falha ao excluir.');
                        
                        const currentFolderId = document.querySelector('.folder-link.active')?.dataset.folderId || currentHistoryFolderId;
                        loadHistory(currentFolderId, currentHistoryPage, currentHistoryLimit);
                        showMessage('historico-success-message', 'An√°lises exclu√≠das.');
                        deleteSelectedBtn.classList.add('hidden');
                        selectAllHistory.checked = false;
                    } catch (err) {
                        showMessage('historico-error-message', err.message, true);
                    }
                }
            });

            // --- L√ìGICA DE CANAIS MONITORADOS ---
            const newChannelForm = document.getElementById('new-channel-form');
            const channelTableBody = document.getElementById('channel-table-body');
            const modal = document.getElementById('channel-videos-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalLoading = document.getElementById('modal-loading');
            const modalError = document.getElementById('modal-error');
            const modalVideoList = document.getElementById('modal-video-list');

            function showModal(isLoading = false, error = null) {
                modal.style.display = 'flex';
                modalLoading.style.display = isLoading ? 'block' : 'none';
                modalError.style.display = error ? 'block' : 'none';
                modalVideoList.style.display = !isLoading && !error ? 'block' : 'none';
                if (error) modalError.innerText = error;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function hideModal() {
                modal.style.display = 'none';
                modalVideoList.innerHTML = '';
            }

            if(modalCloseBtn) modalCloseBtn.addEventListener('click', hideModal);
            if(modal) modal.addEventListener('click', (e) => {
                if (e.target === modal) hideModal();
            });
            
            async function loadMonitoredChannels() {
                try {
                    console.log('[Canais Monitorados] Carregando lista de canais...');
                    const response = await fetch(`${API_BASE}/api/channels/monitor`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Falha ao carregar canais.' }));
                        throw new Error(errorData.msg || 'Falha ao carregar canais.');
                    }
                    const channels = await response.json();
                    
                    console.log(`[Canais Monitorados] ${channels ? channels.length : 0} canal(is) encontrado(s)`, channels);
                    
                    channelTableBody.innerHTML = '';
                    if (!channels || channels.length === 0) {
                        channelTableBody.innerHTML = '<tr><td colspan="3" class="p-3 border-b border-gray-700 bg-gray-900 text-center text-gray-500 py-4">Nenhum canal monitorado. Adicione um canal para come√ßar.</td></tr>';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        return;
                    }
                    
                    // Verificar limite de 5 canais
                    if (channels.length >= 5) {
                        const limitMsg = document.getElementById('canais-limit-message');
                        if (limitMsg) {
                            limitMsg.textContent = `Limite de 5 canais atingido (${channels.length}/5). Exclua um canal para adicionar outro.`;
                            limitMsg.style.display = 'block';
                            limitMsg.className = 'error-message mb-4';
                        }
                    } else {
                        const limitMsg = document.getElementById('canais-limit-message');
                        if (limitMsg) limitMsg.style.display = 'none';
                    }
                    
                    channels.forEach((channel, index) => {
                        const escapedName = (channel.channel_name || '').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
                        const escapedUrl = (channel.channel_url || '').replace(/"/g, '&quot;');
                        channelTableBody.innerHTML += `
                            <tr>
                                <td class="p-3 border-b border-gray-700 bg-gray-900">${escapedName}</td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900 max-w-xs truncate">
                                    <a href="${escapedUrl}" target="_blank" class="text-amber-500 hover:text-amber-400" title="${escapedUrl}">${escapedUrl}</a>
                                </td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900 flex space-x-1">
                                    <button title="Verificar V√≠deos" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-gray-400 hover:text-green-500 btn-channel-action" data-action="check" data-id="${channel.id}">
                                        <i data-lucide="search" class="pointer-events-none w-4 h-4"></i>
                                    </button>
                                    <button title="Excluir Canal" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-gray-400 hover:text-red-500 btn-channel-action" data-action="delete" data-id="${channel.id}">
                                        <i data-lucide="trash-2" class="pointer-events-none w-4 h-4"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    console.log('[Canais Monitorados] Lista atualizada com sucesso.');
                    
                } catch (err) {
                    console.error('[Canais Monitorados] Erro ao carregar:', err);
                    showMessage('canais-error-message', err.message, true);
                }
            }
            
            if (newChannelForm) {
                newChannelForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('btn-add-channel');
                    setButtonLoading(btn, true);
                    
                    const channelName = document.getElementById('new-channel-name').value.trim();
                    const channelUrl = document.getElementById('new-channel-url').value.trim();
                    
                    if (!channelName || !channelUrl) {
                        showMessage('canais-error-message', 'Nome e URL do canal s√£o obrigat√≥rios.', true);
                        setButtonLoading(btn, false);
                        return;
                    }
                    
                    try {
                        console.log('[Adicionar Canal] Enviando requisi√ß√£o...', { channelName, channelUrl });
                        const response = await fetch(`${API_BASE}/api/channels/monitor`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ channelName, channelUrl })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro ao adicionar canal.');
                        
                        console.log('[Adicionar Canal] Canal adicionado com sucesso:', data);
                        
                        // Limpar formul√°rio
                        document.getElementById('new-channel-name').value = '';
                        document.getElementById('new-channel-url').value = '';
                        
                        // Recarregar lista de canais e v√≠deos fixados
                        await loadMonitoredChannels();
                        await loadPinnedVideos(null); // null = mostrar todos os canais
                        
                        showMessage('canais-success-message', `Canal "${channelName}" adicionado com sucesso!`);
                        
                    } catch (err) {
                        showMessage('canais-error-message', err.message, true);
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });
            }
            
            if (channelTableBody) {
                channelTableBody.addEventListener('click', async (e) => {
                    const button = e.target.closest('.btn-channel-action');
                    if (!button) return;
                    
                    const action = button.dataset.action;
                    const channelId = button.dataset.id;
                    
                    if (action === 'delete') {
                         if (confirm('Tem certeza que deseja remover este canal?')) {
                            try {
                                const response = await fetch(`${API_BASE}/api/channels/monitor/${channelId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({ msg: 'Falha ao remover canal.' }));
                                    throw new Error(errorData.msg || 'Falha ao remover canal.');
                                }
                                await loadMonitoredChannels();
                                // Manter o canal selecionado no dropdown (ou null se n√£o houver sele√ß√£o)
                                const channelSelect = document.getElementById('pinned-channel-select');
                                const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                                await loadPinnedVideos(selectedChannelId);
                                showMessage('canais-success-message', 'Canal removido com sucesso.');
                            } catch (err) {
                                showMessage('canais-error-message', err.message, true);
                            }
                        }
                    }
                    if (action === 'check') {
                        const channelName = button.closest('tr').querySelector('td').innerText;
                        modalTitle.innerText = `V√≠deos de: ${channelName}`;
                        showModal(true);

                        try {
                            const response = await fetch(`${API_BASE}/api/channels/monitor/${channelId}/check`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                let errorMsg = 'Erro desconhecido';
                                try {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.msg || errorMsg;
                                } catch (e) {
                                    errorMsg = errorText.substring(0, 100) || 'Erro ao buscar v√≠deos do canal';
                                }
                                throw new Error(errorMsg);
                            }
                            
                            const data = await response.json();

                            const createVideoListHTML = (videos, isPinned = false) => {
                                if (!videos || videos.length === 0) return '<p class="text-gray-500 text-center py-4">Nenhum v√≠deo encontrado.</p>';
                                return videos.map(video => {
                                    const escapedTitle = (video.title || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                                    const revenueUSD = video.estimatedRevenueUSD || 0;
                                    const rpmUSD = video.rpmUSD || 0;
                                    return `
                                    <div class="flex items-start space-x-4 bg-gray-800 p-3 rounded-lg">
                                        <img src="${video.thumbnail}" alt="thumb" class="w-32 h-18 object-cover rounded">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-200 line-clamp-2">${video.title}</p>
                                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-400 mt-1">
                                                <span class="flex items-center"><i data-lucide="eye" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.views || 0)}</span>
                                                <span class="flex items-center"><i data-lucide="thumbs-up" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.likes || 0)}</span>
                                                <span class="flex items-center"><i data-lucide="message-square" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.comments || 0)}</span>
                                            </div>
                                            ${revenueUSD > 0 || rpmUSD > 0 ? `
                                            <div class="mt-2 text-xs">
                                                <span class="text-green-400 font-semibold">$${Math.round(revenueUSD)}</span>
                                                <span class="text-gray-500 mx-1">‚Ä¢</span>
                                                <span class="text-amber-400 font-semibold">RPM: $${rpmUSD.toFixed(2)}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                        <div class="flex flex-col space-y-2">
                                            <button class="btn-analyze-from-modal py-2 px-3 rounded-lg transition duration-300 text-xs font-bold bg-amber-600 hover:bg-amber-500 text-black whitespace-nowrap" data-video-id="${video.videoId}">Analisar</button>
                                            ${isPinned ? 
                                                `<button title="Remover Fixado" class="btn-unpin-video p-2 rounded-md hover:bg-gray-700 text-amber-500" data-pin-id="${video.pinId}" data-channel-id="${channelId}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>` :
                                                `<button title="Fixar" class="btn-pin-video p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-400" data-channel-id="${channelId}" data-video-id="${video.videoId}" data-title="${escapedTitle}" data-thumbnail="${video.thumbnail}"><i data-lucide="pin" class="w-4 h-4 pointer-events-none"></i></button>`
                                            }
                                        </div>
                                    </div>
                                `}).join('');
                            };

                            modalVideoList.innerHTML = `
                                <div>
                                    <h3 class="text-lg font-semibold text-amber-500 mb-2">V√≠deos Fixados</h3>
                                    <div class="space-y-3">${createVideoListHTML(data.pinned, true)}</div>
                                </div>
                                <hr class="border-gray-700 my-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-amber-500 mb-2">5 V√≠deos Mais Populares</h3>
                                    <div class="space-y-3">${createVideoListHTML(data.popular)}</div>
                                </div>
                                <hr class="border-gray-700 my-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-amber-500 mb-2">5 V√≠deos Mais Recentes</h3>
                                    <div class="space-y-3">${createVideoListHTML(data.latest)}</div>
                                </div>
                            `;
                            showModal(false);

                        } catch (err) {
                            showModal(false, `Falha ao buscar v√≠deos: ${err.message}`);
                        }
                    }
                });
            }

            async function pinVideo(channelId, videoId, title, thumbnail, buttonElement) {
                try {
                    const response = await fetch(`${API_BASE}/api/videos/pin`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ channelId, videoId, title, thumbnail })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg);
                    
                    buttonElement.classList.add('text-amber-500');
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 pointer-events-none"></i>';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    showMessage('canais-success-message', 'V√≠deo fixado com sucesso!');
                    
                    // Refresh the modal content
                    const checkButton = document.querySelector(`.btn-channel-action[data-action="check"][data-id="${channelId}"]`);
                    if (checkButton) checkButton.click();
                    
                    // Atualizar se√ß√£o de v√≠deos fixados em tempo real (manter canal selecionado)
                    const channelSelect = document.getElementById('pinned-channel-select');
                    const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                    await loadPinnedVideos(selectedChannelId);

                } catch (err) {
                    showMessage('canais-error-message', err.message, true);
                }
            }
            
            async function unpinVideo(pinId, channelId, buttonElement) {
                 try {
                    const response = await fetch(`${API_BASE}/api/videos/unpin/${pinId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg);
                    
                    showMessage('canais-success-message', 'V√≠deo removido dos fixados.');
                    
                    // Refresh the modal content and pinned videos section
                    const checkButton = document.querySelector(`.btn-channel-action[data-action="check"][data-id="${channelId}"]`);
                    if (checkButton) checkButton.click();
                    // Manter o canal selecionado no dropdown
                    const channelSelect = document.getElementById('pinned-channel-select');
                    const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                    await loadPinnedVideos(selectedChannelId);

                } catch (err) {
                    showMessage('canais-error-message', err.message, true);
                }
            }
            
            let allChannelsForPinned = [];
            let allPinnedVideosByChannel = {};
            
            async function loadPinnedVideos(selectedChannelId = null) {
                const pinnedSection = document.getElementById('pinned-videos-section');
                const channelSelect = document.getElementById('pinned-channel-select');
                if (!pinnedSection) return;
                
                try {
                    // Buscar todos os canais monitorados
                    const channelsResponse = await fetch(`${API_BASE}/api/channels/monitor`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!channelsResponse.ok) throw new Error('Falha ao carregar canais.');
                    const channels = await channelsResponse.json();
                    allChannelsForPinned = channels || [];
                    
                    // Atualizar dropdown de canais
                    if (channelSelect) {
                        channelSelect.innerHTML = '<option value="">Todos os Canais</option>';
                        allChannelsForPinned.forEach(channel => {
                            const option = document.createElement('option');
                            option.value = channel.id;
                            option.textContent = channel.channel_name;
                            if (selectedChannelId && channel.id == selectedChannelId) {
                                option.selected = true;
                            }
                            channelSelect.appendChild(option);
                        });
                    }
                    
                    if (allChannelsForPinned.length === 0) {
                        pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum canal monitorado. Adicione um canal para come√ßar.</p>';
                        return;
                    }
                    
                    // Buscar v√≠deos fixados de todos os canais (ou apenas do canal selecionado)
                    const channelsToFetch = selectedChannelId 
                        ? allChannelsForPinned.filter(c => c.id == selectedChannelId)
                        : allChannelsForPinned;
                    
                    allPinnedVideosByChannel = {};
                    for (const channel of channelsToFetch) {
                        try {
                            const pinnedResponse = await fetch(`${API_BASE}/api/channels/${channel.id}/pinned`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            if (pinnedResponse.ok) {
                                const pinned = await pinnedResponse.json();
                                if (pinned && pinned.length > 0) {
                                    allPinnedVideosByChannel[channel.id] = {
                                        channelName: channel.channel_name,
                                        channelId: channel.id,
                                        videos: pinned
                                    };
                                }
                            }
                        } catch (err) {
                            console.error(`Erro ao buscar v√≠deos fixados do canal ${channel.id}:`, err);
                        }
                    }
                    
                    const channelsWithPinnedVideos = Object.values(allPinnedVideosByChannel);
                    
                    if (channelsWithPinnedVideos.length === 0) {
                        if (selectedChannelId) {
                            pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Este canal n√£o possui v√≠deos fixados ainda. Fixe v√≠deos ao buscar v√≠deos do canal.</p>';
                        } else {
                            pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum v√≠deo fixado ainda. Fixe v√≠deos ao buscar v√≠deos de um canal.</p>';
                        }
                        return;
                    }
                    
                    // Exibir v√≠deos fixados (agrupados por canal se "Todos os Canais", ou apenas do canal selecionado)
                    if (selectedChannelId) {
                        // Mostrar apenas v√≠deos do canal selecionado
                        const channelData = allPinnedVideosByChannel[selectedChannelId];
                        if (channelData) {
                            const { channelName, channelId, videos } = channelData;
                            const videosHtml = videos.map(video => {
                                const escapedTitle = (video.title || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                                return createPinnedVideoCard(video, channelId, escapedTitle);
                            }).join('');
                            
                            pinnedSection.innerHTML = `
                                <div class="col-span-full mb-4">
                                    <h3 class="text-lg font-semibold text-amber-500 mb-3 flex items-center">
                                        <i data-lucide="tv" class="w-5 h-5 mr-2"></i>
                                        ${channelName}
                                        <span class="ml-2 text-sm text-gray-400">(${videos.length} v√≠deo${videos.length !== 1 ? 's' : ''} fixado${videos.length !== 1 ? 's' : ''})</span>
                                    </h3>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 col-span-full">
                                    ${videosHtml}
                                </div>
                            `;
                        } else {
                            pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Este canal n√£o possui v√≠deos fixados ainda.</p>';
                        }
                    } else {
                        // Mostrar todos os canais agrupados
                        pinnedSection.innerHTML = channelsWithPinnedVideos.map(channelData => {
                            const { channelName, channelId, videos } = channelData;
                            const videosHtml = videos.map(video => {
                                const escapedTitle = (video.title || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                                return createPinnedVideoCard(video, channelId, escapedTitle);
                            }).join('');
                            
                            return `
                                <div class="col-span-full mb-6">
                                    <h3 class="text-lg font-semibold text-amber-500 mb-3 flex items-center">
                                        <i data-lucide="tv" class="w-5 h-5 mr-2"></i>
                                        ${channelName}
                                        <span class="ml-2 text-sm text-gray-400">(${videos.length} v√≠deo${videos.length !== 1 ? 's' : ''} fixado${videos.length !== 1 ? 's' : ''})</span>
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${videosHtml}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    function createPinnedVideoCard(video, channelId, escapedTitle) {
                        return `
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 hover:border-amber-500 transition-colors">
                                <img src="${video.thumbnail}" alt="thumb" class="w-full h-40 object-cover rounded-lg mb-3">
                                <div class="space-y-2">
                                    <p class="text-sm font-medium text-white line-clamp-2" title="${escapedTitle}">${escapedTitle}</p>
                                    <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
                                        <span class="flex items-center"><i data-lucide="eye" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.views || 0)}</span>
                                        <span class="flex items-center"><i data-lucide="thumbs-up" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.likes || 0)}</span>
                                    </div>
                                    ${video.estimatedRevenueUSD > 0 || video.rpmUSD > 0 ? `
                                    <div class="mt-2 p-2 bg-gray-800 rounded text-xs">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-gray-400">Receita:</span>
                                            <span class="text-green-400 font-bold">$${Math.round(video.estimatedRevenueUSD || 0)}</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-gray-400">RPM:</span>
                                            <span class="text-amber-400 font-bold">$${(video.rpmUSD || 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                    <div class="flex items-center gap-2 mt-3">
                                        <button class="btn-analyze-from-pinned flex-1 py-2 px-3 rounded-lg transition duration-300 text-xs font-bold bg-amber-600 hover:bg-amber-500 text-black" data-video-id="${video.videoId}">
                                            Analisar
                                        </button>
                                        <button title="Remover Fixado" class="btn-unpin-from-section p-2 rounded-md hover:bg-gray-700 text-red-500" data-pin-id="${video.pinId}" data-channel-id="${channelId}">
                                            <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Event listener para mudan√ßa de canal no dropdown
                    if (channelSelect) {
                        // Remover listener antigo se existir
                        const oldHandler = channelSelect._changeHandler;
                        if (oldHandler) {
                            channelSelect.removeEventListener('change', oldHandler);
                        }
                        
                        const changeHandler = (e) => {
                            const selectedChannelId = e.target.value || null;
                            loadPinnedVideos(selectedChannelId);
                        };
                        
                        channelSelect._changeHandler = changeHandler;
                        channelSelect.addEventListener('change', changeHandler);
                    }
                    
                    // Event listeners para bot√µes (usar event delegation)
                    const oldClickHandler = pinnedSection._clickHandler;
                    if (oldClickHandler) {
                        pinnedSection.removeEventListener('click', oldClickHandler);
                    }
                    
                    const clickHandler = async (e) => {
                        const analyzeBtn = e.target.closest('.btn-analyze-from-pinned');
                        if (analyzeBtn) {
                            const videoId = analyzeBtn.dataset.videoId;
                            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                            navigateToView('analisador');
                            const urlInput = document.getElementById('video-url-input') || document.getElementById('video-url');
                            if (urlInput) urlInput.value = videoUrl;
                            const analisarBtn = document.getElementById('analisar-button');
                            if (analisarBtn) analisarBtn.click();
                            return;
                        }
                        
                        const unpinBtn = e.target.closest('.btn-unpin-from-section');
                        if (unpinBtn) {
                            const pinId = unpinBtn.dataset.pinId;
                            const channelId = unpinBtn.dataset.channelId;
                            await unpinVideo(pinId, channelId, unpinBtn);
                            // Recarregar mantendo o canal selecionado
                            const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                            await loadPinnedVideos(selectedChannelId);
                            return;
                        }
                    };
                    
                    pinnedSection._clickHandler = clickHandler;
                    pinnedSection.addEventListener('click', clickHandler);
                    
                } catch (err) {
                    console.error('Erro ao carregar v√≠deos fixados:', err);
                    pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Erro ao carregar v√≠deos fixados.</p>';
                }
            }

            if (modalVideoList) {
                modalVideoList.addEventListener('click', (e) => {
                    const analyzeButton = e.target.closest('.btn-analyze-from-modal');
                    if (analyzeButton) {
                        const videoId = analyzeButton.dataset.videoId;
                        const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                        
                        hideModal();
                        navigateToView('analisador');
                        
                        const videoUrlInput = document.getElementById('video-url');
                        const analisadorForm = document.getElementById('analisador-form');
                        videoUrlInput.value = videoUrl;
                        analisadorForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                        return;
                    }

                    const pinButton = e.target.closest('.btn-pin-video');
                    if (pinButton) {
                        const channelId = pinButton.dataset.channelId;
                        const videoId = pinButton.dataset.videoId;
                        const title = pinButton.dataset.title;
                        const thumbnail = pinButton.dataset.thumbnail;
                        pinVideo(channelId, videoId, title, thumbnail, pinButton);
                        return;
                    }
                    
                    const unpinButton = e.target.closest('.btn-unpin-video');
                    if (unpinButton) {
                        const pinId = unpinButton.dataset.pinId;
                        const channelId = unpinButton.dataset.channelId;
                        unpinVideo(pinId, channelId, unpinButton);
                        return;
                    }
                });
            }


            // --- L√ìGICA DE CONFIGURA√á√ïES (API KEYS) ---
            
            async function saveKey(serviceName, apiKey) {
                if (!apiKey) return Promise.resolve(null);
                const response = await fetch(`${API_BASE}/api/keys/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({ service_name: serviceName, api_key: apiKey })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.msg || `Erro ao salvar ${serviceName}.`);
                return data;
            }
            
            const configForm = document.getElementById('config-form');
            if (configForm) {
                configForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const saveButton = document.getElementById('btn-save-all');
                    setButtonLoading(saveButton, true);

                    const claudeKey = document.getElementById('key-claude').value;
                    const geminiKey = document.getElementById('key-gemini').value;
                    const openaiKey = document.getElementById('key-openai').value;
                    const youtubeKey = document.getElementById('key-youtube').value;
                    const imagefxKey = document.getElementById('key-imagefx').value;
                    const useCreditsPref = document.getElementById('pref-use-credits').checked;

                    try {
                        const promises = [];
                        if (claudeKey) promises.push(saveKey('claude', claudeKey));
                        if (geminiKey) promises.push(saveKey('gemini', geminiKey));
                        if (openaiKey) promises.push(saveKey('openai', openaiKey));
                        if (youtubeKey) promises.push(saveKey('youtube', youtubeKey));
                        if (imagefxKey) promises.push(saveKey('imagefx', imagefxKey));
                        
                        // Salvar prefer√™ncia de uso de cr√©ditos
                        promises.push(saveUserPreference(useCreditsPref));

                        if (promises.length === 0) {
                            showMessage('config-error-message', "Nenhuma chave foi preenchida para salvar.", true);
                        } else {
                            await Promise.all(promises);
                            showMessage('config-success-message', "Configura√ß√µes salvas com sucesso!");
                            updatePreferenceStatus(useCreditsPref);
                            
                            document.getElementById('key-claude').value = '';
                            document.getElementById('key-gemini').value = '';
                            document.getElementById('key-openai').value = '';
                            document.getElementById('key-youtube').value = '';
                        }
                    } catch (err) {
                        showMessage('config-error-message', err.message, true);
                    } finally {
                        setButtonLoading(saveButton, false);
                    }
                });
            }

            const validateButton = document.getElementById('btn-validate-all');
            if (validateButton) {
                validateButton.addEventListener('click', async () => {
                    setButtonLoading(validateButton, true);
                    showMessage('config-success-message', "A validar chaves guardadas... (Isto pode demorar um momento)");

                    try {
                        const response = await fetch(`${API_BASE}/api/keys/validate-all`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro desconhecido do servidor.');

                        let resultsHtml = "<strong>Resultados da Valida√ß√£o:</strong><ul class='list-disc pl-5 mt-2'>";
                        data.results.forEach(result => {
                            if (result.success) {
                                resultsHtml += `<li class='valid'>${result.service}: V√°lida</li>`;
                            } else {
                                resultsHtml += `<li class='invalid'>${result.service}: Inv√°lida (${result.error})</li>`;
                            }
                        });
                        resultsHtml += "</ul>";
                        
                        showMessage('config-success-message', resultsHtml);

                    } catch (err) {
                        showMessage('config-error-message', err.message, true);
                    } finally {
                        setButtonLoading(validateButton, false);
                    }
                });
            }
            
            // --- L√ìGICA DE PREFER√äNCIAS DO USU√ÅRIO ---
            async function loadUserPreferences() {
                try {
                    const response = await fetch(`${API_BASE}/api/user/preferences`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const checkbox = document.getElementById('pref-use-credits');
                        if (checkbox) {
                            checkbox.checked = data.use_credits_instead_of_own_api || false;
                            updatePreferenceStatus(data.use_credits_instead_of_own_api || false);
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar prefer√™ncias:', err);
                }
            }
            
            async function saveUserPreference(useCredits) {
                try {
                    const response = await fetch(`${API_BASE}/api/user/preferences`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            use_credits_instead_of_own_api: useCredits
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar prefer√™ncia');
                    }
                    
                    return await response.json();
                } catch (err) {
                    console.error('Erro ao salvar prefer√™ncia:', err);
                    throw err;
                }
            }
            
            function updatePreferenceStatus(useCredits) {
                const statusMessage = document.getElementById('pref-status-message');
                if (statusMessage) {
                    const statusText = statusMessage.querySelector('span');
                    if (statusText) {
                        if (useCredits) {
                            statusText.textContent = 'Prefer√™ncia salva: O sistema usar√° seus cr√©ditos mesmo quando voc√™ tiver chaves de API pr√≥prias.';
                        } else {
                            statusText.textContent = 'Prefer√™ncia salva: O sistema usar√° suas chaves de API pr√≥prias quando dispon√≠veis.';
                        }
                        statusMessage.classList.remove('hidden');
                    }
                }
            }
            
            // Event listener para mudan√ßa imediata do checkbox
            const prefCheckbox = document.getElementById('pref-use-credits');
            if (prefCheckbox) {
                prefCheckbox.addEventListener('change', async (e) => {
                    try {
                        await saveUserPreference(e.target.checked);
                        updatePreferenceStatus(e.target.checked);
                    } catch (err) {
                        console.error('Erro ao salvar prefer√™ncia:', err);
                        // Reverter checkbox em caso de erro
                        e.target.checked = !e.target.checked;
                    }
                });
            }
            
            // --- L√ìGICA DE EXPLORAR NICHO ---
            const findSubnicheForm = document.getElementById('find-subniche-form');
            const analyzeCompetitorForm = document.getElementById('analyze-competitor-form');

            findSubnicheForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-find-subniche');
                const loading = document.getElementById('subniche-loading');
                const resultsDiv = document.getElementById('subniche-results');
                
                setButtonLoading(btn, true);
                loading.style.display = 'block';
                resultsDiv.innerHTML = '';
                showMessage('niche-error-message', '', true); // Clear previous errors

                const nichePrincipal = document.getElementById('niche-principal').value;
                const ideiaInicial = document.getElementById('ideia-inicial').value;
                const model = document.getElementById('niche-model-select').value;

                try {
                    // Verificar se laozhang.ai est√° configurada como padr√£o
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Find Subniche] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                    }
                    
                    const endpoint = useLaozhang ? '/api/niche/find-subniche/laozhang' : '/api/niche/find-subniche';
                    const selectedModel = document.getElementById('niche-model-select')?.value || model;
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ 
                            nichePrincipal, 
                            ideiaInicial, 
                            model: useLaozhang ? null : model,
                            selectedModel: selectedModel
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg);
                    
                    let recommendationContent = data.recommendation;
                    let escapedRec;
                    let contentHtml;

                    // Tentar parsear se for string JSON
                    if (typeof recommendationContent === 'string') {
                        try {
                            const parsed = JSON.parse(recommendationContent);
                            recommendationContent = parsed;
                        } catch (e) {
                            // N√£o √© JSON, manter como string
                        }
                    }

                    if (typeof recommendationContent === 'object' && recommendationContent !== null) {
                        contentHtml = formatNicheRecommendation(recommendationContent);
                        escapedRec = JSON.stringify(recommendationContent, null, 2);
                    } else {
                        recommendationContent = String(recommendationContent);
                        contentHtml = `<div class="prose prose-invert max-w-none"><p class="text-gray-300 whitespace-pre-wrap">${recommendationContent.replace(/\n/g, '<br>')}</p></div>`;
                        escapedRec = recommendationContent.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    }

                    resultsDiv.innerHTML = `
                        <div class="relative">
                            <button title="Copiar Sugest√£o" class="btn-copy absolute top-2 right-2 z-10 p-2 rounded-md hover:bg-gray-800 text-gray-400 hover:text-amber-500 transition" data-copy-text='${escapedRec}'>
                                <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <div class="pr-12">
                                ${contentHtml}
                            </div>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                } catch (err) {
                    showMessage('niche-error-message', err.message, true);
                } finally {
                    setButtonLoading(btn, false);
                    loading.style.display = 'none';
                }
            });

            analyzeCompetitorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-analyze-competitor');
                const loading = document.getElementById('competitor-loading');
                const resultsDiv = document.getElementById('competitor-analysis-results');

                setButtonLoading(btn, true);
                loading.style.display = 'block';
                resultsDiv.innerHTML = '';
                showMessage('niche-error-message', '', true);

                const competitorUrl = document.getElementById('competitor-url').value;
                const model = document.getElementById('competitor-model-select').value;

                try {
                    // Verificar se laozhang.ai est√° configurada como padr√£o
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Analyze Competitor] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                    }
                    
                    const endpoint = useLaozhang ? '/api/niche/analyze-competitor/laozhang' : '/api/niche/analyze-competitor';
                    const selectedModel = document.getElementById('competitor-model-select')?.value || model;
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ 
                            competitorUrl, 
                            model: useLaozhang ? null : model,
                            selectedModel: selectedModel
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg);

                    // Se a resposta vier com 'analysis' wrapper, extrair
                    const analysisData = data.analysis || data;
                    
                    let html = '';
                    let textToCopy = '';
                    
                    // Formata√ß√£o melhorada para an√°lise de competidor
                    const formatCompetitorAnalysis = (data) => {
                        let html = '<div class="space-y-6">';
                        
                        // Content Strategies
                        if (data.content_strategies) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">üìπ Estrat√©gias de Conte√∫do</h3>
                                    ${data.content_strategies.overview ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Vis√£o Geral:</strong> ${data.content_strategies.overview}</p>` : ''}
                                    ${data.content_strategies.playlist_strategy ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Estrat√©gia de Playlists:</strong> ${data.content_strategies.playlist_strategy}</p>` : ''}
                                    ${data.content_strategies.storytelling ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Storytelling:</strong> ${data.content_strategies.storytelling}</p>` : ''}
                                    ${data.content_strategies.engagement_tactics ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">T√°ticas de Engajamento:</strong> ${data.content_strategies.engagement_tactics}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Title and Thumbnail Patterns
                        if (data.title_and_thumbnail_patterns) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">üé® Padr√µes de T√≠tulos e Thumbnails</h3>
                                    ${data.title_and_thumbnail_patterns.title_patterns ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Padr√µes de T√≠tulos:</strong> ${data.title_and_thumbnail_patterns.title_patterns}</p>` : ''}
                                    ${data.title_and_thumbnail_patterns.thumbnail_patterns ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Padr√µes de Thumbnails:</strong> ${data.title_and_thumbnail_patterns.thumbnail_patterns}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Posting Frequency
                        if (data.posting_frequency) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">üìÖ Frequ√™ncia de Postagem</h3>
                                    ${data.posting_frequency.current_frequency ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Frequ√™ncia Atual:</strong> ${data.posting_frequency.current_frequency}</p>` : ''}
                                    ${data.posting_frequency.recommendation ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Recomenda√ß√£o:</strong> ${data.posting_frequency.recommendation}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Niche and Subniches
                        if (data.niche_and_subniches) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">üéØ Nicho e Subnichos</h3>
                                    ${data.niche_and_subniches.primary_niche ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Nicho Principal:</strong> ${data.niche_and_subniches.primary_niche}</p>` : ''}
                                    ${data.niche_and_subniches.subniches && Array.isArray(data.niche_and_subniches.subniches) ? `
                                        <div>
                                            <strong class="text-white">Subnichos:</strong>
                                            <ul class="list-disc list-inside space-y-1 pl-4 mt-2">
                                                ${data.niche_and_subniches.subniches.map(sub => `<li class="text-gray-300">${sub}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                        
                        // Differentiation Opportunities
                        if (data.differentiation_opportunities) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">üí° Oportunidades de Diferencia√ß√£o</h3>
                                    ${data.differentiation_opportunities.live_interactions ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Intera√ß√µes ao Vivo:</strong> ${data.differentiation_opportunities.live_interactions}</p>` : ''}
                                    ${data.differentiation_opportunities.exclusive_interviews ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Entrevistas Exclusivas:</strong> ${data.differentiation_opportunities.exclusive_interviews}</p>` : ''}
                                    ${data.differentiation_opportunities.collaborations ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Colabora√ß√µes:</strong> ${data.differentiation_opportunities.collaborations}</p>` : ''}
                                    ${data.differentiation_opportunities.content_gaps ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Lacunas de Conte√∫do:</strong> ${data.differentiation_opportunities.content_gaps}</p>` : ''}
                                    ${data.differentiation_opportunities.unique_angles ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">√Çngulos √önicos:</strong> ${data.differentiation_opportunities.unique_angles}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Strategic Recommendations
                        if (data.strategic_recommendations) {
                            html += `
                                <div class="bg-gradient-to-r from-amber-900/30 to-amber-800/20 rounded-lg p-6 border border-amber-700/50">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">üöÄ Recomenda√ß√µes Estrat√©gicas</h3>
                                    ${data.strategic_recommendations.channel_name_suggestions && Array.isArray(data.strategic_recommendations.channel_name_suggestions) ? `
                                        <div class="mb-4">
                                            <strong class="text-white">Sugest√µes de Nome do Canal:</strong>
                                            <ul class="list-disc list-inside space-y-1 pl-4 mt-2">
                                                ${data.strategic_recommendations.channel_name_suggestions.map(name => `<li class="text-gray-300">${name}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${data.strategic_recommendations.first_videos_ideas && Array.isArray(data.strategic_recommendations.first_videos_ideas) ? `
                                        <div class="mb-4">
                                            <strong class="text-white">Ideias para Primeiros V√≠deos:</strong>
                                            <ul class="list-disc list-inside space-y-1 pl-4 mt-2">
                                                ${data.strategic_recommendations.first_videos_ideas.map(idea => `<li class="text-gray-300">${idea}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${data.strategic_recommendations.growth_strategy ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Estrat√©gia de Crescimento:</strong> ${data.strategic_recommendations.growth_strategy}</p>` : ''}
                                    ${data.strategic_recommendations.monetization_opportunities ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Oportunidades de Monetiza√ß√£o:</strong> ${data.strategic_recommendations.monetization_opportunities}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        html += '</div>';
                        return html;
                    };
                    
                    // Usar formata√ß√£o melhorada se os dados seguirem o formato esperado
                    if (analysisData.content_strategies || analysisData.title_and_thumbnail_patterns || analysisData.differentiation_opportunities) {
                        html = formatCompetitorAnalysis(analysisData);
                        textToCopy = JSON.stringify(analysisData, null, 2);
                    } else {
                        // Fallback para formata√ß√£o gen√©rica
                        for (const key in analysisData) {
                            const title = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            html += `<div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700 mb-4"><h3 class="text-xl font-semibold text-amber-400 mb-3">${title}</h3>`;
                            const value = analysisData[key];
                            
                            if (typeof value === 'object' && value !== null) {
                                html += renderObjectAsList(value);
                            } else {
                                html += `<p class="text-gray-300 leading-relaxed">${value}</p>`;
                            }
                            html += '</div>';
                        }
                        textToCopy = JSON.stringify(analysisData, null, 2);
                    }
                    const escapedText = textToCopy.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    
                    resultsDiv.innerHTML = `
                        <div class="relative">
                            <button title="Copiar An√°lise Completa" class="btn-copy absolute top-2 right-2 z-10 p-2 rounded-md hover:bg-gray-800 text-gray-400 hover:text-amber-500 transition" data-copy-text='${escapedText}'>
                                <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <div class="pr-12">
                                ${html}
                            </div>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                } catch (err) {
                    showMessage('niche-error-message', err.message, true);
                } finally {
                    setButtonLoading(btn, false);
                    loading.style.display = 'none';
                }
            });


            // --- L√ìGICA DE LOGOUT ---
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('core_token');
                    window.location.href = 'la-casa-dark-core-auth.html';
                });
            }
            
            // --- L√ìGICA DE COPIAR PARA CLIPBOARD (Event Delegation) ---
            document.body.addEventListener('click', async (e) => {
                const copyBtn = e.target.closest('.btn-copy');
                if (!copyBtn) return;

                const textToCopy = copyBtn.dataset.copyText;
                if (textToCopy) {
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        
                        const originalIcon = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-500"></i>';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        
                        setTimeout(() => {
                            copyBtn.innerHTML = originalIcon;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }, 2000);

                    } catch (err) {
                        console.error('Falha ao copiar texto: ', err);
                        alert('N√£o foi poss√≠vel copiar o texto.');
                    }
                }
            });
            
            // --- FUN√á√ïES DO DASHBOARD INICIAL ---
            function formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toLocaleString('pt-BR');
            }
            
            // Vari√°vel para controlar o intervalo de atualiza√ß√£o autom√°tica
            let dashboardAutoRefreshInterval = null;
            
            // Fun√ß√£o para iniciar atualiza√ß√£o autom√°tica do dashboard
            function startDashboardAutoRefresh() {
                // Limpar intervalo anterior se existir
                if (dashboardAutoRefreshInterval) {
                    clearInterval(dashboardAutoRefreshInterval);
                }
                
                // Atualizar a cada 10 segundos quando a tela de in√≠cio estiver vis√≠vel
                dashboardAutoRefreshInterval = setInterval(() => {
                    const inicioView = document.getElementById('view-inicio');
                    if (inicioView && inicioView.style.display !== 'none') {
                        console.log('[Dashboard] Atualiza√ß√£o autom√°tica...');
                        loadDashboard();
                    }
                }, 10000); // 10 segundos
            }
            
            // Fun√ß√£o para parar atualiza√ß√£o autom√°tica
            function stopDashboardAutoRefresh() {
                if (dashboardAutoRefreshInterval) {
                    clearInterval(dashboardAutoRefreshInterval);
                    dashboardAutoRefreshInterval = null;
                }
            }

            // Fun√ß√£o para carregar saldo de cr√©ditos
            async function loadCreditsBalance() {
                try {
                    console.log('[CR√âDITOS] Carregando saldo de cr√©ditos...');
                    const response = await fetch(`${API_BASE}/api/credits/balance`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) {
                        console.error('[CR√âDITOS] Erro ao carregar saldo:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.error('[CR√âDITOS] Resposta do erro:', errorText);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('[CR√âDITOS] Saldo recebido:', data);
                    const creditsBalanceEl = document.getElementById('stat-credits-balance');
                    if (creditsBalanceEl) {
                        creditsBalanceEl.textContent = parseFloat(data.balance || 0).toFixed(2);
                        console.log('[CR√âDITOS] Saldo atualizado no elemento:', parseFloat(data.balance || 0).toFixed(2));
                    } else {
                        console.error('[CR√âDITOS] Elemento stat-credits-balance n√£o encontrado!');
                    }
                    
                    // Atualizar tamb√©m no sidebar se existir
                    const sidebarCreditsEl = document.getElementById('sidebar-user-credits-balance');
                    if (sidebarCreditsEl) {
                        sidebarCreditsEl.textContent = parseFloat(data.balance || 0).toFixed(2);
                    }
                    
                    // Carregar armazenamento se dispon√≠vel
                    if (data.storageUsed !== undefined && data.storageLimit !== undefined) {
                        updateStorageDisplay(data.storageUsed, data.storageLimit);
                        updateSidebarStorage(data.storageUsed, data.storageLimit);
                    }
                } catch (err) {
                    console.error('[CR√âDITOS] Erro ao carregar saldo de cr√©ditos:', err);
                }
            }
            
            // Fun√ß√£o para atualizar exibi√ß√£o de armazenamento
            function updateStorageDisplay(used, limit) {
                const usedMB = (used / (1024 * 1024)).toFixed(2);
                const limitMB = (limit / (1024 * 1024)).toFixed(0);
                const limitGB = (limit / (1024 * 1024 * 1024)).toFixed(1);
                const percentage = Math.min((used / limit) * 100, 100);
                
                const storageUsedEl = document.getElementById('stat-storage-used');
                const storageLimitEl = document.getElementById('stat-storage-limit');
                const storageProgressEl = document.getElementById('stat-storage-progress');
                const storagePercentageEl = document.getElementById('stat-storage-percentage');
                
                if (storageUsedEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        // Mostrar em GB se for >= 1GB
                        storageUsedEl.textContent = `${(used / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                    } else {
                        storageUsedEl.textContent = `${usedMB} MB`;
                    }
                }
                
                if (storageLimitEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        storageLimitEl.textContent = `de ${limitGB} GB`;
                    } else {
                        storageLimitEl.textContent = `de ${limitMB} MB`;
                    }
                }
                
                if (storageProgressEl) {
                    storageProgressEl.style.width = `${percentage}%`;
                    // Mudar cor baseado no uso
                    if (percentage >= 90) {
                        storageProgressEl.className = 'bg-red-500 h-2 rounded-full transition-all duration-300';
                    } else if (percentage >= 70) {
                        storageProgressEl.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
                    } else {
                        storageProgressEl.className = 'bg-indigo-500 h-2 rounded-full transition-all duration-300';
                    }
                }
                
                if (storagePercentageEl) {
                    storagePercentageEl.textContent = `${percentage.toFixed(1)}% usado`;
                }
            }
            
            // Fun√ß√£o para atualizar armazenamento no sidebar
            function updateSidebarStorage(used, limit) {
                const usedMB = (used / (1024 * 1024)).toFixed(2);
                const limitMB = (limit / (1024 * 1024)).toFixed(0);
                const limitGB = (limit / (1024 * 1024 * 1024)).toFixed(1);
                const percentage = Math.min((used / limit) * 100, 100);
                
                const sidebarUsedEl = document.getElementById('sidebar-storage-used');
                const sidebarLimitEl = document.getElementById('sidebar-storage-limit');
                const sidebarProgressEl = document.getElementById('sidebar-storage-progress');
                
                if (sidebarUsedEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        sidebarUsedEl.textContent = `${(used / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                    } else {
                        sidebarUsedEl.textContent = `${usedMB} MB`;
                    }
                }
                
                if (sidebarLimitEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        sidebarLimitEl.textContent = `de ${limitGB} GB`;
                    } else {
                        sidebarLimitEl.textContent = `de ${limitMB} MB`;
                    }
                }
                
                if (sidebarProgressEl) {
                    sidebarProgressEl.style.width = `${percentage}%`;
                    if (percentage >= 90) {
                        sidebarProgressEl.className = 'bg-red-500 h-1.5 rounded-full transition-all duration-300';
                    } else if (percentage >= 70) {
                        sidebarProgressEl.className = 'bg-yellow-500 h-1.5 rounded-full transition-all duration-300';
                    } else {
                        sidebarProgressEl.className = 'bg-indigo-500 h-1.5 rounded-full transition-all duration-300';
                    }
                }
            }
            
            // Fun√ß√£o para carregar hist√≥rico de cr√©ditos
            async function loadCreditsHistory() {
                try {
                    const response = await fetch(`${API_BASE}/api/credits/transactions`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) throw new Error('Erro ao carregar hist√≥rico');
                    
                    const data = await response.json();
                    const transactions = data.data || [];
                    
                    // Criar modal com hist√≥rico
                    const modalHtml = `
                        <div id="credits-history-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-white">Hist√≥rico de Cr√©ditos</h3>
                                    <button id="close-credits-history-modal" class="text-gray-400 hover:text-white">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <div id="credits-history-list" class="space-y-3">
                                    ${transactions.length === 0 
                                        ? '<p class="text-gray-400 text-center py-8">Nenhuma transa√ß√£o encontrada</p>'
                                        : transactions.map(t => {
                                            const isCredit = t.isCredit || t.transaction_type === 'credit' || t.transaction_type === 'refund' || (t.amount && t.amount > 0);
                                            const amount = Math.abs(parseFloat(t.amount || 0));
                                            const date = new Date(t.created_at);
                                            
                                            // Informa√ß√µes da opera√ß√£o
                                            let operationDetails = '';
                                            if (t.operation) {
                                                const op = t.operation;
                                                operationDetails = `
                                                    <div class="mt-2 pt-2 border-t border-gray-700">
                                                        <div class="flex flex-wrap gap-2 text-xs">
                                                            ${op.typeName ? `<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">${op.typeName}</span>` : ''}
                                                            ${op.model && op.model !== 'N/A' ? `<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded">${op.model}</span>` : ''}
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                            
                                            return `
                                                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition">
                                                    <div class="flex justify-between items-start">
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span class="text-lg font-bold ${isCredit ? 'text-green-400' : 'text-red-400'}">
                                                                    ${isCredit ? '+' : '-'} ${amount.toFixed(2)} cr√©ditos
                                                                </span>
                                                                ${isCredit 
                                                                    ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded">Cr√©dito</span>'
                                                                    : '<span class="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded">D√©bito</span>'
                                                                }
                                                            </div>
                                                            <p class="text-white font-medium mb-1">${t.description || 'Transa√ß√£o'}</p>
                                                            ${operationDetails}
                                                            <p class="text-gray-500 text-xs mt-2">
                                                                <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                                                ${date.toLocaleString('pt-BR', { 
                                                                    day: '2-digit', 
                                                                    month: '2-digit', 
                                                                    year: 'numeric',
                                                                    hour: '2-digit',
                                                                    minute: '2-digit'
                                                                })}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    document.getElementById('close-credits-history-modal')?.addEventListener('click', () => {
                        document.getElementById('credits-history-modal')?.remove();
                    });
                } catch (error) {
                    console.error('Erro ao carregar hist√≥rico:', error);
                }
            }
            
            // Event listener para ver hist√≥rico de cr√©ditos
            const viewCreditsHistoryBtn = document.getElementById('view-credits-history-btn');
            if (viewCreditsHistoryBtn) {
                viewCreditsHistoryBtn.addEventListener('click', async () => {
                    await loadCreditsHistory();
                });
            }
            
            // Event listeners para bot√µes de comprar cr√©ditos
            const sidebarBuyCreditsBtn = document.getElementById('sidebar-buy-credits-btn');
            if (sidebarBuyCreditsBtn) {
                sidebarBuyCreditsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Simplesmente redirecionar - a p√°gina de planos far√° a verifica√ß√£o se necess√°rio
                    console.log('Redirecionando para p√°gina de planos...');
                    window.location.href = '/plans.html#pacotes';
                });
            }
            
            const mainBuyCreditsBtn = document.getElementById('main-buy-credits-btn');
            if (mainBuyCreditsBtn) {
                mainBuyCreditsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Simplesmente redirecionar - a p√°gina de planos far√° a verifica√ß√£o se necess√°rio
                    console.log('Redirecionando para p√°gina de planos...');
                    window.location.href = '/plans.html#pacotes';
                });
            }
            
            // Event listener para hist√≥rico no sidebar
            const sidebarViewCreditsHistory = document.getElementById('sidebar-view-credits-history');
            if (sidebarViewCreditsHistory) {
                sidebarViewCreditsHistory.addEventListener('click', async () => {
                    await loadCreditsHistory();
                });
            }
            

            async function loadDashboard() {
                try {
                    const response = await fetch(`${API_BASE}/api/analytics/dashboard`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) {
                        console.error('Erro ao carregar dashboard:', response.status);
                        return;
                    }
                    
                    const data = await response.json();
                    
                    // Atualizar estat√≠sticas principais (com verifica√ß√£o de exist√™ncia)
                    const statTotalVideos = document.getElementById('stat-total-videos');
                    const statTotalViews = document.getElementById('stat-total-views');
                    const statTotalRevenue = document.getElementById('stat-total-revenue');
                    const statViralVideos = document.getElementById('stat-viral-videos');
                    
                    if (statTotalVideos) statTotalVideos.textContent = formatNumber(data.stats.totalVideos || 0);
                    if (statTotalViews) statTotalViews.textContent = formatNumber(data.stats.totalViews || 0);
                    if (statTotalRevenue) statTotalRevenue.textContent = '$' + formatNumber(Math.round(data.stats.totalRevenue || 0));
                    if (statViralVideos) statViralVideos.textContent = formatNumber(data.stats.viralVideos || 0);
                    
                    // Carregar saldo de cr√©ditos
                    loadCreditsBalance();
                    
                    // Atualizar m√©tricas adicionais (com verifica√ß√£o de exist√™ncia)
                    const statAvgCtr = document.getElementById('stat-avg-ctr');
                    const statTotalLikes = document.getElementById('stat-total-likes');
                    const statTotalComments = document.getElementById('stat-total-comments');
                    const statAvgRpm = document.getElementById('stat-avg-rpm');
                    
                    if (statAvgCtr) statAvgCtr.textContent = (data.stats.avgCtr || 0).toFixed(1) + '%';
                    if (statTotalLikes) statTotalLikes.textContent = formatNumber(data.stats.totalLikes || 0);
                    if (statTotalComments) statTotalComments.textContent = formatNumber(data.stats.totalComments || 0);
                    if (statAvgRpm) statAvgRpm.textContent = '$' + (data.stats.rpmUSD || 0).toFixed(2);
                    
                    // Carregar v√≠deos recentes
                    loadRecentVideos(data.recentVideos || []);
                    
                    // Carregar atividade recente
                    loadRecentActivity(data);
                    
                    // Gerar dicas da IA
                    generateAITips(data);
                    
                    // Gerar pr√≥ximos passos
                    generateNextSteps(data);
                    
                } catch (err) {
                    console.error('Erro ao carregar dashboard:', err);
                }
            }

            function loadRecentVideos(videos) {
                const container = document.getElementById('recent-videos');
                if (!container) return;
                
                if (!videos || videos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i data-lucide="video-off" class="w-12 h-12 mx-auto mb-3 text-gray-600"></i>
                            <p class="text-sm">Nenhum v√≠deo encontrado ainda.</p>
                            <p class="text-xs mt-2 text-gray-500">Comece analisando v√≠deos virais para ver suas estat√≠sticas aqui.</p>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }
                
                const videosHtml = videos.slice(0, 5).map(video => {
                    const views = formatNumber(video.actual_views || 0);
                    const ctr = (video.actual_ctr || 0).toFixed(1);
                    const revenue = video.revenue_estimate ? '$' + formatNumber(Math.round(video.revenue_estimate)) : 'N/A';
                    const channelName = video.channel_name || 'Canal Desconhecido';
                    
                    return `
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-amber-500/50 transition-colors">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-white font-semibold mb-2 line-clamp-2">${(video.title_used || 'Sem t√≠tulo').substring(0, 60)}${(video.title_used || '').length > 60 ? '...' : ''}</h4>
                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-400">
                                        <span><i data-lucide="eye" class="w-3 h-3 inline mr-1"></i>${views} views</span>
                                        <span><i data-lucide="trending-up" class="w-3 h-3 inline mr-1"></i>${ctr}% CTR</span>
                                        <span><i data-lucide="dollar-sign" class="w-3 h-3 inline mr-1"></i>${revenue}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">${channelName}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = videosHtml;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function loadRecentActivity(data) {
                const container = document.getElementById('recent-activity');
                if (!container) return;
                
                const activities = [];
                
                if (data.stats.totalVideos > 0) {
                    activities.push({
                        icon: 'video',
                        text: `${data.stats.totalVideos} v√≠deo${data.stats.totalVideos > 1 ? 's' : ''} analisado${data.stats.totalVideos > 1 ? 's' : ''}`,
                        time: 'Total'
                    });
                }
                
                if (data.stats.viralVideos > 0) {
                    activities.push({
                        icon: 'trending-up',
                        text: `${data.stats.viralVideos} v√≠deo${data.stats.viralVideos > 1 ? 's' : ''} viral${data.stats.viralVideos > 1 ? 'is' : ''} (1M+ views)`,
                        time: 'Destaque'
                    });
                }
                
                if (data.stats.totalViews > 0) {
                    activities.push({
                        icon: 'eye',
                        text: `${formatNumber(data.stats.totalViews)} views acumuladas`,
                        time: 'Total'
                    });
                }
                
                if (data.stats.totalRevenue > 0) {
                    activities.push({
                        icon: 'dollar-sign',
                        text: `$${formatNumber(data.stats.totalRevenue)} em receita estimada`,
                        time: 'Total'
                    });
                }
                
                if (activities.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-4">
                            <i data-lucide="activity" class="w-8 h-8 mx-auto mb-2 text-gray-600"></i>
                            <p class="text-sm">Nenhuma atividade ainda.</p>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }
                
                const activitiesHtml = activities.map(activity => `
                    <div class="flex items-center space-x-3 p-3 bg-gray-800 rounded-lg">
                        <div class="p-2 bg-amber-500/20 rounded-lg">
                            <i data-lucide="${activity.icon}" class="w-4 h-4 text-amber-500"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-white">${activity.text}</p>
                            <p class="text-xs text-gray-400">${activity.time}</p>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = activitiesHtml;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            async function generateAITips(data) {
                const container = document.getElementById('ai-tips');
                if (!container) return;
                
                const tips = [];
                const stats = data.stats || {};
                const recentVideos = data.recentVideos || [];
                
                // === AN√ÅLISE DE PERFORMANCE GERAL ===
                if (stats.totalVideos === 0) {
                    tips.push({
                        type: 'info',
                        icon: 'lightbulb',
                        title: 'üöÄ Comece Sua Jornada Viral',
                        text: 'Voc√™ ainda n√£o analisou nenhum v√≠deo. Use o Analisador de V√≠deos para descobrir os segredos por tr√°s de v√≠deos que geraram milh√µes de views. Analise pelo menos 5-10 v√≠deos virais do seu nicho para entender os padr√µes de sucesso.'
                    });
                } else if (stats.totalVideos < 5) {
                    tips.push({
                        type: 'success',
                        icon: 'rocket',
                        title: 'üìà Bom Come√ßo! Continue Acelerando',
                        text: `Voc√™ j√° analisou ${stats.totalVideos} v√≠deo${stats.totalVideos > 1 ? 's' : ''}. Para maximizar seus resultados, analise pelo menos 10 v√≠deos virais do seu nicho. Isso ajudar√° a IA a entender melhor os padr√µes de sucesso e gerar t√≠tulos mais precisos.`
                    });
                } else if (stats.totalVideos < 20) {
                    tips.push({
                        type: 'success',
                        icon: 'trending-up',
                        title: 'üí™ Voc√™ Est√° no Caminho Certo!',
                        text: `Excelente! Voc√™ j√° analisou ${stats.totalVideos} v√≠deos. Analise mais 10-15 v√≠deos para criar uma base s√≥lida de dados. Quanto mais v√≠deos voc√™ analisar, mais precisas ser√£o as recomenda√ß√µes da IA.`
                    });
                }
                
                // === AN√ÅLISE DE CTR DETALHADA ===
                if (stats.avgCtr > 0) {
                    if (stats.avgCtr < 3) {
                        tips.push({
                            type: 'warning',
                            icon: 'alert-triangle',
                            title: '‚ö†Ô∏è CTR Cr√≠tico: A√ß√£o Imediata Necess√°ria',
                            text: `Seu CTR m√©dio √© ${stats.avgCtr.toFixed(1)}%, que est√° MUITO abaixo do ideal (10%+). A√ß√µes urgentes: 1) Use t√≠tulos com n√∫meros e perguntas, 2) Thumbnails com rostos humanos e express√µes intensas, 3) Palavras poderosas como "SECRETO", "REVELADO", "PROIBIDO", 4) Teste A/B com 5-10 varia√ß√µes antes de publicar.`
                        });
                    } else if (stats.avgCtr < 5) {
                        tips.push({
                            type: 'warning',
                            icon: 'alert-circle',
                            title: 'üìä CTR Pode Melhorar Significativamente',
                            text: `Seu CTR m√©dio √© ${stats.avgCtr.toFixed(1)}% (meta: 10%+). Estrat√©gias: 1) T√≠tulos entre 40-60 caracteres com n√∫meros, 2) Thumbnails com alto contraste e cores vibrantes, 3) Use a fun√ß√£o "Valida√ß√£o de T√≠tulo" antes de publicar, 4) Analise seus v√≠deos de maior CTR e replique os padr√µes.`
                        });
                    } else if (stats.avgCtr < 8) {
                        tips.push({
                            type: 'info',
                            icon: 'target',
                            title: 'üéØ CTR Bom, Mas Pode Ser Excelente',
                            text: `Seu CTR de ${stats.avgCtr.toFixed(1)}% est√° acima da m√©dia do YouTube (2-3%), mas pode chegar a 10-15%+. Foque em: 1) Thumbnails com texto grande e leg√≠vel, 2) T√≠tulos que geram curiosidade extrema, 3) Teste diferentes hor√°rios de publica√ß√£o, 4) Use a Biblioteca Virais para estudar t√≠tulos que geraram CTR alto.`
                        });
                    } else if (stats.avgCtr >= 10) {
                        tips.push({
                            type: 'success',
                            icon: 'award',
                            title: 'üèÜ CTR Excepcional! Voc√™ √© um Expert',
                            text: `Parab√©ns! Seu CTR m√©dio de ${stats.avgCtr.toFixed(1)}% est√° no TOP 5% dos criadores. Continue: 1) Documente o que funciona nos seus v√≠deos de maior CTR, 2) Replique essas estrat√©gias, 3) Experimente nichos com RPM mais alto para maximizar receita, 4) Compartilhe suas estrat√©gias com a comunidade.`
                        });
                    }
                }
                
                // === AN√ÅLISE DE RECEITA E MONETIZA√á√ÉO ===
                if (stats.totalRevenue > 0) {
                    const revenuePerVideo = stats.totalRevenue / stats.totalVideos;
                    const viewsPerVideo = stats.totalViews / stats.totalVideos;
                    const rpm = stats.rpmUSD || 0;
                    
                    if (revenuePerVideo < 10) {
                        tips.push({
                            type: 'info',
                            icon: 'dollar-sign',
                            title: 'üí∞ Potencial de Monetiza√ß√£o',
                            text: `Voc√™ est√° gerando $${revenuePerVideo.toFixed(2)} por v√≠deo em m√©dia. Para aumentar: 1) Foque em nichos com RPM alto (Finan√ßas: $15-18, Tech: $7-8), 2) Aumente o CTR para ter mais views, 3) Publique mais frequentemente, 4) Use a fun√ß√£o "ROI Calculator" para acompanhar seu retorno.`
                        });
                    } else if (revenuePerVideo < 50) {
                        tips.push({
                            type: 'success',
                            icon: 'trending-up',
                            title: 'üíµ Receita Crescendo Bem',
                            text: `Excelente! Voc√™ est√° gerando $${revenuePerVideo.toFixed(2)} por v√≠deo. Para escalar: 1) Analise seus v√≠deos de maior receita e replique, 2) Considere nichos com RPM mais alto, 3) Publique 2-3x por semana, 4) Use o Heatmap de Sucesso para identificar f√≥rmulas que geram mais receita.`
                        });
                    } else {
                        tips.push({
                            type: 'success',
                            icon: 'zap',
                            title: 'üöÄ Receita Excelente! Continue Escalando',
                            text: `Impressionante! $${revenuePerVideo.toFixed(2)} por v√≠deo √© um resultado excepcional. Estrat√©gias avan√ßadas: 1) Automatize publica√ß√£o com Integra√ß√£o YouTube, 2) Crie s√©ries de v√≠deos para aumentar reten√ß√£o, 3) Explore afiliados e sponsorships, 4) Use o Leaderboard para identificar seus melhores t√≠tulos/thumbnails.`
                        });
                    }
                    
                    // An√°lise de RPM
                    if (rpm > 0) {
                        if (rpm < 3) {
                            tips.push({
                                type: 'info',
                                icon: 'arrow-up',
                                title: 'üìà Seu RPM Pode Aumentar',
                                text: `Seu RPM atual √© $${rpm.toFixed(2)}. Para aumentar: 1) Considere nichos com RPM mais alto (Finan√ßas: $15-18, Investimentos: $18+), 2) Melhore a reten√ß√£o do p√∫blico (v√≠deos mais longos e engajantes), 3) Publique em hor√°rios de pico, 4) Use SEO otimizado para atrair audi√™ncia de maior valor.`
                            });
                        } else if (rpm >= 10) {
                            tips.push({
                                type: 'success',
                                icon: 'star',
                                title: '‚≠ê RPM Premium! Voc√™ Est√° em Nicho Lucrativo',
                                text: `Seu RPM de $${rpm.toFixed(2)} indica que voc√™ est√° em um nicho de alto valor. Continue: 1) Mantenha a qualidade do conte√∫do, 2) Publique consistentemente, 3) Construa autoridade no nicho, 4) Explore oportunidades de monetiza√ß√£o adicional (afiliados, produtos digitais).`
                            });
                        }
                    }
                } else if (stats.totalViews > 0) {
                    tips.push({
                        type: 'info',
                        icon: 'dollar-sign',
                        title: 'üí° Ative o Rastreamento de Receita',
                        text: `Voc√™ tem ${formatNumber(stats.totalViews)} views, mas n√£o est√° rastreando receita. V√° em Analytics > Registrar Novo V√≠deo e registre seus v√≠deos publicados para ver quanto dinheiro voc√™ est√° gerando. Isso ajudar√° a identificar quais t√≠tulos/thumbnails geram mais receita.`
                    });
                }
                
                // === AN√ÅLISE DE ENGAGEMENT ===
                if (stats.totalViews > 0 && stats.totalLikes > 0) {
                    const likesPerView = (stats.totalLikes / stats.totalViews) * 100;
                    const commentsPerView = (stats.totalComments / stats.totalViews) * 100;
                    
                    if (likesPerView < 1) {
                        tips.push({
                            type: 'warning',
                            icon: 'thumbs-down',
                            title: 'üëé Engajamento Baixo: Melhore o Conte√∫do',
                            text: `Apenas ${likesPerView.toFixed(2)}% dos viewers est√£o dando like. Isso indica que o conte√∫do n√£o est√° entregando o que o t√≠tulo/thumbnail promete. A√ß√µes: 1) Alinhe t√≠tulo/thumbnail com o conte√∫do, 2) Melhore a qualidade do v√≠deo, 3) Adicione CTAs para like/compartilhar, 4) Analise coment√°rios para entender o que o p√∫blico quer.`
                        });
                    } else if (likesPerView >= 3) {
                        tips.push({
                            type: 'success',
                            icon: 'thumbs-up',
                            title: 'üëç Engajamento Excelente!',
                            text: `Parab√©ns! ${likesPerView.toFixed(2)}% de taxa de likes √© excepcional. Seu conte√∫do est√° entregando valor. Continue: 1) Replique o formato dos v√≠deos com maior engajamento, 2) Crie s√©ries baseadas nesses v√≠deos, 3) Use os coment√°rios para gerar novos v√≠deos, 4) Compartilhe esses v√≠deos em outras plataformas.`
                        });
                    }
                    
                    if (commentsPerView < 0.1) {
                        tips.push({
                            type: 'info',
                            icon: 'message-square',
                            title: 'üí¨ Aumente Coment√°rios para Mais Engajamento',
                            text: `Apenas ${commentsPerView.toFixed(3)}% dos viewers est√£o comentando. Para aumentar: 1) Fa√ßa perguntas no v√≠deo, 2) Pe√ßa opini√µes nos coment√°rios, 3) Responda todos os coment√°rios, 4) Crie pol√™mica saud√°vel, 5) Use finais que geram discuss√£o.`
                        });
                    }
                }
                
                // === AN√ÅLISE DE V√çDEOS VIRAIS ===
                if (stats.viralVideos > 0) {
                    const viralRate = (stats.viralVideos / stats.totalVideos) * 100;
                    tips.push({
                        type: 'success',
                        icon: 'zap',
                        title: '‚ö° Voc√™ Tem V√≠deos Virais!',
                        text: `Voc√™ tem ${stats.viralVideos} v√≠deo${stats.viralVideos > 1 ? 's' : ''} com 1M+ views (${viralRate.toFixed(1)}% de taxa viral). A√ß√µes estrat√©gicas: 1) Analise profundamente esses v√≠deos na Biblioteca, 2) Identifique padr√µes (t√≠tulo, thumbnail, nicho, hor√°rio), 3) Replique a f√≥rmula, 4) Crie s√©ries baseadas nesses v√≠deos, 5) Use o Score Predictor antes de publicar novos v√≠deos.`
                    });
                } else if (stats.totalVideos >= 10) {
                    tips.push({
                        type: 'info',
                        icon: 'target',
                        title: 'üéØ Estrat√©gia para Viralizar',
                        text: `Voc√™ j√° tem ${stats.totalVideos} v√≠deos, mas nenhum viral ainda. Estrat√©gias: 1) Analise v√≠deos que viralizaram no seu nicho usando o Analisador, 2) Use t√≠tulos com pontua√ß√£o 9+ da IA, 3) Foque em nichos com maior potencial viral, 4) Publique em hor√°rios de pico (ter√ßa-quinta, 14h-16h), 5) Use o Heatmap de Sucesso para identificar f√≥rmulas que funcionam.`
                    });
                }
                
                // === AN√ÅLISE DE PERFORMANCE POR V√çDEO ===
                if (recentVideos.length > 0) {
                    const topVideo = recentVideos.reduce((max, v) => (v.actual_views || 0) > (max.actual_views || 0) ? v : max, recentVideos[0]);
                    const avgViewsPerVideo = stats.totalViews / stats.totalVideos;
                    
                    if (topVideo && topVideo.actual_views > avgViewsPerVideo * 2) {
                        tips.push({
                            type: 'success',
                            icon: 'star',
                            title: '‚≠ê Voc√™ Tem um V√≠deo Destaque!',
                            text: `"${(topVideo.title_used || 'Sem t√≠tulo').substring(0, 50)}..." tem ${formatNumber(topVideo.actual_views)} views, muito acima da sua m√©dia. Analise: 1) Qual foi o t√≠tulo usado? 2) Qual foi a thumbnail? 3) Qual foi o nicho? 4) Replique essa f√≥rmula em novos v√≠deos. Use a Biblioteca para salvar esse t√≠tulo/thumbnail como favorito.`
                        });
                    }
                    
                    // An√°lise de CTR por v√≠deo
                    const videosWithHighCtr = recentVideos.filter(v => v.actual_ctr && v.actual_ctr >= 8);
                    if (videosWithHighCtr.length > 0) {
                        tips.push({
                            type: 'success',
                            icon: 'trending-up',
                            title: 'üìä Voc√™ Tem V√≠deos com CTR Alto',
                            text: `${videosWithHighCtr.length} v√≠deo${videosWithHighCtr.length > 1 ? 's' : ''} com CTR acima de 8%. Esses s√£o seus modelos de sucesso! A√ß√µes: 1) Estude esses t√≠tulos/thumbnails na Biblioteca, 2) Use o Gerador de Thumbnails para criar varia√ß√µes, 3) Aplique essas f√≥rmulas em novos v√≠deos, 4) Use o Compara√ß√£o com Competidores para ver como voc√™ se compara.`
                        });
                    }
                }
                
                // === AN√ÅLISE DE CONSIST√äNCIA ===
                if (stats.totalVideos >= 5) {
                    const daysSinceFirst = recentVideos.length > 0 && recentVideos[0].published_at 
                        ? Math.floor((new Date() - new Date(recentVideos[0].published_at)) / (1000 * 60 * 60 * 24))
                        : 0;
                    
                    if (daysSinceFirst > 0) {
                        const videosPerWeek = (stats.totalVideos / (daysSinceFirst / 7));
                        if (videosPerWeek < 1) {
                            tips.push({
                                type: 'warning',
                                icon: 'calendar',
                                title: 'üìÖ Consist√™ncia √© Chave para o Sucesso',
                                text: `Voc√™ est√° publicando menos de 1 v√≠deo por semana. Para crescer no YouTube: 1) Publique pelo menos 2-3x por semana, 2) Use a Integra√ß√£o YouTube para agendar publica√ß√µes, 3) Crie um calend√°rio de conte√∫do, 4) Use o Gerador de Roteiros (em breve) para acelerar a cria√ß√£o.`
                            });
                        } else if (videosPerWeek >= 3) {
                            tips.push({
                                type: 'success',
                                icon: 'check-circle',
                                title: '‚úÖ Excelente Consist√™ncia!',
                                text: `Voc√™ est√° publicando ${videosPerWeek.toFixed(1)} v√≠deos por semana. Isso √© √≥timo! Continue: 1) Mantenha a qualidade mesmo com alta frequ√™ncia, 2) Use automa√ß√£o para economizar tempo, 3) Analise quais dias/hor√°rios performam melhor, 4) Crie templates de t√≠tulos/thumbnails para acelerar.`
                            });
                        }
                    }
                }
                
                // === AN√ÅLISE DE ROI E EFICI√äNCIA ===
                if (stats.totalRevenue > 0 && stats.totalVideos > 0) {
                    const costPerAnalysis = 0.50; // Custo estimado por an√°lise
                    const totalCost = stats.totalVideos * costPerAnalysis;
                    const roi = ((stats.totalRevenue - totalCost) / totalCost) * 100;
                    
                    if (roi > 1000) {
                        tips.push({
                            type: 'success',
                            icon: 'trending-up',
                            title: 'üí∞ ROI Excepcional! Voc√™ Est√° no Caminho Certo',
                            text: `Seu ROI √© de ${roi.toFixed(0)}%! Para cada $1 investido, voc√™ est√° gerando $${(stats.totalRevenue / totalCost).toFixed(2)}. Continue: 1) Aumente o investimento em an√°lises, 2) Escale para mais canais, 3) Automatize o processo, 4) Use o ROI Calculator para acompanhar em tempo real.`
                        });
                    } else if (roi > 0) {
                        tips.push({
                            type: 'info',
                            icon: 'dollar-sign',
                            title: 'üìä ROI Positivo - Continue Investindo',
                            text: `Seu ROI √© de ${roi.toFixed(0)}%. Voc√™ est√° no caminho certo! Para melhorar: 1) Foque em v√≠deos com maior potencial (use Score Predictor), 2) Otimize t√≠tulos/thumbnails antes de publicar, 3) Publique mais frequentemente, 4) Analise nichos com maior RPM.`
                        });
                    }
                }
                
                // === DICAS ESPEC√çFICAS BASEADAS EM PADR√ïES ===
                if (stats.totalVideos >= 3) {
                    const avgViews = stats.totalViews / stats.totalVideos;
                    
                    if (avgViews < 10000) {
                        tips.push({
                            type: 'info',
                            icon: 'eye',
                            title: 'üëÅÔ∏è Potencial de Crescimento',
                            text: `Sua m√©dia de ${formatNumber(avgViews)} views por v√≠deo indica grande potencial. Estrat√©gias: 1) Analise v√≠deos com 100K+ views do seu nicho, 2) Use t√≠tulos com pontua√ß√£o 9+ da IA, 3) Otimize thumbnails para CTR acima de 10%, 4) Publique em hor√°rios de pico, 5) Use SEO otimizado (tags, descri√ß√£o).`
                        });
                    } else if (avgViews >= 100000) {
                        tips.push({
                            type: 'success',
                            icon: 'award',
                            title: 'üèÜ Performance Excepcional!',
                            text: `Sua m√©dia de ${formatNumber(avgViews)} views por v√≠deo est√° no TOP 1% dos criadores. Voc√™ domina o jogo! Pr√≥ximos passos: 1) Escale para m√∫ltiplos canais, 2) Explore monetiza√ß√£o avan√ßada (afiliados, produtos), 3) Construa uma marca pessoal, 4) Use o Leaderboard para identificar seus melhores conte√∫dos.`
                        });
                    }
                }
                
                // === DICAS DE OTIMIZA√á√ÉO T√âCNICA ===
                if (stats.totalVideos > 0) {
                    tips.push({
                        type: 'info',
                        icon: 'settings',
                        title: '‚öôÔ∏è Otimize Antes de Publicar',
                        text: 'Use as ferramentas de valida√ß√£o: 1) Valida√ß√£o de T√≠tulo para garantir que segue melhores pr√°ticas, 2) Valida√ß√£o de Thumbnail para verificar contraste e composi√ß√£o, 3) Score Predictor para prever views antes de publicar, 4) Compara√ß√£o com Competidores para ver como voc√™ se compara. Essas ferramentas aumentam suas chances de sucesso em at√© 300%.'
                    });
                }
                
                // === DICAS DE ESTRAT√âGIA AVAN√áADA ===
                if (stats.totalVideos >= 10) {
                    tips.push({
                        type: 'info',
                        icon: 'brain',
                        title: 'üß† Estrat√©gias Avan√ßadas',
                        text: 'Voc√™ j√° tem experi√™ncia suficiente! Estrat√©gias avan√ßadas: 1) Use o Heatmap de Sucesso para identificar f√≥rmulas que funcionam por nicho, 2) Crie s√©ries de v√≠deos baseadas nos seus maiores sucessos, 3) Use A/B Testing (em breve) para testar varia√ß√µes, 4) Analise tend√™ncias semanais, 5) Construa uma biblioteca pessoal de t√≠tulos/thumbnails virais.'
                    });
                }
                
                // Limitar a 8 dicas mais relevantes para n√£o sobrecarregar
                tips.sort((a, b) => {
                    const priority = { 'warning': 3, 'success': 2, 'info': 1 };
                    return (priority[b.type] || 0) - (priority[a.type] || 0);
                });
                
                const topTips = tips.slice(0, 6); // Reduzir para 6 dicas para layout mais compacto
                
                // Se n√£o houver dicas, adicionar uma padr√£o
                if (topTips.length === 0) {
                    topTips.push({
                        type: 'info',
                        icon: 'sparkles',
                        title: '‚ú® Continue o Bom Trabalho!',
                        text: 'Mantenha a consist√™ncia analisando v√≠deos virais regularmente e testando diferentes estrat√©gias de t√≠tulos e thumbnails. Use todas as ferramentas dispon√≠veis para maximizar seus resultados.'
                    });
                }
                
                // Renderizar dicas de forma mais compacta
                container.innerHTML = '';
                topTips.forEach(tip => {
                    const tipClass = tip.type === 'warning' 
                        ? 'bg-red-900/20 border-red-700/30' 
                        : tip.type === 'success' 
                        ? 'bg-green-900/20 border-green-700/30' 
                        : 'bg-gray-800/40 border-amber-700/20';
                    
                    const iconClass = tip.type === 'warning' 
                        ? 'text-red-400' 
                        : tip.type === 'success' 
                        ? 'text-green-400' 
                        : 'text-amber-400';
                    
                    container.innerHTML += `
                        <div class="${tipClass} rounded-lg p-2.5 border">
                            <div class="flex items-start space-x-2">
                                <i data-lucide="${tip.icon}" class="w-4 h-4 ${iconClass} mt-0.5 flex-shrink-0"></i>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-xs font-semibold text-white mb-1 leading-tight">${tip.title}</h3>
                                    <p class="text-gray-300 text-xs leading-relaxed">${tip.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function generateNextSteps(data) {
                const container = document.getElementById('next-steps');
                if (!container) return;
                
                const steps = [];
                const stats = data.stats || {};
                
                if (stats.totalVideos === 0) {
                    steps.push({
                        icon: 'youtube',
                        text: 'Analise seu primeiro v√≠deo viral usando o Analisador de V√≠deos',
                        action: 'analisador'
                    });
                    steps.push({
                        icon: 'settings',
                        text: 'Configure suas chaves de API (Gemini, Claude, OpenAI) nas Configura√ß√µes',
                        action: 'configuracoes'
                    });
                } else {
                    if (stats.totalVideos < 5) {
                        steps.push({
                            icon: 'youtube',
                            text: `Continue analisando v√≠deos. Voc√™ j√° tem ${stats.totalVideos}, tente chegar a pelo menos 10.`,
                            action: 'analisador'
                        });
                    }
                    
                    if (stats.viralVideos === 0 && stats.totalVideos >= 5) {
                        steps.push({
                            icon: 'trending-up',
                            text: 'Explore novos nichos usando a ferramenta Explorar Nicho para encontrar oportunidades',
                            action: 'explorar-nicho'
                        });
                    }
                    
                    steps.push({
                        icon: 'image',
                        text: 'Gere thumbnails para seus t√≠tulos mais promissores usando o Gerador de Thumbnails',
                        action: 'analisador'
                    });
                    
                    steps.push({
                        icon: 'book',
                        text: 'Organize seus t√≠tulos favoritos na Biblioteca Virais para acesso r√°pido',
                        action: 'biblioteca'
                    });
                }
                
                steps.push({
                    icon: 'bar-chart-3',
                    text: 'Acompanhe o desempenho dos seus v√≠deos na se√ß√£o Analytics',
                    action: 'analytics'
                });
                
                const stepsHtml = steps.map((step, index) => `
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-amber-500/50 transition-colors cursor-pointer" onclick="navigateToView('${step.action}')">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-500 font-bold text-sm">
                                ${index + 1}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <i data-lucide="${step.icon}" class="w-4 h-4 text-amber-500"></i>
                                    <p class="text-white text-sm font-medium">${step.text}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = stepsHtml;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // --- CARREGAMENTO INICIAL ---
            // Garantir que a view 'inicio' est√° vis√≠vel por padr√£o
            const inicioViewOnLoad = document.getElementById('view-inicio');
            if (inicioViewOnLoad) {
                inicioViewOnLoad.style.display = 'block';
                inicioViewOnLoad.classList.add('active'); // Adicionar classe active para o CSS n√£o esconder
            }
            // Esconder todas as outras views e remover classe active
            const allViews = document.querySelectorAll('[id^="view-"]');
            allViews.forEach(view => {
                if (view && view.id !== 'view-inicio') {
                    view.style.display = 'none';
                    view.classList.remove('active');
                }
            });
            
            checkUserRoleAndLoadAdmin();
            loadFolders();
            loadDashboard(); // Carregar dashboard na tela inicial
            startDashboardAutoRefresh(); // Iniciar atualiza√ß√£o autom√°tica do dashboard
            setupAdminListeners();

            // === FUNCIONALIDADES DE ANALYTICS ===
            async function loadAnalytics() {
                console.log('[Analytics] Iniciando carregamento...');
                if (!userToken) {
                    console.error('[Analytics] Token de usu√°rio n√£o encontrado');
                    const errorMsg = document.getElementById('analytics-error-message');
                    if (errorMsg) showMessage('analytics-error-message', 'Token de autentica√ß√£o n√£o encontrado. Por favor, fa√ßa login novamente.', true);
                    return;
                }
                try {
                    console.log('[Analytics] Fazendo requisi√ß√£o para:', `${API_BASE}/api/analytics/dashboard`);
                    const response = await fetch(`${API_BASE}/api/analytics/dashboard`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('[Analytics] Resposta recebida:', response.status, response.statusText);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar analytics: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('[Analytics] Dados recebidos:', data);

                    const totalViewsEl = document.getElementById('stats-total-views');
                    const avgCtrEl = document.getElementById('stats-avg-ctr');
                    const totalRevenueEl = document.getElementById('stats-total-revenue');
                    const viralVideosEl = document.getElementById('stats-viral-videos');

                    if (totalViewsEl) totalViewsEl.textContent = formatNumber(data.stats.totalViews || 0);
                    if (avgCtrEl) avgCtrEl.textContent = (data.stats.avgCtr || 0).toFixed(1) + '%';
                    if (totalRevenueEl) {
                        const revenueUSD = data.stats.totalRevenue || 0;
                        totalRevenueEl.textContent = '$' + formatNumber(Math.round(revenueUSD));
                    }
                    const totalRevenueBrlEl = document.getElementById('stats-total-revenue-brl');
                    if (totalRevenueBrlEl) {
                        const revenueUSD = data.stats.totalRevenue || 0;
                        const revenueBRL = revenueUSD * 5.50; // Taxa de c√¢mbio USD para BRL
                        totalRevenueBrlEl.textContent = 'R$ ' + formatNumber(Math.round(revenueBRL));
                    }
                    const rpmEl = document.getElementById('stats-rpm');
                    if (rpmEl) rpmEl.textContent = `RPM: $${(data.stats.rpmUSD || 0).toFixed(2)} / R$ ${(data.stats.rpmBRL || 0).toFixed(2)}`;
                    if (viralVideosEl) viralVideosEl.textContent = data.stats.viralVideos || 0;

                    const videosList = document.getElementById('analytics-videos-list');
                    if (videosList) {
                        if (data.recentVideos && data.recentVideos.length > 0) {
                            videosList.innerHTML = data.recentVideos.map(video => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-white font-semibold mb-1">${escapeHtml(video.title_used || 'Sem t√≠tulo')}</h3>
                                        <p class="text-gray-400 text-sm mb-1">${formatNumber(parseInt(video.actual_views || 0))} views ‚Ä¢ CTR: ${(parseFloat(video.actual_ctr || 0)).toFixed(1)}%</p>
                                        <p class="text-gray-400 text-xs mb-1">Receita: $${formatNumber(Math.round(parseFloat(video.revenue_estimate || 0)))} / R$ ${formatNumber(Math.round(parseFloat(video.revenue_estimate || 0) * 5.50))}</p>
                                        ${video.channel_name ? `<p class="text-blue-400 text-xs mb-1">Canal: ${escapeHtml(video.channel_name)}</p>` : ''}
                                        ${video.youtube_video_id ? `<a href="https://www.youtube.com/watch?v=${video.youtube_video_id}" target="_blank" class="text-amber-500 hover:text-amber-400 text-xs">Ver no YouTube</a>` : ''}
                                        ${video.published_at ? `<p class="text-gray-500 text-xs mt-1">Publicado: ${new Date(video.published_at).toLocaleDateString('pt-BR')}</p>` : ''}
                                    </div>
                                    <div class="flex items-center gap-2 ml-4">
                                        <button onclick="updateVideoMetrics(${video.id})" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black rounded-lg font-bold text-sm" title="Atualizar m√©tricas">
                                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="deleteVideoTracking(${video.id})" class="py-2 px-4 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold text-sm" title="Excluir do tracking">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            videosList.innerHTML = '<p class="text-gray-400">Nenhum v√≠deo trackado ainda.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar analytics:', err);
                    const errorMsg = document.getElementById('analytics-error-message');
                    if (errorMsg) {
                        showMessage('analytics-error-message', err.message || 'Erro ao carregar analytics. Verifique o console para mais detalhes.', true);
                    }
                    // Mesmo com erro, mostrar interface vazia
                    const totalViewsEl = document.getElementById('stats-total-views');
                    const avgCtrEl = document.getElementById('stats-avg-ctr');
                    const totalRevenueEl = document.getElementById('stats-total-revenue');
                    const viralVideosEl = document.getElementById('stats-viral-videos');
                    if (totalViewsEl) totalViewsEl.textContent = '0';
                    if (avgCtrEl) avgCtrEl.textContent = '0%';
                    if (totalRevenueEl) totalRevenueEl.textContent = '$0';
                    if (viralVideosEl) viralVideosEl.textContent = '0';
                }
            }

            window.updateVideoMetrics = async function(trackingId) {
                try {
                    const response = await fetch(`${API_BASE}/api/analytics/update/${trackingId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar m√©tricas.');
                    showMessage('analytics-success-message', 'M√©tricas atualizadas com sucesso!');
                    await loadAnalytics();
                    // Atualizar dashboard se estiver vis√≠vel
                    refreshDashboardIfVisible();
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            window.deleteVideoTracking = async function(trackingId) {
                if (!confirm('Tem certeza que deseja excluir este v√≠deo do tracking? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/api/analytics/track/${trackingId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || 'Falha ao excluir v√≠deo.');
                    }
                    showMessage('analytics-success-message', 'V√≠deo exclu√≠do do tracking com sucesso!');
                    await loadAnalytics();
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            // === GERENCIAMENTO DE CANAIS ===
            let currentEditingChannelId = null;

            async function loadChannels() {
                try {
                    const response = await fetch(`${API_BASE}/api/channels`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar canais.');
                    const channels = await response.json();
                    
                    const channelsList = document.getElementById('channels-list');
                    const channelSelect = document.getElementById('register-video-channel');
                    
                    if (channelsList) {
                        if (channels.length > 0) {
                            channelsList.innerHTML = channels.map(channel => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-white font-semibold">${escapeHtml(channel.channel_name)}</h3>
                                        <p class="text-gray-400 text-sm">${escapeHtml(channel.niche || 'Sem nicho')} ‚Ä¢ ${escapeHtml(channel.language || 'pt-BR')} ‚Ä¢ ${escapeHtml(channel.country || 'BR')}</p>
                                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded ${channel.is_active ? 'bg-green-600' : 'bg-gray-600'}">${channel.is_active ? 'Ativo' : 'Inativo'}</span>
                                    </div>
                                    <div class="flex items-center gap-2 ml-4">
                                        <button onclick="editChannel(${channel.id})" class="p-2 text-blue-400 hover:text-blue-300" title="Editar canal">
                                            <i data-lucide="edit"></i>
                                        </button>
                                        <button onclick="toggleChannelStatus(${channel.id}, ${channel.is_active})" class="p-2 ${channel.is_active ? 'text-yellow-400' : 'text-green-400'} hover:opacity-80" title="${channel.is_active ? 'Desativar' : 'Ativar'}">
                                            <i data-lucide="${channel.is_active ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button onclick="deleteChannel(${channel.id})" class="p-2 text-red-600 hover:text-red-500" title="Excluir canal">
                                            <i data-lucide="trash-2"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            channelsList.innerHTML = '<p class="text-gray-400">Nenhum canal cadastrado. Adicione um canal para organizar seus v√≠deos por nicho e idioma.</p>';
                        }
                    }

                    if (channelSelect) {
                        channelSelect.innerHTML = '<option value="">Selecione um canal (opcional)</option>' + 
                            channels.filter(c => c.is_active).map(channel => 
                                `<option value="${channel.id}">${escapeHtml(channel.channel_name)}</option>`
                            ).join('');
                    }
                } catch (err) {
                    console.error('Erro ao carregar canais:', err);
                }
            }

            window.showAddChannelModal = function() {
                currentEditingChannelId = null;
                document.getElementById('channel-modal-title').textContent = 'Adicionar Canal';
                document.getElementById('channel-form').reset();
                document.getElementById('channel-modal').classList.remove('hidden');
                document.getElementById('channel-modal').classList.add('flex');
            };

            window.hideChannelModal = function() {
                document.getElementById('channel-modal').classList.add('hidden');
                document.getElementById('channel-modal').classList.remove('flex');
                currentEditingChannelId = null;
            };

            window.editChannel = async function(channelId) {
                try {
                    const response = await fetch(`${API_BASE}/api/channels`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar canais.');
                    const channels = await response.json();
                    const channel = channels.find(c => c.id === channelId);
                    if (!channel) throw new Error('Canal n√£o encontrado.');
                    
                    currentEditingChannelId = channelId;
                    document.getElementById('channel-modal-title').textContent = 'Editar Canal';
                    document.getElementById('channel-name').value = channel.channel_name;
                    document.getElementById('channel-url').value = channel.channel_url || '';
                    document.getElementById('channel-niche').value = channel.niche || '';
                    document.getElementById('channel-language').value = channel.language || 'pt-BR';
                    document.getElementById('channel-country').value = channel.country || 'BR';
                    document.getElementById('channel-modal').classList.remove('hidden');
                    document.getElementById('channel-modal').classList.add('flex');
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            window.toggleChannelStatus = async function(channelId, currentStatus) {
                try {
                    const response = await fetch(`${API_BASE}/api/channels/${channelId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isActive: !currentStatus })
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar status do canal.');
                    await loadChannels();
                    await loadAnalytics();
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            window.deleteChannel = async function(channelId) {
                if (!confirm('Tem certeza que deseja excluir este canal? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/api/channels/${channelId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao excluir canal.');
                    await loadChannels();
                    await loadAnalytics();
                    showMessage('analytics-success-message', 'Canal exclu√≠do com sucesso!');
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            // Auto-preenchimento de canal ao digitar URL (usando event delegation para funcionar quando modal abrir)
            let channelUrlTimeout;
            document.addEventListener('input', (e) => {
                if (e.target.id === 'channel-url') {
                    clearTimeout(channelUrlTimeout);
                    const url = e.target.value.trim();
                    if (url && url.includes('youtube.com')) {
                        channelUrlTimeout = setTimeout(async () => {
                            try {
                                const response = await fetch(`${API_BASE}/api/channels/fetch-info`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${userToken}`
                                    },
                                    body: JSON.stringify({ channelUrl: url })
                                });
                                if (response.ok) {
                                    const data = await response.json();
                                    console.log('[Canais] Dados recebidos do servidor:', data);
                                    if (data.channelName) {
                                        const nameInput = document.getElementById('channel-name');
                                        if (nameInput) {
                                            nameInput.value = data.channelName;
                                            console.log('[Canais] Nome do canal preenchido:', data.channelName);
                                        }
                                    }
                                    if (data.channelId) {
                                        const hiddenInput = document.getElementById('channel-id-hidden');
                                        if (hiddenInput) {
                                            hiddenInput.setAttribute('data-channel-id', data.channelId);
                                            console.log('[Canais] ID do canal salvo:', data.channelId);
                                        }
                                    }
                                    if (data.niche) {
                                        const nicheInput = document.getElementById('channel-niche');
                                        if (nicheInput) {
                                            nicheInput.value = data.niche;
                                            console.log('[Canais] Nicho preenchido:', data.niche);
                                        }
                                    } else {
                                        console.warn('[Canais] Nicho n√£o retornado pelo servidor');
                                    }
                                    if (data.language) {
                                        const langInput = document.getElementById('channel-language');
                                        if (langInput) {
                                            langInput.value = data.language;
                                            console.log('[Canais] Idioma preenchido:', data.language);
                                        }
                                    }
                                    if (data.country) {
                                        const countryInput = document.getElementById('channel-country');
                                        if (countryInput) {
                                            countryInput.value = data.country;
                                            console.log('[Canais] Pa√≠s preenchido:', data.country);
                                        }
                                    }
                                    showMessage('analytics-success-message', 'Informa√ß√µes do canal carregadas com sucesso!');
                                } else {
                                    const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                                    console.error('[Canais] Erro ao buscar informa√ß√µes:', errorData);
                                    showMessage('analytics-error-message', errorData.msg || 'Erro ao buscar informa√ß√µes do canal.', true);
                                }
                            } catch (err) {
                                console.error('Erro ao buscar informa√ß√µes do canal:', err);
                            }
                        }, 1000); // Aguardar 1 segundo ap√≥s parar de digitar
                    }
                }
            });

            const channelForm = document.getElementById('channel-form');
            if (channelForm) {
                channelForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const channelName = document.getElementById('channel-name').value;
                    const channelUrl = document.getElementById('channel-url').value;
                    const channelIdHidden = document.getElementById('channel-id-hidden');
                    const channelId = channelIdHidden?.getAttribute('data-channel-id') || null;
                    const niche = document.getElementById('channel-niche').value;
                    const language = document.getElementById('channel-language').value;
                    const country = document.getElementById('channel-country').value;

                    try {
                        const response = await fetch(`${API_BASE}/api/channels`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                channelName,
                                channelUrl,
                                channelId,
                                niche,
                                language,
                                country
                            })
                        });
                        if (!response.ok) {
                            const data = await response.json();
                            throw new Error(data.msg || 'Falha ao salvar canal.');
                        }
                        
                        hideChannelModal();
                        await loadChannels();
                        showMessage('analytics-success-message', 'Canal salvo com sucesso!');
                    } catch (err) {
                        showMessage('analytics-error-message', err.message, true);
                    }
                });
            }

            const registerVideoForm = document.getElementById('register-video-form');
            if (registerVideoForm) {
                registerVideoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('[Analytics] Registrando v√≠deo...', { API_BASE, hasToken: !!userToken });
                    
                    const channelId = document.getElementById('register-video-channel')?.value;
                    const url = document.getElementById('register-video-url')?.value;
                    const title = document.getElementById('register-video-title')?.value;
                    const ctr = document.getElementById('register-video-ctr')?.value;
                    const views = document.getElementById('register-video-views')?.value;

                    if (!url || !title) {
                        const errorMsg = document.getElementById('analytics-error-message');
                        if (errorMsg) {
                            showMessage('analytics-error-message', 'URL e t√≠tulo s√£o obrigat√≥rios.', true);
                        } else {
                            alert('URL e t√≠tulo s√£o obrigat√≥rios.');
                        }
                        return;
                    }

                    try {
                        const videoId = url.match(/[?&]v=([^&]+)/)?.[1];
                        if (!videoId) {
                            throw new Error('URL do YouTube inv√°lida. Use o formato: https://www.youtube.com/watch?v=VIDEO_ID');
                        }

                        console.log('[Analytics] Enviando dados:', { videoId, title, ctr, views, channelId });
                        
                        const response = await fetch(`${API_BASE}/api/analytics/track`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                channelId: channelId || null,
                                youtubeVideoId: videoId,
                                titleUsed: title,
                                predictedCtr: ctr ? parseFloat(ctr) : null,
                                predictedViews: views ? parseInt(views) : null
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ msg: 'Falha ao registrar v√≠deo.' }));
                            throw new Error(errorData.msg || 'Falha ao registrar v√≠deo.');
                        }
                        
                        const data = await response.json();
                        console.log('[Analytics] V√≠deo registrado com sucesso:', data);
                        
                        registerVideoForm.reset();
                        await loadAnalytics();
                        
                        // Mostrar mensagem de sucesso
                        const successMsg = document.getElementById('analytics-success-message');
                        if (successMsg) {
                            showMessage('analytics-success-message', 'V√≠deo registrado com sucesso!');
                        }
                        
                        // Atualizar dashboard se estiver vis√≠vel
                        refreshDashboardIfVisible();
                    } catch (err) {
                        console.error('[Analytics] Erro ao registrar v√≠deo:', err);
                        const errorMsg = document.getElementById('analytics-error-message');
                        if (errorMsg) {
                            showMessage('analytics-error-message', err.message, true);
                        } else {
                            alert('Erro ao registrar v√≠deo: ' + err.message);
                        }
                    }
                });
            } else {
                console.warn('[Analytics] Formul√°rio register-video-form n√£o encontrado');
            }

            // === FUNCIONALIDADES DE BIBLIOTECA ===
            let currentBibliotecaTab = 'titles';
            
            const bibliotecaTabTitles = document.getElementById('biblioteca-tab-titles');
            const bibliotecaTabThumbnails = document.getElementById('biblioteca-tab-thumbnails');
            const bibliotecaTabAgents = document.getElementById('biblioteca-tab-agents');
            const bibliotecaTabScripts = document.getElementById('biblioteca-tab-scripts');
            
            if (bibliotecaTabTitles) {
                bibliotecaTabTitles.addEventListener('click', () => {
                    currentBibliotecaTab = 'titles';
                    document.getElementById('biblioteca-titles-section').style.display = 'block';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'none';
                    document.getElementById('biblioteca-agents-section').style.display = 'none';
                    bibliotecaTabTitles.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.remove('text-gray-400');
                    bibliotecaTabThumbnails?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails?.classList.add('text-gray-400');
                    bibliotecaTabAgents?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents?.classList.add('text-gray-400');
                    loadBibliotecaNiches();
                    loadBibliotecaTitles();
                });
            }

            if (bibliotecaTabThumbnails) {
                bibliotecaTabThumbnails.addEventListener('click', () => {
                    currentBibliotecaTab = 'thumbnails';
                    document.getElementById('biblioteca-titles-section').style.display = 'none';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'block';
                    document.getElementById('biblioteca-agents-section').style.display = 'none';
                    bibliotecaTabThumbnails.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails.classList.remove('text-gray-400');
                    bibliotecaTabTitles.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.add('text-gray-400');
                    bibliotecaTabAgents?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents?.classList.add('text-gray-400');
                    loadBibliotecaNiches();
                    loadBibliotecaThumbnails();
                });
            }

            if (bibliotecaTabAgents) {
                bibliotecaTabAgents.addEventListener('click', () => {
                    currentBibliotecaTab = 'agents';
                    document.getElementById('biblioteca-titles-section').style.display = 'none';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'none';
                    document.getElementById('biblioteca-agents-section').style.display = 'block';
                    document.getElementById('biblioteca-scripts-section').style.display = 'none';
                    bibliotecaTabAgents.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents.classList.remove('text-gray-400');
                    bibliotecaTabTitles.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.add('text-gray-400');
                    bibliotecaTabThumbnails?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails?.classList.add('text-gray-400');
                    bibliotecaTabScripts?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabScripts?.classList.add('text-gray-400');
                    loadBibliotecaAgents();
                });
            }

            if (bibliotecaTabScripts) {
                bibliotecaTabScripts.addEventListener('click', () => {
                    currentBibliotecaTab = 'scripts';
                    document.getElementById('biblioteca-titles-section').style.display = 'none';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'none';
                    document.getElementById('biblioteca-agents-section').style.display = 'none';
                    document.getElementById('biblioteca-scripts-section').style.display = 'block';
                    bibliotecaTabScripts.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabScripts.classList.remove('text-gray-400');
                    bibliotecaTabTitles.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.add('text-gray-400');
                    bibliotecaTabThumbnails?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails?.classList.add('text-gray-400');
                    bibliotecaTabAgents?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents?.classList.add('text-gray-400');
                    loadBibliotecaScripts();
                });
            }

            async function loadBibliotecaNiches() {
                console.log('[Biblioteca] Carregando nichos...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usu√°rio n√£o encontrado');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/api/library/niches`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        throw new Error('Erro ao carregar nichos');
                    }
                    const data = await response.json();
                    const niches = data.niches || [];
                    
                    const nicheFilter = document.getElementById('biblioteca-niche-filter');
                    if (nicheFilter) {
                        const currentValue = nicheFilter.value;
                        nicheFilter.innerHTML = '<option value="">Todos os Nichos</option>';
                        niches.forEach(niche => {
                            const option = document.createElement('option');
                            option.value = niche;
                            option.textContent = niche;
                            nicheFilter.appendChild(option);
                        });
                        // Restaurar valor anterior se ainda existir
                        if (currentValue && niches.includes(currentValue)) {
                            nicheFilter.value = currentValue;
                        }
                    }
                } catch (err) {
                    console.error('[Biblioteca] Erro ao carregar nichos:', err);
                }
            }

            async function loadBibliotecaTitles() {
                console.log('[Biblioteca] Carregando t√≠tulos...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usu√°rio n√£o encontrado');
                    return;
                }
                try {
                    const search = document.getElementById('biblioteca-search')?.value || '';
                    const niche = document.getElementById('biblioteca-niche-filter')?.value || '';
                    const minViews = document.getElementById('biblioteca-views-filter')?.value || '';
                    const favoritesBtn = document.getElementById('biblioteca-favorites-only');
                    const favorites = favoritesBtn?.classList.contains('active') ? 'true' : '';

                    let url = `${API_BASE}/api/library/titles?`;
                    if (search) url += `search=${encodeURIComponent(search)}&`;
                    if (niche) url += `niche=${encodeURIComponent(niche)}&`;
                    if (minViews) url += `minViews=${minViews}&`;
                    if (favorites) url += `favorite=${favorites}&`;

                    console.log('[Biblioteca] URL:', url);
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('[Biblioteca] Resposta:', response.status);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar t√≠tulos: ${response.status}`);
                    }
                    const titles = await response.json();
                    console.log('[Biblioteca] T√≠tulos recebidos:', titles.length);

                    const list = document.getElementById('biblioteca-titles-list');
                    if (list) {
                        if (titles.length > 0) {
                            list.innerHTML = titles.map(title => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-white font-semibold mb-1">${escapeHtml(title.title || 'Sem t√≠tulo')}</h3>
                                        <p class="text-gray-400 text-sm">${escapeHtml(title.niche || 'N/A')} ‚Ä¢ ${escapeHtml(title.subniche || 'N/A')} ‚Ä¢ ${formatNumber(parseInt(title.original_views || 0))} views ‚Ä¢ Score: ${title.viral_score || 'N/A'}/10</p>
                                    </div>
                                    <div class="flex items-center gap-2 ml-4">
                                        <button onclick="toggleTitleFavorite(${title.id}, ${title.is_favorite || 0})" class="p-2 ${title.is_favorite ? 'text-red-600 fill-red-600' : 'text-gray-400'} hover:text-red-500 transition-colors" title="${title.is_favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                                            <i data-lucide="heart" class="w-4 h-4 ${title.is_favorite ? 'fill-current' : ''}"></i>
                                        </button>
                                        <button onclick="deleteTitleFromLibrary(${title.id})" class="p-2 text-red-600 hover:text-red-500 transition-colors" title="Excluir t√≠tulo">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            list.innerHTML = '<p class="text-gray-400">Nenhum t√≠tulo encontrado.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar t√≠tulos:', err);
                    const list = document.getElementById('biblioteca-titles-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar t√≠tulos: ${err.message}</p>`;
                    }
                }
            }

            async function loadBibliotecaScripts() {
                console.log('[Biblioteca] Carregando roteiros gerados...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usu√°rio n√£o encontrado');
                    return;
                }
                try {
                    const list = document.getElementById('biblioteca-scripts-list');
                    if (!list) {
                        console.error('[Biblioteca] Elemento biblioteca-scripts-list n√£o encontrado');
                        return;
                    }

                    list.innerHTML = '<p class="text-gray-400">Carregando roteiros...</p>';

                    const response = await fetch(`${API_BASE}/api/scripts`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar roteiros: ${response.status}`);
                    }

                    const data = await response.json();
                    const scripts = data.scripts || [];
                    console.log('[Biblioteca] Roteiros recebidos:', scripts.length);

                    if (list) {
                        if (scripts.length > 0) {
                            list.innerHTML = scripts.map(script => {
                                const createdDate = new Date(script.created_at || script.createdAt || Date.now());
                                const dateStr = createdDate.toLocaleDateString('pt-BR', { 
                                    day: '2-digit', 
                                    month: '2-digit', 
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                // Calcular tempo aproximado (150 palavras/minuto, ~5 caracteres/palavra = 750 caracteres/minuto)
                                const charCount = script.script_content?.length || 0;
                                const estimatedMinutes = Math.ceil(charCount / 750);
                                
                                return `
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-amber-500 transition-colors">
                                        <div class="flex items-start space-x-4 mb-4">
                                            <div class="flex-shrink-0 pt-1">
                                                <input type="checkbox" class="script-checkbox w-5 h-5 text-amber-600 bg-gray-700 border-gray-600 rounded focus:ring-amber-500 focus:ring-2" data-script-id="${script.id}">
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="text-lg font-semibold text-white mb-2">${escapeHtml(script.title || 'Sem t√≠tulo')}</h3>
                                                <div class="space-y-1 text-sm text-gray-400">
                                                    ${script.niche ? `<p><span class="text-amber-500">Nicho:</span> ${escapeHtml(script.niche)}</p>` : ''}
                                                    ${script.subniche ? `<p><span class="text-amber-500">Sub-nicho:</span> ${escapeHtml(script.subniche)}</p>` : ''}
                                                    ${script.model_used ? `<p><span class="text-amber-500">Modelo:</span> ${escapeHtml(window.formatModelNameForDisplay ? window.formatModelNameForDisplay(script.model_used) : script.model_used)}</p>` : ''}
                                                    <p class="text-xs text-gray-500 mt-2">Gerado em: ${dateStr}</p>
                                                    <p class="text-xs text-gray-500">Tamanho: ${charCount.toLocaleString('pt-BR')} caracteres</p>
                                                    <p class="text-xs text-amber-400 font-medium">Dura√ß√£o aproximada: ${estimatedMinutes} minuto${estimatedMinutes !== 1 ? 's' : ''}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2 mt-4">
                                            <button class="btn-view-script flex-1 py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors flex items-center justify-center space-x-2" data-script-id="${script.id}" data-script-title="${escapeHtml(script.title)}" data-script-duration="${script.duration_minutes || estimatedMinutes}">
                                                <i data-lucide="eye"></i>
                                                <span>Ver Roteiro</span>
                                            </button>
                                            <button class="btn-download-script-srt py-2 px-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors" data-script-id="${script.id}" data-script-content="${escapeHtml((script.script_content || '').substring(0, 1000))}" data-script-title="${escapeHtml(script.title)}" title="Baixar SRT">
                                                <i data-lucide="download"></i>
                                            </button>
                                            <button class="btn-delete-script py-2 px-3 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors" data-script-id="${script.id}" title="Excluir roteiro">
                                                <i data-lucide="trash-2"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            // Adicionar event listeners para checkboxes
                            document.querySelectorAll('.script-checkbox').forEach(checkbox => {
                                checkbox.addEventListener('change', updateDeleteButton);
                            });
                            
                            // Event listener para selecionar todos
                            const selectAllBtn = document.getElementById('select-all-scripts');
                            const deleteSelectedBtn = document.getElementById('delete-selected-scripts');
                            if (selectAllBtn) {
                                selectAllBtn.addEventListener('click', () => {
                                    const checkboxes = document.querySelectorAll('.script-checkbox');
                                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                                    checkboxes.forEach(cb => {
                                        cb.checked = !allChecked;
                                    });
                                    updateDeleteButton();
                                });
                            }
                            
                            // Event listener para apagar selecionados
                            if (deleteSelectedBtn) {
                                deleteSelectedBtn.addEventListener('click', async () => {
                                    const selectedIds = Array.from(document.querySelectorAll('.script-checkbox:checked'))
                                        .map(cb => cb.getAttribute('data-script-id'));
                                    
                                    if (selectedIds.length === 0) {
                                        showMessage('biblioteca-error-message', 'Nenhum roteiro selecionado.', true);
                                        return;
                                    }
                                    
                                    const confirmed = await showStyledConfirm(
                                        `Tem certeza que deseja excluir ${selectedIds.length} roteiro(s)?`,
                                        'Confirmar Exclus√£o'
                                    );
                                    if (!confirmed) {
                                        return;
                                    }
                                    
                                    try {
                                        const deletePromises = selectedIds.map(id => 
                                            fetch(`${API_BASE}/api/scripts/${id}`, {
                                                method: 'DELETE',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            })
                                        );
                                        
                                        const results = await Promise.all(deletePromises);
                                        const failed = results.filter(r => !r.ok).length;
                                        
                                        if (failed === 0) {
                                            showMessage('biblioteca-success-message', `${selectedIds.length} roteiro(s) exclu√≠do(s) com sucesso!`);
                                            loadBibliotecaScripts();
                                        } else {
                                            showMessage('biblioteca-error-message', `${failed} roteiro(s) n√£o puderam ser exclu√≠dos.`, true);
                                        }
                                    } catch (err) {
                                        showMessage('biblioteca-error-message', 'Erro ao excluir roteiros: ' + err.message, true);
                                    }
                                });
                            }
                            
                            // Fun√ß√£o para atualizar bot√£o de apagar selecionados
                            function updateDeleteButton() {
                                const selectedCount = document.querySelectorAll('.script-checkbox:checked').length;
                                const deleteBtn = document.getElementById('delete-selected-scripts');
                                const countSpan = document.getElementById('selected-count');
                                
                                if (deleteBtn) {
                                    deleteBtn.style.display = selectedCount > 0 ? 'flex' : 'none';
                                }
                                if (countSpan) {
                                    countSpan.textContent = selectedCount;
                                }
                            }
                            
                            // Adicionar event listeners
                            document.querySelectorAll('.btn-view-script').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const scriptId = btn.getAttribute('data-script-id');
                                    const scriptTitle = btn.getAttribute('data-script-title');
                                    const scriptDuration = parseInt(btn.getAttribute('data-script-duration')) || 5;
                                    try {
                                        const response = await fetch(`${API_BASE}/api/scripts/${scriptId}`, {
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        });
                                        if (!response.ok) throw new Error('Erro ao carregar roteiro');
                                        const data = await response.json();
                                        showScriptResult(data.script.script_content || data.script.content || '', scriptTitle, scriptDuration);
                                    } catch (err) {
                                        alert('Erro ao carregar roteiro: ' + err.message);
                                    }
                                });
                            });

                            document.querySelectorAll('.btn-download-script-srt').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const scriptContent = btn.getAttribute('data-script-content');
                                    const scriptTitle = btn.getAttribute('data-script-title');
                                    // Carregar conte√∫do completo
                                    fetch(`${API_BASE}/api/scripts/${btn.getAttribute('data-script-id')}`, {
                                        headers: { 'Authorization': `Bearer ${userToken}` }
                                    })
                                    .then(res => res.json())
                                    .then(data => {
                                        let fullContent = data.script?.script_content || data.script?.content || '';
                                        
                                        // Remover marca√ß√µes de pausa dram√°tica (entre chaves {} ou colchetes [])
                                        // Remover marca√ß√µes de PARTE X e intervalos de tempo
                                        fullContent = fullContent
                                            .replace(/\{[^}]*\}/g, '') // Remove {texto}
                                            .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                                            .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00"
                                            .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00"
                                            .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no in√≠cio da linha
                                            .replace(/\s+/g, ' ') // Normalizar espa√ßos
                                            .trim();
                                        
                                        // Estimar dura√ß√£o baseado no tamanho (150 palavras/minuto, ~5 caracteres/palavra)
                                        const estimatedDuration = Math.max(5, Math.ceil(fullContent.length / (150 * 5)));
                                        const srtContent = generateSRT(fullContent, estimatedDuration);
                                        downloadSRT(srtContent, scriptTitle || 'roteiro');
                                    })
                                    .catch(err => {
                                        showStyledAlert('Erro ao baixar SRT: ' + err.message, 'Erro');
                                    });
                                });
                            });

                            document.querySelectorAll('.btn-delete-script').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const scriptId = btn.getAttribute('data-script-id');
                                    const confirmed = await showStyledConfirm(
                                        'Tem certeza que deseja excluir este roteiro?',
                                        'Confirmar Exclus√£o'
                                    );
                                    if (confirmed) {
                                        try {
                                            const response = await fetch(`${API_BASE}/api/scripts/${scriptId}`, {
                                                method: 'DELETE',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            });
                                            if (!response.ok) throw new Error('Erro ao excluir roteiro');
                                            loadBibliotecaScripts();
                                            showMessage('biblioteca-success-message', 'Roteiro exclu√≠do com sucesso!');
                                        } catch (err) {
                                            showMessage('biblioteca-error-message', 'Erro ao excluir roteiro: ' + err.message, true);
                                        }
                                    }
                                });
                            });

                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            list.innerHTML = `
                                <div class="col-span-full text-center py-12">
                                    <i data-lucide="file-text" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                                    <p class="text-gray-400 text-lg mb-2">Nenhum roteiro gerado ainda</p>
                                    <p class="text-gray-500 text-sm">Os roteiros gerados pelos agentes aparecer√£o aqui</p>
                                </div>
                            `;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }
                    }
                } catch (err) {
                    console.error('[Biblioteca] Erro ao carregar roteiros:', err);
                    const list = document.getElementById('biblioteca-scripts-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar roteiros: ${err.message}</p>`;
                    }
                }
            }

            async function loadBibliotecaAgents() {
                console.log('[Biblioteca] Carregando agentes de roteiro...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usu√°rio n√£o encontrado');
                    return;
                }
                try {
                    const list = document.getElementById('biblioteca-agents-list');
                    if (!list) {
                        console.error('[Biblioteca] Elemento biblioteca-agents-list n√£o encontrado');
                        return;
                    }

                    list.innerHTML = '<p class="text-gray-400">Carregando agentes...</p>';

                    const response = await fetch(`${API_BASE}/api/script-agents`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar agentes: ${response.status}`);
                    }

                    const data = await response.json();
                    const agents = data.agents || [];
                    console.log('[Biblioteca] Agentes recebidos:', agents.length);

                    if (list) {
                        if (agents.length > 0) {
                            list.innerHTML = agents.map(agent => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-amber-500 transition-colors">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-white mb-2">${escapeHtml(agent.agent_name || 'Sem nome')}</h3>
                                            <div class="space-y-1 text-sm text-gray-400">
                                                ${agent.niche ? `<p><span class="text-amber-500">Nicho:</span> ${escapeHtml(agent.niche)}</p>` : ''}
                                                ${agent.subniche ? `<p><span class="text-amber-500">Sub-nicho:</span> ${escapeHtml(agent.subniche)}</p>` : ''}
                                                ${agent.source_video_title ? `<p class="text-xs text-gray-500 mt-2">Baseado em: ${escapeHtml(agent.source_video_title.substring(0, 50))}${agent.source_video_title.length > 50 ? '...' : ''}</p>` : ''}
                                                <p class="text-xs text-gray-500 mt-2">Usado ${agent.usage_count || 0} vez${agent.usage_count !== 1 ? 'es' : ''}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2 mt-4">
                                        <button class="btn-use-agent flex-1 py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors flex items-center justify-center space-x-2" data-agent-id="${agent.id}" data-agent-name="${escapeHtml(agent.agent_name)}">
                                            <i data-lucide="play"></i>
                                            <span>Usar Agente</span>
                                        </button>
                                        <button class="btn-delete-agent py-2 px-3 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors" data-agent-id="${agent.id}" title="Excluir agente">
                                            <i data-lucide="trash-2"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            
                            // Adicionar event listeners
                            document.querySelectorAll('.btn-use-agent').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const agentId = btn.getAttribute('data-agent-id');
                                    const agentName = btn.getAttribute('data-agent-name');
                                    openGenerateScriptModal(agentId, agentName);
                                });
                            });

                            document.querySelectorAll('.btn-delete-agent').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const agentId = btn.getAttribute('data-agent-id');
                                    if (confirm('Tem certeza que deseja excluir este agente?')) {
                                        try {
                                            const response = await fetch(`${API_BASE}/api/script-agents/${agentId}`, {
                                                method: 'DELETE',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            });
                                            if (!response.ok) throw new Error('Erro ao excluir agente');
                                            loadBibliotecaAgents();
                                            showMessage('biblioteca-success-message', 'Agente exclu√≠do com sucesso!');
                                        } catch (err) {
                                            showMessage('biblioteca-error-message', 'Erro ao excluir agente: ' + err.message, true);
                                        }
                                    }
                                });
                            });

                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            list.innerHTML = `
                                <div class="col-span-full text-center py-12">
                                    <i data-lucide="bot" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                                    <p class="text-gray-400 text-lg mb-2">Nenhum agente de roteiro criado ainda</p>
                                    <p class="text-gray-500 text-sm">Crie seu primeiro agente a partir de um v√≠deo analisado</p>
                                </div>
                            `;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }
                    }
                } catch (err) {
                    console.error('[Biblioteca] Erro ao carregar agentes:', err);
                    const list = document.getElementById('biblioteca-agents-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar agentes: ${err.message}</p>`;
                    }
                }
            }

            function openGenerateScriptModal(agentId, agentName) {
                console.log(`[Generate Script Modal] Abrindo modal - agentId: ${agentId}, agentName: ${agentName}`);
                
                // Criar modal dinamicamente ou usar existente
                let modal = document.getElementById('generate-script-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'generate-script-modal';
                    modal.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center';
                    modal.innerHTML = `
                        <div class="bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Gerar Roteiro com Agente</h3>
                                <button id="close-generate-script-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <form id="generate-script-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Agente <span class="text-amber-500">*</span></label>
                                    <input type="text" id="generate-script-agent-name" readonly class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 cursor-not-allowed" required>
                                    <input type="hidden" id="generate-script-agent-id" value="">
                                    <p class="text-xs text-gray-400 mt-1">Agente selecionado para gerar o roteiro</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">T√≠tulo do V√≠deo <span class="text-amber-500">*</span></label>
                                    <input type="text" id="generate-script-title" placeholder="Cole aqui o t√≠tulo do v√≠deo para o qual deseja gerar o roteiro..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                                    <p class="text-xs text-gray-400 mt-1">O agente ir√° analisar o t√≠tulo e gerar um roteiro completo seguindo a estrutura do v√≠deo viral original.</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Dura√ß√£o (min) <span class="text-amber-500">*</span></label>
                                        <input type="number" id="generate-script-duration" min="3" max="120" value="5" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                                        <p class="text-xs text-gray-400 mt-1">Palavras: ~<span id="duration-words">750</span></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Partes (Autom√°tico)</label>
                                        <input type="text" id="generate-script-parts" readonly class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 cursor-not-allowed">
                                        <p class="text-xs text-gray-400 mt-1">Partes de 3 minutos cada</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Idioma do Roteiro <span class="text-amber-500">*</span></label>
                                        <select id="generate-script-language" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                                            <option value="pt" selected>Portugu√™s (Brasil)</option>
                                            <option value="pt-PT">Portugu√™s (Portugal)</option>
                                            <option value="es">Espa√±ol</option>
                                            <option value="en">English</option>
                                            <option value="fr">Fran√ßais</option>
                                            <option value="de">Deutsch</option>
                                            <option value="it">Italiano</option>
                                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                                            <option value="ja">Êó•Êú¨Ë™û</option>
                                            <option value="zh">‰∏≠Êñá</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Call to Action (CTA) - Onde incluir?</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="cta-inicio" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500">
                                            <span class="text-sm text-gray-300">CTA no In√≠cio (primeiros 30 segundos)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="cta-meio" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500">
                                            <span class="text-sm text-gray-300">CTA no Meio (aproximadamente na metade do v√≠deo)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="cta-final" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500" checked>
                                            <span class="text-sm text-gray-300">CTA no Final (√∫ltimos 30 segundos)</span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Marque onde deseja incluir chamadas para a√ß√£o (like, subscribe, comentar, etc.)</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo de IA</label>
                                    <select id="generate-script-model" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="claude-3-7-sonnet-20250219" selected>Claude 3.7 Sonnet (Fev/25) ‚≠ê Recomendado</option>
                                        <option value="gpt-4o">GPT-4o (2025)</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">T√≥pico Adicional (Opcional)</label>
                                    <textarea id="generate-script-topic" rows="3" placeholder="Se desejar, adicione informa√ß√µes adicionais sobre o t√≥pico ou contexto espec√≠fico..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                                    <p class="text-xs text-gray-400 mt-1">Opcional: Use apenas se quiser fornecer contexto adicional al√©m do t√≠tulo.</p>
                                </div>
                                <div class="flex space-x-4">
                                    <button type="button" id="cancel-generate-script" class="flex-1 py-3 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                    <button type="submit" id="submit-generate-script" class="flex-1 py-3 px-4 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold flex items-center justify-center space-x-2">
                                        <span>Gerar Roteiro</span>
                                        <div class="btn-spinner hidden"></div>
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    document.getElementById('close-generate-script-modal').addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                    
                    // Atualizar partes quando a dura√ß√£o mudar
                    const durationInput = document.getElementById('generate-script-duration');
                    if (durationInput) {
                        durationInput.addEventListener('input', updateScriptParts);
                        durationInput.addEventListener('change', updateScriptParts);
                    }
                    document.getElementById('cancel-generate-script').addEventListener('click', () => {
                        modal.style.display = 'none';
                    });

                    document.getElementById('generate-script-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const agentNameField = document.getElementById('generate-script-agent-name');
                        const agentIdField = document.getElementById('generate-script-agent-id');
                        const title = document.getElementById('generate-script-title').value.trim();
                        const topic = document.getElementById('generate-script-topic').value.trim();
                        const duration = document.getElementById('generate-script-duration').value;
                        const language = document.getElementById('generate-script-language').value;
                        const model = document.getElementById('generate-script-model').value;
                        const ctaInicio = document.getElementById('cta-inicio').checked;
                        const ctaMeio = document.getElementById('cta-meio').checked;
                        const ctaFinal = document.getElementById('cta-final').checked;
                        
                        const agentId = agentIdField ? agentIdField.value : null;
                        
                        console.log(`[Generate Script] Submetendo formul√°rio - agentId: ${agentId}, agentName: ${agentNameField?.value}`);
                        
                        if (!agentId || !agentNameField || !agentNameField.value) {
                            alert('Erro: Agente n√£o encontrado. Por favor, selecione um agente novamente.');
                            return;
                        }
                        
                        if (!title) {
                            alert('Por favor, informe o t√≠tulo do v√≠deo.');
                            return;
                        }

                        if (!duration) {
                            alert('Por favor, selecione a dura√ß√£o do roteiro.');
                            return;
                        }

                        if (!language) {
                            alert('Por favor, selecione o idioma do roteiro.');
                            return;
                        }

                        const btn = document.getElementById('submit-generate-script');
                        setButtonLoading(btn, true);
                        
                        // Calcular dura√ß√£o ajustada (mesma l√≥gica do updateScriptParts)
                        const baseDuration = parseInt(duration) || 5;
                        const additionalMinutes = Math.min(5, Math.max(3, Math.ceil(baseDuration * 0.2))); // 20% da dura√ß√£o, m√≠nimo 3, m√°ximo 5
                        const adjustedDuration = baseDuration + additionalMinutes;
                        const parsedDuration = adjustedDuration; // Usar dura√ß√£o ajustada
                        
                        const partsInput = document.getElementById('generate-script-parts');
                        const partsCount = partsInput ? (parseInt(partsInput.value) || Math.max(1, Math.ceil(parsedDuration / 3))) : Math.max(1, Math.ceil(parsedDuration / 3));
                        const sessionId = (window.crypto && typeof window.crypto.randomUUID === 'function')
                            ? window.crypto.randomUUID()
                            : `session-${Date.now()}`;
                        
                        console.log(`[Generate Script] Dura√ß√£o original: ${baseDuration} min, Dura√ß√£o ajustada enviada: ${parsedDuration} min (+${additionalMinutes} min)`);
                        
                        // Mostrar modal de progresso real-time
                        showProgressModal(parsedDuration, partsCount);
                        startScriptProgressStream(sessionId, partsCount);
                        
                        try {
                            // Verificar se laozhang.ai est√° configurada como padr√£o
                            let useLaozhang = false;
                            try {
                                const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                if (settingsResponse.ok) {
                                    const settings = await settingsResponse.json();
                                    useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                                }
                            } catch (err) {
                                console.warn('[Generate Script] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                            }
                            
                            const endpoint = useLaozhang ? `/api/script-agents/${agentId}/generate/laozhang` : `/api/script-agents/${agentId}/generate`;
                            const selectedModel = model || 'claude-3-7-sonnet-20250219';
                            
                            const response = await fetch(`${API_BASE}${endpoint}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({ 
                                    title: title,
                                    topic: topic || null,
                                    duration: parsedDuration,
                                    language: language,
                                    cta: {
                                        inicio: ctaInicio,
                                        meio: ctaMeio,
                                        final: ctaFinal
                                    },
                                    model: useLaozhang ? null : selectedModel,
                                    selectedModel: selectedModel,
                                    parts: partsCount,
                                    sessionId
                                })
                            });

                            if (!response.ok) {
                                hideProgressModal();
                                const errorData = await response.json();
                                throw new Error(errorData.msg || 'Erro ao gerar roteiro');
                            }

                            const data = await response.json();
                            console.log('[Roteiro] Dados recebidos:', data);
                            
                            modal.style.display = 'none';
                            
                            // Extrair o roteiro (pode vir em diferentes formatos)
                            let scriptText = '';
                            if (typeof data.script === 'string') {
                                scriptText = data.script;
                            } else if (data.script && typeof data.script === 'object') {
                                // Se for objeto, tentar extrair conte√∫do
                                if (data.script.content) {
                                    scriptText = data.script.content;
                                } else if (data.script.script && Array.isArray(data.script.script)) {
                                    // Se for array de objetos (formato JSON)
                                    scriptText = data.script.script.map(item => {
                                        if (item.content) {
                                            const timeStr = item.time ? `[${item.time}] ` : '';
                                            return timeStr + item.content;
                                        }
                                        return '';
                                    }).filter(Boolean).join('\n\n');
                                } else if (data.script.roteiro) {
                                    scriptText = data.script.roteiro;
                                } else {
                                    scriptText = JSON.stringify(data.script, null, 2);
                                }
                            } else {
                                scriptText = data.script || '';
                            }
                            
                            console.log('[Roteiro] Script extra√≠do (primeiros 200 caracteres):', scriptText.substring(0, 200));
                            
                            // Limpar JSON se ainda houver
                            scriptText = scriptText
                                .replace(/\{[\s\S]*?"roteiro"[\s\S]*?\}/g, '')
                                .replace(/"roteiro"\s*:\s*"([^"]+)"/gi, '$1')
                                .replace(/"duracao"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/"estrutura"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/\{[\s\S]*\}/g, '')
                                .trim();
                            
                            if (!scriptText || scriptText.length === 0) {
                                console.error('[Roteiro] Script vazio ap√≥s processamento');
                                hideProgressModal();
                                alert('Erro: O roteiro gerado est√° vazio. Por favor, tente novamente.');
                                return;
                            }
                            
                            // Validar quantidade de palavras antes de fechar o modal
                            const wordCount = scriptText.trim().split(/\s+/).filter(w => w.length > 0).length;
                            const expectedWords = parsedDuration * 150;
                            const minWords = expectedWords - 50;
                            const maxWords = expectedWords + 100;
                            
                            console.log(`[Roteiro] Valida√ß√£o: ${wordCount} palavras encontradas, esperado: ${expectedWords} (toler√¢ncia: ${minWords}-${maxWords})`);
                            
                            // Atualizar barra de progresso com informa√ß√£o de palavras
                            const progressBar = document.getElementById('progress-bar');
                            const progressText = document.getElementById('progress-text');
                            
                            // Se estiver muito abaixo do m√≠nimo, avisar mas continuar (o backend j√° tentou expandir)
                            if (wordCount < minWords) {
                                const percentage = Math.round((wordCount / expectedWords) * 100);
                                if (progressBar) progressBar.style.width = '95%';
                                if (progressText) {
                                    progressText.textContent = `Roteiro gerado: ${wordCount} palavras (${percentage}% da meta de ${expectedWords}). Finalizando...`;
                                }
                                
                                // Avisar que est√° abaixo do ideal, mas continuar
                                console.warn(`[Roteiro] Roteiro abaixo do ideal: ${wordCount} palavras (meta: ${expectedWords}), mas continuando...`);
                            }
                            
                            if (wordCount > maxWords) {
                                console.warn(`[Roteiro] Roteiro muito longo: ${wordCount} palavras (m√°ximo: ${maxWords}), mas continuando...`);
                            }
                            
                            setTimeout(() => {
                                hideProgressModal();
                                showScriptResult(scriptText, agentName, parsedDuration);
                            }, 1200);
                        } catch (err) {
                            hideProgressModal();
                            alert('Erro ao gerar roteiro: ' + err.message);
                        } finally {
                            setButtonLoading(btn, false);
                        }
                    });
                }

                // Atualizar campos do agente
                const agentNameInput = document.getElementById('generate-script-agent-name');
                const agentIdInput = document.getElementById('generate-script-agent-id');
                if (agentNameInput) {
                    agentNameInput.value = agentName || '';
                }
                if (agentIdInput) {
                    agentIdInput.value = agentId || '';
                }
                console.log(`[Generate Script Modal] Atualizando modal - agentId: ${agentId}, agentName: ${agentName}`);
                
                document.getElementById('generate-script-title').value = '';
                document.getElementById('generate-script-topic').value = '';
                document.getElementById('generate-script-duration').value = '5';
                document.getElementById('generate-script-language').value = 'pt';
                document.getElementById('generate-script-model').value = 'claude-3-7-sonnet-20250219';
                document.getElementById('cta-inicio').checked = false;
                document.getElementById('cta-meio').checked = false;
                document.getElementById('cta-final').checked = true;
                
                // Atualizar partes automaticamente
                setTimeout(() => {
                    updateScriptParts();
                }, 100);
                
                modal.style.display = 'flex';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function updateScriptParts() {
                const durationInput = document.getElementById('generate-script-duration');
                const partsInput = document.getElementById('generate-script-parts');
                const wordsSpan = document.getElementById('duration-words');
                
                if (durationInput && partsInput && wordsSpan) {
                    const duration = parseInt(durationInput.value) || 5;
                    // Adicionar 3-5 minutos a mais na dura√ß√£o mostrada ao usu√°rio
                    const additionalMinutes = Math.min(5, Math.max(3, Math.ceil(duration * 0.2))); // 20% da dura√ß√£o, m√≠nimo 3, m√°ximo 5
                    const displayedDuration = duration + additionalMinutes;
                    const basePartDuration = 3;
                    const numberOfParts = Math.max(1, Math.ceil(displayedDuration / basePartDuration));
                    const wordsTarget = displayedDuration * 150;
                    
                    partsInput.value = numberOfParts;
                    // Atualizar texto mostrando dura√ß√£o ajustada
                    const parentElement = wordsSpan.parentElement;
                    if (parentElement) {
                        parentElement.innerHTML = `Palavras: ~<span id="duration-words">${wordsTarget.toLocaleString('pt-BR')}</span> <span class="text-amber-500">(dura√ß√£o ajustada: ${displayedDuration} min)</span>`;
                    } else {
                    wordsSpan.textContent = wordsTarget.toLocaleString('pt-BR');
                    }
                }
            }

            // ===== FUN√á√ïES DE PROGRESSO DO ROTEIRO (ESCOPO GLOBAL) =====
            function showProgressModal(duration, partsCount = 1) {
                let progressModal = document.getElementById('script-progress-modal');
                if (!progressModal) {
                    progressModal = document.createElement('div');
                    progressModal.id = 'script-progress-modal';
                    progressModal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center';
                    progressModal.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all">
                            <div class="text-center mb-6">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20 animate-pulse">
                                    <i data-lucide="sparkles" class="w-10 h-10 text-amber-400 animate-spin"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-400 bg-clip-text text-transparent animate-pulse">Gerando Roteiro...</h3>
                                <p class="text-gray-300 text-sm mb-1" id="progress-main-status">Inicializando gera√ß√£o...</p>
                                <p class="text-gray-400 text-xs" id="progress-sub-status">Preparando IA e carregando f√≥rmula viral</p>
                            </div>
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-white font-bold text-lg" id="progress-parts-counter">0/0</span>
                                        <span class="text-gray-400 text-sm">partes</span>
                                    </div>
                                    <span id="progress-percentage" class="text-amber-400 font-bold text-2xl">0%</span>
                                </div>
                                <div class="w-full bg-gray-800/50 rounded-full h-4 overflow-hidden border border-gray-700/50 shadow-inner">
                                    <div id="progress-bar" class="h-full bg-gradient-to-r from-amber-500 via-yellow-400 to-amber-500 rounded-full transition-all duration-500 ease-out relative" style="width: 0%; background-size: 200% 100%; animation: shimmer 2s infinite;">
                                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent animate-shimmer"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="parts-progress" class="mb-4 max-h-48 overflow-y-auto space-y-2" style="display: none;">
                                <p class="text-xs text-gray-400 mb-1">Partes:</p>
                                <div id="parts-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                            </div>
                            <p id="progress-text" class="text-center text-gray-400 text-xs">Iniciando...</p>
                        </div>
                    `;
                    document.body.appendChild(progressModal);
                }
                
                const wordsTarget = duration * 150;
                const minWords = wordsTarget - 50;
                const maxWords = wordsTarget + 100;
                
                progressModal.dataset.wordsTarget = wordsTarget;
                progressModal.dataset.minWords = minWords;
                progressModal.dataset.maxWords = maxWords;
                progressModal.dataset.duration = duration;
                progressModal.dataset.numberOfParts = partsCount;
                progressModal.dataset.currentPart = 0;
                progressModal.dataset.completedParts = 0;
                progressModal.dataset.renderedParts = 0;
                
                renderPartIndicators(partsCount);
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const progressMainStatus = document.getElementById('progress-main-status');
                const progressSubStatus = document.getElementById('progress-sub-status');
                const progressPercentage = document.getElementById('progress-percentage');
                const progressPartsCounter = document.getElementById('progress-parts-counter');
                
                if (progressBar) progressBar.style.width = '0%';
                if (progressPercentage) progressPercentage.textContent = '0%';
                if (progressMainStatus) progressMainStatus.textContent = 'Inicializando gera√ß√£o...';
                if (progressSubStatus) progressSubStatus.textContent = `Preparando IA do agente (meta: ${wordsTarget.toLocaleString('pt-BR')} palavras)...`;
                if (progressPartsCounter) progressPartsCounter.textContent = `0/${partsCount}`;
                if (progressText) progressText.textContent = 'Iniciando gera√ß√£o...';
                
                progressModal.style.display = 'flex';
            }
            
            function renderPartIndicators(totalParts) {
                const progressModal = document.getElementById('script-progress-modal');
                const partsProgress = document.getElementById('parts-progress');
                const partsList = document.getElementById('parts-list');
                if (!progressModal || !partsProgress || !partsList) return;
                
                if (totalParts > 1) {
                    partsProgress.style.display = 'block';
                    partsList.innerHTML = '';
                    for (let i = 1; i <= totalParts; i++) {
                        const partDiv = document.createElement('div');
                        partDiv.id = `part-${i}`;
                        partDiv.className = 'flex items-center justify-between bg-gray-800/70 rounded-md px-3 py-2 text-xs';
                        partDiv.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="part-${i}-indicator"></div>
                                <span class="text-gray-300 font-semibold">Parte ${i}</span>
                            </div>
                            <span class="text-gray-500 text-[11px]" id="part-${i}-status">Aguardando...</span>
                        `;
                        partsList.appendChild(partDiv);
                    }
                } else {
                    partsProgress.style.display = 'none';
                    partsList.innerHTML = '';
                }
                
                progressModal.dataset.renderedParts = totalParts;
            }
            
            function updatePartProgress(partNumber, status, percentage = 0) {
                const partDiv = document.getElementById(`part-${partNumber}`);
                const partIndicator = document.getElementById(`part-${partNumber}-indicator`);
                const partStatus = document.getElementById(`part-${partNumber}-status`);
                
                if (partIndicator && partStatus) {
                    if (status === 'generating') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse ring-2 ring-amber-400/50';
                        partStatus.textContent = percentage > 0 ? `‚è≥ Gerando... ${percentage}%` : '‚è≥ Gerando...';
                        partStatus.className = 'text-amber-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-amber-900/20 rounded-md px-3 py-2 text-xs border border-amber-700/30';
                    } else if (status === 'completed') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-green-500 ring-2 ring-green-400/50';
                        partStatus.textContent = '‚úì Conclu√≠da';
                        partStatus.className = 'text-green-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-green-900/20 rounded-md px-3 py-2 text-xs border border-green-700/30';
                    } else if (status === 'expanding') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse ring-2 ring-blue-400/50';
                        partStatus.textContent = percentage > 0 ? `üìù Expandindo... ${percentage}%` : 'üìù Expandindo...';
                        partStatus.className = 'text-blue-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-blue-900/20 rounded-md px-3 py-2 text-xs border border-blue-700/30';
                    } else if (status === 'waiting') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-gray-700 animate-pulse';
                        partStatus.textContent = '‚è∏ Aguardando...';
                        partStatus.className = 'text-gray-500 text-[11px]';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-gray-800/70 rounded-md px-3 py-2 text-xs';
                    } else if (status === 'warning') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-yellow-500 ring-2 ring-yellow-400/50';
                        partStatus.textContent = '‚ö† Revisar manualmente';
                        partStatus.className = 'text-yellow-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-yellow-900/20 rounded-md px-3 py-2 text-xs border border-yellow-700/30';
                    } else if (status === 'error') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-red-500 ring-2 ring-red-400/50';
                        partStatus.textContent = '‚ùå Erro na gera√ß√£o';
                        partStatus.className = 'text-red-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-red-900/20 rounded-md px-3 py-2 text-xs border border-red-700/30';
                    }
                }
            }
            
            function handleScriptProgressUpdate(data) {
                const progressModal = document.getElementById('script-progress-modal');
                if (!progressModal || !data) return;
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const progressMainStatus = document.getElementById('progress-main-status');
                const progressSubStatus = document.getElementById('progress-sub-status');
                const progressPercentage = document.getElementById('progress-percentage');
                const progressPartsCounter = document.getElementById('progress-parts-counter');
                
                // Atualizar n√∫mero total de partes
                if (typeof data.totalParts === 'number') {
                    const rendered = parseInt(progressModal.dataset.renderedParts) || 0;
                    if (rendered !== data.totalParts) {
                        renderPartIndicators(data.totalParts);
                    }
                    progressModal.dataset.numberOfParts = data.totalParts;
                }
                
                // Atualizar parte atual e calcular porcentagem baseado em partes conclu√≠das
                let completedParts = 0;
                if (typeof data.currentPart === 'number') {
                    progressModal.dataset.currentPart = data.currentPart;
                    completedParts = data.currentPart;
                } else if (data.details && typeof data.details.completedParts !== 'undefined') {
                    completedParts = data.details.completedParts;
                } else if (data.details && data.details.status === 'completed' && data.details.partNumber) {
                    completedParts = data.details.partNumber;
                }
                
                    const totalParts = parseInt(progressModal.dataset.numberOfParts) || 1;
                
                // Atualizar contador de partes (X/5 partes)
                if (progressPartsCounter && completedParts > 0) {
                    progressPartsCounter.textContent = `${completedParts}/${totalParts} partes`;
                }
                
                // Calcular porcentagem baseado em partes conclu√≠das
                let calculatedProgress = 0;
                if (completedParts > 0 && totalParts > 0) {
                    calculatedProgress = Math.min(95, Math.round((completedParts / totalParts) * 100));
                } else if (typeof data.progress === 'number') {
                    calculatedProgress = data.progress;
                }
                
                // Atualizar barra de progresso e porcentagem
                if (progressBar && progressPercentage) {
                    const safeProgress = Math.max(0, Math.min(100, calculatedProgress));
                    progressBar.style.width = `${safeProgress}%`;
                    progressBar.style.transition = 'width 0.5s ease-out';
                    progressPercentage.textContent = `${Math.round(safeProgress)}%`;
                }
                
                // Atualizar mensagens principais e secund√°rias
                if (data.stage) {
                    const stageMessages = {
                        'preparing': {
                            main: 'Preparando IA do agente...',
                            sub: 'Carregando f√≥rmula viral e configura√ß√µes'
                        },
                        'generating': {
                            main: 'Gerando roteiro com IA...',
                            sub: data.details?.partNumber ? `Processando parte ${data.details.partNumber}...` : 'Criando conte√∫do otimizado'
                        },
                        'expanding': {
                            main: 'Expandindo conte√∫do...',
                            sub: 'Ajustando minutagem e detalhando narrativa'
                        },
                        'optimizing': {
                            main: 'Otimizando roteiro...',
                            sub: 'Aplicando melhorias e valida√ß√µes'
                        },
                        'validating': {
                            main: 'Validando qualidade...',
                            sub: 'Verificando estrutura e elementos virais'
                        },
                        'finalizing': {
                            main: 'Finalizando...',
                            sub: 'Preparando roteiro final'
                        }
                    };
                    
                    const stageInfo = stageMessages[data.stage] || {
                        main: data.message || 'Processando...',
                        sub: 'Aguarde enquanto geramos seu roteiro'
                    };
                    
                    if (progressMainStatus) progressMainStatus.textContent = stageInfo.main;
                    if (progressSubStatus) progressSubStatus.textContent = stageInfo.sub;
                } else if (data.message) {
                    if (progressMainStatus) progressMainStatus.textContent = data.message;
                    if (progressSubStatus) {
                        const progress = typeof data.progress === 'number' ? Math.round(data.progress) : 0;
                        progressSubStatus.textContent = `Progresso: ${progress}% - Aguarde...`;
                    }
                }
                
                if (data.message && progressText) {
                    progressText.textContent = data.message;
                }
                
                if (data.details && data.details.partNumber && data.details.status) {
                    updatePartProgress(
                        data.details.partNumber,
                        data.details.status,
                        data.details.percentage || 0
                    );
                    
                    // Atualizar contador de partes baseado no status
                    const totalParts = parseInt(progressModal.dataset.numberOfParts) || 1;
                    if (data.details.status === 'generating') {
                        // Parte come√ßando a ser gerada
                        if (progressPartsCounter) {
                            progressPartsCounter.textContent = `${data.details.partNumber}/${totalParts} partes`;
                        }
                        if (progressMainStatus) {
                        progressMainStatus.textContent = `Gerando parte ${data.details.partNumber}...`;
                        }
                        if (progressSubStatus) {
                        progressSubStatus.textContent = `Criando conte√∫do narrativo (${data.details.percentage || 0}%)`;
                        }
                        // Atualizar porcentagem baseado na parte sendo gerada
                        const partProgress = Math.min(95, 10 + ((data.details.partNumber - 1 + (data.details.percentage || 0) / 100) / totalParts) * 85);
                        if (progressBar) progressBar.style.width = `${partProgress}%`;
                        if (progressPercentage) progressPercentage.textContent = `${Math.round(partProgress)}%`;
                    } else if (data.details.status === 'expanding') {
                        if (progressMainStatus) {
                        progressMainStatus.textContent = `Expandindo parte ${data.details.partNumber}...`;
                        }
                        if (progressSubStatus) {
                        progressSubStatus.textContent = 'Ajustando minutagem e detalhando';
                        }
                    } else if (data.details.status === 'completed') {
                        // Parte conclu√≠da
                        if (progressPartsCounter) {
                            progressPartsCounter.textContent = `${data.details.partNumber}/${totalParts} partes`;
                        }
                        if (progressMainStatus) {
                        progressMainStatus.textContent = `Parte ${data.details.partNumber} conclu√≠da!`;
                        }
                        if (progressSubStatus) {
                            progressSubStatus.textContent = data.details.partNumber < totalParts ? 'Continuando com pr√≥xima parte...' : 'Finalizando roteiro...';
                        }
                        // Atualizar porcentagem baseado em partes conclu√≠das
                        const completedProgress = Math.min(95, 10 + (data.details.partNumber / totalParts) * 85);
                        if (progressBar) {
                            progressBar.style.width = `${completedProgress}%`;
                            progressBar.style.transition = 'width 0.5s ease-out';
                        }
                        if (progressPercentage) {
                            progressPercentage.textContent = `${Math.round(completedProgress)}%`;
                        }
                    }
                }
                
                if (data.stage === 'failed' || data.stage === 'error') {
                    if (progressMainStatus) progressMainStatus.textContent = 'Erro na gera√ß√£o';
                    if (progressSubStatus) progressSubStatus.textContent = 'Tente novamente em alguns instantes';
                    setTimeout(() => hideProgressModal(), 2000);
                }
            }
            
            function startProgressFallback(totalParts) {
                if (scriptProgressFallbackInterval) return;
                let fallbackValue = 0;
                scriptProgressFallbackInterval = setInterval(() => {
                    fallbackValue = Math.min(95, fallbackValue + (Math.random() * 6 + 3));
                    handleScriptProgressUpdate({
                        progress: fallbackValue,
                        message: `Gerando roteiro... (${Math.round(fallbackValue)}% estimado)`,
                        totalParts,
                        details: {
                            completedParts: Math.floor((fallbackValue / 100) * totalParts)
                        }
                    });
                }, 800);
            }
            
            function startScriptProgressStream(sessionId, totalParts) {
                currentProgressSessionId = sessionId;
                
                if (scriptProgressSource) {
                    scriptProgressSource.close();
                    scriptProgressSource = null;
                }
                if (scriptProgressFallbackInterval) {
                    clearInterval(scriptProgressFallbackInterval);
                    scriptProgressFallbackInterval = null;
                }
                
                if (typeof EventSource === 'undefined') {
                    startProgressFallback(totalParts);
                    return;
                }
                
                const source = new EventSource(`${API_BASE}/api/script-agents/progress/${sessionId}?token=${encodeURIComponent(userToken)}`);
                scriptProgressSource = source;
                source.onmessage = (event) => {
                    try {
                        const payload = JSON.parse(event.data);
                        handleScriptProgressUpdate(payload);
                    } catch (err) {
                        console.error('[Progresso] Erro ao ler SSE:', err);
                    }
                };
                source.onerror = () => {
                    if (scriptProgressSource) {
                        scriptProgressSource.close();
                        scriptProgressSource = null;
                    }
                    startProgressFallback(totalParts);
                };
            }
            
            function stopScriptProgressStream() {
                if (scriptProgressSource) {
                    scriptProgressSource.close();
                    scriptProgressSource = null;
                }
                if (scriptProgressFallbackInterval) {
                    clearInterval(scriptProgressFallbackInterval);
                    scriptProgressFallbackInterval = null;
                }
                currentProgressSessionId = null;
            }
            
            function hideProgressModal() {
                const progressModal = document.getElementById('script-progress-modal');
                if (progressModal) {
                    stopScriptProgressStream();
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) progressBar.style.width = '100%';
                    
                    setTimeout(() => {
                        progressModal.style.display = 'none';
                    }, 500);
                }
            }
            // ===== FIM DAS FUN√á√ïES DE PROGRESSO =====

            // Fun√ß√£o para formatar roteiro em partes (cada parte ~3 minutos, dividida em 5 par√°grafos)
            function formatScriptIntoParts(script, totalDuration) {
                if (!script || !script.trim()) {
                    return '<p class="text-gray-400">Roteiro vazio.</p>';
                }
                
                // Calcular n√∫mero de partes (cada parte = 3 minutos)
                const partDuration = 3;
                const numberOfParts = Math.max(1, Math.ceil(totalDuration / partDuration));
                
                // Dividir o texto em par√°grafos (separados por quebras de linha duplas ou pontos finais)
                let paragraphs = script
                    .split(/\n\n+/)
                    .map(p => p.trim())
                    .filter(p => p.length > 0);
                
                // Se n√£o houver par√°grafos claros, dividir por pontos finais
                if (paragraphs.length === 1 || paragraphs.length < numberOfParts) {
                    const sentences = script.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 0);
                    // Agrupar senten√ßas em par√°grafos de ~3-5 senten√ßas
                    paragraphs = [];
                    for (let i = 0; i < sentences.length; i += 4) {
                        paragraphs.push(sentences.slice(i, i + 4).join(' '));
                    }
                }
                
                // Calcular quantos par√°grafos por parte (5 par√°grafos por parte)
                const paragraphsPerPart = 5;
                const totalParagraphs = paragraphs.length;
                const paragraphsPerPartCalculated = Math.max(1, Math.ceil(totalParagraphs / numberOfParts));
                
                let formattedHTML = '';
                let currentParagraphIndex = 0;
                
                for (let partIndex = 0; partIndex < numberOfParts; partIndex++) {
                    const partNumber = partIndex + 1;
                    const startTime = partIndex * partDuration;
                    const endTime = Math.min(totalDuration, (partIndex + 1) * partDuration);
                    
                    formattedHTML += `
                        <div class="mb-8 pb-6 border-b border-gray-700/50 last:border-b-0">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-bold text-amber-400">PARTE ${partNumber}</h4>
                                <span class="text-sm text-gray-500">${String(Math.floor(startTime / 60)).padStart(2, '0')}:${String(startTime % 60).padStart(2, '0')} - ${String(Math.floor(endTime / 60)).padStart(2, '0')}:${String(endTime % 60).padStart(2, '0')}</span>
                            </div>
                            <div class="space-y-4">
                    `;
                    
                    // Pegar par√°grafos para esta parte
                    const partParagraphs = paragraphs.slice(
                        currentParagraphIndex,
                        currentParagraphIndex + paragraphsPerPartCalculated
                    );
                    
                    partParagraphs.forEach((paragraph) => {
                        formattedHTML += `
                            <p class="text-gray-300 leading-relaxed text-base">
                                ${escapeHtml(paragraph)}
                            </p>
                        `;
                    });
                    
                    currentParagraphIndex += partParagraphs.length;
                    
                    formattedHTML += `
                            </div>
                        </div>
                    `;
                    
                    // Se j√° processou todos os par√°grafos, parar
                    if (currentParagraphIndex >= totalParagraphs) {
                        break;
                    }
                }
                
                return formattedHTML;
            }

            function showScriptResult(script, agentName, duration = 5) {
                let resultModal = document.getElementById('script-result-modal');
                if (!resultModal) {
                    resultModal = document.createElement('div');
                    resultModal.id = 'script-result-modal';
                    resultModal.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center';
                    resultModal.innerHTML = `
                        <div class="bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Roteiro Gerado</h3>
                                <button id="close-script-result-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div id="script-result-content" class="prose prose-invert max-w-none text-gray-300"></div>
                            <div class="mt-4 flex space-x-2">
                                <button id="copy-script-result" class="flex-1 py-3 px-4 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold flex items-center justify-center space-x-2">
                                    <i data-lucide="copy"></i>
                                    <span>Copiar Roteiro</span>
                                </button>
                                <button id="download-srt-result" class="flex-1 py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-semibold flex items-center justify-center space-x-2">
                                    <i data-lucide="download"></i>
                                    <span>Baixar SRT</span>
                                </button>
                                <button id="close-script-result-btn" class="flex-1 py-3 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Fechar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(resultModal);

                    document.getElementById('close-script-result-modal').addEventListener('click', () => {
                        resultModal.style.display = 'none';
                    });
                    document.getElementById('close-script-result-btn').addEventListener('click', () => {
                        resultModal.style.display = 'none';
                    });
                    document.getElementById('copy-script-result').addEventListener('click', () => {
                        // Pegar o texto limpo (sem formata√ß√£o HTML) para copiar
                        const contentDiv = document.getElementById('script-result-content');
                        let content = contentDiv.textContent || contentDiv.innerText || '';
                        
                        // Remover marca√ß√µes de pausa dram√°tica (entre chaves {} ou colchetes [])
                        // Remover marca√ß√µes de PARTE X e intervalos de tempo
                        content = content
                            .replace(/\{[^}]*\}/g, '') // Remove {texto}
                            .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                            .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00"
                            .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00"
                            .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no in√≠cio da linha
                            .replace(/\s+/g, ' ') // Normalizar espa√ßos
                            .trim();
                        
                        navigator.clipboard.writeText(content).then(() => {
                            // Mostrar modal profissional de sucesso
                            showCopySuccessModal();
                        }).catch(err => {
                            console.error('Erro ao copiar:', err);
                            showCopySuccessModal();
                        });
                    });
                    
                    document.getElementById('download-srt-result').addEventListener('click', () => {
                        // Pegar o texto limpo (sem formata√ß√£o HTML) para gerar SRT
                        const contentDiv = document.getElementById('script-result-content');
                        let content = contentDiv.textContent || contentDiv.innerText || '';
                        
                        // Remover marca√ß√µes de pausa dram√°tica (entre chaves {} ou colchetes [])
                        // Remover marca√ß√µes de PARTE X e intervalos de tempo
                        content = content
                            .replace(/\{[^}]*\}/g, '') // Remove {texto}
                            .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                            .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00"
                            .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00"
                            .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no in√≠cio da linha
                            .replace(/\s+/g, ' ') // Normalizar espa√ßos
                            .trim();
                        
                        const savedDuration = resultModal.dataset.duration || duration || 5;
                        const srtContent = generateSRT(content, parseInt(savedDuration));
                        downloadSRT(srtContent, agentName || 'roteiro');
                    });
                }
                
                // Guardar dura√ß√£o para gerar SRT
                resultModal.dataset.duration = duration || 5;

                // Processar e limpar o script antes de exibir
                console.log('[Roteiro] showScriptResult chamado com:', typeof script, script?.substring?.(0, 100));
                
                let cleanScript = '';
                if (script) {
                    if (typeof script === 'string') {
                        cleanScript = script;
                    } else if (typeof script === 'object') {
                        cleanScript = JSON.stringify(script);
                    } else {
                        cleanScript = String(script);
                    }
                }
                
                // Se script estiver vazio, mostrar mensagem de erro
                if (!cleanScript || cleanScript.trim().length === 0) {
                    cleanScript = 'Erro: O roteiro n√£o foi gerado ou est√° vazio. Por favor, tente novamente.';
                    console.error('[Roteiro] Script vazio recebido');
                }
                
                // Se o script cont√©m JSON, extrair o conte√∫do
                if (typeof cleanScript === 'string' && cleanScript.includes('{')) {
                    try {
                        // Tentar parsear JSON
                        const jsonMatch = cleanScript.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const jsonObj = JSON.parse(jsonMatch[0]);
                            
                            // Extrair conte√∫do baseado na estrutura
                            if (jsonObj.script && Array.isArray(jsonObj.script)) {
                                cleanScript = jsonObj.script.map(item => {
                                    if (item.content) {
                                        const timeStr = item.time ? `[${item.time}] ` : '';
                                        return timeStr + item.content;
                                    }
                                    return '';
                                }).filter(Boolean).join('\n\n');
                            } else if (jsonObj.roteiro) {
                                cleanScript = jsonObj.roteiro;
                            } else if (jsonObj.content) {
                                cleanScript = jsonObj.content;
                            } else if (jsonObj.script && typeof jsonObj.script === 'string') {
                                cleanScript = jsonObj.script;
                            }
                        }
                    } catch (e) {
                        // Se falhar, tentar extra√ß√£o por regex
                        const roteiroMatch = cleanScript.match(/"roteiro"\s*:\s*"([^"]+)"/i);
                        if (roteiroMatch) {
                            cleanScript = roteiroMatch[1];
                        } else {
                            // Remover JSON manualmente
                            cleanScript = cleanScript
                                .replace(/\{[\s\S]*?"roteiro"[\s\S]*?\}/g, '')
                                .replace(/"roteiro"\s*:\s*"([^"]+)"/gi, '$1')
                                .replace(/"duracao"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/"estrutura"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/\{[\s\S]*\}/g, '')
                                .trim();
                        }
                    }
                }
                
                // Remover TODAS as marca√ß√µes para voice over (limpar completamente para narra√ß√£o)
                cleanScript = cleanScript
                    // Remover marca√ß√µes de PARTE X com intervalos de tempo (mais agressivo)
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "PARTE 1 0:00 - 3:00"
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "Parte 1 0:00 - 3:00"
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "PARTE 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "Parte 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00" (qualquer varia√ß√£o)
                    .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00" (qualquer varia√ß√£o)
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gmi, '') // Remove linha que come√ßa com "0:00 - 3:00"
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no in√≠cio da linha (sem quebra)
                    .replace(/PARTE\s+\d+\s*$/gmi, '') // Remove "PARTE 1" sozinho no final da linha
                    .replace(/Parte\s+\d+\s*$/gmi, '') // Remove "Parte 1" sozinho no final da linha
                    // Remover marca√ß√µes de cenas (Cena 1:, Cena 2:, etc.)
                    .replace(/^Cena\s+\d+:\s*/gmi, '') // Remove "Cena 1:", "Cena 2:", etc.
                    .replace(/^CENA\s+\d+:\s*/gmi, '') // Remove "CENA 1:", "CENA 2:", etc.
                    .replace(/^Scene\s+\d+:\s*/gmi, '') // Remove "Scene 1:", "Scene 2:", etc.
                    .replace(/^SCENE\s+\d+:\s*/gmi, '') // Remove "SCENE 1:", "SCENE 2:", etc.
                    .replace(/^Parte\s+\d+:\s*/gmi, '') // Remove "Parte 1:", "Parte 2:", etc.
                    .replace(/^PARTE\s+\d+:\s*/gmi, '') // Remove "PARTE 1:", "PARTE 2:", etc.
                    // Remover marca√ß√µes de tempo
                    .replace(/\[?\d{1,2}:\d{2}-\d{1,2}:\d{2}\]?\s*/g, '') // Remove [0:00-0:30]
                    .replace(/\(\d{1,2}:\d{2}\)\s*/g, '') // Remove (0:30)
                    .replace(/^\d{1,2}:\d{2}\s*/gm, '') // Remove 0:30 no in√≠cio da linha
                    // Remover t√≠tulos de se√ß√µes
                    .replace(/^[A-Z][A-Z\s]+:\s*/gm, '') // Remove t√≠tulos em mai√∫sculas seguidos de dois pontos
                    // Limpar espa√ßos e quebras excessivas
                    .replace(/\n{3,}/g, '\n\n') // Remove m√∫ltiplas quebras de linha
                    .replace(/^\s+/gm, '') // Remove espa√ßos no in√≠cio de cada linha
                    .replace(/\s+$/gm, '') // Remove espa√ßos no final de cada linha
                    .trim();
                
                // Formatar roteiro em partes (cada parte ~3 minutos, dividida em 5 par√°grafos)
                const formattedScript = formatScriptIntoParts(cleanScript, duration || 5);
                
                // Usar innerHTML para permitir formata√ß√£o HTML
                const contentDiv = document.getElementById('script-result-content');
                contentDiv.innerHTML = formattedScript;
                resultModal.style.display = 'flex';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            // Fun√ß√µes para modais estilizados (substituir alert e confirm)
            function showStyledAlert(message, title = 'Aviso') {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.id = 'styled-alert-modal';
                    modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center';
                    modal.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all animate-scale-in">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-6 ring-4 ring-amber-500/20">
                                    <i data-lucide="alert-circle" class="w-12 h-12 text-amber-400"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3 bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-400 bg-clip-text text-transparent">
                                    ${escapeHtml(title)}
                                </h3>
                                <p class="text-gray-300 text-sm mb-6 whitespace-pre-wrap">
                                    ${escapeHtml(message)}
                                </p>
                                <button id="styled-alert-ok" class="w-full py-3 px-6 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold transition-colors flex items-center justify-center space-x-2">
                                    <span>OK</span>
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Animar entrada
                    setTimeout(() => {
                        const content = modal.querySelector('.animate-scale-in');
                        if (content) {
                            content.style.transform = 'scale(1)';
                            content.style.opacity = '1';
                        }
                    }, 10);
                    
                    // Fechar ao clicar no bot√£o
                    document.getElementById('styled-alert-ok').addEventListener('click', () => {
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                            resolve();
                        }, 200);
                    });
                    
                    // Fechar ao clicar fora
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.opacity = '0';
                            modal.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                modal.remove();
                                resolve();
                            }, 200);
                }
                    });
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            }
            
            function showStyledConfirm(message, title = 'Confirma√ß√£o') {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.id = 'styled-confirm-modal';
                    modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center';
                    modal.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all animate-scale-in">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-6 ring-4 ring-amber-500/20">
                                    <i data-lucide="help-circle" class="w-12 h-12 text-amber-400"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3 bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-400 bg-clip-text text-transparent">
                                    ${escapeHtml(title)}
                                </h3>
                                <p class="text-gray-300 text-sm mb-6 whitespace-pre-wrap">
                                    ${escapeHtml(message)}
                                </p>
                                <div class="flex space-x-3">
                                    <button id="styled-confirm-cancel" class="flex-1 py-3 px-6 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors">
                                        Cancelar
                                    </button>
                                    <button id="styled-confirm-ok" class="flex-1 py-3 px-6 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold transition-colors">
                                        Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Animar entrada
                    setTimeout(() => {
                        const content = modal.querySelector('.animate-scale-in');
                        if (content) {
                            content.style.transform = 'scale(1)';
                            content.style.opacity = '1';
                        }
                    }, 10);
                    
                    const closeModal = (result) => {
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                            resolve(result);
                        }, 200);
                    };
                    
                    // Fechar ao clicar nos bot√µes
                    document.getElementById('styled-confirm-ok').addEventListener('click', () => closeModal(true));
                    document.getElementById('styled-confirm-cancel').addEventListener('click', () => closeModal(false));
                
                    // Fechar ao clicar fora (cancela)
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeModal(false);
                        }
                    });
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            }
            
            // Substituir alert e confirm globais
            window.alert = showStyledAlert;
            window.confirm = showStyledConfirm;
            
            // Fun√ß√£o para mostrar modal profissional de sucesso ao copiar
            function showCopySuccessModal() {
                // Remover modal anterior se existir
                const existingModal = document.getElementById('copy-success-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const modal = document.createElement('div');
                modal.id = 'copy-success-modal';
                modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center';
                modal.innerHTML = `
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all animate-scale-in">
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-emerald-600/20 rounded-full mb-6 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-3 bg-gradient-to-r from-green-400 via-emerald-400 to-green-400 bg-clip-text text-transparent">
                                Roteiro Copiado!
                            </h3>
                            <p class="text-gray-300 text-sm mb-6">
                                O roteiro foi copiado para a √°rea de transfer√™ncia e est√° pronto para uso.
                            </p>
                            <button id="close-copy-success-modal" class="w-full py-3 px-6 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold transition-colors flex items-center justify-center space-x-2">
                                <span>OK</span>
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Animar entrada
                setTimeout(() => {
                    modal.querySelector('.animate-scale-in').style.transform = 'scale(1)';
                    modal.querySelector('.animate-scale-in').style.opacity = '1';
                }, 10);
                
                // Fechar ao clicar no bot√£o
                document.getElementById('close-copy-success-modal').addEventListener('click', () => {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        modal.remove();
                    }, 200);
                });
                
                // Fechar ao clicar fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                        }, 200);
                    }
                });
                
                // Fechar automaticamente ap√≥s 3 segundos
                setTimeout(() => {
                    if (document.getElementById('copy-success-modal')) {
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                        }, 200);
                    }
                }, 3000);
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            function generateSRT(text, duration) {
                // Remover marca√ß√µes de pausa dram√°tica (entre chaves {} ou colchetes [])
                // Remover marca√ß√µes de PARTE X e intervalos de tempo (mais agressivo)
                let cleanText = text
                    .replace(/\{[^}]*\}/g, '') // Remove {texto}
                    .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "PARTE 1 0:00 - 3:00"
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "Parte 1 0:00 - 3:00"
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "PARTE 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "Parte 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00" (qualquer varia√ß√£o)
                    .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00" (qualquer varia√ß√£o)
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gmi, '') // Remove linha que come√ßa com "0:00 - 3:00"
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no in√≠cio da linha (sem quebra)
                    .replace(/PARTE\s+\d+\s*$/gmi, '') // Remove "PARTE 1" sozinho no final da linha
                    .replace(/Parte\s+\d+\s*$/gmi, '') // Remove "Parte 1" sozinho no final da linha
                    .replace(/\[?\d{1,2}:\d{2}-\d{1,2}:\d{2}\]?\s*/g, '') // Remove marca√ß√µes de tempo [0:00-0:30]
                    .replace(/\(\d{1,2}:\d{2}\)\s*/g, '') // Remove (0:30)
                    .replace(/^\d{1,2}:\d{2}\s*/gm, '') // Remove 0:30 no in√≠cio da linha
                    .replace(/\s+/g, ' ') // Normalizar espa√ßos
                    .trim();
                
                // Dividir texto em partes de at√© 499 caracteres, respeitando palavras e frases
                const maxChars = 499;
                const gapBetweenSubtitles = 10; // 10 segundos entre partes
                const parts = [];
                let currentPart = '';
                
                // Dividir por frases completas primeiro (pontos, exclama√ß√£o, interroga√ß√£o)
                const sentences = cleanText.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 0);
                
                for (const sentence of sentences) {
                    const sentenceTrimmed = sentence.trim();
                    
                    // Se a frase sozinha j√° ultrapassa 499 caracteres, dividir por v√≠rgulas
                    if (sentenceTrimmed.length > maxChars) {
                        // Se j√° tem uma parte em constru√ß√£o, salv√°-la
                        if (currentPart.trim()) {
                            parts.push(currentPart.trim());
                            currentPart = '';
                        }
                        
                        // Dividir a frase longa por v√≠rgulas ou pontos e v√≠rgulas
                        const subParts = sentenceTrimmed.split(/(?<=[,;])\s+/);
                        for (const subPart of subParts) {
                            if ((currentPart + ' ' + subPart).trim().length <= maxChars) {
                                currentPart += (currentPart ? ' ' : '') + subPart;
                            } else {
                                if (currentPart.trim()) {
                                    parts.push(currentPart.trim());
                                }
                                // Se a subparte sozinha √© maior que 499, dividir por espa√ßos (palavras)
                                if (subPart.length > maxChars) {
                                    const words = subPart.split(/\s+/);
                                    let wordPart = '';
                                    for (const word of words) {
                                        if ((wordPart + ' ' + word).trim().length <= maxChars) {
                                            wordPart += (wordPart ? ' ' : '') + word;
                    } else {
                                            if (wordPart.trim()) {
                                                parts.push(wordPart.trim());
                                            }
                                            wordPart = word;
                                        }
                                    }
                                    currentPart = wordPart;
                                } else {
                                    currentPart = subPart;
                                }
                            }
                        }
                    } else {
                        // Verificar se adicionar esta frase ultrapassa 499 caracteres
                        const testPart = currentPart ? currentPart + ' ' + sentenceTrimmed : sentenceTrimmed;
                        if (testPart.length <= maxChars) {
                            currentPart = testPart;
                        } else {
                            // Salvar parte atual e come√ßar nova
                            if (currentPart.trim()) {
                                parts.push(currentPart.trim());
                            }
                            currentPart = sentenceTrimmed;
                        }
                    }
                }
                
                // Adicionar √∫ltima parte se houver
                if (currentPart.trim()) {
                    parts.push(currentPart.trim());
                }
                
                // Calcular tempo total (dura√ß√£o em segundos)
                const totalSeconds = duration * 60;
                
                // Calcular tempo por parte considerando os espa√ßos de 10 segundos
                const totalGapTime = (parts.length - 1) * gapBetweenSubtitles;
                const availableTime = Math.max(totalSeconds - totalGapTime, totalSeconds * 0.5);
                const secondsPerPart = availableTime / Math.max(parts.length, 1);
                
                // Gerar SRT
                let srtContent = '';
                let currentTime = 0;
                let subtitleIndex = 1;
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                        const startTime = formatSRTTime(currentTime);
                    const displayDuration = Math.max(secondsPerPart, 3); // M√≠nimo 3 segundos
                        currentTime += displayDuration;
                    const endTime = formatSRTTime(currentTime);
                        
                    srtContent += `${subtitleIndex}\n${startTime} --> ${endTime}\n${part}\n\n`;
                        subtitleIndex++;
                        
                    // Adicionar espa√ßo de 10 segundos antes da pr√≥xima parte (exceto na √∫ltima)
                    if (i < parts.length - 1) {
                            currentTime += gapBetweenSubtitles;
                    }
                }
                
                return srtContent;
            }
            
            function formatSRTTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                const milliseconds = Math.floor((seconds % 1) * 1000);
                
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')},${String(milliseconds).padStart(3, '0')}`;
            }
            
            function downloadSRT(content, filename) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename.replace(/[^a-z0-9]/gi, '_')}.srt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async function loadBibliotecaThumbnails() {
                console.log('[Biblioteca] Carregando thumbnails...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usu√°rio n√£o encontrado');
                    return;
                }
                try {
                    const search = document.getElementById('biblioteca-search')?.value || '';
                    const niche = document.getElementById('biblioteca-niche-filter')?.value || '';
                    const minViews = document.getElementById('biblioteca-views-filter')?.value || '';
                    const favoritesBtn = document.getElementById('biblioteca-favorites-only');
                    const favorites = favoritesBtn?.classList.contains('active') ? 'true' : '';

                    let url = `${API_BASE}/api/library/thumbnails?`;
                    if (search) url += `search=${encodeURIComponent(search)}&`;
                    if (niche) url += `niche=${encodeURIComponent(niche)}&`;
                    if (minViews) url += `minViews=${minViews}&`;
                    if (favorites) url += `favorite=${favorites}&`;

                    console.log('[Biblioteca] URL thumbnails:', url);
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('[Biblioteca] Resposta thumbnails:', response.status);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar thumbnails: ${response.status}`);
                    }
                    const thumbnails = await response.json();
                    console.log('[Biblioteca] Thumbnails recebidos:', thumbnails.length);

                    const list = document.getElementById('biblioteca-thumbnails-list');
                    if (list) {
                        if (thumbnails.length > 0) {
                            list.innerHTML = thumbnails.map(thumb => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 relative overflow-hidden">
                                    ${thumb.thumbnail_url ? `
                                        <div class="w-full h-48 mb-3 rounded-lg overflow-hidden bg-gray-900 flex items-center justify-center">
                                            <img src="${escapeHtml(thumb.thumbnail_url)}" alt="Thumbnail" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<p class=\\'text-gray-500 text-xs\\'>Erro ao carregar imagem</p>'">
                                        </div>
                                    ` : ''}
                                    ${!thumb.thumbnail_url && thumb.thumbnail_description ? `
                                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 mb-3 min-h-[120px] flex items-center justify-center">
                                            <p class="text-gray-400 text-xs text-center line-clamp-4" title="${escapeHtml(thumb.thumbnail_description)}">${escapeHtml(thumb.thumbnail_description.substring(0, 200))}${thumb.thumbnail_description.length > 200 ? '...' : ''}</p>
                                        </div>
                                    ` : ''}
                                    <div class="flex items-start justify-between gap-2">
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-white font-semibold text-sm mb-1 truncate" title="${escapeHtml(thumb.niche || 'N/A')} ‚Ä¢ ${escapeHtml(thumb.subniche || 'N/A')}">${escapeHtml(thumb.niche || 'N/A')} ‚Ä¢ ${escapeHtml(thumb.subniche || 'N/A')}</h3>
                                            <p class="text-gray-400 text-xs mb-1">${formatNumber(parseInt(thumb.original_views || 0))} views${thumb.original_ctr ? ` ‚Ä¢ CTR: ${(parseFloat(thumb.original_ctr || 0)).toFixed(1)}%` : ''}</p>
                                            ${thumb.style ? `<p class="text-gray-500 text-xs mb-1 truncate">Estilo: ${escapeHtml(thumb.style)}</p>` : ''}
                                            ${thumb.viral_score ? `<p class="text-amber-400 text-xs mb-1">Score Viral: ${thumb.viral_score}/10</p>` : ''}
                                        </div>
                                        <div class="flex items-center gap-1 flex-shrink-0">
                                            <button onclick="toggleThumbnailFavorite(${thumb.id}, ${thumb.is_favorite || 0})" class="p-2 ${thumb.is_favorite ? 'text-red-600 fill-red-600' : 'text-gray-400'} hover:text-red-500 transition-colors" title="${thumb.is_favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                                                <i data-lucide="heart" class="w-4 h-4 ${thumb.is_favorite ? 'fill-current' : ''}"></i>
                                            </button>
                                            <button onclick="deleteThumbnailFromLibrary(${thumb.id})" class="p-2 text-red-600 hover:text-red-500 transition-colors" title="Excluir thumbnail">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${thumb.thumbnail_description ? `
                                        <div class="mt-3 pt-3 border-t border-gray-700">
                                            <p class="text-gray-500 text-xs mb-2 line-clamp-3" title="${escapeHtml(thumb.thumbnail_description)}">${escapeHtml(thumb.thumbnail_description)}</p>
                                            <div class="flex items-center gap-2">
                                                ${thumb.thumbnail_url ? `
                                                    <button class="btn-download-thumbnail flex-1 py-1.5 px-3 bg-amber-600 hover:bg-amber-500 text-black rounded-lg font-bold text-xs flex items-center justify-center gap-1" data-url="${escapeHtml(thumb.thumbnail_url)}" data-title="${escapeHtml((thumb.thumbnail_description || '').substring(0, 30))}" title="Baixar imagem">
                                                        <i data-lucide="download" class="w-3 h-3"></i>
                                                        <span>Baixar</span>
                                                    </button>
                                                ` : ''}
                                                <button class="btn-copy-thumbnail-prompt flex-1 py-1.5 px-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1" data-prompt="${escapeHtml(thumb.thumbnail_description)}" title="Copiar prompt">
                                                    <i data-lucide="copy" class="w-3 h-3"></i>
                                                    <span>Copiar Prompt</span>
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            list.innerHTML = '<p class="text-gray-400">Nenhuma thumbnail encontrada. As thumbnails ser√£o salvas automaticamente quando voc√™ gerar ideias de thumbnail no Analisador de T√≠tulos Virais.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar thumbnails:', err);
                    const list = document.getElementById('biblioteca-thumbnails-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar thumbnails: ${err.message}</p>`;
                    }
                }
            }

            window.toggleTitleFavorite = async function(id, currentState) {
                try {
                    const response = await fetch(`${API_BASE}/api/library/titles/${id}/favorite`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isFavorite: !currentState })
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar favorito.');
                    await loadBibliotecaTitles();
                } catch (err) {
                    console.error('Erro ao atualizar favorito:', err);
                }
            };

            window.toggleThumbnailFavorite = async function(id, currentState) {
                try {
                    const response = await fetch(`${API_BASE}/api/library/thumbnails/${id}/favorite`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isFavorite: !currentState })
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar favorito.');
                    await loadBibliotecaThumbnails();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao atualizar favorito:', err);
                    showMessage('biblioteca-error-message', 'Erro ao atualizar favorito.', true);
                }
            };

            window.deleteTitleFromLibrary = async function(id) {
                if (!confirm('Tem certeza que deseja excluir este t√≠tulo da biblioteca? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/api/library/titles/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || 'Falha ao excluir t√≠tulo.');
                    }
                    await loadBibliotecaTitles();
                    showMessage('biblioteca-success-message', 'T√≠tulo exclu√≠do da biblioteca com sucesso!');
                } catch (err) {
                    showMessage('biblioteca-error-message', err.message, true);
                }
            };

            window.deleteThumbnailFromLibrary = async function(id) {
                if (!confirm('Tem certeza que deseja excluir esta thumbnail da biblioteca? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/api/library/thumbnails/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || 'Falha ao excluir thumbnail.');
                    }
                    await loadBibliotecaThumbnails();
                    showMessage('biblioteca-success-message', 'Thumbnail exclu√≠da da biblioteca com sucesso!');
                } catch (err) {
                    showMessage('biblioteca-error-message', err.message, true);
                }
            };

            // Event delegation para bot√µes de download e copiar prompt
            document.addEventListener('click', async (e) => {
                // Download de thumbnail
                if (e.target.closest('.btn-download-thumbnail')) {
                    const btn = e.target.closest('.btn-download-thumbnail');
                    const imageUrl = btn.getAttribute('data-url');
                    const title = btn.getAttribute('data-title') || 'thumbnail';
                    
                    try {
                        // Tentar download direto primeiro
                        const link = document.createElement('a');
                        link.href = imageUrl;
                        link.download = `${title.replace(/[^a-z0-9]/gi, '_')}.jpg`;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Mensagem de sucesso
                        setTimeout(() => {
                            showMessage('biblioteca-success-message', 'Download iniciado! Se n√£o funcionar devido a CORS, a imagem ser√° aberta em nova aba.');
                        }, 100);
                    } catch (err) {
                        console.error('Erro ao baixar imagem:', err);
                        // Fallback: abrir em nova aba
                        window.open(imageUrl, '_blank');
                        showMessage('biblioteca-success-message', 'Imagem aberta em nova aba. Use "Salvar imagem como..." do navegador.');
                    }
                }
                
                // Copiar prompt
                if (e.target.closest('.btn-copy-thumbnail-prompt')) {
                    const btn = e.target.closest('.btn-copy-thumbnail-prompt');
                    const prompt = btn.getAttribute('data-prompt');
                    
                    if (!prompt) {
                        showMessage('biblioteca-error-message', 'Prompt n√£o encontrado.', true);
                        return;
                    }
                    
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(prompt);
                            showMessage('biblioteca-success-message', 'Prompt copiado para a √°rea de transfer√™ncia!');
                        } else {
                            // Fallback para navegadores mais antigos
                            const textarea = document.createElement('textarea');
                            textarea.value = prompt;
                            textarea.style.position = 'fixed';
                            textarea.style.opacity = '0';
                            textarea.style.left = '-9999px';
                            document.body.appendChild(textarea);
                            textarea.select();
                            textarea.setSelectionRange(0, 99999); // Para mobile
                            const success = document.execCommand('copy');
                            document.body.removeChild(textarea);
                            if (success) {
                                showMessage('biblioteca-success-message', 'Prompt copiado para a √°rea de transfer√™ncia!');
                            } else {
                                throw new Error('Falha ao copiar');
                            }
                        }
                    } catch (err) {
                        console.error('Erro ao copiar prompt:', err);
                        showMessage('biblioteca-error-message', 'Erro ao copiar prompt. Tente selecionar e copiar manualmente.', true);
                    }
                }
            });

            const bibliotecaSearch = document.getElementById('biblioteca-search');
            const bibliotecaNicheFilter = document.getElementById('biblioteca-niche-filter');
            const bibliotecaViewsFilter = document.getElementById('biblioteca-views-filter');
            const bibliotecaFavoritesOnly = document.getElementById('biblioteca-favorites-only');

            if (bibliotecaSearch) {
                bibliotecaSearch.addEventListener('input', () => {
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles();
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails();
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            if (bibliotecaNicheFilter) {
                bibliotecaNicheFilter.addEventListener('change', () => {
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles();
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails();
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            if (bibliotecaViewsFilter) {
                bibliotecaViewsFilter.addEventListener('change', () => {
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles();
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails();
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            if (bibliotecaFavoritesOnly) {
                bibliotecaFavoritesOnly.addEventListener('click', function() {
                    this.classList.toggle('active');
                    this.classList.toggle('bg-amber-600');
                    this.classList.toggle('text-white');
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles();
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails();
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            // === FUNCIONALIDADES DE INTEGRA√á√ÉO YOUTUBE ===
            // Vari√°vel para controlar atualiza√ß√£o autom√°tica de canais
            let youtubeChannelsRefreshInterval = null;

            async function loadYouTubeIntegrationStatus() {
                try {
                    // Obter token dentro da fun√ß√£o para garantir que est√° dispon√≠vel
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        console.warn('[YouTube Integration] Token n√£o encontrado');
                        const channelsList = document.getElementById('youtube-channels-list');
                        if (channelsList) {
                            channelsList.innerHTML = '<p class="text-red-400">Erro: Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.</p>';
                        }
                        return;
                    }
                    
                    if (typeof API_BASE === 'undefined') {
                        console.error('[YouTube Integration] API_BASE n√£o est√° definido');
                        const channelsList = document.getElementById('youtube-channels-list');
                        if (channelsList) {
                            channelsList.innerHTML = '<p class="text-red-400">Erro: API_BASE n√£o est√° definido. Recarregue a p√°gina.</p>';
                        }
                        return;
                    }
                    
                    // Buscar lista de canais
                    const response = await fetch(`${API_BASE}/api/youtube/channels`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Falha ao carregar canais');
                    }
                    
                    const data = await response.json();
                    const channelsList = document.getElementById('youtube-channels-list');
                    const btnConnect = document.getElementById('btn-connect-youtube');
                    
                    if (channelsList) {
                        if (data.channels && data.channels.length > 0) {
                            channelsList.innerHTML = data.channels.map(channel => `
                                <div class="bg-gray-800 border ${channel.isExpired ? 'border-yellow-700' : 'border-green-700'} rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3 flex-1">
                                            <i data-lucide="${channel.isExpired ? 'alert-circle' : 'check-circle'}" class="w-5 h-5 ${channel.isExpired ? 'text-yellow-500' : 'text-green-500'}"></i>
                                            <div class="flex-1">
                                                <p class="text-white font-semibold">${escapeHtml(channel.channelName || 'Canal do YouTube')}</p>
                                                <p class="text-gray-400 text-xs">ID: ${escapeHtml(channel.channelId || 'N/A')}</p>
                                                ${channel.niche || channel.subniche ? `
                                                    <div class="mt-2 flex flex-wrap gap-2">
                                                        ${channel.niche ? `<span class="px-2 py-1 bg-amber-600/20 text-amber-400 rounded text-xs border border-amber-600/30">üìå ${escapeHtml(channel.niche)}</span>` : ''}
                                                        ${channel.subniche ? `<span class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-xs border border-blue-600/30">üéØ ${escapeHtml(channel.subniche)}</span>` : ''}
                                                    </div>
                                                ` : '<p class="text-gray-500 text-xs mt-1">‚è≥ Analisando nicho...</p>'}
                                                ${channel.isExpired ? '<p class="text-yellow-400 text-xs mt-1">‚ö†Ô∏è Token expirado</p>' : ''}
                                            </div>
                                        </div>
                                        <button onclick="disconnectChannel(${channel.id})" class="ml-4 py-2 px-3 rounded-lg bg-red-600 hover:bg-red-500 text-white text-sm font-semibold transition duration-300">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            
                            // Mostrar contador
                            const statusDiv = document.getElementById('youtube-integration-status');
                            if (statusDiv) {
                                statusDiv.innerHTML = `<p class="text-gray-400 text-sm">${data.count} de ${data.maxChannels} canais conectados</p>`;
                            }
                            
                            // Desabilitar bot√£o se atingiu o limite
                            if (btnConnect && data.count >= data.maxChannels) {
                                btnConnect.disabled = true;
                                btnConnect.innerHTML = '<i data-lucide="x"></i><span>Limite atingido (10 canais)</span>';
                            } else if (btnConnect) {
                                btnConnect.disabled = false;
                                btnConnect.innerHTML = '<i data-lucide="plus"></i><span>Adicionar Canal</span>';
                            }
                        } else {
                            channelsList.innerHTML = '<p class="text-gray-400">Nenhum canal conectado. Clique em "Adicionar Canal" para come√ßar.</p>';
                            const statusDiv = document.getElementById('youtube-integration-status');
                            if (statusDiv) {
                                statusDiv.innerHTML = '';
                            }
                        }
                    }
                    
                    // Atualizar √≠cones do Lucide
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('[YouTube Integration] Erro ao carregar canais:', err);
                    const channelsList = document.getElementById('youtube-channels-list');
                    if (channelsList) {
                        channelsList.innerHTML = `<p class="text-red-400">Erro ao carregar canais: ${err.message}</p>`;
                    }
                    // Parar atualiza√ß√£o autom√°tica em caso de erro
                    if (youtubeChannelsRefreshInterval) {
                        clearInterval(youtubeChannelsRefreshInterval);
                        youtubeChannelsRefreshInterval = null;
                    }
                }
            }
            
            // Fun√ß√£o para desconectar um canal
            window.disconnectChannel = async function(channelId) {
                if (!confirm('Tem certeza que deseja desconectar este canal?')) {
                    return;
                }
                
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        showMessage('youtube-integration-error-message', 'Token de autentica√ß√£o n√£o encontrado.', true);
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/youtube/channels/${channelId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.msg || 'Falha ao desconectar canal');
                    }
                    
                    showMessage('youtube-integration-success-message', 'Canal desconectado com sucesso!');
                    await loadYouTubeIntegrationStatus(); // Recarregar lista
                } catch (err) {
                    console.error('[YouTube Integration] Erro ao desconectar:', err);
                    showMessage('youtube-integration-error-message', err.message, true);
                }
            }

            const btnConnectYouTube = document.getElementById('btn-connect-youtube');
            if (btnConnectYouTube) {
                btnConnectYouTube.addEventListener('click', async () => {
                    try {
                        // Obter token dentro da fun√ß√£o
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            showMessage('youtube-integration-error-message', 'Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.', true);
                            return;
                        }
                        
                        if (typeof API_BASE === 'undefined') {
                            showMessage('youtube-integration-error-message', 'API_BASE n√£o est√° definido. Recarregue a p√°gina.', true);
                            return;
                        }
                        
                        const response = await fetch(`${API_BASE}/api/youtube/oauth/authorize`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.msg || 'Falha ao obter URL de autoriza√ß√£o.');
                        }
                        const data = await response.json();
                        window.open(data.authUrl, '_blank');
                        showMessage('youtube-integration-success-message', 'Autorize o acesso no popup que foi aberto.');
                    } catch (err) {
                        console.error('[YouTube Integration] Erro ao conectar:', err);
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            async function loadScheduledPosts() {
                try {
                    // Obter token dentro da fun√ß√£o para garantir que est√° dispon√≠vel
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        console.warn('[YouTube Integration] Token n√£o encontrado');
                        const list = document.getElementById('scheduled-posts-list');
                        if (list) {
                            list.innerHTML = '<p class="text-red-400">Erro: Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.</p>';
                        }
                        return;
                    }
                    
                    if (typeof API_BASE === 'undefined') {
                        console.error('[YouTube Integration] API_BASE n√£o est√° definido');
                        const list = document.getElementById('scheduled-posts-list');
                        if (list) {
                            list.innerHTML = '<p class="text-red-400">Erro: API_BASE n√£o est√° definido. Recarregue a p√°gina.</p>';
                        }
                        return;
                    }
                    
                    console.log('[YouTube] Carregando publica√ß√µes agendadas...', { API_BASE, hasToken: !!token });
                    console.log('[YouTube] Fazendo requisi√ß√£o para:', `${API_BASE}/api/youtube/scheduled`);
                    const response = await fetch(`${API_BASE}/api/youtube/scheduled`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    console.log('[YouTube] Resposta:', response.status);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar publica√ß√µes agendadas: ${response.status}`);
                    }
                    const scheduled = await response.json();
                    const scheduledArray = Array.isArray(scheduled) ? scheduled : [];
                    console.log('[YouTube] Publica√ß√µes recebidas:', scheduledArray.length);

                    const list = document.getElementById('scheduled-posts-list');
                    if (list) {
                        if (scheduledArray.length > 0) {
                            list.innerHTML = scheduledArray.map(post => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <h3 class="text-white font-semibold">${escapeHtml(post.title || 'Sem t√≠tulo')}</h3>
                                    <p class="text-gray-400 text-sm">Agendado para: ${post.scheduled_time ? new Date(post.scheduled_time).toLocaleString('pt-BR') : 'N/A'}</p>
                                    <p class="text-gray-400 text-sm">Status: <span class="px-2 py-1 text-xs rounded ${post.status === 'published' ? 'bg-green-600' : post.status === 'failed' ? 'bg-red-600' : 'bg-yellow-600'}">${escapeHtml(post.status || 'pending')}</span></p>
                                    ${post.description ? `<p class="text-gray-500 text-xs mt-2 line-clamp-2">${escapeHtml(post.description)}</p>` : ''}
                                </div>
                            `).join('');
                        } else {
                            list.innerHTML = '<p class="text-gray-400">Nenhuma publica√ß√£o agendada.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar publica√ß√µes agendadas:', err);
                    const list = document.getElementById('scheduled-posts-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar publica√ß√µes: ${err.message}</p>`;
                    }
                }
            }

            // ============================================
            // üé® PROMTPS E IMAGENS - L√≥gica Integrada
            // ============================================
            
            let scenePromptsData = [];
            
            // Fun√ß√£o para calcular estimativa de cenas
            function calculateSceneEstimate() {
                const scriptText = document.getElementById('scene-script-text');
                const modeSelect = document.getElementById('scene-generation-mode');
                const wordsPerScene = document.getElementById('scene-words-per-scene');
                const estimateBox = document.getElementById('estimated-scenes-count');
                
                if (!scriptText || !modeSelect || !estimateBox) return;
                
                const text = scriptText.value.trim();
                const words = text.split(/\s+/).filter(Boolean).length;
                const mode = modeSelect.value;
                
                let estimatedScenes = 0;
                if (mode === 'automatic') {
                    // Modo autom√°tico: 1 cena a cada ~90 palavras
                    estimatedScenes = Math.max(1, Math.round(words / 90));
                } else {
                    // Modo manual: baseado no campo "Gerar a cada X palavras"
                    const wordsPer = parseInt(wordsPerScene?.value || 100);
                    estimatedScenes = Math.max(1, Math.round(words / wordsPer));
                }
                
                estimateBox.textContent = `${estimatedScenes} cena${estimatedScenes !== 1 ? 's' : ''}`;
            }
            
            // Contador de palavras e c√°lculo de estimativa
            const sceneScriptText = document.getElementById('scene-script-text');
            const sceneWordCount = document.getElementById('scene-word-count');
            const sceneGenerationMode = document.getElementById('scene-generation-mode');
            const sceneWordsPerScene = document.getElementById('scene-words-per-scene');
            const manualModeSettings = document.getElementById('manual-mode-settings');
            
            if (sceneScriptText && sceneWordCount) {
                sceneScriptText.addEventListener('input', () => {
                    const text = sceneScriptText.value.trim();
                    const words = text.split(/\s+/).filter(Boolean).length;
                    sceneWordCount.textContent = `${words} palavras`;
                    calculateSceneEstimate();
                });
            }
            
            // Mostrar/esconder campo manual baseado no modo
            if (sceneGenerationMode && manualModeSettings) {
                sceneGenerationMode.addEventListener('change', () => {
                    if (sceneGenerationMode.value === 'manual') {
                        manualModeSettings.classList.remove('hidden');
                    } else {
                        manualModeSettings.classList.add('hidden');
                    }
                    calculateSceneEstimate();
                });
            }
            
            // Atualizar estimativa quando mudar palavras por cena
            if (sceneWordsPerScene) {
                sceneWordsPerScene.addEventListener('input', calculateSceneEstimate);
            }
            
            // Fun√ß√µes do modal de agentes
            window.openAgentModal = function() {
                const modal = document.getElementById('select-agent-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    loadAgentsList();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            };
            
            window.closeAgentModal = function() {
                const modal = document.getElementById('select-agent-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            };
            
            async function loadAgentsList() {
                const agentsList = document.getElementById('agents-list');
                if (!agentsList) return;
                
                try {
                    agentsList.innerHTML = '<p class="text-gray-400 text-center py-8">Carregando agentes...</p>';
                    
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        agentsList.innerHTML = '<p class="text-red-400 text-center py-8">Token n√£o encontrado.</p>';
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/script-agents`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao carregar agentes');
                    }
                    
                    const data = await response.json();
                    const agents = data.agents || [];
                    
                    if (agents.length === 0) {
                        agentsList.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhum agente encontrado. Crie um agente primeiro.</p>';
                        return;
                    }
                    
                    // Para cada agente, buscar seus roteiros
                    const agentsWithScripts = await Promise.all(agents.map(async (agent) => {
                        try {
                            const scriptsResponse = await fetch(`${API_BASE}/api/scripts?agentId=${agent.id}&limit=10`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            
                            if (scriptsResponse.ok) {
                                const scriptsData = await scriptsResponse.json();
                                return {
                                    ...agent,
                                    scripts: scriptsData.scripts || []
                                };
                            }
                        } catch (e) {
                            console.error(`Erro ao buscar roteiros do agente ${agent.id}:`, e);
                        }
                        return { ...agent, scripts: [] };
                    }));
                    
                    agentsList.innerHTML = agentsWithScripts.map(agent => {
                        if (agent.scripts.length === 0) {
                            return `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <h4 class="text-white font-semibold mb-1">${escapeHtml(agent.name || 'Agente sem nome')}</h4>
                                    <p class="text-gray-400 text-sm">Nenhum roteiro gerado ainda</p>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                <h4 class="text-white font-semibold mb-2">${escapeHtml(agent.name || 'Agente sem nome')}</h4>
                                <p class="text-gray-400 text-xs mb-3">${agent.scripts.length} roteiro(s) dispon√≠vel(is)</p>
                                <div class="space-y-2">
                                    ${agent.scripts.map(script => `
                                        <button onclick="importScriptFromAgent(${script.id}, '${escapeHtml(script.title || 'Sem t√≠tulo')}')" 
                                                class="w-full text-left px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-gray-200 transition duration-200">
                                            <div class="font-medium">${escapeHtml(script.title || 'Roteiro sem t√≠tulo')}</div>
                                            <div class="text-xs text-gray-400 mt-1">${new Date(script.created_at).toLocaleString('pt-BR')}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (err) {
                    console.error('[Load Agents] Erro:', err);
                    agentsList.innerHTML = '<p class="text-red-400 text-center py-8">Erro ao carregar agentes.</p>';
                }
            }
            
            window.importScriptFromAgent = async function(scriptId, scriptTitle) {
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        showMessage('prompts-imagens-error-message', 'Token n√£o encontrado.', true);
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/scripts/${scriptId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar roteiro');
                    }
                    
                    const data = await response.json();
                    if (sceneScriptText) {
                        sceneScriptText.value = data.script?.script_content || data.script?.content || '';
                        sceneScriptText.dispatchEvent(new Event('input'));
                    }
                    
                    closeAgentModal();
                    showMessage('prompts-imagens-success-message', `Roteiro "${scriptTitle}" importado com sucesso!`);
                    
                } catch (err) {
                    console.error('[Import Script] Erro:', err);
                    showMessage('prompts-imagens-error-message', err.message || 'Erro ao importar roteiro.', true);
                }
            };
            
            // Bot√£o importar roteiro do agente
            const btnImportLastScript = document.getElementById('btn-import-last-script');
            if (btnImportLastScript) {
                btnImportLastScript.addEventListener('click', () => {
                    openAgentModal();
                });
            }
            
            // Bot√£o detectar personagens
            const btnDetectCharacters = document.getElementById('btn-detect-characters');
            if (btnDetectCharacters) {
                btnDetectCharacters.addEventListener('click', async () => {
                    const script = sceneScriptText?.value.trim();
                    const charactersField = document.getElementById('scene-characters');
                    
                    if (!script) {
                        showMessage('prompts-imagens-error-message', 'Cole o roteiro primeiro para detectar personagens.', true);
                        return;
                    }
                    
                    try {
                        btnDetectCharacters.disabled = true;
                        btnDetectCharacters.textContent = 'Detectando...';
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            throw new Error('Token de autentica√ß√£o n√£o encontrado.');
                        }
                        
                        // Verificar se laozhang.ai est√° configurada como padr√£o
                        let useLaozhang = false;
                        try {
                            const settingsResponse = await fetch(`${API_BASE}/api/admin/app-settings`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (settingsResponse.ok) {
                                const settings = await settingsResponse.json();
                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                            }
                        } catch (err) {
                            console.warn('[Detect Characters] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                        }
                        
                        // Usar rota /laozhang se configurada como padr√£o
                        const endpoint = useLaozhang ? '/api/detect/characters/laozhang' : '/api/detect/characters';
                        console.log(`[Detect Characters] Usando endpoint: ${endpoint} (laozhang: ${useLaozhang})`);
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                script: script,
                                model: useLaozhang ? null : (document.getElementById('scene-model-select')?.value || 'gpt-4o'),
                                selectedModel: document.getElementById('scene-model-select')?.value || 'gpt-4o'
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.msg || 'Erro ao detectar personagens');
                        }
                        
                        const data = await response.json();
                        
                        if (charactersField && data.characters) {
                            charactersField.value = data.characters;
                            showMessage('prompts-imagens-success-message', data.msg || `${data.charactersList?.length || 0} personagem(ns) detectado(s)!`);
                        } else {
                            throw new Error('Nenhum personagem foi detectado.');
                        }
                        
                    } catch (err) {
                        console.error('[Detect Characters] Erro:', err);
                        showMessage('prompts-imagens-error-message', err.message || 'Erro ao detectar personagens.', true);
                    } finally {
                        btnDetectCharacters.disabled = false;
                        btnDetectCharacters.textContent = 'Detectar Personagens (IA)';
                    }
                });
            }
            
            // Carregar hist√≥rico ao abrir a view
            async function loadScenePromptsHistory() {
                const historyContainer = document.getElementById('scene-prompts-history');
                if (!historyContainer) return;
                
                try {
                    historyContainer.innerHTML = '<p class="text-gray-400">Carregando hist√≥rico...</p>';
                    
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        historyContainer.innerHTML = '<p class="text-gray-400">Fa√ßa login para ver o hist√≥rico.</p>';
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/scene-prompts/history`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.msg || 'Erro ao carregar hist√≥rico');
                    }
                    
                    const data = await response.json();
                    const history = data.history || [];
                    
                    if (history.length === 0) {
                        historyContainer.innerHTML = '<p class="text-gray-400">Nenhum prompt gerado ainda.</p>';
                        return;
                    }
                    
                    // Fun√ß√£o para formatar nome do modelo (sem mostrar fornecedor)
                    const formatModelName = (model) => {
                        if (!model) return 'N/A';
                        // Remover prefixos de fornecedores
                        let cleanModel = model.replace(/^(laozhang-|claude-|gemini-|gpt-)/i, '');
                        if (model.includes('laozhang-gpt-4o') || model.includes('gpt-4o')) return 'GPT-4o';
                        if (model.includes('claude-3-7-sonnet') || model.includes('sonnet-3-7')) return '3.7 Sonnet';
                        if (model.includes('claude-sonnet-4') || model.includes('sonnet-4')) return 'Sonnet 4';
                        if (model.includes('claude-opus-4') || model.includes('opus-4')) return 'Opus 4';
                        if (model.includes('claude-3-5-haiku') || model.includes('haiku-3-5')) return '3.5 Haiku';
                        if (model.includes('claude-3-opus') || model.includes('opus-3')) return '3 Opus';
                        if (model.includes('gemini-2.5-pro') || model.includes('2.5-pro')) return '2.5 Pro';
                        if (model.includes('gemini-2.5-flash') || model.includes('2.5-flash')) return '2.5 Flash';
                        if (model.includes('gemini-2.0-flash') || model.includes('2.0-flash')) return '2.0 Flash';
                        if (model.includes('gpt-4o')) return 'GPT-4o';
                        if (model.includes('gpt-4o-mini')) return 'GPT-4o Mini';
                        if (model.includes('gpt-4-turbo')) return 'GPT-4 Turbo';
                        // Se ainda cont√©m fornecedor, remover
                        return cleanModel.replace(/^(claude|gemini|gpt|laozhang)-/i, '');
                    };
                    
                    historyContainer.innerHTML = history.map(item => `
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="text-white font-semibold">${escapeHtml(item.title || 'Prompts sem t√≠tulo')}</h4>
                                    <p class="text-gray-400 text-sm">${item.scene_count || 0} cenas ‚Ä¢ ${new Date(item.created_at).toLocaleString('pt-BR')}</p>
                                    <p class="text-gray-500 text-xs mt-1">Estilo: ${escapeHtml(item.style || 'N/A')} ‚Ä¢ Modelo: ${escapeHtml(formatModelName(item.model))}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="loadScenePromptHistory(${item.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm">
                                        Carregar
                                    </button>
                                    <button onclick="deleteScenePromptHistory(${item.id})" class="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm">
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (err) {
                    console.error('[Load History] Erro:', err);
                    historyContainer.innerHTML = `<p class="text-red-400">Erro ao carregar hist√≥rico: ${escapeHtml(err.message || 'Erro desconhecido')}</p>`;
                }
            }
            
            // Fun√ß√µes globais para hist√≥rico
            window.loadScenePromptHistory = async function(historyId) {
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) return;
                    
                    const response = await fetch(`${API_BASE}/api/scene-prompts/history/${historyId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao carregar prompt');
                    }
                    
                    const data = await response.json();
                    scenePromptsData = data.scenes || [];
                    
                    // Preencher campos
                    if (sceneScriptText) sceneScriptText.value = data.script || '';
                    if (document.getElementById('scene-model-select')) document.getElementById('scene-model-select').value = data.model || 'gpt-4o';
                    if (document.getElementById('scene-style-select')) document.getElementById('scene-style-select').value = data.style || 'photorealistic';
                    
                    // Renderizar prompts
                    renderScenePrompts(scenePromptsData);
                    
                    // Mostrar se√ß√£o de gerar imagens
                    const generateSection = document.getElementById('generate-all-images-section');
                    if (generateSection) {
                        generateSection.style.display = 'block';
                    }
                    
                    showMessage('prompts-imagens-success-message', 'Prompt carregado com sucesso!');
                    
                } catch (err) {
                    console.error('[Load Prompt] Erro:', err);
                    showMessage('prompts-imagens-error-message', err.message || 'Erro ao carregar prompt.', true);
                }
            };
            
            window.deleteScenePromptHistory = async function(historyId) {
                if (!confirm('Tem certeza que deseja excluir este prompt do hist√≥rico?')) return;
                
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) return;
                    
                    const response = await fetch(`${API_BASE}/api/scene-prompts/history/${historyId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao excluir prompt');
                    }
                    
                    loadScenePromptsHistory();
                    showMessage('prompts-imagens-success-message', 'Prompt exclu√≠do com sucesso!');
                    
                } catch (err) {
                    console.error('[Delete Prompt] Erro:', err);
                    showMessage('prompts-imagens-error-message', err.message || 'Erro ao excluir prompt.', true);
                }
            };
            
            // Carregar hist√≥rico quando a view for aberta
            const originalNavigateToView = window.navigateToView;
            if (typeof originalNavigateToView === 'function') {
                // Interceptar navega√ß√£o para carregar hist√≥rico
                const navLinks = document.querySelectorAll('a[data-view="prompts-imagens"]');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        setTimeout(() => {
                            loadScenePromptsHistory();
                            calculateSceneEstimate();
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }, 500);
                    });
                });
            }
            
            // Inicializar √≠cones quando a p√°gina carregar
            if (typeof lucide !== 'undefined') {
                setTimeout(() => lucide.createIcons(), 1000);
            }
            
            // ============================================
            // üñºÔ∏è SISTEMA DE GERA√á√ÉO DE IMAGENS (ESTILO DARKSCRIPT)
            // ============================================
            
            // Inicializar objeto de resultados de imagens
            if (!window.imageFxResults) {
                window.imageFxResults = { images: [], lastClearedImages: [] };
            }
            
            // Fun√ß√£o para renderizar o grid de imagens (estilo DARKSCRIPT)
            window.renderImageFxOutput = function() {
                const output = document.getElementById('generated-images-output');
                const actionsContainer = document.getElementById('imagefx-actions');
                const clearBtn = document.getElementById('clear-all-images-btn');
                
                if (!output) return;
                
                const images = window.imageFxResults.images || [];
                
                if (images.length === 0) {
                    output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>';
                    if (actionsContainer) actionsContainer.style.display = 'none';
                } else {
                    output.innerHTML = `
                        ${images.map((img, index) => {
                            const isPending = img.status === 'pending' || img.status === 'retrying';
                            const isFailed = img.status === 'failed';
                            const isRetrying = img.status === 'retrying';
                            
                            const aspectRatioClass = {
                                '16:9': 'aspect-video',
                                '9:16': 'aspect-[9/16]',
                                '1:1': 'aspect-square'
                            }[img.aspectRatio || '16:9'] || 'aspect-video';
                            
                            if (isPending) {
                                return `
                                    <div id="image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 relative flex flex-col ${aspectRatioClass}">
                                        <div class="w-full h-full flex items-center justify-center bg-gray-700 rounded-lg animate-pulse">
                                            <div class="text-center">
                                                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <p class="mt-2 text-sm font-semibold text-gray-300">A gerar Cena ${img.sceneNumber || index + 1}...</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else if (isFailed) {
                                const errorMessage = escapeHtml(img.error || 'Erro desconhecido');
                                const truncatedMessage = errorMessage.length > 150 ? errorMessage.substring(0, 150) + '...' : errorMessage;
                                
                                const errorLower = errorMessage.toLowerCase();
                                const isPolicyError = errorLower.includes('bloqueado') || 
                                                     errorLower.includes('inseguro') || 
                                                     errorLower.includes('unsafe') ||
                                                     errorLower.includes('policy');
                                
                                let helpMessage = '';
                                if (isRetrying) {
                                    helpMessage = '<div class="bg-blue-900/20 border border-blue-700 rounded p-2 mb-3"><p class="text-xs text-blue-300"><strong>üîÑ A processar...</strong><br>A sua imagem est√° a ser regenerada automaticamente. Por favor aguarde.</p></div>';
                                } else if (isPolicyError) {
                                    helpMessage = '<div class="bg-orange-900/20 border border-orange-700 rounded p-2 mb-3"><p class="text-xs text-orange-300"><strong>üõ°Ô∏è Prompt bloqueado</strong><br>O prompt violou as pol√≠ticas de conte√∫do. A IA ir√° <strong>reescrever automaticamente</strong> mantendo o estilo e hist√≥ria.</p></div>';
                                } else {
                                    helpMessage = '<div class="bg-yellow-900/20 border border-yellow-700 rounded p-2 mb-3"><p class="text-xs text-yellow-300"><strong>‚ö†Ô∏è Erro detectado</strong><br>Esta imagem ser√° <strong>regenerada automaticamente</strong> ap√≥s a conclus√£o das outras.</p></div>';
                                }
                                
                                return `
                                    <div id="image-container-${index}" class="bg-red-900/20 border border-red-700 rounded-lg p-4 relative flex flex-col ${aspectRatioClass}">
                                        <h4 class="font-bold text-red-300 mb-2 flex items-center gap-2">
                                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                            ${isRetrying ? 'A Gerar Novamente Cena' : 'Erro na Cena'} ${img.sceneNumber || index + 1}
                                        </h4>
                                        <div class="flex-grow">
                                            ${helpMessage}
                                            <details class="text-xs">
                                                <summary class="cursor-pointer text-red-400 hover:text-red-300 mb-2">Ver detalhes t√©cnicos</summary>
                                                <p class="text-red-300 mt-2 overflow-wrap-anywhere bg-red-950/30 p-2 rounded" title="${errorMessage}">${truncatedMessage}</p>
                                            </details>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-auto">
                                            <button class="toggle-prompt-btn text-sm bg-red-800 text-red-200 px-3 py-1 rounded-md hover:bg-red-700" data-img-index="${index}" ${isRetrying ? 'disabled' : ''}>
                                                ${isRetrying ? '‚è≥ Aguarde...' : 'Ver Prompt / Editar'}
                                            </button>
                                            <div id="edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Imagem gerada com sucesso
                                const rewrittenIndicator = img.wasRewritten ? '<span class="text-yellow-500 font-bold text-lg" title="Este prompt foi reescrito pela IA">‚ö†Ô∏è</span>' : '';
                                return `
                                    <div id="image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 group relative flex flex-col">
                                        <div class="relative ${aspectRatioClass} w-full" data-img-index="${index}">
                                            <input type="checkbox" class="absolute top-2 right-2 h-5 w-5 z-30 image-select-checkbox" data-img-index="${index}">
                                            <span class="absolute top-2 left-2 text-white bg-black/50 rounded-full px-2 py-0.5 text-xs font-semibold z-20 flex items-center gap-1">Cena ${img.sceneNumber || index + 1} ${rewrittenIndicator}</span>
                                            <img src="${img.url || img.image || 'data:image/png;base64,' + img.base64}" alt="Cena ${img.sceneNumber || index + 1}" class="w-full h-full rounded-lg object-cover image-lightbox-trigger cursor-pointer" data-img-index="${index}" data-img-url="${img.url || img.image || 'data:image/png;base64,' + img.base64}" data-img-scene="${img.sceneNumber || index + 1}">
                                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-4 gap-2 pointer-events-none">
                                                <button class="download-single-image-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg pointer-events-auto z-10" data-img-url="${img.url || ''}" data-img-base64="${img.base64 || ''}" data-img-scene="${img.sceneNumber || index + 1}">
                                                    Baixar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-2">
                                            <button class="toggle-prompt-btn text-sm bg-gray-700 text-gray-200 px-3 py-1 rounded-md hover:bg-gray-600" data-img-index="${index}">
                                                Ver Prompt / Editar
                                            </button>
                                            <div id="edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    `;
                    if (actionsContainer) actionsContainer.style.display = 'block';
                }
                
                if (clearBtn && images.length > 0) {
                    clearBtn.style.display = 'block';
                } else if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
                
                // Configurar event listeners
                setupImageGeneratorEventListeners();
                
                // Configurar lightbox (apenas uma vez)
                if (!window._lightboxInitialized) {
                    setupImageLightbox();
                    window._lightboxInitialized = true;
                }
                
                // Atualizar √≠cones
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            };
            
            // Fun√ß√£o para configurar lightbox de imagens
            function setupImageLightbox() {
                // Remover listeners antigos se existirem
                if (window._lightboxImageClickHandler) {
                    document.removeEventListener('click', window._lightboxImageClickHandler, true);
                }
                
                // Usar event delegation para funcionar com imagens din√¢micas
                window._lightboxImageClickHandler = (e) => {
                    // Verificar se o clique foi diretamente na imagem ou no container
                    const imgElement = e.target.classList.contains('image-lightbox-trigger') 
                        ? e.target 
                        : e.target.closest('.image-lightbox-trigger');
                    
                    if (!imgElement) return;
                    
                    // N√£o abrir se clicou no bot√£o de download, checkbox ou qualquer bot√£o
                    if (e.target.closest('.download-single-image-btn') || 
                        e.target.closest('.image-select-checkbox') ||
                        e.target.tagName === 'BUTTON' ||
                        e.target.closest('button')) {
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const imgIndex = parseInt(imgElement.dataset.imgIndex);
                    const allImageTriggers = Array.from(document.querySelectorAll('.image-lightbox-trigger'));
                    
                    // Filtrar apenas imagens com sucesso (que t√™m URL v√°lida)
                    const validImages = allImageTriggers.filter(img => {
                        const url = img.dataset.imgUrl || img.src;
                        return url && 
                               url !== '' && 
                               !url.includes('data:image/svg') &&
                               (url.startsWith('data:image/') || url.startsWith('http'));
                    });
                    
                    if (validImages.length === 0) {
                        console.warn('[Lightbox] Nenhuma imagem v√°lida encontrada');
                        return;
                    }
                    
                    const allImages = validImages.map((img, idx) => ({
                        index: idx,
                        url: img.dataset.imgUrl || img.src,
                        scene: img.dataset.imgScene || (idx + 1)
                    }));
                    
                    let currentImageIndex = validImages.findIndex(img => parseInt(img.dataset.imgIndex) === imgIndex);
                    if (currentImageIndex === -1) currentImageIndex = 0;
                    
                    console.log('[Lightbox] Abrindo imagem', currentImageIndex + 1, 'de', allImages.length);
                    openLightbox(currentImageIndex, allImages);
                };
                
                // Usar capture phase para garantir que captura o clique antes de outros handlers
                document.addEventListener('click', window._lightboxImageClickHandler, true);
                
                // Vari√°veis globais para o lightbox
                window._lightboxImages = [];
                window._lightboxCurrentIndex = 0;
                
                function openLightbox(index, images) {
                    if (!images || images.length === 0) return;
                    
                    window._lightboxImages = images;
                    window._lightboxCurrentIndex = index;
                    
                    const lightbox = document.getElementById('image-lightbox');
                    const lightboxImage = document.getElementById('lightbox-image');
                    const lightboxCounter = document.getElementById('lightbox-counter');
                    const lightboxInfo = document.getElementById('lightbox-info');
                    
                    if (!lightbox || !lightboxImage) return;
                    
                    const currentImage = images[index];
                    
                    // Limpar src anterior para for√ßar reload
                    lightboxImage.src = '';
                    setTimeout(() => {
                        lightboxImage.src = currentImage.url;
                    }, 10);
                    
                    if (lightboxCounter) lightboxCounter.textContent = `${index + 1} / ${images.length}`;
                    if (lightboxInfo) lightboxInfo.textContent = `Cena ${currentImage.scene}`;
                    
                    lightbox.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevenir scroll do body
                    
                    // Atualizar bot√µes de navega√ß√£o
                    const prevBtn = document.getElementById('lightbox-prev');
                    const nextBtn = document.getElementById('lightbox-next');
                    
                    if (prevBtn) prevBtn.style.display = images.length > 1 ? 'flex' : 'none';
                    if (nextBtn) nextBtn.style.display = images.length > 1 ? 'flex' : 'none';
                    
                    // Atualizar √≠cones
                    if (typeof lucide !== 'undefined') {
                        setTimeout(() => lucide.createIcons(), 100);
                    }
                }
                
                function closeLightbox() {
                    const lightbox = document.getElementById('image-lightbox');
                    if (lightbox) {
                        lightbox.classList.add('hidden');
                        document.body.style.overflow = ''; // Restaurar scroll
                    }
                }
                
                function navigateLightbox(direction) {
                    if (!window._lightboxImages || window._lightboxImages.length === 0) return;
                    
                    if (direction === 'prev') {
                        window._lightboxCurrentIndex = (window._lightboxCurrentIndex - 1 + window._lightboxImages.length) % window._lightboxImages.length;
                    } else {
                        window._lightboxCurrentIndex = (window._lightboxCurrentIndex + 1) % window._lightboxImages.length;
                    }
                    
                    openLightbox(window._lightboxCurrentIndex, window._lightboxImages);
                }
                
                // Event listeners
                const closeBtn = document.getElementById('lightbox-close');
                const prevBtn = document.getElementById('lightbox-prev');
                const nextBtn = document.getElementById('lightbox-next');
                const lightbox = document.getElementById('image-lightbox');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeLightbox);
                }
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => navigateLightbox('prev'));
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => navigateLightbox('next'));
                }
                
                // Fechar com ESC e navega√ß√£o com setas (apenas uma vez)
                if (!window._lightboxKeyHandler) {
                    window._lightboxKeyHandler = (e) => {
                        if (!lightbox || lightbox.classList.contains('hidden')) return;
                        
                        if (e.key === 'Escape') {
                            closeLightbox();
                        } else if (e.key === 'ArrowLeft') {
                            navigateLightbox('prev');
                        } else if (e.key === 'ArrowRight') {
                            navigateLightbox('next');
                        }
                    };
                    
                    document.addEventListener('keydown', window._lightboxKeyHandler);
                }
                
                // Fechar ao clicar no fundo (apenas uma vez)
                if (lightbox && !window._lightboxClickHandler) {
                    lightbox.addEventListener('click', (e) => {
                        if (e.target === lightbox || e.target.id === 'image-lightbox') {
                            closeLightbox();
                        }
                    });
                    window._lightboxClickHandler = true;
                }
            }
            
            // Fun√ß√£o para renderizar progresso (estilo DARKSCRIPT)
            window.renderImageGenerationProgress = function(status) {
                const panel = document.getElementById('image-gen-progress-panel');
                if (!panel) return;
                
                if (!status || !status.active) {
                    panel.style.display = 'none';
                    return;
                }
                
                panel.style.display = 'block';
                const { current, total, message } = status;
                const progress = total > 0 ? Math.round((current / total) * 100) : 0;
                const isComplete = current === total;
                
                let title, titleColor;
                if (isComplete) {
                    title = 'Gera√ß√£o Conclu√≠da';
                    titleColor = 'text-green-400';
                } else {
                    title = 'A gerar imagens...';
                    titleColor = 'text-blue-400';
                }
                
                panel.innerHTML = `
                    <h4 class="font-bold text-sm mb-2 ${titleColor} flex items-center justify-between">
                        ${title}
                        <button id="cancel-image-gen-btn" class="text-gray-400 hover:text-gray-200">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </h4>
                    <p class="text-xs text-gray-300 mb-2 truncate" title="${escapeHtml(message || '')}">${escapeHtml(message || '')}</p>
                    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                        <div class="h-2 rounded-full transition-all duration-300 ${isComplete ? 'bg-green-500' : 'bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500'}" style="width: ${progress}%; background-size: 200% 100%; animation: ${isComplete ? 'none' : 'shimmer 2s infinite'};"></div>
                    </div>
                    <p class="text-right text-xs text-gray-400 mt-1">${progress}% (${current}/${total})</p>
                `;
                
                // Bot√£o cancelar
                const cancelBtn = document.getElementById('cancel-image-gen-btn');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        if (window.appState) {
                            window.appState.imageGenStatus = { ...window.appState.imageGenStatus, cancelled: true };
                        }
                        panel.style.display = 'none';
                    };
                }
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            };
            
            // Vari√°vel global para armazenar prompts do TXT
            let batchPromptsFromTxt = [];
            
            // Configurar upload de TXT para prompts em lote
            function setupBatchTxtUpload() {
                const uploadBtn = document.getElementById('batch-upload-txt-btn');
                const txtInput = document.getElementById('batch-txt-file-input');
                const textarea = document.getElementById('batch-image-prompts-textarea');
                const promptsCountDisplay = document.getElementById('batch-prompts-count-display');
                const generateBtn = document.getElementById('batch-btn-generate-images');
                
                if (uploadBtn && txtInput) {
                    uploadBtn.addEventListener('click', () => {
                        txtInput.click();
                    });
                    
                    txtInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        if (!file.name.endsWith('.txt')) {
                            showMessage('imagens-lote-error-message', 'Por favor, selecione um arquivo TXT.', true);
                            return;
                        }
                        
                        try {
                            const text = await file.text();
                            if (textarea) {
                                textarea.value = text;
                            }
                            parsePromptsFromText(text);
                        } catch (err) {
                            console.error('[Upload TXT] Erro:', err);
                            showMessage('imagens-lote-error-message', 'Erro ao ler arquivo TXT.', true);
                        }
                    });
                }
                
                // Atualizar contagem quando o texto mudar
                if (textarea) {
                    textarea.addEventListener('input', () => {
                        parsePromptsFromText(textarea.value);
                    });
                }
                
                // Bot√£o de gerar imagens em lote
                if (generateBtn) {
                    generateBtn.addEventListener('click', async () => {
                        if (batchPromptsFromTxt.length === 0) {
                            showMessage('imagens-lote-error-message', 'Adicione prompts primeiro! Cole no campo de texto ou fa√ßa upload de um arquivo TXT.', true);
                            return;
                        }
                        
                        // Usar a fun√ß√£o existente de gera√ß√£o em lote
                        await generateBatchImagesFromPrompts(batchPromptsFromTxt);
                    });
                }
                
                // Bot√µes de a√ß√£o para imagens em lote
                const selectAllBtn = document.getElementById('batch-select-all-images-btn');
                const deselectAllBtn = document.getElementById('batch-deselect-all-images-btn');
                const downloadSelectedBtn = document.getElementById('batch-download-selected-images-btn');
                const clearAllBtn = document.getElementById('batch-clear-all-images-btn');
                
                if (selectAllBtn) {
                    selectAllBtn.addEventListener('click', () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        checkboxes.forEach(cb => cb.checked = true);
                    });
                }
                
                if (deselectAllBtn) {
                    deselectAllBtn.addEventListener('click', () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        checkboxes.forEach(cb => cb.checked = false);
                    });
                }
                
                if (downloadSelectedBtn) {
                    downloadSelectedBtn.addEventListener('click', async () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox:checked');
                        if (checkboxes.length === 0) {
                            showMessage('imagens-lote-error-message', 'Selecione pelo menos uma imagem para baixar.', true);
                            return;
                        }
                        
                        for (const checkbox of checkboxes) {
                            const imgIndex = parseInt(checkbox.dataset.imgIndex);
                            const imgCard = checkbox.closest('.image-card');
                            const img = imgCard?.querySelector('img');
                            if (img && img.src) {
                                const a = document.createElement('a');
                                a.href = img.src;
                                a.download = `imagem-cena-${imgIndex}.png`;
                                a.click();
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                        }
                    });
                }
                
                if (clearAllBtn) {
                    clearAllBtn.addEventListener('click', () => {
                        if (confirm('Tem certeza que deseja limpar todas as imagens geradas?')) {
                            const output = document.getElementById('batch-generated-images-output');
                            if (output) {
                                output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>';
                            }
                            const actions = document.getElementById('batch-imagefx-actions');
                            if (actions) actions.style.display = 'none';
                            batchPromptsFromTxt = [];
                            updatePromptsCount(0);
                        }
                    });
                }
                
                // Event listeners dos modais
                const batchCloseModalBtn = document.getElementById('batch-close-image-gen-modal-btn');
                const batchViewImagesBtn = document.getElementById('batch-view-generated-images-btn');
                
                if (batchCloseModalBtn) {
                    batchCloseModalBtn.addEventListener('click', () => {
                        document.getElementById('batch-image-gen-complete-modal')?.classList.add('hidden');
                    });
                }
                
                if (batchViewImagesBtn) {
                    batchViewImagesBtn.addEventListener('click', () => {
                        document.getElementById('batch-image-gen-complete-modal')?.classList.add('hidden');
                        // Scroll para o grid de imagens
                        const output = document.getElementById('batch-generated-images-output');
                        if (output) {
                            output.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                }
            }
            
            // Parsear prompts do texto (um por linha)
            function parsePromptsFromText(text) {
                if (!text || !text.trim()) {
                    batchPromptsFromTxt = [];
                    updatePromptsCount(0);
                    return;
                }
                
                // Dividir por linhas e filtrar linhas vazias e coment√°rios
                const lines = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => {
                        const trimmed = line.trim();
                        return trimmed.length > 0 && 
                               !trimmed.startsWith('//') && 
                               !trimmed.startsWith('#') &&
                               !trimmed.toLowerCase().startsWith('prompts de cena gerados') &&
                               !trimmed.toLowerCase().startsWith('data:') &&
                               !trimmed.toLowerCase().startsWith('total de cenas:') &&
                               !trimmed.match(/^cena \d+:/i) || trimmed.length > 20; // Incluir linhas que come√ßam com "CENA X:" mas t√™m conte√∫do
                    });
                
                batchPromptsFromTxt = lines.map((line, index) => ({
                    scene_number: index + 1,
                    prompt_text: line.replace(/^CENA \d+:\s*/i, '').trim(), // Remover prefixo "CENA X:" se existir
                    style: document.getElementById('batch-image-style-select')?.value || 'photorealistic'
                }));
                
                updatePromptsCount(batchPromptsFromTxt.length);
            }
            
            // Atualizar contagem de prompts
            function updatePromptsCount(count) {
                const promptsCountDisplay = document.getElementById('batch-prompts-count-display');
                if (promptsCountDisplay) {
                    promptsCountDisplay.textContent = `${count} prompt${count !== 1 ? 's' : ''}`;
                }
            }
            
            // Gerar imagens em lote a partir dos prompts do TXT (igual a Prompts e Imagens)
            async function generateBatchImagesFromPrompts(prompts) {
                if (prompts.length === 0) {
                    showMessage('imagens-lote-error-message', 'Nenhum prompt encontrado!', true);
                    return;
                }
                
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        throw new Error('Token de autentica√ß√£o n√£o encontrado.');
                    }
                    
                    const style = document.getElementById('batch-image-style-select')?.value || 'photorealistic';
                    
                    // Mostrar modal de confirma√ß√£o
                    const confirmModal = document.getElementById('batch-confirm-generation-modal');
                    const confirmMessage = document.getElementById('batch-confirm-modal-message');
                    const confirmCount = document.getElementById('batch-confirm-modal-count');
                    const confirmBtn = document.getElementById('batch-confirm-modal-confirm');
                    const cancelBtn = document.getElementById('batch-confirm-modal-cancel');
                    
                    if (confirmModal && confirmMessage && confirmCount) {
                        confirmCount.textContent = `${prompts.length} imagem${prompts.length !== 1 ? 'ns' : ''}`;
                        confirmMessage.textContent = `Voc√™ est√° prestes a gerar ${prompts.length} imagem${prompts.length !== 1 ? 'ns' : ''} em lote.`;
                        
                        if (typeof lucide !== 'undefined') {
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                        
                        confirmModal.classList.remove('hidden');
                        
                        const userConfirmed = await new Promise((resolve) => {
                            const handleConfirm = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(true);
                            };
                            
                            const handleCancel = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(false);
                            };
                            
                            confirmBtn.addEventListener('click', handleConfirm);
                            cancelBtn.addEventListener('click', handleCancel);
                            
                            const handleEsc = (e) => {
                                if (e.key === 'Escape') {
                                    document.removeEventListener('keydown', handleEsc);
                                    handleCancel();
                                }
                            };
                            document.addEventListener('keydown', handleEsc);
                        });
                        
                        if (!userConfirmed) return;
                    }
                    
                    // Limpar grid anterior
                    const output = document.getElementById('batch-generated-images-output');
                    if (output) {
                        output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Gerando imagens...</p>';
                    }
                    
                    // Inicializar resultados (IGUAL a window.imageFxResults)
                    if (!window.batchImageFxResults) {
                        window.batchImageFxResults = { images: [], lastClearedImages: [] };
                    }
                    window.batchImageFxResults.images = new Array(prompts.length).fill(null);
                    
                    // Inicializar status de gera√ß√£o
                    window.appState.imageGenStatus = {
                        active: true,
                        current: 0,
                        total: prompts.length,
                        message: 'Iniciando gera√ß√£o...',
                        cancelled: false
                    };
                    
                    // Mostrar e renderizar painel de progresso
                    const batchProgressPanel = document.getElementById('batch-image-gen-progress-panel');
                    if (batchProgressPanel) {
                        batchProgressPanel.style.display = 'block';
                    }
                    updateBatchProgressPanel();
                    
                    // Preparar tasks para gera√ß√£o (todas de uma vez)
                    const tasks = prompts.map((prompt, index) => ({
                        index: index,
                        prompt: prompt.prompt_text,
                        sceneNumber: prompt.scene_number || index + 1,
                        style: style
                    }));
                    
                    let completed = 0;
                    const totalPrompts = prompts.length;
                    
                    // Fun√ß√£o para processar cada task
                    const processTask = async (task) => {
                        if (window.appState.imageGenStatus.cancelled) return;
                        
                        const currentImageIndex = task.index;
                        const currentPrompt = task.prompt;
                        const currentSceneNumber = task.sceneNumber;
                        
                        try {
                            // Chamar API de gera√ß√£o de imagem
                            const response = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    prompt: currentPrompt,
                                    style: style,
                                    aspectRatio: '16:9'
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.msg || 'Erro ao gerar imagem');
                            }
                            
                            const data = await response.json();
                            
                            if (data.image || data.base64 || data.imageUrl) {
                                const base64 = data.base64 || data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null);
                                const url = data.imageUrl || `data:image/png;base64,${base64}`;
                                
                                window.batchImageFxResults.images[currentImageIndex] = {
                                    status: 'success',
                                    url: url,
                                    base64: base64,
                                    prompt: data.prompt || currentPrompt,
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9',
                                    wasRewritten: data.wasRewritten || false
                                };
                            } else {
                                throw new Error('A API retornou uma resposta vazia.');
                            }
                            
                            completed++;
                            window.appState.imageGenStatus.current = completed;
                            window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                            updateBatchProgressPanel();
                            renderBatchImageFxOutput();
                            
                        } catch (error) {
                            console.error(`Erro na gera√ß√£o ImageFX para cena ${currentSceneNumber}:`, error);
                            const userFriendlyMessage = error.message || 'Erro desconhecido.';
                            const errorLower = userFriendlyMessage.toLowerCase();
                            
                            // Verificar se √© erro de throttling (429)
                            const isThrottleError = errorLower.includes('throttled') || 
                                                   errorLower.includes('429') ||
                                                   errorLower.includes('limite de requisi√ß√µes') ||
                                                   errorLower.includes('rate limit');
                            
                            // Verificar se √© erro de pol√≠tica (bloqueado)
                            const isPolicyError = errorLower.includes('bloqueado') || 
                                                 errorLower.includes('conte√∫do inseguro') || 
                                                 errorLower.includes('conteudo inseguro') ||
                                                 errorLower.includes('unsafe') ||
                                                 errorLower.includes('policy');
                            
                            // Se for erro de throttling, aguardar e tentar novamente
                            if (isThrottleError) {
                                window.batchImageFxResults.images[currentImageIndex] = {
                                    status: 'retrying',
                                    prompt: currentPrompt,
                                    error: 'Limite de requisi√ß√µes atingido. Aguardando e tentando novamente...',
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9'
                                };
                                renderBatchImageFxOutput();
                                
                                // Aguardar 5-10 segundos antes de tentar novamente
                                await new Promise(resolve => setTimeout(resolve, 5000 + Math.random() * 5000));
                                
                                // Tentar gerar novamente
                                try {
                                    const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            prompt: currentPrompt,
                                            style: style,
                                            aspectRatio: '16:9'
                                        })
                                    });
                                    
                                    if (retryResponse.ok) {
                                        const retryData = await retryResponse.json();
                                        const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                        const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                        
                                        if (base64 || retryData.image || retryData.imageUrl) {
                                            window.batchImageFxResults.images[currentImageIndex] = {
                                                status: 'success',
                                                url: url,
                                                base64: base64,
                                                prompt: currentPrompt,
                                                sceneNumber: currentSceneNumber,
                                                aspectRatio: '16:9'
                                            };
                                            completed++;
                                            window.appState.imageGenStatus.current = completed;
                                            window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                            updateBatchProgressPanel();
                                            renderBatchImageFxOutput();
                                            return;
                                        }
                                    }
                                } catch (retryErr) {
                                    console.warn(`[Retry Throttle] Erro ao tentar novamente ap√≥s throttling para cena ${currentSceneNumber}:`, retryErr);
                                }
                            }
                            
                            if (isPolicyError) {
                                // Marcar como retrying e tentar reescrever automaticamente
                                window.batchImageFxResults.images[currentImageIndex] = {
                                    status: 'retrying',
                                    prompt: currentPrompt,
                                    error: 'Prompt bloqueado. Reescrevendo automaticamente...',
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9'
                                };
                                renderBatchImageFxOutput();
                                
                                // Tentar reescrever o prompt usando IA
                                try {
                                    // Verificar se laozhang.ai est√° configurada como padr√£o
                                    let useLaozhang = false;
                                    try {
                                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                            headers: { 'Authorization': `Bearer ${token}` }
                                        });
                                        if (settingsResponse.ok) {
                                            const settings = await settingsResponse.json();
                                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                                        }
                                    } catch (err) {
                                        console.warn('[Rewrite Prompt] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                                    }
                                    
                                    const endpoint = useLaozhang ? '/api/rewrite/blocked-prompt/laozhang' : '/api/rewrite/blocked-prompt';
                                    const selectedModel = 'gpt-4o'; // Modelo padr√£o para reescrita
                                    
                                    const rewriteResponse = await fetch(`${API_BASE}${endpoint}`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            prompt: currentPrompt,
                                            model: useLaozhang ? null : selectedModel,
                                            selectedModel: selectedModel
                                        })
                                    });
                                    
                                    if (rewriteResponse.ok) {
                                        const rewriteData = await rewriteResponse.json();
                                        const rewrittenPrompt = rewriteData.rewrittenPrompt || currentPrompt;
                                        
                                        // Atualizar status
                                        window.batchImageFxResults.images[currentImageIndex] = {
                                            ...window.batchImageFxResults.images[currentImageIndex],
                                            error: 'Gerando com prompt reescrito...'
                                        };
                                        renderBatchImageFxOutput();
                                        
                                        // Aguardar antes de tentar novamente
                                        await new Promise(resolve => setTimeout(resolve, 2000));
                                        
                                        // Tentar gerar novamente com prompt reescrito
                                        const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({
                                                prompt: rewrittenPrompt,
                                                style: style,
                                                aspectRatio: '16:9'
                                            })
                                        });
                                        
                                        if (retryResponse.ok) {
                                            const retryData = await retryResponse.json();
                                            const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                            const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                            
                                            if (base64 || retryData.image || retryData.imageUrl) {
                                                window.batchImageFxResults.images[currentImageIndex] = {
                                                    status: 'success',
                                                    url: url,
                                                    base64: base64,
                                                    prompt: rewrittenPrompt,
                                                    sceneNumber: currentSceneNumber,
                                                    aspectRatio: '16:9',
                                                    wasRewritten: true,
                                                    originalPrompt: currentPrompt
                                                };
                                                completed++;
                                                window.appState.imageGenStatus.current = completed;
                                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                                updateBatchProgressPanel();
                                                renderBatchImageFxOutput();
                                                return;
                                            }
                                        }
                                    }
                                } catch (rewriteErr) {
                                    console.warn(`[Retry] Erro ao reescrever prompt para cena ${currentSceneNumber}:`, rewriteErr);
                                }
                            }
                            
                            // Se chegou aqui, falhou mesmo ap√≥s retry
                            window.batchImageFxResults.images[currentImageIndex] = {
                                status: 'failed',
                                prompt: currentPrompt,
                                error: userFriendlyMessage,
                                sceneNumber: currentSceneNumber,
                                aspectRatio: '16:9'
                            };
                            
                            completed++;
                            window.appState.imageGenStatus.current = completed;
                            window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                            updateBatchProgressPanel();
                            renderBatchImageFxOutput();
                        }
                    };
                    
                    // Executar em paralelo (3 por vez)
                    await runTasksWithConcurrency(tasks, 3, processTask);
                    
                    if (window.appState.imageGenStatus.cancelled) {
                        window.appState.imageGenStatus.active = false;
                        window.appState.imageGenStatus.message = 'Gera√ß√£o cancelada pelo usu√°rio.';
                        updateBatchProgressPanel();
                        showMessage('imagens-lote-success-message', 'Gera√ß√£o cancelada pelo usu√°rio.');
                        return;
                    }
                    
                    // Processar imagens com erro automaticamente (retry em paralelo, 3 por vez)
                    let retryAttempt = 0;
                    const maxRetryAttempts = 5;
                    
                    while (retryAttempt < maxRetryAttempts) {
                        const failedImages = window.batchImageFxResults.images
                            .map((img, idx) => ({ ...img, originalIndex: idx }))
                            .filter(img => img && img.status === 'failed');
                        
                        if (failedImages.length === 0) break;
                        
                        retryAttempt++;
                        window.appState.imageGenStatus.message = `Tentativa ${retryAttempt}: Regenerando ${failedImages.length} imagem(ns) com erro...`;
                        updateBatchProgressPanel();
                        
                        // Processar falhas em paralelo (3 por vez)
                        const retryTasks = failedImages.map(failedImg => ({
                            img: failedImg,
                            index: failedImg.originalIndex
                        }));
                        
                        const processRetryTask = async (task) => {
                            if (window.appState.imageGenStatus.cancelled) return;
                            
                            const { img: failedImg, index: originalIndex } = task;
                            const { prompt: failedPrompt, sceneNumber: failedSceneNumber } = failedImg;
                            
                            try {
                                // Marcar como retrying
                                window.batchImageFxResults.images[originalIndex] = {
                                    ...window.batchImageFxResults.images[originalIndex],
                                    status: 'retrying',
                                    error: 'Regenerando automaticamente...'
                                };
                                renderBatchImageFxOutput();
                                
                                // Aguardar um pouco antes de tentar
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                
                                // Tentar gerar novamente
                                const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        prompt: failedPrompt,
                                        style: style,
                                        aspectRatio: '16:9'
                                    })
                                });
                                
                                if (retryResponse.ok) {
                                    const retryData = await retryResponse.json();
                                    const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                    const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                    
                                    if (base64 || retryData.image || retryData.imageUrl) {
                                        window.batchImageFxResults.images[originalIndex] = {
                                            status: 'success',
                                            url: url,
                                            base64: base64,
                                            prompt: failedPrompt,
                                            sceneNumber: failedSceneNumber,
                                            aspectRatio: '16:9'
                                        };
                                        completed++;
                                        window.appState.imageGenStatus.current = completed;
                                        window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                        updateBatchProgressPanel();
                                        renderBatchImageFxOutput();
                                    }
                                } else {
                                    throw new Error('Erro ao regenerar imagem');
                                }
                            } catch (retryErr) {
                                console.warn(`[Retry] Erro ao regenerar imagem ${originalIndex}:`, retryErr);
                                window.batchImageFxResults.images[originalIndex] = {
                                    ...window.batchImageFxResults.images[originalIndex],
                                    status: 'failed',
                                    error: retryErr.message || 'Erro ao regenerar'
                                };
                                renderBatchImageFxOutput();
                            }
                        };
                        
                        await runTasksWithConcurrency(retryTasks, 3, processRetryTask);
                        
                        // Aguardar antes da pr√≥xima tentativa
                        if (retryAttempt < maxRetryAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                    
                    // Finalizar
                    window.appState.imageGenStatus.active = false;
                    window.appState.imageGenStatus.message = 'Gera√ß√£o conclu√≠da!';
                    updateBatchProgressPanel();
                    
                    // Esconder painel de progresso
                    const batchProgressPanelFinal = document.getElementById('batch-image-gen-progress-panel');
                    if (batchProgressPanelFinal) {
                        batchProgressPanelFinal.style.display = 'none';
                    }
                    
                    // Mostrar modal de conclus√£o
                    const completeModal = document.getElementById('batch-image-gen-complete-modal');
                    if (completeModal) {
                        const successCount = window.batchImageFxResults.images.filter(img => img && img.status === 'success').length;
                        const failedCount = window.batchImageFxResults.images.filter(img => img && img.status === 'failed').length;
                        
                        document.getElementById('batch-image-gen-success-count').textContent = `${successCount} sucesso`;
                        document.getElementById('batch-image-gen-failed-count').textContent = `${failedCount} erros`;
                        
                        completeModal.classList.remove('hidden');
                    }
                    
                } catch (err) {
                    console.error('[Batch Images] Erro:', err);
                    showMessage('imagens-lote-error-message', err.message || 'Erro ao gerar imagens em lote.', true);
                    window.appState.imageGenStatus.active = false;
                    const batchProgressPanelError = document.getElementById('batch-image-gen-progress-panel');
                    if (batchProgressPanelError) {
                        batchProgressPanelError.style.display = 'none';
                    }
                }
            }
            
            // Fun√ß√£o para atualizar painel de progresso
            function updateBatchProgressPanel() {
                const batchProgressPanel = document.getElementById('batch-image-gen-progress-panel');
                if (!batchProgressPanel || !window.appState.imageGenStatus) return;
                
                const status = window.appState.imageGenStatus;
                const progress = status.total > 0 ? Math.round((status.current / status.total) * 100) : 0;
                
                batchProgressPanel.innerHTML = `
                    <h4 class="font-bold text-sm mb-2 text-blue-400 flex items-center justify-between">
                        A gerar imagens...
                        <button id="batch-cancel-image-gen-btn" class="text-gray-400 hover:text-gray-200">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </h4>
                    <p class="text-xs text-gray-300 mb-2">${status.message || `Processando ${status.current}/${status.total} cenas...`}</p>
                    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                        <div class="h-2 rounded-full transition-all duration-300 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500" style="width: ${progress}%; background-size: 200% 100%; animation: shimmer 2s infinite;"></div>
                    </div>
                    <p class="text-right text-xs text-gray-400 mt-1">${progress}% (${status.current}/${status.total})</p>
                `;
                
                const cancelBtn = document.getElementById('batch-cancel-image-gen-btn');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        window.appState.imageGenStatus.cancelled = true;
                        batchProgressPanel.style.display = 'none';
                    };
                }
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            }
            
            // Fun√ß√£o para renderizar output (IGUAL a renderImageFxOutput de Prompts e Imagens)
            function renderBatchImageFxOutput() {
                const output = document.getElementById('batch-generated-images-output');
                const actionsContainer = document.getElementById('batch-imagefx-actions');
                const clearBtn = document.getElementById('batch-clear-all-images-btn');
                
                if (!output) return;
                
                const images = window.batchImageFxResults.images || [];
                
                // Sempre renderizar todas as imagens do array, mesmo se algumas forem null
                if (images.length === 0) {
                    output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>';
                    if (actionsContainer) actionsContainer.style.display = 'none';
                } else {
                    // Renderizar TODAS as imagens do array (incluindo null/pending)
                    output.innerHTML = `
                        ${images.map((img, index) => {
                        if (!img) {
                                return `
                                    <div id="batch-image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 relative flex flex-col aspect-video">
                                        <div class="w-full h-full flex items-center justify-center bg-gray-700 rounded-lg animate-pulse">
                                            <div class="text-center">
                                                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <p class="mt-2 text-sm font-semibold text-gray-300">Aguardando gera√ß√£o...</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            const isPending = img.status === 'pending' || (img.status === 'retrying' && !img.error);
                            const isFailed = img.status === 'failed';
                            const isRetrying = img.status === 'retrying' && img.error;
                            
                            const aspectRatioClass = {
                                '16:9': 'aspect-video',
                                '9:16': 'aspect-[9/16]',
                                '1:1': 'aspect-square'
                            }[img.aspectRatio || '16:9'] || 'aspect-video';
                            
                            if (isPending) {
                                return `
                                    <div id="batch-image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 relative flex flex-col ${aspectRatioClass}">
                                        <div class="w-full h-full flex items-center justify-center bg-gray-700 rounded-lg animate-pulse">
                                            <div class="text-center">
                                                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <p class="mt-2 text-sm font-semibold text-gray-300">A gerar Cena ${img.sceneNumber || index + 1}...</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else if (isFailed || isRetrying) {
                                const errorMessage = escapeHtml(img.error || 'Erro desconhecido');
                                const truncatedMessage = errorMessage.length > 150 ? errorMessage.substring(0, 150) + '...' : errorMessage;
                                
                                const errorLower = errorMessage.toLowerCase();
                                const isPolicyError = errorLower.includes('bloqueado') || 
                                                     errorLower.includes('inseguro') || 
                                                     errorLower.includes('unsafe') ||
                                                     errorLower.includes('policy');
                                
                                let helpMessage = '';
                                if (isRetrying) {
                                    helpMessage = '<div class="bg-blue-900/20 border border-blue-700 rounded p-2 mb-3"><p class="text-xs text-blue-300"><strong>üîÑ A processar...</strong><br>A sua imagem est√° a ser regenerada automaticamente. Por favor aguarde.</p></div>';
                                } else if (isPolicyError) {
                                    helpMessage = '<div class="bg-orange-900/20 border border-orange-700 rounded p-2 mb-3"><p class="text-xs text-orange-300"><strong>üõ°Ô∏è Prompt bloqueado</strong><br>O prompt violou as pol√≠ticas de conte√∫do. A IA ir√° <strong>reescrever automaticamente</strong> mantendo o estilo e hist√≥ria.</p></div>';
                                } else {
                                    helpMessage = '<div class="bg-yellow-900/20 border border-yellow-700 rounded p-2 mb-3"><p class="text-xs text-yellow-300"><strong>‚ö†Ô∏è Erro detectado</strong><br>Esta imagem ser√° <strong>regenerada automaticamente</strong> ap√≥s a conclus√£o das outras.</p></div>';
                                }
                                
                                return `
                                    <div id="batch-image-container-${index}" class="bg-red-900/20 border border-red-700 rounded-lg p-4 relative flex flex-col ${aspectRatioClass}">
                                        <h4 class="font-bold text-red-300 mb-2 flex items-center gap-2">
                                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                            ${isRetrying ? 'A Gerar Novamente Cena' : 'Erro na Cena'} ${img.sceneNumber || index + 1}
                                        </h4>
                                        <div class="flex-grow">
                                            ${helpMessage}
                                            <details class="text-xs">
                                                <summary class="cursor-pointer text-red-400 hover:text-red-300 mb-2">Ver detalhes t√©cnicos</summary>
                                                <p class="text-red-300 mt-2 overflow-wrap-anywhere bg-red-950/30 p-2 rounded" title="${errorMessage}">${truncatedMessage}</p>
                                            </details>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-auto">
                                            <button class="batch-toggle-prompt-btn text-sm bg-red-800 text-red-200 px-3 py-1 rounded-md hover:bg-red-700" data-img-index="${index}" ${isRetrying ? 'disabled' : ''}>
                                                ${isRetrying ? '‚è≥ Aguarde...' : 'Ver Prompt / Editar'}
                                            </button>
                                            <div id="batch-edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="batch-edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="batch-regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Imagem gerada com sucesso
                                const rewrittenIndicator = img.wasRewritten ? '<span class="text-yellow-500 font-bold text-lg" title="Este prompt foi reescrito pela IA">‚ö†Ô∏è</span>' : '';
                                return `
                                    <div id="batch-image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 group relative flex flex-col">
                                        <div class="relative ${aspectRatioClass} w-full" data-img-index="${index}">
                                            <input type="checkbox" class="absolute top-2 right-2 h-5 w-5 z-30 image-select-checkbox" data-img-index="${index}">
                                            <span class="absolute top-2 left-2 text-white bg-black/50 rounded-full px-2 py-0.5 text-xs font-semibold z-20 flex items-center gap-1">Cena ${img.sceneNumber || index + 1} ${rewrittenIndicator}</span>
                                            <img src="${img.url || img.image || 'data:image/png;base64,' + img.base64}" alt="Cena ${img.sceneNumber || index + 1}" class="w-full h-full rounded-lg object-cover image-lightbox-trigger cursor-pointer" data-img-index="${index}" data-img-url="${img.url || img.image || 'data:image/png;base64,' + img.base64}" data-img-scene="${img.sceneNumber || index + 1}">
                                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-4 gap-2 pointer-events-none">
                                                <button class="download-single-image-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg pointer-events-auto z-10" data-img-url="${img.url || ''}" data-img-base64="${img.base64 || ''}" data-img-scene="${img.sceneNumber || index + 1}">
                                                    Baixar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-2">
                                            <button class="batch-toggle-prompt-btn text-sm bg-gray-700 text-gray-200 px-3 py-1 rounded-md hover:bg-gray-600" data-img-index="${index}">
                                                Ver Prompt / Editar
                                            </button>
                                            <div id="batch-edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="batch-edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="batch-regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    `;
                    if (actionsContainer) actionsContainer.style.display = 'block';
                    
                    // Garantir que todas as imagens sejam vis√≠veis e o scroll funcione
                    setTimeout(() => {
                        const allImages = output.querySelectorAll('[id^="batch-image-container-"]');
                        console.log(`[Batch Images] Total de imagens no array: ${images.length}, renderizadas: ${allImages.length}`);
                        
                        // Verificar se todas as imagens foram renderizadas
                        if (allImages.length < images.length) {
                            console.warn(`[Batch Images] ‚ö†Ô∏è Algumas imagens n√£o foram renderizadas! Esperado: ${images.length}, Encontrado: ${allImages.length}`);
                            // For√ßar re-renderiza√ß√£o
                            renderBatchImageFxOutput();
                        }
                        
                        // Remover qualquer limita√ß√£o de altura do container e parent
                        const viewContainer = document.getElementById('view-imagens-lote');
                        if (viewContainer) {
                            viewContainer.style.overflowY = 'visible';
                            viewContainer.style.maxHeight = 'none';
                            viewContainer.style.height = 'auto';
                        }
                        
                        if (output.parentElement) {
                            output.parentElement.style.overflowY = 'visible';
                            output.parentElement.style.maxHeight = 'none';
                            output.parentElement.style.height = 'auto';
                        }
                        output.style.overflowY = 'visible';
                        output.style.maxHeight = 'none';
                        output.style.height = 'auto';
                    }, 100);
                }
                
                if (clearBtn && images.length > 0 && images.some(img => img)) {
                    clearBtn.style.display = 'block';
                } else if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
                
                // Configurar event listeners
                setupBatchImageEventListeners();
                
                // Configurar lightbox (apenas uma vez)
                if (!window._batchLightboxInitialized) {
                    setupImageLightbox();
                    window._batchLightboxInitialized = true;
                }
                
                // Atualizar √≠cones
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            }
            
            // Fun√ß√£o helper para escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Configurar event listeners para imagens em lote (IGUAL a setupImageGeneratorEventListeners)
            function setupBatchImageEventListeners() {
                // Selecionar tudo
                const selectAllBtn = document.getElementById('batch-select-all-images-btn');
                if (selectAllBtn) {
                    const newBtn = selectAllBtn.cloneNode(true);
                    selectAllBtn.parentNode.replaceChild(newBtn, selectAllBtn);
                    newBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        const isAnyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
                        checkboxes.forEach(cb => cb.checked = isAnyUnchecked);
                        newBtn.textContent = isAnyUnchecked ? 'Desselecionar Tudo' : 'Selecionar Tudo';
                    };
                }
                
                // Desmarcar todas
                const deselectAllBtn = document.getElementById('batch-deselect-all-images-btn');
                if (deselectAllBtn) {
                    const newBtn = deselectAllBtn.cloneNode(true);
                    deselectAllBtn.parentNode.replaceChild(newBtn, deselectAllBtn);
                    newBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        checkboxes.forEach(cb => cb.checked = false);
                    };
                }
                
                // Baixar selecionadas
                const downloadSelectedBtn = document.getElementById('batch-download-selected-images-btn');
                if (downloadSelectedBtn) {
                    const newBtn = downloadSelectedBtn.cloneNode(true);
                    downloadSelectedBtn.parentNode.replaceChild(newBtn, downloadSelectedBtn);
                    newBtn.onclick = async () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox:checked');
                        const selectedIndexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.imgIndex));
                        
                        let targets = [];
                        if (selectedIndexes.length === 0) {
                            // Se nada foi selecionado, baixar todas as imagens dispon√≠veis
                            targets = window.batchImageFxResults.images
                                .map((img, idx) => ({ img, idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        } else {
                            targets = selectedIndexes
                                .map(idx => ({ img: window.batchImageFxResults.images[idx], idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        }
                        
                        if (targets.length === 0) {
                            showMessage('imagens-lote-error-message', 'Nenhuma imagem dispon√≠vel para download.', true);
                            return;
                        }
                        
                        showMessage('imagens-lote-success-message', `Iniciando download de ${targets.length} imagem(ns)...`);
                        
                        for (const { img, idx } of targets) {
                            const dataUrl = img.url || `data:image/png;base64,${img.base64}`;
                            const filename = `cena-${img.sceneNumber || idx + 1}.png`;
                            downloadImage(dataUrl, filename);
                            await new Promise(resolve => setTimeout(resolve, 800)); // esperar 800ms entre downloads
                        }
                        
                        showMessage('imagens-lote-success-message', `Download de ${targets.length} imagem(ns) conclu√≠do!`);
                    };
                }
                
                // Limpar imagens
                const clearBtn = document.getElementById('batch-clear-all-images-btn');
                if (clearBtn) {
                    const newBtn = clearBtn.cloneNode(true);
                    clearBtn.parentNode.replaceChild(newBtn, clearBtn);
                    newBtn.onclick = () => {
                        if (confirm('Tem certeza de que deseja limpar todas as imagens geradas? Esta a√ß√£o n√£o pode ser desfeita.')) {
                            if (!window.batchImageFxResults) {
                                window.batchImageFxResults = { images: [], lastClearedImages: [] };
                            }
                            window.batchImageFxResults.lastClearedImages = [...window.batchImageFxResults.images];
                            window.batchImageFxResults.images = [];
                            renderBatchImageFxOutput();
                            showMessage('imagens-lote-success-message', 'Imagens limpas com sucesso!');
                        }
                    };
                }
                
                // Download individual
                document.querySelectorAll('#batch-generated-images-output .download-single-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const url = newBtn.dataset.imgUrl;
                        const base64 = newBtn.dataset.imgBase64;
                        const scene = newBtn.dataset.imgScene;
                        if (url) {
                            downloadImage(url, `cena-${scene}.png`);
                        } else if (base64) {
                            downloadImage(`data:image/png;base64,${base64}`, `cena-${scene}.png`);
                        }
                    };
                });
                
                // Toggle prompt (ver/editar)
                document.querySelectorAll('#batch-generated-images-output .batch-toggle-prompt-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const container = document.getElementById(`batch-edit-prompt-container-${index}`);
                        if (container) {
                            container.style.display = container.style.display === 'none' ? 'block' : 'none';
                        }
                    };
                });
                
                // Regenerar imagem com prompt editado
                document.querySelectorAll('#batch-generated-images-output .batch-regenerate-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = async () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const sceneNumber = newBtn.dataset.sceneNumber;
                        const aspectRatio = newBtn.dataset.imgAspectRatio;
                        const textarea = document.getElementById(`batch-edit-prompt-${index}`);
                        const editedPrompt = textarea?.value.trim();
                        
                        if (!editedPrompt) {
                            showMessage('imagens-lote-error-message', 'Por favor, edite o prompt antes de regenerar.', true);
                            return;
                        }
                        
                        try {
                            newBtn.disabled = true;
                            newBtn.textContent = 'Regenerando...';
                            
                            // Atualizar status da imagem
                            if (window.batchImageFxResults.images[index]) {
                                window.batchImageFxResults.images[index] = {
                                    ...window.batchImageFxResults.images[index],
                                    status: 'retrying',
                                    error: 'Regenerando com prompt editado...'
                                };
                                renderBatchImageFxOutput();
                            }
                            
                            const token = localStorage.getItem('core_token');
                            if (!token) {
                                throw new Error('Token n√£o encontrado.');
                            }
                            
                            const style = document.getElementById('batch-image-style-select')?.value || 'photorealistic';
                            
                            const response = await fetch(`${API_BASE}/api/generate/imagefx/regenerate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    prompt: editedPrompt,
                                    aspectRatio: aspectRatio || '16:9',
                                    style: style
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.msg || 'Erro ao regenerar imagem');
                            }
                            
                            const data = await response.json();
                            
                            if (window.batchImageFxResults.images[index]) {
                                window.batchImageFxResults.images[index] = {
                                    status: 'success',
                                    url: data.imageUrl || `data:image/png;base64,${data.image}`,
                                    base64: data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null),
                                    prompt: editedPrompt,
                                    sceneNumber: sceneNumber,
                                    aspectRatio: aspectRatio || '16:9'
                                };
                                renderBatchImageFxOutput();
                                showMessage('imagens-lote-success-message', 'Imagem regenerada com sucesso!');
                            }
                            
                        } catch (err) {
                            console.error('[Regenerate Image] Erro:', err);
                            
                            if (window.batchImageFxResults.images[index]) {
                                window.batchImageFxResults.images[index] = {
                                    ...window.batchImageFxResults.images[index],
                                    status: 'failed',
                                    error: err.message || 'Erro ao regenerar imagem'
                                };
                                renderBatchImageFxOutput();
                            }
                            
                            showMessage('imagens-lote-error-message', err.message || 'Erro ao regenerar imagem.', true);
                        } finally {
                            newBtn.disabled = false;
                            newBtn.textContent = 'Gerar Novamente';
                        }
                    };
                });
            }
            
            
            // Configurar event listeners dos bot√µes de imagem
            function setupImageGeneratorEventListeners() {
                // Selecionar tudo
                const selectAllBtn = document.getElementById('select-all-images-btn');
                if (selectAllBtn) {
                    const newBtn = selectAllBtn.cloneNode(true);
                    selectAllBtn.parentNode.replaceChild(newBtn, selectAllBtn);
                    newBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('.image-select-checkbox');
                        const isAnyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
                        checkboxes.forEach(cb => cb.checked = isAnyUnchecked);
                        newBtn.textContent = isAnyUnchecked ? 'Desselecionar Tudo' : 'Selecionar Tudo';
                    };
                }
                
                // Baixar selecionadas
                const downloadSelectedBtn = document.getElementById('download-selected-images-btn');
                if (downloadSelectedBtn) {
                    const newBtn = downloadSelectedBtn.cloneNode(true);
                    downloadSelectedBtn.parentNode.replaceChild(newBtn, downloadSelectedBtn);
                    newBtn.onclick = async () => {
                        const checkboxes = document.querySelectorAll('.image-select-checkbox:checked');
                        const selectedIndexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.imgIndex));
                        
                        let targets = [];
                        if (selectedIndexes.length === 0) {
                            // Se nada foi selecionado, baixar todas as imagens dispon√≠veis
                            targets = window.imageFxResults.images
                                .map((img, idx) => ({ img, idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        } else {
                            targets = selectedIndexes
                                .map(idx => ({ img: window.imageFxResults.images[idx], idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        }
                        
                        if (targets.length === 0) {
                            showMessage('prompts-imagens-error-message', 'Nenhuma imagem dispon√≠vel para download.', true);
                            return;
                        }
                        
                        showMessage('prompts-imagens-success-message', `Iniciando download de ${targets.length} imagem(ns)...`);
                        
                        for (const { img, idx } of targets) {
                            const dataUrl = img.url || `data:image/png;base64,${img.base64}`;
                            const filename = `cena-${img.sceneNumber || idx + 1}.png`;
                            downloadImage(dataUrl, filename);
                            await window.delay(800); // esperar 800ms entre downloads para evitar bloqueio do navegador
                        }
                        
                        showMessage('prompts-imagens-success-message', `Download de ${targets.length} imagem(ns) conclu√≠do!`);
                    };
                }
                
                // Limpar imagens
                const clearBtn = document.getElementById('clear-all-images-btn');
                if (clearBtn) {
                    const newBtn = clearBtn.cloneNode(true);
                    clearBtn.parentNode.replaceChild(newBtn, clearBtn);
                    newBtn.onclick = () => {
                        if (confirm('Tem certeza de que deseja limpar todas as imagens geradas? Esta a√ß√£o n√£o pode ser desfeita.')) {
                            window.imageFxResults.lastClearedImages = [...window.imageFxResults.images];
                            window.imageFxResults.images = [];
                            window.renderImageFxOutput();
                            showMessage('prompts-imagens-success-message', 'Imagens limpas com sucesso!');
                        }
                    };
                }
                
                // Download individual
                document.querySelectorAll('.download-single-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const url = newBtn.dataset.imgUrl;
                        const base64 = newBtn.dataset.imgBase64;
                        const scene = newBtn.dataset.imgScene;
                        if (url) {
                            downloadImage(url, `cena-${scene}.png`);
                        } else if (base64) {
                            downloadImage(`data:image/png;base64,${base64}`, `cena-${scene}.png`);
                        }
                    };
                });
                
                // Toggle prompt (ver/editar)
                document.querySelectorAll('.toggle-prompt-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const container = document.getElementById(`edit-prompt-container-${index}`);
                        if (container) {
                            container.style.display = container.style.display === 'none' ? 'block' : 'none';
                        }
                    };
                });
                
                // Regenerar imagem com prompt editado
                document.querySelectorAll('.regenerate-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = async () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const sceneNumber = newBtn.dataset.sceneNumber;
                        const aspectRatio = newBtn.dataset.imgAspectRatio;
                        const textarea = document.getElementById(`edit-prompt-${index}`);
                        const editedPrompt = textarea?.value.trim();
                        
                        if (!editedPrompt) {
                            showMessage('prompts-imagens-error-message', 'Por favor, edite o prompt antes de regenerar.', true);
                            return;
                        }
                        
                        try {
                            newBtn.disabled = true;
                            newBtn.textContent = 'Regenerando...';
                            
                            // Atualizar status da imagem
                            if (window.imageFxResults.images[index]) {
                                window.imageFxResults.images[index] = {
                                    ...window.imageFxResults.images[index],
                                    status: 'retrying',
                                    error: 'Regenerando com prompt editado...'
                                };
                                window.renderImageFxOutput();
                            }
                            
                            const token = localStorage.getItem('core_token');
                            if (!token) {
                                throw new Error('Token n√£o encontrado.');
                            }
                            
                            const style = document.getElementById('scene-style-select')?.value || 'photorealistic';
                            
                            const response = await fetch(`${API_BASE}/api/generate/imagefx/regenerate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    prompt: editedPrompt,
                                    aspectRatio: aspectRatio || '16:9',
                                    style: style
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.msg || 'Erro ao regenerar imagem');
                            }
                            
                            const data = await response.json();
                            
                            if (window.imageFxResults.images[index]) {
                                window.imageFxResults.images[index] = {
                                    status: 'success',
                                    url: data.imageUrl || `data:image/png;base64,${data.image}`,
                                    base64: data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null),
                                    prompt: editedPrompt,
                                    sceneNumber: sceneNumber,
                                    aspectRatio: aspectRatio || '16:9'
                                };
                                window.renderImageFxOutput();
                                showMessage('prompts-imagens-success-message', 'Imagem regenerada com sucesso!');
                            }
                            
                        } catch (err) {
                            console.error('[Regenerate Image] Erro:', err);
                            
                            if (window.imageFxResults.images[index]) {
                                window.imageFxResults.images[index] = {
                                    ...window.imageFxResults.images[index],
                                    status: 'failed',
                                    error: err.message || 'Erro ao regenerar imagem'
                                };
                                window.renderImageFxOutput();
                            }
                            
                            showMessage('prompts-imagens-error-message', err.message || 'Erro ao regenerar imagem.', true);
                        } finally {
                            newBtn.disabled = false;
                            newBtn.textContent = 'Gerar Novamente';
                        }
                    };
                });
            }
            
            // Formul√°rio de gerar prompts de cena
            const scenePromptsForm = document.getElementById('scene-prompts-form');
            if (scenePromptsForm) {
                scenePromptsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const script = document.getElementById('scene-script-text')?.value.trim();
                    const model = document.getElementById('scene-model-select')?.value;
                    const style = document.getElementById('scene-style-select')?.value;
                    const mode = document.getElementById('scene-generation-mode')?.value;
                    const wordsPerScene = document.getElementById('scene-words-per-scene')?.value;
                    const characters = document.getElementById('scene-characters')?.value.trim();
                    
                    if (!script || !model) {
                        showMessage('prompts-imagens-error-message', 'Por favor, preencha todos os campos.', true);
                        return;
                    }
                    
                    const btn = document.getElementById('btn-generate-scene-prompts');
                    const originalText = btn?.querySelector('span')?.textContent;
                    
                    try {
                        if (btn) {
                            btn.disabled = true;
                            if (btn.querySelector('span')) btn.querySelector('span').textContent = 'Gerando...';
                        }
                        
                        // Mostrar modal de progresso
                        const progressModal = document.getElementById('scene-prompts-progress-modal');
                        const progressBar = document.getElementById('progress-modal-bar');
                        const progressPercentage = document.getElementById('progress-modal-percentage');
                        const progressCounter = document.getElementById('progress-modal-counter');
                        const progressStatus = document.getElementById('progress-modal-status');
                        const progressDetails = document.getElementById('progress-modal-details');
                        
                        if (progressModal) {
                            progressModal.classList.remove('hidden');
                            if (progressBar) progressBar.style.width = '0%';
                            if (progressPercentage) progressPercentage.textContent = '0%';
                            if (progressCounter) progressCounter.textContent = '0/0';
                            if (progressStatus) progressStatus.textContent = 'Iniciando gera√ß√£o...';
                            if (progressDetails) progressDetails.textContent = 'Preparando a IA...';
                            
                            // Criar √≠cones
                            if (typeof lucide !== 'undefined') {
                                setTimeout(() => lucide.createIcons(), 100);
                            }
                        }
                        
                        hideMessage('prompts-imagens-error-message');
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            throw new Error('Token de autentica√ß√£o n√£o encontrado. Fa√ßa login novamente.');
                        }
                        
                        // Calcular estimativa de cenas para o contador
                        const wordCount = script.trim().split(/\s+/).filter(Boolean).length;
                        let estimatedScenes = 0;
                        if (mode === 'manual' && wordsPerScene) {
                            estimatedScenes = Math.max(1, Math.round(wordCount / parseInt(wordsPerScene)));
                        } else {
                            estimatedScenes = Math.max(1, Math.round(wordCount / 90));
                        }
                        
                        // Simular progresso enquanto aguarda resposta
                        let progress = 0;
                        const progressInterval = setInterval(() => {
                            if (progress < 90) {
                                progress += Math.random() * 5;
                                if (progress > 90) progress = 90;
                                
                                // Calcular quantos prompts foram "gerados" baseado na porcentagem
                                const currentPromptCount = Math.max(1, Math.floor((progress / 100) * estimatedScenes));
                                
                                if (progressBar) progressBar.style.width = `${progress}%`;
                                if (progressPercentage) progressPercentage.textContent = `${Math.round(progress)}%`;
                                if (progressCounter) progressCounter.textContent = `${currentPromptCount}/${estimatedScenes}`;
                                if (progressStatus) progressStatus.textContent = 'Gerando prompts com IA...';
                                if (progressDetails) progressDetails.textContent = `Analisando roteiro e criando ${estimatedScenes} cenas...`;
                            }
                        }, 500);
                        
                        // Verificar se laozhang.ai est√° configurada como padr√£o
                        let useLaozhang = false;
                        try {
                            const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (settingsResponse.ok) {
                                const settings = await settingsResponse.json();
                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                            }
                        } catch (err) {
                            console.warn('[Scene Prompts] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                        }
                        
                        // Usar rota /laozhang se configurada como padr√£o
                        const endpoint = useLaozhang ? '/api/generate/scene-prompts/laozhang' : '/api/generate/scene-prompts';
                        console.log(`[Scene Prompts] Usando endpoint: ${endpoint} (laozhang: ${useLaozhang})`);
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                script,
                                model: useLaozhang ? null : model, // N√£o enviar model se usar laozhang, mas sempre capturar o modelo selecionado
                                style,
                                mode,
                                wordsPerScene: mode === 'manual' ? parseInt(wordsPerScene) : null,
                                characters: characters || null,
                                imageModel: 'imageFx',
                                selectedModel: model // Sempre enviar o modelo selecionado para salvar no hist√≥rico
                            })
                        });
                        
                        clearInterval(progressInterval);
                        
                        // Atualizar progresso final
                        if (progressBar) progressBar.style.width = '100%';
                        if (progressPercentage) progressPercentage.textContent = '100%';
                        if (progressCounter) progressCounter.textContent = `${estimatedScenes}/${estimatedScenes}`;
                        if (progressStatus) progressStatus.textContent = 'Finalizando...';
                        if (progressDetails) progressDetails.textContent = 'Processando resposta da IA...';
                        
                        if (!response.ok) {
                            clearInterval(progressInterval);
                            const errorData = await response.json().catch(() => ({}));
                            
                            // Fechar modal e mostrar erro
                            if (progressModal) progressModal.classList.add('hidden');
                            throw new Error(errorData.msg || 'Erro ao gerar prompts de cena');
                        }
                        
                        const data = await response.json();
                        scenePromptsData = data.scenes || [];
                        
                        // Usar o modelo retornado pelo backend, ou o modelo selecionado como fallback
                        // O backend sempre retorna modelUsed com o modelo correto
                        let modelUsed = data.modelUsed;
                        if (!modelUsed) {
                            // Se n√£o retornou modelUsed, usar o modelo do select (que foi capturado antes)
                            modelUsed = model || document.getElementById('scene-model-select')?.value || 'gpt-4o';
                        }
                        
                        console.log('[Scene Prompts] ‚úÖ Modelo usado:', modelUsed, '| Modelo selecionado no frontend:', model, '| Modelo retornado pelo backend:', data.modelUsed);
                        
                        if (!scenePromptsData || scenePromptsData.length === 0) {
                            clearInterval(progressInterval);
                            if (progressModal) progressModal.classList.add('hidden');
                            throw new Error('Nenhum prompt foi gerado. Tente novamente.');
                        }
                        
                        // Atualizar contador final
                        if (progressCounter) progressCounter.textContent = `${scenePromptsData.length}/${scenePromptsData.length}`;
                        if (progressStatus) progressStatus.textContent = 'Conclu√≠do!';
                        if (progressDetails) progressDetails.textContent = `${scenePromptsData.length} prompts gerados com sucesso!`;
                        
                        // Fechar modal ap√≥s 1.5 segundos
                        setTimeout(() => {
                            if (progressModal) progressModal.classList.add('hidden');
                        }, 1500);
                        
                        // Renderizar prompts
                        renderScenePrompts(scenePromptsData);
                        
                        // Mostrar se√ß√£o de gerar imagens
                        const generateSection = document.getElementById('generate-all-images-section');
                        if (generateSection) {
                            generateSection.style.display = 'block';
                        }
                        
                        const countEl = document.getElementById('total-prompts-count');
                        if (countEl) {
                            countEl.textContent = `${scenePromptsData.length} prompts prontos`;
                        }
                        
                        showMessage('prompts-imagens-success-message', data.msg || `${scenePromptsData.length} prompts gerados com sucesso!`);
                        
                        // Salvar no hist√≥rico com o modelo correto
                        try {
                            const historyResponse = await fetch(`${API_BASE}/api/scene-prompts/history`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    script: script,
                                    scenes: scenePromptsData,
                                    model: modelUsed, // Usar o modelo retornado pelo backend
                                    style: style,
                                    mode: mode,
                                    wordsPerScene: mode === 'manual' ? parseInt(wordsPerScene) : null,
                                    characters: characters || null,
                                    title: `Prompts gerados em ${new Date().toLocaleString('pt-BR')}`
                                })
                            });
                            
                            if (!historyResponse.ok) {
                                const errorData = await historyResponse.json().catch(() => ({}));
                                console.warn('[Save History] Erro ao salvar no hist√≥rico:', errorData.msg || 'Erro desconhecido');
                            } else {
                                console.log('[Save History] Hist√≥rico salvo com sucesso!');
                            }
                        } catch (historyErr) {
                            console.error('[Save History] Erro ao salvar no hist√≥rico:', historyErr);
                        }
                        
                        // Recarregar hist√≥rico
                        loadScenePromptsHistory();
                        
                    } catch (err) {
                        console.error('[Scene Prompts] Erro:', err);
                        
                        // Garantir que o modal seja fechado em caso de erro
                        const progressModal = document.getElementById('scene-prompts-progress-modal');
                        if (progressModal) {
                            progressModal.classList.add('hidden');
                        }
                        
                        showMessage('prompts-imagens-error-message', err.message || 'Erro ao gerar prompts de cena.', true);
                    } finally {
                        if (btn) {
                            btn.disabled = false;
                            if (btn.querySelector('span') && originalText) {
                                btn.querySelector('span').textContent = originalText;
                            }
                        }
                    }
                });
            }
            
            // Fun√ß√£o para renderizar prompts
            function renderScenePrompts(scenes) {
                const container = document.getElementById('scene-prompts-list');
                const resultsDiv = document.getElementById('scene-prompts-results');
                
                if (!container || !resultsDiv) return;
                
                if (scenes.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">Nenhum prompt gerado.</p>';
                    return;
                }
                
                container.innerHTML = scenes.map((scene, index) => `
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-white font-semibold">Cena ${scene.scene_number || index + 1}: ${scene.scene_description || 'Cena'}</h4>
                            <button onclick="copyToClipboard('scene-prompt-${index}')" class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <textarea id="scene-prompt-${index}" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded text-gray-300 text-sm" rows="3" readonly>${escapeHtml(scene.prompt_text || '')}</textarea>
                    </div>
                `).join('');
                
                resultsDiv.classList.remove('hidden');
                
                // Configurar bot√£o de download
                const downloadBtn = document.getElementById('download-prompts-btn');
                if (downloadBtn) {
                    const newBtn = downloadBtn.cloneNode(true);
                    downloadBtn.parentNode.replaceChild(newBtn, downloadBtn);
                    newBtn.onclick = () => {
                        downloadScenePrompts(scenes);
                    };
                }
                
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            
            // Fun√ß√£o para baixar prompts de cena
            function downloadScenePrompts(scenes) {
                if (!scenes || scenes.length === 0) {
                    showMessage('prompts-imagens-error-message', 'Nenhum prompt dispon√≠vel para download.', true);
                    return;
                }
                
                // Criar conte√∫do do arquivo
                let content = `PROMPTS DE CENA GERADOS\n`;
                content += `Data: ${new Date().toLocaleString('pt-BR')}\n`;
                content += `Total de cenas: ${scenes.length}\n`;
                content += `\n${'='.repeat(60)}\n\n`;
                
                scenes.forEach((scene, index) => {
                    content += `CENA ${scene.scene_number || index + 1}`;
                    if (scene.scene_description) {
                        content += `: ${scene.scene_description}`;
                    }
                    content += `\n${'-'.repeat(60)}\n`;
                    content += `${scene.prompt_text || ''}\n\n`;
                });
                
                // Criar e baixar arquivo
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `prompts-cena-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showMessage('prompts-imagens-success-message', `${scenes.length} prompt(s) baixado(s) com sucesso!`);
            }
            
            // Inicializar appState para controle de gera√ß√£o
            if (!window.appState) {
                window.appState = { imageGenStatus: { active: false, current: 0, total: 0, message: '', cancelled: false } };
            }
            
            // Fun√ß√£o para gera√ß√£o em paralelo (estilo DARKSCRIPT)
            const runTasksWithConcurrency = async (tasks, limit, processor) => {
                return new Promise((resolve) => {
                    let nextIndex = 0;
                    let active = 0;
                    
                    const launchNext = () => {
                        if (nextIndex >= tasks.length && active === 0) {
                            resolve();
                            return;
                        }
                        while (active < limit && nextIndex < tasks.length) {
                            const task = tasks[nextIndex++];
                            active++;
                            processor(task).finally(() => {
                                active--;
                                launchNext();
                            });
                        }
                    };
                    
                    launchNext();
                });
            };
            
            // Bot√£o de gerar todas as imagens (estilo DARKSCRIPT)
            const btnGenerateAllImages = document.getElementById('btn-generate-all-images');
            if (btnGenerateAllImages) {
                btnGenerateAllImages.addEventListener('click', async () => {
                    if (scenePromptsData.length === 0) {
                        showMessage('prompts-imagens-error-message', 'Gere os prompts de cena primeiro!', true);
                        return;
                    }
                    
                    // Mostrar modal de confirma√ß√£o customizado
                    const confirmModal = document.getElementById('confirm-generation-modal');
                    const confirmMessage = document.getElementById('confirm-modal-message');
                    const confirmCount = document.getElementById('confirm-modal-count');
                    const confirmBtn = document.getElementById('confirm-modal-confirm');
                    const cancelBtn = document.getElementById('confirm-modal-cancel');
                    
                    if (confirmModal && confirmMessage && confirmCount) {
                        confirmCount.textContent = `${scenePromptsData.length} imagem${scenePromptsData.length !== 1 ? 'ns' : ''}`;
                        confirmMessage.textContent = `Voc√™ est√° prestes a gerar ${scenePromptsData.length} imagem${scenePromptsData.length !== 1 ? 'ns' : ''} para o seu v√≠deo.`;
                        
                        if (typeof lucide !== 'undefined') {
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                        
                        confirmModal.classList.remove('hidden');
                        
                        // Aguardar confirma√ß√£o
                        const userConfirmed = await new Promise((resolve) => {
                            const handleConfirm = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(true);
                            };
                            
                            const handleCancel = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(false);
                            };
                            
                            confirmBtn.addEventListener('click', handleConfirm);
                            cancelBtn.addEventListener('click', handleCancel);
                            
                            // Fechar com ESC
                            const handleEsc = (e) => {
                                if (e.key === 'Escape') {
                                    document.removeEventListener('keydown', handleEsc);
                                    handleCancel();
                                }
                            };
                            document.addEventListener('keydown', handleEsc);
                        });
                        
                        if (!userConfirmed) return;
                    }
                    
                    try {
                        btnGenerateAllImages.disabled = true;
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            throw new Error('Token de autentica√ß√£o n√£o encontrado.');
                        }
                        
                        const style = document.getElementById('scene-style-select')?.value || 'photorealistic';
                        const prompts = scenePromptsData.map(s => s.prompt_text).filter(Boolean);
                        const totalPrompts = prompts.length;
                        
                        // Limpar imagens anteriores
                        window.imageFxResults.images = [];
                        window.renderImageFxOutput();
                        
                        // Inicializar status de gera√ß√£o
                        window.appState.imageGenStatus = {
                            active: true,
                            current: 0,
                            total: totalPrompts,
                            message: `A iniciar ${totalPrompts} prompt(s)...`,
                            cancelled: false
                        };
                        window.renderImageGenerationProgress(window.appState.imageGenStatus);
                        
                        // Preparar tasks
                        const tasks = prompts.map((prompt, idx) => {
                            const sceneNumber = scenePromptsData[idx]?.scene_number || idx + 1;
                            const imageIndex = idx;
                            
                            // Adicionar placeholder
                            window.imageFxResults.images.push({
                                status: 'pending',
                                prompt: prompt,
                                error: 'A gerar...',
                                sceneNumber: sceneNumber,
                                aspectRatio: '16:9'
                            });
                            
                            return { prompt, sceneNumber, imageIndex };
                        });
                        
                        window.renderImageFxOutput();
                        
                        let completed = 0;
                        const generationStartTime = Date.now();
                        
                        const processTask = async (task) => {
                            if (window.appState.imageGenStatus.cancelled) {
                                return;
                            }
                            
                            const { prompt: currentPrompt, sceneNumber: currentSceneNumber, imageIndex: currentImageIndex } = task;
                            
                            try {
                                const response = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        prompt: currentPrompt,
                                        style: style,
                                        aspectRatio: '16:9'
                                    })
                                });
                                
                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({}));
                                    throw new Error(errorData.msg || 'Erro ao gerar imagem');
                                }
                                
                                const data = await response.json();
                                
                                if (data.image || data.base64 || data.imageUrl) {
                                    const base64 = data.base64 || data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null);
                                    const url = data.imageUrl || `data:image/png;base64,${base64}`;
                                    
                                    window.imageFxResults.images[currentImageIndex] = {
                                        status: 'success',
                                        url: url,
                                        base64: base64,
                                        prompt: data.prompt || currentPrompt,
                                        sceneNumber: currentSceneNumber,
                                        aspectRatio: '16:9',
                                        wasRewritten: data.wasRewritten || false
                                    };
                                } else {
                                    throw new Error('A API retornou uma resposta vazia.');
                                }
                                
                                completed++;
                                window.appState.imageGenStatus.current = completed;
                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                window.renderImageFxOutput();
                                
                            } catch (error) {
                                console.error(`Erro na gera√ß√£o ImageFX para cena ${currentSceneNumber}:`, error);
                                const userFriendlyMessage = error.message || 'Erro desconhecido.';
                                const errorLower = userFriendlyMessage.toLowerCase();
                                
                                // Verificar se √© erro de throttling (429)
                                const isThrottleError = errorLower.includes('throttled') || 
                                                       errorLower.includes('429') ||
                                                       errorLower.includes('limite de requisi√ß√µes') ||
                                                       errorLower.includes('rate limit');
                                
                                // Verificar se √© erro de pol√≠tica (bloqueado)
                                const isPolicyError = errorLower.includes('bloqueado') || 
                                                     errorLower.includes('conte√∫do inseguro') || 
                                                     errorLower.includes('conteudo inseguro') ||
                                                     errorLower.includes('unsafe') ||
                                                     errorLower.includes('policy');
                                
                                // Se for erro de throttling, aguardar e tentar novamente
                                if (isThrottleError) {
                                    window.imageFxResults.images[currentImageIndex] = {
                                        status: 'retrying',
                                        prompt: currentPrompt,
                                        error: 'Limite de requisi√ß√µes atingido. Aguardando e tentando novamente...',
                                        sceneNumber: currentSceneNumber,
                                        aspectRatio: '16:9'
                                    };
                                    window.renderImageFxOutput();
                                    
                                    // Aguardar 5-10 segundos antes de tentar novamente
                                    await new Promise(resolve => setTimeout(resolve, 5000 + Math.random() * 5000));
                                    
                                    // Tentar gerar novamente
                                    try {
                                        const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({
                                                prompt: currentPrompt,
                                                style: style,
                                                aspectRatio: '16:9'
                                            })
                                        });
                                        
                                        if (retryResponse.ok) {
                                            const retryData = await retryResponse.json();
                                            const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                            const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                            
                                            if (base64 || retryData.image || retryData.imageUrl) {
                                                window.imageFxResults.images[currentImageIndex] = {
                                                    status: 'success',
                                                    url: url,
                                                    base64: base64,
                                                    prompt: currentPrompt,
                                                    sceneNumber: currentSceneNumber,
                                                    aspectRatio: '16:9'
                                                };
                                                completed++;
                                                window.appState.imageGenStatus.current = completed;
                                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                                window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                                window.renderImageFxOutput();
                                                return;
                                            }
                                        }
                                    } catch (retryErr) {
                                        console.warn(`[Retry Throttle] Erro ao tentar novamente ap√≥s throttling para cena ${currentSceneNumber}:`, retryErr);
                                    }
                                }
                                
                                if (isPolicyError) {
                                    // Marcar como retrying e tentar reescrever automaticamente
                                    window.imageFxResults.images[currentImageIndex] = {
                                        status: 'retrying',
                                        prompt: currentPrompt,
                                        error: 'Prompt bloqueado. Reescrevendo automaticamente...',
                                        sceneNumber: currentSceneNumber,
                                        aspectRatio: '16:9'
                                    };
                                    window.renderImageFxOutput();
                                    
                                    // Tentar reescrever o prompt usando IA
                                    try {
                                        // Verificar se laozhang.ai est√° configurada como padr√£o
                                        let useLaozhang = false;
                                        try {
                                            const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                                headers: { 'Authorization': `Bearer ${token}` }
                                            });
                                            if (settingsResponse.ok) {
                                                const settings = await settingsResponse.json();
                                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                                            }
                                        } catch (err) {
                                            console.warn('[Rewrite Prompt] Erro ao verificar configura√ß√£o laozhang.ai:', err);
                                        }
                                        
                                        const endpoint = useLaozhang ? '/api/rewrite/blocked-prompt/laozhang' : '/api/rewrite/blocked-prompt';
                                        const selectedModel = document.getElementById('scene-model-select')?.value || 'gpt-4o';
                                        
                                        const rewriteResponse = await fetch(`${API_BASE}${endpoint}`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({
                                                prompt: currentPrompt,
                                                model: useLaozhang ? null : selectedModel,
                                                selectedModel: selectedModel
                                            })
                                        });
                                        
                                        if (rewriteResponse.ok) {
                                            const rewriteData = await rewriteResponse.json();
                                            const rewrittenPrompt = rewriteData.rewrittenPrompt || currentPrompt;
                                            
                                            // Atualizar status
                                            window.imageFxResults.images[currentImageIndex] = {
                                                ...window.imageFxResults.images[currentImageIndex],
                                                error: 'Gerando com prompt reescrito...'
                                            };
                                            window.renderImageFxOutput();
                                            
                                            // Aguardar antes de tentar novamente
                                            await new Promise(resolve => setTimeout(resolve, 2000));
                                            
                                            // Tentar gerar novamente com prompt reescrito
                                            const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Authorization': `Bearer ${token}`
                                                },
                                                body: JSON.stringify({
                                                    prompt: rewrittenPrompt,
                                                    style: style,
                                                    aspectRatio: '16:9'
                                                })
                                            });
                                            
                                            if (retryResponse.ok) {
                                                const retryData = await retryResponse.json();
                                                const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                                const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                                
                                                if (base64 || retryData.image || retryData.imageUrl) {
                                                    window.imageFxResults.images[currentImageIndex] = {
                                                        status: 'success',
                                                        url: url,
                                                        base64: base64,
                                                        prompt: rewrittenPrompt,
                                                        sceneNumber: currentSceneNumber,
                                                        aspectRatio: '16:9',
                                                        wasRewritten: true,
                                                        originalPrompt: currentPrompt
                                                    };
                                                    completed++;
                                                    window.appState.imageGenStatus.current = completed;
                                                    window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                                    window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                                    window.renderImageFxOutput();
                                                    return;
                                                }
                                            }
                                        }
                                    } catch (rewriteErr) {
                                        console.warn(`[Retry] Erro ao reescrever prompt para cena ${currentSceneNumber}:`, rewriteErr);
                                    }
                                }
                                
                                // Se chegou aqui, falhou mesmo ap√≥s retry
                                window.imageFxResults.images[currentImageIndex] = {
                                    status: 'failed',
                                    prompt: currentPrompt,
                                    error: userFriendlyMessage,
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9'
                                };
                                
                                completed++;
                                window.appState.imageGenStatus.current = completed;
                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                window.renderImageFxOutput();
                            }
                        };
                        
                        // Executar em paralelo (3 por vez)
                        await runTasksWithConcurrency(tasks, 3, processTask);
                        
                        if (window.appState.imageGenStatus.cancelled) {
                            window.appState.imageGenStatus.active = false;
                            window.appState.imageGenStatus.message = 'Gera√ß√£o cancelada pelo usu√°rio.';
                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                            showMessage('prompts-imagens-success-message', 'Gera√ß√£o cancelada pelo usu√°rio.');
                            return;
                        }
                        
                        // Processar imagens com erro automaticamente (retry em paralelo, 3 por vez)
                        let retryAttempt = 0;
                        const maxRetryAttempts = 5;
                        
                        while (retryAttempt < maxRetryAttempts) {
                            const failedImages = window.imageFxResults.images
                                .map((img, idx) => ({ ...img, originalIndex: idx }))
                                .filter(img => img.status === 'failed');
                            
                            if (failedImages.length === 0) break;
                            
                            retryAttempt++;
                            window.appState.imageGenStatus.message = `Tentativa ${retryAttempt}: Regenerando ${failedImages.length} imagem(ns) com erro...`;
                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                            
                            // Processar falhas em paralelo (3 por vez)
                            const retryTasks = failedImages.map(failedImg => ({
                                img: failedImg,
                                index: failedImg.originalIndex
                            }));
                            
                            const processRetryTask = async (task) => {
                                if (window.appState.imageGenStatus.cancelled) return;
                                
                                const { img: failedImg, index: originalIndex } = task;
                                const { prompt: failedPrompt, sceneNumber: failedSceneNumber } = failedImg;
                                
                                try {
                                    // Marcar como retrying
                                    window.imageFxResults.images[originalIndex] = {
                                        ...window.imageFxResults.images[originalIndex],
                                        status: 'retrying',
                                        error: 'Regenerando automaticamente...'
                                    };
                                    window.renderImageFxOutput();
                                    
                                    // Aguardar um pouco antes de tentar
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                    
                                    // Tentar gerar novamente
                                    const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            prompt: failedPrompt,
                                            style: style,
                                            aspectRatio: '16:9'
                                        })
                                    });
                                    
                                    if (retryResponse.ok) {
                                        const retryData = await retryResponse.json();
                                        const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                        const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                        
                                        if (base64 || retryData.image || retryData.imageUrl) {
                                            window.imageFxResults.images[originalIndex] = {
                                                status: 'success',
                                                url: url,
                                                base64: base64,
                                                prompt: retryData.prompt || failedPrompt,
                                                sceneNumber: failedSceneNumber,
                                                aspectRatio: '16:9',
                                                wasRewritten: retryData.wasRewritten || false
                                            };
                                            // Atualizar contador
                                            const currentSuccess = window.imageFxResults.images.filter(img => img.status === 'success').length;
                                            window.appState.imageGenStatus.current = currentSuccess;
                                            window.appState.imageGenStatus.message = `Regenerando... ${currentSuccess}/${totalPrompts}`;
                                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                            window.renderImageFxOutput();
                                        }
                                    } else {
                                        throw new Error('Erro na resposta');
                                    }
                                } catch (retryErr) {
                                    console.warn(`[Auto Retry] Erro ao regenerar cena ${failedSceneNumber}:`, retryErr);
                                    // Manter como failed para pr√≥xima tentativa
                                    window.imageFxResults.images[originalIndex] = {
                                        ...window.imageFxResults.images[originalIndex],
                                        status: 'failed',
                                        error: retryErr.message || 'Erro ao regenerar'
                                    };
                                    window.renderImageFxOutput();
                                }
                            };
                            
                            await runTasksWithConcurrency(retryTasks, 3, processRetryTask);
                            
                            // Aguardar antes da pr√≥xima tentativa
                            if (retryAttempt < maxRetryAttempts) {
                                await new Promise(resolve => setTimeout(resolve, 2000));
                            }
                        }
                        
                        // Finalizar
                        const finalSuccessCount = window.imageFxResults.images.filter(img => img.status === 'success').length;
                        const finalFailedCount = window.imageFxResults.images.filter(img => img.status === 'failed').length;
                        const durationSeconds = Math.max(1, Math.round((Date.now() - generationStartTime) / 1000));
                        
                        window.appState.imageGenStatus.active = false;
                        window.appState.imageGenStatus.message = `Conclu√≠do. ${finalSuccessCount} sucesso, ${finalFailedCount} erro(s).`;
                        window.renderImageGenerationProgress(window.appState.imageGenStatus);
                        
                        // Mostrar modal de conclus√£o
                        if (typeof window.showImageGenCompleteModal === 'function') {
                            window.showImageGenCompleteModal(durationSeconds, finalSuccessCount, finalFailedCount);
                        } else {
                            // Fallback: mostrar mensagem
                            showMessage('prompts-imagens-success-message', `${finalSuccessCount} imagem(ns) gerada(s) com sucesso${finalFailedCount > 0 ? `, ${finalFailedCount} erro(s)` : ''} em ${durationSeconds} segundos!`);
                        }
                        
                        window.renderImageFxOutput();
                        
                    } catch (err) {
                        console.error('[Generate All Images] Erro:', err);
                        showMessage('prompts-imagens-error-message', err.message || 'Erro ao gerar imagens.', true);
                        if (window.appState) {
                            window.appState.imageGenStatus.active = false;
                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                        }
                    } finally {
                        btnGenerateAllImages.disabled = false;
                    }
                });
            }
            
            // Fun√ß√£o para mostrar modal de conclus√£o
            window.showImageGenCompleteModal = function(durationInSeconds, successCount = 0, failedCount = 0) {
                const modal = document.getElementById('image-gen-complete-modal');
                if (!modal) return;

                const durationEl = document.getElementById('image-gen-duration');
                const successCountEl = document.getElementById('image-gen-success-count');
                const failedCountEl = document.getElementById('image-gen-failed-count');
                
                if (durationEl) {
                    const minutes = Math.floor(durationInSeconds / 60);
                    const seconds = durationInSeconds % 60;
                    durationEl.textContent = minutes > 0 
                        ? `Tempo total: ${minutes}min ${seconds}s`
                        : `Tempo total: ${durationInSeconds}s`;
                }
                
                if (successCountEl) {
                    successCountEl.textContent = `${successCount} sucesso`;
                }
                
                if (failedCountEl) {
                    failedCountEl.textContent = failedCount > 0 ? `${failedCount} erros` : '0 erros';
                    failedCountEl.style.display = failedCount > 0 ? 'block' : 'none';
                }

                modal.classList.remove('hidden');
                
                // Atualizar √≠cones
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }

                const closeBtn = document.getElementById('close-image-gen-modal-btn');
                const viewBtn = document.getElementById('view-generated-images-btn');

                if (closeBtn) {
                    const newCloseBtn = closeBtn.cloneNode(true);
                    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
                    newCloseBtn.onclick = () => modal.classList.add('hidden');
                }
                
                if (viewBtn) {
                    const newViewBtn = viewBtn.cloneNode(true);
                    viewBtn.parentNode.replaceChild(newViewBtn, viewBtn);
                    newViewBtn.onclick = () => {
                        modal.classList.add('hidden');
                        // Fazer scroll para as imagens
                        const output = document.getElementById('generated-images-output');
                        if (output) {
                            output.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    };
                }
            };
            
            // Fun√ß√£o auxiliar para download de imagem
            window.downloadImage = function(dataUrl, filename) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            window.delay = function(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            };

            // ================================================
            // GERADOR DE VOZ (TTS) - FUN√á√ïES
            // ================================================
            const TTS_PROVIDER_MODELS = {
                voice_premium: 'genaipro-default',
                genaipro: 'genaipro-default',
                openai: 'tts-1-hd',
                gemini: 'gemini-2.5-pro-preview-tts',
                laozhang: 'tts-1'
            };

            function getProviderDefaultTtsModel(provider) {
                return TTS_PROVIDER_MODELS[provider] || 'gemini-2.5-pro-preview-tts';
            }

            function getProviderFriendlyName(provider) {
                switch (provider) {
                    case 'voice_premium':
                    case 'genaipro':
                        return 'Voz Premium';
                    case 'openai':
                        return 'La Casa Dark Core IA';
                    case 'gemini':
                        return 'La Casa Dark Core IA';
                    case 'laozhang':
                        return 'DarkVoz';
                    default:
                        return 'La Casa Dark Core';
                }
            }
            
            let ttsJobId = null;
            let ttsPollInterval = null;
            
            // Carregar vozes quando a view √© exibida
            async function loadTtsVoices() {
                const voiceSelect = document.getElementById('tts-voice-select');
                const providerSelect = document.getElementById('tts-provider-select');
                
                if (!voiceSelect || !providerSelect) return;
                
                const provider = providerSelect.value || 'voice_premium';
                const providerName = getProviderFriendlyName(provider);
                
                try {
                    const response = await fetch(`${API_BASE}/api/tts/voices?provider=${provider}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        voiceSelect.innerHTML = '<option value="">Selecione uma voz...</option>';
                        
                        console.log('[TTS] Vozes recebidas:', data);
                        
                        if (data.data && Array.isArray(data.data)) {
                            if (data.data.length === 0) {
                                voiceSelect.innerHTML = '<option value="">Nenhuma voz dispon√≠vel</option>';
                                showMessage('tts-error-message', `Nenhuma voz dispon√≠vel. Verifique se a chave de API do ${providerName} est√° configurada corretamente.`, true);
                            } else {
                                data.data.forEach(voice => {
                                    const option = document.createElement('option');
                                    // Usar o ID (voice_id) como value para a API, mas mostrar o label amig√°vel
                                    const voiceId = voice.id || voice.voice_id || voice.name || '';
                                    option.value = voiceId;
                                    option.textContent = voice.label || voice.name || voice.voice_name || voiceId || 'Voz';
                                    option.setAttribute('data-voice-id', voiceId);
                                    voiceSelect.appendChild(option);
                                });
                                console.log(`[TTS] ${data.data.length} vozes carregadas com sucesso`);
                            }
                        } else {
                            console.warn('[TTS] Formato de resposta inesperado:', data);
                            voiceSelect.innerHTML = '<option value="">Erro ao carregar vozes</option>';
                        }
                    } else {
                        // Se a resposta n√£o foi OK, tentar ler a mensagem de erro
                        const errorData = await response.json().catch(() => ({ message: 'Erro ao carregar vozes' }));
                        console.error('[TTS] Erro ao carregar vozes:', errorData);
                        voiceSelect.innerHTML = '<option value="">Erro ao carregar vozes</option>';
                        showMessage('tts-error-message', errorData.message || `Erro ao carregar vozes. Verifique se a chave de API do ${providerName} est√° configurada no painel admin.`, true);
                    }
                } catch (error) {
                    console.error('Erro ao carregar vozes:', error);
                    voiceSelect.innerHTML = '<option value="">Erro ao carregar vozes</option>';
                    showMessage('tts-error-message', `Erro ao carregar vozes (${providerName}): ${error.message || 'Erro desconhecido'}`, true);
                }
            }
            
            // Preview de voz - Abrir modal
            document.getElementById('tts-preview-btn')?.addEventListener('click', async () => {
                const voiceSelect = document.getElementById('tts-voice-select');
                const providerSelect = document.getElementById('tts-provider-select');
                
                const voice = voiceSelect?.value;
                const provider = providerSelect?.value || 'laozhang';
                
                if (!voice) {
                    showMessage('tts-error-message', 'Por favor, selecione uma voz para testar.');
                    return;
                }
                
                // Obter modelo e velocidade se for DarkVoz
                let model = getProviderDefaultTtsModel(provider);
                let speed = 1.0;
                if (provider === 'laozhang') {
                    const modelSelect = document.getElementById('tts-model-select');
                    const speedSelect = document.getElementById('tts-speed-select');
                    if (modelSelect) model = modelSelect.value || 'tts-1';
                    if (speedSelect) speed = parseFloat(speedSelect.value) || 1.0;
                }
                
                // Mostrar modal
                const modal = document.getElementById('tts-preview-modal');
                const loadingDiv = document.getElementById('tts-preview-loading');
                const player = document.getElementById('tts-preview-player');
                const errorDiv = document.getElementById('tts-preview-error');
                
                modal.classList.remove('hidden');
                loadingDiv.classList.remove('hidden');
                player.style.display = 'none';
                errorDiv.classList.add('hidden');
                errorDiv.textContent = '';
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                try {
                    const response = await fetch(`${API_BASE}/api/tts/preview`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            voice: voice,
                            provider: provider,
                            model: model,
                            speed: speed
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.audio && data.audio.base64) {
                            loadingDiv.classList.add('hidden');
                            player.src = `data:${data.audio.mimeType};base64,${data.audio.base64}`;
                            player.style.display = 'block';
                            player.play();
                        } else {
                            throw new Error('√Åudio n√£o retornado');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Erro ao gerar preview' }));
                        const errorMessage = errorData.message || errorData.details || `Erro ${response.status} ao gerar preview`;
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    loadingDiv.classList.add('hidden');
                    const errorMessage = error.message || 'Erro ao gerar preview.';
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.remove('hidden');
                    console.error('[TTS Preview] Erro:', error);
                }
            });
            
            // Fechar modal de preview
            document.getElementById('tts-preview-modal-close')?.addEventListener('click', () => {
                document.getElementById('tts-preview-modal').classList.add('hidden');
            });
            
            document.getElementById('tts-preview-modal-close-btn')?.addEventListener('click', () => {
                document.getElementById('tts-preview-modal').classList.add('hidden');
            });
            
            // Gerar narra√ß√£o completa
            document.getElementById('tts-generate-btn')?.addEventListener('click', async () => {
                const scriptInput = document.getElementById('tts-script-input');
                const voiceSelect = document.getElementById('tts-voice-select');
                const providerSelect = document.getElementById('tts-provider-select');
                const styleInstructions = document.getElementById('tts-style-instructions');
                
                const script = scriptInput?.value.trim();
                const voice = voiceSelect?.value;
                const provider = providerSelect?.value || 'laozhang';
                const style = styleInstructions?.value.trim() || '';
                
                if (!script || !voice) {
                    showMessage('tts-error-message', 'Por favor, preencha o roteiro e selecione uma voz.');
                    return;
                }
                
                // Obter velocidade se for DarkVoz (modelo ser√° 'tts-1' por padr√£o)
                let model = getProviderDefaultTtsModel(provider);
                let speed = 1.0;
                if (provider === 'laozhang') {
                    const speedSelect = document.getElementById('tts-speed-select');
                    if (speedSelect) speed = parseFloat(speedSelect.value) || 1.0;
                    model = 'tts-1'; // Modelo fixo para laozhang
                }
                
                // Mostrar modal de progresso
                document.getElementById('tts-progress-modal').classList.remove('hidden');
                document.getElementById('tts-progress-status').textContent = 'Iniciando gera√ß√£o...';
                document.getElementById('tts-progress-counter').textContent = '0/0';
                document.getElementById('tts-progress-percentage').textContent = '0%';
                document.getElementById('tts-progress-bar').style.width = '0%';
                
                try {
                    const response = await fetch(`${API_BASE}/api/tts/generate-from-script`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            script: script,
                            voice: voice,
                            ttsModel: model,
                            styleInstructions: style,
                            provider: provider,
                            speed: speed
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        ttsJobId = data.jobId;
                        
                        // Iniciar polling (a cada 1 segundo para atualiza√ß√£o mais r√°pida)
                        if (ttsPollInterval) clearInterval(ttsPollInterval);
                        ttsPollInterval = setInterval(pollTtsStatus, 1000);
                        
                        // Primeira atualiza√ß√£o imediata
                        setTimeout(pollTtsStatus, 500);
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
                        const errorMessage = errorData.message || errorData.msg || `Erro ${response.status} ao iniciar gera√ß√£o`;
                        showMessage('tts-error-message', errorMessage, true);
                        document.getElementById('tts-progress-modal').classList.add('hidden');
                        console.error('[TTS Generate] Erro:', errorData);
                    }
                } catch (error) {
                    showMessage('tts-error-message', 'Erro ao iniciar gera√ß√£o: ' + error.message);
                    document.getElementById('tts-progress-modal').classList.add('hidden');
                }
            });
            
            // Polling de status
            async function pollTtsStatus() {
                if (!ttsJobId) return;
                
                try {
                    const response = await fetch(`${API_BASE}/api/tts/status/${ttsJobId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        const progress = data.progress || 0;
                        const total = data.total || 1;
                        const percentage = total > 0 ? Math.round((progress / total) * 100) : 0;
                        
                        // Atualizar status e mensagem
                        const statusEl = document.getElementById('tts-progress-status');
                        const detailsEl = document.getElementById('tts-progress-details');
                        if (statusEl) statusEl.textContent = data.message || 'Processando...';
                        if (detailsEl) detailsEl.textContent = data.message || `Gerando parte ${progress} de ${total}...`;
                        
                        // Atualizar contador e porcentagem
                        document.getElementById('tts-progress-counter').textContent = `${progress}/${total}`;
                        document.getElementById('tts-progress-percentage').textContent = `${percentage}%`;
                        
                        // Atualizar barra de progresso com anima√ß√£o suave
                        const progressBar = document.getElementById('tts-progress-bar');
                        if (progressBar) {
                            progressBar.style.width = `${percentage}%`;
                            progressBar.style.transition = 'width 0.5s ease-out';
                        }
                        
                        if (data.status === 'completed') {
                            clearInterval(ttsPollInterval);
                            ttsPollInterval = null;
                            
                            // Garantir 100% antes de fechar
                            document.getElementById('tts-progress-percentage').textContent = '100%';
                            document.getElementById('tts-progress-bar').style.width = '100%';
                            document.getElementById('tts-progress-status').textContent = 'Conclu√≠do!';
                            document.getElementById('tts-progress-details').textContent = 'Narra√ß√£o gerada com sucesso!';
                            
                            // Aguardar um pouco antes de fechar o modal
                            setTimeout(() => {
                            document.getElementById('tts-progress-modal').classList.add('hidden');
                            
                            // Mostrar modal de conclus√£o
                            if (data.downloadUrl) {
                                const downloadLink = document.getElementById('tts-download-link');
                                    if (downloadLink) {
                                downloadLink.href = data.downloadUrl;
                                downloadLink.download = `narracao_${Date.now()}.mp3`;
                                    }
                                    const completeModal = document.getElementById('tts-complete-modal');
                                    if (completeModal) completeModal.classList.remove('hidden');
                            }
                            
                            showMessage('tts-success-message', 'Narra√ß√£o gerada com sucesso!');
                            }, 1000);
                        } else if (data.status === 'partial') {
                            // FFmpeg n√£o dispon√≠vel - mostrar partes separadas
                            clearInterval(ttsPollInterval);
                            ttsPollInterval = null;
                            
                            // Garantir 100% antes de fechar
                            document.getElementById('tts-progress-percentage').textContent = '100%';
                            document.getElementById('tts-progress-bar').style.width = '100%';
                            document.getElementById('tts-progress-status').textContent = 'Partes geradas!';
                            document.getElementById('tts-progress-details').textContent = data.message || 'Partes geradas (FFmpeg n√£o dispon√≠vel)';
                            
                            // Aguardar um pouco antes de fechar o modal
                            setTimeout(() => {
                                document.getElementById('tts-progress-modal').classList.add('hidden');
                                
                                // Mostrar modal de partes
                                if (data.partDownloads && data.partDownloads.length > 0) {
                                    const partsList = document.getElementById('tts-parts-list');
                                    if (partsList) {
                                        partsList.innerHTML = '';
                                        data.partDownloads.forEach((part) => {
                                            const partDiv = document.createElement('div');
                                            partDiv.className = 'bg-gray-800/50 border border-gray-700 rounded-lg p-4 flex items-center justify-between';
                                            partDiv.innerHTML = `
                                                <div class="flex items-center gap-3">
                                                    <i data-lucide="file-audio" class="w-6 h-6 text-amber-400"></i>
                                                    <div>
                                                        <p class="text-white font-medium">Parte ${part.part}</p>
                                                        <p class="text-gray-400 text-xs">${part.filename}</p>
                                                    </div>
                                                </div>
                                                <a href="${part.downloadUrl}" download="${part.filename}" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition duration-200 text-sm">
                                                    Baixar
                                                </a>
                                            `;
                                            partsList.appendChild(partDiv);
                                        });
                                        // Re-inicializar √≠cones Lucide
                                        if (typeof lucide !== 'undefined') {
                                            lucide.createIcons();
                                        }
                                    }
                                    document.getElementById('tts-parts-modal').classList.remove('hidden');
                                    showMessage('tts-success-message', `${data.partDownloads.length} parte(s) gerada(s) com sucesso!`, false);
                                } else {
                                    showMessage('tts-error-message', data.message || 'Partes geradas mas n√£o foi poss√≠vel preparar downloads.', true);
                                }
                            }, 1000);
                        } else if (data.status === 'failed') {
                            clearInterval(ttsPollInterval);
                            ttsPollInterval = null;
                            document.getElementById('tts-progress-modal').classList.add('hidden');
                            showMessage('tts-error-message', data.message || 'Erro ao gerar narra√ß√£o.', true);
                        } else if (data.status === 'processing' || data.status === 'queued') {
                            // Continuar atualizando o progresso
                            // O progresso j√° foi atualizado acima
                        }
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }
            
            // Reset
            document.getElementById('tts-reset-btn')?.addEventListener('click', () => {
                document.getElementById('tts-script-input').value = '';
                document.getElementById('tts-voice-select').value = '';
                document.getElementById('tts-style-instructions').value = '';
                document.getElementById('tts-preview-player').style.display = 'none';
                document.getElementById('tts-char-count').textContent = '';
                document.getElementById('tts-duration-hint').textContent = 'Adicione o roteiro para calcular a dura√ß√£o.';
            });
            
            // Importar √∫ltimo roteiro
            document.getElementById('tts-import-last-script')?.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/scripts/last`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.script) {
                            document.getElementById('tts-script-input').value = data.script;
                            showMessage('tts-success-message', 'Roteiro importado com sucesso!');
                        } else {
                            showMessage('tts-error-message', 'Nenhum roteiro encontrado.');
                        }
                    }
                } catch (error) {
                    showMessage('tts-error-message', 'Erro ao importar roteiro.');
                }
            });
            
            // Calcular dura√ß√£o e caracteres
            document.getElementById('tts-script-input')?.addEventListener('input', (e) => {
                const text = e.target.value;
                const charCount = text.length;
                const wordCount = text.trim().split(/\s+/).filter(w => w).length;
                const estimatedDuration = Math.ceil(wordCount / 150); // 150 palavras por minuto
                
                document.getElementById('tts-char-count').textContent = `${charCount} caracteres`;
                if (wordCount > 0) {
                    document.getElementById('tts-duration-hint').textContent = `Dura√ß√£o estimada: ~${estimatedDuration} minuto(s)`;
                } else {
                    document.getElementById('tts-duration-hint').textContent = 'Adicione o roteiro para calcular a dura√ß√£o.';
                }
            });
            
            // Fechar modais
            document.getElementById('tts-close-modal-btn')?.addEventListener('click', () => {
                document.getElementById('tts-complete-modal').classList.add('hidden');
            });
            
            document.getElementById('tts-parts-close-btn')?.addEventListener('click', () => {
                document.getElementById('tts-parts-modal').classList.add('hidden');
            });
            
            // Carregar vozes quando o provedor mudar
            document.getElementById('tts-provider-select')?.addEventListener('change', () => {
                loadTtsVoices();
                toggleDarkVozControls();
            });
            
            // Mostrar/ocultar controles do DarkVoz baseado no provedor
            function toggleDarkVozControls() {
                const providerSelect = document.getElementById('tts-provider-select');
                const darkVozControls = document.getElementById('darkvoz-controls');
                if (providerSelect && darkVozControls) {
                    if (providerSelect.value === 'laozhang') {
                        darkVozControls.style.display = 'block';
                    } else {
                        darkVozControls.style.display = 'none';
                    }
                }
            }
            
            // Inicializar controles do DarkVoz
            toggleDarkVozControls();
            
            // Carregar vozes quando a view √© exibida
            const viewLinks = document.querySelectorAll('a[data-view]');
            viewLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const viewName = link.getAttribute('data-view');
                    if (viewName === 'gerador-voz') {
                        setTimeout(() => {
                            loadTtsVoices();
                        }, 100);
                    }
                    if (viewName === 'gerador-video') {
                        console.log('[Dashboard] Navegando para gerador de v√≠deo, inicializando...');
                        // Aguardar um pouco para garantir que o DOM est√° pronto
                        setTimeout(() => {
                            initVideoGenerator();
                        }, 200);
                    }
                    if (viewName === 'imagens-lote') {
                        setTimeout(() => {
                            setupBatchTxtUpload();
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }, 100);
                    }
                });
            });

            // === GERADOR DE V√çDEO ===
            let currentVideoOperationId = null;
            let currentVideoBlob = null;
            let currentVideoUri = null;
            let currentVideoConfig = null;
            let videoPollInterval = null;

            // Estado do gerador de v√≠deo
            const videoState = {
                mode: 'text-to-video',
                startFrame: null,
                endFrame: null,
                referenceImages: [],
                inputVideo: null,
                isLooping: false
            };

            // Fun√ß√£o para converter arquivo para base64
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve({
                            base64: base64,
                            mimeType: file.type,
                            file: file
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // Inicializar gerador de v√≠deo
            window.initVideoGenerator = function() {
                console.log('[Video Generator] ========== INICIANDO GERADOR DE V√çDEO ==========');
                
                // Verificar se a view est√° vis√≠vel
                const viewElement = document.getElementById('view-gerador-video');
                if (!viewElement) {
                    console.error('[Video Generator] ‚ùå View n√£o encontrada!');
                    return;
                }
                
                console.log('[Video Generator] View encontrada, display:', viewElement.style.display);
                
                // Aguardar um pouco para garantir que os elementos est√£o no DOM
                setTimeout(() => {
                    // Verificar elementos cr√≠ticos antes de inicializar
                    const generateBtn = document.getElementById('video-generate-btn');
                    const settingsToggle = document.getElementById('video-settings-toggle');
                    const modelSelect = document.getElementById('video-model-select');
                    const promptInput = document.getElementById('video-prompt-input');
                    const settingsPanel = document.getElementById('video-settings-panel');
                    
                    console.log('[Video Generator] Verificando elementos:', {
                        view: !!viewElement,
                        viewDisplay: viewElement.style.display,
                        generateBtn: !!generateBtn,
                        generateBtnId: generateBtn?.id,
                        settingsToggle: !!settingsToggle,
                        settingsToggleId: settingsToggle?.id,
                        modelSelect: !!modelSelect,
                        modelSelectId: modelSelect?.id,
                        promptInput: !!promptInput,
                        settingsPanel: !!settingsPanel
                    });
                    
                    if (!generateBtn) {
                        console.error('[Video Generator] ‚ùå Bot√£o Gerar V√≠deo n√£o encontrado!');
                    }
                    if (!settingsToggle) {
                        console.error('[Video Generator] ‚ùå Toggle de configura√ß√µes n√£o encontrado!');
                    }
                    if (!modelSelect) {
                        console.error('[Video Generator] ‚ùå Select de modelo n√£o encontrado!');
                    }
                    
                    if (!generateBtn || !settingsToggle || !modelSelect) {
                        console.error('[Video Generator] ‚ùå Elementos cr√≠ticos n√£o encontrados! Tentando novamente em 500ms...');
                        setTimeout(() => initVideoGenerator(), 500);
                        return;
                    }
                    
                    // Atualizar UI baseado no modo
                    updateVideoModeUI();
                    
                    // Event listeners
                    setupVideoEventListeners();
                    
                    console.log('[Video Generator] ‚úÖ‚úÖ‚úÖ GERADOR DE V√çDEO INICIALIZADO COM SUCESSO ‚úÖ‚úÖ‚úÖ');
                }, 300);
            }

            function updateVideoModeUI() {
                // Modo fixo: text-to-video
                const mode = 'text-to-video';
                const mediaUploads = document.getElementById('video-media-uploads');
                const framesSection = document.getElementById('frames-upload-section');
                const referencesSection = document.getElementById('references-upload-section');
                const extendSection = document.getElementById('extend-video-section');
                const aspectRatioSelect = document.getElementById('video-aspect-ratio-select');
                const resolutionSelect = document.getElementById('video-resolution-select');
                const modelSelect = document.getElementById('video-model-select');

                // Esconder todas as se√ß√µes de upload
                if (framesSection) framesSection.classList.add('hidden');
                if (referencesSection) referencesSection.classList.add('hidden');
                if (extendSection) extendSection.classList.add('hidden');
                if (mediaUploads) mediaUploads.classList.add('hidden');

                // Text-to-video: habilitar propor√ß√£o, resolu√ß√£o e modelo
                if (aspectRatioSelect) {
                    aspectRatioSelect.disabled = false;
                    aspectRatioSelect.removeAttribute('readonly');
                }
                if (resolutionSelect) {
                    resolutionSelect.disabled = false;
                    resolutionSelect.removeAttribute('readonly');
                }
                if (modelSelect) {
                    modelSelect.disabled = false;
                    modelSelect.removeAttribute('readonly');
                }

                videoState.mode = mode;
                console.log('[Video Generator] UI atualizada - modo:', mode);
            }

            function setupVideoEventListeners() {
                console.log('[Video Generator] Configurando event listeners...');
                
                // Modo fixo, n√£o precisa de listener
                // document.getElementById('video-mode-select')?.addEventListener('change', updateVideoModeUI);

                // Toggle de configura√ß√µes
                const settingsToggle = document.getElementById('video-settings-toggle');
                if (settingsToggle) {
                    // Remover listeners anteriores
                    const newToggle = settingsToggle.cloneNode(true);
                    settingsToggle.parentNode.replaceChild(newToggle, settingsToggle);
                    
                    newToggle.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Video Generator] ‚öôÔ∏è Toggle de configura√ß√µes clicado');
                        const panel = document.getElementById('video-settings-panel');
                        const toggleBtn = document.getElementById('video-settings-toggle');
                        const icon = toggleBtn?.querySelector('i');
                        if (panel) {
                            const isHidden = panel.classList.contains('hidden');
                            panel.classList.toggle('hidden');
                            console.log('[Video Generator] Painel de configura√ß√µes:', isHidden ? 'expandido' : 'oculto');
                            if (icon) {
                                if (panel.classList.contains('hidden')) {
                                    icon.setAttribute('data-lucide', 'chevron-down');
                                } else {
                                    icon.setAttribute('data-lucide', 'chevron-up');
                                }
                                if (typeof lucide !== 'undefined') lucide.createIcons();
                            }
                        } else {
                            console.error('[Video Generator] ‚ùå Painel de configura√ß√µes n√£o encontrado!');
                        }
                    };
                    console.log('[Video Generator] ‚úÖ Toggle de configura√ß√µes configurado');
                } else {
                    console.error('[Video Generator] ‚ùå Bot√£o de configura√ß√µes n√£o encontrado!');
                }

                // Upload de frame inicial
                document.getElementById('video-start-frame-btn')?.addEventListener('click', () => {
                    document.getElementById('video-start-frame').click();
                });
                document.getElementById('video-start-frame')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const base64Data = await fileToBase64(file);
                        videoState.startFrame = base64Data;
                        document.getElementById('video-start-frame-img').src = URL.createObjectURL(file);
                        document.getElementById('video-start-frame-preview').classList.remove('hidden');
                        document.getElementById('video-start-frame-btn').classList.add('hidden');
                    }
                });
                document.getElementById('video-start-frame-remove')?.addEventListener('click', () => {
                    videoState.startFrame = null;
                    document.getElementById('video-start-frame').value = '';
                    document.getElementById('video-start-frame-preview').classList.add('hidden');
                    document.getElementById('video-start-frame-btn').classList.remove('hidden');
                });

                // Upload de frame final
                document.getElementById('video-end-frame-btn')?.addEventListener('click', () => {
                    document.getElementById('video-end-frame').click();
                });
                document.getElementById('video-end-frame')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const base64Data = await fileToBase64(file);
                        videoState.endFrame = base64Data;
                        document.getElementById('video-end-frame-img').src = URL.createObjectURL(file);
                        document.getElementById('video-end-frame-preview').classList.remove('hidden');
                        document.getElementById('video-end-frame-btn').classList.add('hidden');
                    }
                });
                document.getElementById('video-end-frame-remove')?.addEventListener('click', () => {
                    videoState.endFrame = null;
                    document.getElementById('video-end-frame').value = '';
                    document.getElementById('video-end-frame-preview').classList.add('hidden');
                    document.getElementById('video-end-frame-btn').classList.remove('hidden');
                });

                // Checkbox de loop
                document.getElementById('video-loop-checkbox')?.addEventListener('change', (e) => {
                    videoState.isLooping = e.target.checked;
                });

                // Upload de refer√™ncias
                document.getElementById('video-add-reference-btn')?.addEventListener('click', () => {
                    document.getElementById('video-reference-input').click();
                });
                document.getElementById('video-reference-input')?.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length + videoState.referenceImages.length > 3) {
                        showMessage('video-error-message', 'M√°ximo de 3 imagens de refer√™ncia.', true);
                        return;
                    }
                    for (const file of files) {
                        const base64Data = await fileToBase64(file);
                        videoState.referenceImages.push(base64Data);
                        addReferenceImagePreview(base64Data, file);
                    }
                    e.target.value = '';
                });

                // Upload de v√≠deo de entrada (extend)
                document.getElementById('video-input-video-btn')?.addEventListener('click', () => {
                    document.getElementById('video-input-video').click();
                });
                document.getElementById('video-input-video')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const base64Data = await fileToBase64(file);
                        videoState.inputVideo = base64Data;
                        const preview = document.getElementById('video-input-video-preview-player');
                        preview.src = URL.createObjectURL(file);
                        document.getElementById('video-input-video-preview').classList.remove('hidden');
                        document.getElementById('video-input-video-btn').classList.add('hidden');
                    }
                });
                document.getElementById('video-input-video-remove')?.addEventListener('click', () => {
                    videoState.inputVideo = null;
                    document.getElementById('video-input-video').value = '';
                    document.getElementById('video-input-video-preview').classList.add('hidden');
                    document.getElementById('video-input-video-btn').classList.remove('hidden');
                });

                // Bot√£o gerar
                const generateBtn = document.getElementById('video-generate-btn');
                if (generateBtn) {
                    // Remover listeners anteriores
                    const newGenerateBtn = generateBtn.cloneNode(true);
                    generateBtn.parentNode.replaceChild(newGenerateBtn, generateBtn);
                    
                    newGenerateBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Video Generator] üé¨ Bot√£o Gerar V√≠deo clicado');
                        if (typeof handleVideoGenerate === 'function') {
                            handleVideoGenerate();
                        } else {
                            console.error('[Video Generator] ‚ùå Fun√ß√£o handleVideoGenerate n√£o encontrada!');
                        }
                    };
                    console.log('[Video Generator] ‚úÖ Bot√£o Gerar V√≠deo configurado');
                } else {
                    console.error('[Video Generator] ‚ùå Bot√£o Gerar V√≠deo n√£o encontrado!');
                }

                // Bot√£o reset
                const resetBtn = document.getElementById('video-reset-btn');
                if (resetBtn) {
                    // Remover listeners anteriores
                    const newResetBtn = resetBtn.cloneNode(true);
                    resetBtn.parentNode.replaceChild(newResetBtn, resetBtn);
                    
                    newResetBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Video Generator] üóëÔ∏è Bot√£o Limpar Tudo clicado');
                        if (typeof resetVideoGenerator === 'function') {
                            resetVideoGenerator();
                        } else {
                            console.error('[Video Generator] ‚ùå Fun√ß√£o resetVideoGenerator n√£o encontrada!');
                        }
                    };
                    console.log('[Video Generator] ‚úÖ Bot√£o Limpar Tudo configurado');
                } else {
                    console.warn('[Video Generator] ‚ö†Ô∏è Bot√£o Limpar Tudo n√£o encontrado');
                }

                // Bot√µes de resultado
                document.getElementById('video-retry-btn')?.addEventListener('click', () => {
                    if (currentVideoConfig) {
                        handleVideoGenerate(currentVideoConfig);
                    }
                });
                document.getElementById('video-new-btn')?.addEventListener('click', resetVideoGenerator);
                document.getElementById('video-extend-btn')?.addEventListener('click', handleVideoExtend);
            }

            function addReferenceImagePreview(imageData, file) {
                const container = document.getElementById('video-reference-images');
                const preview = document.createElement('div');
                preview.className = 'relative w-32 h-32 group';
                preview.innerHTML = `
                    <img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover rounded-lg">
                    <button type="button" class="video-remove-reference absolute top-1 right-1 p-1 bg-red-600 rounded-full text-white opacity-0 group-hover:opacity-100 transition">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                const removeBtn = preview.querySelector('.video-remove-reference');
                removeBtn.addEventListener('click', () => {
                    const index = Array.from(container.children).indexOf(preview) - 1;
                    videoState.referenceImages.splice(index, 1);
                    preview.remove();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
                container.insertBefore(preview, container.lastElementChild);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // Esconder bot√£o de adicionar se j√° tem 3
                if (videoState.referenceImages.length >= 3) {
                    document.getElementById('video-add-reference-btn').classList.add('hidden');
                }
            }

            async function handleVideoGenerate(config = null) {
                // Sempre pegar valores atuais do formul√°rio
                const promptInput = document.getElementById('video-prompt-input');
                const prompt = promptInput ? promptInput.value.trim() : '';
                const mode = 'text-to-video'; // Modo fixo
                const model = document.getElementById('video-model-select').value;
                const aspectRatio = document.getElementById('video-aspect-ratio-select').value;
                const resolution = document.getElementById('video-resolution-select').value;

                console.log('[Frontend] Valores capturados:', { prompt: prompt ? `"${prompt.substring(0, 50)}..."` : 'VAZIO', mode, model, aspectRatio, resolution });

                // Valida√ß√µes - apenas text-to-video
                if (!prompt) {
                    showMessage('video-error-message', 'Por favor, descreva o v√≠deo que deseja criar.', true);
                    return;
                }

                // Sempre usar valores atuais do formul√°rio, n√£o o config passado
                currentVideoConfig = {
                    prompt: prompt || (config?.prompt || ''), // Usar prompt atual ou do config
                    model: model || config?.model || 'veo-3.1-fast',
                    aspectRatio: aspectRatio || config?.aspectRatio || '16:9',
                    resolution: resolution || config?.resolution || '720p',
                    mode: 'text-to-video', // Modo fixo
                    startFrame: null,
                    endFrame: null,
                    referenceImages: [],
                    inputVideo: null,
                    isLooping: false
                };

                console.log('[Frontend] Config final sendo enviado:', {
                    prompt: currentVideoConfig.prompt ? `"${currentVideoConfig.prompt.substring(0, 50)}..."` : 'VAZIO',
                    model: currentVideoConfig.model,
                    mode: currentVideoConfig.mode
                });

                // Mostrar modal de progresso
                const progressModal = document.getElementById('video-progress-modal');
                const progressStatus = document.getElementById('video-progress-status');
                const progressBar = document.getElementById('video-progress-bar');
                const progressPercentage = document.getElementById('video-progress-percentage');
                
                progressModal.classList.remove('hidden');
                if (progressStatus) progressStatus.textContent = 'Iniciando gera√ß√£o...';
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.classList.add('animate-pulse');
                }
                if (progressPercentage) progressPercentage.textContent = '0%';

                try {
                    const response = await fetch(`${API_BASE}/api/video/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(currentVideoConfig)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao iniciar gera√ß√£o');
                    }

                    const data = await response.json();
                    
                    // Se o v√≠deo j√° estiver pronto (resposta direta da Laozhang.ai)
                    if (data.status === 'completed' && data.videoUri) {
                        console.log('[Frontend] ‚úÖ V√≠deo recebido diretamente na resposta:', data.videoUri);
                        currentVideoOperationId = data.operationId || `direct-${Date.now()}`;
                        currentVideoUri = data.videoUri;
                        
                        // Exibir v√≠deo diretamente
                        displayVideoResult(data.videoUri);
                        return;
                    }
                    
                    currentVideoOperationId = data.operationId;

                    // Iniciar polling com intervalo menor para atualiza√ß√£o em tempo real
                    if (videoPollInterval) clearInterval(videoPollInterval);
                    // Polling a cada 1 segundo para atualiza√ß√£o mais r√°pida do progresso
                    pollVideoStatus(); // Primeira verifica√ß√£o imediata
                    videoPollInterval = setInterval(pollVideoStatus, 1000);

                } catch (error) {
                    console.error('Erro ao gerar v√≠deo:', error);
                    showMessage('video-error-message', error.message || 'Erro ao gerar v√≠deo.', true);
                    document.getElementById('video-progress-modal').classList.add('hidden');
                }
            }

            async function pollVideoStatus() {
                if (!currentVideoOperationId) return;

                try {
                    // Codificar o operationId para lidar com barras e caracteres especiais
                    const encodedOperationId = encodeURIComponent(currentVideoOperationId);
                    const response = await fetch(`${API_BASE}/api/video/status/${encodedOperationId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Erro ao verificar status');
                    }

                    const data = await response.json();
                    
                    console.log('[Frontend] Status recebido:', data.status, {
                        hasVideoUri: !!data.videoUri,
                        hasVideoBase64: !!data.videoBase64,
                        videoUri: data.videoUri ? data.videoUri.substring(0, 100) : null
                    });

                    if (data.status === 'completed') {
                        // V√≠deo pronto!
                        clearInterval(videoPollInterval);
                        videoPollInterval = null;

                        // Salvar URI do v√≠deo para poss√≠vel extens√£o
                        currentVideoUri = data.videoUri;

                        // Se tiver base64, usar para exibi√ß√£o
                        if (data.videoBase64) {
                            const videoBlob = base64ToBlob(data.videoBase64, data.videoMimeType || 'video/mp4');
                            currentVideoBlob = videoBlob;

                            const videoUrl = URL.createObjectURL(videoBlob);
                            document.getElementById('video-result-player').src = videoUrl;
                            document.getElementById('video-download-link').href = videoUrl;
                            document.getElementById('video-download-link').download = `video-${Date.now()}.mp4`;
                        } else if (data.videoUri) {
                            // Se n√£o tiver base64 mas tiver URI, usar diretamente
                            // URLs da Laozhang.ai (aliyuncs.com) podem ser usadas diretamente
                            console.log('[Frontend] Usando v√≠deo URI diretamente:', data.videoUri);
                            displayVideoResult(data.videoUri);
                        }

                        // Atualizar barra de progresso para 100%
                        const progressBar = document.getElementById('video-progress-bar');
                        const progressPercentage = document.getElementById('video-progress-percentage');
                        if (progressBar) {
                            progressBar.style.width = '100%';
                            progressBar.style.animation = 'none';
                        }
                        if (progressPercentage) {
                            progressPercentage.textContent = '100%';
                        }

                        document.getElementById('video-progress-modal').classList.add('hidden');
                        document.getElementById('video-result-section').classList.remove('hidden');
                        document.getElementById('video-extend-btn').style.display = 
                            currentVideoConfig.resolution === '720p' ? 'inline-flex' : 'none';

                        showMessage('video-success-message', 'V√≠deo gerado com sucesso!');
                    } else if (data.status === 'error') {
                        clearInterval(videoPollInterval);
                        videoPollInterval = null;
                        document.getElementById('video-progress-modal').classList.add('hidden');
                        showMessage('video-error-message', data.error || 'Erro ao gerar v√≠deo.', true);
                    } else {
                        // Ainda processando - atualizar com progresso se dispon√≠vel
                        const progressStatus = document.getElementById('video-progress-status');
                        const progressBar = document.getElementById('video-progress-bar');
                        const progressDetails = document.getElementById('video-progress-details');
                        
                        if (data.progress !== undefined && data.progress !== null) {
                            const progressPercent = Math.min(100, Math.max(0, parseFloat(data.progress)));
                            const progressText = data.progressMessage || `Gerando v√≠deo... ${progressPercent.toFixed(1)}%`;
                            
                            // Atualizar texto de status
                            if (progressStatus) {
                                progressStatus.textContent = progressText;
                            }
                            
                            // Atualizar barra de progresso com gradiente laranja
                            if (progressBar) {
                                progressBar.style.width = `${progressPercent}%`;
                                progressBar.style.transition = 'width 0.5s ease-out';
                                // Remover anima√ß√£o de pulse quando h√° progresso real
                                progressBar.classList.remove('animate-pulse');
                                // Gradiente laranja conforme a porcentagem
                                progressBar.style.background = `linear-gradient(to right, #f59e0b, #fb923c, #f97316)`;
                                progressBar.style.backgroundSize = '200% 100%';
                                // Adicionar anima√ß√£o de gradiente se progresso > 0
                                if (progressPercent > 0 && progressPercent < 100) {
                                    progressBar.style.animation = 'gradient-shift 2s ease infinite';
                                } else {
                                    progressBar.style.animation = 'none';
                                }
                                console.log('[Video Generator] üìä Progresso atualizado:', progressPercent.toFixed(1) + '%');
                            }
                            
                            // Atualizar porcentagem no centro da barra
                            const progressPercentage = document.getElementById('video-progress-percentage');
                            if (progressPercentage) {
                                progressPercentage.textContent = `${progressPercent.toFixed(1)}%`;
                                // Destacar quando pr√≥ximo de 100%
                                if (progressPercent >= 95) {
                                    progressPercentage.classList.add('text-green-400', 'font-bold');
                                } else {
                                    progressPercentage.classList.remove('text-green-400', 'font-bold');
                                }
                            }
                            
                            // Atualizar detalhes
                            if (progressDetails) {
                                progressDetails.textContent = `${progressPercent.toFixed(1)}% conclu√≠do...`;
                            }
                        } else {
                            // Sem progresso espec√≠fico, usar mensagem gen√©rica
                            if (progressStatus) {
                                progressStatus.textContent = 'Gerando v√≠deo... Isso pode levar alguns minutos.';
                            }
                            if (progressBar) {
                                progressBar.style.width = '100%';
                            }
                            if (progressDetails) {
                                progressDetails.textContent = 'Processando...';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }

            function base64ToBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            }

            function displayVideoResult(videoUri) {
                console.log('[Frontend] Exibindo v√≠deo:', videoUri);
                
                // Verificar se os elementos existem
                const videoPlayer = document.getElementById('video-result-player');
                const videoDownloadLink = document.getElementById('video-download-link');
                const videoResultSection = document.getElementById('video-result-section');
                const videoProgressModal = document.getElementById('video-progress-modal');
                
                if (!videoPlayer || !videoDownloadLink || !videoResultSection) {
                    console.error('[Frontend] Elementos do v√≠deo n√£o encontrados!');
                    return;
                }
                
                // URLs da Laozhang.ai (aliyuncs.com) podem ser usadas diretamente
                // N√£o precisamos baixar via backend
                videoPlayer.src = videoUri;
                videoDownloadLink.href = videoUri;
                videoDownloadLink.download = `video-${Date.now()}.mp4`;
                
                // Salvar URI para poss√≠vel extens√£o
                currentVideoUri = videoUri;
                
                // Esconder modal de progresso e mostrar resultado
                if (videoProgressModal) {
                    videoProgressModal.classList.add('hidden');
                }
                videoResultSection.classList.remove('hidden');
                
                // Ajustar bot√£o de estender baseado na resolu√ß√£o
                const videoExtendBtn = document.getElementById('video-extend-btn');
                if (videoExtendBtn && currentVideoConfig) {
                    videoExtendBtn.style.display = 
                        currentVideoConfig.resolution === '720p' ? 'inline-flex' : 'none';
                }
                
                // Mostrar mensagem de sucesso
                showMessage('video-success-message', 'V√≠deo gerado com sucesso!');
                
                // Parar polling se estiver ativo
                if (videoPollInterval) {
                    clearInterval(videoPollInterval);
                    videoPollInterval = null;
                }
                
                console.log('[Frontend] ‚úÖ V√≠deo exibido com sucesso!');
            }

            async function handleVideoExtend() {
                if (!currentVideoUri) {
                    showMessage('video-error-message', 'Nenhum v√≠deo dispon√≠vel para estender. Voc√™ precisa ter gerado um v√≠deo anteriormente.', true);
                    return;
                }

                console.log('[Frontend] Preparando para estender v√≠deo:', currentVideoUri);

                // Mudar modo para extend-video
                videoState.mode = 'extend-video';
                // Modo fixo: text-to-video (n√£o suporta extend-video)
                // Sugerir prompt que enfatiza continuar o v√≠deo
                document.getElementById('video-prompt-input').value = 'Continue o v√≠deo de forma natural e fluida, mantendo a mesma cena, personagens e estilo visual.';
                document.getElementById('video-prompt-input').placeholder = 'Descreva a continua√ß√£o natural do v√≠deo (opcional - deixe vazio para continua√ß√£o autom√°tica)...';
                updateVideoModeUI();
                
                // Configurar v√≠deo de entrada usando URI diretamente
                // O backend ir√° processar o v√≠deo e extrair o √∫ltimo frame se necess√°rio
                videoState.inputVideo = {
                    uri: currentVideoUri
                };

                console.log('[Frontend] V√≠deo de entrada configurado com URI:', currentVideoUri);

                // Mostrar preview do v√≠deo usando URI diretamente
                // N√£o tentamos baixar o v√≠deo no frontend devido a CORS
                    const preview = document.getElementById('video-input-video-preview-player');
                const previewContainer = document.getElementById('video-input-video-preview');
                const uploadBtn = document.getElementById('video-input-video-btn');
                
                if (preview && currentVideoUri) {
                    // Tentar usar blob local primeiro (sem problemas de CORS)
                    if (currentVideoBlob) {
                    preview.src = URL.createObjectURL(currentVideoBlob);
                        previewContainer.classList.remove('hidden');
                        uploadBtn.classList.add('hidden');
                    } else if (currentVideoUri) {
                        // Tentar usar URI diretamente - pode falhar por CORS, mas n√£o √© cr√≠tico
                        // O importante √© que o backend receber√° o URI corretamente
                        preview.src = currentVideoUri;
                        preview.crossOrigin = 'anonymous';
                        previewContainer.classList.remove('hidden');
                        uploadBtn.classList.add('hidden');
                        
                        // Se houver erro de CORS, n√£o √© cr√≠tico - o backend processar√° o v√≠deo
                        preview.onerror = () => {
                            console.warn('[Frontend] Erro ao carregar preview (CORS), mas o v√≠deo ser√° processado pelo backend');
                            // Mostrar mensagem informativa
                            const errorMsg = document.createElement('div');
                            errorMsg.className = 'text-yellow-500 text-sm mt-2';
                            errorMsg.textContent = 'Preview n√£o dispon√≠vel (CORS), mas o v√≠deo ser√° processado corretamente pelo backend.';
                            previewContainer.appendChild(errorMsg);
                        };
                    }
                }

                // Esconder se√ß√£o de resultado e mostrar formul√°rio
                document.getElementById('video-result-section').classList.add('hidden');
                
                // Scroll para o topo do formul√°rio
                const videoSection = document.getElementById('view-video-generator');
                if (videoSection) {
                    videoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                showMessage('video-success-message', 'V√≠deo carregado! Digite a descri√ß√£o da continua√ß√£o e clique em "Gerar V√≠deo". O √∫ltimo frame ser√° extra√≠do automaticamente pelo backend.');
            }

            // Fun√ß√£o para extrair o √∫ltimo frame de um v√≠deo
            function extractLastFrameFromVideo(videoBlob) {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.muted = true;
                    video.playsInline = true;

                    video.onloadedmetadata = () => {
                        // Ir para o √∫ltimo frame (99% do v√≠deo para garantir que pegamos o √∫ltimo frame vis√≠vel)
                        video.currentTime = Math.max(0, video.duration * 0.99);
                    };

                    video.onseeked = () => {
                        try {
                            // Criar canvas para capturar o frame
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                            // Converter para base64
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    // Converter blob para base64
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                        const base64 = reader.result.split(',')[1];
                                        resolve(base64);
                                    };
                                    reader.onerror = reject;
                                    reader.readAsDataURL(blob);
                                } else {
                                    reject(new Error('N√£o foi poss√≠vel capturar o frame'));
                                }
                            }, 'image/jpeg', 0.95);
                        } catch (error) {
                            reject(error);
                        }
                    };

                    video.onerror = (error) => {
                        reject(error);
                    };

                    video.src = URL.createObjectURL(videoBlob);
                });
            }

            function resetVideoGenerator() {
                videoState.mode = 'text-to-video';
                videoState.startFrame = null;
                videoState.endFrame = null;
                videoState.referenceImages = [];
                videoState.inputVideo = null;
                videoState.isLooping = false;
                currentVideoOperationId = null;
                currentVideoBlob = null;
                currentVideoUri = null;
                currentVideoConfig = null;

                if (videoPollInterval) {
                    clearInterval(videoPollInterval);
                    videoPollInterval = null;
                }

                // Modo fixo: text-to-video
                document.getElementById('video-prompt-input').value = '';
                document.getElementById('video-start-frame').value = '';
                document.getElementById('video-end-frame').value = '';
                document.getElementById('video-reference-input').value = '';
                document.getElementById('video-input-video').value = '';
                document.getElementById('video-loop-checkbox').checked = false;

                document.getElementById('video-start-frame-preview').classList.add('hidden');
                document.getElementById('video-start-frame-btn').classList.remove('hidden');
                document.getElementById('video-end-frame-preview').classList.add('hidden');
                document.getElementById('video-end-frame-btn').classList.remove('hidden');
                document.getElementById('video-input-video-preview').classList.add('hidden');
                document.getElementById('video-input-video-btn').classList.remove('hidden');

                const refContainer = document.getElementById('video-reference-images');
                while (refContainer.children.length > 1) {
                    refContainer.removeChild(refContainer.firstChild);
                }
                document.getElementById('video-add-reference-btn').classList.remove('hidden');

                document.getElementById('video-result-section').classList.add('hidden');
                document.getElementById('video-progress-modal').classList.add('hidden');

                updateVideoModeUI();
            }

            // ==================== FUN√á√ïES PARA AGENTES VIRAIS ====================
            let currentViralAgent = null;
            let currentViralConversation = null;
            let editingViralField = null;

            async function loadViralAgents() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao carregar agentes');

                    const data = await response.json();
                    renderViralAgents(data.agents);
                } catch (error) {
                    console.error('Erro:', error);
                    document.getElementById('viral-agents-list').innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <p class="text-red-400">Erro ao carregar agentes: ${error.message}</p>
                        </div>
                    `;
                }
            }

            function renderViralAgents(agents) {
                const container = document.getElementById('viral-agents-list');
                if (agents.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <p class="text-gray-400 mb-4">Nenhum agente criado ainda</p>
                            <button onclick="openCreateViralAgentModal()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200">
                                Criar Primeiro Agente
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = agents.map(agent => `
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 cursor-pointer hover:border-amber-500 transition" onclick="openViralAgent(${agent.id})">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white mb-1">${escapeHtml(agent.name)}</h3>
                                ${agent.description ? `<p class="text-sm text-gray-400">${escapeHtml(agent.description)}</p>` : ''}
                            </div>
                            ${agent.is_favorite ? '<i data-lucide="star" class="text-amber-500 fill-amber-500"></i>' : ''}
                        </div>
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span><i data-lucide="file-text"></i> ${agent.file_count || 0} arquivos</span>
                            <span><i data-lucide="message-square"></i> ${agent.conversation_count || 0} conversas</span>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            ${formatDate(agent.updated_at)}
                        </div>
                    </div>
                `).join('');

                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Tornar fun√ß√£o globalmente acess√≠vel
            window.openViralAgent = async function(agentId) {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${agentId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao carregar agente');

                    const data = await response.json();
                    currentViralAgent = data.agent;
                    
                    showViralAgentsDetailView();
                    loadViralAgentData();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao carregar agente');
                }
            };

            function loadViralAgentData() {
                if (!currentViralAgent) return;

                const nameHeader = document.getElementById('viral-agent-name-header');
                const descHeader = document.getElementById('viral-agent-description-header');
                const memoryEl = document.getElementById('viral-agent-memory');
                const instructionsEl = document.getElementById('viral-agent-instructions');
                
                if (nameHeader) nameHeader.textContent = currentViralAgent.name;
                if (descHeader) descHeader.textContent = currentViralAgent.description || '';
                if (memoryEl) {
                    memoryEl.textContent = currentViralAgent.memory || 'Nenhuma mem√≥ria definida';
                    // Adicionar data de atualiza√ß√£o se houver
                    const memoryUpdated = document.getElementById('viral-memory-updated');
                    if (memoryUpdated && currentViralAgent.updated_at) {
                        const daysAgo = Math.floor((new Date() - new Date(currentViralAgent.updated_at)) / (1000 * 60 * 60 * 24));
                        memoryUpdated.textContent = daysAgo === 0 ? '√öltima atualiza√ß√£o hoje' : `√öltima atualiza√ß√£o h√° ${daysAgo} ${daysAgo === 1 ? 'dia' : 'dias'}`;
                    }
                }
                if (instructionsEl) instructionsEl.textContent = currentViralAgent.instructions || 'Nenhuma instru√ß√£o definida';
                
                // Favorito
                const favoriteBtn = document.getElementById('viral-favorite-btn');
                if (favoriteBtn) {
                    const icon = favoriteBtn.querySelector('i');
                    if (icon) {
                        if (currentViralAgent.is_favorite) {
                            icon.classList.add('text-amber-500', 'fill-amber-500');
                        } else {
                            icon.classList.remove('text-amber-500', 'fill-amber-500');
                        }
                    }
                }

                // Arquivos
                renderViralFiles(currentViralAgent.files || []);
                
                // Conversas
                renderViralConversations(currentViralAgent.conversations || []);

                // Criar nova conversa se n√£o houver
                if (!currentViralConversation && (!currentViralAgent.conversations || currentViralAgent.conversations.length === 0)) {
                    createNewViralConversation();
                } else if (currentViralAgent.conversations && currentViralAgent.conversations.length > 0) {
                    currentViralConversation = currentViralAgent.conversations[0].id;
                    loadViralMessages(currentViralConversation);
                }
            }

            function renderViralFiles(files) {
                const container = document.getElementById('viral-agent-files');
                if (!container) return;
                
                if (files.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Nenhum arquivo</p>';
                    return;
                }

                container.innerHTML = files.map(file => `
                    <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-white">${escapeHtml(file.file_name)}</p>
                            <p class="text-xs text-gray-500">${file.file_size || 0} bytes</p>
                        </div>
                        <button onclick="deleteViralFile(${file.id})" class="text-red-400 hover:text-red-300">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                `).join('');

                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function renderViralConversations(conversations) {
                const container = document.getElementById('viral-conversations-list');
                if (!container) return;
                
                if (conversations.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Nenhuma conversa</p>';
                    return;
                }

                container.innerHTML = conversations.map(conv => `
                    <div class="p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition ${currentViralConversation === conv.id ? 'border border-amber-500' : ''} group relative" 
                         onclick="loadViralConversation(${conv.id})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-white">${escapeHtml(conv.title || 'Nova Conversa')}</p>
                                <p class="text-xs text-gray-500 mt-1">${formatDate(conv.updated_at)}</p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteViralConversation(${conv.id})" class="opacity-0 group-hover:opacity-100 transition-opacity p-1.5 text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded" title="Deletar conversa">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            window.deleteViralConversation = async function(conversationId) {
                if (!currentViralAgent) return;
                if (!confirm('Tem certeza que deseja deletar esta conversa?')) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations/${conversationId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao deletar conversa');
                    }

                    // Se a conversa deletada era a atual, limpar chat
                    if (currentViralConversation === conversationId) {
                        currentViralConversation = null;
                        const container = document.getElementById('viral-chat-messages');
                        if (container) container.innerHTML = '';
                    }

                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao deletar conversa: ' + error.message);
                }
            };

            // Tornar fun√ß√µes globalmente acess√≠veis
            window.showViralAgentsListView = function() {
                document.getElementById('viral-agents-list-view').style.display = 'block';
                document.getElementById('viral-agents-detail-view').style.display = 'none';
                currentViralAgent = null;
                currentViralConversation = null;
            };

            window.showViralAgentsDetailView = function() {
                document.getElementById('viral-agents-list-view').style.display = 'none';
                document.getElementById('viral-agents-detail-view').style.display = 'block';
            };

            window.showViralChatTab = function() {
                document.getElementById('viral-tab-content-chat').style.display = 'block';
                document.getElementById('viral-tab-content-conversations').style.display = 'none';
                document.getElementById('viral-tab-chat').classList.add('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-chat').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('viral-tab-conversations').classList.remove('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-conversations').classList.add('border-transparent', 'text-gray-400');
            };

            window.showViralConversationsTab = function() {
                document.getElementById('viral-tab-content-chat').style.display = 'none';
                document.getElementById('viral-tab-content-conversations').style.display = 'block';
                document.getElementById('viral-tab-conversations').classList.add('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-conversations').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('viral-tab-chat').classList.remove('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-chat').classList.add('border-transparent', 'text-gray-400');
            };

            // Tornar fun√ß√£o globalmente acess√≠vel
            window.openCreateViralAgentModal = function() {
                // Criar modal de cria√ß√£o de agente
                const modalHTML = `
                    <div id="viral-agent-create-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Novo Agente Viral</h3>
                                <button onclick="closeViralAgentCreateModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <form id="viral-agent-create-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Agente *</label>
                                    <input type="text" id="viral-agent-name-input" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ex: Agente de Hist√≥rias Emocionantes">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Descri√ß√£o</label>
                                    <input type="text" id="viral-agent-description-input" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ex: Roteiro viral para canal de hist√≥rias">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Mem√≥ria</label>
                                    <textarea id="viral-agent-memory-input" rows="4" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="Informa√ß√µes que o agente deve lembrar..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Instru√ß√µes</label>
                                    <textarea id="viral-agent-instructions-input" rows="6" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="Instru√ß√µes para o agente..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo de IA</label>
                                    <select id="viral-agent-model-input" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                        <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                    </select>
                                </div>
                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" onclick="closeViralAgentCreateModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                    <button type="submit" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Criar Agente</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Remover modal existente se houver
                const existingModal = document.getElementById('viral-agent-create-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Adicionar modal ao body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Criar √≠cones
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // Adicionar event listener ao formul√°rio
                document.getElementById('viral-agent-create-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveViralAgent();
                });
            };
            
            window.closeViralAgentCreateModal = function() {
                const modal = document.getElementById('viral-agent-create-modal');
                if (modal) {
                    modal.remove();
                }
            };
            
            async function saveViralAgent() {
                const name = document.getElementById('viral-agent-name-input').value.trim();
                if (!name) {
                    alert('Nome do agente √© obrigat√≥rio');
                    return;
                }

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            description: document.getElementById('viral-agent-description-input').value.trim(),
                            memory: document.getElementById('viral-agent-memory-input').value.trim(),
                            instructions: document.getElementById('viral-agent-instructions-input').value.trim(),
                            model: document.getElementById('viral-agent-model-input').value
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao criar agente');
                    }

                    closeViralAgentCreateModal();
                    loadViralAgents();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao criar agente: ' + error.message);
                }
            }

            window.openEditViralAgentModal = function() {
                if (!currentViralAgent) return;
                
                const modalHTML = `
                    <div id="viral-edit-agent-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Editar Agente</h3>
                                <button onclick="closeViralEditAgentModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <form id="viral-edit-agent-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Agente *</label>
                                    <input type="text" id="viral-edit-agent-name" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" value="${escapeHtml(currentViralAgent.name)}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Descri√ß√£o</label>
                                    <input type="text" id="viral-edit-agent-description" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" value="${escapeHtml(currentViralAgent.description || '')}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo de IA</label>
                                    <select id="viral-edit-agent-model" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="gpt-4o" ${currentViralAgent.model === 'gpt-4o' ? 'selected' : ''}>GPT-4o (2025)</option>
                                        <option value="claude-3-7-sonnet-20250219" ${currentViralAgent.model === 'claude-3-7-sonnet-20250219' ? 'selected' : ''}>Claude 3.7 Sonnet (Fev/25)</option>
                                        <option value="gemini-2.5-pro" ${currentViralAgent.model === 'gemini-2.5-pro' ? 'selected' : ''}>Gemini 2.5 Pro (2025)</option>
                                    </select>
                                </div>
                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" onclick="closeViralEditAgentModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                    <button onclick="saveViralAgentEdit()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-edit-agent-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralEditAgentModal = function() {
                const modal = document.getElementById('viral-edit-agent-modal');
                if (modal) modal.remove();
            };
            
            window.saveViralAgentEdit = async function() {
                if (!currentViralAgent) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: document.getElementById('viral-edit-agent-name').value.trim(),
                            description: document.getElementById('viral-edit-agent-description').value.trim(),
                            model: document.getElementById('viral-edit-agent-model').value
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao salvar');
                    }

                    closeViralEditAgentModal();
                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao salvar: ' + error.message);
                }
            };

            window.deleteViralAgent = async function() {
                if (!currentViralAgent) return;
                const confirmed = await showCustomConfirm('Tem certeza que deseja deletar este agente?');
                if (!confirmed) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao deletar agente');

                    showViralAgentsListView();
                    loadViralAgents();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao deletar agente');
                }
            };

            window.toggleViralAgentFavorite = async function() {
                if (!currentViralAgent) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            is_favorite: !currentViralAgent.is_favorite
                        })
                    });

                    if (!response.ok) throw new Error('Erro ao atualizar favorito');

                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao atualizar favorito');
                }
            };

            window.editViralMemory = function() {
                if (!currentViralAgent) return;
                editingViralField = 'memory';
                
                const modalHTML = `
                    <div id="viral-edit-field-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Editar Mem√≥ria</h3>
                                <button onclick="closeViralEditFieldModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <textarea id="viral-edit-field-content" rows="12" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="Informa√ß√µes que o agente deve lembrar...">${escapeHtml(currentViralAgent.memory || '')}</textarea>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeViralEditFieldModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                <button onclick="saveViralField()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Salvar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-edit-field-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };

            window.editViralInstructions = function() {
                if (!currentViralAgent) return;
                editingViralField = 'instructions';
                
                const modalHTML = `
                    <div id="viral-edit-field-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Editar Instru√ß√µes</h3>
                                <button onclick="closeViralEditFieldModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <textarea id="viral-edit-field-content" rows="16" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none font-mono text-sm" placeholder="Instru√ß√µes para o agente...">${escapeHtml(currentViralAgent.instructions || '')}</textarea>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeViralEditFieldModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                <button onclick="saveViralField()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Salvar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-edit-field-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralEditFieldModal = function() {
                const modal = document.getElementById('viral-edit-field-modal');
                if (modal) modal.remove();
                editingViralField = null;
            };
            
            window.saveViralField = async function() {
                if (!currentViralAgent || !editingViralField) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const content = document.getElementById('viral-edit-field-content').value.trim();
                    
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            [editingViralField]: content
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao salvar');
                    }

                    closeViralEditFieldModal();
                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao salvar: ' + error.message);
                }
            };

            window.addViralFile = function() {
                if (!currentViralAgent) return;
                
                const modalHTML = `
                    <div id="viral-add-file-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Adicionar Arquivo</h3>
                                <button onclick="closeViralAddFileModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Arquivo *</label>
                                    <input type="text" id="viral-file-name-input" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ex: exemplo.txt">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Conte√∫do *</label>
                                    <textarea id="viral-file-content-input" rows="12" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none font-mono text-sm" placeholder="Cole ou digite o conte√∫do do arquivo..."></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeViralAddFileModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                <button onclick="saveViralFile()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Adicionar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-add-file-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralAddFileModal = function() {
                const modal = document.getElementById('viral-add-file-modal');
                if (modal) modal.remove();
            };
            
            window.saveViralFile = async function() {
                if (!currentViralAgent) return;

                const fileName = document.getElementById('viral-file-name-input').value.trim();
                const fileContent = document.getElementById('viral-file-content-input').value.trim();

                if (!fileName || !fileContent) {
                    alert('Nome e conte√∫do do arquivo s√£o obrigat√≥rios');
                    return;
                }

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/files`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            file_name: fileName,
                            file_content: fileContent,
                            file_type: 'text/plain',
                            file_size: fileContent.length
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao adicionar arquivo');
                    }

                    closeViralAddFileModal();
                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao adicionar arquivo: ' + error.message);
                }
            };

            window.deleteViralFile = async function(fileId) {
                if (!confirm('Tem certeza que deseja deletar este arquivo?')) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/files/${fileId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao deletar arquivo');

                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao deletar arquivo');
                }
            };

            window.createNewViralConversation = async function() {
                if (!currentViralAgent) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: 'Nova Conversa'
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao criar conversa');
                    }

                    const data = await response.json();
                    currentViralConversation = data.conversation.id;
                    await openViralAgent(currentViralAgent.id);
                    await loadViralMessages(currentViralConversation);
                    showViralChatTab();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao criar conversa: ' + error.message);
                }
            };

            window.loadViralConversation = async function(conversationId) {
                currentViralConversation = conversationId;
                await loadViralMessages(conversationId);
                showViralChatTab();
            };

            async function loadViralMessages(conversationId) {
                if (!currentViralAgent || !conversationId) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations/${conversationId}/messages`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao carregar mensagens');

                    const data = await response.json();
                    renderViralMessages(data.messages);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao carregar mensagens');
                }
            }

            // Armazenar mensagens globalmente para acesso na fun√ß√£o de copiar
            let currentViralMessages = [];
            
            function renderViralMessages(messages) {
                const container = document.getElementById('viral-chat-messages');
                if (!container) return;
                
                // Armazenar mensagens para acesso posterior
                currentViralMessages = messages;
                
                container.innerHTML = messages.map((msg, index) => `
                    <div class="p-3 rounded-lg ${msg.role === 'user' ? 'bg-amber-500/20 border border-amber-500/30 ml-auto max-w-[80%]' : 'bg-gray-800 border border-gray-700 mr-auto max-w-[80%]'} relative group">
                        <p class="text-sm text-white whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                        ${msg.role === 'assistant' ? `
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                <button onclick="copyViralMessage(${index})" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Copiar roteiro">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                                <button onclick="openViralMarkdown()" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Ver roteiro completo em MD">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                container.scrollTop = container.scrollHeight;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            window.showViralRoteiroCompleteModal = function(nota, checklist, roteiro) {
                // Definir checklist padr√£o se n√£o vier
                const checklistData = checklist || {
                    gancho_inicial: false,
                    estrutura_narrativa: false,
                    engajamento_emocional: false,
                    densidade_valor: false,
                    tecnicas_retencao: false,
                    linguagem_tom: false,
                    elementos_estruturais: false,
                    loops_abertos: false,
                    variacao_emocional: false,
                    final_satisfatorio: false
                };
                
                const checklistItems = [
                    { key: 'gancho_inicial', label: '1. GANCHO INICIAL (0-30 segundos)', desc: 'Abertura magn√©tica que cria "lacuna de curiosidade". Promessa clara do valor do v√≠deo.' },
                    { key: 'estrutura_narrativa', label: '2. ESTRUTURA NARRATIVA', desc: 'Arco dram√°tico completo, ritmo variado, transi√ß√µes fluidas.' },
                    { key: 'engajamento_emocional', label: '3. ENGAJAMENTO EMOCIONAL', desc: 'Apelo a emo√ß√µes prim√°rias, personagens identific√°veis, stakes claros.' },
                    { key: 'densidade_valor', label: '4. DENSIDADE DE VALOR', desc: 'Informa√ß√£o surpreendente a cada 30-60s, especificidade, sem enchimento.' },
                    { key: 'tecnicas_retencao', label: '5. T√âCNICAS DE RETEN√á√ÉO', desc: 'Pattern interrupts, foreshadowing, cliffhangers internos, payoff satisfat√≥rio.' },
                    { key: 'linguagem_tom', label: '6. LINGUAGEM E TOM', desc: 'Voz ativa, frases variadas, naturalidade, vocabul√°rio acess√≠vel.' },
                    { key: 'elementos_estruturais', label: '7. ELEMENTOS ESTRUTURAIS', desc: 'Dura√ß√£o otimizada, CTA org√¢nica, final memor√°vel.' },
                    { key: 'loops_abertos', label: '8. LOOPS ABERTOS', desc: 'Loops abertos sendo fechados no momento certo.' },
                    { key: 'variacao_emocional', label: '9. VARIA√á√ÉO EMOCIONAL', desc: 'A emo√ß√£o varia ao longo do roteiro.' },
                    { key: 'final_satisfatorio', label: '10. FINAL SATISFAT√ìRIO', desc: 'Todas as promessas cumpridas, final memor√°vel.' }
                ];
                
                const modalHTML = `
                    <div id="viral-roteiro-complete-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 overflow-y-auto">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-8 max-w-2xl w-full mx-4 my-8">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="check-circle" class="w-10 h-10 text-amber-500"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Roteiro Finalizado!</h3>
                                <p class="text-gray-400">Seu roteiro foi gerado com sucesso</p>
                            </div>
                            
                            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                                <div class="flex items-center justify-between mb-6">
                                    <span class="text-gray-400 text-lg">Nota do Roteiro</span>
                                    <span class="text-4xl font-bold text-amber-500">${nota || 0}/10</span>
                                </div>
                                
                                <div class="border-t border-gray-700 pt-4">
                                    <h4 class="text-white font-semibold mb-4">Checklist de Avalia√ß√£o</h4>
                                    <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${checklistItems.map(item => `
                                            <div class="flex items-start space-x-3 p-3 rounded-lg ${checklistData[item.key] ? 'bg-amber-500/10 border border-amber-500/30' : 'bg-gray-700/50 border border-gray-600/30'}">
                                                <div class="flex-shrink-0 mt-0.5">
                                                    <input type="checkbox" ${checklistData[item.key] ? 'checked' : ''} disabled class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-amber-500 focus:ring-amber-500 focus:ring-offset-gray-900 cursor-not-allowed">
                                                </div>
                                                <div class="flex-1">
                                                    <label class="text-sm font-medium text-white cursor-not-allowed">${item.label}</label>
                                                    <p class="text-xs text-gray-400 mt-1">${item.desc}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="copyViralRoteiroFromModal()" class="flex-1 px-6 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-white font-semibold transition duration-200 flex items-center justify-center space-x-2">
                                    <i data-lucide="copy" class="w-5 h-5"></i>
                                    <span>Copiar</span>
                                </button>
                                <button onclick="downloadViralRoteiro()" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 flex items-center justify-center space-x-2">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                    <span>Baixar</span>
                                </button>
                            </div>
                            
                            <button onclick="closeViralRoteiroCompleteModal()" class="w-full mt-4 px-4 py-2 text-gray-400 hover:text-white transition">
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                // Armazenar roteiro globalmente para acesso nos bot√µes
                window.currentViralRoteiro = roteiro;
                
                const existingModal = document.getElementById('viral-roteiro-complete-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralRoteiroCompleteModal = function() {
                const modal = document.getElementById('viral-roteiro-complete-modal');
                if (modal) modal.remove();
                window.currentViralRoteiro = null;
            };
            
            window.copyViralRoteiroFromModal = function() {
                if (!window.currentViralRoteiro) return;
                
                navigator.clipboard.writeText(window.currentViralRoteiro).then(() => {
                    showMessage('viral-agents-success-message', 'Roteiro copiado para a √°rea de transfer√™ncia!', false);
                    closeViralRoteiroCompleteModal();
                }).catch(err => {
                    console.error('Erro ao copiar:', err);
                    alert('Erro ao copiar roteiro');
                });
            };
            
            window.downloadViralRoteiro = function() {
                if (!window.currentViralRoteiro || !currentViralAgent || !currentViralConversation) return;
                
                // Abrir markdown em nova aba (j√° tem a funcionalidade)
                openViralMarkdown();
                closeViralRoteiroCompleteModal();
            };
            
            window.openViralMarkdown = async function() {
                if (!currentViralAgent || !currentViralConversation) return;
                try {
                    const token = localStorage.getItem('core_token');
                    const url = `${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations/${currentViralConversation}/markdown`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (!response.ok) throw new Error('Erro ao gerar documento');
                    const html = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao abrir documento: ' + error.message);
                }
            };
            
            window.copyViralMessage = function(messageIndex) {
                if (!currentViralMessages || !currentViralMessages[messageIndex]) return;
                
                const message = currentViralMessages[messageIndex];
                if (message.role !== 'assistant') return;
                
                const messageText = message.content;
                
                // Copiar para clipboard
                navigator.clipboard.writeText(messageText).then(() => {
                    // Mostrar feedback visual
                    const container = document.getElementById('viral-chat-messages');
                    if (container) {
                        const messages = container.querySelectorAll('.bg-gray-800');
                        if (messages[messageIndex]) {
                            const button = messages[messageIndex].querySelector('button');
                            if (button) {
                                const icon = button.querySelector('i');
                                if (icon) {
                                    icon.setAttribute('data-lucide', 'check');
                                    lucide.createIcons();
                                    setTimeout(() => {
                                        icon.setAttribute('data-lucide', 'copy');
                                        lucide.createIcons();
                                    }, 2000);
                                }
                            }
                        }
                    }
                    
                    // Mostrar notifica√ß√£o
                    showMessage('viral-agents-success-message', 'Roteiro copiado para a √°rea de transfer√™ncia!', false);
                }).catch(err => {
                    console.error('Erro ao copiar:', err);
                    // Fallback para navegadores mais antigos
                    const textArea = document.createElement('textarea');
                    textArea.value = messageText;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showMessage('viral-agents-success-message', 'Roteiro copiado para a √°rea de transfer√™ncia!', false);
                    } catch (e) {
                        alert('Erro ao copiar roteiro. Selecione o texto manualmente.');
                    }
                    document.body.removeChild(textArea);
                });
            };

            window.sendViralMessage = async function() {
                if (!currentViralAgent || !currentViralConversation) {
                    await createNewViralConversation();
                    if (!currentViralConversation) return;
                }

                const input = document.getElementById('viral-chat-input');
                const message = input.value.trim();
                if (!message) return;

                // Adicionar mensagem do usu√°rio ao array
                currentViralMessages.push({
                    role: 'user',
                    content: message
                });

                // Adicionar mensagem do usu√°rio na UI
                const container = document.getElementById('viral-chat-messages');
                container.innerHTML += `
                    <div class="p-3 rounded-lg bg-amber-500/20 border border-amber-500/30 ml-auto max-w-[80%]">
                        <p class="text-sm text-white whitespace-pre-wrap">${escapeHtml(message)}</p>
                    </div>
                `;
                container.scrollTop = container.scrollHeight;

                input.value = '';
                input.disabled = true;

                // Mostrar loading
                container.innerHTML += `
                    <div class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-[80%]">
                        <p class="text-sm text-gray-400">Pensando...</p>
                    </div>
                `;
                container.scrollTop = container.scrollHeight;

                try {
                    const token = localStorage.getItem('core_token');
                    const startTime = Date.now(); // Marcar in√≠cio
                    
                    // Criar elemento de resposta que ser√° atualizado em tempo real
                    const loadingDiv = container.querySelector('.bg-gray-800:last-child');
                    let responseDiv = null;
                    let fullResponse = '';
                    let roteiroFinal = '';
                    
                    if (loadingDiv && loadingDiv.textContent.includes('Pensando')) {
                        loadingDiv.outerHTML = `
                            <div id="viral-streaming-response" class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-[80%] relative group">
                                <p id="viral-streaming-text" class="text-sm text-white whitespace-pre-wrap"></p>
                                <div id="viral-streaming-buttons" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2" style="display: none;">
                                    <button onclick="copyViralMessage(${currentViralMessages.length})" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Copiar roteiro">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="openViralMarkdown()" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Ver roteiro completo em MD">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        responseDiv = document.getElementById('viral-streaming-response');
                        container.scrollTop = container.scrollHeight;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                    
                    // Usar fetch com streaming
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/chat`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            conversation_id: currentViralConversation,
                            message: message,
                            model: currentViralAgent.model || 'gpt-4o',
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao enviar mensagem');
                    }

                    // Ler stream
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    const streamingText = document.getElementById('viral-streaming-text');
                    let nota = null;
                    let pontosFortes = [];

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.done) {
                                        // Extrair nota e checklist se vieram do servidor
                                        let checklistData = null;
                                        if (data.nota) {
                                            nota = data.nota;
                                            checklistData = data.checklist || null;
                                        }
                                        
                                        // Remover JSON da resposta se houver
                                        roteiroFinal = fullResponse.replace(/\{[\s\S]*"nota"[\s\S]*\}/, '').trim();
                                        
                                        // Se n√£o encontrou nota no JSON, tentar extrair do texto
                                        if (!nota) {
                                            const jsonMatch = fullResponse.match(/\{[\s\S]*"nota"[\s\S]*\}/);
                                            if (jsonMatch) {
                                                try {
                                                    const avaliacao = JSON.parse(jsonMatch[0]);
                                                    nota = avaliacao.nota;
                                                    checklistData = avaliacao.checklist || null;
                                                    roteiroFinal = fullResponse.replace(/\{[\s\S]*"nota"[\s\S]*\}/, '').trim();
                                                } catch (e) {
                                                    const notaMatch = fullResponse.match(/nota[:\s]*(\d+)\/10/i);
                                                    if (notaMatch) {
                                                        nota = parseInt(notaMatch[1]);
                                                        roteiroFinal = fullResponse.replace(/nota[:\s]*\d+\/10[\s\S]*/i, '').trim();
                                                    } else {
                                                        // Gerar nota padr√£o baseada no tamanho do roteiro
                                                        nota = Math.min(10, Math.max(7, Math.floor(roteiroFinal.length / 1000) + 7));
                                                    }
                                                }
                                            } else {
                                                // Gerar nota padr√£o baseada no tamanho do roteiro
                                                nota = Math.min(10, Math.max(7, Math.floor(roteiroFinal.length / 1000) + 7));
                                            }
                                        }
                                        
                                        // Atualizar texto final (sem a nota)
                                        if (streamingText) {
                                            streamingText.textContent = roteiroFinal;
                                        }
                                        
                                        if (responseDiv) {
                                            document.getElementById('viral-streaming-buttons').style.display = 'flex';
                                        }
                                        
                                        // Adicionar mensagem completa ao array (sem nota)
                                        currentViralMessages.push({
                                            role: 'assistant',
                                            content: roteiroFinal
                                        });
                                        
                                        // Mostrar popup de conclus√£o com checklist
                                        showViralRoteiroCompleteModal(nota, checklistData, roteiroFinal);
                                        
                                        // Recarregar conversas para atualizar timestamp
                                        await openViralAgent(currentViralAgent.id);
                                        break;
                                    }
                                    
                                    if (data.text) {
                                        fullResponse += data.text;
                                        if (streamingText) {
                                            streamingText.textContent = fullResponse;
                                            container.scrollTop = container.scrollHeight;
                                        }
                                    }
                                    
                                    if (data.error) {
                                        throw new Error(data.error);
                                    }
                                } catch (e) {
                                    // Ignorar erros de parsing
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    container.innerHTML = container.innerHTML.replace(
                        /<div class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-\[80%\]">[\s\S]*?Pensando\.\.\.[\s\S]*?<\/div>/,
                        `<div class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-[80%]">
                            <p class="text-sm text-red-400">Erro: ${escapeHtml(error.message)}</p>
                        </div>`
                    );
                } finally {
                    input.disabled = false;
                    input.focus();
                }
            };
            // ==================== FIM DAS FUN√á√ïES PARA AGENTES VIRAIS ====================

            // Iniciar polling de notifica√ß√µes
            if (userToken && userToken !== 'undefined') {
                // Aguardar um pouco para garantir que tudo est√° carregado
                setTimeout(() => {
                    startNotificationPolling();
                }, 2000);
            }
            
            // Inicializa√ß√£o: Carregar dashboard e cr√©ditos quando a p√°gina carrega
            // Garantir que a view 'inicio' est√° vis√≠vel por padr√£o
            const inicioView = document.getElementById('view-inicio');
            if (inicioView) {
                inicioView.style.display = 'block';
                inicioView.classList.add('active'); // Adicionar classe active para o CSS n√£o esconder
                // Esconder todas as outras views
                views.forEach(view => {
                    if (view && view.id !== 'view-inicio') {
                        view.style.display = 'none';
                        view.classList.remove('active');
                    }
                });
            }
            
            setTimeout(() => {
                loadDashboard();
                loadCreditsBalance();
                startDashboardAutoRefresh();
            }, 500); // Pequeno delay para garantir que tudo est√° carregado

        });

    </script>

    <!-- Script de Prote√ß√£o de C√≥digo -->
    <script>
        // Desativa o clique com o bot√£o direito
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Desativa atalhos de teclado
        document.addEventListener('keydown', event => {
            // Bloqueia F12 (Dev Tools)
            if (event.key === 'F12') {
                event.preventDefault();
            }
            // Bloqueia Ctrl+Shift+I (Dev Tools)
            if (event.ctrlKey && event.shiftKey && event.key === 'I') {
                event.preventDefault();
            }
            // Bloqueia Ctrl+U (Ver c√≥digo-fonte)
            if (event.ctrlKey && event.key === 'U') {
                event.preventDefault();
            }
            // Bloqueia Ctrl+C (Copiar)
            if (event.ctrlKey && event.key === 'C') {
                event.preventDefault();
            }
        });
    </script>

</body>
</html>
</html>