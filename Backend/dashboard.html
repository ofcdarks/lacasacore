<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - La Casa Dark Core</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Premium: Plus Jakarta Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- Ícones (Lucide Icons) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* --- ESTILOS GLOBAIS --- */
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            /* Desativa a seleção de texto */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Padrão */
        }
        .brand-title {
            font-weight: 500;
            color: #6b7280;
        }
        .brand-title-core {
            font-weight: 800;
            color: #f59e0b;
            letter-spacing: 0.05em;
        }

        /* --- COMPONENTES DE UI --- */
        .loader {
            border: 4px solid #374151; /* gray-700 */
            border-top: 4px solid #f59e0b; /* amber-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .btn-spinner {
             border: 2px solid #f3f4f6; /* gray-100 */
             border-top: 2px solid #f59e0b; /* amber-500 */
             border-radius: 50%;
             width: 16px;
             height: 16px;
             animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- FORMULÁRIOS E INPUTS --- */
        select.styled-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em;
            padding-right: 2.5rem; /* Espaço para a seta */
        }
        
        optgroup {
            font-weight: 700;
            font-style: normal;
            background-color: #1f2937; /* gray-800 */
            color: #f59e0b; /* amber-500 */
        }
        option {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            padding: 8px;
        }

        /* --- MENSAGENS E ALERTAS --- */
        .error-message {
            background-color: #450a0a;
            color: #fecaca;
            border: 1px solid #991b1b;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.875rem;
            display: none;
        }
        .success-message {
            background-color: #064e3b;
            color: #d1fae5;
            border: 1px solid #047857;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
        }
        
        /* --- SEPARAÇÃO DE VIEWS --- */
        [id^="view-"] {
            position: relative;
            isolation: isolate;
        }
        
        [id^="view-"]:not(.active) {
            display: none !important;
        }
        
        .admin-tab-content {
            position: relative;
            isolation: isolate;
        }
        
        .admin-tab-content:not([style*="display: block"]) {
            display: none !important;
        }
        .success-message ul {
            margin-top: 8px;
            list-style: disc;
            padding-left: 20px;
        }
        .success-message li.valid {
            color: #a7f3d0;
        }
        .success-message li.invalid {
            color: #fecaca;
            font-weight: 600;
        }

        /* --- ANIMAÇÕES PARA MODAL --- */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-scale-in {
            animation: scaleIn 0.3s ease-out forwards;
            opacity: 0;
            transform: scale(0.9);
        }

        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }

        /* --- CARDS E LAYOUT (ANÁLISE) --- */
        .niche-tag {
            background-color: #3f3f46;
            color: #d4d4d8;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #52525b;
        }
        .niche-tag strong {
            color: #f59e0b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            display: block;
            margin-bottom: 2px;
        }
        
        /* Estilos para abas do admin */
        .admin-tab-btn.active {
            border-bottom-color: #f59e0b !important;
            color: #f59e0b !important;
        }
        
        /* Animação pulsante para botões de comprar créditos */
        @keyframes pulse-credits {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
                transform: scale(1.02);
            }
        }
        
        .btn-credits-pulse {
            animation: pulse-credits 2s ease-in-out infinite;
        }
        
        /* --- SCROLLBAR CUSTOMIZADO --- */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(245, 158, 11, 0.3) transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(245, 158, 11, 0.3);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(245, 158, 11, 0.5);
        }
        
        /* --- ESTILOS PARA PASTAS E HISTÓRICO --- */
        .folder-link.active {
            background: rgba(245, 158, 11, 0.1) !important;
            border-color: rgba(245, 158, 11, 0.5) !important;
        }
        
        .folder-link.active i {
            color: #f59e0b !important;
        }
        
        .folder-link.active span {
            color: #fbbf24 !important;
            font-weight: 600;
        }
        
        /* Hover effect para linhas da tabela */
        #history-table-body tr:hover {
            background-color: rgba(245, 158, 11, 0.05) !important;
        }
        
        /* Estilos para biblioteca de títulos */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Cards da biblioteca com hover effect */
        #biblioteca-titles-list > div:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease;
        }
        
        /* Toast Centralizado */
        #global-toast {
            animation: toastSlideIn 0.3s ease-out;
        }
        
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Alinhamento do botão de adicionar pasta */
        #new-folder-form {
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        
        #new-folder-form > div {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 0.5rem;
            box-sizing: border-box;
        }
        
        #new-folder-form input {
            flex: 1;
            min-width: 0;
            box-sizing: border-box;
        }
        
        #new-folder-form button {
            flex-shrink: 0;
            min-width: 48px;
            width: 48px;
            height: 42px;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* --- CORREÇÃO DE OVERFLOW DA TABELA --- */
        #history-table {
            table-layout: auto;
        }
        
        #history-table th,
        #history-table td {
            white-space: nowrap;
        }
        
        #history-table th:first-child,
        #history-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: rgba(17, 24, 39, 0.95);
        }
        
        #history-table thead th:first-child {
            background-color: rgba(31, 41, 55, 0.95);
        }
        
        #history-table tbody tr:hover td:first-child {
            background-color: rgba(245, 158, 11, 0.05);
        }
        
        /* Garantir que a coluna de ações sempre seja visível */
        #history-table th:last-child,
        #history-table td:last-child {
            position: sticky;
            right: 0;
            z-index: 10;
            background-color: rgba(17, 24, 39, 0.95);
        }
        
        #history-table thead th:last-child {
            background-color: rgba(31, 41, 55, 0.95);
        }
        
        #history-table tbody tr:hover td:last-child {
            background-color: rgba(245, 158, 11, 0.05);
        }
        
        /* Ajustar largura das colunas para evitar overflow */
        #history-table {
            width: 100%;
        }
        
        #history-table th:nth-child(2),
        #history-table td:nth-child(2) {
            max-width: 300px;
            min-width: 200px;
        }
        
        #history-table th:nth-child(3),
        #history-table td:nth-child(3) {
            max-width: 220px;
            min-width: 150px;
        }
        
        #history-table th:nth-child(4),
        #history-table td:nth-child(4) {
            max-width: 160px;
            min-width: 140px;
        }
        
        #history-table th:nth-child(5),
        #history-table td:nth-child(5) {
            width: 80px;
            min-width: 80px;
        }
        
        /* Em telas menores, permitir scroll horizontal apenas se necessário */
        @media (max-width: 1024px) {
            #history-table th:nth-child(2),
            #history-table td:nth-child(2) {
                max-width: 200px;
                min-width: 150px;
            }
            
            #history-table th:nth-child(3),
            #history-table td:nth-child(3) {
                max-width: 180px;
                min-width: 120px;
            }
        }
        
        /* Modal customizado */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px) saturate(180%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeInModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .custom-modal {
            background: linear-gradient(135deg, rgba(17, 17, 17, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%);
            border: 1px solid rgba(245, 158, 11, 0.4);
            border-radius: 16px;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.95),
                0 0 0 1px rgba(245, 158, 11, 0.1),
                0 0 60px rgba(245, 158, 11, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            transform-origin: center center;
        }
        
        @keyframes fadeInModal {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .custom-modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(180deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
        }
        
        .custom-modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.02em;
        }
        
        .custom-modal-title i {
            color: #f59e0b;
            filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.4));
        }
        
        .custom-modal-close {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .custom-modal-close:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .custom-modal-body {
            padding: 28px;
        }
        
        .custom-modal-message {
            color: rgba(255, 255, 255, 0.92);
            font-size: 15.5px;
            line-height: 1.7;
            margin-bottom: 24px;
            letter-spacing: -0.01em;
        }
        
        .custom-modal-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.2s;
        }
        
        .custom-modal-input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }
        
        .custom-modal-footer {
            padding: 24px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
        }
        
        .custom-modal-btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14.5px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            letter-spacing: 0.01em;
            position: relative;
            overflow: hidden;
        }
        
        .custom-modal-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .custom-modal-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .custom-modal-btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #000000;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }
        
        .custom-modal-btn-primary:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
        }
        
        .custom-modal-btn-primary:active {
            transform: translateY(0);
        }
        
        .custom-modal-btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .custom-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        /* Notificações */
        .notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }
        
        .notification {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.98) 0%, rgba(15, 15, 15, 0.98) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6), 0 0 20px rgba(245, 158, 11, 0.15);
            animation: slideInRight 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f59e0b, #d97706);
            animation: shimmer 2s linear infinite;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .notification-icon {
            width: 20px;
            height: 20px;
            color: #f59e0b;
        }
        
        .notification-title {
            font-weight: 700;
            color: #ffffff;
            font-size: 14px;
        }
        
        .notification-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.5;
        }
        
        .notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .notification-close:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Responsividade Mobile */
        @media (max-width: 1024px) {
            .admin-tab-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
            .admin-tab-btn i {
                width: 14px;
                height: 14px;
            }
        }
        
        @media (max-width: 768px) {
            /* Sidebar mobile */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            
            /* Tabelas responsivas */
            table {
                font-size: 0.75rem;
            }
            table th, table td {
                padding: 0.5rem 0.25rem;
            }
            
            /* Cards em grid */
            .grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Admin tabs */
            .admin-tabs-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .admin-tabs-nav::-webkit-scrollbar {
                display: none;
            }
            .admin-tab-btn {
                white-space: nowrap;
                font-size: 0.7rem;
                padding: 0.5rem;
                min-width: fit-content;
            }
            
            /* Modais */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 1rem;
            }
            
            /* Notificações */
            .notification {
                width: calc(100% - 2rem);
                max-width: 400px;
            }
        }
        
        @media (max-width: 640px) {
            .notification-container {
                right: 10px;
                bottom: 10px;
                max-width: calc(100% - 20px);
            }
        }
    </style>
</head>
<body class="bg-black text-gray-300">

    <!-- Script de Proteção de Rota -->
    <script>
        // Tratamento global de erros para evitar que erros de extensões quebrem a aplicação
        window.addEventListener('error', function(event) {
            // Ignorar erros relacionados a storage em contextos restritos
            if (event.message && event.message.includes('Access to storage is not allowed')) {
                event.preventDefault();
                console.warn('[AUTH] Acesso ao storage bloqueado neste contexto (pode ser iframe ou extensão)');
                return false;
            }
            
            // Ignorar erros comuns de extensões do Chrome
            if (event.message && (
                event.message.includes('message channel closed') ||
                event.message.includes('asynchronous response') ||
                event.message.includes('listener indicated an asynchronous response')
            )) {
                event.preventDefault();
                return false;
            }
        });
        
        // Tratamento de erros não capturados em promises
        window.addEventListener('unhandledrejection', function(event) {
            // Ignorar erros relacionados a storage e extensões do Chrome
            const errorMessage = event.reason?.message || (typeof event.reason === 'string' ? event.reason : '') || '';
            
            if (errorMessage.includes('Access to storage is not allowed') ||
                errorMessage.includes('message channel closed') ||
                errorMessage.includes('asynchronous response') ||
                errorMessage.includes('listener indicated an asynchronous response') ||
                errorMessage.includes('message channel closed before a response was received')) {
                event.preventDefault();
                // Não logar para não poluir o console
                return;
            }
            
            // Verificar também se o erro é uma string
            if (typeof event.reason === 'string') {
                if (event.reason.includes('Access to storage is not allowed') ||
                    event.reason.includes('message channel closed') ||
                    event.reason.includes('asynchronous response') ||
                    event.reason.includes('listener indicated an asynchronous response') ||
                    event.reason.includes('message channel closed before a response was received')) {
                    event.preventDefault();
                    // Não logar para não poluir o console
                    return;
                }
            }
        });
        
        // Função helper para acessar localStorage de forma segura (definida antes de usar)
        function safeLocalStorageGet(key) {
            try {
                if (typeof Storage !== 'undefined' && typeof localStorage !== 'undefined') {
                    return localStorage.getItem(key);
                }
            } catch (error) {
                // Silenciar erro para não quebrar a página
                return null;
            }
            return null;
        }
        
        function safeLocalStorageRemove(key) {
            try {
                if (typeof Storage !== 'undefined' && typeof localStorage !== 'undefined') {
                    localStorage.removeItem(key);
                    return true;
                }
            } catch (error) {
                // Silenciar erro para não quebrar a página
                return false;
            }
            return false;
        }
        
        // Verificar token de forma segura
        try {
            const token = safeLocalStorageGet('core_token');
            if (!token || token === 'undefined') {
                safeLocalStorageRemove('core_token');
                window.location.href = 'la-casa-dark-core-auth.html';
            }
        } catch (error) {
            // Se houver erro, não fazer nada - pode ser contexto restrito
            console.warn('[AUTH] Não foi possível verificar token:', error.message);
        }
    </script>

    <!-- Overlay para o menu mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 hidden md:hidden"></div>

    <div class="flex min-h-screen">
        <!-- Barra Lateral (Sidebar) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-900 border-r border-gray-800 p-6 flex flex-col
                         transform -translate-x-full transition-transform duration-300 ease-in-out
                         md:relative md:translate-x-0 md:flex">
            <!-- Logo -->
            <div class="text-center mb-10">
                <h1 class="text-2xl brand-title">
                    La Casa Dark
                    <span class="brand-title-core">CORE</span>
                </h1>
            </div>
            
            <!-- Navegação -->
            <nav id="main-nav" class="flex-1 space-y-2">
                <a href="#" data-view="inicio" class="flex items-center space-x-3 px-4 py-3 bg-amber-600 text-black rounded-lg font-bold">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Início</span>
                </a>
                <a href="#" data-view="analisador" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="youtube"></i>
                    <span>Analisador de Vídeos</span>
                </a>
                <a href="#" data-view="explorar-nicho" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="compass"></i>
                    <span>Explorar Nicho</span>
                </a>
                <a href="#" data-view="historico" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="history"></i>
                    <span>Pastas e Histórico</span>
                </a>
                
                <a href="#" data-view="canais" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="target"></i>
                    <span>Canais Monitorados</span>
                </a>
                
                <a href="#" data-view="analytics" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="bar-chart-2"></i>
                    <span>Analytics</span>
                </a>
                
                <a href="#" data-view="biblioteca" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="book-open"></i>
                    <span>Biblioteca Virais</span>
                </a>
                
                <a href="#" data-view="viral-agents" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="bot"></i>
                    <span>Agentes Virais</span>
                </a>
                
                <a href="#" data-view="prompts-imagens" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="image"></i>
                    <span>Prompts e Imagens</span>
                </a>
                
                <a href="#" data-view="gerador-voz" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="mic"></i>
                    <span>Gerador de Voz</span>
                </a>
                
                <a href="#" data-view="imagens-lote" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="images"></i>
                    <span>Imagens em Lote</span>
                </a>
                
                <a href="#" data-view="gerador-video" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="video"></i>
                    <span>Gerador de Vídeo</span>
                </a>
                
                <a href="#" data-view="youtube-integration" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="youtube"></i>
                    <span>Integração YouTube</span>
                </a>
                
                <a href="#" data-view="viral-analysis" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="trending-up"></i>
                    <span>Análise de Canais Virais</span>
                </a>
                
                <a href="#" data-view="configuracoes" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition duration-200 font-medium">
                    <i data-lucide="settings"></i>
                    <span>Configurações</span>
                </a>
                
                <!-- Exibição de Créditos no Sidebar -->
                <div class="mt-4 px-4 py-3 bg-gray-800 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="coins" class="w-4 h-4 text-yellow-500"></i>
                            <span class="text-xs font-medium text-gray-400">Créditos</span>
                        </div>
                    </div>
                    <p class="text-lg font-bold text-yellow-400" id="sidebar-user-credits-balance">0.00</p>
                    <div class="mt-2 space-y-2">
                        <a href="javascript:void(0)" id="sidebar-buy-credits-btn" class="block w-full px-3 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-xs font-semibold rounded-lg transition duration-200 text-center cursor-pointer btn-credits-pulse">
                            <i data-lucide="zap" class="w-3 h-3 inline-block mr-1"></i>
                            Comprar Créditos
                        </a>
                        <button id="sidebar-view-credits-history" class="w-full text-xs text-yellow-400 hover:text-yellow-300 underline text-left">
                        Ver Histórico
                    </button>
                    </div>
                </div>
                
                <!-- Armazenamento no Sidebar -->
                <div class="mt-4 px-4 py-3 bg-gray-800 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="hard-drive" class="w-4 h-4 text-indigo-500"></i>
                            <span class="text-xs font-medium text-gray-400">Armazenamento</span>
                        </div>
                    </div>
                    <p class="text-sm font-bold text-white" id="sidebar-storage-used">0 MB</p>
                    <p class="text-xs text-gray-500" id="sidebar-storage-limit">de 10 MB</p>
                    <div class="mt-2">
                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                            <div class="bg-indigo-500 h-1.5 rounded-full transition-all duration-300" id="sidebar-storage-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Plano Atual no Sidebar -->
                <div class="mt-4 px-4 py-3 bg-gray-800 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="crown" class="w-4 h-4 text-amber-500"></i>
                            <span class="text-xs font-medium text-gray-400">Plano Atual</span>
                        </div>
                    </div>
                    <p class="text-sm font-bold text-white" id="sidebar-current-plan">Carregando...</p>
                    <div class="mt-2">
                        <a href="javascript:void(0)" id="sidebar-upgrade-plan-btn" class="block w-full px-3 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-xs font-semibold rounded-lg transition duration-200 text-center cursor-pointer">
                            <i data-lucide="arrow-up-circle" class="w-3 h-3 inline-block mr-1"></i>
                            Fazer Upgrade
                        </a>
                    </div>
                </div>

                <!-- Link do Painel Admin (Oculto por padrão) -->
                <a href="#" data-view="admin" id="admin-nav-link" style="display: none;"
                   class="flex items-center space-x-3 px-4 py-3 text-red-400 hover:bg-gray-800 hover:text-red-300 rounded-lg transition duration-200 font-medium">
                    <i data-lucide="shield-check"></i>
                    <span>Painel Admin</span>
                </a>
            </nav>

            <!-- Logout -->
            <div>
                <button id="logout-button" class="flex items-center space-x-3 px-4 py-3 w-full text-left text-red-500 hover:bg-red-900 hover:text-red-300 rounded-lg transition duration-200 font-medium">
                    <i data-lucide="log-out"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-6 md:p-10 w-full overflow-x-hidden max-w-7xl mx-auto">

            <!-- Header Mobile com botão Hamburger -->
            <header class="mb-6 md:hidden flex items-center justify-between">
                <button id="hamburger-button" class="p-2 text-gray-400 hover:text-white rounded-lg">
                    <i data-lucide="menu" class="h-6 w-6"></i>
                </button>
                <div class="text-center">
                    <h1 class="text-xl brand-title">
                        La Casa Dark
                        <span class="brand-title-core">CORE</span>
                    </h1>
                </div>
                <div class="w-8"></div> <!-- Espaçador -->
            </header>

            <!-- VISÃO 1: Início (Visível por padrão) -->
            <div id="view-inicio">
                <header class="mb-8">
                    <h1 id="welcome-heading" class="text-3xl md:text-4xl font-bold text-white">Núcleo Operacional</h1>
                    <p class="text-lg text-gray-400">Visão geral da sua execução ativa</p>
                </header>

                <!-- Dashboard de Estatísticas -->
                <div id="dashboard-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                    <!-- Card: Total de Vídeos -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-amber-500/20 rounded-lg">
                                <i data-lucide="video" class="w-6 h-6 text-amber-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Total de Vídeos</h3>
                        <p class="text-3xl font-bold text-white" id="stat-total-videos">0</p>
                        <span class="absolute top-3 right-3 text-xs font-semibold text-gray-500 uppercase tracking-wider" id="stat-videos-status">SEM DADOS</span>
                    </div>

                    <!-- Card: Total de Views -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-500/20 rounded-lg">
                                <i data-lucide="eye" class="w-6 h-6 text-blue-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Total de Views</h3>
                        <p class="text-3xl font-bold text-white" id="stat-total-views">0</p>
                        <span class="absolute top-3 right-3 text-xs font-semibold text-gray-500 uppercase tracking-wider" id="stat-views-status">SEM DADOS</span>
                    </div>

                    <!-- Card: Receita Total -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-green-500/20 rounded-lg">
                                <i data-lucide="dollar-sign" class="w-6 h-6 text-green-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Receita Total</h3>
                        <p class="text-3xl font-bold text-white" id="stat-total-revenue">$0</p>
                        <span class="absolute top-3 right-3 text-xs font-semibold text-gray-500 uppercase tracking-wider" id="stat-revenue-status">SEM DADOS</span>
                    </div>

                    <!-- Card: Créditos -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-yellow-500/20 rounded-lg">
                                <i data-lucide="coins" class="w-6 h-6 text-yellow-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Créditos Disponíveis</h3>
                        <p class="text-3xl font-bold text-white" id="stat-credits-balance">0.00</p>
                        <span class="absolute top-3 right-3 text-xs font-semibold text-amber-400 uppercase tracking-wider" id="stat-credits-status">ATIVO</span>
                        <div class="mt-3 space-y-2">
                            <a href="javascript:void(0)" id="main-buy-credits-btn" class="block w-full px-4 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white text-sm font-semibold rounded-lg transition duration-200 text-center cursor-pointer btn-credits-pulse">
                                <i data-lucide="zap" class="w-4 h-4 inline-block mr-1"></i>
                                Reabastecer Créditos
                            </a>
                            <button id="view-credits-history-btn" class="w-full text-xs text-yellow-400 hover:text-yellow-300 underline text-center">Ver Histórico</button>
                        </div>
                    </div>

                    <!-- Card: Armazenamento -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-indigo-500/20 rounded-lg">
                                <i data-lucide="hard-drive" class="w-6 h-6 text-indigo-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Armazenamento</h3>
                        <p class="text-3xl font-bold text-white" id="stat-storage-used">0 MB</p>
                        <p class="text-xs text-gray-500 mt-1" id="stat-storage-limit">de 10 MB</p>
                        <div class="mt-3">
                            <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                                <div class="bg-indigo-500 h-2 rounded-full transition-all duration-300" id="stat-storage-progress" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-400 text-center" id="stat-storage-percentage">0% usado</p>
                        </div>
                    </div>

                    <!-- Card: Vídeos Virais -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-purple-500/20 rounded-lg">
                                <i data-lucide="trending-up" class="w-6 h-6 text-purple-500"></i>
                            </div>
                        </div>
                        <h3 class="text-sm font-medium text-gray-400 mb-1">Vídeos Virais</h3>
                        <p class="text-3xl font-bold text-white" id="stat-viral-videos">0</p>
                    </div>
                </div>

                <!-- Grid de Informações Adicionais -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Métricas Adicionais -->
                    <div class="lg:col-span-2 bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-amber-500"></i>
                            Métricas de Performance
                        </h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">CTR Médio</p>
                                <p class="text-2xl font-bold text-white" id="stat-avg-ctr">0%</p>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">Total de Likes</p>
                                <p class="text-2xl font-bold text-white" id="stat-total-likes">0</p>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">Total de Comentários</p>
                                <p class="text-2xl font-bold text-white" id="stat-total-comments">0</p>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-1">RPM Médio</p>
                                <p class="text-2xl font-bold text-white" id="stat-avg-rpm">$0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Atividade Recente -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="activity" class="w-5 h-5 mr-2 text-amber-500"></i>
                            Registros Operacionais
                        </h2>
                        <div id="recent-activity" class="space-y-3">
                            <div class="text-center text-gray-400 py-4">
                                <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                                <p class="text-sm">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dicas da IA e Próximos Passos -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Dicas da IA - Coluna Direita Compacta -->
                    <div class="lg:col-span-1 bg-gradient-to-br from-amber-900/30 to-amber-800/20 border border-amber-700/50 rounded-lg p-4">
                        <h2 class="text-lg font-semibold text-white mb-3 flex items-center">
                            <i data-lucide="lightbulb" class="w-5 h-5 mr-2 text-amber-400"></i>
                            Diretivas
                        </h2>
                        <div id="ai-tips" class="space-y-2 max-h-[500px] overflow-y-auto pr-2" style="scrollbar-width: thin; scrollbar-color: rgba(251, 191, 36, 0.5) transparent;">
                            <div class="bg-gray-800/50 rounded-lg p-3 border border-amber-700/30">
                                <div class="flex items-start space-x-2">
                                    <i data-lucide="loader" class="w-4 h-4 text-amber-400 mt-0.5 animate-spin flex-shrink-0"></i>
                                    <p class="text-gray-300 text-xs">Analisando telemetria para gerar diretivas operacionais...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Próximos Passos - Colunas Centrais -->
                    <div class="lg:col-span-2 bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="target" class="w-5 h-5 mr-2 text-amber-500"></i>
                            Próximos Passos
                        </h2>
                        <div id="next-steps" class="space-y-3">
                            <div class="bg-gray-800 rounded-lg p-4">
                                <div class="flex items-start space-x-3">
                                    <i data-lucide="loader" class="w-5 h-5 text-amber-500 mt-0.5 animate-spin"></i>
                                    <p class="text-gray-300 text-sm">Carregando próximos passos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vídeos Recentes -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                        <i data-lucide="clock" class="w-5 h-5 mr-2 text-amber-500"></i>
                        Vídeos Recentes
                    </h2>
                    <div id="recent-videos" class="space-y-3">
                        <div class="text-center text-gray-400 py-4">
                            <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                            <p class="text-sm">Carregando vídeos recentes...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISÃO 2: Analisador (Oculto por padrão) -->
            <div id="view-analisador" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Analisador de Títulos Virais</h1>
                    <p class="text-lg text-gray-400">Cole uma URL de vídeo e o motor de IA para gerar títulos.</p>
                </header>

                <div id="analisador-success-message" class="success-message mb-6"></div>

                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                    <form id="analisador-form" class="space-y-6">
                        <!-- URL do Vídeo -->
                        <div>
                            <label for="video-url" class="block text-sm font-medium mb-2">URL do Vídeo Viral</label>
                            <input type="url" id="video-url" name="video-url" required
                                   placeholder="https://www.youtube.com/watch?v=..."
                                   class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Motor de IA -->
                            <div>
                                <label for="model-select" class="block text-sm font-medium mb-2">Motor de IA</label>
                                <select id="model-select" name="model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="all">Comparar (Multimodal)</option>
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                        <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">
                                    <span id="model-info-text">Modo único: 5 títulos</span>
                                </p>
                            </div>
                            
                            <!-- Idioma dos Títulos -->
                            <div>
                                <label for="language-select" class="block text-sm font-medium mb-2">Idioma dos Títulos</label>
                                <select id="language-select" name="language-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="Português" selected>🇧🇷 Português (PT-BR)</option>
                                    <option value="Inglês">🇺🇸 Inglês (EN)</option>
                                    <option value="Espanhol">🇪🇸 Espanhol (ES)</option>
                                </select>
                            </div>
                            
                            <!-- Salvar em... (Canais/Pastas) -->
                            <div>
                                <label for="folder-select" class="block text-sm font-medium mb-2">Salvar em... (Opcional)</label>
                                <select id="folder-select" name="folder-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="">Histórico Geral</option>
                                    <!-- Pastas serão carregadas aqui -->
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <button type="submit" id="analisar-button" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black w-full">
                                <span>Analisar e Gerar Títulos</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </div>
                    </form>

                    <!-- Área de Loading e Resultados -->
                    <div id="analisador-loading" class="mt-8 flex-col items-center justify-center" style="display: none;">
                        <div class="loader"></div>
                        <p class="text-amber-500 mt-4 font-semibold">Analisando... Isso pode levar alguns segundos.</p>
                    </div>

                    <!-- Caixa de erro para o analisador -->
                    <div id="analisador-error" class="error-message mt-8"></div>

                    <!-- Div de resultados (Títulos) -->
                    <div id="analisador-resultados" class="mt-8" style="display: none;">
                        <!-- O Sumário do Vídeo + Análise + Títulos serão inseridos aqui -->
                    </div>
                    
                    <!-- Gerenciador de Thumbnails de Referência -->
                    <div id="thumbnail-references-manager" class="mt-8" style="display: none;">
                        <hr class="border-gray-700 mb-6">
                        <h3 class="text-xl font-semibold text-white mb-4">📚 Biblioteca de Thumbnails de Referência</h3>
                        <p class="text-sm text-gray-400 mb-6">Faça upload de thumbnails do seu canal para que a IA sempre replique o estilo visual nas novas gerações.</p>
                        
                        <!-- Formulário de Upload -->
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-semibold text-white mb-4">Adicionar Thumbnail de Referência</h4>
                            <p class="text-xs text-amber-400 mb-4">💡 Os campos serão preenchidos automaticamente com os dados da análise atual</p>
                            <form id="thumbnail-reference-upload-form" class="space-y-4">
                                <div>
                                    <label for="ref-thumbnail-file" class="block text-sm font-medium mb-2">Imagem da Thumbnail</label>
                                    <input type="file" id="ref-thumbnail-file" accept="image/*" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <p class="text-xs text-gray-400 mt-1">Formatos suportados: JPG, PNG, WebP (máx. 5MB)</p>
                                </div>
                                
                                <div>
                                    <label for="ref-folder-select" class="block text-sm font-medium mb-2">Pasta (Opcional)</label>
                                    <select id="ref-folder-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="">Nenhuma pasta</option>
                                        <!-- Pastas serão carregadas aqui -->
                                    </select>
                                    <p class="text-xs text-gray-400 mt-1">Associe esta thumbnail a uma pasta específica</p>
                                </div>
                                
                                <div>
                                    <label for="ref-channel-name" class="block text-sm font-medium mb-2">Nome do Canal (Opcional)</label>
                                    <input type="text" id="ref-channel-name" placeholder="Ex: Meu Canal" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="ref-niche" class="block text-sm font-medium mb-2">Nicho</label>
                                        <input type="text" id="ref-niche" placeholder="Ex: História" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    </div>
                                    <div>
                                        <label for="ref-subniche" class="block text-sm font-medium mb-2">Subnicho</label>
                                        <input type="text" id="ref-subniche" placeholder="Ex: História Antiga" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    </div>
                                </div>
                                <p class="text-xs text-gray-400">A thumbnail será usada para gerar novas thumbnails deste nicho/subnicho específico</p>
                                
                                <div>
                                    <label for="ref-description" class="block text-sm font-medium mb-2">Descrição (Opcional)</label>
                                    <textarea id="ref-description" rows="2" placeholder="Descreva o estilo ou características desta thumbnail..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                                </div>
                                
                                <button type="submit" id="btn-upload-reference" class="w-full py-3 px-4 rounded-lg font-bold bg-amber-600 hover:bg-amber-500 text-black flex items-center justify-center space-x-2">
                                    <span>Upload Thumbnail</span>
                                    <div class="btn-spinner hidden"></div>
                                </button>
                            </form>
                        </div>
                        
                        <!-- Lista de Thumbnails de Referência -->
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-white">Thumbnails Salvas</h4>
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col">
                                        <label for="analyze-model-select" class="text-xs text-gray-400 mb-1">Modelo de IA para Análise:</label>
                                        <select id="analyze-model-select" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                            <option value="auto">Escolher Automaticamente</option>
                                            <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                            <option value="gpt-4o">GPT-4o (2025)</option>
                                            <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                        </select>
                                    </div>
                            <button id="btn-analyze-style" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-semibold">
                                🔄 Analisar Estilo e Criar Prompt Padrão
                            </button>
                        </div>
                    </div>
                            <div id="thumbnail-references-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                <!-- Thumbnails serão listadas aqui via JS -->
                                <p class="text-gray-400 text-sm col-span-full">Carregando thumbnails...</p>
                            </div>
                            <div id="style-prompt-info" class="mt-4 p-4 bg-amber-900/30 border border-amber-700 rounded-lg hidden">
                                <p class="text-amber-200 text-sm font-semibold mb-2">✅ Prompts Padrão Ativos (3 variações)</p>
                                <p class="text-amber-300 text-xs mb-3">O estilo visual das thumbnails de referência foi analisado e 3 prompts padrão foram criados. Selecione qual usar nas gerações.</p>
                                
                                <!-- Seleção de Prompt -->
                                <div class="mb-3">
                                    <label class="block text-xs font-medium text-amber-200 mb-2">Selecione o Prompt Padrão a Usar:</label>
                                    <div class="flex gap-2 mb-3">
                                        <button id="select-prompt-1" class="px-3 py-1 bg-amber-700 hover:bg-amber-600 text-white rounded text-xs prompt-select-btn" data-prompt-num="1">
                                            Prompt 1
                                        </button>
                                        <button id="select-prompt-2" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs prompt-select-btn" data-prompt-num="2">
                                            Prompt 2
                                        </button>
                                        <button id="select-prompt-3" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs prompt-select-btn" data-prompt-num="3">
                                            Prompt 3
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Tabs para exibir os 3 prompts -->
                                <div class="mb-3">
                                    <div class="flex border-b border-amber-700/50 mb-2">
                                        <button class="prompt-tab px-3 py-1 text-xs font-medium text-amber-300 border-b-2 border-amber-500 active" data-tab="prompt-1">Prompt 1</button>
                                        <button class="prompt-tab px-3 py-1 text-xs font-medium text-gray-400 border-b-2 border-transparent" data-tab="prompt-2">Prompt 2</button>
                                        <button class="prompt-tab px-3 py-1 text-xs font-medium text-gray-400 border-b-2 border-transparent" data-tab="prompt-3">Prompt 3</button>
                                    </div>
                                    
                                    <div id="prompt-1-content" class="prompt-content">
                                        <textarea id="standard-prompt-display-1" readonly rows="6" class="w-full px-3 py-2 bg-gray-900/50 border border-amber-700/50 rounded text-xs text-gray-200 resize-none" placeholder="Prompt 1 aparecerá aqui..."></textarea>
                                    </div>
                                    <div id="prompt-2-content" class="prompt-content hidden">
                                        <textarea id="standard-prompt-display-2" readonly rows="6" class="w-full px-3 py-2 bg-gray-900/50 border border-amber-700/50 rounded text-xs text-gray-200 resize-none" placeholder="Prompt 2 aparecerá aqui..."></textarea>
                                    </div>
                                    <div id="prompt-3-content" class="prompt-content hidden">
                                        <textarea id="standard-prompt-display-3" readonly rows="6" class="w-full px-3 py-2 bg-gray-900/50 border border-amber-700/50 rounded text-xs text-gray-200 resize-none" placeholder="Prompt 3 aparecerá aqui..."></textarea>
                                    </div>
                                </div>
                                
                                <button id="btn-reanalyze-style" class="px-3 py-1 bg-amber-700 hover:bg-amber-600 text-white rounded text-xs">
                                    Re-analisar Estilo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Gerador de Thumbnail Simplificado e Sincronizado -->
                    <div id="thumbnail-generator" class="mt-8" style="display: none;">
                        <hr class="border-gray-700 mb-6">
                        <h3 class="text-xl font-semibold text-white mb-4">🎨 Gerador de Thumbnail Completa</h3>
                        <p class="text-sm text-gray-400 mb-6">Digite o título e o sistema gerará automaticamente: thumbnail pronta, headline de impacto, descrição SEO e tags principais, tudo baseado no estilo das suas thumbnails de referência.</p>
                        
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <div class="mb-4">
                                <label for="thumb-title-input" class="block text-sm font-medium mb-2">Título do Vídeo</label>
                                <input type="text" id="thumb-title-input" placeholder="Ex: A CIDADE FLUTUANTE dos Astecas: 3 TÉCNICAS GENIAIS que Arqueólogos Ainda Não Conseguem Explicar" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <p class="text-xs text-gray-400 mt-1">O sistema adaptará automaticamente o estilo das thumbnails de referência para este título.</p>
                        </div>
                        
                        <div class="mb-4">
                                <label for="thumb-prompt-variant-simple" class="block text-sm font-medium mb-2">Prompt Padrão a Usar</label>
                                <select id="thumb-prompt-variant-simple" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <option value="1" selected>Prompt 1</option>
                                    <option value="2">Prompt 2</option>
                                    <option value="3">Prompt 3</option>
                            </select>
                                <p class="text-xs text-gray-400 mt-1">Selecione qual dos 3 prompts padrão usar para gerar a thumbnail</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                    <label for="thumb-ai-model-simple" class="block text-sm font-medium mb-2">Modelo de IA</label>
                                    <select id="thumb-ai-model-simple" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                        <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                        <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            <div>
                                    <label for="thumb-language-simple" class="block text-sm font-medium mb-2">Idioma</label>
                                    <select id="thumb-language-simple" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                        <option value="pt-BR" selected>Português</option>
                                        <option value="en-US">Inglês</option>
                                        <option value="es-ES">Espanhol</option>
                                </select>
                            </div>
                            <div>
                                    <label for="thumb-style-simple" class="block text-sm font-medium mb-2">Estilo de Arte</label>
                                    <select id="thumb-style-simple" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                    <optgroup label="🎨 Estilos Realistas">
                                        <option value="photorealistic" selected>📸 Foto Realista - Ultra HD, detalhes perfeitos</option>
                                        <option value="cinematic">🎬 Cinematográfico - Estilo Hollywood, dramático</option>
                                        <option value="documentary">📹 Documentário - Natural, autêntico</option>
                                        <option value="cinematic-narrative">🎭 Narrativa Cinematográfica - Storytelling visual</option>
                                    </optgroup>
                                    <optgroup label="🎨 Estilos Artísticos">
                                        <option value="anime">🌸 Anime - Estilo japonês animado</option>
                                        <option value="cartoon">🎨 Desenho Animado - Colorido e expressivo</option>
                                        <option value="cartoon-premium">✨ Cartoon Premium - Alta qualidade animada</option>
                                        <option value="fantasy">✨ Fantasia - Mágico e épico</option>
                                    </optgroup>
                                    <optgroup label="🎨 Estilos Minimalistas">
                                            <option value="stick-figure">👤 Desenho de Palitos - Simples e minimalista</option>
                                            <option value="whiteboard">📝 Quadro Branco - Explicativo e limpo</option>
                                            <option value="tech-minimalist">💻 Tech Minimalista - Moderno e clean</option>
                                            <option value="spiritual-minimalist">🧘 Narrativa Espiritual Minimalista - Sereno</option>
                                    </optgroup>
                                        <optgroup label="🎨 Estilos Vibrantes">
                                            <option value="viral-vibrant">🔥 Viral Vibrante - Alto contraste, cores intensas</option>
                                            <option value="modern-documentary">📺 Documentário Moderno - Dinâmico e atual</option>
                                        </optgroup>
                                        <optgroup label="🎨 Estilos Dramáticos">
                                            <option value="analog-horror">👻 Terror Analógico - Estética VHS, sombrio</option>
                                            <option value="dark-theater">🎪 Teatro Sombrio - Dramático e intenso</option>
                                            <option value="naturalist-drama">🎭 Drama Naturalista - Realista e emocional</option>
                                        </optgroup>
                                        <optgroup label="🎨 Estilos Experimentais 2025">
                                            <option value="cinematic-diorama">🎭 Diorama Cinematográfico Narrativo - Miniatura/maquete com iluminação cinematográfica</option>
                                            <option value="spiritual-neorealism">🌟 Neo-Realismo Espiritual - Transcendente</option>
                                            <option value="psychological-surrealism">🌀 Surrealismo Psicológico - Onírico</option>
                                            <option value="fragmented-memory">🧩 Memória Fragmentada - Narrativa quebrada</option>
                                        <option value="fragmented-narrative">📖 Narrativa Fragmentada - Estilo colagem</option>
                                            <option value="dream-real">💭 Sonho-Real - Limiar entre sonho e realidade</option>
                                            <option value="vhs-nostalgic">📼 VHS Nostálgico - Estética anos 80/90</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                        
                            <button type="button" id="btn-generate-complete-thumbnail" class="w-full py-4 px-6 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-black text-lg">
                                <i data-lucide="image" class="w-5 h-5"></i>
                                <span>Gerar Thumbnail Completa</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                            <p class="text-xs text-gray-400 mt-3 text-center">O sistema gerará 2 variações da thumbnail com headline, SEO e tags prontos</p>
                        </div>
                        
                        <!-- Área de resultados -->
                        <div id="complete-thumbnail-results" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6" style="display: none;"></div>
                    </div>


                    <!-- Área de loading e resultados para Ideias de Thumbnail -->
                    <div id="thumbnail-ideas-loading" class="mt-6 flex-col items-center justify-center" style="display: none;">
                        <div class="loader"></div>
                        <p class="text-amber-500 mt-4 font-semibold">A gerar ideias de thumbnail (x2)...</p>
                    </div>
                    
                    <div id="thumbnail-ideas-results" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6" style="display: none;">
                        <!-- As 2 ideias de thumbnail serão inseridas aqui -->
                    </div>

                </div>
            </div>

            <!-- VISÃO 3: Explorar Nicho (NOVA) -->
            <div id="view-explorar-nicho" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Explorador de Nichos</h1>
                    <p class="text-lg text-gray-400">Encontre subnichos promissores e analise a concorrência para o seu novo canal.</p>
                </header>

                <div id="niche-success-message" class="success-message mb-6"></div>
                <div id="niche-error-message" class="error-message mb-6"></div>

                <div class="space-y-8">
                    <!-- Etapa 1: Encontrar Subnicho -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                        <h2 class="text-2xl font-semibold text-white mb-1">Etapa 1: Encontrar um Subnicho</h2>
                        <p class="text-gray-400 mb-6">Descubra oportunidades com alta demanda e baixa concorrência.</p>
                        
                        <form id="find-subniche-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="niche-principal" class="block text-sm font-medium mb-2">Nicho Principal</label>
                                    <input type="text" id="niche-principal" required placeholder="Ex: História, Culinária, Finanças" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                </div>
                                <div>
                                    <label for="ideia-inicial" class="block text-sm font-medium mb-2">Subnicho que você pensou (concorrido)</label>
                                    <input type="text" id="ideia-inicial" required placeholder="Ex: Segunda Guerra Mundial" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                </div>
                            </div>
                            <div>
                                <label for="niche-model-select" class="block text-sm font-medium mb-2">Motor de IA</label>
                                <select id="niche-model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            <button type="submit" id="btn-find-subniche" class="w-full py-3 px-4 rounded-lg font-bold bg-amber-600 hover:bg-amber-500 text-black flex items-center justify-center space-x-2">
                                <span>Encontrar Subnichos</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </form>
                        <div id="subniche-loading" class="mt-6 text-center" style="display: none;">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4 text-amber-500">A procurar subnichos...</p>
                        </div>
                        <div id="subniche-results" class="mt-6 prose prose-invert max-w-none prose-p:text-gray-300 prose-strong:text-white prose-headings:text-amber-400"></div>
                    </div>

                    <!-- Etapa 2: Analisar Concorrente -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                        <h2 class="text-2xl font-semibold text-white mb-1">Etapa 2: Analisar Canal Concorrente</h2>
                        <p class="text-gray-400 mb-6">Obtenha um plano estratégico completo baseado em um canal de sucesso.</p>
                        
                        <form id="analyze-competitor-form" class="space-y-6">
                             <div>
                                <label for="competitor-url" class="block text-sm font-medium mb-2">URL do Canal Concorrente</label>
                                <input type="url" id="competitor-url" required placeholder="https://www.youtube.com/@canaldesucesso" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                             <div>
                                <label for="competitor-model-select" class="block text-sm font-medium mb-2">Motor de IA</label>
                                <select id="competitor-model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            <button type="submit" id="btn-analyze-competitor" class="w-full py-3 px-4 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center space-x-2">
                                <span>Gerar Plano Estratégico</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </form>
                        <div id="competitor-loading" class="mt-6 text-center" style="display: none;">
                            <div class="loader mx-auto"></div>
                            <p class="mt-4 text-amber-500">Analisando canal... Isso pode levar um minuto.</p>
                        </div>
                        <div id="competitor-analysis-results" class="mt-6 prose prose-invert max-w-none prose-p:text-gray-300 prose-strong:text-white prose-headings:text-amber-400 prose-li:text-gray-300"></div>
                    </div>
                </div>
            </div>

            <!-- VISÃO 4: Pastas e Histórico (Layout UX Profissional) -->
            <div id="view-historico" style="display: none;">
                <header class="mb-8">
                    <div class="flex items-center space-x-3 mb-2">
                        <div class="p-3 bg-gradient-to-br from-amber-600 to-amber-700 rounded-lg">
                            <i data-lucide="folder-open" class="w-6 h-6 text-white"></i>
                        </div>
                        <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Pastas e Histórico</h1>
                            <p class="text-sm text-gray-400 mt-1">Organize suas análises em pastas e acesse seu histórico completo</p>
                        </div>
                    </div>
                </header>
                
                <div id="historico-success-message" class="success-message mb-6"></div>
                <div id="historico-error-message" class="error-message mb-6"></div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    
                    <!-- Sidebar: Pastas -->
                    <div class="lg:col-span-1">
                        <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 shadow-xl">
                            <div class="flex items-center space-x-2 mb-6">
                                <i data-lucide="folder" class="w-5 h-5 text-amber-500"></i>
                                <h2 class="text-lg font-bold text-white">Minhas Pastas</h2>
                            </div>
                            
                            <form id="new-folder-form" class="mb-6 w-full">
                                <div class="flex items-center w-full">
                                    <input type="text" id="new-folder-name" placeholder="Nome do novo canal..." class="flex-1 px-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all mr-2" required>
                                    <button type="submit" class="w-11 h-11 rounded-lg transition-all duration-300 shadow-lg flex items-center justify-center disabled:opacity-50 font-bold bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-black hover:shadow-amber-500/50 flex-shrink-0">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                                </div>
                            </form>
                            
                            <div class="space-y-1 max-h-[600px] overflow-y-auto custom-scrollbar">
                                <button id="folder-all" class="folder-link w-full text-left px-4 py-3 rounded-lg transition-all duration-200 hover:bg-gray-800/50 hover:border-amber-500/30 border border-transparent active" data-folder-id="" data-folder-name="Histórico Geral">
                                    <div class="flex items-center space-x-3">
                                        <i data-lucide="archive" class="w-4 h-4 text-gray-400"></i>
                                        <span class="text-gray-200 font-medium">Histórico Geral</span>
                                    </div>
                                </button>
                                <ul id="folder-list" class="space-y-1">
                                <!-- Lista de pastas/canais -->
                            </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Conteúdo Principal: Histórico -->
                    <div class="lg:col-span-3">
                        <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 shadow-xl">
                            <!-- Header do Histórico -->
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
                                <div>
                                    <h2 class="text-xl font-bold text-white mb-1" id="history-title">Histórico Geral</h2>
                                    <p class="text-sm text-gray-400" id="history-subtitle">Todas as suas análises em um só lugar</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="delete-selected-history" class="py-2 px-4 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 text-red-400 text-sm font-semibold flex items-center space-x-2 transition-all hidden">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        <span>Excluir Selecionados</span>
                                    </button>
                                    <button id="clear-history-filter" class="text-sm text-amber-500 hover:text-amber-400 font-medium flex items-center space-x-1 transition-colors" style="display: none;">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                        <span>Limpar Filtros</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtros Melhorados -->
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="relative">
                                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                                    <input type="text" id="history-search" placeholder="Buscar por título..." class="w-full pl-10 pr-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                                </div>
                                <select id="history-niche-filter" class="px-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                                    <option value="">Todos os Nichos</option>
                                </select>
                                <select id="history-date-filter" class="px-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                                    <option value="">Todas as Datas</option>
                                    <option value="today">Hoje</option>
                                    <option value="week">Esta Semana</option>
                                    <option value="month">Este Mês</option>
                                    <option value="year">Este Ano</option>
                                </select>
                            </div>
                            
                            <!-- Tabela Melhorada - Sem Overflow -->
                            <div class="rounded-lg border border-gray-700/50 bg-gray-800/30 overflow-hidden">
                                <div class="overflow-x-auto max-w-full">
                                <table id="history-table" class="w-full text-left border-collapse">
                                    <thead>
                                            <tr class="bg-gray-800/50">
                                                <th class="p-3 w-12 border-b border-gray-700">
                                                    <input type="checkbox" id="select-all-history" class="bg-gray-700 border-gray-600 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                                                </th>
                                                <th class="p-3 border-b border-gray-700 text-amber-500 uppercase text-xs tracking-wider font-bold">Título Original</th>
                                                <th class="p-3 border-b border-gray-700 text-amber-500 uppercase text-xs tracking-wider font-bold">Nicho</th>
                                                <th class="p-3 border-b border-gray-700 text-amber-500 uppercase text-xs tracking-wider font-bold">Data e Hora</th>
                                                <th class="p-3 border-b border-gray-700 text-amber-500 uppercase text-xs tracking-wider font-bold text-center w-20">Ações</th>
                                        </tr>
                                    </thead>
                                        <tbody id="history-table-body" class="divide-y divide-gray-700/50">
                                        <!-- Histórico carregado aqui -->
                                    </tbody>
                                </table>
                                </div>
                            </div>
                            
                            <!-- Paginação Melhorada com Seletor -->
                            <div id="history-pagination" class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4" style="display: none;">
                                <div class="flex items-center space-x-4">
                                    <div class="text-sm text-gray-400 font-medium" id="history-pagination-info"></div>
                                    <div class="flex items-center space-x-2">
                                        <label for="history-limit" class="text-sm text-gray-400">Itens por página:</label>
                                        <select id="history-limit" class="px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                                            <option value="10">10</option>
                                            <option value="50" selected>50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2" id="history-pagination-controls"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VISÃO 5: Canais Monitorados -->
            <div id="view-canais" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Canais Monitorados</h1>
                    <p class="text-lg text-gray-400">Adicione canais do YouTube para monitorar novos vídeos.</p>
                </header>

                <div id="canais-success-message" class="success-message mb-6"></div>
                <div id="canais-error-message" class="error-message mb-6"></div>
                <div id="canais-limit-message" class="error-message mb-4" style="display: none;"></div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-4">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-white mb-4">Adicionar Novo Canal</h2>
                            <form id="new-channel-form" class="space-y-4">
                                <div>
                                    <label for="new-channel-name" class="block text-sm font-medium mb-2">Nome do Canal</label>
                                    <input type="text" id="new-channel-name" placeholder="Ex: Canal Dark" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" required>
                                </div>
                                <div>
                                    <label for="new-channel-url" class="block text-sm font-medium mb-2">URL do Canal</label>
                                    <input type="url" id="new-channel-url" placeholder="https://www.youtube.com/@canal" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" required>
                                </div>
                                <button type="submit" id="btn-add-channel" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black w-full">
                                    <span>Adicionar Canal</span>
                                    <div class="btn-spinner hidden"></div>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                            <h2 class="text-xl font-semibold text-white mb-4">Meus Canais Monitorados</h2>
                            <div class="overflow-x-auto rounded-lg border border-gray-800">
                                <table id="channel-table" class="w-full text-left border-collapse">
                                    <thead>
                                        <tr>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">Nome</th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">URL</th>
                                            <th class="p-3 border-b border-gray-700 bg-gray-800 text-amber-500 uppercase text-xs tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="channel-table-body">
                                        <!-- Canais carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seção de Vídeos Fixados -->
                <div class="mt-8 bg-black border border-gray-800 rounded-lg p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                        <h2 class="text-xl font-semibold text-white">Vídeos Fixados</h2>
                        <div class="flex items-center gap-3">
                            <label for="pinned-channel-select" class="text-sm text-gray-400 whitespace-nowrap">Canal:</label>
                            <select id="pinned-channel-select" class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent flex-1 min-w-[200px]">
                                <option value="">Todos os Canais</option>
                                <!-- Canais serão carregados aqui -->
                            </select>
                        </div>
                    </div>
                    <div id="pinned-videos-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-gray-400 col-span-full text-center py-8">Nenhum vídeo fixado ainda. Fixe vídeos ao buscar vídeos de um canal.</p>
                    </div>
                </div>
            </div>

            <!-- VISÃO 6: Analytics Dashboard -->
            <div id="view-analytics" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">📊 Analytics e Performance</h1>
                    <p class="text-lg text-gray-400">Acompanhe o desempenho dos seus vídeos e veja quanto dinheiro você está gerando</p>
                </header>

                <div id="analytics-error-message" class="error-message mb-6"></div>
                <div id="analytics-success-message" class="success-message mb-6"></div>

                <!-- Cards de Métricas Principais -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-green-900 to-green-800 border border-green-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="trending-up" class="w-8 h-8 text-green-400"></i>
                            <span class="text-2xl font-bold text-white" id="stats-total-views">0</span>
                        </div>
                        <p class="text-green-200 text-sm">Total de Visualizações</p>
                    </div>

                    <div class="bg-gradient-to-br from-blue-900 to-blue-800 border border-blue-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="target" class="w-8 h-8 text-blue-400"></i>
                            <span class="text-2xl font-bold text-white" id="stats-avg-ctr">0%</span>
                        </div>
                        <p class="text-blue-200 text-sm">CTR Médio</p>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-900 to-yellow-800 border border-yellow-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="dollar-sign" class="w-8 h-8 text-yellow-400"></i>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-white" id="stats-total-revenue">$0</span>
                                <span class="text-lg font-semibold text-yellow-200 block" id="stats-total-revenue-brl">R$ 0</span>
                            </div>
                        </div>
                        <p class="text-yellow-200 text-sm">Receita Estimada</p>
                        <p class="text-yellow-300 text-xs mt-1" id="stats-rpm">RPM: $0 / R$ 0</p>
                    </div>

                    <div class="bg-gradient-to-br from-purple-900 to-purple-800 border border-purple-700 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-2">
                            <i data-lucide="zap" class="w-8 h-8 text-purple-400"></i>
                            <span class="text-2xl font-bold text-white" id="stats-viral-videos">0</span>
                        </div>
                        <p class="text-purple-200 text-sm">Vídeos Virais (1M+)</p>
                    </div>
                </div>

                <!-- Lista de Vídeos Trackados -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Vídeos Recentes</h2>
                    <div class="space-y-4" id="analytics-videos-list">
                        <p class="text-gray-400">Nenhum vídeo trackado ainda. Publique um vídeo usando nossos títulos/thumbnails e registre o tracking.</p>
                    </div>
                </div>

                <!-- Gerenciamento de Canais -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-white">Meus Canais (1-10)</h2>
                        <button onclick="showAddChannelModal()" class="py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Adicionar Canal
                        </button>
                    </div>
                    <div id="channels-list" class="space-y-3">
                        <p class="text-gray-400">Carregando canais...</p>
                    </div>
                </div>

                <!-- Modal para Registrar Novo Vídeo -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">Registrar Novo Vídeo Publicado</h2>
                    <form id="register-video-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Canal</label>
                            <select id="register-video-channel" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                <option value="">Selecione um canal (opcional)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">URL do Vídeo no YouTube</label>
                            <input type="url" id="register-video-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Título Usado</label>
                            <input type="text" id="register-video-title" placeholder="Título que você usou no vídeo" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">CTR Previsto (%)</label>
                                <input type="number" id="register-video-ctr" placeholder="25" min="0" max="100" step="0.1" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Views Previstas</label>
                                <input type="number" id="register-video-views" placeholder="1000000" min="0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                        </div>
                        <button type="submit" class="py-3 px-6 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black w-full">
                            <i data-lucide="plus"></i>
                            <span>Registrar Vídeo</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Modal para Adicionar/Editar Canal -->
            <div id="channel-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-md w-full mx-4">
                    <h2 class="text-2xl font-bold text-white mb-4" id="channel-modal-title">Adicionar Canal</h2>
                    <form id="channel-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Canal *</label>
                            <input type="text" id="channel-name" required class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" placeholder="Ex: Meu Canal de Tech">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">URL do Canal</label>
                            <input type="url" id="channel-url" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" placeholder="https://www.youtube.com/@...">
                            <p class="text-gray-500 text-xs mt-1">Digite a URL e os campos serão preenchidos automaticamente</p>
                            <input type="hidden" id="channel-id-hidden">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                            <input type="text" id="channel-niche" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" placeholder="Ex: Tecnologia, Educação, Entretenimento">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Idioma</label>
                                <select id="channel-language" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="pt-BR">Português (BR)</option>
                                    <option value="en-US">English (US)</option>
                                    <option value="es-ES">Español</option>
                                    <option value="fr-FR">Français</option>
                                    <option value="de-DE">Deutsch</option>
                                    <option value="it-IT">Italiano</option>
                                    <option value="ja-JP">日本語</option>
                                    <option value="ko-KR">한국어</option>
                                    <option value="zh-CN">中文</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">País</label>
                                <select id="channel-country" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="BR">Brasil</option>
                                    <option value="US">Estados Unidos</option>
                                    <option value="ES">Espanha</option>
                                    <option value="FR">França</option>
                                    <option value="DE">Alemanha</option>
                                    <option value="IT">Itália</option>
                                    <option value="JP">Japão</option>
                                    <option value="KR">Coreia do Sul</option>
                                    <option value="CN">China</option>
                                    <option value="MX">México</option>
                                    <option value="AR">Argentina</option>
                                    <option value="CO">Colômbia</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="submit" class="flex-1 py-3 px-6 bg-amber-600 hover:bg-amber-500 text-black rounded-lg font-bold">Salvar</button>
                            <button type="button" onclick="hideChannelModal()" class="flex-1 py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- VISÃO 7: Biblioteca Virais -->
            <div id="view-biblioteca" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">📚 Biblioteca de Títulos e Thumbnails Virais</h1>
                    <p class="text-lg text-gray-400">Acesse todos os títulos e thumbnails que geraram milhões de views</p>
                </header>

                <div id="biblioteca-error-message" class="error-message mb-6"></div>
                <div id="biblioteca-success-message" class="success-message mb-6"></div>

                <!-- Tabs Melhoradas -->
                <div class="mb-6 flex space-x-1 border-b border-gray-800 bg-gray-900/50 rounded-t-lg p-1">
                    <button id="biblioteca-tab-titles" class="px-6 py-3 font-semibold text-amber-500 border-b-2 border-amber-500 transition-all hover:bg-gray-800/50 rounded-t">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            <span>Títulos Virais</span>
                        </div>
                    </button>
                    <button id="biblioteca-tab-thumbnails" class="px-6 py-3 font-semibold text-gray-400 hover:text-white transition-all hover:bg-gray-800/50 rounded-t">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="image" class="w-4 h-4"></i>
                            <span>Thumbnails Virais</span>
                        </div>
                    </button>
                    <button id="biblioteca-tab-agents" class="px-6 py-3 font-semibold text-gray-400 hover:text-white transition-all hover:bg-gray-800/50 rounded-t">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="bot" class="w-4 h-4"></i>
                            <span>Agentes de Roteiro</span>
                        </div>
                    </button>
                    <button id="biblioteca-tab-scripts" class="px-6 py-3 font-semibold text-gray-400 hover:text-white transition-all hover:bg-gray-800/50 rounded-t">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="scroll-text" class="w-4 h-4"></i>
                            <span>Roteiros Gerados</span>
                        </div>
                    </button>
                </div>

                <!-- Filtros Melhorados -->
                <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 mb-6 shadow-xl">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                            <input type="text" id="biblioteca-search" placeholder="Buscar títulos..." class="w-full pl-10 pr-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                        </div>
                        <select id="biblioteca-niche-filter" class="styled-select px-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                            <option value="">Todos os Nichos</option>
                        </select>
                        <select id="biblioteca-views-filter" class="styled-select px-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                            <option value="">Todas as Views</option>
                            <option value="1000000">1M+ views</option>
                            <option value="5000000">5M+ views</option>
                            <option value="10000000">10M+ views</option>
                        </select>
                        <button id="biblioteca-favorites-only" class="px-4 py-2.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 transition-all flex items-center justify-center space-x-2">
                            <i data-lucide="heart" class="w-4 h-4"></i>
                            <span>Apenas Favoritos</span>
                        </button>
                    </div>
                </div>

                <!-- Lista de Títulos -->
                <div id="biblioteca-titles-section" class="space-y-4">
                    <!-- Controles de seleção em lote -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="select-all-titles" class="w-5 h-5 bg-gray-700 border-gray-600 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                            <label for="select-all-titles" class="text-gray-300 font-medium">Selecionar Todos</label>
                            <span id="selected-titles-count" class="text-amber-500 font-semibold hidden">(<span id="selected-count-number">0</span> selecionados)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="delete-selected-titles" onclick="deleteSelectedTitles()" class="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 text-red-400 text-sm font-semibold rounded-lg transition-all flex items-center space-x-2 hidden">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Excluir Selecionados</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="biblioteca-titles-list">
                        <div class="col-span-full text-center py-8">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin text-amber-500"></i>
                            <p class="text-gray-400">Carregando títulos...</p>
                        </div>
                    </div>
                    
                    <!-- Paginação -->
                    <div id="biblioteca-titles-pagination" class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4" style="display: none;">
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-400 font-medium" id="biblioteca-titles-pagination-info"></div>
                            <div class="flex items-center space-x-2">
                                <label for="biblioteca-titles-limit" class="text-sm text-gray-400">Itens por página:</label>
                                <select id="biblioteca-titles-limit" class="px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                                    <option value="6" selected>6</option>
                                    <option value="12">12</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2" id="biblioteca-titles-pagination-controls"></div>
                    </div>
                </div>

                <!-- Lista de Thumbnails -->
                <div id="biblioteca-thumbnails-section" class="space-y-4" style="display: none;">
                    <!-- Controles de seleção em lote -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="select-all-thumbnails" class="w-5 h-5 bg-gray-700 border-gray-600 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                            <label for="select-all-thumbnails" class="text-gray-300 font-medium">Selecionar Todos</label>
                            <span id="selected-thumbnails-count" class="text-amber-500 font-semibold hidden">(<span id="selected-thumbnails-count-number">0</span> selecionados)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="delete-selected-thumbnails" onclick="deleteSelectedThumbnails()" class="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 text-red-400 text-sm font-semibold rounded-lg transition-all flex items-center space-x-2 hidden">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Excluir Selecionados</span>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="biblioteca-thumbnails-list">
                        <p class="text-gray-400">Carregando thumbnails...</p>
                    </div>
                    <!-- Paginação -->
                    <div id="biblioteca-thumbnails-pagination" class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4" style="display: none;">
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-400 font-medium" id="biblioteca-thumbnails-pagination-info"></div>
                            <div class="flex items-center space-x-2">
                                <label for="biblioteca-thumbnails-limit" class="text-sm text-gray-400">Itens por página:</label>
                                <select id="biblioteca-thumbnails-limit" class="px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-all">
                                    <option value="6" selected>6</option>
                                    <option value="12">12</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2" id="biblioteca-thumbnails-pagination-controls"></div>
                    </div>
                </div>

                <!-- Lista de Agentes de Roteiro -->
                <div id="biblioteca-agents-section" class="space-y-4" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="biblioteca-agents-list">
                        <p class="text-gray-400">Carregando agentes...</p>
                    </div>
                </div>

                <!-- Lista de Roteiros Gerados -->
                <div id="biblioteca-scripts-section" class="space-y-4" style="display: none;">
                    <!-- Botão de apagar selecionados -->
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-2">
                            <button id="select-all-scripts" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 hover:bg-gray-700 transition-colors text-sm">
                                Selecionar Todos
                            </button>
                            <button id="delete-selected-scripts" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors text-sm flex items-center space-x-2" style="display: none;">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                <span>Apagar Selecionados (<span id="selected-count">0</span>)</span>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4" id="biblioteca-scripts-list">
                        <p class="text-gray-400">Carregando roteiros...</p>
                    </div>
                </div>
            </div>

            <!-- VISÃO 7.5: Agentes Virais -->
            <div id="view-viral-agents" style="display: none;">
                <header class="mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl md:text-4xl font-bold text-white">🤖 Agentes Virais</h1>
                            <p class="text-lg text-gray-400">Crie e gerencie agentes de IA personalizados com memória, instruções e arquivos</p>
                        </div>
                        <button onclick="openCreateViralAgentModal()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 flex items-center space-x-2">
                            <i data-lucide="plus"></i>
                            <span>Novo Agente</span>
                        </button>
                    </div>
                </header>

                <div id="viral-agents-success-message" class="success-message mb-6" style="display: none;"></div>
                <div id="viral-agents-error-message" class="error-message mb-6" style="display: none;"></div>

                <!-- View: Lista de Agentes -->
                <div id="viral-agents-list-view">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="viral-agents-list">
                        <div class="text-center py-12">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin text-gray-400"></i>
                            <p class="text-gray-400">Carregando agentes...</p>
                        </div>
                    </div>
                </div>

                <!-- View: Detalhes do Agente -->
                <div id="viral-agents-detail-view" style="display: none;">
                    <div class="flex gap-6">
                        <!-- Conteúdo Principal -->
                        <div class="flex-1">
                            <!-- Header do Agente -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-4">
                                    <button onclick="showViralAgentsListView()" class="text-gray-400 hover:text-white transition">
                                        <i data-lucide="arrow-left"></i>
                                    </button>
                                    <div>
                                        <h2 id="viral-agent-name-header" class="text-2xl font-bold text-white"></h2>
                                        <p id="viral-agent-description-header" class="text-gray-400 text-sm"></p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleViralAgentFavorite()" id="viral-favorite-btn" class="p-2 rounded-lg hover:bg-gray-800 transition">
                                        <i data-lucide="star"></i>
                                    </button>
                                    <button onclick="openEditViralAgentModal()" class="p-2 rounded-lg hover:bg-gray-800 transition">
                                        <i data-lucide="settings"></i>
                                    </button>
                                    <button onclick="deleteViralAgent()" class="p-2 rounded-lg hover:bg-red-900 transition text-red-400">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Abas -->
                            <div class="flex gap-2 mb-6 border-b border-gray-800">
                                <button onclick="showViralChatTab()" id="viral-tab-chat" class="px-4 py-2 font-semibold border-b-2 border-amber-500 text-amber-500">
                                    Chat
                                </button>
                                <button onclick="showViralConversationsTab()" id="viral-tab-conversations" class="px-4 py-2 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white">
                                    Conversas
                                </button>
                            </div>

                            <!-- Tab: Chat -->
                            <div id="viral-tab-content-chat" class="tab-content">
                                <div class="bg-gray-900 border border-gray-800 rounded-lg" style="height: 600px; display: flex; flex-direction: column;">
                                    <div class="flex-1 overflow-y-auto p-6 space-y-4" id="viral-chat-messages">
                                        <!-- Mensagens serão carregadas aqui -->
                                    </div>
                                    <div class="p-4 border-t border-gray-800 flex gap-3">
                                        <input 
                                            type="text" 
                                            id="viral-chat-input" 
                                            placeholder="Digite sua mensagem..."
                                            class="flex-1 px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-amber-500"
                                            onkeypress="if(event.key === 'Enter') sendViralMessage()"
                                        >
                                        <button onclick="sendViralMessage()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200">
                                            <i data-lucide="send"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Conversas -->
                            <div id="viral-tab-content-conversations" class="tab-content" style="display: none;">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-white">Conversas Anteriores</h3>
                                    <button onclick="createNewViralConversation()" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white hover:bg-gray-700 transition text-sm flex items-center space-x-2">
                                        <i data-lucide="plus"></i>
                                        <span>Nova Conversa</span>
                                    </button>
                                </div>
                                <div id="viral-conversations-list" class="space-y-2">
                                    <!-- Conversas serão carregadas aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="w-80">
                            <!-- Memória -->
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-bold text-amber-500">Memória</span>
                                        <span class="text-xs text-gray-500 flex items-center gap-1">
                                            <i data-lucide="lock" class="w-3 h-3"></i>
                                            Apenas você
                                        </span>
                                    </div>
                                    <button onclick="editViralMemory()" class="text-gray-400 hover:text-white">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <p id="viral-agent-memory" class="text-xs text-gray-300 whitespace-pre-wrap line-clamp-4" style="max-height: 120px; overflow: hidden; text-overflow: ellipsis;"></p>
                                <p class="text-xs text-gray-500 mt-2" id="viral-memory-updated"></p>
                            </div>

                            <!-- Instruções -->
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-amber-500">Instruções</span>
                                    <button onclick="editViralInstructions()" class="text-gray-400 hover:text-white">
                                        <i data-lucide="pencil" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <p id="viral-agent-instructions" class="text-xs text-gray-300 whitespace-pre-wrap line-clamp-4" style="max-height: 120px; overflow: hidden; text-overflow: ellipsis;"></p>
                            </div>

                            <!-- Arquivos -->
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm font-bold text-amber-500">Arquivos</span>
                                    <button onclick="addViralFile()" class="text-gray-400 hover:text-white">
                                        <i data-lucide="plus"></i>
                                    </button>
                                </div>
                                <div id="viral-agent-files" class="space-y-2 mb-3">
                                    <!-- Arquivos serão carregados aqui -->
                                </div>
                                <div class="text-xs text-gray-500">
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div id="viral-storage-bar" class="bg-amber-500 h-2 rounded-full" style="width: 1%"></div>
                                    </div>
                                    <p class="mt-1" id="viral-storage-text">1% da capacidade do projeto utilizada</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISÃO 8: Gerador de Voz -->
            <div id="view-gerador-voz" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">🎙️ Gerador de Voz</h1>
                    <p class="text-lg text-gray-400">Transforme roteiros em narrações de alta qualidade para qualquer duração.</p>
                </header>

                <div id="tts-success-message" class="success-message mb-6" style="display: none;"></div>
                <div id="tts-error-message" class="error-message mb-6" style="display: none;"></div>

                <!-- Modal de Progresso de Geração de Voz -->
                <div id="tts-progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20">
                                <i data-lucide="mic" class="w-10 h-10 text-amber-400 animate-pulse"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Gerando Narração</h3>
                            <p class="text-gray-300 text-sm" id="tts-progress-status">Iniciando...</p>
                        </div>
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-white font-bold text-lg" id="tts-progress-counter">0/0</span>
                                <span class="text-amber-400 font-bold text-2xl" id="tts-progress-percentage">0%</span>
                            </div>
                            <div class="w-full bg-gray-800/50 rounded-full h-3 overflow-hidden border border-gray-700/50 relative">
                                <div class="h-full bg-gradient-to-r from-amber-500 via-yellow-400 to-amber-500 rounded-full transition-all duration-300 ease-out" id="tts-progress-bar" style="width: 0%; background-size: 200% 100%; animation: shimmer 2s infinite;"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-300" id="tts-progress-details">Aguarde enquanto geramos sua narração...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal de Teste de Voz -->
                <div id="tts-preview-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10000] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-white">🎙️ Teste de Voz</h3>
                            <button id="tts-preview-modal-close" class="text-gray-400 hover:text-white transition">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="mb-6">
                            <div id="tts-preview-loading" class="text-center py-8 hidden">
                                <div class="inline-block loader"></div>
                                <p class="text-gray-400 mt-4">Gerando preview...</p>
                            </div>
                            <audio id="tts-preview-player" class="w-full" style="display: none;" controls></audio>
                            <div id="tts-preview-error" class="text-red-400 text-sm text-center mt-4 hidden"></div>
                        </div>
                        <div class="flex gap-3">
                            <button id="tts-preview-modal-close-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Conclusão -->
                <div id="tts-complete-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-green-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-green-600/20 rounded-full mb-4 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Narração Gerada!</h3>
                            <p class="text-gray-300 text-sm">Sua narração está pronta para download.</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="tts-close-modal-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                            <a id="tts-download-link" href="#" download class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-lg transition duration-200 text-center">
                                Download
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Modal de Partes (FFmpeg não disponível) -->
                <div id="tts-parts-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10002] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20">
                                <i data-lucide="file-audio" class="w-12 h-12 text-amber-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Partes Geradas</h3>
                            <p class="text-gray-300 text-sm mb-2">FFmpeg não está disponível para concatenação automática.</p>
                            <p class="text-gray-400 text-xs">Baixe cada parte e use um software de áudio para combiná-las.</p>
                        </div>
                        <div id="tts-parts-list" class="space-y-3 mb-6">
                            <!-- Partes serão inseridas aqui dinamicamente -->
                        </div>
                        <div class="flex gap-3">
                            <button id="tts-parts-close-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Formulário de Geração de Voz -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 space-y-6">
                        <div>
                            <label for="tts-script-input" class="block text-sm font-medium text-gray-300 mb-2">Roteiro Completo</label>
                            <textarea id="tts-script-input" rows="10" placeholder="Cole ou importe o roteiro completo aqui... (sem limite de caracteres)" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <button id="tts-import-last-script" class="text-sm font-medium text-blue-400 hover:text-blue-300 hover:underline">
                                    Importar último roteiro gerado
                                </button>
                                <div class="flex items-center gap-2">
                                    <p id="tts-duration-hint" class="text-sm text-gray-400">Adicione o roteiro para calcular a duração.</p>
                                    <p id="tts-char-count" class="text-sm text-gray-400"></p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="tts-voice-select" class="block text-sm font-medium text-gray-300 mb-2">Voz da Narração</label>
                                <div class="flex items-center gap-3">
                                    <select id="tts-voice-select" class="flex-1 min-w-0 max-w-[calc(100%-140px)] px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 truncate" title="">
                                        <option value="">Carregando vozes...</option>
                                    </select>
                                    <button id="tts-preview-btn" type="button" class="flex-shrink-0 px-4 py-3 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold transition shadow-lg hover:shadow-amber-500/50 flex items-center gap-2 whitespace-nowrap" title="Testar Voz">
                                        <i data-lucide="play" class="w-5 h-5"></i>
                                        <span>Testar</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="tts-provider-select" class="block text-sm font-medium text-gray-300 mb-2">Provedor de Voz</label>
                                <select id="tts-provider-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="laozhang" selected>DarkVoz (Padrão)</option>
                                    <option value="voice_premium">Voz Premium</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Escolha o provedor de geração de voz</p>
                            </div>
                        </div>

                        <!-- Controles específicos do DarkVoz -->
                        <div id="darkvoz-controls" class="mb-6">
                            <div>
                                <label for="tts-speed-select" class="block text-sm font-medium text-gray-300 mb-2">Velocidade de Fala</label>
                                <select id="tts-speed-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="0.25">0.25x (Muito Lento)</option>
                                    <option value="0.5">0.5x (Lento)</option>
                                    <option value="0.75">0.75x (Um pouco lento)</option>
                                    <option value="1.0" selected>1.0x (Normal)</option>
                                    <option value="1.25">1.25x (Um pouco rápido)</option>
                                    <option value="1.5">1.5x (Rápido)</option>
                                    <option value="1.75">1.75x (Muito rápido)</option>
                                    <option value="2.0">2.0x (Máximo)</option>
                                    <option value="2.5">2.5x (Máximo)</option>
                                    <option value="3.0">3.0x (Máximo)</option>
                                    <option value="4.0">4.0x (Máximo)</option>
                                </select>
                                <p class="text-xs text-gray-400 mt-1">Velocidade de reprodução da voz (0.25x a 4.0x)</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="tts-style-preset" class="block text-sm font-medium text-gray-300 mb-2">Estilo de Narração (Predefinições)</label>
                                <select id="tts-style-preset" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="">Selecione um estilo...</option>
                                    <option value="natural">Natural e Conversacional</option>
                                    <option value="energetic">Energético e Animado</option>
                                    <option value="calm">Calmo e Profissional</option>
                                    <option value="dramatic">Dramático e Expressivo</option>
                                </select>
                            </div>
                            <div>
                                <label for="tts-style-instructions" class="block text-sm font-medium text-gray-300 mb-2">Instruções de Estilo (Personalizado)</label>
                                <textarea id="tts-style-instructions" rows="3" placeholder="Selecione um estilo ou escreva suas próprias instruções..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-3">
                            <button id="tts-generate-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold text-white bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 focus:outline-none focus:ring-4 focus:ring-amber-300 transition">
                                Gerar Narração
                            </button>
                            <button id="tts-reset-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold bg-gray-700 hover:bg-gray-600 text-gray-200 transition">
                                Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISÃO 9: Imagens em Lote -->
            <div id="view-imagens-lote" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">🖼️ Imagens em Lote</h1>
                    <p class="text-lg text-gray-400">Gere múltiplas imagens de uma vez a partir de prompts em arquivo TXT</p>
                </header>

                <div id="imagens-lote-success-message" class="success-message mb-6"></div>
                <div id="imagens-lote-error-message" class="error-message mb-6"></div>

                <!-- Modal de Confirmação de Geração -->
                <div id="batch-confirm-generation-modal" class="fixed inset-0 bg-black/85 backdrop-blur-[8px] saturate-180 z-[10001] hidden flex items-center justify-center p-4" style="animation: fadeInModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);">
                    <div class="bg-gradient-to-br from-[#111111] via-[#0a0a0a] to-[#111111] border border-amber-500/40 rounded-2xl p-8 max-w-md w-full shadow-[0_25px_50px_-12px_rgba(0,0,0,0.95),0_0_0_1px_rgba(245,158,11,0.1),0_0_60px_rgba(245,158,11,0.15),inset_0_1px_0_rgba(255,255,255,0.05)] transform transition-all" style="animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20" style="box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-amber-400" style="filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.4));"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-2" style="letter-spacing: -0.02em;">Confirmar Geração de Imagens</h3>
                            <p class="text-gray-300 text-sm leading-relaxed" id="batch-confirm-modal-message" style="letter-spacing: -0.01em;">Você está prestes a gerar imagens.</p>
                        </div>
                        
                        <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-5 mb-6 backdrop-blur-sm" style="box-shadow: 0 0 20px rgba(245, 158, 11, 0.1);">
                            <div class="flex items-start gap-3">
                                <i data-lucide="info" class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" style="filter: drop-shadow(0 0 4px rgba(245, 158, 11, 0.3));"></i>
                                <div class="text-sm text-gray-200">
                                    <p class="font-semibold text-amber-300 mb-2" id="batch-confirm-modal-count" style="letter-spacing: 0.01em;">0 imagens</p>
                                    <p class="text-gray-300/90 leading-relaxed">Este processo pode levar alguns minutos. As imagens serão geradas automaticamente em paralelo.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3" style="background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.2) 100%); padding-top: 8px; margin-top: -8px;">
                            <button id="batch-confirm-modal-cancel" class="flex-1 px-6 py-3 bg-white/8 hover:bg-white/12 text-white/90 font-semibold rounded-lg transition-all duration-250 border border-white/15 hover:border-white/25 hover:-translate-y-0.5" style="letter-spacing: 0.01em;">
                                Cancelar
                            </button>
                            <button id="batch-confirm-modal-confirm" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-black font-semibold rounded-lg transition-all duration-250 shadow-lg shadow-amber-500/30 hover:shadow-amber-500/50 hover:-translate-y-0.5" style="letter-spacing: 0.01em;">
                                Confirmar e Gerar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Conclusão de Geração -->
                <div id="batch-image-gen-complete-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-green-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-green-600/20 rounded-full mb-4 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">Geração Concluída!</h3>
                            <p class="text-gray-300 text-sm" id="batch-image-gen-duration">Tempo total: 0 segundos</p>
                        </div>
                        
                        <div class="bg-green-900/20 border border-green-700/50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-green-300 font-semibold" id="batch-image-gen-success-count">0 sucesso</span>
                                <span class="text-red-300 font-semibold" id="batch-image-gen-failed-count">0 erros</span>
                            </div>
                            <p class="text-xs text-gray-400 text-center">Todas as imagens foram processadas</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="batch-close-image-gen-modal-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                            <button id="batch-view-generated-images-btn" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-blue-500/30">
                                Ver Imagens
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Seção Principal: Prompts para Imagens -->
                <div class="bg-gradient-to-r from-blue-900 to-indigo-900 border border-blue-700 rounded-lg p-6 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="lightbulb" class="w-6 h-6 text-yellow-400"></i>
                        <h2 class="text-xl font-semibold text-white">💡 Prompts para Imagens</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Cole ou faça upload de um arquivo TXT com os prompts das imagens (um por linha). As imagens serão geradas em lote.</p>
                    
                    <div class="relative" id="batch-textarea-container">
                        <textarea id="batch-image-prompts-textarea" rows="8" placeholder="Cole os prompts aqui (um por linha) ou arraste e solte um arquivo TXT aqui...&#10;&#10;Exemplo:&#10;CENA 1: Opening scene with tense and mysterious music on a black screen.&#10;CENA 2: A person walking through a dark corridor..." class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none transition-colors duration-200" style="min-height: 200px;"></textarea>
                        <button type="button" id="batch-upload-txt-btn" class="absolute top-2 right-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium transition duration-200 flex items-center gap-2 z-20">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                            Upload TXT
                        </button>
                        <input type="file" id="batch-txt-file-input" accept=".txt" class="hidden">
                        <!-- Área de drop para drag and drop -->
                        <div id="batch-drop-zone" class="absolute inset-0 border-2 border-dashed border-blue-500 bg-blue-500/20 rounded-lg flex items-center justify-center pointer-events-none opacity-0 transition-all duration-200 z-10 backdrop-blur-sm">
                            <div class="text-center">
                                <i data-lucide="upload-cloud" class="w-16 h-16 text-blue-400 mx-auto mb-3"></i>
                                <p class="text-blue-300 font-semibold text-lg mb-1">Solte o arquivo TXT aqui</p>
                                <p class="text-blue-400 text-sm">Arraste e solte seu arquivo TXT nesta área</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 flex items-center justify-between">
                        <p class="text-sm text-gray-400" id="batch-prompts-count-display">0 prompts</p>
                        <p class="text-xs text-gray-500">Dica: Você pode colar prompts ou fazer upload de um arquivo TXT</p>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Modelo de Imagem</label>
                            <select id="batch-image-model-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="flux-pro">Flux Pro</option>
                                <option value="flux-dev">Flux Dev</option>
                                <option value="dalle-3">DALL-E 3</option>
                                <option value="midjourney">Midjourney</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Estilo</label>
                            <select id="batch-image-style-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="photorealistic">📸 Foto Realista - Ultra HD</option>
                                <option value="cinematic">🎬 Cinematográfico</option>
                                <option value="anime">🌸 Anime</option>
                                <option value="cartoon">🎨 Desenho Animado</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="batch-btn-generate-images" class="mt-4 w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-lg transition duration-200 flex items-center justify-center gap-2">
                        <i data-lucide="images" class="w-5 h-5"></i>
                        <span>Gerar Todas as Imagens</span>
                    </button>
                </div>

                <!-- Painel de Progresso -->
                <div id="batch-image-gen-progress-panel" class="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-4" style="display: none;">
                    <!-- Conteúdo será inserido dinamicamente -->
                </div>

                <!-- Progresso de Animação -->
                <div id="batch-animation-progress-panel" class="bg-gray-800 border border-purple-700 rounded-lg p-4 mb-4" style="display: none;">
                    <!-- Conteúdo será inserido dinamicamente -->
                </div>

                <!-- Botões de Ação -->
                <div id="batch-imagefx-actions" class="mb-4 space-y-2" style="display: none;">
                    <div class="flex gap-2">
                        <button id="batch-select-all-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-700 text-gray-200 hover:bg-gray-600">
                            Selecionar Tudo
                        </button>
                        <button id="batch-deselect-all-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-700 text-gray-200 hover:bg-gray-600">
                            Desmarcar Todas
                        </button>
                        <button id="batch-download-selected-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-500">
                            Baixar Selecionadas
                        </button>
                        <button id="batch-animate-selected-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-purple-600 text-white hover:bg-purple-500">
                            Animar Selecionadas (Parallax)
                        </button>
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Prompt de Animação (Parallax)</label>
                        <input type="text" id="meta-animation-prompt-input" placeholder="Descreva sua animação..." class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button id="batch-clear-all-images-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-500">
                        Limpar Imagens Geradas
                    </button>
                </div>

                <!-- Grid de Imagens Geradas -->
                <div id="batch-generated-images-output" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 min-h-0">
                    <p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>
                </div>
            </div>

            <!-- VISÃO 10: Gerador de Vídeo -->
            <div id="view-gerador-video" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">🎬 Gerador de Vídeo</h1>
                    <p class="text-lg text-gray-400">Crie vídeos incríveis com IA usando Veo da Google</p>
                </header>

                <div id="video-success-message" class="success-message mb-6" style="display: none;"></div>
                <div id="video-error-message" class="error-message mb-6" style="display: none;"></div>

                <!-- Modal de Progresso -->
                <div id="video-progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-indigo-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-500/30 to-indigo-600/20 rounded-full mb-4 ring-4 ring-indigo-500/20">
                                <div class="w-10 h-10 border-4 border-t-transparent border-indigo-400 rounded-full animate-spin"></div>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2">Gerando Vídeo</h3>
                            <p class="text-gray-300 text-sm" id="video-progress-status">Iniciando geração...</p>
                        </div>
                        <div class="mb-6">
                            <div class="w-full bg-gray-800/50 rounded-full h-3 overflow-hidden border border-gray-700/50 relative">
                                <div class="h-full bg-gradient-to-r from-amber-500 via-orange-500 to-amber-500 rounded-full transition-all duration-500" id="video-progress-bar" style="width: 0%;"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-xs font-semibold text-white" id="video-progress-percentage">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-300" id="video-progress-details">Isso pode levar alguns minutos. Por favor, aguarde...</p>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Formulário de Geração -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 space-y-6">
                        <!-- Modo fixo: Texto para Vídeo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Modo de Geração</label>
                            <input type="text" value="Texto para Vídeo" readonly class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 cursor-not-allowed">
                        </div>

                        <!-- Upload de Mídia (condicional baseado no modo) -->
                        <div id="video-media-uploads" class="hidden">
                            <!-- Frames to Video -->
                            <div id="frames-upload-section" class="hidden space-y-4">
                                <div class="flex gap-4">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Frame Inicial</label>
                                        <div class="relative">
                                            <input type="file" id="video-start-frame" accept="image/*" class="hidden">
                                            <button type="button" id="video-start-frame-btn" class="w-full h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                                <i data-lucide="image" class="w-8 h-8 mb-2"></i>
                                                <span class="text-sm">Adicionar Frame Inicial</span>
                                            </button>
                                            <div id="video-start-frame-preview" class="hidden mt-2 relative">
                                                <img id="video-start-frame-img" class="w-full h-32 object-cover rounded-lg">
                                                <button type="button" id="video-start-frame-remove" class="absolute top-2 right-2 p-1 bg-red-600 rounded-full text-white">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                                <button class="batch-animate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-purple-600 hover:bg-purple-700 mt-2" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}">
                                                    Animar (Parallax)
                                                </button>
                                                <div id="batch-animate-result-${index}" class="mt-2" style="display:none;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Frame Final (Opcional)</label>
                                        <div class="relative">
                                            <input type="file" id="video-end-frame" accept="image/*" class="hidden">
                                            <button type="button" id="video-end-frame-btn" class="w-full h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                                <i data-lucide="image" class="w-8 h-8 mb-2"></i>
                                                <span class="text-sm">Adicionar Frame Final</span>
                                            </button>
                                            <div id="video-end-frame-preview" class="hidden mt-2 relative">
                                                <img id="video-end-frame-img" class="w-full h-32 object-cover rounded-lg">
                                                <button type="button" id="video-end-frame-remove" class="absolute top-2 right-2 p-1 bg-red-600 rounded-full text-white">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="video-loop-checkbox" class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded">
                                    <label for="video-loop-checkbox" class="ml-2 text-sm text-gray-300">Criar vídeo em loop (usar frame inicial como final)</label>
                                </div>
                            </div>

                            <!-- References to Video -->
                            <div id="references-upload-section" class="hidden space-y-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Imagens de Referência (máx. 3)</label>
                                <div id="video-reference-images" class="flex gap-4 flex-wrap">
                                    <button type="button" id="video-add-reference-btn" class="w-32 h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                        <i data-lucide="plus" class="w-8 h-8 mb-2"></i>
                                        <span class="text-xs">Adicionar</span>
                                    </button>
                                </div>
                                <input type="file" id="video-reference-input" accept="image/*" multiple class="hidden">
                            </div>

                            <!-- Extend Video -->
                            <div id="extend-video-section" class="hidden space-y-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Vídeo de Entrada (deve ser 720p gerado pelo Veo)</label>
                                <input type="file" id="video-input-video" accept="video/*" class="hidden">
                                <button type="button" id="video-input-video-btn" class="w-full h-32 bg-gray-800 border-2 border-dashed border-gray-700 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-white hover:border-indigo-500 transition">
                                    <i data-lucide="video" class="w-8 h-8 mb-2"></i>
                                    <span class="text-sm">Adicionar Vídeo</span>
                                </button>
                                <div id="video-input-video-preview" class="hidden mt-2">
                                    <video id="video-input-video-preview-player" class="w-full h-48 rounded-lg" controls></video>
                                    <button type="button" id="video-input-video-remove" class="mt-2 px-4 py-2 bg-red-600 rounded-lg text-white text-sm">
                                        Remover Vídeo
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Prompt -->
                        <div>
                            <label for="video-prompt-input" class="block text-sm font-medium text-gray-300 mb-2">Descrição do Vídeo</label>
                            <textarea id="video-prompt-input" rows="4" placeholder="Descreva o vídeo que você quer criar..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
                        </div>

                        <!-- Configurações Avançadas -->
                        <div class="border-t border-gray-700 pt-4">
                            <button type="button" id="video-settings-toggle" class="flex items-center justify-between w-full text-sm font-medium text-gray-300 hover:text-white mb-4">
                                <span>Configurações Avançadas</span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                            <div id="video-settings-panel" class="hidden space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Modelo</label>
                                        <select id="video-model-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="veo-3.1-fast" selected>Veo Fast</option>
                                            <option value="sora_video2-15s">Sora 2 - 15s (Portrait)</option>
                                            <option value="sora_video2-landscape-15s">Sora 2 - 15s (Landscape)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Proporção</label>
                                        <select id="video-aspect-ratio-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="16:9">Landscape (16:9)</option>
                                            <option value="9:16">Portrait (9:16)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Resolução</label>
                                        <select id="video-resolution-select" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                            <option value="720p">720p</option>
                                            <option value="1080p">1080p</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="flex gap-3">
                            <button id="video-generate-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition">
                                Gerar Vídeo
                            </button>
                            <button id="video-reset-btn" class="flex-1 justify-center py-3 px-4 rounded-lg font-semibold bg-gray-700 hover:bg-gray-600 text-gray-200 transition">
                                Limpar Tudo
                            </button>
                        </div>
                    </div>

                    <!-- Resultado do Vídeo -->
                    <div id="video-result-section" class="hidden bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-2xl font-bold text-white mb-4">Vídeo Gerado!</h2>
                        <div class="w-full max-w-2xl mx-auto aspect-video rounded-lg overflow-hidden bg-black mb-6">
                            <video id="video-result-player" class="w-full h-full object-contain" controls></video>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4">
                            <button id="video-retry-btn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition">
                                <i data-lucide="refresh-cw" class="w-5 h-5 inline mr-2"></i>
                                Tentar Novamente
                            </button>
                            <button id="video-extend-btn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="play-circle" class="w-5 h-5 inline mr-2"></i>
                                Estender Vídeo
                            </button>
                            <a id="video-download-link" href="#" download class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition inline-flex items-center">
                                <i data-lucide="download" class="w-5 h-5 inline mr-2"></i>
                                Download
                            </a>
                            <button id="video-new-btn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                                Novo Vídeo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISÃO 10: Integração YouTube -->
            <div id="view-youtube-integration" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">🎬 Integração com YouTube</h1>
                    <p class="text-lg text-gray-400">Publique vídeos automaticamente, monitore tendências e gerencie seu canal</p>
                </header>

                <div id="youtube-integration-error-message" class="error-message mb-6"></div>
                <div id="youtube-integration-success-message" class="success-message mb-6"></div>

                <!-- Tabs de Navegação -->
                <div class="border-b border-gray-700 mb-6">
                    <nav class="flex space-x-8">
                        <button onclick="switchYouTubeTab('channels')" id="youtube-tab-channels" class="youtube-tab-button py-4 px-1 border-b-2 border-amber-500 font-medium text-sm text-amber-500">
                            <i data-lucide="tv" class="w-4 h-4 inline mr-2"></i> Canais
                        </button>
                        <button onclick="switchYouTubeTab('schedule')" id="youtube-tab-schedule" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i> Agendamento
                        </button>
                        <button onclick="switchYouTubeTab('trends')" id="youtube-tab-trends" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i> Tendências
                        </button>
                        <button onclick="switchYouTubeTab('competitors')" id="youtube-tab-competitors" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i> Competidores
                        </button>
                        <button onclick="switchYouTubeTab('analytics')" id="youtube-tab-analytics" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="bar-chart-3" class="w-4 h-4 inline mr-2"></i> Métricas
                        </button>
                        <button onclick="switchYouTubeTab('insights')" id="youtube-tab-insights" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="brain" class="w-4 h-4 inline mr-2"></i> Análise e Insights
                        </button>
                        <button onclick="switchYouTubeTab('suggestions')" id="youtube-tab-suggestions" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i> Sugestões IA
                        </button>
                        <button onclick="switchYouTubeTab('alerts')" id="youtube-tab-alerts" class="youtube-tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                            <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i> Alertas
                        </button>
                    </nav>
                </div>

                <!-- TAB 1: Canais Conectados -->
                <div id="youtube-tab-content-channels" class="youtube-tab-content">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-white">Canais Conectados</h2>
                            <button id="btn-connect-youtube" class="py-2 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-red-600 hover:bg-red-500 text-white text-sm">
                                <i data-lucide="plus"></i>
                                <span>Adicionar Canal</span>
                            </button>
                        </div>
                        <div id="youtube-channels-list" class="space-y-3 mb-4">
                            <p class="text-gray-400">Carregando canais...</p>
                        </div>
                        <div id="youtube-integration-status" class="text-gray-400"></div>
                    </div>

                    <!-- Resumo rápido (ao entrar) -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-2">⚡ Resumo Rápido</h2>
                        <p class="text-gray-400 mb-4">Ao entrar, mostramos um snapshot do seu canal principal (últimos 30 dias).</p>
                        <div id="youtube-quick-overview" class="text-gray-400">
                            <p>Carregando...</p>
                        </div>
                    </div>

                    <!-- Publicações Agendadas -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">Publicações Agendadas</h2>
                        <div id="scheduled-posts-list" class="space-y-4">
                            <p class="text-gray-400">Nenhuma publicação agendada.</p>
                        </div>
                    </div>

                    <!-- Upload de Vídeo - Interface Completa YouTube Studio -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📤 Upload de Vídeo</h2>
                        <p class="text-gray-400 mb-4">Envie vídeos diretamente para seu canal do YouTube</p>
                        
                        <!-- Abas estilo YouTube Studio -->
                        <div class="border-b border-gray-700 mb-6">
                            <nav class="flex space-x-8">
                                <button onclick="switchUploadTab('details')" id="upload-tab-details" class="upload-tab-button py-3 px-1 border-b-2 border-amber-500 font-medium text-sm text-amber-500">
                                    <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i> Detalhes
                                </button>
                                <button onclick="switchUploadTab('visibility')" id="upload-tab-visibility" class="upload-tab-button py-3 px-1 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-gray-300">
                                    <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i> Visibilidade
                                </button>
                            </nav>
                        </div>
                        
                        <form id="youtube-upload-form" class="space-y-4">
                            <!-- Painel: Detalhes -->
                            <div id="upload-pane-details" class="upload-pane space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Canal</label>
                                <select id="upload-channel-select" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                                    <option value="">Selecione um canal...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Arquivo de Vídeo</label>
                                <input type="file" id="upload-video-file" accept="video/*" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Título</label>
                                <input type="text" id="upload-video-title" placeholder="Título do vídeo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Descrição</label>
                                <textarea id="upload-video-description" rows="4" placeholder="Descrição do vídeo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Tags (separadas por vírgula)</label>
                                <input type="text" id="upload-video-tags" placeholder="tag1, tag2, tag3" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Thumbnail (Opcional)</label>
                                <input type="file" id="upload-video-thumbnail" accept="image/*" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            </div>

                            <!-- Painel: Visibilidade -->
                            <div id="upload-pane-visibility" class="upload-pane space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Visibilidade</label>
                                <select id="upload-video-privacy" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="private">Privado</option>
                                    <option value="unlisted">Não listado</option>
                                    <option value="public">Público</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Publicação</label>
                                <select id="upload-publish-type" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500 mb-2">
                                    <option value="now">Publicar Agora</option>
                                    <option value="schedule">Agendar para Depois</option>
                                </select>
                                <div id="schedule-datetime-container" class="hidden mt-2">
                                    <input type="datetime-local" id="upload-schedule-datetime" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" min="">
                                </div>
                            </div>
                            </div>

                            <button type="submit" class="w-full py-3 px-4 bg-red-600 hover:bg-red-500 text-white rounded-lg font-semibold transition duration-300">
                                <i data-lucide="upload" class="w-5 h-5 inline mr-2"></i> <span id="upload-button-text">Enviar Vídeo para YouTube</span>
                            </button>
                        </form>
                        <div id="upload-progress" class="mt-4 hidden">
                            <div class="bg-gray-800 rounded-full h-2 overflow-hidden">
                                <div id="upload-progress-bar" class="bg-red-600 h-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="upload-status" class="text-gray-400 text-sm mt-2"></p>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Agendamento Inteligente -->
                <div id="youtube-tab-content-schedule" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🤖 Agendamento Inteligente</h2>
                        <p class="text-gray-400 mb-6">A IA sugere o melhor horário para publicar baseado no seu nicho</p>
                        
                        <form id="suggest-time-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                                <input type="text" id="suggest-time-niche" placeholder="Ex: Entretenimento, Educação, Tecnologia" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Subnicho (Opcional)</label>
                                <input type="text" id="suggest-time-subniche" placeholder="Ex: Gaming, Finanças Pessoais" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i> Sugerir Melhor Horário
                            </button>
                        </form>
                        
                        <div id="suggested-time-result" class="mt-6 hidden">
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-white font-semibold mb-2">⏰ Horário Sugerido</h3>
                                <p id="suggested-time" class="text-amber-400 text-2xl font-bold mb-2"></p>
                                <p id="suggested-days" class="text-gray-300 mb-3"></p>
                                <p id="suggested-explanation" class="text-gray-400 text-sm"></p>
                                <div id="suggested-alternatives" class="mt-3">
                                    <p class="text-gray-400 text-sm mb-2">Horários alternativos:</p>
                                    <div id="alternative-times" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🏷️ Gerador Automático de Tags e Descrição</h2>
                        <p class="text-gray-400 mb-6">Gere automaticamente tags e descrição otimizadas para SEO usando IA</p>
                        
                        <form id="generate-metadata-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Título do Vídeo</label>
                                <input type="text" id="metadata-title" placeholder="Digite o título do vídeo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Modelo de IA</label>
                                <select id="metadata-model" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="gpt-4o">GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho (Opcional)</label>
                                <input type="text" id="metadata-niche" placeholder="Ex: Entretenimento" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Descrição do Conteúdo (Opcional)</label>
                                <textarea id="metadata-description" rows="3" placeholder="Descreva brevemente o conteúdo do vídeo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500"></textarea>
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="wand-2" class="w-4 h-4 inline mr-2"></i> Gerar Metadata
                            </button>
                        </form>
                        
                        <div id="generated-metadata-result" class="mt-6 hidden">
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 space-y-4">
                                <div>
                                    <h3 class="text-white font-semibold mb-2">Descrição Otimizada:</h3>
                                    <textarea id="generated-description" rows="6" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm" readonly></textarea>
                                    <button onclick="copyToClipboard('generated-description')" class="mt-2 py-1 px-3 bg-gray-600 hover:bg-gray-500 text-white rounded text-xs">
                                        <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i> Copiar
                                    </button>
                                </div>
                                <div>
                                    <h3 class="text-white font-semibold mb-2">Tags Otimizadas:</h3>
                                    <div id="generated-tags" class="flex flex-wrap gap-2 mb-2"></div>
                                    <button onclick="copyTagsToClipboard()" class="py-1 px-3 bg-gray-600 hover:bg-gray-500 text-white rounded text-xs">
                                        <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i> Copiar Tags
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: Análise de Tendências -->
                <div id="youtube-tab-content-trends" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📈 Análise Automática de Tendências</h2>
                        <p class="text-gray-400 mb-6">Escanee o YouTube por vídeos virais recentes no seu nicho</p>
                        
                        <form id="scan-trends-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                                    <input type="text" id="trends-niche" placeholder="Ex: Entretenimento, Educação" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Subnicho (Opcional)</label>
                                    <input type="text" id="trends-subniche" placeholder="Ex: Gaming, Finanças" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                </div>
                            </div>
                            
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-300 mb-3">🔍 Filtros de Busca</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Idioma</label>
                                        <select id="trends-language" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="pt">Português (Brasil)</option>
                                            <option value="en">Inglês</option>
                                            <option value="es">Espanhol</option>
                                            <option value="fr">Francês</option>
                                            <option value="de">Alemão</option>
                                            <option value="it">Italiano</option>
                                            <option value="ja">Japonês</option>
                                            <option value="ko">Coreano</option>
                                            <option value="zh">Chinês</option>
                                            <option value="ru">Russo</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Ordenar por</label>
                                        <select id="trends-order-by" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="viewCount">Mais Visualizações</option>
                                            <option value="date">Mais Recente</option>
                                            <option value="rating">Melhor Avaliação</option>
                                            <option value="relevance">Mais Relevante</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Duração do Vídeo</label>
                                        <select id="trends-duration" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="any">Qualquer Duração</option>
                                            <option value="short">Curto (&lt; 4 min)</option>
                                            <option value="medium">Médio (4-20 min)</option>
                                            <option value="long">Longo (&gt; 20 min)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Período de Publicação</label>
                                        <select id="trends-published-after" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                            <option value="1">Últimas 24 horas</option>
                                            <option value="3">Últimos 3 dias</option>
                                            <option value="7" selected>Últimos 7 dias</option>
                                            <option value="14">Últimos 14 dias</option>
                                            <option value="30">Últimos 30 dias</option>
                                            <option value="90">Últimos 90 dias</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-300 mb-3">📊 Filtros de Performance</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Views Mínimas</label>
                                        <input type="number" id="trends-min-views" value="0" min="0" step="1000" placeholder="Ex: 10000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                        <p class="text-xs text-gray-500 mt-1">Deixe 0 para desabilitar</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Views por Dia Mínimas</label>
                                        <input type="number" id="trends-min-views-per-day" value="0" min="0" step="100" placeholder="Ex: 1000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                        <p class="text-xs text-gray-500 mt-1">Deixe 0 para desabilitar</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Número de Resultados</label>
                                <input type="number" id="trends-max-results" value="10" min="1" max="50" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            
                            <button type="submit" class="w-full py-2 px-4 bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white rounded-lg font-semibold transition-all shadow-lg shadow-amber-500/30">
                                <i data-lucide="search" class="w-4 h-4 inline mr-2"></i> Escanear Tendências
                            </button>
                        </form>
                    </div>

                    <div id="trends-results" class="space-y-4">
                        <!-- Resultados serão inseridos aqui -->
                    </div>
                </div>

                <!-- TAB 4: Monitoramento de Competidores -->
                <div id="youtube-tab-content-competitors" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">👥 Monitoramento de Competidores</h2>
                        <p class="text-gray-400 mb-6">Adicione canais competidores para monitoramento automático</p>
                        
                        <form id="monitor-competitor-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">URL ou ID do Canal Competidor</label>
                                <input type="text" id="competitor-channel-id" placeholder="https://youtube.com/@canal ou UC..." class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Canal (Opcional)</label>
                                <input type="text" id="competitor-channel-name" placeholder="Nome do canal" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho (Opcional)</label>
                                <input type="text" id="competitor-niche" placeholder="Ex: Entretenimento" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="competitor-auto-analyze" checked class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500">
                                <label for="competitor-auto-analyze" class="ml-2 text-sm text-gray-300">Análise automática ativada</label>
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i> Adicionar Competidor
                            </button>
                        </form>
                    </div>

                    <div id="monitored-competitors-list" class="space-y-4">
                        <p class="text-gray-400">Carregando competidores monitorados...</p>
                    </div>
                </div>

                <!-- TAB 5: Sugestões IA -->
                <!-- TAB: Métricas do Canal -->
                <div id="youtube-tab-content-analytics" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📊 Métricas do Canal</h2>
                        <p class="text-gray-400 mb-4">Visualize métricas detalhadas do seu canal do YouTube</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Canal</label>
                                <select id="analytics-channel-select" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                                    <option value="">Selecione um canal...</option>
                                </select>
                                <div id="analytics-channel-meta" class="mt-2 text-xs text-gray-400"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Período</label>
                                <select id="analytics-period-select" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30" selected>Últimos 30 dias</option>
                                    <option value="90">Últimos 90 dias</option>
                                    <option value="365">Último ano</option>
                                </select>
                            </div>
                        </div>
                        
                        <button onclick="loadChannelAnalytics()" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold mb-6">
                            <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i> Carregar Métricas
                        </button>
                        
                        <div id="analytics-loading" class="hidden text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-amber-500"></div>
                            <p class="text-gray-400 mt-2">Carregando métricas...</p>
                        </div>
                        
                        <div id="analytics-content" class="hidden">
                            <!-- Layout estilo YouTube Studio -->
                            <div class="bg-gray-900 border border-gray-800 rounded-2xl p-0 overflow-hidden mb-6">
                                <div class="p-6 border-b border-gray-800">
                                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                                        <div class="min-w-0">
                                            <h3 id="yt-analytics-headline" class="text-2xl md:text-3xl font-bold text-white leading-tight">
                                                Seu canal teve - visualizações nos últimos - dias
                                            </h3>
                                            <p id="yt-analytics-subheadline" class="text-sm text-gray-400 mt-2">
                                                Selecionando período e carregando dados...
                                            </p>
                                            <!-- Mantido para compatibilidade/uso interno -->
                                            <p id="analytics-summary-text" class="hidden">Carregando resumo...</p>
                                        </div>
                                        <div class="flex items-center gap-2 md:pt-1">
                                            <button onclick="loadChannelAnalytics()" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black rounded-lg font-semibold">
                                                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i> Atualizar
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cards + gráfico (YouTube-like) -->
                                <div class="bg-gray-950/40">
                                    <div class="grid grid-cols-1 md:grid-cols-4 divide-y md:divide-y-0 md:divide-x divide-gray-800">
                                        <div class="p-5">
                                            <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Visualizações</p>
                                            <p id="analytics-total-views" class="text-3xl font-bold text-white">-</p>
                                            <p id="analytics-views-change" class="text-xs text-gray-500 mt-1">-</p>
                                        </div>
                                        <div class="p-5">
                                            <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Tempo de exibição</p>
                                            <p id="analytics-watch-time" class="text-3xl font-bold text-white">-</p>
                                            <p id="analytics-watch-time-change" class="text-xs text-gray-500 mt-1">-</p>
                                        </div>
                                        <div class="p-5">
                                            <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Inscritos</p>
                                            <p id="analytics-subscribers-gained" class="text-3xl font-bold text-white">-</p>
                                            <p id="analytics-subscribers-gained-change" class="text-xs text-gray-500 mt-1">-</p>
                                            <!-- Mantido (total) -->
                                            <p class="text-[11px] text-gray-600 mt-2">Total: <span id="analytics-subscribers" class="text-gray-400">-</span></p>
                                            <p id="analytics-subscribers-change" class="hidden">-</p>
                                        </div>
                                        <div class="p-5">
                                            <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Receita estimada</p>
                                            <p id="analytics-estimated-revenue" class="text-3xl font-bold text-white">-</p>
                                            <p id="analytics-revenue-period" class="text-xs text-gray-500 mt-1">-</p>
                                            <div class="mt-2 text-[11px] text-gray-600 space-y-1">
                                                <div>RPM: <span id="analytics-rpm" class="text-gray-400">-</span></div>
                                                <div>Impressões (anúncios): <span id="analytics-ad-impressions" class="text-gray-400">-</span></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-6">
                                        <div class="flex items-center justify-between mb-3">
                                            <p class="text-white font-semibold">Visualizações ao longo do tempo</p>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="toggleChartType('line')" class="px-3 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-white rounded chart-type-btn active" data-type="line">
                                                    <i data-lucide="trending-up" class="w-4 h-4 inline"></i> Linha
                                                </button>
                                                <button onclick="toggleChartType('bar')" class="px-3 py-1 text-xs bg-gray-800 hover:bg-gray-700 text-white rounded chart-type-btn" data-type="bar">
                                                    <i data-lucide="bar-chart-2" class="w-4 h-4 inline"></i> Barras
                                                </button>
                                            </div>
                                        </div>
                                        <canvas id="analytics-chart" class="w-full" style="max-height: 320px;"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Breakdowns (fontes/paises) -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-white font-semibold mb-3">🚦 Fontes de Tráfego (Top)</h3>
                                    <div id="analytics-traffic-sources" class="space-y-2">
                                        <p class="text-gray-400 text-sm">Carregando...</p>
                                    </div>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-white font-semibold mb-3">🌍 Países (Top)</h3>
                                    <div id="analytics-top-countries" class="space-y-2">
                                        <p class="text-gray-400 text-sm">Carregando...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                                <h3 class="text-white font-semibold mb-3">🧠 Insights Acionáveis (para ficar na frente)</h3>
                                <div id="analytics-action-insights" class="space-y-2">
                                    <p class="text-gray-400 text-sm">Carregando...</p>
                                </div>
                            </div>
                            
                            <!-- Métricas de Engajamento -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-gray-400 text-sm">Curtidas</p>
                                        <i data-lucide="thumbs-up" class="w-4 h-4 text-blue-500"></i>
                                    </div>
                                    <p id="analytics-likes" class="text-2xl font-bold text-white">-</p>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-gray-400 text-sm">Comentários</p>
                                        <i data-lucide="message-circle" class="w-4 h-4 text-green-500"></i>
                                    </div>
                                    <p id="analytics-comments" class="text-2xl font-bold text-white">-</p>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-gray-400 text-sm">Compartilhamentos</p>
                                        <i data-lucide="share-2" class="w-4 h-4 text-purple-500"></i>
                                    </div>
                                    <p id="analytics-shares" class="text-2xl font-bold text-white">-</p>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-gray-400 text-sm">Taxa de Engajamento</p>
                                        <i data-lucide="activity" class="w-4 h-4 text-amber-500"></i>
                                    </div>
                                    <p id="analytics-engagement-rate" class="text-2xl font-bold text-white">-</p>
                                </div>
                            </div>
                            
                            <!-- Métricas Avançadas -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <p class="text-gray-400 text-sm mb-2">Duração Média de Visualização</p>
                                    <p id="analytics-avg-view-duration" class="text-xl font-bold text-white">-</p>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <p class="text-gray-400 text-sm mb-2">Taxa de Retenção</p>
                                    <p id="analytics-retention-rate" class="text-xl font-bold text-white">-</p>
                                </div>
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <p class="text-gray-400 text-sm mb-2">CTR (Taxa de Cliques)</p>
                                    <p id="analytics-ctr" class="text-xl font-bold text-white">-</p>
                                </div>
                            </div>
                            
                            <!-- Vídeos Recentes -->
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-white font-semibold">Vídeos Recentes</h3>
                                    <button onclick="loadChannelAnalytics()" class="text-xs text-amber-500 hover:text-amber-400">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i> Atualizar
                                    </button>
                                </div>
                                <div id="analytics-recent-videos" class="space-y-3">
                                    <p class="text-gray-400">Carregando...</p>
                                </div>
                            </div>

                            <!-- Top 5 mais vistos + análise -->
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mt-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-white font-semibold">🏆 Top 5 Vídeos Mais Vistos (com análise)</h3>
                                    <button onclick="loadChannelAnalytics()" class="text-xs text-amber-500 hover:text-amber-400">
                                        <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i> Atualizar
                                    </button>
                                </div>
                                <div id="analytics-top-videos" class="space-y-3">
                                    <p class="text-gray-400">Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Análise e Insights -->
                <div id="youtube-tab-content-insights" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🧠 Análise e Insights do Canal</h2>
                        <p class="text-gray-400 mb-4">Análise completa do seu canal com recomendações de IA para maximizar views e engajamento</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Canal</label>
                                <select id="insights-channel-select" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                                    <option value="">Selecione um canal...</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="loadChannelInsights()" class="w-full py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                    <i data-lucide="brain" class="w-4 h-4 inline mr-2"></i> Gerar Análise Completa
                                </button>
                            </div>
                        </div>
                        
                        <div id="insights-loading" class="hidden text-center py-12">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500"></div>
                            <p class="text-gray-400 mt-4">Analisando canal e gerando insights... Isso pode levar alguns minutos.</p>
                        </div>
                        
                        <div id="insights-content" class="hidden">
                            <!-- Resumo Executivo -->
                            <div class="bg-gradient-to-r from-amber-900/20 to-blue-900/20 border border-amber-700/30 rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4">📊 Resumo Executivo</h3>
                                <div id="insights-summary" class="prose prose-invert max-w-none">
                                    <p class="text-gray-300">Carregando análise...</p>
                                </div>
                            </div>
                            
                            <!-- Grid de Insights -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <!-- Frequência de Publicação -->
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                        <i data-lucide="calendar" class="w-5 h-5 mr-2 text-amber-500"></i> Frequência Ideal
                                    </h3>
                                    <div id="insights-frequency" class="text-gray-300">
                                        <p class="text-sm">Analisando...</p>
                                    </div>
                                </div>
                                
                                <!-- Minutagem Ideal -->
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                        <i data-lucide="clock" class="w-5 h-5 mr-2 text-amber-500"></i> Duração Ideal
                                    </h3>
                                    <div id="insights-duration" class="text-gray-300">
                                        <p class="text-sm">Analisando...</p>
                                    </div>
                                </div>
                                
                                <!-- Horário Ideal -->
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                        <i data-lucide="timer" class="w-5 h-5 mr-2 text-amber-500"></i> Horário de Publicação
                                    </h3>
                                    <div id="insights-publish-time" class="text-gray-300">
                                        <p class="text-sm">Analisando...</p>
                                    </div>
                                </div>
                                
                                <!-- Tipo de Conteúdo -->
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                        <i data-lucide="video" class="w-5 h-5 mr-2 text-amber-500"></i> Conteúdo Recomendado
                                    </h3>
                                    <div id="insights-content-type" class="text-gray-300">
                                        <p class="text-sm">Analisando...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estratégias para Viralizar -->
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                    <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-amber-500"></i> Estratégias para Aumentar Views
                                </h3>
                                <div id="insights-strategies" class="space-y-3">
                                    <p class="text-gray-300">Analisando estratégias...</p>
                                </div>
                            </div>
                            
                            <!-- Recomendações de Títulos -->
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                    <i data-lucide="type" class="w-5 h-5 mr-2 text-amber-500"></i> Padrões de Títulos que Funcionam
                                </h3>
                                <div id="insights-titles" class="space-y-2">
                                    <p class="text-gray-300">Analisando padrões...</p>
                                </div>
                            </div>
                            
                            <!-- Análise de Thumbnails -->
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                    <i data-lucide="image" class="w-5 h-5 mr-2 text-amber-500"></i> Recomendações de Thumbnails
                                </h3>
                                <div id="insights-thumbnails" class="text-gray-300">
                                    <p class="text-sm">Analisando thumbnails...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="youtube-tab-content-suggestions" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">✨ Sugestões Automáticas de Vídeos</h2>
                        <p class="text-gray-400 mb-6">A IA analisa tendências e sugere novos vídeos com potencial viral</p>
                        
                        <form id="generate-suggestions-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho</label>
                                <input type="text" id="suggestions-niche" placeholder="Ex: Entretenimento" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Subnicho (Opcional)</label>
                                <input type="text" id="suggestions-subniche" placeholder="Ex: Gaming" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-amber-500">
                            </div>
                            <button type="submit" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-semibold">
                                <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i> Gerar Sugestões
                            </button>
                        </form>
                    </div>

                    <div id="ai-suggestions-list" class="space-y-4">
                        <p class="text-gray-400">Carregando sugestões...</p>
                    </div>
                </div>

                <!-- TAB 6: Alertas Virais -->
                <div id="youtube-tab-content-alerts" class="youtube-tab-content" style="display: none;">
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🔔 Alertas de Vídeos Virais</h2>
                        <p class="text-gray-400 mb-6">Notificações sobre vídeos virais de competidores monitorados</p>
                        
                        <div id="viral-alerts-list" class="space-y-4">
                            <p class="text-gray-400">Carregando alertas...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISÃO 8: Prompts e Imagens -->
            <div id="view-prompts-imagens" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">🎨 Prompts para Cenas e Gerador de Imagens</h1>
                    <p class="text-lg text-gray-400">Gere prompts de cena do seu roteiro e crie todas as imagens com apenas 1 clique!</p>
                </header>

                <div id="prompts-imagens-success-message" class="success-message mb-6"></div>
                <div id="prompts-imagens-error-message" class="error-message mb-6"></div>

                <!-- Modal de Progresso de Geração -->
                <!-- Modal de Progresso de Prompts -->
                <div id="scene-prompts-progress-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-lg w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20">
                                <i data-lucide="sparkles" class="w-10 h-10 text-amber-400 animate-spin"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-amber-400 to-yellow-400 bg-clip-text text-transparent">Gerando Prompts de Cena</h3>
                            <p class="text-gray-300 text-sm" id="progress-modal-status">Iniciando...</p>
                        </div>
                        
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-white font-bold text-lg" id="progress-modal-counter">0/0</span>
                                <span class="text-amber-400 font-bold text-2xl" id="progress-modal-percentage">0%</span>
                            </div>
                            <div class="w-full bg-gray-800/50 rounded-full h-3 overflow-hidden border border-gray-700/50">
                                <div class="h-full bg-gradient-to-r from-amber-500 via-yellow-400 to-amber-500 rounded-full transition-all duration-500 ease-out relative" id="progress-modal-bar" style="width: 0%; background-size: 200% 100%; animation: shimmer 2s infinite;">
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent animate-shimmer"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <p class="text-sm text-gray-300" id="progress-modal-details">Aguarde enquanto geramos seus prompts...</p>
                        </div>
                    </div>
                </div>

                <!-- Modal de Confirmação de Geração -->
                <div id="confirm-generation-modal" class="fixed inset-0 bg-black/85 backdrop-blur-[8px] saturate-180 z-[10001] hidden flex items-center justify-center p-4" style="animation: fadeInModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);">
                    <div class="bg-gradient-to-br from-[#111111] via-[#0a0a0a] to-[#111111] border border-amber-500/40 rounded-2xl p-8 max-w-md w-full shadow-[0_25px_50px_-12px_rgba(0,0,0,0.95),0_0_0_1px_rgba(245,158,11,0.1),0_0_60px_rgba(245,158,11,0.15),inset_0_1px_0_rgba(255,255,255,0.05)] transform transition-all" style="animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20" style="box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-amber-400" style="filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.4));"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-2" style="letter-spacing: -0.02em;">Confirmar Geração de Imagens</h3>
                            <p class="text-gray-300 text-sm leading-relaxed" id="confirm-modal-message" style="letter-spacing: -0.01em;">Você está prestes a gerar imagens.</p>
                        </div>
                        
                        <div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-5 mb-6 backdrop-blur-sm" style="box-shadow: 0 0 20px rgba(245, 158, 11, 0.1);">
                            <div class="flex items-start gap-3">
                                <i data-lucide="info" class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" style="filter: drop-shadow(0 0 4px rgba(245, 158, 11, 0.3));"></i>
                                <div class="text-sm text-gray-200">
                                    <p class="font-semibold text-amber-300 mb-2" id="confirm-modal-count" style="letter-spacing: 0.01em;">0 imagens</p>
                                    <p class="text-gray-300/90 leading-relaxed">Este processo pode levar alguns minutos. As imagens serão geradas automaticamente em paralelo.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3" style="background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.2) 100%); padding-top: 8px; margin-top: -8px;">
                            <button id="confirm-modal-cancel" class="flex-1 px-6 py-3 bg-white/8 hover:bg-white/12 text-white/90 font-semibold rounded-lg transition-all duration-250 border border-white/15 hover:border-white/25 hover:-translate-y-0.5" style="letter-spacing: 0.01em;">
                                Cancelar
                            </button>
                            <button id="confirm-modal-confirm" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-black font-semibold rounded-lg transition-all duration-250 shadow-lg shadow-amber-500/30 hover:shadow-amber-500/50 hover:-translate-y-0.5" style="letter-spacing: 0.01em;">
                                Confirmar e Gerar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de Conclusão de Geração -->
                <div id="image-gen-complete-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[10001] hidden flex items-center justify-center p-4">
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border border-amber-500/50 rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-green-600/20 rounded-full mb-4 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">Geração Concluída!</h3>
                            <p class="text-gray-300 text-sm" id="image-gen-duration">Tempo total: 0 segundos</p>
                        </div>
                        
                        <div class="bg-green-900/20 border border-green-700/50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-green-300 font-semibold" id="image-gen-success-count">0 sucesso</span>
                                <span class="text-red-300 font-semibold" id="image-gen-failed-count">0 erros</span>
                            </div>
                            <p class="text-xs text-gray-400 text-center">Todas as imagens foram processadas</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="close-image-gen-modal-btn" class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200">
                                Fechar
                            </button>
                            <button id="view-generated-images-btn" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-amber-500/30">
                                Ver Imagens
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lightbox para Visualizar Imagens -->
                <div id="image-lightbox" class="fixed inset-0 bg-black/95 backdrop-blur-sm z-[10002] hidden flex items-center justify-center p-4">
                    <div class="relative w-full h-full max-w-7xl max-h-[90vh] flex flex-col">
                        <!-- Botão Fechar -->
                        <button id="lightbox-close" class="absolute top-4 right-4 z-50 w-12 h-12 bg-gray-900/80 hover:bg-gray-800 rounded-full flex items-center justify-center text-white transition-all shadow-lg">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Navegação Anterior -->
                        <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 z-50 w-12 h-12 bg-gray-900/80 hover:bg-gray-800 rounded-full flex items-center justify-center text-white transition-all shadow-lg">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Navegação Próxima -->
                        <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 z-50 w-12 h-12 bg-gray-900/80 hover:bg-gray-800 rounded-full flex items-center justify-center text-white transition-all shadow-lg">
                            <i data-lucide="chevron-right" class="w-6 h-6"></i>
                        </button>
                        
                        <!-- Contador -->
                        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-50 bg-gray-900/80 px-4 py-2 rounded-full text-white text-sm font-semibold">
                            <span id="lightbox-counter">1 / 1</span>
                        </div>
                        
                        <!-- Imagem -->
                        <div class="flex-1 flex items-center justify-center p-8">
                            <img id="lightbox-image" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
                        </div>
                        
                        <!-- Informações -->
                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-50 bg-gray-900/80 px-6 py-3 rounded-lg text-white text-sm max-w-2xl text-center">
                            <p id="lightbox-info" class="font-semibold">Cena 1</p>
                        </div>
                    </div>
                </div>

                <!-- Modal de Seleção de Agente -->
                <div id="select-agent-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center">
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border-2 border-blue-500 rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-white">Selecionar Agente e Roteiro</h3>
                            <button onclick="closeAgentModal()" class="text-gray-400 hover:text-white">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto">
                            <div id="agents-list" class="space-y-3">
                                <p class="text-gray-400 text-center py-8">Carregando agentes...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    @keyframes shimmer {
                        0% { background-position: -200% 0; }
                        100% { background-position: 200% 0; }
                    }
                    .animate-shimmer {
                        animation: shimmer 2s infinite;
                    }
                </style>

                <!-- Seção 1: Gerar Prompts de Cena -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-white mb-4">📝 Passo 1: Gerar Prompts de Cena</h2>
                    <p class="text-gray-400 mb-6">Cole o seu roteiro completo e gere prompts otimizados para cada cena do vídeo.</p>
                    
                    <form id="scene-prompts-form" class="space-y-4">
                        <div>
                            <label for="scene-script-text" class="block text-sm font-medium text-gray-300 mb-2">Roteiro Completo</label>
                            <textarea id="scene-script-text" rows="10" placeholder="Cole o roteiro completo aqui..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                            <div class="flex items-center justify-between mt-1">
                                <p class="text-xs text-gray-400" id="scene-word-count">0 palavras</p>
                                <button type="button" id="btn-import-last-script" class="text-xs px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded transition duration-200">
                                    Importar Roteiro do Agente
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="scene-generation-mode" class="block text-sm font-medium text-gray-300 mb-2">Modo de Geração</label>
                                <select id="scene-generation-mode" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="automatic">Geração Automática de Cenas</option>
                                    <option value="manual">Geração Manual por Palavras</option>
                                </select>
                            </div>
                            <div>
                                <label for="scene-model-select" class="block text-sm font-medium text-gray-300 mb-2">Modelo de IA</label>
                                <select id="scene-model-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                    <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Campo para modo manual -->
                        <div id="manual-mode-settings" class="hidden">
                            <div class="flex items-center gap-4">
                                <label for="scene-words-per-scene" class="block text-sm font-medium text-gray-300">Gerar a cada</label>
                                <input type="number" id="scene-words-per-scene" value="50" min="25" max="500" step="5" class="w-24 px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                <select id="scene-unit-select" class="w-32 px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <option value="words">palavras</option>
                                    <option value="seconds">segundos</option>
                                </select>
                            </div>
                        </div>

                        <!-- Estimativa de cenas -->
                        <div id="scene-estimate-box" class="bg-blue-900/30 border border-blue-700 rounded-lg p-4">
                            <p class="text-sm text-gray-300 mb-1">Total de cenas estimado:</p>
                            <p class="text-xs text-gray-400 mb-2">Baseado no número de palavras do roteiro</p>
                            <p class="text-2xl font-bold text-blue-400" id="estimated-scenes-count">0 cenas</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="scene-style-select" class="block text-sm font-medium text-gray-300 mb-2">Estilo da Cena</label>
                                <select id="scene-style-select" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                    <optgroup label="🎨 Estilos Realistas">
                                        <option value="photorealistic">📸 Foto Realista - Ultra HD, detalhes perfeitos</option>
                                        <option value="cinematic">🎬 Cinematográfico - Estilo Hollywood, dramático</option>
                                        <option value="documentary">📹 Documentário - Natural, autêntico</option>
                                        <option value="cinematic-narrative">🎭 Narrativa Cinematográfica - Storytelling visual</option>
                                    </optgroup>
                                    <optgroup label="🎨 Estilos Artísticos">
                                        <option value="anime">🌸 Anime - Estilo japonês animado</option>
                                        <option value="cartoon">🎨 Desenho Animado - Colorido e expressivo</option>
                                        <option value="cartoon-premium">✨ Cartoon Premium - Alta qualidade animada</option>
                                        <option value="fantasy">✨ Fantasia - Mágico e épico</option>
                                    </optgroup>
                                    <optgroup label="🎨 Estilos Minimalistas">
                                        <option value="stick-figure">👤 Desenho de Palitos - Simples e minimalista</option>
                                        <option value="whiteboard">📝 Quadro Branco - Explicativo e limpo</option>
                                        <option value="tech-minimalist">💻 Tech Minimalista - Moderno e clean</option>
                                        <option value="spiritual-minimalist">🧘 Narrativa Espiritual Minimalista - Sereno</option>
                                    </optgroup>
                                    <optgroup label="🎨 Estilos Vibrantes">
                                        <option value="viral-vibrant">🔥 Viral Vibrante - Alto contraste, cores intensas</option>
                                        <option value="modern-documentary">📺 Documentário Moderno - Dinâmico e atual</option>
                                    </optgroup>
                                    <optgroup label="🎨 Estilos Dramáticos">
                                        <option value="analog-horror">👻 Terror Analógico - Estética VHS, sombrio</option>
                                        <option value="dark-theater">🎪 Teatro Sombrio - Dramático e intenso</option>
                                        <option value="naturalist-drama">🎭 Drama Naturalista - Realista e emocional</option>
                                    </optgroup>
                                    <optgroup label="🎨 Estilos Experimentais 2025">
                                        <option value="cinematic-diorama">🎭 Diorama Cinematográfico Narrativo - Miniatura/maquete com iluminação cinematográfica</option>
                                        <option value="spiritual-neorealism">🌟 Neo-Realismo Espiritual - Transcendente</option>
                                        <option value="psychological-surrealism">🌀 Surrealismo Psicológico - Onírico</option>
                                        <option value="fragmented-memory">🧩 Memória Fragmentada - Narrativa quebrada</option>
                                        <option value="fragmented-narrative">📖 Narrativa Fragmentada - Estilo colagem</option>
                                        <option value="dream-real">💭 Sonho-Real - Limiar entre sonho e realidade</option>
                                        <option value="vhs-nostalgic">📼 VHS Nostálgico - Estética anos 80/90</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <!-- Personagens Consistentes -->
                        <div>
                            <label for="scene-characters" class="block text-sm font-medium text-gray-300 mb-2">Personagens Consistentes (Opcional)</label>
                            <textarea id="scene-characters" rows="3" placeholder="Ex: João, um homem de 40 anos, cabelo grisalho, óculos. Maria, uma jovem de 25, cabelo longo e ruivo." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"></textarea>
                            <button type="button" id="btn-detect-characters" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-medium transition duration-200">
                                Detectar Personagens (IA)
                            </button>
                        </div>

                        <!-- Checkbox para VO3 -->
                        <div class="flex items-center space-x-3 p-4 bg-gray-800/50 border border-gray-700 rounded-lg">
                            <input type="checkbox" id="scene-vo3-checkbox" name="isVO3" class="w-5 h-5 text-amber-600 bg-gray-700 border-gray-600 rounded focus:ring-amber-500 focus:ring-2">
                            <label for="scene-vo3-checkbox" class="text-sm font-medium text-gray-300 cursor-pointer">
                                <span class="font-semibold text-amber-400">🎬 Otimizar para VO3</span>
                                <span class="block text-xs text-gray-400 mt-1">Gera prompts otimizados para VO3 com SFX embutido e descrições de movimento</span>
                            </label>
                        </div>

                        <button type="submit" id="btn-generate-scene-prompts" class="w-full py-3 px-4 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition duration-300 flex items-center justify-center space-x-2">
                            <i data-lucide="sparkles"></i>
                            <span>Gerar Prompts de Cena</span>
                        </button>
                    </form>

                    <!-- Resultados dos Prompts -->
                    <div id="scene-prompts-results" class="mt-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Prompts Gerados</h3>
                            <button id="download-prompts-btn" class="px-4 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 shadow-lg shadow-amber-500/30 flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                Baixar Prompts
                            </button>
                        </div>
                        <div id="scene-prompts-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Seção 2: Gerar Todas as Imagens -->
                <div class="bg-gradient-to-r from-purple-900 to-pink-900 border border-purple-700 rounded-lg p-6 mb-6" id="generate-all-images-section" style="display: none;">
                    <h2 class="text-xl font-semibold text-white mb-4">🎨 Passo 2: Gerar Todas as Imagens</h2>
                    <p class="text-gray-300 mb-4">Gere todas as imagens para o seu vídeo com apenas 1 clique!</p>
                    
                    <div class="flex items-center justify-between bg-white/10 rounded-lg p-4 mb-4">
                        <div>
                            <p class="text-white font-semibold" id="total-prompts-count">0 prompts prontos</p>
                            <p class="text-gray-300 text-sm">Todas as imagens serão geradas automaticamente</p>
                        </div>
                        <button id="btn-generate-all-images" class="px-6 py-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm border-2 border-white/30 rounded-lg font-semibold text-white transition-all duration-200 flex items-center gap-2">
                            <i data-lucide="image"></i>
                            <span>Gerar Todas as Imagens</span>
                        </button>
                    </div>

                    <!-- Painel de Progresso (estilo DARKSCRIPT) -->
                    <div id="image-gen-progress-panel" class="bg-gray-800 border border-gray-700 rounded-lg p-4 mb-4" style="display: none;">
                        <!-- Conteúdo será inserido dinamicamente -->
                    </div>

                    <!-- Botões de Ação (estilo DARKSCRIPT) -->
                    <div id="imagefx-actions" class="mb-4 space-y-2" style="display: none;">
                        <div class="flex gap-2">
                            <button id="select-all-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-gray-700 text-gray-200 hover:bg-gray-600">
                                Selecionar Tudo
                            </button>
                            <button id="download-selected-images-btn" class="flex-1 text-center py-2 px-4 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-500">
                                Baixar Selecionadas
                            </button>
                        </div>
                        <button id="clear-all-images-btn" class="w-full text-center py-2 px-4 rounded-lg font-semibold bg-red-600 text-white hover:bg-red-500">
                            Limpar Imagens Geradas
                        </button>
                    </div>

                    <!-- Grid de Imagens Geradas (estilo DARKSCRIPT) -->
                    <div id="generated-images-output" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>
                    </div>
                </div>

                <!-- Seção 3: Histórico de Prompts -->
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
                    <h2 class="text-xl font-semibold text-white mb-4">📚 Histórico de Prompts Gerados</h2>
                    <p class="text-gray-400 mb-4">Visualize e reutilize prompts de cenas anteriores</p>
                    
                    <div id="scene-prompts-history" class="space-y-3">
                        <p class="text-gray-400">Carregando histórico...</p>
                    </div>
                </div>
            </div>

            <!-- VISÃO 9: Análise de Canais Virais -->
            <div id="view-viral-analysis" style="display: none;">
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <div class="mb-8">
                        <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">📊 Análise de Canais Virais</h1>
                        <p class="text-lg text-gray-400">Analise até 5 canais, identifique padrões virais e crie títulos baseados no que funcionou</p>
                    </div>

                    <!-- Adicionar Canal -->
                    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">➕ Adicionar Canal para Análise</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">URL do Canal</label>
                                <input type="text" id="viral-channel-url" placeholder="https://youtube.com/@canal ou https://youtube.com/channel/..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Nicho <span class="text-xs text-gray-500">(detectado após análise)</span></label>
                                <input type="text" id="viral-channel-niche" placeholder="Será detectado automaticamente após a análise..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 transition-colors" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Subnicho <span class="text-xs text-gray-500">(detectado após análise)</span></label>
                                <input type="text" id="viral-channel-subniche" placeholder="Será detectado automaticamente após a análise..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 transition-colors" readonly>
                            </div>
                            <div class="flex items-end">
                                <button id="btn-add-viral-channel" class="w-full py-3 px-6 bg-amber-600 hover:bg-amber-500 text-black font-bold rounded-lg transition">
                                    Adicionar Canal
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Você pode adicionar até 5 canais para análise simultânea. O nicho e subnicho serão detectados automaticamente após a análise do canal, trazendo informações mais precisas.</p>
                    </div>

                    <!-- Lista de Canais -->
                    <div id="viral-channels-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Canais serão inseridos aqui -->
                    </div>

                    <!-- Análise Detalhada -->
                    <div id="viral-analysis-detail" class="hidden">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 mb-6">
                            <h2 class="text-xl font-semibold text-white mb-4" id="viral-detail-title">Análise do Canal</h2>
                            
                            <!-- Informações do Canal -->
                            <div id="viral-channel-info" class="mb-6"></div>
                            
                            <!-- Top Vídeos -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4">🎬 Top Vídeos Mais Vistos</h3>
                                <div id="viral-top-videos" class="space-y-4"></div>
                            </div>
                            
                            <!-- Insights Virais -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4">💡 Insights Virais (IA)</h3>
                                <div id="viral-insights" class="space-y-4"></div>
                            </div>
                            
                            <!-- Cruzamento de Análises -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4">🔀 Cruzar Análises de Canais</h3>
                                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                    <p class="text-gray-300 text-sm mb-4">Selecione múltiplos canais analisados para cruzar informações e gerar conteúdo inédito viral baseado nos padrões identificados.</p>
                                    <button onclick="window.showCrossAnalysisModal()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded font-semibold flex items-center gap-2">
                                        <i data-lucide="git-branch" class="w-4 h-4"></i>
                                        Cruzar Análises e Gerar Conteúdo Viral
                                    </button>
                                </div>
                                <div id="cross-analysis-results" class="space-y-4"></div>
                            </div>
                            
                            <!-- Recomendações -->
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-white mb-4">🎯 Recomendações e Títulos Sugeridos</h3>
                                <div id="viral-recommendations"></div>
                            </div>
                            
                            <!-- Insights para Novo Canal -->
                            <div id="viral-new-channel-insights-section" class="mb-6" style="display: none;">
                                <h3 class="text-lg font-semibold text-white mb-4">🚀 Insights para Criar Novo Canal</h3>
                                <div id="viral-new-channel-insights" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISÃO 10: Configurações -->
            <div id="view-configuracoes" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Configurações</h1>
                    <p class="text-lg text-gray-400">Gerencie as suas chaves de API para habilitar as ferramentas da plataforma.</p>
                </header>
                
                <div id="config-success-message" class="success-message mb-6"></div>
                <div id="config-error-message" class="error-message mb-6"></div>

                <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 md:p-8">
                    <form id="config-form" class="space-y-6 max-w-2xl mx-auto">
                        
                        <h2 class="text-xl font-semibold text-white">Chaves de API de Texto (Obrigatório)</h2>
                        <p class="text-sm text-gray-400 -mt-4">As suas chaves são salvas de forma segura e encriptada.</p>

                        <!-- Mensagem de bloqueio para planos não Master/Anuais -->
                        <div id="api-keys-premium-message" class="hidden bg-amber-900/20 border border-amber-700/50 rounded-lg p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <i data-lucide="lock" class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="text-amber-300 font-semibold mb-2">🔒 Chaves de API Próprias - Recurso Premium</p>
                                    <p class="text-gray-300 text-sm mb-3">
                                        Para usar suas próprias chaves de API (Claude, Gemini, OpenAI), você precisa ter o plano <strong class="text-amber-400">MASTER</strong> ou qualquer plano <strong class="text-amber-400">ANUAL</strong>.
                                    </p>
                                    <button onclick="window.location.href='/plans.html#pacotes'" class="px-4 py-2 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-black font-semibold rounded-lg transition-all duration-250 shadow-lg shadow-amber-500/30 hover:shadow-amber-500/50 hover:-translate-y-0.5">
                                        <i data-lucide="arrow-up" class="w-4 h-4 inline mr-2"></i>
                                        Fazer Upgrade Agora
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="key-claude" class="block text-sm font-medium mb-2">Claude AI API Key (Preferencial)</label>
                            <div class="relative">
                                <input type="password" id="key-claude" placeholder="Cole a sua chave (sk-ant-...)" class="w-full px-4 py-3 pr-12 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" disabled>
                                <button type="button" id="toggle-key-claude" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" disabled>
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <p id="key-claude-locked" class="hidden text-xs text-amber-400 mt-1">🔒 Disponível apenas para planos MASTER ou ANUAIS</p>
                        </div>

                        <div>
                            <label for="key-gemini" class="block text-sm font-medium mb-2">Gemini API Key</label>
                            <div class="relative">
                                <input type="password" id="key-gemini" placeholder="Cole a sua chave (AI...)" class="w-full px-4 py-3 pr-12 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" disabled>
                                <button type="button" id="toggle-key-gemini" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" disabled>
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <p id="key-gemini-locked" class="hidden text-xs text-amber-400 mt-1">🔒 Disponível apenas para planos MASTER ou ANUAIS</p>
                        </div>

                        <div>
                            <label for="key-openai" class="block text-sm font-medium mb-2">OpenAI (GPT) API Key</label>
                            <div class="relative">
                                <input type="password" id="key-openai" placeholder="Cole a sua chave (sk-...)" class="w-full px-4 py-3 pr-12 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" disabled>
                                <button type="button" id="toggle-key-openai" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors" disabled>
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <p id="key-openai-locked" class="hidden text-xs text-amber-400 mt-1">🔒 Disponível apenas para planos MASTER ou ANUAIS</p>
                        </div>

                        <div>
                            <label for="key-youtube" class="block text-sm font-medium mb-2">YouTube Data API v3 Key</label>
                            <div class="relative">
                                <input type="password" id="key-youtube" placeholder="Cole a sua chave do YouTube Data API v3 (AIza...)" class="w-full px-4 py-3 pr-12 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                                <button type="button" id="toggle-key-youtube" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Necessária para buscar dados de vídeos do YouTube. Obtenha em: <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-amber-500 hover:text-amber-400 underline">Google Cloud Console</a></p>
                        </div>

                        <hr class="border-gray-700">

                        <h2 class="text-xl font-semibold text-white">Configurações de Midia (Opcional)</h2>
                        <div>
                            <label for="key-imagefx" class="block text-sm font-medium mb-2">ImageFX Cookies (JSON)</label>
                            <textarea id="key-imagefx" rows="4" placeholder="Cole o JSON dos cookies aqui..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent" style="font-family: monospace;"></textarea>
                        </div>


                        <hr class="border-gray-700">

                        <h2 class="text-xl font-semibold text-white">Preferências de Uso</h2>
                        <div class="bg-blue-900/20 border border-blue-700 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <input type="checkbox" id="pref-use-credits" class="mt-1 w-5 h-5 bg-gray-800 border-gray-700 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                                <div class="flex-1">
                                    <label for="pref-use-credits" class="block text-sm font-medium text-white mb-1">
                                        Usar créditos mesmo tendo API própria
                                    </label>
                                    <p class="text-xs text-gray-400">
                                        Se marcado, o sistema usará seus créditos ao invés das suas chaves de API quando ambas estiverem disponíveis.
                                    </p>
                                    <div id="pref-status-message" class="mt-2 text-sm text-blue-300 hidden">
                                        <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="border-gray-700">

                        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                            <button type="submit" id="btn-save-all" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black flex-1">
                                <span class="btn-text">Salvar Configurações</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                            <button type="button" id="btn-validate-all" class="py-3 px-4 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white flex-1">
                                <span class="btn-text">Validar APIs</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            
            <!-- VISÃO 7: Painel Admin (Oculto) -->
            <div id="view-admin" style="display: none;">
                <header class="mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Painel Administrativo</h1>
                    <p class="text-lg text-gray-400">Gerir utilizadores, créditos e APIs da aplicação.</p>
                </header>
                
                <div id="admin-success-message" class="success-message mb-6"></div>
                <div id="admin-error-message" class="error-message mb-6"></div>
            
                <!-- Sistema de Abas -->
                <div class="mb-6 border-b border-gray-700">
                    <nav class="flex space-x-1 overflow-x-auto">
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors active" data-tab="users">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                            Utilizadores
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="credits">
                            <i data-lucide="coins" class="w-4 h-4 inline mr-2"></i>
                            Créditos
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="apis">
                            <i data-lucide="key" class="w-4 h-4 inline mr-2"></i>
                            APIs
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="pixel">
                            <i data-lucide="target" class="w-4 h-4 inline mr-2"></i>
                            Pixel/Ads
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="payments">
                            <i data-lucide="credit-card" class="w-4 h-4 inline mr-2"></i>
                            Pagamentos
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="subscriptions">
                            <i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i>
                            Assinaturas
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="storage">
                            <i data-lucide="hard-drive" class="w-4 h-4 inline mr-2"></i>
                            Armazenamento
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="notifications">
                            <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i>
                            Notificações
                        </button>
                        <button class="admin-tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-600 transition-colors" data-tab="plan-permissions">
                            <i data-lucide="shield" class="w-4 h-4 inline mr-2"></i>
                            Permissões de Planos
                        </button>
                    </nav>
                </div>

                <!-- Aba: Utilizadores -->
                <div id="admin-tab-users" class="admin-tab-content space-y-8">
                    <!-- Estatisticas da Aplicacao -->
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-4">Estatisticas da Aplicacao</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Total de Utilizadores</p>
                                <p id="stats-total-users" class="text-3xl font-bold text-white mt-1">...</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Ativacao Pendente</p>
                                <p id="stats-pending-users" class="text-3xl font-bold text-yellow-400 mt-1">...</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Online Agora (15min)</p>
                                <p id="stats-online-users" class="text-3xl font-bold text-green-400 mt-1">...</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-5">
                                <p class="text-sm text-gray-400">Logins (24h)</p>
                                <p id="stats-logins-24h" class="text-3xl font-bold text-white mt-1">...</p>
                            </div>
                        </div>
                        <button id="btn-approve-all" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                            Aprovar Todos os Utilizadores Pendentes
                        </button>
                    </div>
            
                    <!-- Gerenciamento de Utilizadores -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">Gerenciamento de Utilizadores</h2>
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <input id="admin-search-input" type="search" placeholder="Buscar por email, whatsapp ou nome..." class="w-full md:w-1/3 px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="flex items-center gap-4">
                                <select id="admin-status-filter" class="styled-select px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Todos</option>
                                    <option value="active">Ativos</option>
                                    <option value="pending">Pendentes</option>
                                    <option value="blocked">Bloqueados</option>
                                </select>
                                <select class="styled-select px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option>10 por pagina</option>
                                    <option>25 por pagina</option>
                                    <option>50 por pagina</option>
                                </select>
                            </div>
                        </div>
            
                        <div class="overflow-x-auto rounded-lg border border-gray-700">
                            <table id="admin-user-table" class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 w-4"><input type="checkbox" class="bg-gray-700 border-gray-600 rounded"></th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Email</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Whatsapp</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Cargo</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Plano</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Tags</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Acoes</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-table-body">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex justify-end items-center mt-4">
                            <nav class="flex items-center space-x-2 text-sm">
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">Anterior</a>
                                <a href="#" class="px-3 py-1 rounded-md bg-blue-600 text-white">1</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">2</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">3</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">4</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">5</a>
                                <a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700">Proximo</a>
                            </nav>
                        </div>
                    </div>
                </div>
                </div>

                <!-- Aba: Créditos -->
                <div id="admin-tab-credits" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- 1. Configurações Globais -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">⚙️ Configurações Globais</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Saldo Inicial (créditos dados automaticamente a novos usuários)</label>
                                <input type="number" id="initial-bonus-credits" step="0.01" min="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 250">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Multiplicador de Custo para Geração de Voz (TTS)</label>
                                <input type="number" id="tts-credits-multiplier" step="0.1" min="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 2.0">
                                <p class="text-xs text-gray-400 mt-1">Ex: 2.0 = dobra o custo, 0.5 = metade do custo.</p>
                            </div>
                            <button id="save-global-settings" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                Salvar Configurações
                            </button>
                        </div>
                    </div>

                    <!-- 2. Consultar Saldo -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🔍 Consultar Saldo</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Buscar por Email, Nome ou WhatsApp</label>
                                <input type="text" id="consult-balance-search" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: usuario@email.com, nome ou 5511999999999">
                            </div>
                            <button id="consult-balance-btn" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                Ver Saldo
                            </button>
                            <div id="consult-balance-result" class="hidden mt-4 p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <p class="text-white font-semibold" id="consult-balance-user-info"></p>
                                <p class="text-yellow-400 text-2xl font-bold mt-2" id="consult-balance-amount"></p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Buscar Usuários -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">👥 Buscar Usuários</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Buscar por Email, Nome ou WhatsApp</label>
                                <input type="text" id="search-users-input" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Digite para buscar usuários...">
                            </div>
                            <button id="search-users-btn" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                Buscar Usuários
                            </button>
                            <div id="search-users-results" class="mt-4 hidden">
                                <!-- Resultados da busca serão inseridos aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- 4. Adicionar Créditos (Individual) -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">➕ Adicionar Créditos (Individual)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Buscar Usuário (Email, Nome ou WhatsApp)</label>
                                <input type="text" id="add-credits-user-search" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Digite para buscar...">
                                <div id="add-credits-user-results" class="mt-2 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Quantidade de Créditos</label>
                                <input type="number" id="add-credits-amount" step="0.01" min="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 1000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Descrição (opcional)</label>
                                <input type="text" id="add-credits-description" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: Bônus inicial">
                            </div>
                            <button id="add-credits-btn" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                Adicionar Créditos
                            </button>
                        </div>
                    </div>

                    <!-- 5. Usuários com Saldo Disponível -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-white">💰 Usuários com Saldo Disponível</h2>
                            <button id="refresh-credits-table" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition">
                                Atualizar
                            </button>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Saldo Mínimo</label>
                            <input type="number" id="min-balance-filter" step="0.01" min="0" value="0" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 w-4"><input type="checkbox" id="select-all-users" class="bg-gray-700 border-gray-600 rounded"></th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">EMAIL</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">WHATSAPP</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">TAGS</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">SALDO</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">ÚLTIMA ATUALIZAÇÃO</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-credits-table-body">
                                    <tr>
                                        <td colspan="7" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Paginação -->
                        <div class="flex justify-end items-center mt-4">
                            <nav class="flex items-center space-x-2 text-sm" id="credits-pagination">
                                <!-- Paginação será inserida aqui -->
                            </nav>
                        </div>
                    </div>

                    <!-- 6. Estatísticas e Relatórios de Créditos -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📊 Estatísticas e Relatórios de Créditos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Data Inicial</label>
                                <input type="date" id="stats-start-date" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Data Final</label>
                                <input type="date" id="stats-end-date" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button id="load-statistics-btn" class="flex-1 px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition">
                                Carregar Estatísticas
                            </button>
                            <button id="export-credits-btn" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                Exportar
                            </button>
                        </div>
                        <div id="statistics-results" class="mt-6 hidden">
                            <!-- Resultados das estatísticas serão inseridos aqui -->
                        </div>
                    </div>
                </div>

                <!-- Aba: APIs -->
                <div id="admin-tab-apis" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configuração de Voz Premium (GenAIPro) - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🎙️ Configuração de Voz Premium</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API</label>
                                <div class="flex gap-2">
                                    <input type="text" id="voice-premium-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API aqui">
                                    <button id="check-voice-premium-balance" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Verificar Saldo
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Após verificar o saldo, você poderá salvar a chave e adicionar créditos aos usuários.</p>
                                <div id="voice-premium-balance-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-400">Saldo Disponível</p>
                                            <p class="text-2xl font-bold text-yellow-400 mt-1" id="voice-premium-balance-amount">0.00</p>
                                        </div>
                                        <button id="save-voice-premium-api" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                            Salvar Chave
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> Após salvar a chave, você poderá adicionar saldo aos usuários através do sistema de créditos.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuração de Chave de Voz OpenAI - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🗣️ Configuração de Chave de Voz OpenAI</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API OpenAI</label>
                                <div class="flex gap-2">
                                    <input type="text" id="openai-voice-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API OpenAI aqui">
                                    <button id="validate-openai-voice-api-key" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Validar
                                    </button>
                                    <button id="save-openai-voice-api-key" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar Chave
                                    </button>
                                </div>
                                <div id="openai-voice-api-key-validation-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div id="openai-voice-api-key-validation-message" class="text-sm"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Use esta chave para gerar vozes com a API OpenAI. Se configurada aqui, será usada automaticamente quando o provider de voz for "OpenAI".</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuração de API de Vídeo (Gemini/Veo) - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🎥 Configuração de API de Vídeo (Gemini/Veo)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API para Vídeo</label>
                                <div class="flex gap-2">
                                    <input type="text" id="video-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave do Gemini (Veo) aqui">
                                    <button id="validate-video-api-key" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Validar
                                    </button>
                                    <button id="save-video-api-key" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar Chave
                                    </button>
                                </div>
                                <div id="video-api-key-validation-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div id="video-api-key-validation-message" class="text-sm"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Esta chave será usada para gerar vídeos com o modelo Veo quando o usuário preferir usar API própria. Caso não configure, será usada a chave do usuário ou o provedor externo quando disponível.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuração de Chave de Voz (Google Cloud/Gemini) - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🎤 Configuração de Chave de Voz</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API para Voz (Google Cloud/Gemini)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="voice-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API do Google Cloud ou Gemini aqui">
                                    <button id="validate-voice-api-key" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Validar
                                    </button>
                                    <button id="save-voice-api-key" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar Chave
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Esta chave será usada prioritariamente para TTS quando o usuário escolher usar API própria do Gemini. Se não configurada, será usada a chave do usuário.</p>
                                <div id="voice-api-key-validation-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div id="voice-api-key-validation-message" class="text-sm"></div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> Esta chave é usada quando o usuário seleciona "Gemini" como provider de voz e tem preferência para usar API própria. Se configurada aqui, será usada ao invés da chave do usuário.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuração de API DownSub - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📝 Configuração de API DownSub (Transcrições)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API DownSub</label>
                                <div class="flex gap-2">
                                    <input type="text" id="downsub-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API do DownSub aqui">
                                    <button id="check-downsub-api" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Verificar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Configure a chave de API do DownSub para carregar transcrições de vídeos do YouTube e outros sites suportados.</p>
                                <div id="downsub-api-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-400">Status da API</p>
                                            <p class="text-lg font-bold text-green-400 mt-1" id="downsub-api-status">Válida</p>
                                            <p class="text-xs text-gray-400 mt-1" id="downsub-api-credits"></p>
                                        </div>
                                        <button id="save-downsub-api" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                            Salvar Chave
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> A API DownSub permite obter transcrições de vídeos do YouTube e outros sites suportados. Cada chamada bem-sucedida consome 1 crédito. Os créditos são renovados mensalmente no plano Pro (2000 créditos/mês).
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuração de DarkVoz - APENAS NO PAINEL ADMIN -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🤖 Configuração de DarkVoz</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave de API</label>
                                <div class="flex gap-2">
                                    <input type="text" id="laozhang-api-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole sua chave de API do DarkVoz aqui">
                                    <button id="check-laozhang-api" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        Verificar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Configure a chave de API do DarkVoz para usar os serviços disponíveis na plataforma.</p>
                                <div id="laozhang-api-result" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-400">Status da API</p>
                                            <p class="text-lg font-bold text-green-400 mt-1" id="laozhang-api-status">Válida</p>
                                        </div>
                                        <button id="save-laozhang-api" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                            Salvar Chave
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="laozhang-use-as-default" class="w-5 h-5 bg-gray-800 border-gray-700 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                                    <div>
                                        <span class="text-sm font-medium text-gray-300">Usar DarkVoz como padrão para todas as funções</span>
                                        <p class="text-xs text-gray-400 mt-1">Quando ativado, todas as chamadas de IA usarão o DarkVoz, independente das preferências do usuário.</p>
                                    </div>
                                </label>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> A chave do DarkVoz será usada para acessar as APIs disponíveis na plataforma La Casa Dark Core. Ative a opção acima para usar como padrão em todas as funções.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gerenciamento de Outras APIs -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-white">Gerenciamento de APIs</h2>
                            <button id="btn-add-api" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                                Adicionar API
                            </button>
                        </div>

                        <!-- Lista de APIs -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Nome</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Modelo</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Créditos/Unidade</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-apis-table-body">
                                    <tr>
                                        <td colspan="5" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Aba: Pixel/Ads -->
                <div id="admin-tab-pixel" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configuração de Facebook Pixel -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📊 Facebook Pixel</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Pixel ID do Facebook</label>
                                <div class="flex gap-2">
                                    <input type="text" id="facebook-pixel-id" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 1234567890123456">
                                    <button id="save-facebook-pixel" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Encontre seu Pixel ID no Gerenciador de Eventos do Facebook. Formato: 15-16 dígitos numéricos.</p>
                                <div id="facebook-pixel-status" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                                        <span class="text-sm text-green-400">Pixel configurado com sucesso!</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> O Facebook Pixel permite rastrear conversões e otimizar campanhas. Configure o Pixel ID para começar a rastrear eventos na plataforma.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuração de Google Ads -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🎯 Google Ads (Conversion Tracking)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">ID de Conversão do Google Ads</label>
                                <div class="flex gap-2">
                                    <input type="text" id="google-ads-id" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: AW-123456789">
                                    <button id="save-google-ads" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Encontre seu ID de conversão no Google Ads. Formato: AW- seguido de números.</p>
                                <div id="google-ads-status" class="mt-3 hidden p-4 bg-gray-900 rounded-lg border border-gray-700">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
                                        <span class="text-sm text-green-400">Google Ads configurado com sucesso!</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> Configure o ID de conversão para rastrear assinaturas e conversões de planos na plataforma.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Status Geral -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📈 Status de Rastreamento</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Facebook Pixel</span>
                                    <span id="facebook-pixel-status-badge" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">Não configurado</span>
                                </div>
                                <p id="facebook-pixel-id-display" class="text-sm text-gray-500 mt-1">-</p>
                            </div>
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Google Ads</span>
                                    <span id="google-ads-status-badge" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">Não configurado</span>
                                </div>
                                <p id="google-ads-id-display" class="text-sm text-gray-500 mt-1">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuração de Webhook WhatsApp -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📱 Webhook WhatsApp (Mensagens Automáticas)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Token de Acesso do WhatsApp Business API</label>
                                <div class="flex gap-2">
                                    <input type="password" id="whatsapp-token" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Cole seu token aqui">
                                    <button id="toggle-whatsapp-token" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button id="save-whatsapp-token" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Token de acesso da API do WhatsApp Business. Configure para enviar mensagens automáticas.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Número do WhatsApp Business (ID)</label>
                                <input type="text" id="whatsapp-number-id" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 123456789012345">
                                <p class="text-xs text-gray-400 mt-1">ID do número de telefone do WhatsApp Business.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">URL do Webhook (para receber eventos)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="whatsapp-webhook-url" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" value="/api/whatsapp/webhook" readonly>
                                    <button id="copy-webhook-url" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="copy" class="w-4 h-4 inline mr-2"></i>
                                        Copiar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Configure esta URL no painel do WhatsApp Business para receber eventos.</p>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> Configure o webhook do WhatsApp para enviar mensagens automáticas quando usuários se registram, cancelam planos ou fazem compras.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Templates de Email -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📧 Templates de Email Automático</h2>
                        <div class="space-y-6">
                            <!-- Template: Registro -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Bem-vindo (Registro)</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-register-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Bem-vindo à La Casa Dark Core!" value="Bem-vindo à La Casa Dark Core!">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-register-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Olá {{nome}},

Bem-vindo à La Casa Dark Core! Estamos muito felizes em tê-lo conosco.

Sua conta foi criada com sucesso e você já pode começar a usar todas as funcionalidades da plataforma.

Seus créditos iniciais: {{creditos_iniciais}}

Acesse sua conta: {{link_acesso}}

Qualquer dúvida, estamos à disposição!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Variáveis disponíveis: {{nome}}, {{email}}, {{creditos_iniciais}}, {{link_acesso}}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('register')">
                                            Salvar Template
                                        </button>
                                        <button class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition" onclick="testEmailTemplate('register')" title="Enviar email de teste">
                                            <i data-lucide="mail" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Template: Cancelamento -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Cancelamento de Plano</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-cancel-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Sua assinatura foi cancelada" value="Sua assinatura foi cancelada">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-cancel-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Olá {{nome}},

Recebemos sua solicitação de cancelamento da assinatura {{plano}}.

Sua assinatura será cancelada em: {{data_cancelamento}}

Você continuará tendo acesso até: {{data_fim_acesso}}

Esperamos vê-lo novamente em breve!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Variáveis disponíveis: {{nome}}, {{email}}, {{plano}}, {{data_cancelamento}}, {{data_fim_acesso}}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('cancel')">
                                            Salvar Template
                                        </button>
                                        <button class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition" onclick="testEmailTemplate('cancel')" title="Enviar email de teste">
                                            <i data-lucide="mail" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Template: Pagamento -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Confirmação de Pagamento</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-payment-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Pagamento confirmado!" value="Pagamento confirmado!">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-payment-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Olá {{nome}},

Seu pagamento foi confirmado com sucesso!

Detalhes da transação:
- Plano: {{plano}}
- Valor: {{valor}}
- Data: {{data_pagamento}}
- Próxima cobrança: {{proxima_cobranca}}

Obrigado por confiar em nós!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Variáveis disponíveis: {{nome}}, {{email}}, {{plano}}, {{valor}}, {{data_pagamento}}, {{proxima_cobranca}}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('payment')">
                                            Salvar Template
                                        </button>
                                        <button class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition" onclick="testEmailTemplate('payment')" title="Enviar email de teste">
                                            <i data-lucide="mail" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Template: Compra de Pacote -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Compra de Pacote de Créditos</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-package-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Pacote de créditos adquirido!" value="Pacote de créditos adquirido!">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-package-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Olá {{nome}},

Seu pacote de créditos foi adquirido com sucesso!

Detalhes da compra:
- Pacote: {{pacote}}
- Créditos: {{creditos}}
- Valor: {{valor}}
- Data: {{data_compra}}
- Saldo atual: {{saldo_atual}}

Aproveite seus créditos!

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Variáveis disponíveis: {{nome}}, {{email}}, {{pacote}}, {{creditos}}, {{valor}}, {{data_compra}}, {{saldo_atual}}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('package')">
                                            Salvar Template
                                        </button>
                                        <button class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition" onclick="testEmailTemplate('package')" title="Enviar email de teste">
                                            <i data-lucide="mail" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Template: Senha Provisória -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Senha Provisória</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Ativo</span>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Assunto do Email</label>
                                        <input type="text" id="email-template-password_reset-subject" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Sua senha provisória" value="Sua senha provisória - La Casa Dark Core">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Corpo do Email (HTML)</label>
                                        <textarea id="email-template-password_reset-body" rows="8" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 font-mono text-sm" placeholder="<html>...">Olá {{nome}},

Uma senha provisória foi gerada para sua conta.

Senha provisória: {{senha_provisoria}}

Por favor, altere esta senha após fazer login pela primeira vez.

Acesse sua conta: {{link_acesso}}

Equipe La Casa Dark Core</textarea>
                                        <p class="text-xs text-gray-400 mt-1">Variáveis disponíveis: {{nome}}, {{email}}, {{senha_provisoria}}, {{link_acesso}}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition" onclick="saveEmailTemplate('password_reset')">
                                            Salvar Template
                                        </button>
                                        <button class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition" onclick="testEmailTemplate('password_reset')" title="Enviar email de teste">
                                            <i data-lucide="mail" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Templates de Assinatura por Plano -->
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold text-white">Emails de Assinatura por Plano</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-700 text-white">Opcional</span>
                                </div>
                                <p class="text-sm text-gray-400 mb-4">Configure templates personalizados para cada plano. Se não configurar, será usado o template genérico de "Confirmação de Pagamento".</p>
                                
                                <div class="space-y-4">
                                    <!-- START CREATOR Mensal -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">START CREATOR (Mensal)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-start-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-start-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- TURBO MAKER Mensal -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">TURBO MAKER (Mensal)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-turbo-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-turbo-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- MASTER PRO Mensal -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">MASTER PRO (Mensal)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-master-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-master-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- START CREATOR Anual -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">START CREATOR (Anual)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-start-annual-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-start-annual-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- TURBO MAKER Anual -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">TURBO MAKER (Anual)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-turbo-annual-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-turbo-annual-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- MASTER PRO Anual -->
                                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                                        <h4 class="text-sm font-semibold text-white mb-2">MASTER PRO (Anual)</h4>
                                        <div class="space-y-2">
                                            <input type="text" id="email-template-subscription_plan-master-annual-subject" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" placeholder="Assunto (opcional)">
                                            <textarea id="email-template-subscription_plan-master-annual-body" rows="4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm font-mono" placeholder="Corpo HTML (opcional)"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition mt-4" onclick="saveAllSubscriptionTemplates()">
                                    Salvar Todos os Templates de Assinatura
                                </button>
                                <p class="text-xs text-gray-400 mt-2">Variáveis disponíveis: {{nome}}, {{email}}, {{plano}}, {{valor}}, {{data_pagamento}}, {{proxima_cobranca}}, {{creditos}}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuração de SMTP -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">⚙️ Configuração de SMTP (Envio de Emails)</h2>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Servidor SMTP</label>
                                    <input type="text" id="smtp-host" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: smtp.gmail.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Porta</label>
                                    <input type="number" id="smtp-port" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: 587" value="587">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Email de Envio</label>
                                <input type="email" id="smtp-email" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="noreply@lacasadarkcore.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Senha do Email</label>
                                <div class="flex gap-2">
                                    <input type="password" id="smtp-password" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Senha do email">
                                    <button id="toggle-smtp-password" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="smtp-secure" class="w-5 h-5 bg-gray-800 border-gray-700 rounded text-amber-500 focus:ring-amber-500 focus:ring-2">
                                    <span class="text-sm font-medium text-gray-300">Usar TLS/SSL</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="save-smtp-config" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                Salvar Configuração SMTP
                            </button>
                                <button id="test-smtp-config" class="w-full px-4 py-3 bg-amber-600 hover:bg-amber-700 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                    Enviar Email de Teste
                                </button>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> Configure o SMTP para enviar emails automáticos. Para Gmail, use uma senha de app. Para outros provedores, consulte a documentação.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Pagamentos (Stripe) -->
                <div id="admin-tab-payments" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configuração de Stripe -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">💳 Configuração do Stripe</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave Pública (Publishable Key)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="stripe-publishable-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: pk_live_... ou pk_test_...">
                                    <button id="save-stripe-publishable" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Chave pública do Stripe. Use pk_test_ para testes ou pk_live_ para produção.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Chave Secreta (Secret Key)</label>
                                <div class="flex gap-2">
                                    <input type="password" id="stripe-secret-key" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: sk_live_... ou sk_test_...">
                                    <button id="toggle-stripe-secret" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button id="save-stripe-secret" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Chave secreta do Stripe. Mantenha esta chave em segurança. Use sk_test_ para testes ou sk_live_ para produção.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Webhook Secret</label>
                                <div class="flex gap-2">
                                    <input type="password" id="stripe-webhook-secret" class="flex-1 px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: whsec_...">
                                    <button id="toggle-stripe-webhook" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button id="save-stripe-webhook" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        Salvar
                                    </button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Secret do webhook do Stripe para validar eventos. Configure o webhook no painel do Stripe apontando para: <code class="bg-gray-900 px-2 py-1 rounded">/api/stripe/webhook</code></p>
                            </div>
                            <div class="mt-4 p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">
                                    <strong>💡 Dica:</strong> Configure primeiro as chaves de API, depois configure os planos abaixo. O webhook é necessário para processar pagamentos recorrentes e atualizações de assinatura.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuração de Planos Stripe -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📦 Configuração de Planos</h2>
                        <p class="text-sm text-gray-400 mb-6">Configure os Price IDs do Stripe para cada plano. Crie os produtos e preços no painel do Stripe e cole os IDs aqui.</p>
                        
                        <!-- Planos Mensais -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Planos Mensais</h3>
                            <div class="space-y-4">
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">FREE</h4>
                                            <p class="text-sm text-gray-400">R$ 0,00 - 100 créditos/mês</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white">Gratuito</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe (opcional - para upgrades)</label>
                                        <input type="text" id="stripe-plan-free" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_... (deixe vazio se for gratuito)">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">START CREATOR</h4>
                                            <p class="text-sm text-gray-400">R$ 79,90 - 1.000 créditos/mês</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-start" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-amber-500 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">TURBO MAKER</h4>
                                            <p class="text-sm text-gray-400">R$ 99,90 - 2.500 créditos/mês</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-amber-500 text-black">MAIS POPULAR</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-turbo" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">MASTER PRO</h4>
                                            <p class="text-sm text-gray-400">R$ 149,90 - 5.000 créditos/mês</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-600 text-white">PRO</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-master" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Planos Anuais -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Planos Anuais</h3>
                            <div class="space-y-4">
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">START CREATOR ANUAL</h4>
                                            <p class="text-sm text-gray-400">R$ 699,00 - 12.000 créditos/ano</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-start-annual" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-amber-500 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">TURBO MAKER ANUAL</h4>
                                            <p class="text-sm text-gray-400">R$ 999,00 - 30.000 créditos/ano</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-amber-500 text-black">MAIS POPULAR</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-turbo-annual" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">MASTER PRO ANUAL</h4>
                                            <p class="text-sm text-gray-400">R$ 1.499,00 - 60.000 créditos/ano</p>
                                        </div>
                                        <span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-600 text-white">PRO</span>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-plan-master-annual" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pacotes de Créditos -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Pacotes de Créditos</h3>
                            <div class="space-y-4">
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">1.000 Créditos</h4>
                                            <p class="text-sm text-gray-400">R$ 79,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-1000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">2.500 Créditos</h4>
                                            <p class="text-sm text-gray-400">R$ 99,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-2500" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">5.000 Créditos</h4>
                                            <p class="text-sm text-gray-400">R$ 149,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-5000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">10.000 Créditos</h4>
                                            <p class="text-sm text-gray-400">R$ 249,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-10000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>

                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <h4 class="font-semibold text-white">20.000 Créditos</h4>
                                            <p class="text-sm text-gray-400">R$ 399,90</p>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price ID do Stripe</label>
                                        <input type="text" id="stripe-package-20000" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="price_...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="save-all-stripe-plans" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Salvar Todas as Configurações de Planos
                        </button>
                    </div>

                    <!-- Status do Stripe -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">🔐 Status da Configuração</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Chave Pública</span>
                                    <span id="stripe-publishable-status" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">Não configurado</span>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Chave Secreta</span>
                                    <span id="stripe-secret-status" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">Não configurado</span>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Webhook</span>
                                    <span id="stripe-webhook-status" class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">Não configurado</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Assinaturas -->
                <div id="admin-tab-subscriptions" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Filtros e Ações -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <div class="flex flex-col md:flex-row gap-4 items-end">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Período</label>
                                <select id="subscriptions-period-filter" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30" selected>Últimos 30 dias</option>
                                    <option value="90">Últimos 90 dias</option>
                                    <option value="365">Último ano</option>
                                    <option value="all">Todo o período</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Status</label>
                                <select id="subscriptions-status-filter" class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200">
                                    <option value="all">Todas</option>
                                    <option value="active">Ativas</option>
                                    <option value="canceled">Canceladas</option>
                                    <option value="past_due">Atrasadas</option>
                                    <option value="trialing">Em teste</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                            <button id="refresh-subscriptions" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2 shadow-lg hover:shadow-xl active:scale-95">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>Atualizar</span>
                            </button>
                                <button id="export-subscriptions" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Resumo Geral -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-4">📊 Resumo Geral</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Receita Total</span>
                                    <i data-lucide="dollar-sign" class="w-5 h-5 text-green-400"></i>
                                </div>
                                <p id="summary-total-revenue" class="text-2xl font-bold text-white">R$ 0,00</p>
                                <p class="text-xs text-gray-500 mt-1">Todas as receitas acumuladas</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Receita Mensal</span>
                                    <i data-lucide="calendar" class="w-5 h-5 text-blue-400"></i>
                                </div>
                                <p id="summary-monthly-revenue" class="text-2xl font-bold text-white">R$ 0,00</p>
                                <p class="text-xs text-gray-500 mt-1">Receita do mês atual</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Total de Assinaturas</span>
                                    <i data-lucide="users" class="w-5 h-5 text-purple-400"></i>
                                </div>
                                <p id="summary-total-subscriptions" class="text-2xl font-bold text-white">0</p>
                                <p class="text-xs text-gray-500 mt-1">Todas as assinaturas (ativas + canceladas)</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Taxa de Conversão</span>
                                    <i data-lucide="trending-up" class="w-5 h-5 text-amber-400"></i>
                                </div>
                                <p id="summary-conversion-rate" class="text-2xl font-bold text-white">0%</p>
                                <p class="text-xs text-gray-500 mt-1">Taxa de conversão em assinaturas</p>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas Principais (KPIs) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-800 border border-blue-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-blue-200 font-medium">MRR</span>
                                <i data-lucide="trending-up" class="w-5 h-5 text-blue-200"></i>
                            </div>
                            <p id="kpi-mrr" class="text-3xl font-bold text-white mb-2">R$ 0,00</p>
                            <div id="kpi-mrr-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-blue-300">Receita Recorrente Mensal</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-800 border border-green-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-green-200 font-medium">ARR</span>
                                <i data-lucide="dollar-sign" class="w-5 h-5 text-green-200"></i>
                            </div>
                            <p id="kpi-arr" class="text-3xl font-bold text-white mb-2">R$ 0,00</p>
                            <div id="kpi-arr-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-green-300">Receita Recorrente Anual</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-800 border border-purple-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-purple-200 font-medium">Assinantes Ativos</span>
                                <i data-lucide="users" class="w-5 h-5 text-purple-200"></i>
                            </div>
                            <p id="kpi-active-subscribers" class="text-3xl font-bold text-white mb-2">0</p>
                            <div id="kpi-active-subscribers-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-purple-300">Total de assinantes ativos</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-600 to-amber-800 border border-amber-500 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-amber-200 font-medium">Churn Rate</span>
                                <i data-lucide="alert-circle" class="w-5 h-5 text-amber-200"></i>
                            </div>
                            <p id="kpi-churn-rate" class="text-3xl font-bold text-white mb-2">0%</p>
                            <div id="kpi-churn-rate-change" class="text-sm mb-2 min-h-[20px] flex items-center">-</div>
                            <p class="text-xs text-amber-300">Taxa de cancelamento</p>
                        </div>
                    </div>

                    <!-- Métricas Secundárias e Mensais -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-blue-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Novos Assinantes</span>
                                <i data-lucide="user-plus" class="w-5 h-5 text-blue-400"></i>
                            </div>
                            <p id="kpi-new-subscribers" class="text-2xl font-bold text-white">0</p>
                            <p class="text-xs text-gray-500 mt-1">No período selecionado</p>
                        </div>
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-red-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Cancelamentos</span>
                                <i data-lucide="user-x" class="w-5 h-5 text-red-400"></i>
                            </div>
                            <p id="kpi-cancellations" class="text-2xl font-bold text-white">0</p>
                            <p class="text-xs text-gray-500 mt-1">No período selecionado</p>
                        </div>
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-green-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">LTV (Lifetime Value)</span>
                                <i data-lucide="briefcase" class="w-5 h-5 text-green-400"></i>
                            </div>
                            <p id="kpi-ltv" class="text-2xl font-bold text-white">R$ 0,00</p>
                            <p class="text-xs text-gray-500 mt-1">Valor médio por cliente</p>
                        </div>
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-purple-500 transition">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-400">Tempo Médio</span>
                                <i data-lucide="clock" class="w-5 h-5 text-purple-400"></i>
                            </div>
                            <p id="kpi-avg-duration" class="text-2xl font-bold text-white">0 dias</p>
                            <p class="text-xs text-gray-500 mt-1">Duração média das assinaturas</p>
                        </div>
                    </div>

                    <!-- Métricas Mensais Detalhadas -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4">📅 Análise Mensal</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Receita do Mês</span>
                                    <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i>
                                </div>
                                <p id="monthly-revenue" class="text-xl font-bold text-white">R$ 0,00</p>
                                <p class="text-xs text-gray-500 mt-1">Mês atual</p>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Novos (Mês)</span>
                                    <i data-lucide="arrow-up" class="w-4 h-4 text-green-400"></i>
                                </div>
                                <p id="monthly-new" class="text-xl font-bold text-white">0</p>
                                <p class="text-xs text-gray-500 mt-1">Novos assinantes este mês</p>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Cancelados (Mês)</span>
                                    <i data-lucide="arrow-down" class="w-4 h-4 text-red-400"></i>
                                </div>
                                <p id="monthly-canceled" class="text-xl font-bold text-white">0</p>
                                <p class="text-xs text-gray-500 mt-1">Cancelamentos este mês</p>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Crescimento</span>
                                    <i data-lucide="trending-up" class="w-4 h-4 text-amber-400"></i>
                                </div>
                                <p id="monthly-growth" class="text-xl font-bold text-white">0%</p>
                                <p class="text-xs text-gray-500 mt-1">Crescimento mensal</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Gráfico MRR ao longo do tempo -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">MRR ao Longo do Tempo</h3>
                            <div class="w-full" style="height: 400px; position: relative;">
                                <canvas id="mrr-chart" style="max-height: 400px;"></canvas>
                            </div>
                        </div>
                        <!-- Gráfico de Assinantes -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">Evolução de Assinantes</h3>
                            <div class="w-full" style="height: 400px; position: relative;">
                                <canvas id="subscribers-chart" style="max-height: 400px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Gráfico de Distribuição por Plano -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 overflow-hidden">
                            <h3 class="text-lg font-semibold text-white mb-4">Distribuição por Plano</h3>
                            <div class="relative" style="height: 300px; overflow: hidden;">
                                <canvas id="plans-distribution-chart"></canvas>
                            </div>
                        </div>
                        <!-- Gráfico de Churn Rate -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 overflow-hidden">
                            <h3 class="text-lg font-semibold text-white mb-4">Churn Rate Mensal</h3>
                            <div class="relative" style="height: 300px; overflow: hidden;">
                                <canvas id="churn-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Assinaturas -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Lista de Assinaturas</h3>
                            <div class="flex gap-2">
                                <input type="text" id="subscriptions-search" placeholder="Buscar por email ou nome..." class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 text-sm">
                                <button id="export-subscriptions" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition text-sm">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Usuário</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Plano</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Valor Mensal</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Início</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Próxima Cobrança</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Duração</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Total Pago</th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptions-table-body">
                                    <tr>
                                        <td colspan="8" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Paginação -->
                        <div class="flex justify-end items-center mt-4">
                            <nav class="flex items-center space-x-2 text-sm" id="subscriptions-pagination">
                                <!-- Paginação será inserida aqui -->
                            </nav>
                        </div>
                    </div>

                    <!-- Relatórios e Análises -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Relatório de Receitas -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">💰 Relatório de Receitas</h3>
                                <button id="export-revenue-report" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                                    Exportar
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita Total Acumulada</span>
                                    <span id="report-total-revenue" class="text-lg font-bold text-white">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita dos Últimos 30 Dias</span>
                                    <span id="report-30d-revenue" class="text-lg font-bold text-green-400">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita dos Últimos 90 Dias</span>
                                    <span id="report-90d-revenue" class="text-lg font-bold text-blue-400">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Receita do Ano</span>
                                    <span id="report-year-revenue" class="text-lg font-bold text-purple-400">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Ticket Médio</span>
                                    <span id="report-avg-ticket" class="text-lg font-bold text-amber-400">R$ 0,00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Relatório de Assinaturas -->
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">📊 Relatório de Assinaturas</h3>
                                <button id="export-subscriptions-report" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">
                                    <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                                    Exportar
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Total de Assinaturas</span>
                                    <span id="report-total-subs" class="text-lg font-bold text-white">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Assinaturas Ativas</span>
                                    <span id="report-active-subs" class="text-lg font-bold text-green-400">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Assinaturas Canceladas</span>
                                    <span id="report-canceled-subs" class="text-lg font-bold text-red-400">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Taxa de Retenção</span>
                                    <span id="report-retention-rate" class="text-lg font-bold text-blue-400">0%</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                    <span class="text-sm text-gray-400">Taxa de Churn</span>
                                    <span id="report-churn-rate" class="text-lg font-bold text-amber-400">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights e Análises -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">💡 Insights e Análises</h3>
                        <div id="subscriptions-insights" class="space-y-4">
                            <div class="p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
                                <p class="text-sm text-blue-300">Carregando insights...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Armazenamento -->
                <div id="admin-tab-storage" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Estatísticas do Servidor -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                            <i data-lucide="server" class="w-6 h-6 mr-2 text-indigo-500"></i>
                            Estatísticas do Servidor
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Espaço Total</span>
                                    <i data-lucide="hard-drive" class="w-5 h-5 text-blue-400"></i>
                                </div>
                                <p id="server-total-space" class="text-2xl font-bold text-white">0 GB</p>
                                <p class="text-xs text-gray-500 mt-1">Capacidade total do servidor</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Espaço Usado (Usuários)</span>
                                    <i data-lucide="database" class="w-5 h-5 text-yellow-400"></i>
                                </div>
                                <p id="server-users-storage" class="text-2xl font-bold text-white">0 GB</p>
                                <p class="text-xs text-gray-500 mt-1">Total usado por todos os usuários</p>
                            </div>
                            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Arquivos Temporários</span>
                                    <i data-lucide="folder" class="w-5 h-5 text-green-400"></i>
                                </div>
                                <p id="server-temp-storage" class="text-2xl font-bold text-white">0 MB</p>
                                <p class="text-xs text-gray-500 mt-1">Pasta temp_audio</p>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Usuários e Armazenamento -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-white flex items-center">
                                <i data-lucide="users" class="w-5 h-5 mr-2 text-indigo-500"></i>
                                Armazenamento por Usuário
                            </h2>
                            <div class="flex gap-2">
                                <input type="text" id="storage-search" placeholder="Buscar por email ou nome..." class="px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 text-sm">
                                <button id="refresh-storage-stats" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition text-sm">
                                    <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                                    Atualizar
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Usuário</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Plano</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Usado</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Limite</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Uso</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="storage-table-body">
                                    <tr>
                                        <td colspan="6" class="p-4 text-center text-gray-400">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Aba: Notificações -->
                <div id="admin-tab-notifications" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configuração de Notificações -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="settings" class="w-5 h-5 mr-2 text-indigo-500"></i>
                            Configuração de Notificações
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i data-lucide="shopping-cart" class="w-4 h-4 mr-2 text-green-500"></i>
                                    Notificações de Compra
                                </h3>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notif-purchase-enabled" class="mr-2">
                                        <span class="text-gray-300">Ativar notificações de compra</span>
                                    </label>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Intervalo entre notificações (segundos)</label>
                                        <input type="number" id="notif-purchase-interval" value="5" min="1" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Mensagem padrão</label>
                                        <textarea id="notif-purchase-message" rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white" placeholder="Ex: {name} acabou de comprar {plan}">🎉 {name} acabou de comprar o plano {plan}!</textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
                                    <i data-lucide="user-plus" class="w-4 h-4 mr-2 text-blue-500"></i>
                                    Notificações de Novos Usuários
                                </h3>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notif-user-enabled" class="mr-2">
                                        <span class="text-gray-300">Ativar notificações de novos usuários</span>
                                    </label>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Intervalo entre notificações (segundos)</label>
                                        <input type="number" id="notif-user-interval" value="5" min="1" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-400 mb-2">Mensagem padrão</label>
                                        <textarea id="notif-user-message" rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white" placeholder="Ex: {name} acabou de se cadastrar">👋 {name} acabou de se cadastrar na plataforma!</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button id="save-notifications-config" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Salvar Configurações
                            </button>
                            <button id="test-notification-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="bell" class="w-4 h-4 inline mr-2"></i>
                                Testar Notificação
                            </button>
                        </div>
                    </div>

                    <!-- Usuários Fictícios -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="users" class="w-5 h-5 mr-2 text-purple-500"></i>
                            Usuários Fictícios
                        </h2>
                        <div class="mb-4 flex gap-3">
                            <button id="add-fake-user-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                                Adicionar Usuário Fictício
                            </button>
                            <button id="create-bulk-users-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">
                                <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                                Criar 100 Usuários (50 Compra + 50 Novo)
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Nome</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Email</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Tipo</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Status</th>
                                        <th class="p-3 text-xs font-semibold text-gray-400 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="fake-users-table-body">
                                    <tr>
                                        <td colspan="5" class="p-4 text-center text-gray-400">Nenhum usuário fictício cadastrado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controles de Loop -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="play-circle" class="w-5 h-5 mr-2 text-amber-500"></i>
                            Controles de Loop
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">Notificações de Compra</h3>
                                <div class="space-y-3">
                                    <button id="start-purchase-loop" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                                        Iniciar Loop
                                    </button>
                                    <button id="stop-purchase-loop" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition" disabled>
                                        <i data-lucide="stop-circle" class="w-4 h-4 inline mr-2"></i>
                                        Parar Loop
                                    </button>
                                    <div class="text-sm text-gray-400">
                                        Status: <span id="purchase-loop-status" class="text-gray-300">Parado</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-white mb-3">Notificações de Novos Usuários</h3>
                                <div class="space-y-3">
                                    <button id="start-user-loop" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition">
                                        <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>
                                        Iniciar Loop
                                    </button>
                                    <button id="stop-user-loop" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition" disabled>
                                        <i data-lucide="stop-circle" class="w-4 h-4 inline mr-2"></i>
                                        Parar Loop
                                    </button>
                                    <div class="text-sm text-gray-400">
                                        Status: <span id="user-loop-status" class="text-gray-300">Parado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba: Permissões de Planos -->
                <div id="admin-tab-plan-permissions" class="admin-tab-content space-y-8" style="display: none;">
                    <!-- Configuração de Créditos por Plano -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="coins" class="w-5 h-5 mr-2 text-yellow-500"></i>
                            Créditos Mensais por Plano
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="plan-credits-list">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                    </div>

                    <!-- Permissões por Plano -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="shield" class="w-5 h-5 mr-2 text-indigo-500"></i>
                            Permissões de Funcionalidades por Plano
                        </h2>
                        <div id="plan-permissions-list" class="space-y-6">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal para Vídeos do Canal -->
    <div id="channel-videos-modal" class="fixed inset-0 bg-black/70 z-40 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-white">Últimos Vídeos do Canal</h2>
                <button id="modal-close-btn" class="p-2 text-gray-400 hover:text-white rounded-full">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="modal-loading" class="text-center py-8" style="display: none;">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-amber-500">A procurar vídeos...</p>
            </div>
            <div id="modal-error" class="error-message" style="display: none;"></div>
            <div id="modal-video-list" class="overflow-y-auto flex-1 space-y-6 pr-2">
                <!-- Lista de vídeos será inserida aqui -->
            </div>
        </div>
    </div>

    <!-- Container de Notificações -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Modal Customizado (substitui prompt/confirm) -->
    <div id="custom-modal-overlay" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="custom-modal-title">
                    <i data-lucide="alert-circle" class="w-5 h-5"></i>
                    <span id="custom-modal-title-text">Confirmação</span>
                </h3>
                <button class="custom-modal-close" id="custom-modal-close">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="custom-modal-body">
                <p class="custom-modal-message" id="custom-modal-message"></p>
                <input type="text" id="custom-modal-input" class="custom-modal-input" style="display: none;" placeholder="">
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn custom-modal-btn-secondary" id="custom-modal-cancel">Cancelar</button>
                <button class="custom-modal-btn custom-modal-btn-primary" id="custom-modal-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Utilizador (Admin) -->
    <div id="edit-user-modal" class="fixed inset-0 bg-black/70 z-40 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Editar Utilizador</h2>
                <button id="edit-user-modal-close-btn" class="p-2 text-gray-400 hover:text-white rounded-full">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label for="edit-user-name" class="block text-sm font-medium mb-2">Nome</label>
                    <input type="text" id="edit-user-name" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div>
                    <label for="edit-user-email" class="block text-sm font-medium mb-2">Email (não pode ser alterado)</label>
                    <input type="email" id="edit-user-email" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-400 cursor-not-allowed" readonly>
                </div>
                <div>
                    <label for="edit-user-whatsapp" class="block text-sm font-medium mb-2">WhatsApp</label>
                    <input type="text" id="edit-user-whatsapp" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-user-role" class="block text-sm font-medium mb-2">Cargo</label>
                        <select id="edit-user-role" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="user">Utilizador</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-user-status" class="block text-sm font-medium mb-2">Status</label>
                        <select id="edit-user-status" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="pending">Pendente</option>
                            <option value="active">Ativo</option>
                            <option value="blocked">Bloqueado</option>
                        </select>
                    </div>
                </div>
                <div class="pt-4">
                    <button type="submit" id="btn-save-user" class="w-full py-3 px-4 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center space-x-2">
                        <span>Salvar Alterações</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Personalizado para Mensagens -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[100]" style="display: none;">
        <div id="custom-modal-box" class="bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all animate-fade-in overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div id="custom-modal-icon-container" class="w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-amber-500"></i>
                    </div>
                    <h3 id="custom-modal-title" class="text-xl font-bold text-white">Aviso</h3>
                </div>
                <button id="custom-modal-close" class="text-gray-400 hover:text-white transition-colors p-1 rounded hover:bg-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="mb-6">
                <div id="custom-modal-message" class="text-gray-300 leading-relaxed"></div>
            </div>
            <div class="flex justify-end">
                <button id="custom-modal-ok" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors shadow-lg">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Criar Agente de Roteiro -->
    <div id="create-agent-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Criar Agente de Roteiro</h3>
                <button id="btn-close-agent-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="create-agent-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Agente</label>
                    <input type="text" id="agent-name-input" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Nicho</label>
                        <input type="text" id="agent-niche-input" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Subnicho</label>
                        <input type="text" id="agent-subniche-input" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">
                        Transcrição Manual (Opcional)
                        <span class="text-xs text-gray-400 ml-2">Cole aqui a transcrição do vídeo se a automática não funcionar</span>
                    </label>
                    <textarea id="agent-manual-transcript" rows="20" placeholder="Cole aqui a transcrição completa do vídeo..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-y min-h-[400px] max-h-[600px]"></textarea>
                    <p class="text-xs text-gray-400 mt-1">Se você colar uma transcrição manual aqui, ela será usada em vez da transcrição automática.</p>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="btn-cancel-agent" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                    <button type="submit" id="btn-submit-agent" class="py-2 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-semibold flex items-center space-x-2">
                        <span>Criar Agente</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação da Fórmula do Agente -->
    <div id="agent-formula-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-amber-500 rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-2xl font-semibold text-white">Revisar Fórmula do Agente</h3>
                    <p class="text-sm text-gray-400">A IA vai replicar exatamente os elementos abaixo no novo agente.</p>
                </div>
                <button id="agent-formula-close" class="text-gray-400 hover:text-white">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div id="agent-formula-content" class="space-y-4 text-sm text-gray-200">
                <!-- Conteúdo preenchido dinamicamente -->
            </div>
            <div class="mt-6 flex flex-col md:flex-row md:justify-end gap-3">
                <button id="agent-formula-cancel" class="w-full md:w-auto px-4 py-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-semibold">Voltar e editar</button>
                <button id="agent-formula-confirm" class="w-full md:w-auto px-4 py-3 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold flex items-center justify-center gap-2">
                    <i data-lucide="check-circle"></i>
                    <span>Confirmar e Criar Agente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Trocar Senha (Admin) -->
    <div id="change-password-modal" class="fixed inset-0 bg-black/70 z-40 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Trocar Senha</h2>
                <button id="change-password-modal-close-btn" class="p-2 text-gray-400 hover:text-white rounded-full">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <form id="change-password-form" class="space-y-4">
                <input type="hidden" id="change-password-user-id">
                <p class="text-sm text-gray-400">A definir nova senha para <strong id="change-password-user-email" class="text-amber-400"></strong>.</p>
                <div>
                    <label for="new-password" class="block text-sm font-medium mb-2">Nova Senha (mínimo 6 caracteres)</label>
                    <input type="password" id="new-password" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required minlength="6">
                </div>
                <div class="pt-4">
                    <button type="submit" id="btn-save-password" class="w-full py-3 px-4 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center space-x-2">
                        <span>Definir Nova Senha</span>
                        <div class="btn-spinner hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Loading ao Criar Agente -->
    <div id="create-agent-loading-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-900 border border-amber-500 rounded-xl shadow-2xl max-w-md w-full p-8 text-center">
            <div class="mb-6">
                <div class="loader mx-auto w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <h3 class="text-2xl font-semibold text-white mb-2">Criando Agente...</h3>
            <p class="text-gray-400 text-sm mb-4">Analisando a fórmula viral e gerando o agente personalizado</p>
            <div class="w-full bg-gray-800 rounded-full h-2 mb-2">
                <div id="create-agent-progress-bar" class="bg-amber-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="create-agent-progress-text" class="text-xs text-gray-500">Iniciando...</p>
        </div>
    </div>

    <script>
        // Função helper global para acessar localStorage de forma segura
        function safeLocalStorageGet(key) {
            try {
                if (typeof Storage !== 'undefined' && typeof localStorage !== 'undefined') {
                    return localStorage.getItem(key);
                }
            } catch (error) {
                console.warn(`[STORAGE] Erro ao acessar localStorage para chave "${key}":`, error.message);
            }
            return null;
        }
        
        function safeLocalStorageSet(key, value) {
            try {
                if (typeof Storage !== 'undefined' && typeof localStorage !== 'undefined') {
                    localStorage.setItem(key, value);
                    return true;
                }
            } catch (error) {
                console.warn(`[STORAGE] Erro ao definir localStorage para chave "${key}":`, error.message);
            }
            return false;
        }
        
        function safeLocalStorageRemove(key) {
            try {
                if (typeof Storage !== 'undefined' && typeof localStorage !== 'undefined') {
                    localStorage.removeItem(key);
                    return true;
                }
            } catch (error) {
                console.warn(`[STORAGE] Erro ao remover localStorage para chave "${key}":`, error.message);
            }
            return false;
        }
        
        document.addEventListener('DOMContentLoaded', (event) => {
        
            // URLs da API - Detecta automaticamente a porta do backend
            // Se estiver rodando no live-server (porta 5500) ou não estiver na porta 5001, usa o backend na porta 5001
            const currentPort = window.location.port;
            const isBackendPort = currentPort === '5001' || currentPort === '';
            const API_BASE = isBackendPort 
                ? '' 
                : `http://${window.location.hostname}:5001`;
            
            console.log('API_BASE configurado:', API_BASE, { currentPort, isBackendPort });

            // Variáveis globais para progresso de roteiro
            let scriptProgressSource = null;
            let scriptProgressFallbackInterval = null;
            let currentProgressSessionId = null;

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error('Script Lucide (ícones) não carregou a tempo.');
            }

            // Obter token de forma segura usando a função helper
            const userToken = safeLocalStorageGet('core_token');

            let currentAnalysisData = {
                videoId: null,
                niche: null,
                subniche: null,
                model: null,
                generatedTitles: []
            };

            // Salvar títulos gerados na biblioteca (tanto GPT quanto Claude/Gemini)
            async function saveTitlesToLibrary(titles = [], meta = {}) {
                try {
                    if (!Array.isArray(titles) || titles.length === 0) return;
                    const token = localStorage.getItem('core_token');
                    if (!token) return;

                    const niche = meta.niche || null;
                    const subniche = meta.subniche || null;
                    const views = meta.views || null;
                    const formula = meta.formula || null;
                    const keywords = meta.keywords || null;

                    // Enviar em série para evitar sobrecarga
                    for (const t of titles) {
                        const titleText = t?.titulo || t?.title || (typeof t === 'string' ? t : null);
                        if (!titleText) continue;
                        const body = {
                            title: titleText,
                            niche,
                            subniche,
                            originalViews: views,
                            formulaType: formula || t?.formulaTitulo || null,
                            keywords: keywords || t?.keywords || null,
                            viralScore: t?.viralScore || t?.score || null
                        };
                        try {
                            await fetch(`${API_BASE}/api/library/titles`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(body)
                            });
                        } catch (err) {
                            console.warn('[Biblioteca] Falha ao salvar título:', err?.message || err);
                        }
                    }
                } catch (err) {
                    console.warn('[Biblioteca] Erro ao salvar títulos:', err);
                }
            }
            
            let userFolders = [];
            
            // Função global para formatar nome do modelo sem mostrar fornecedor
            window.formatModelNameForDisplay = function(model) {
                if (!model) return 'N/A';
                
                // CRÍTICO: Remover qualquer referência a fornecedores de API
                // NUNCA exibir "Laozhang.ai", "OpenAI", "Claude", "Gemini" como fornecedores
                
                // Primeiro, remover referências diretas a fornecedores
                let cleanModel = String(model)
                    .replace(/laozhang\.ai/gi, '')
                    .replace(/laozhang/gi, '')
                    .replace(/openai/gi, '')
                    .replace(/anthropic/gi, '')
                    .replace(/google/gi, '')
                    .trim();
                
                // Remover prefixos de fornecedores
                cleanModel = cleanModel.replace(/^(laozhang-|claude-|gemini-|gpt-|openai-|anthropic-)/i, '');
                cleanModel = cleanModel.replace(/-(laozhang|claude|gemini|gpt|openai|anthropic)$/i, '');
                
                // Mapear para nomes amigáveis (apenas modelos)
                if (cleanModel.includes('gpt-4o') || model.includes('gpt-4o')) return 'GPT-4o';
                if (cleanModel.includes('gpt-4o-mini') || model.includes('gpt-4o-mini')) return 'GPT-4o Mini';
                if (cleanModel.includes('gpt-4-turbo') || model.includes('gpt-4-turbo')) return 'GPT-4 Turbo';
                if (cleanModel.includes('claude-3-7-sonnet') || model.includes('claude-3-7-sonnet') || model.includes('sonnet-3-7')) return 'Claude 3.7 Sonnet';
                if (cleanModel.includes('claude-sonnet-4') || model.includes('claude-sonnet-4') || model.includes('sonnet-4')) return 'Claude Sonnet 4';
                if (cleanModel.includes('claude-opus-4') || model.includes('claude-opus-4') || model.includes('opus-4')) return 'Claude Opus 4';
                if (cleanModel.includes('claude-3-5-haiku') || model.includes('claude-3-5-haiku') || model.includes('haiku-3-5')) return 'Claude 3.5 Haiku';
                if (cleanModel.includes('claude-3-opus') || model.includes('claude-3-opus') || model.includes('opus-3')) return 'Claude 3 Opus';
                if (cleanModel.includes('gemini-2.5-pro') || model.includes('gemini-2.5-pro') || model.includes('2.5-pro')) return 'Gemini 2.5 Pro';
                if (cleanModel.includes('gemini-2.5-flash') || model.includes('gemini-2.5-flash') || model.includes('2.5-flash')) return 'Gemini 2.5 Flash';
                if (cleanModel.includes('gemini-2.0-flash') || model.includes('gemini-2.0-flash') || model.includes('2.0-flash')) return 'Gemini 2.0 Flash';
                
                // Se ainda tiver referências a fornecedores, remover
                cleanModel = cleanModel.replace(/laozhang|openai|anthropic|google/gi, '').trim();
                
                // Se ficou vazio ou só tem hífens, retornar padrão
                if (!cleanModel || cleanModel === '-' || cleanModel.length < 2) return 'GPT-4o';
                
                return cleanModel;
            };

            // --- FUNÇÕES GLOBAIS DE MENSAGEM (Genéricas) ---
            // Função para mostrar modal personalizado com HTML
            function showCustomModalHTML(title, htmlContent, type = 'info') {
                const modal = document.getElementById('custom-modal');
                const modalTitle = modal?.querySelector('#custom-modal-title') || document.getElementById('custom-modal-title');
                const modalMessage = modal?.querySelector('#custom-modal-message') || document.getElementById('custom-modal-message');
                const modalClose = modal?.querySelector('#custom-modal-close') || document.getElementById('custom-modal-close');
                const modalOk = modal?.querySelector('#custom-modal-ok') || document.getElementById('custom-modal-ok');
                const modalBox = modal?.querySelector('#custom-modal-box') || document.getElementById('custom-modal-box');
                const modalIconContainer = modal?.querySelector('#custom-modal-icon-container') || document.getElementById('custom-modal-icon-container');

                if (!modal || !modalTitle || !modalMessage) {
                    console.error('[Modal HTML] Elementos não encontrados', { 
                        modal: !!modal, 
                        modalTitle: !!modalTitle, 
                        modalMessage: !!modalMessage 
                    });
                    alert(title + '\n\n' + htmlContent.replace(/<[^>]*>/g, '')); // Fallback sem HTML
                    return;
                }

                console.log('[Modal HTML] Configurando modal:', { title, htmlLength: htmlContent.length, type });

                // Configurar título
                if (modalTitle) modalTitle.textContent = title;
                
                // Limpar e inserir HTML
                if (modalMessage) {
                    // Remover todos os filhos
                    while (modalMessage.firstChild) {
                        modalMessage.removeChild(modalMessage.firstChild);
                    }
                    // Inserir novo HTML
                    modalMessage.innerHTML = htmlContent;
                    
                    // Verificar se foi inserido
                    console.log('[Modal HTML] HTML inserido:', {
                        innerHTMLLength: modalMessage.innerHTML.length,
                        childrenCount: modalMessage.children.length,
                        firstChild: modalMessage.firstElementChild ? modalMessage.firstElementChild.tagName : 'none'
                    });
                } else {
                    console.error('[Modal HTML] modalMessage não encontrado!');
                    return;
                }
                
                // Expandir modal se necessário para conteúdo maior
                if (modalBox) {
                    modalBox.style.maxWidth = '600px';
                    modalBox.style.maxHeight = '90vh';
                }
                
                // Configurar cores baseado no tipo
                if (type === 'error') {
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'alert-circle');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-red-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all overflow-y-auto';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition-colors';
                    }
                } else if (type === 'success') {
                    // Sucesso no tema (sem verde)
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'check-circle');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all overflow-y-auto';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors';
                    }
                } else {
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'info');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all overflow-y-auto';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors';
                    }
                }

                // Mostrar modal APÓS configurar tudo
                if (modal) {
                    // Forçar reflow para garantir que o conteúdo seja renderizado
                    modal.offsetHeight;
                    modal.style.display = 'flex';
                    
                    // Atualizar ícones após um delay para garantir que o HTML foi inserido e renderizado
                    setTimeout(() => {
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                            console.log('[Modal HTML] Ícones do Lucide atualizados');
                        }
                        // Verificar se o conteúdo está visível
                        const visible = modalMessage.offsetHeight > 0 || modalMessage.scrollHeight > 0;
                        console.log('[Modal HTML] Conteúdo visível?', visible, 'Height:', modalMessage.offsetHeight);
                    }, 250);
                }

                // Fechar modal ao clicar em OK ou X
                const closeModal = () => {
                    modal.style.display = 'none';
                    // Resetar maxWidth
                    if (modalBox) modalBox.style.maxWidth = '520px';
                };

                if (modalClose) {
                    modalClose.onclick = closeModal;
                }
                if (modalOk) {
                    modalOk.onclick = closeModal;
                }

                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                };
            }
            
            // Função para mostrar modal personalizado (texto simples)
            function showCustomModal(title, message, type = 'info') {
                const modal = document.getElementById('custom-modal');
                const modalTitle = modal?.querySelector('#custom-modal-title') || document.getElementById('custom-modal-title');
                const modalMessage = modal?.querySelector('#custom-modal-message') || document.getElementById('custom-modal-message');
                const modalClose = modal?.querySelector('#custom-modal-close') || document.getElementById('custom-modal-close');
                const modalOk = modal?.querySelector('#custom-modal-ok') || document.getElementById('custom-modal-ok');
                const modalBox = modal?.querySelector('#custom-modal-box') || document.getElementById('custom-modal-box');
                const modalIconContainer = modal?.querySelector('#custom-modal-icon-container') || document.getElementById('custom-modal-icon-container');

                if (!modal || !modalTitle || !modalMessage) {
                    console.error('[Modal] Elementos não encontrados');
                    alert(title + ': ' + message); // Fallback
                    return;
                }

                // Configurar título e mensagem
                modalTitle.textContent = title || 'Aviso';
                
                // Converter quebras de linha (\n) em <br> e manter HTML se presente
                let formattedMessage = (message && String(message).trim().length > 0) ? message : null;
                
                // Mensagens padrão por tipo quando o conteúdo está vazio
                if (!formattedMessage) {
                    formattedMessage = ({
                        'success': 'Operação concluída com sucesso.',
                        'error': 'Ocorreu um erro. Verifique os dados e tente novamente.',
                        'warning': 'Ação realizada com observações. Reveja os detalhes e prossiga.',
                        'info': 'Nenhuma informação detalhada disponível no momento.'
                    })[type] || 'Informação.';
                }
                // Se contém HTML (tags), usar innerHTML, senão converter \n em <br>
                if (formattedMessage.includes('<') && formattedMessage.includes('>')) {
                    modalMessage.innerHTML = formattedMessage;
                } else {
                    // Converter quebras de linha em <br> e escapar HTML
                    formattedMessage = formattedMessage
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\n/g, '<br>');
                    modalMessage.innerHTML = formattedMessage;
                }

                // Configurar cores baseado no tipo
                if (type === 'error') {
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'alert-circle');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-red-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition-colors';
                    }
                } else if (type === 'success') {
                    // Sucesso no tema (sem verde)
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'check-circle');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors';
                    }
                } else {
                    if (modalIconContainer) {
                        modalIconContainer.className = 'w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center';
                        const icon = modalIconContainer.querySelector('i[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'info');
                    }
                    if (modalBox) {
                        modalBox.className = 'bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all';
                    }
                    if (modalOk) {
                        modalOk.className = 'px-6 py-2 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors';
                    }
                }

                // Mostrar modal
                modal.style.display = 'flex';
                
                // Atualizar ícones
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Fechar modal ao clicar em OK ou X
                const closeModal = () => {
                    modal.style.display = 'none';
                };

                if (modalClose) {
                    modalClose.onclick = closeModal;
                }
                if (modalOk) {
                    modalOk.onclick = closeModal;
                }

                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                };
            }

            // ================================================
            // SISTEMA DE MODAL CUSTOMIZADO
            // ================================================
            
            function showCustomConfirm(message, title = 'Confirmação') {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('custom-modal-overlay');
                    const titleEl = document.getElementById('custom-modal-title-text');
                    const messageEl = document.getElementById('custom-modal-message');
                    const inputEl = document.getElementById('custom-modal-input');
                    const confirmBtn = document.getElementById('custom-modal-confirm');
                    const cancelBtn = document.getElementById('custom-modal-cancel');
                    const closeBtn = document.getElementById('custom-modal-close');
                    
                    // Remover qualquer banner verde de sucesso que possa existir no modal
                    const existingSuccessBanners = overlay?.querySelectorAll('.bg-green-600, .bg-green-500, [class*="green"][class*="success"], [class*="excluído"][class*="sucesso"]');
                    if (existingSuccessBanners) {
                        existingSuccessBanners.forEach(banner => banner.remove());
                    }
                    
                    // Configurar modal - usar apenas texto simples, sem HTML que possa conter banners verdes
                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    messageEl.innerHTML = ''; // Limpar qualquer HTML anterior
                    messageEl.textContent = message; // Definir apenas o texto
                    inputEl.style.display = 'none';
                    confirmBtn.textContent = 'Confirmar';
                    
                    // Mostrar modal
                    overlay.style.display = 'flex';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Observar mudanças no modal para remover banners verdes que possam ser adicionados
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === 1) {
                                    const greenBanners = node.querySelectorAll ? node.querySelectorAll('.bg-green-600, .bg-green-500, [class*="green"][class*="success"], [class*="excluído"][class*="sucesso"]') : [];
                                    greenBanners.forEach(banner => {
                                        if (banner.closest('#custom-modal-overlay')) {
                                            banner.remove();
                                        }
                                    });
                                    if (node.classList && (node.classList.contains('bg-green-600') || node.classList.contains('bg-green-500') || 
                                        Array.from(node.classList).some(c => c.includes('green') && c.includes('success')) ||
                                        Array.from(node.classList).some(c => c.includes('excluído') && c.includes('sucesso')))) {
                                        if (node.closest('#custom-modal-overlay')) {
                                            node.remove();
                                        }
                                    }
                                }
                            });
                        });
                    });
                    if (overlay) {
                        observer.observe(overlay, { childList: true, subtree: true });
                    }
                    
                    // Handlers
                    let modalObserver = null;
                    const cleanup = () => {
                        if (modalObserver) {
                            modalObserver.disconnect();
                            modalObserver = null;
                        }
                        overlay.style.display = 'none';
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        closeBtn.onclick = null;
                    };
                    
                    confirmBtn.onclick = () => {
                        cleanup();
                        resolve(true);
                    };
                    
                    cancelBtn.onclick = () => {
                        cleanup();
                        resolve(false);
                    };
                    
                    closeBtn.onclick = () => {
                        cleanup();
                        resolve(false);
                    };
                });
            }
            
            function showCustomPrompt(message, defaultValue = '', title = 'Entrada') {
                return new Promise((resolve) => {
                    const overlay = document.getElementById('custom-modal-overlay');
                    const titleEl = document.getElementById('custom-modal-title-text');
                    const messageEl = document.getElementById('custom-modal-message');
                    const inputEl = document.getElementById('custom-modal-input');
                    const confirmBtn = document.getElementById('custom-modal-confirm');
                    const cancelBtn = document.getElementById('custom-modal-cancel');
                    const closeBtn = document.getElementById('custom-modal-close');
                    
                    // Configurar modal
                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    inputEl.style.display = 'block';
                    inputEl.value = defaultValue;
                    inputEl.focus();
                    inputEl.select();
                    confirmBtn.textContent = 'OK';
                    
                    // Mostrar modal
                    overlay.style.display = 'flex';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Handlers
                    const cleanup = () => {
                        overlay.style.display = 'none';
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        closeBtn.onclick = null;
                        inputEl.onkeydown = null;
                    };
                    
                    const handleConfirm = () => {
                        const value = inputEl.value;
                        cleanup();
                        resolve(value);
                    };
                    
                    const handleCancel = () => {
                        cleanup();
                        resolve(null);
                    };
                    
                    confirmBtn.onclick = handleConfirm;
                    cancelBtn.onclick = handleCancel;
                    closeBtn.onclick = handleCancel;
                    
                    inputEl.onkeydown = (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleConfirm();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            handleCancel();
                        }
                    };
                });
            }
            
            // ================================================
            // SISTEMA DE NOTIFICAÇÕES
            // ================================================
            
            function showNotification(title, message, type = 'info', duration = 5000) {
                const container = document.getElementById('notification-container');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = 'notification';
                
                const icons = {
                    info: 'info',
                    success: 'check-circle',
                    warning: 'alert-triangle',
                    error: 'x-circle',
                    user: 'user-plus',
                    purchase: 'shopping-cart'
                };
                
                const icon = icons[type] || 'info';
                
                notification.innerHTML = `
                    <button class="notification-close">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                    <div class="notification-header">
                        <i data-lucide="${icon}" class="notification-icon"></i>
                        <span class="notification-title">${title}</span>
                    </div>
                    <div class="notification-message">${message}</div>
                `;
                
                container.appendChild(notification);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // Auto-remover após duração
                if (duration > 0) {
                    setTimeout(() => {
                        notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                        setTimeout(() => notification.remove(), 300);
                    }, duration);
                }
                
                // Botão de fechar
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                });
            }
            
            // Polling para notificações
            let notificationPollInterval = null;
            
            function startNotificationPolling() {
                if (notificationPollInterval) return;
                
                // Rastrear notificações já exibidas para evitar duplicatas
                const displayedNotifications = new Set();
                
                notificationPollInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`${API_BASE}/api/notifications/pending`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (response.ok) {
                            const notifications = await response.json();
                            notifications.forEach(notif => {
                                // Só exibir se ainda não foi exibida nesta sessão
                                if (!displayedNotifications.has(notif.id)) {
                                    showNotification(notif.title, notif.message, notif.type, notif.duration || 5000);
                                    displayedNotifications.add(notif.id);
                                    
                                    // Marcar como lida apenas após o tempo de exibição
                                    setTimeout(() => {
                                        fetch(`${API_BASE}/api/notifications/${notif.id}/read`, {
                                            method: 'POST',
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        }).catch(() => {});
                                        // Remover do set após marcar como lida para permitir nova exibição se necessário
                                        displayedNotifications.delete(notif.id);
                                    }, notif.duration || 5000);
                                }
                            });
                        }
                    } catch (err) {
                        console.error('Erro ao buscar notificações:', err);
                    }
                }, 2000); // Verificar a cada 2 segundos para melhor responsividade
            }
            
            function stopNotificationPolling() {
                if (notificationPollInterval) {
                    clearInterval(notificationPollInterval);
                    notificationPollInterval = null;
                }
            }
            
            // Função para mostrar modal de loading genérico
            function showLoadingModal(message = 'Processando...', icon = 'sparkles') {
                // Remover modal existente se houver
                const existingModal = document.getElementById('generic-loading-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const modal = document.createElement('div');
                modal.id = 'generic-loading-modal';
                modal.className = 'custom-modal-overlay';
                modal.innerHTML = `
                    <div class="custom-modal">
                        <div class="custom-modal-header">
                            <div class="custom-modal-title">
                                <i data-lucide="${icon}" class="w-5 h-5 text-amber-400 animate-spin"></i>
                                <span>${message}</span>
                            </div>
                        </div>
                        <div class="custom-modal-body">
                            <div class="flex items-center justify-center py-8">
                                <div class="loader"></div>
                            </div>
                            <p class="custom-modal-message text-center">Aguarde enquanto processamos sua solicitação...</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            // Função para esconder modal de loading
            function hideLoadingModal() {
                const modal = document.getElementById('generic-loading-modal');
                if (modal) {
                    modal.style.animation = 'fadeOut 0.2s ease-out';
                    setTimeout(() => modal.remove(), 200);
                }
            }
            
            // ===== Modal padrão da plataforma (tema) =====
            // Substitui toast verde: queremos mensagem no CENTRO e no TEMA.
            function showToast(message, type = 'success', duration = 1800) {
                const title = type === 'error' ? 'Erro' : (type === 'success' ? 'Sucesso' : 'Aviso');
                // Sempre usar modal no tema (âmbar). Ícone pode variar, mas sem “banner verde”.
                showCustomModal(title, message, 'info');
                // Fechar automaticamente em sucessos (mantém UX ágil)
                if (type === 'success') {
                    setTimeout(() => {
                        const modal = document.getElementById('custom-modal');
                        if (modal && modal.style.display !== 'none') modal.style.display = 'none';
                    }, Math.max(800, duration));
                }
            }
            
            function showMessage(elementId, message, isError = false) {
                // Usar modal central no tema (sem toast verde)
                showToast(message, isError ? 'error' : 'success');
                
                // Manter compatibilidade com código antigo que espera mensagens em elementos específicos
                const msgBox = document.getElementById(elementId);
                if (msgBox) {
                    msgBox.innerHTML = message;
                    msgBox.style.display = 'block';
                    setTimeout(() => { msgBox.style.display = 'none'; }, 3000);
                }
            }
            
            function hideMessage(elementId) {
                const msgBox = document.getElementById(elementId);
                if (msgBox) {
                    msgBox.style.display = 'none';
                }
            }

            function setButtonLoading(button, isLoading) {
                if (!button) return;
                const text = button.querySelector('span');
                const spinner = button.querySelector('.btn-spinner');
                button.disabled = isLoading;
                if (isLoading) {
                    if (text) text.style.display = 'none';
                    if (spinner) spinner.style.display = 'block';
                } else {
                    if (text) text.style.display = 'inline';
                    if (spinner) spinner.style.display = 'none';
                }
            }
            
            // Helper function to render nested objects/arrays as HTML lists
            function renderObjectAsList(obj, depth = 0) {
                if (typeof obj !== 'object' || obj === null) {
                    return `<span class="text-gray-300">${String(obj)}</span>`;
                }
                
                if (Array.isArray(obj)) {
                    let html = '<ul class="list-disc list-inside pl-6 space-y-2 mt-2">';
                    obj.forEach((item, index) => {
                        html += '<li class="text-gray-300">';
                        if (typeof item === 'object' && item !== null) {
                            html += renderObjectAsList(item, depth + 1);
                        } else {
                            html += `<span class="text-gray-300">${String(item)}</span>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                    return html;
                }
                
                let html = '<div class="space-y-3 mt-2">';
                for (const key in obj) {
                    const value = obj[key];
                    const title = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    html += '<div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">';
                    html += `<h4 class="text-amber-400 font-semibold mb-2 text-lg">${title}</h4>`;
                    
                    if (typeof value === 'object' && value !== null) {
                        html += renderObjectAsList(value, depth + 1);
                    } else {
                        html += `<p class="text-gray-300 leading-relaxed">${String(value)}</p>`;
                    }
                    html += '</div>';
                }
                html += '</div>';
                return html;
            }
            
            function formatNicheRecommendation(data) {
                if (typeof data === 'string') {
                    // Tentar parsear se for JSON string
                    try {
                        const parsed = JSON.parse(data);
                        return formatNicheRecommendation(parsed);
                    } catch (e) {
                        // Se não for JSON, retornar como texto formatado
                        return `<div class="prose prose-invert max-w-none"><p class="text-gray-300 whitespace-pre-wrap">${data.replace(/\n/g, '<br>')}</p></div>`;
                    }
                }
                
                if (typeof data !== 'object' || data === null) {
                    return `<p class="text-gray-300">${String(data)}</p>`;
                }
                
                let html = '<div class="space-y-4">';
                
                // Subnicho Recomendado
                if (data.subnicho_recomendado) {
                    html += `
                        <div class="bg-gradient-to-r from-amber-900/30 to-amber-800/20 rounded-lg p-6 border border-amber-700/50">
                            <h3 class="text-2xl font-bold text-amber-400 mb-2">🎯 Subnicho Recomendado</h3>
                            <p class="text-xl text-white font-semibold">${data.subnicho_recomendado}</p>
                        </div>
                    `;
                }
                
                // Análise de Potencial
                if (data.analise_potencial) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">💡 Análise de Potencial</h3>
                            <p class="text-gray-300 leading-relaxed">${data.analise_potencial}</p>
                        </div>
                    `;
                }
                
                // Análise de Concorrência
                if (data.analise_concorrencia) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">📊 Análise de Concorrência</h3>
                            <p class="text-gray-300 leading-relaxed">${data.analise_concorrencia}</p>
                        </div>
                    `;
                }
                
                // Potencial de Viralização
                if (data.potencial_viralizacao) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">🚀 Potencial de Viralização</h3>
                            <p class="text-gray-300 leading-relaxed">${data.potencial_viralizacao}</p>
                        </div>
                    `;
                }
                
                // Estratégias de Conteúdo
                if (data.estrategias_conteudo && Array.isArray(data.estrategias_conteudo)) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-3">📝 Estratégias de Conteúdo</h3>
                            <ul class="list-disc list-inside space-y-2 pl-4">
                                ${data.estrategias_conteudo.map(strategy => `<li class="text-gray-300">${strategy}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Sugestões de Títulos e Thumbnails
                if (data.sugestoes_titulos_thumbnails) {
                    html += `
                        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700">
                            <h3 class="text-xl font-semibold text-amber-400 mb-4">🎨 Sugestões de Títulos e Thumbnails</h3>
                            
                            ${data.sugestoes_titulos_thumbnails.titulos && Array.isArray(data.sugestoes_titulos_thumbnails.titulos) ? `
                                <div class="mb-4">
                                    <h4 class="text-lg font-semibold text-white mb-2">📌 Títulos Virais</h4>
                                    <ul class="list-disc list-inside space-y-2 pl-4">
                                        ${data.sugestoes_titulos_thumbnails.titulos.map(title => `<li class="text-gray-300">${title}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${data.sugestoes_titulos_thumbnails.thumbnails && Array.isArray(data.sugestoes_titulos_thumbnails.thumbnails) ? `
                                <div>
                                    <h4 class="text-lg font-semibold text-white mb-2">🖼️ Thumbnails</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${data.sugestoes_titulos_thumbnails.thumbnails.map((thumb, idx) => `
                                            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                                                <h5 class="text-amber-400 font-semibold mb-2">Thumbnail ${idx + 1}</h5>
                                                <p class="text-gray-300 text-sm mb-1"><strong>Imagem:</strong> ${thumb.imagem || 'N/A'}</p>
                                                <p class="text-gray-300 text-sm mb-1"><strong>Texto:</strong> ${thumb.texto || 'N/A'}</p>
                                                <p class="text-gray-300 text-sm"><strong>Cores:</strong> ${thumb.cores || 'N/A'}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
            }

            function createWhatsAppLink(whatsapp) {
                if (!whatsapp) {
                    return 'N/A';
                }
                // Remove all non-digit characters
                const number = whatsapp.replace(/\D/g, '');
                if (!number) {
                    return whatsapp; // Return original if it's just weird characters
                }
                return `<a href="https://wa.me/${number}" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline">${whatsapp}</a>`;
            }

            // Funções auxiliares (definidas cedo para uso em todas as funções)
            function formatNumber(num) {
                const n = parseFloat(num) || 0;
                if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                return Math.floor(n).toString();
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }


            // --- LÓGICA DE ADMIN ---
            const editUserModal = document.getElementById('edit-user-modal');
            const editUserModalCloseBtn = document.getElementById('edit-user-modal-close-btn');
            const editUserForm = document.getElementById('edit-user-form');
            const changePasswordModal = document.getElementById('change-password-modal');
            const changePasswordModalCloseBtn = document.getElementById('change-password-modal-close-btn');
            const changePasswordForm = document.getElementById('change-password-form');

            function showEditUserModal(user) {
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-whatsapp').value = user.whatsapp || '';
                document.getElementById('edit-user-role').value = user.isAdmin ? 'admin' : 'user';
                
                const statusSelect = document.getElementById('edit-user-status');
                if (user.isBlocked) {
                    statusSelect.value = 'blocked';
                } else if (!user.isApproved) {
                    statusSelect.value = 'pending';
                } else {
                    statusSelect.value = 'active';
                }

                editUserModal.style.display = 'flex';
            }

            function hideEditUserModal() {
                editUserModal.style.display = 'none';
            }

            function showChangePasswordModal(user) {
                document.getElementById('change-password-user-id').value = user.id;
                document.getElementById('change-password-user-email').innerText = user.email;
                document.getElementById('new-password').value = '';
                changePasswordModal.style.display = 'flex';
            }

            function hideChangePasswordModal() {
                changePasswordModal.style.display = 'none';
            }

            if (editUserModalCloseBtn) editUserModalCloseBtn.addEventListener('click', hideEditUserModal);
            if (changePasswordModalCloseBtn) changePasswordModalCloseBtn.addEventListener('click', hideChangePasswordModal);

            if (editUserModal) editUserModal.addEventListener('click', (e) => {
                if (e.target === editUserModal) hideEditUserModal();
            });
            if (changePasswordModal) changePasswordModal.addEventListener('click', (e) => {
                if (e.target === changePasswordModal) hideChangePasswordModal();
            });

            if (editUserForm) {
                editUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userId = document.getElementById('edit-user-id').value;
                    const name = document.getElementById('edit-user-name').value;
                    const whatsapp = document.getElementById('edit-user-whatsapp').value;
                    const isAdmin = document.getElementById('edit-user-role').value === 'admin';
                    const status = document.getElementById('edit-user-status').value;
                    
                    const isApproved = status !== 'pending';
                    const isBlocked = status === 'blocked';

                    const btn = document.getElementById('btn-save-user');
                    setButtonLoading(btn, true);

                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ name, whatsapp, isAdmin, isApproved, isBlocked })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro ao atualizar utilizador.');
                        showMessage('admin-success-message', data.msg);
                        hideEditUserModal();
                        loadAdminUsers();
                        loadAdminStats();
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });
            }

            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userId = document.getElementById('change-password-user-id').value;
                    const newPassword = document.getElementById('new-password').value;
                    const btn = document.getElementById('btn-save-password');
                    setButtonLoading(btn, true);

                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/${userId}/password`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ password: newPassword })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro ao trocar senha.');
                        showMessage('admin-success-message', data.msg);
                        hideChangePasswordModal();
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });
            }

            async function toggleUserBlockStatus(userId, isBlocked) {
                const confirmed = await showCustomConfirm(`Tem certeza que deseja ${isBlocked ? 'bloquear' : 'desbloquear'} este utilizador?`);
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users/${userId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isBlocked: isBlocked })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro ao alterar status.');
                    showMessage('admin-success-message', data.msg);
                    loadAdminUsers();
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }

            async function deleteUser(userId) {
                const confirmed = await showCustomConfirm('Tem certeza que deseja EXCLUIR este utilizador? Esta ação é irreversível.');
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro ao excluir utilizador.');
                    showMessage('admin-success-message', data.msg);
                    loadAdminUsers();
                    loadAdminStats();
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }

            async function checkUserRoleAndLoadAdmin() {
                if (!userToken) return;
                try {
                    console.log('Verificando autenticação do usuário...', { API_BASE, hasToken: !!userToken });
                    const response = await fetch(`${API_BASE}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    console.log('Resposta de /api/auth/me:', { status: response.status, ok: response.ok });
                    
                    if (!response.ok) {
                        // Só redireciona se for erro de autenticação (401/403), não erro de rede (404)
                        if (response.status === 401 || response.status === 403) {
                            console.warn('Erro de autenticação. Redirecionando para login...');
                            localStorage.removeItem('core_token');
                            window.location.href = 'la-casa-dark-core-auth.html';
                            return;
                        } else if (response.status === 404) {
                            console.error('Endpoint não encontrado. Verifique se o servidor está rodando e se a URL da API está correta.');
                            console.error('API_BASE:', API_BASE, 'URL completa:', `${API_BASE}/api/auth/me`);
                            // Não redireciona em caso de 404, apenas mostra erro no console
                            return;
                        } else {
                            console.error('Erro ao verificar autenticação:', response.status, response.statusText);
                            return;
                        }
                    }
                    const userData = await response.json();
                    console.log('Dados do usuário carregados:', { name: userData.name, isAdmin: userData.isAdmin, plan: userData.plan });
                    
                    // Verificar se usuário tem plano Master ou Anual para liberar APIs próprias
                    const userPlan = userData.plan || userData.subscription_plan || 'plan-free';
                    const hasPremiumPlan = userPlan === 'plan-master' || 
                                          userPlan === 'plan-master-annual' || 
                                          userPlan === 'plan-start-annual' || 
                                          userPlan === 'plan-turbo-annual' ||
                                          (userData.isAdmin === 1 || userData.isAdmin === true || String(userData.isAdmin) === '1'); // Admins sempre têm acesso
                    
                    console.log('[API Keys] Verificação de plano:', { userPlan, hasPremiumPlan, isAdmin: userData.isAdmin });
                    
                    // Bloquear/desbloquear campos de API
                    // Aguardar um pouco para garantir que os elementos existam
                    setTimeout(() => {
                        const apiKeysPremiumMessage = document.getElementById('api-keys-premium-message');
                        const claudeInput = document.getElementById('key-claude');
                        const geminiInput = document.getElementById('key-gemini');
                        const openaiInput = document.getElementById('key-openai');
                        const claudeToggle = document.getElementById('toggle-key-claude');
                        const geminiToggle = document.getElementById('toggle-key-gemini');
                        const openaiToggle = document.getElementById('toggle-key-openai');
                        const claudeLocked = document.getElementById('key-claude-locked');
                        const geminiLocked = document.getElementById('key-gemini-locked');
                        const openaiLocked = document.getElementById('key-openai-locked');
                        
                        console.log('[API Keys] Elementos encontrados:', {
                            apiKeysPremiumMessage: !!apiKeysPremiumMessage,
                            claudeInput: !!claudeInput,
                            geminiInput: !!geminiInput,
                            openaiInput: !!openaiInput
                        });
                        
                            if (!hasPremiumPlan) {
                                // Bloquear campos
                                if (claudeInput) {
                                    claudeInput.disabled = true;
                                    claudeInput.classList.add('opacity-50', 'cursor-not-allowed');
                                }
                                if (geminiInput) {
                                    geminiInput.disabled = true;
                                    geminiInput.classList.add('opacity-50', 'cursor-not-allowed');
                                }
                                if (openaiInput) {
                                    openaiInput.disabled = true;
                                    openaiInput.classList.add('opacity-50', 'cursor-not-allowed');
                                }
                                // Bloquear toggles
                                if (claudeToggle) {
                                    claudeToggle.disabled = true;
                                    claudeToggle.classList.add('opacity-50', 'cursor-not-allowed');
                                }
                                if (geminiToggle) {
                                    geminiToggle.disabled = true;
                                    geminiToggle.classList.add('opacity-50', 'cursor-not-allowed');
                                }
                                if (openaiToggle) {
                                    openaiToggle.disabled = true;
                                    openaiToggle.classList.add('opacity-50', 'cursor-not-allowed');
                                }
                                if (apiKeysPremiumMessage) apiKeysPremiumMessage.classList.remove('hidden');
                                if (claudeLocked) claudeLocked.classList.remove('hidden');
                                if (geminiLocked) geminiLocked.classList.remove('hidden');
                                if (openaiLocked) openaiLocked.classList.remove('hidden');
                                // Inicializar ícones do Lucide
                                if (typeof lucide !== 'undefined') {
                                    setTimeout(() => lucide.createIcons(), 100);
                                }
                            } else {
                                // Desbloquear campos
                                if (claudeInput) {
                                    claudeInput.disabled = false;
                                    claudeInput.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                                if (geminiInput) {
                                    geminiInput.disabled = false;
                                    geminiInput.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                                if (openaiInput) {
                                    openaiInput.disabled = false;
                                    openaiInput.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                                // Desbloquear toggles
                                if (claudeToggle) {
                                    claudeToggle.disabled = false;
                                    claudeToggle.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                                if (geminiToggle) {
                                    geminiToggle.disabled = false;
                                    geminiToggle.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                                if (openaiToggle) {
                                    openaiToggle.disabled = false;
                                    openaiToggle.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                                if (apiKeysPremiumMessage) apiKeysPremiumMessage.classList.add('hidden');
                                if (claudeLocked) claudeLocked.classList.add('hidden');
                                if (geminiLocked) geminiLocked.classList.add('hidden');
                                if (openaiLocked) openaiLocked.classList.add('hidden');
                            }
                        }, 500); // Aguardar 500ms para garantir que os elementos existam
                    
                    // Atualiza a mensagem de boas-vindas
                    const welcomeHeading = document.getElementById('welcome-heading');
                    if (welcomeHeading && userData.name) {
                        const firstName = userData.name.split(' ')[0]; // Pega só o primeiro nome
                        welcomeHeading.innerText = `Bem-vindo, ${firstName}!`;
                    }

                    // Mostra o link do painel admin se o utilizador for admin
                    if (userData.isAdmin) {
                        document.getElementById('admin-nav-link').style.display = 'flex';
                    }
                } catch (err) { console.error('Erro ao verificar status do utilizador:', err); }
            }

            async function loadAdminStats() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/stats`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao buscar estatísticas.');
                    const stats = await response.json();
                    document.getElementById('stats-total-users').innerText = stats.totalUsers;
                    document.getElementById('stats-pending-users').innerText = stats.pendingUsers;
                    document.getElementById('stats-online-users').innerText = stats.onlineUsers;
                    document.getElementById('stats-logins-24h').innerText = stats.logins24h;
                } catch (err) {
                    console.error('Erro ao carregar estatísticas do admin:', err);
                }
            }

            async function loadAdminUsers() {
                const search = document.getElementById('admin-search-input').value;
                const status = document.getElementById('admin-status-filter').value;
                let url = `${API_BASE}/api/admin/users?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (status) url += `status=${status}&`;

                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao buscar utilizadores.');
                    const users = await response.json();
                    const tableBody = document.getElementById('admin-user-table-body');
                    if (!tableBody) return;
                    
                    tableBody.innerHTML = ''; 
                    users.forEach((user) => {
                        let statusText, statusClass;
                        if (user.isBlocked) {
                            statusText = 'Bloqueado';
                            statusClass = 'bg-red-500/20 text-red-400';
                        } else if (!user.isApproved) {
                            statusText = 'Pendente';
                            statusClass = 'bg-yellow-500/20 text-yellow-400';
                        } else {
                            statusText = 'Ativo';
                            statusClass = 'bg-green-500/20 text-green-400';
                        }

                        const roleText = user.isAdmin ? 'Admin' : 'Utilizador';
                        const tags = 'N/A'; // Placeholder for tags
                        const whatsappLink = createWhatsAppLink(user.whatsapp);
                        
                        // Formatar plano
                        const planName = user.subscription_plan || user.plan || 'plan-free';
                        const planLabels = {
                            'plan-free': 'FREE',
                            'plan-start': 'START',
                            'plan-turbo': 'TURBO',
                            'plan-master': 'MASTER',
                            'plan-start-annual': 'START ANUAL',
                            'plan-turbo-annual': 'TURBO ANUAL',
                            'plan-master-annual': 'MASTER ANUAL'
                        };
                        const planLabel = planLabels[planName] || planName;
                        const planColors = {
                            'plan-free': 'bg-gray-600/50 text-gray-300',
                            'plan-start': 'bg-blue-600/50 text-blue-300',
                            'plan-turbo': 'bg-yellow-600/50 text-yellow-300',
                            'plan-master': 'bg-purple-600/50 text-purple-300',
                            'plan-start-annual': 'bg-blue-700/50 text-blue-200',
                            'plan-turbo-annual': 'bg-yellow-700/50 text-yellow-200',
                            'plan-master-annual': 'bg-purple-700/50 text-purple-200'
                        };
                        const planColor = planColors[planName] || 'bg-gray-600/50 text-gray-300';

                        tableBody.innerHTML += `
                            <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                <td class="p-3"><input type="checkbox" class="bg-gray-700 border-gray-600 rounded"></td>
                                <td class="p-3 text-sm text-gray-200">${user.email}</td>
                                <td class="p-3 text-sm">${whatsappLink}</td>
                                <td class="p-3 text-sm text-gray-400">${roleText}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${planColor}">
                                        ${planLabel}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                        ${statusText}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-600/50 text-gray-300">
                                        ${tags}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <div class="flex space-x-2">
                                        <button title="Editar" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-blue-500 btn-admin-action" data-action="edit" data-user='${JSON.stringify(user)}'>
                                            <i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="Trocar Senha" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-amber-500 btn-admin-action" data-action="change-password" data-user='${JSON.stringify(user)}'>
                                            <i data-lucide="key" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="${user.isBlocked ? 'Desbloquear' : 'Bloquear'}" class="p-2 rounded-md hover:bg-gray-700 transition-colors ${user.isBlocked ? 'text-green-500' : 'text-red-500'} btn-admin-action" data-action="toggle-block" data-id="${user.id}" data-is-blocked="${user.isBlocked}">
                                            <i data-lucide="${user.isBlocked ? 'unlock' : 'lock'}" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="Alterar Plano" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-purple-500 btn-admin-action" data-action="change-plan" data-id="${user.id}" data-user='${JSON.stringify(user)}'>
                                            <i data-lucide="credit-card" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                        <button title="Excluir" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-red-600 btn-admin-action" data-action="delete" data-id="${user.id}">
                                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) { console.error('Erro ao carregar utilizadores admin:', err); }
            }
            
            // Sistema de Abas do Admin
            function initAdminTabs() {
                const tabButtons = document.querySelectorAll('.admin-tab-btn');
                const tabContents = document.querySelectorAll('.admin-tab-content');
                
                tabButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetTab = btn.dataset.tab;
                        
                        // Remove active de todos os botões
                        tabButtons.forEach(b => {
                            b.classList.remove('active', 'border-amber-500', 'text-white');
                            b.classList.add('text-gray-400');
                        });
                        
                        // Adiciona active ao botão clicado
                        btn.classList.add('active', 'border-amber-500', 'text-white');
                        btn.classList.remove('text-gray-400');
                        
                        // Esconde todos os conteúdos
                        tabContents.forEach(content => {
                            content.style.display = 'none';
                        });
                        
                        // Mostra o conteúdo da aba selecionada
                        const targetContent = document.getElementById(`admin-tab-${targetTab}`);
                        if (targetContent) {
                            targetContent.style.display = 'block';
                            
                            // Carrega dados específicos da aba
                            if (targetTab === 'credits') {
                                loadAdminCredits();
                            } else if (targetTab === 'apis') {
                                loadAdminApis();
                            } else if (targetTab === 'pixel') {
                                loadAdminPixel();
                            } else if (targetTab === 'payments') {
                                loadAdminPayments();
                            } else if (targetTab === 'subscriptions') {
                                attachSubscriptionsListeners();
                                loadAdminSubscriptions();
                            } else if (targetTab === 'storage') {
                                loadAdminStorage();
                            } else if (targetTab === 'notifications') {
                                loadAdminNotifications();
                            } else if (targetTab === 'plan-permissions') {
                                loadAdminPlanPermissions();
                            } else if (targetTab === 'config') {
                                // Carregar configurações SMTP quando a aba de configurações for aberta
                                if (typeof loadSMTPConfig === 'function') {
                                    loadSMTPConfig();
                                }
                            }
                        }
                    });
                });
                
                // Ativa a primeira aba por padrão
                if (tabButtons.length > 0) {
                    tabButtons[0].click();
                }
            }
            
            // Função para carregar e gerenciar notificações
            let purchaseLoopInterval = null;
            let userLoopInterval = null;
            
            async function loadAdminNotifications() {
                try {
                    // Carregar status dos loops
                    const statusResponse = await fetch(`${API_BASE}/api/admin/notifications/loop/status`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (statusResponse.ok) {
                        const status = await statusResponse.json();
                        // Restaurar estado dos loops se estiverem ativos
                        if (status.purchase && status.purchase.is_active) {
                            document.getElementById('purchase-loop-status').textContent = 'Em execução';
                            document.getElementById('start-purchase-loop').disabled = true;
                            document.getElementById('stop-purchase-loop').disabled = false;
                        }
                        if (status.user && status.user.is_active) {
                            document.getElementById('user-loop-status').textContent = 'Em execução';
                            document.getElementById('start-user-loop').disabled = true;
                            document.getElementById('stop-user-loop').disabled = false;
                        }
                    }
                    
                    // Carregar configurações
                    const configResponse = await fetch(`${API_BASE}/api/admin/notifications/config`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (configResponse.ok) {
                        const config = await configResponse.json();
                        document.getElementById('notif-purchase-enabled').checked = config.purchase_enabled;
                        document.getElementById('notif-purchase-interval').value = config.purchase_interval;
                        document.getElementById('notif-purchase-message').value = config.purchase_message;
                        document.getElementById('notif-user-enabled').checked = config.user_enabled;
                        document.getElementById('notif-user-interval').value = config.user_interval;
                        document.getElementById('notif-user-message').value = config.user_message;
                    }
                    
                    // Carregar usuários fictícios
                    await loadFakeUsers();
                    
                    // Botão para criar usuários em massa
                    const createBulkUsersBtn = document.getElementById('create-bulk-users-btn');
                    if (createBulkUsersBtn) {
                        // Remover listener antigo se existir
                        const newBtn = createBulkUsersBtn.cloneNode(true);
                        createBulkUsersBtn.parentNode.replaceChild(newBtn, createBulkUsersBtn);
                        newBtn.addEventListener('click', createBulkUsers);
                    }
                    
                    // Remover event listeners antigos para evitar duplicação
                    const oldSaveBtn = document.getElementById('save-notifications-config');
                    const oldAddBtn = document.getElementById('add-fake-user-btn');
                    const oldStartPurchase = document.getElementById('start-purchase-loop');
                    const oldStopPurchase = document.getElementById('stop-purchase-loop');
                    const oldStartUser = document.getElementById('start-user-loop');
                    const oldStopUser = document.getElementById('stop-user-loop');
                    
                    // Clonar e substituir para remover listeners antigos
                    if (oldSaveBtn) {
                        const newSaveBtn = oldSaveBtn.cloneNode(true);
                        oldSaveBtn.parentNode.replaceChild(newSaveBtn, oldSaveBtn);
                    }
                    if (oldAddBtn) {
                        const newAddBtn = oldAddBtn.cloneNode(true);
                        oldAddBtn.parentNode.replaceChild(newAddBtn, oldAddBtn);
                    }
                    if (oldStartPurchase) {
                        const newStartPurchase = oldStartPurchase.cloneNode(true);
                        oldStartPurchase.parentNode.replaceChild(newStartPurchase, oldStartPurchase);
                    }
                    if (oldStopPurchase) {
                        const newStopPurchase = oldStopPurchase.cloneNode(true);
                        oldStopPurchase.parentNode.replaceChild(newStopPurchase, oldStopPurchase);
                    }
                    if (oldStartUser) {
                        const newStartUser = oldStartUser.cloneNode(true);
                        oldStartUser.parentNode.replaceChild(newStartUser, oldStartUser);
                    }
                    if (oldStopUser) {
                        const newStopUser = oldStopUser.cloneNode(true);
                        oldStopUser.parentNode.replaceChild(newStopUser, oldStopUser);
                    }
                    
                    // Adicionar event listeners
                    document.getElementById('save-notifications-config')?.addEventListener('click', saveNotificationsConfig);
                    document.getElementById('test-notification-btn')?.addEventListener('click', testNotification);
                    document.getElementById('add-fake-user-btn')?.addEventListener('click', showAddFakeUserModal);
                    document.getElementById('start-purchase-loop')?.addEventListener('click', startPurchaseLoop);
                    document.getElementById('stop-purchase-loop')?.addEventListener('click', stopPurchaseLoop);
                    document.getElementById('start-user-loop')?.addEventListener('click', startUserLoop);
                    document.getElementById('stop-user-loop')?.addEventListener('click', stopUserLoop);
                } catch (err) {
                    console.error('Erro ao carregar notificações:', err);
                    showMessage('admin-error-message', 'Erro ao carregar configurações de notificações', true);
                }
            }
            
            // Função para testar notificação
            async function testNotification() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/notifications/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            title: 'Teste de Notificação',
                            message: 'Esta é uma notificação de teste! 🎉',
                            type: 'info',
                            user_id: null
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Notificação de teste criada! Ela aparecerá em alguns segundos.');
                        // Forçar busca imediata de notificações
                        setTimeout(async () => {
                            try {
                                const notifResponse = await fetch(`${API_BASE}/api/notifications/pending`, {
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                if (notifResponse.ok) {
                                    const notifications = await notifResponse.json();
                                    if (notifications && notifications.length > 0) {
                                        notifications.forEach(notif => {
                                            showNotification(notif.title, notif.message, notif.type, 5000);
                                            fetch(`${API_BASE}/api/notifications/${notif.id}/read`, {
                                                method: 'POST',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            }).catch(() => {});
                                        });
                                    }
                                }
                            } catch (err) {
                                console.error('Erro ao buscar notificação de teste:', err);
                            }
                        }, 1000);
                    } else {
                        throw new Error('Erro ao criar notificação de teste');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }
            
            async function saveNotificationsConfig() {
                try {
                    const config = {
                        purchase_enabled: document.getElementById('notif-purchase-enabled').checked,
                        purchase_interval: parseInt(document.getElementById('notif-purchase-interval').value),
                        purchase_message: document.getElementById('notif-purchase-message').value,
                        user_enabled: document.getElementById('notif-user-enabled').checked,
                        user_interval: parseInt(document.getElementById('notif-user-interval').value),
                        user_message: document.getElementById('notif-user-message').value
                    };
                    
                    const response = await fetch(`${API_BASE}/api/admin/notifications/config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify(config)
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Configurações salvas com sucesso!');
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar configurações');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }
            
            async function loadFakeUsers() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        const tbody = document.getElementById('fake-users-table-body');
                        if (!tbody) return;
                        
                        tbody.innerHTML = '';
                        
                        if (users.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhum usuário fictício cadastrado</td></tr>';
                        } else {
                            users.forEach(user => {
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-3 text-sm text-white">${user.name}</td>
                                        <td class="p-3 text-sm text-gray-300">${user.email}</td>
                                        <td class="p-3">
                                            <div class="flex flex-col gap-1">
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.type === 'purchase' ? 'bg-green-700 text-white' : 'bg-blue-700 text-white'}">
                                                    ${user.type === 'purchase' ? 'Compra' : 'Usuário'}
                                                </span>
                                                ${user.plan_name ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-700 text-white">${user.plan_name}</span>` : ''}
                                            </div>
                                        </td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.is_active ? 'bg-green-700 text-white' : 'bg-gray-700 text-gray-300'}">
                                                ${user.is_active ? 'Ativo' : 'Inativo'}
                                            </span>
                                        </td>
                                        <td class="p-3">
                                            <button class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded btn-delete-fake-user" data-id="${user.id}">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Event listeners para deletar
                            document.querySelectorAll('.btn-delete-fake-user').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const id = btn.dataset.id;
                                    const confirmed = await showCustomConfirm('Tem certeza que deseja deletar este usuário fictício?');
                                    if (!confirmed) return;
                                    
                                    try {
                                        const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users/${id}`, {
                                            method: 'DELETE',
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        });
                                        
                                        if (response.ok) {
                                            showMessage('admin-success-message', 'Usuário fictício deletado com sucesso!');
                                            loadFakeUsers();
                                        } else {
                                            throw new Error('Erro ao deletar usuário fictício');
                                        }
                                    } catch (err) {
                                        showMessage('admin-error-message', err.message, true);
                                    }
                                });
                            });
                        }
                        
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                } catch (err) {
                    console.error('Erro ao carregar usuários fictícios:', err);
                }
            }
            
            // Função para criar usuários em massa
            async function createBulkUsers() {
                const confirmed = await showCustomConfirm(
                    'Isso criará 100 usuários fictícios (50 para compras e 50 para novos usuários). Deseja continuar?',
                    'Criar Usuários em Massa'
                );
                if (!confirmed) return;
                
                const emails = [
                    'carlos.ventura@gmail.com', 'ana.clarice@gmail.com', 'lucas.araujo@gmail.com', 'mariana.teixeira@gmail.com', 'pedro.mendes@gmail.com',
                    'julia.freitas@gmail.com', 'victor.cardoso@gmail.com', 'renata.costa@gmail.com', 'felipe.andrade@gmail.com', 'larissa.dias@gmail.com',
                    'rodrigo.silveira@hotmail.com', 'tamara.ramos@hotmail.com', 'eduardo.santos@hotmail.com', 'bianca.motta@hotmail.com', 'igor.felix@hotmail.com',
                    'aline.martins@hotmail.com', 'caio.monteiro@hotmail.com', 'priscila.souza@hotmail.com', 'daniel.bernardo@hotmail.com', 'gabriela.torres@hotmail.com',
                    'joao.castro@uol.com.br', 'rafaela.lima@uol.com.br', 'diego.siqueira@uol.com.br', 'carolina.amaral@uol.com.br', 'ricardo.prado@uol.com.br',
                    'elisa.nogueira@uol.com.br', 'tiago.rodrigues@uol.com.br', 'beatriz.vasconcelos@uol.com.br', 'henrique.moraes@uol.com.br', 'fabiana.dias@uol.com.br',
                    'sofia.santana@gmail.com', 'bruno.pereira@gmail.com', 'luciana.castro@gmail.com', 'marcelo.correia@gmail.com', 'patricia.monteiro@gmail.com',
                    'leonardo.silva@hotmail.com', 'isabela.nunes@hotmail.com', 'adriano.almeida@hotmail.com', 'cristina.mello@hotmail.com', 'vitor.macedo@hotmail.com',
                    'micaela.luz@uol.com.br', 'rogerio.martins@uol.com.br', 'eduarda.pinho@uol.com.br', 'fernando.reis@uol.com.br', 'jessica.moraes@uol.com.br',
                    'alexandre.campos@gmail.com', 'natasha.coelho@hotmail.com', 'brenda.macedo@uol.com.br', 'enzo.guimaraes@gmail.com', 'helena.souza@hotmail.com'
                ];
                
                // Função para extrair primeiro nome do email
                const getFirstName = (email) => {
                    if (!email || typeof email !== 'string') {
                        return 'Usuário';
                    }
                    try {
                        const namePart = email.split('@')[0];
                        if (!namePart) return 'Usuário';
                        const parts = namePart.split('.');
                        const firstName = parts[0] || namePart;
                        return firstName.charAt(0).toUpperCase() + firstName.slice(1);
                    } catch (err) {
                        console.error('Erro ao extrair nome do email:', email, err);
                        return 'Usuário';
                    }
                };
                
                // Criar lista de usuários
                const users = [];
                
                // Primeiros 50 para compras (com planos aleatórios)
                for (let i = 0; i < 50 && i < emails.length; i++) {
                    const email = emails[i];
                    if (email && typeof email === 'string') {
                        users.push({
                            name: getFirstName(email),
                            email: email,
                            type: 'purchase',
                            plan_name: null // Aleatório
                        });
                    }
                }
                
                // Últimos 50 para novos usuários
                for (let i = 50; i < emails.length; i++) {
                    const email = emails[i];
                    if (email && typeof email === 'string') {
                        users.push({
                            name: getFirstName(email),
                            email: email,
                            type: 'user',
                            plan_name: null
                        });
                    }
                }
                
                if (users.length === 0) {
                    showMessage('admin-error-message', 'Nenhum email válido encontrado!', true);
                    return;
                }
                
                try {
                    showMessage('admin-success-message', `Criando ${users.length} usuários... Aguarde.`);
                    
                    console.log('[BULK USERS] Total de usuários a criar:', users.length);
                    console.log('[BULK USERS] Primeiros 3:', users.slice(0, 3));
                    
                    const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ bulk: true, users })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showMessage('admin-success-message', `${result.created || users.length} usuários fictícios criados com sucesso!`);
                        loadFakeUsers();
                    } else {
                        throw new Error(result.message || 'Erro ao criar usuários');
                    }
                } catch (err) {
                    console.error('[BULK USERS] Erro completo:', err);
                    showMessage('admin-error-message', err.message || 'Erro ao criar usuários', true);
                }
            }
            
            async function showAddFakeUserModal() {
                const name = await showCustomPrompt('Nome do usuário fictício:', '', 'Adicionar Usuário Fictício');
                if (!name) return;
                
                const email = await showCustomPrompt('Email do usuário fictício:', `fake${Date.now()}@example.com`, 'Adicionar Usuário Fictício');
                if (!email) return;
                
                // Criar modal para selecionar tipo e plano
                const modal = document.getElementById('custom-modal-overlay');
                const messageEl = document.getElementById('custom-modal-message');
                const inputEl = document.getElementById('custom-modal-input');
                const titleEl = document.getElementById('custom-modal-title-text');
                
                titleEl.textContent = 'Adicionar Usuário Fictício';
                messageEl.innerHTML = `
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Tipo de notificação:</label>
                            <select id="temp-type-select" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                <option value="purchase">Compra</option>
                                <option value="user">Usuário Novo</option>
                            </select>
                        </div>
                        <div id="plan-select-container" style="display: none;">
                            <label class="block text-sm text-gray-400 mb-2">Plano (para notificações de compra):</label>
                            <select id="temp-plan-select" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                <option value="">Aleatório</option>
                                <option value="START CREATOR">START CREATOR</option>
                                <option value="TURBO MAKER">TURBO MAKER</option>
                                <option value="MASTER PRO">MASTER PRO</option>
                            </select>
                        </div>
                    </div>
                `;
                inputEl.style.display = 'none';
                
                modal.style.display = 'flex';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                const typeSelect = document.getElementById('temp-type-select');
                const planSelect = document.getElementById('temp-plan-select');
                const planContainer = document.getElementById('plan-select-container');
                
                // Mostrar/ocultar seleção de plano baseado no tipo
                typeSelect.addEventListener('change', () => {
                    planContainer.style.display = typeSelect.value === 'purchase' ? 'block' : 'none';
                });
                
                const confirmBtn = document.getElementById('custom-modal-confirm');
                const cancelBtn = document.getElementById('custom-modal-cancel');
                const closeBtn = document.getElementById('custom-modal-close');
                
                const cleanup = () => {
                    modal.style.display = 'none';
                    messageEl.innerHTML = '';
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    closeBtn.onclick = null;
                    typeSelect.onchange = null;
                };
                
                confirmBtn.onclick = async () => {
                    const type = typeSelect.value;
                    const planName = type === 'purchase' ? planSelect.value : null;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ name, email, type, plan_name: planName || null })
                        });
                        
                        if (response.ok) {
                            showMessage('admin-success-message', 'Usuário fictício criado com sucesso!');
                            loadFakeUsers();
                        } else {
                            const error = await response.json();
                            throw new Error(error.message || 'Erro ao criar usuário fictício');
                        }
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    }
                    cleanup();
                };
                
                cancelBtn.onclick = cleanup;
                closeBtn.onclick = cleanup;
            }
            
            async function startPurchaseLoop() {
                if (purchaseLoopInterval) return;
                
                const enabled = document.getElementById('notif-purchase-enabled').checked;
                if (!enabled) {
                    showMessage('admin-error-message', 'Ative as notificações de compra primeiro!', true);
                    return;
                }
                
                const interval = parseInt(document.getElementById('notif-purchase-interval').value) * 1000;
                const message = document.getElementById('notif-purchase-message').value;
                
                // Buscar usuários fictícios de compra
                const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: 'Erro ao buscar usuários fictícios' }));
                    throw new Error(error.message || 'Erro ao buscar usuários fictícios');
                }
                
                const users = await response.json();
                const purchaseUsers = users.filter(u => u.type === 'purchase' && u.is_active);
                
                if (purchaseUsers.length === 0) {
                    showMessage('admin-error-message', 'Nenhum usuário fictício de compra cadastrado!', true);
                    return;
                }
                
                // Função para criar notificação de compra
                const createPurchaseNotification = async () => {
                    // Selecionar usuário aleatório
                    const randomUserIndex = Math.floor(Math.random() * purchaseUsers.length);
                    const user = purchaseUsers[randomUserIndex];
                    
                    // Usar plano do usuário fictício ou plano aleatório
                    const planNames = ['START CREATOR', 'TURBO MAKER', 'MASTER PRO'];
                    const plan = user.plan_name || planNames[Math.floor(Math.random() * planNames.length)];
                    
                    const notificationMessage = message
                        .replace('{name}', user.name)
                        .replace('{plan}', plan);
                    
                    // Criar notificação global (user_id = null)
                    await fetch(`${API_BASE}/api/admin/notifications/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            title: 'Nova Compra!',
                            message: notificationMessage,
                            type: 'purchase',
                            user_id: null
                        })
                    });
                };
                
                // Criar primeira notificação imediatamente
                createPurchaseNotification();
                
                // Agendar próxima notificação com intervalo aleatório
                const scheduleNext = () => {
                    // Intervalo aleatório entre 50% e 150% do intervalo configurado
                    const minInterval = interval * 0.5;
                    const maxInterval = interval * 1.5;
                    const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval) + minInterval);
                    
                    purchaseLoopInterval = setTimeout(async () => {
                        await createPurchaseNotification();
                        scheduleNext();
                    }, randomInterval);
                };
                
                scheduleNext();
                
                document.getElementById('start-purchase-loop').disabled = true;
                document.getElementById('stop-purchase-loop').disabled = false;
                document.getElementById('purchase-loop-status').textContent = 'Em execução';
            }
            
            function stopPurchaseLoop() {
                if (purchaseLoopInterval) {
                    clearTimeout(purchaseLoopInterval);
                    purchaseLoopInterval = null;
                }
                document.getElementById('start-purchase-loop').disabled = false;
                document.getElementById('stop-purchase-loop').disabled = true;
                document.getElementById('purchase-loop-status').textContent = 'Parado';
            }
            
            async function startUserLoop() {
                if (userLoopInterval) return;
                
                const enabled = document.getElementById('notif-user-enabled').checked;
                if (!enabled) {
                    showMessage('admin-error-message', 'Ative as notificações de novos usuários primeiro!', true);
                    return;
                }
                
                const interval = parseInt(document.getElementById('notif-user-interval').value);
                const message = document.getElementById('notif-user-message').value;
                
                // Salvar estado no banco de dados
                try {
                    await fetch(`${API_BASE}/api/admin/notifications/loop/start`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            loop_type: 'user',
                            interval_seconds: interval
                        })
                    });
                } catch (err) {
                    console.error('Erro ao salvar estado do loop:', err);
                }
                
                // Buscar usuários fictícios de usuário
                const response = await fetch(`${API_BASE}/api/admin/notifications/fake-users`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ message: 'Erro ao buscar usuários fictícios' }));
                    throw new Error(error.message || 'Erro ao buscar usuários fictícios');
                }
                
                const users = await response.json();
                const userUsers = users.filter(u => u.type === 'user' && u.is_active);
                
                if (userUsers.length === 0) {
                    showMessage('admin-error-message', 'Nenhum usuário fictício de novo usuário cadastrado!', true);
                    return;
                }
                
                // Função para criar notificação de novo usuário
                const createUserNotification = async () => {
                    // Selecionar usuário aleatório
                    const randomUserIndex = Math.floor(Math.random() * userUsers.length);
                    const user = userUsers[randomUserIndex];
                    
                    const notificationMessage = message.replace('{name}', user.name);
                    
                    // Criar notificação global (user_id = null)
                    await fetch(`${API_BASE}/api/admin/notifications/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            title: 'Novo Usuário!',
                            message: notificationMessage,
                            type: 'user',
                            user_id: null
                        })
                    });
                };
                
                // Criar primeira notificação imediatamente
                createUserNotification();
                
                // Agendar próxima notificação com intervalo aleatório
                const scheduleNext = () => {
                    // Intervalo aleatório entre 50% e 150% do intervalo configurado
                    const intervalMs = interval * 1000;
                    const minInterval = intervalMs * 0.5;
                    const maxInterval = intervalMs * 1.5;
                    const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval) + minInterval);
                    
                    userLoopInterval = setTimeout(async () => {
                        await createUserNotification();
                        scheduleNext();
                    }, randomInterval);
                };
                
                scheduleNext();
                
                document.getElementById('start-user-loop').disabled = true;
                document.getElementById('stop-user-loop').disabled = false;
                document.getElementById('user-loop-status').textContent = 'Em execução';
            }
            
            async function stopUserLoop() {
                if (userLoopInterval) {
                    clearTimeout(userLoopInterval);
                    userLoopInterval = null;
                }
                
                // Salvar estado no banco de dados
                try {
                    await fetch(`${API_BASE}/api/admin/notifications/loop/stop`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            loop_type: 'user'
                        })
                    });
                } catch (err) {
                    console.error('Erro ao salvar estado do loop:', err);
                }
                
                document.getElementById('start-user-loop').disabled = false;
                document.getElementById('stop-user-loop').disabled = true;
                document.getElementById('user-loop-status').textContent = 'Parado';
            }

            // Função para carregar permissões de planos
            async function loadAdminPlanPermissions() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/plan-permissions`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) throw new Error('Erro ao carregar permissões');
                    
                    const permissions = await response.json();
                    
                    // Carregar créditos
                    const planNames = ['plan-free', 'plan-start', 'plan-turbo', 'plan-master', 
                                     'plan-start-annual', 'plan-turbo-annual', 'plan-master-annual'];
                    const planLabels = {
                        'plan-free': 'FREE',
                        'plan-start': 'START CREATOR',
                        'plan-turbo': 'TURBO MAKER',
                        'plan-master': 'MASTER PRO',
                        'plan-start-annual': 'START ANUAL',
                        'plan-turbo-annual': 'TURBO ANUAL',
                        'plan-master-annual': 'MASTER ANUAL'
                    };
                    
                    // Renderizar créditos
                    const creditsList = document.getElementById('plan-credits-list');
                    if (creditsList) {
                        creditsList.innerHTML = '';
                        planNames.forEach(planName => {
                            const planData = permissions[planName] || { monthly_credits: 0 };
                            creditsList.innerHTML += `
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
                                    <h3 class="text-lg font-semibold text-white mb-2">${planLabels[planName] || planName}</h3>
                                    <input type="number" id="credits-${planName}" value="${planData.monthly_credits || 0}" 
                                           class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white mb-2">
                                    <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg btn-save-credits" 
                                            data-plan="${planName}">
                                        Salvar Créditos
                                    </button>
                                </div>
                            `;
                        });
                        
                        // Event listeners para salvar créditos
                        document.querySelectorAll('.btn-save-credits').forEach(btn => {
                            btn.addEventListener('click', async () => {
                                const planName = btn.dataset.plan;
                                const credits = parseInt(document.getElementById(`credits-${planName}`).value);
                                
                                try {
                                    const response = await fetch(`${API_BASE}/api/admin/plan-credits/${planName}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${userToken}`
                                        },
                                        body: JSON.stringify({ monthly_credits: credits })
                                    });
                                    
                                    if (response.ok) {
                                        showMessage('admin-success-message', `Créditos do plano ${planLabels[planName]} atualizados!`);
                                    } else {
                                        throw new Error('Erro ao salvar créditos');
                                    }
                                } catch (err) {
                                    showMessage('admin-error-message', err.message, true);
                                }
                            });
                        });
                    }
                    
                    // Renderizar permissões
                    const features = [
                        { name: 'video_analyzer', label: 'Analisador de Vídeos' },
                        { name: 'niche_explorer', label: 'Explorar Nicho' },
                        { name: 'script_generator', label: 'Gerador de Roteiro' },
                        { name: 'voice_generator', label: 'Gerador de Voz' },
                        { name: 'image_generator', label: 'Gerador de Imagens' },
                        { name: 'video_generator', label: 'Gerador de Vídeo' },
                        { name: 'youtube_integration', label: 'Integração YouTube' },
                        { name: 'api_propria', label: 'API Própria' },
                        { name: 'batch_images', label: 'Imagens em Lote' },
                        { name: 'analytics', label: 'Analytics' },
                        { name: 'viral_library', label: 'Biblioteca Virais' }
                    ];
                    
                    const permissionsList = document.getElementById('plan-permissions-list');
                    if (permissionsList) {
                        permissionsList.innerHTML = '';
                        
                        planNames.forEach(planName => {
                            const planData = permissions[planName] || { features: {} };
                            permissionsList.innerHTML += `
                                <div class="bg-gray-900 border border-gray-700 rounded-lg p-6">
                                    <h3 class="text-xl font-semibold text-white mb-4">${planLabels[planName] || planName}</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        ${features.map(feature => {
                                            const isAllowed = planData.features && planData.features[feature.name] === true;
                                            return `
                                                <label class="flex items-center p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-750 transition">
                                                    <input type="checkbox" 
                                                           class="mr-3 w-4 h-4 text-amber-500 rounded focus:ring-amber-500" 
                                                           ${isAllowed ? 'checked' : ''}
                                                           data-plan="${planName}" 
                                                           data-feature="${feature.name}">
                                                    <span class="text-gray-300">${feature.label}</span>
                                                </label>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        });
                        
                        // Event listeners para checkboxes
                        document.querySelectorAll('input[type="checkbox"][data-plan]').forEach(checkbox => {
                            checkbox.addEventListener('change', async () => {
                                const planName = checkbox.dataset.plan;
                                const featureName = checkbox.dataset.feature;
                                const isAllowed = checkbox.checked;
                                
                                try {
                                    const response = await fetch(`${API_BASE}/api/admin/plan-permissions/${planName}/${featureName}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${userToken}`
                                        },
                                        body: JSON.stringify({ is_allowed: isAllowed })
                                    });
                                    
                                    if (response.ok) {
                                        showMessage('admin-success-message', 'Permissão atualizada com sucesso!');
                                    } else {
                                        checkbox.checked = !isAllowed; // Reverter
                                        throw new Error('Erro ao atualizar permissão');
                                    }
                                } catch (err) {
                                    showMessage('admin-error-message', err.message, true);
                                }
                            });
                        });
                    }
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar permissões:', err);
                    showMessage('admin-error-message', 'Erro ao carregar permissões de planos', true);
                }
            }

            // Variáveis para paginação de créditos
            let currentCreditsPage = 1;
            const creditsPerPage = 20;
            
            // Carregar configurações globais
            async function loadGlobalSettings() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        document.getElementById('initial-bonus-credits').value = settings.initial_bonus_credits || 0;
                        document.getElementById('tts-credits-multiplier').value = settings.tts_credits_multiplier || 1.0;
                    }
                } catch (err) {
                    console.error('Erro ao carregar configurações:', err);
                }
            }
            
            // Salvar configurações globais
            document.getElementById('save-global-settings')?.addEventListener('click', async () => {
                try {
                    const initialBonus = parseFloat(document.getElementById('initial-bonus-credits').value) || 0;
                    const ttsMultiplier = parseFloat(document.getElementById('tts-credits-multiplier').value) || 1.0;
                    
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                initial_bonus_credits: initialBonus,
                                tts_credits_multiplier: ttsMultiplier
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Configurações salvas com sucesso');
                    } else {
                        throw new Error('Erro ao salvar configurações');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Consultar saldo
            document.getElementById('consult-balance-btn')?.addEventListener('click', async () => {
                const identifier = document.getElementById('consult-balance-search').value.trim();
                if (!identifier) {
                    showMessage('admin-error-message', 'Digite um email, nome ou WhatsApp', true);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/credits/balance`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ identifier })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('consult-balance-user-info').textContent = `${data.user.email} (${data.user.name || 'N/A'})`;
                        document.getElementById('consult-balance-amount').textContent = `${parseFloat(data.balance || 0).toFixed(2)} créditos`;
                        document.getElementById('consult-balance-result').classList.remove('hidden');
                    } else {
                        const error = await response.json();
                        showMessage('admin-error-message', error.message || 'Usuário não encontrado', true);
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Buscar usuários
            document.getElementById('search-users-btn')?.addEventListener('click', async () => {
                const search = document.getElementById('search-users-input').value.trim();
                if (!search) {
                    showMessage('admin-error-message', 'Digite algo para buscar', true);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users?search=${encodeURIComponent(search)}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        const resultsDiv = document.getElementById('search-users-results');
                        resultsDiv.classList.remove('hidden');
                        
                        if (users.length === 0) {
                            resultsDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum usuário encontrado</p>';
                        } else {
                            resultsDiv.innerHTML = `
                                <div class="space-y-2">
                                    ${users.map(user => `
                                        <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                            <p class="text-white font-semibold">${user.email}</p>
                                            <p class="text-gray-400 text-sm">${user.name || 'N/A'} - ${user.whatsapp || 'N/A'}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Adicionar créditos individual
            let selectedUserIdForCredits = null;
            
            document.getElementById('add-credits-user-search')?.addEventListener('input', async (e) => {
                const search = e.target.value.trim();
                if (search.length < 2) {
                    document.getElementById('add-credits-user-results').classList.add('hidden');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/users?search=${encodeURIComponent(search)}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        const resultsDiv = document.getElementById('add-credits-user-results');
                        resultsDiv.classList.remove('hidden');
                        
                        if (users.length === 0) {
                            resultsDiv.innerHTML = '<p class="text-gray-400 text-sm">Nenhum usuário encontrado</p>';
                        } else {
                            resultsDiv.innerHTML = `
                                <div class="space-y-1 bg-gray-900 rounded-lg p-2 border border-gray-700">
                                    ${users.slice(0, 5).map(user => `
                                        <button class="w-full text-left p-2 hover:bg-gray-800 rounded text-sm text-white user-select-btn" data-user-id="${user.id}" data-user-email="${user.email}">
                                            ${user.email} - ${user.name || 'N/A'}
                                        </button>
                                    `).join('')}
                                </div>
                            `;
                            
                            document.querySelectorAll('.user-select-btn').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    selectedUserIdForCredits = btn.dataset.userId;
                                    document.getElementById('add-credits-user-search').value = btn.dataset.userEmail;
                                    resultsDiv.classList.add('hidden');
                                });
                            });
                        }
                    }
                } catch (err) {
                    console.error('Erro ao buscar usuários:', err);
                }
            });
            
            document.getElementById('add-credits-btn')?.addEventListener('click', async () => {
                if (!selectedUserIdForCredits) {
                    showMessage('admin-error-message', 'Selecione um usuário primeiro', true);
                    return;
                }
                
                const amount = parseFloat(document.getElementById('add-credits-amount').value);
                const description = document.getElementById('add-credits-description').value;
                
                if (!amount || amount <= 0) {
                    showMessage('admin-error-message', 'Digite uma quantidade válida', true);
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/credits/add`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            user_id: selectedUserIdForCredits,
                            amount: amount,
                            description: description || 'Créditos adicionados pelo administrador'
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Créditos adicionados com sucesso');
                        document.getElementById('add-credits-amount').value = '';
                        document.getElementById('add-credits-description').value = '';
                        document.getElementById('add-credits-user-search').value = '';
                        selectedUserIdForCredits = null;
                        loadAdminCreditsTable();
                    } else {
                        throw new Error('Erro ao adicionar créditos');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Carregar tabela de usuários com créditos
            async function loadAdminCreditsTable(page = 1) {
                try {
                    const minBalance = parseFloat(document.getElementById('min-balance-filter')?.value || 0);
                    const offset = (page - 1) * creditsPerPage;
                    
                    const response = await fetch(`${API_BASE}/api/admin/credits/users-with-balance?min_balance=${minBalance}&limit=${creditsPerPage}&offset=${offset}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const tbody = document.getElementById('admin-credits-table-body');
                        tbody.innerHTML = '';
                        
                        if (data.users.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-400">Nenhum usuário encontrado</td></tr>';
                        } else {
                            data.users.forEach(user => {
                                const lastUpdated = user.last_updated 
                                    ? new Date(user.last_updated).toLocaleString('pt-BR')
                                    : 'N/A';
                                
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-3"><input type="checkbox" class="user-checkbox bg-gray-700 border-gray-600 rounded" data-user-id="${user.id}"></td>
                                        <td class="p-3 text-sm text-gray-200">${user.email}</td>
                                        <td class="p-3 text-sm text-gray-200">${user.whatsapp || 'N/A'}</td>
                                        <td class="p-3 text-sm text-gray-200">N/A</td>
                                        <td class="p-3 text-sm font-bold text-yellow-400">${parseFloat(user.balance || 0).toFixed(2)}</td>
                                        <td class="p-3 text-sm text-gray-400">${lastUpdated}</td>
                                        <td class="p-3">
                                            <div class="flex gap-2">
                                                <button class="px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded btn-edit-user-credits" data-user-id="${user.id}" data-user-email="${user.email}">
                                                    Editar
                                                </button>
                                                <button class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded btn-reset-user-credits" data-user-id="${user.id}">
                                                    Zerar
                                                </button>
                                                <button class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded btn-history-user-credits" data-user-id="${user.id}">
                                                    Histórico
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Event listeners
                            document.querySelectorAll('.btn-edit-user-credits').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const userId = btn.dataset.userId;
                                    const userEmail = btn.dataset.userEmail;
                                    showManageCreditsModal(userId, userEmail);
                                });
                            });
                            
                            document.querySelectorAll('.btn-reset-user-credits').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const userId = btn.dataset.userId;
                                    const confirmed = await showCustomConfirm('Tem certeza que deseja zerar os créditos deste usuário?');
                                    if (!confirmed) return;
                                    
                                    try {
                                        const response = await fetch(`${API_BASE}/api/admin/credits/reset`, {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${userToken}`
                                            },
                                            body: JSON.stringify({ user_id: userId })
                                        });
                                        
                                        if (response.ok) {
                                            showMessage('admin-success-message', 'Créditos zerados com sucesso');
                                            loadAdminCreditsTable(currentCreditsPage);
                                        } else {
                                            throw new Error('Erro ao zerar créditos');
                                        }
                                    } catch (err) {
                                        showMessage('admin-error-message', err.message, true);
                                    }
                                });
                            });
                            
                            document.querySelectorAll('.btn-history-user-credits').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const userId = btn.dataset.userId;
                                    try {
                                        const response = await fetch(`${API_BASE}/api/admin/credits/transactions/${userId}`, {
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        });
                                        
                                        if (response.ok) {
                                            const data = await response.json();
                                            showCreditsHistoryModal(data.data, userId);
                                        }
                                    } catch (err) {
                                        showMessage('admin-error-message', err.message, true);
                                    }
                                });
                            });
                            
                            // Paginação
                            const totalPages = Math.ceil(data.total / creditsPerPage);
                            const paginationDiv = document.getElementById('credits-pagination');
                            if (paginationDiv) {
                                let paginationHtml = '';
                                if (currentCreditsPage > 1) {
                                    paginationHtml += `<a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700 prev-page">Anterior</a>`;
                                }
                                for (let i = 1; i <= totalPages && i <= 5; i++) {
                                    paginationHtml += `<a href="#" class="px-3 py-1 rounded-md ${i === currentCreditsPage ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'} page-link" data-page="${i}">${i}</a>`;
                                }
                                if (currentCreditsPage < totalPages) {
                                    paginationHtml += `<a href="#" class="px-3 py-1 rounded-md text-gray-400 hover:bg-gray-700 next-page">Próximo</a>`;
                                }
                                paginationDiv.innerHTML = paginationHtml;
                                
                                document.querySelectorAll('.page-link').forEach(link => {
                                    link.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        currentCreditsPage = parseInt(link.dataset.page);
                                        loadAdminCreditsTable(currentCreditsPage);
                                    });
                                });
                                
                                document.querySelector('.prev-page')?.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (currentCreditsPage > 1) {
                                        currentCreditsPage--;
                                        loadAdminCreditsTable(currentCreditsPage);
                                    }
                                });
                                
                                document.querySelector('.next-page')?.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    if (currentCreditsPage < totalPages) {
                                        currentCreditsPage++;
                                        loadAdminCreditsTable(currentCreditsPage);
                                    }
                                });
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar tabela de créditos:', err);
                }
            }
            
            // Carregar créditos no admin
            async function loadAdminCredits() {
                await loadGlobalSettings();
                await loadAdminCreditsTable();
                
                // Carregar estatísticas
                try {
                    const statsResponse = await fetch(`${API_BASE}/api/admin/credits/statistics`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        document.getElementById('admin-total-credits').textContent = parseFloat(stats.totalDistributed || 0).toFixed(2);
                        document.getElementById('admin-users-with-credits').textContent = stats.usersWithCredits || 0;
                        document.getElementById('admin-credits-used').textContent = parseFloat(stats.creditsUsed30Days || 0).toFixed(2);
                    }
                } catch (err) {
                    console.error('Erro ao carregar estatísticas:', err);
                }
            }
            
            // Atualizar tabela quando mudar filtro de saldo mínimo
            document.getElementById('min-balance-filter')?.addEventListener('change', () => {
                currentCreditsPage = 1;
                loadAdminCreditsTable();
            });
            
            // Botão atualizar
            document.getElementById('refresh-credits-table')?.addEventListener('click', () => {
                loadAdminCreditsTable(currentCreditsPage);
            });
            
            // Carregar estatísticas
            document.getElementById('load-statistics-btn')?.addEventListener('click', async () => {
                const startDate = document.getElementById('stats-start-date').value;
                const endDate = document.getElementById('stats-end-date').value;
                
                try {
                    let url = `${API_BASE}/api/admin/credits/statistics?`;
                    if (startDate) url += `startDate=${startDate}&`;
                    if (endDate) url += `endDate=${endDate}`;
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const stats = await response.json();
                        const resultsDiv = document.getElementById('statistics-results');
                        resultsDiv.classList.remove('hidden');
                        
                        resultsDiv.innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400">Total de Operações</p>
                                    <p class="text-2xl font-bold text-white mt-1">${stats.summary?.total_operations || 0}</p>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400">Total de Créditos Usados</p>
                                    <p class="text-2xl font-bold text-white mt-1">${parseFloat(stats.summary?.total_credits || 0).toFixed(2)}</p>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400">Usuários Únicos</p>
                                    <p class="text-2xl font-bold text-white mt-1">${stats.summary?.unique_users || 0}</p>
                                </div>
                            </div>
                            <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                                <h3 class="text-lg font-semibold text-white mb-4">Top 10 Usuários</h3>
                                <div class="space-y-2">
                                    ${(stats.byUser || []).slice(0, 10).map(user => `
                                        <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                                            <span class="text-white text-sm">${user.email}</span>
                                            <span class="text-yellow-400 font-bold">${parseFloat(user.total_credits || 0).toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Exportar créditos
            document.getElementById('export-credits-btn')?.addEventListener('click', async () => {
                const startDate = document.getElementById('stats-start-date').value;
                const endDate = document.getElementById('stats-end-date').value;
                
                try {
                    let url = `${API_BASE}/api/admin/credits/export?format=csv`;
                    if (startDate) url += `&startDate=${startDate}`;
                    if (endDate) url += `&endDate=${endDate}`;
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `creditos_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Exportação realizada com sucesso');
                    } else {
                        throw new Error('Erro ao exportar');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });
            
            // Modal de histórico de créditos (Admin)
            function showCreditsHistoryModal(transactions, userId) {
                const modalHtml = `
                    <div id="user-credits-history-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white">Histórico de Transações</h2>
                                <div class="flex items-center gap-3">
                                    ${transactions.length > 0 ? `
                                        <button id="clear-user-history-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition-colors flex items-center gap-2" data-user-id="${userId}">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            Zerar Histórico
                                        </button>
                                    ` : ''}
                                <button id="close-user-history-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${transactions.length === 0 
                                    ? '<p class="text-gray-400 text-center py-8">Nenhuma transação encontrada</p>'
                                    : transactions.map(t => {
                                        const isCredit = t.isCredit || t.transaction_type === 'credit' || t.amount > 0;
                                        const amount = Math.abs(parseFloat(t.amount || 0));
                                        const date = new Date(t.created_at);
                                        
                                        // Informações da operação
                                        let operationDetails = '';
                                        if (t.operation) {
                                            const op = t.operation;
                                            operationDetails = `
                                                <div class="mt-2 pt-2 border-t border-gray-700">
                                                    <div class="flex flex-wrap gap-2 text-xs">
                                                        ${op.typeName ? `<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">${op.typeName}</span>` : ''}
                                                        ${op.model && op.model !== 'N/A' ? `<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded">${op.model}</span>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }
                                        
                                        return `
                                            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <span class="text-lg font-bold ${isCredit ? 'text-green-400' : 'text-red-400'}">
                                                                ${isCredit ? '+' : '-'} ${amount.toFixed(2)} créditos
                                                            </span>
                                                            ${isCredit 
                                                                ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded">Crédito</span>'
                                                                : '<span class="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded">Débito</span>'
                                                            }
                                                        </div>
                                                        <p class="text-white font-medium mb-1">${t.description || 'Transação'}</p>
                                                        ${operationDetails}
                                                        <p class="text-gray-500 text-xs mt-2">
                                                            <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                                            ${date.toLocaleString('pt-BR', { 
                                                                day: '2-digit', 
                                                                month: '2-digit', 
                                                                year: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                document.getElementById('close-user-history-modal')?.addEventListener('click', () => {
                    document.getElementById('user-credits-history-modal')?.remove();
                });
                
                // Botão para zerar histórico
                document.getElementById('clear-user-history-btn')?.addEventListener('click', async () => {
                    const btn = document.getElementById('clear-user-history-btn');
                    const userId = btn.dataset.userId;
                    
                    // Confirmar ação
                    const confirmed = await showStyledConfirm(
                        'Tem certeza que deseja zerar todo o histórico de transações deste usuário? Esta ação não pode ser desfeita.',
                        'Zerar Histórico'
                    );
                    
                    if (!confirmed) return;
                    
                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Zerando...';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        
                        const response = await fetch(`${API_BASE}/api/admin/credits/transactions/${userId}/clear`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${userToken}`
                            }
                        });
                        
                        if (response.ok) {
                            showStyledAlert('Histórico de transações zerado com sucesso!', 'Sucesso');
                            // Fechar modal e recarregar histórico
                            document.getElementById('user-credits-history-modal')?.remove();
                            // Recarregar histórico se necessário
                            const historyBtn = document.querySelector(`.btn-history-user-credits[data-user-id="${userId}"]`);
                            if (historyBtn) {
                                historyBtn.click();
                            }
                        } else {
                            const error = await response.json();
                            throw new Error(error.message || 'Erro ao zerar histórico');
                        }
                    } catch (err) {
                        showStyledAlert(err.message || 'Erro ao zerar histórico de transações', 'Erro');
                        btn.disabled = false;
                        btn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i> Zerar Histórico';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                });
            }
            
            // Carregar configuração de Voz Premium
            async function loadVoicePremiumConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/api-providers`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const apis = await response.json();
                        const voicePremiumApi = apis.find(api => api.provider === 'genaipro' || api.provider === 'voice_premium');
                        
                        if (voicePremiumApi) {
                            // Mostrar chave parcialmente mascarada
                            const apiKeyInput = document.getElementById('voice-premium-api-key');
                            const maskedKey = voicePremiumApi.api_key.length > 10 
                                ? voicePremiumApi.api_key.substring(0, 8) + '...' + voicePremiumApi.api_key.substring(voicePremiumApi.api_key.length - 4)
                                : '••••••••';
                            apiKeyInput.value = maskedKey;
                            apiKeyInput.setAttribute('data-saved-key', voicePremiumApi.api_key);
                            apiKeyInput.setAttribute('readonly', 'readonly');
                            apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            // Adicionar botão para editar
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                apiKeyInput.removeAttribute('readonly');
                                apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                apiKeyInput.value = voicePremiumApi.api_key;
                                apiKeyInput.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            
                            const checkBtn = document.getElementById('check-voice-premium-balance');
                            if (checkBtn && !checkBtn.nextElementSibling?.classList.contains('edit-voice-key-btn')) {
                                checkBtn.insertAdjacentElement('afterend', editBtn);
                                editBtn.classList.add('edit-voice-key-btn');
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configuração Voz Premium:', err);
                }
            }
            
            // Verificar saldo da API Voz Premium
            document.getElementById('check-voice-premium-balance')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-premium-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('check-voice-premium-balance');
                btn.disabled = true;
                btn.textContent = 'Verificando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/voice-premium/check-balance`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('[Admin] Resposta de verificação de saldo:', data);
                        
                        const resultDiv = document.getElementById('voice-premium-balance-result');
                        resultDiv.classList.remove('hidden');
                        
                        if (data.balance !== null && data.balance !== undefined) {
                            const balanceValue = parseFloat(data.balance);
                            document.getElementById('voice-premium-balance-amount').textContent = `${balanceValue.toFixed(2)} créditos`;
                            document.getElementById('voice-premium-balance-amount').classList.remove('text-gray-400');
                            document.getElementById('voice-premium-balance-amount').classList.add('text-yellow-400');
                        } else {
                            document.getElementById('voice-premium-balance-amount').textContent = 'N/A';
                            document.getElementById('voice-premium-balance-amount').classList.remove('text-yellow-400');
                            document.getElementById('voice-premium-balance-amount').classList.add('text-gray-400');
                        }
                        
                        showMessage('admin-success-message', data.message || 'Saldo verificado com sucesso');
                    } else {
                        const error = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
                        console.error('[Admin] Erro ao verificar saldo:', error);
                        showMessage('admin-error-message', error.message || 'Erro ao verificar saldo', true);
                        
                        // Mostrar resultado mesmo com erro (pode ser que a chave seja válida)
                        const resultDiv = document.getElementById('voice-premium-balance-result');
                        resultDiv.classList.remove('hidden');
                        document.getElementById('voice-premium-balance-amount').textContent = 'N/A';
                    }
                } catch (err) {
                    showMessage('admin-error-message', 'Erro ao verificar saldo: ' + err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Verificar Saldo';
                }
            });
            
            // Salvar chave da API Voz Premium
            document.getElementById('save-voice-premium-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-premium-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-voice-premium-api');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/voice-premium/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ 
                            api_key: apiKey,
                            name: 'Voz Premium'
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de API Voz Premium salva com sucesso');
                        // Mascarar chave na interface
                        const maskedKey = apiKey.length > 10 
                            ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                            : '••••••••';
                        apiKeyInput.value = maskedKey;
                        apiKeyInput.setAttribute('data-saved-key', apiKey);
                        apiKeyInput.setAttribute('readonly', 'readonly');
                        apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                        
                        // Recarregar lista de APIs
                        loadAdminApis();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar configuração de Chave de Voz
            async function loadVoiceApiKeyConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const voiceApiKey = settings.voice_api_key;
                        
                        if (voiceApiKey) {
                            const apiKeyInput = document.getElementById('voice-api-key');
                            if (apiKeyInput) {
                                const maskedKey = voiceApiKey.length > 10 
                                    ? voiceApiKey.substring(0, 8) + '...' + voiceApiKey.substring(voiceApiKey.length - 4)
                                    : '••••••••';
                                apiKeyInput.value = maskedKey;
                                apiKeyInput.setAttribute('data-saved-key', voiceApiKey);
                                apiKeyInput.setAttribute('readonly', 'readonly');
                                apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                                
                                // Adicionar botão para editar
                                const existingEditBtn = apiKeyInput.parentElement.querySelector('.edit-voice-key-btn');
                                if (existingEditBtn) {
                                    existingEditBtn.remove();
                                }
                                
                                const editBtn = document.createElement('button');
                                editBtn.textContent = 'Editar';
                                editBtn.className = 'edit-voice-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                                editBtn.addEventListener('click', () => {
                                    apiKeyInput.removeAttribute('readonly');
                                    apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                    apiKeyInput.value = voiceApiKey;
                                    apiKeyInput.removeAttribute('data-saved-key');
                                    editBtn.remove();
                                });
                                
                                // Inserir botão após o input
                                const inputContainer = apiKeyInput.parentElement;
                                inputContainer.insertBefore(editBtn, apiKeyInput.nextSibling);
                            }
                        } else {
                            const apiKeyInput = document.getElementById('voice-api-key');
                            if (apiKeyInput) {
                                apiKeyInput.value = '';
                                apiKeyInput.removeAttribute('readonly');
                                apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                apiKeyInput.removeAttribute('data-saved-key');
                                const existingEditBtn = apiKeyInput.parentElement.querySelector('.edit-voice-key-btn');
                                if (existingEditBtn) existingEditBtn.remove();
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configuração de chave de voz:', err);
                }
            }
            
            // Validar chave de API de Voz
            document.getElementById('validate-voice-api-key')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('validate-voice-api-key');
                const resultDiv = document.getElementById('voice-api-key-validation-result');
                const messageDiv = document.getElementById('voice-api-key-validation-message');
                
                btn.disabled = true;
                btn.textContent = 'Validando...';
                resultDiv.classList.remove('hidden');
                messageDiv.innerHTML = '<p class="text-yellow-400">⏳ Validando chave...</p>';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/voice-api-key/validate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        messageDiv.innerHTML = `
                            <p class="text-green-400 font-semibold">✅ ${data.message || 'Chave válida!'}</p>
                            ${data.type ? `<p class="text-gray-400 text-xs mt-1">Tipo: ${data.type}</p>` : ''}
                            ${data.warning ? `<p class="text-yellow-400 text-xs mt-1">⚠️ ${data.warning}</p>` : ''}
                        `;
                        resultDiv.classList.remove('border-gray-700');
                        resultDiv.classList.add('border-green-700');
                    } else {
                        messageDiv.innerHTML = `
                            <p class="text-red-400 font-semibold">❌ ${data.message || 'Chave inválida'}</p>
                            ${data.error ? `<p class="text-gray-400 text-xs mt-1">${data.error}</p>` : ''}
                        `;
                        resultDiv.classList.remove('border-gray-700');
                        resultDiv.classList.add('border-red-700');
                    }
                } catch (err) {
                    messageDiv.innerHTML = `<p class="text-red-400 font-semibold">❌ Erro ao validar: ${err.message}</p>`;
                    resultDiv.classList.remove('border-gray-700');
                    resultDiv.classList.add('border-red-700');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Validar';
                }
            });
            
            // Carregar chave de voz OpenAI
            async function loadOpenAiVoiceKeyConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const openAiKey = settings.openai_voice_api_key;
                        const input = document.getElementById('openai-voice-api-key');
                        if (!input) return;
                        
                        const applyMask = (key) => {
                            if (!key) return '';
                            return key.length > 10 ? key.substring(0, 8) + '...' + key.substring(key.length - 4) : '••••••••';
                        };
                        
                        const cleanupEditBtn = () => {
                            const existing = input.parentElement.querySelector('.edit-openai-voice-key-btn');
                            if (existing) existing.remove();
                        };
                        
                        if (openAiKey) {
                            input.value = applyMask(openAiKey);
                            input.setAttribute('data-saved-key', openAiKey);
                            input.setAttribute('readonly', 'readonly');
                            input.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            cleanupEditBtn();
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'edit-openai-voice-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                input.removeAttribute('readonly');
                                input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                input.value = openAiKey;
                                input.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            input.parentElement.insertBefore(editBtn, input.nextSibling);
                        } else {
                            cleanupEditBtn();
                            input.value = '';
                            input.removeAttribute('readonly');
                            input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                            input.removeAttribute('data-saved-key');
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar chave OpenAI:', err);
                }
            }
            
            // Validar chave OpenAI
            document.getElementById('validate-openai-voice-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('openai-voice-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('validate-openai-voice-api-key');
                const resultDiv = document.getElementById('openai-voice-api-key-validation-result');
                const messageDiv = document.getElementById('openai-voice-api-key-validation-message');
                
                btn.disabled = true;
                btn.textContent = 'Validando...';
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('border-red-700', 'border-green-700');
                messageDiv.innerHTML = '<p class="text-yellow-400">⏳ Validando chave...</p>';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/openai-voice/validate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        messageDiv.innerHTML = `<p class="text-green-400 font-semibold">✅ ${data.message || 'Chave válida!'}</p>`;
                        resultDiv.classList.add('border-green-700');
                    } else {
                        messageDiv.innerHTML = `<p class="text-red-400 font-semibold">❌ ${data.message || 'Chave inválida'}</p>`;
                        resultDiv.classList.add('border-red-700');
                    }
                } catch (err) {
                    messageDiv.innerHTML = `<p class="text-red-400 font-semibold">❌ Erro ao validar: ${err.message}</p>`;
                    resultDiv.classList.add('border-red-700');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Validar';
                }
            });
            
            // Salvar chave OpenAI
            document.getElementById('save-openai-voice-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('openai-voice-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-openai-voice-api-key');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                openai_voice_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave OpenAI salva com sucesso');
                        await loadOpenAiVoiceKeyConfig();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar chave de vídeo
            async function loadVideoApiKeyConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const videoKey = settings.video_api_key;
                        const input = document.getElementById('video-api-key');
                        if (!input) return;
                        
                        const applyMask = (key) => {
                            if (!key) return '';
                            return key.length > 10 ? key.substring(0, 8) + '...' + key.substring(key.length - 4) : '••••••••';
                        };
                        
                        const cleanupEditBtn = () => {
                            const existing = input.parentElement.querySelector('.edit-video-key-btn');
                            if (existing) existing.remove();
                        };
                        
                        if (videoKey) {
                            input.value = applyMask(videoKey);
                            input.setAttribute('data-saved-key', videoKey);
                            input.setAttribute('readonly', 'readonly');
                            input.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            cleanupEditBtn();
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'edit-video-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                input.removeAttribute('readonly');
                                input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                input.value = videoKey;
                                input.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            input.parentElement.insertBefore(editBtn, input.nextSibling);
                        } else {
                            cleanupEditBtn();
                            input.value = '';
                            input.removeAttribute('readonly');
                            input.classList.remove('bg-gray-800', 'cursor-not-allowed');
                            input.removeAttribute('data-saved-key');
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar chave de vídeo:', err);
                }
            }
            
            document.getElementById('validate-video-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('video-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('validate-video-api-key');
                const resultDiv = document.getElementById('video-api-key-validation-result');
                const messageDiv = document.getElementById('video-api-key-validation-message');
                
                btn.disabled = true;
                btn.textContent = 'Validando...';
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('border-red-700', 'border-green-700');
                messageDiv.innerHTML = '<p class="text-yellow-400">⏳ Validando chave...</p>';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/video-api/validate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        messageDiv.innerHTML = `<p class="text-green-400 font-semibold">✅ ${data.message || 'Chave válida!'}</p>`;
                        resultDiv.classList.add('border-green-700');
                    } else {
                        messageDiv.innerHTML = `<p class="text-red-400 font-semibold">❌ ${data.message || 'Chave inválida'}</p>`;
                        resultDiv.classList.add('border-red-700');
                    }
                } catch (err) {
                    messageDiv.innerHTML = `<p class="text-red-400 font-semibold">❌ Erro ao validar: ${err.message}</p>`;
                    resultDiv.classList.add('border-red-700');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Validar';
                }
            });
            
            document.getElementById('save-video-api-key')?.addEventListener('click', async () => {
                const input = document.getElementById('video-api-key');
                let apiKey = input.value.trim();
                if (apiKey.includes('...') && input.dataset.savedKey) {
                    apiKey = input.dataset.savedKey;
                }
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-video-api-key');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                video_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de vídeo salva com sucesso');
                        await loadVideoApiKeyConfig();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Salvar chave de API de Voz
            document.getElementById('save-voice-api-key')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('voice-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-voice-api-key');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                voice_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de API de Voz salva com sucesso');
                        // Mascarar chave na interface
                        const maskedKey = apiKey.length > 10 
                            ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                            : '••••••••';
                        apiKeyInput.value = maskedKey;
                        apiKeyInput.setAttribute('data-saved-key', apiKey);
                        apiKeyInput.setAttribute('readonly', 'readonly');
                        apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                        
                        // Adicionar botão para editar
                        const existingEditBtn = apiKeyInput.parentElement.querySelector('.edit-voice-key-btn');
                        if (existingEditBtn) {
                            existingEditBtn.remove();
                        }
                        
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Editar';
                        editBtn.className = 'edit-voice-key-btn px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                        editBtn.addEventListener('click', () => {
                            apiKeyInput.removeAttribute('readonly');
                            apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                            apiKeyInput.value = apiKey;
                            apiKeyInput.removeAttribute('data-saved-key');
                            editBtn.remove();
                        });
                        
                        // Inserir botão após o input
                        const inputContainer = apiKeyInput.parentElement;
                        inputContainer.insertBefore(editBtn, apiKeyInput.nextSibling);
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar configuração de Laozhang.ai
            async function loadLaozhangConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const settings = await response.json();
                        const laozhangApiKey = settings.laozhang_api_key;
                        const laozhangUseAsDefault = settings.laozhang_use_as_default || false;
                        
                        // Carregar checkbox de usar como padrão
                        const defaultCheckbox = document.getElementById('laozhang-use-as-default');
                        if (defaultCheckbox) {
                            defaultCheckbox.checked = laozhangUseAsDefault;
                        }
                        
                        if (laozhangApiKey) {
                            const apiKeyInput = document.getElementById('laozhang-api-key');
                            const maskedKey = laozhangApiKey.length > 10 
                                ? laozhangApiKey.substring(0, 8) + '...' + laozhangApiKey.substring(laozhangApiKey.length - 4)
                                : '••••••••';
                            apiKeyInput.value = maskedKey;
                            apiKeyInput.setAttribute('data-saved-key', laozhangApiKey);
                            apiKeyInput.setAttribute('readonly', 'readonly');
                            apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                            
                            // Adicionar botão para editar
                            const editBtn = document.createElement('button');
                            editBtn.textContent = 'Editar';
                            editBtn.className = 'px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                            editBtn.addEventListener('click', () => {
                                apiKeyInput.removeAttribute('readonly');
                                apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                apiKeyInput.value = laozhangApiKey;
                                apiKeyInput.removeAttribute('data-saved-key');
                                editBtn.remove();
                            });
                            
                            const checkBtn = document.getElementById('check-laozhang-api');
                            if (checkBtn && !checkBtn.nextElementSibling?.classList.contains('edit-laozhang-key-btn')) {
                                checkBtn.insertAdjacentElement('afterend', editBtn);
                                editBtn.classList.add('edit-laozhang-key-btn');
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configuração Laozhang.ai:', err);
                }
            }
            
            // Salvar configuração de usar como padrão
            document.getElementById('laozhang-use-as-default')?.addEventListener('change', async (e) => {
                const useAsDefault = e.target.checked;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                laozhang_use_as_default: useAsDefault
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', useAsDefault 
                            ? 'API configurada como padrão para todas as funções' 
                            : 'API removida como padrão', false);
                    } else {
                        throw new Error('Erro ao salvar configuração');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                    // Reverter checkbox em caso de erro
                    e.target.checked = !useAsDefault;
                }
            });
            
            // Verificar chave da API Laozhang.ai
            document.getElementById('check-laozhang-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('laozhang-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('check-laozhang-api');
                btn.disabled = true;
                btn.textContent = 'Verificando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/laozhang/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const resultDiv = document.getElementById('laozhang-api-result');
                        resultDiv.classList.remove('hidden');
                        
                        if (data.success) {
                            document.getElementById('laozhang-api-status').textContent = 'Válida';
                            document.getElementById('laozhang-api-status').classList.remove('text-red-400');
                            document.getElementById('laozhang-api-status').classList.add('text-green-400');
                            showMessage('admin-success-message', data.message || 'Chave de API válida');
                        } else {
                            document.getElementById('laozhang-api-status').textContent = 'Inválida';
                            document.getElementById('laozhang-api-status').classList.remove('text-green-400');
                            document.getElementById('laozhang-api-status').classList.add('text-red-400');
                            showMessage('admin-error-message', data.message || 'Chave de API inválida', true);
                        }
                    } else {
                        const error = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
                        showMessage('admin-error-message', error.message || 'Erro ao verificar chave', true);
                        const resultDiv = document.getElementById('laozhang-api-result');
                        resultDiv.classList.remove('hidden');
                        document.getElementById('laozhang-api-status').textContent = 'Erro';
                        document.getElementById('laozhang-api-status').classList.remove('text-green-400');
                        document.getElementById('laozhang-api-status').classList.add('text-red-400');
                    }
                } catch (err) {
                    console.error('[Admin] Erro ao verificar chave Laozhang.ai:', err);
                    showMessage('admin-error-message', 'Erro ao verificar chave: ' + err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Verificar';
                }
            });
            
            // Salvar chave da API Laozhang.ai
            document.getElementById('save-laozhang-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('laozhang-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-laozhang-api');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/app-settings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            settings: {
                                laozhang_api_key: apiKey
                            }
                        })
                    });
                    
                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave de API salva com sucesso');
                        // Mascarar chave na interface
                        const maskedKey = apiKey.length > 10 
                            ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                            : '••••••••';
                        apiKeyInput.value = maskedKey;
                        apiKeyInput.setAttribute('data-saved-key', apiKey);
                        apiKeyInput.setAttribute('readonly', 'readonly');
                        apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Verificar chave da API DownSub
            document.getElementById('check-downsub-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('downsub-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('check-downsub-api');
                btn.disabled = true;
                btn.textContent = 'Verificando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/downsub/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const resultDiv = document.getElementById('downsub-api-result');
                        resultDiv.classList.remove('hidden');
                        
                        if (data.success) {
                            document.getElementById('downsub-api-status').textContent = 'Válida';
                            document.getElementById('downsub-api-status').classList.remove('text-red-400');
                            document.getElementById('downsub-api-status').classList.add('text-green-400');
                            
                            // Mostrar créditos disponíveis
                            if (data.credits) {
                                const creditsText = `Créditos restantes: ${data.credits.remainingCredits || 'N/A'} / ${data.credits.monthlyCredits || 'N/A'}`;
                                document.getElementById('downsub-api-credits').textContent = creditsText;
                            }
                            
                            showMessage('admin-success-message', data.message || 'Chave de API válida');
                        } else {
                            document.getElementById('downsub-api-status').textContent = 'Inválida';
                            document.getElementById('downsub-api-status').classList.remove('text-green-400');
                            document.getElementById('downsub-api-status').classList.add('text-red-400');
                            showMessage('admin-error-message', data.message || 'Chave de API inválida', true);
                        }
                    } else {
                        const error = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
                        showMessage('admin-error-message', error.message || 'Erro ao verificar chave', true);
                        const resultDiv = document.getElementById('downsub-api-result');
                        resultDiv.classList.remove('hidden');
                        document.getElementById('downsub-api-status').textContent = 'Erro';
                        document.getElementById('downsub-api-status').classList.remove('text-green-400');
                        document.getElementById('downsub-api-status').classList.add('text-red-400');
                    }
                } catch (err) {
                    console.error('[Admin] Erro ao verificar chave DownSub:', err);
                    showMessage('admin-error-message', 'Erro ao verificar chave: ' + err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Verificar';
                }
            });
            
            // Salvar chave da API DownSub
            document.getElementById('save-downsub-api')?.addEventListener('click', async () => {
                const apiKeyInput = document.getElementById('downsub-api-key');
                let apiKey = apiKeyInput.value.trim();
                
                // Se for chave mascarada, usar a chave salva
                if (apiKey.includes('...') && apiKeyInput.dataset.savedKey) {
                    apiKey = apiKeyInput.dataset.savedKey;
                }
                
                if (!apiKey) {
                    showMessage('admin-error-message', 'Digite a chave de API primeiro', true);
                    return;
                }
                
                const btn = document.getElementById('save-downsub-api');
                btn.disabled = true;
                btn.textContent = 'Salvando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/downsub/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ api_key: apiKey })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        showMessage('admin-success-message', data.message || 'Chave de API salva com sucesso');
                        // Mascarar chave na interface
                        const maskedKey = apiKey.length > 10 
                            ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                            : '••••••••';
                        apiKeyInput.value = maskedKey;
                        apiKeyInput.setAttribute('data-saved-key', apiKey);
                        apiKeyInput.setAttribute('readonly', 'readonly');
                        apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Salvar Chave';
                }
            });
            
            // Carregar configuração do DownSub
            async function loadDownSubConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/api-providers`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const apis = await response.json();
                        const downsubApi = apis.find(api => api.provider === 'downsub');
                        if (downsubApi && downsubApi.api_key) {
                            const apiKeyInput = document.getElementById('downsub-api-key');
                            if (apiKeyInput) {
                                // A chave vem descriptografada do backend quando listamos as APIs
                                // Mas vamos mascarar para segurança
                                const apiKey = downsubApi.api_key;
                                const maskedKey = apiKey.length > 10 
                                    ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4)
                                    : '••••••••';
                                apiKeyInput.value = maskedKey;
                                apiKeyInput.setAttribute('data-saved-key', apiKey);
                                apiKeyInput.setAttribute('readonly', 'readonly');
                                apiKeyInput.classList.add('bg-gray-800', 'cursor-not-allowed');
                                
                                // Adicionar botão para editar
                                const editBtn = document.createElement('button');
                                editBtn.textContent = 'Editar';
                                editBtn.className = 'px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition ml-2';
                                editBtn.addEventListener('click', () => {
                                    apiKeyInput.removeAttribute('readonly');
                                    apiKeyInput.classList.remove('bg-gray-800', 'cursor-not-allowed');
                                    apiKeyInput.value = apiKey;
                                    apiKeyInput.removeAttribute('data-saved-key');
                                    editBtn.remove();
                                });
                                
                                const checkBtn = document.getElementById('check-downsub-api');
                                if (checkBtn && !checkBtn.nextElementSibling?.classList.contains('edit-downsub-key-btn')) {
                                    checkBtn.insertAdjacentElement('afterend', editBtn);
                                    editBtn.classList.add('edit-downsub-key-btn');
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.error('[Admin] Erro ao carregar configuração DownSub:', err);
                }
            }
            
            // Carregar APIs no admin
            async function loadAdminApis() {
                await loadVoicePremiumConfig();
                await loadVoiceApiKeyConfig();
                await loadOpenAiVoiceKeyConfig();
                await loadVideoApiKeyConfig();
                await loadLaozhangConfig();
                await loadDownSubConfig();
                
                try {
                    const response = await fetch(`${API_BASE}/api/admin/api-providers`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const apis = await response.json();
                        // Filtrar APIs que não são Voz Premium (para não mostrar GenAIPro)
                        const otherApis = apis.filter(api => api.provider !== 'genaipro' && api.provider !== 'voice_premium');
                        const tbody = document.getElementById('admin-apis-table-body');
                        tbody.innerHTML = '';
                        
                        if (otherApis.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhuma outra API cadastrada</td></tr>';
                        } else {
                            otherApis.forEach(api => {
                                const statusBadge = api.is_active 
                                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-400">Ativa</span>'
                                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-500/20 text-red-400">Inativa</span>';
                                const defaultBadge = api.is_default 
                                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-500/20 text-blue-400 ml-2">Padrão</span>'
                                    : '';
                                
                                tbody.innerHTML += `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-3 text-sm text-gray-200">${api.name}</td>
                                        <td class="p-3 text-sm text-gray-200">${api.model}</td>
                                        <td class="p-3 text-sm text-gray-200">${parseFloat(api.credits_per_unit || 0).toFixed(2)}</td>
                                        <td class="p-3">${statusBadge}${defaultBadge}</td>
                                        <td class="p-3">
                                            <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded btn-edit-api mr-2" data-api='${JSON.stringify(api)}'>
                                                Editar
                                            </button>
                                            <button class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-xs rounded btn-delete-api" data-api-id="${api.id}">
                                                Excluir
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                        }
                        
                        // Event listeners
                        document.querySelectorAll('.btn-edit-api').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const api = JSON.parse(btn.dataset.api);
                                showEditApiModal(api);
                            });
                        });
                        
                        document.querySelectorAll('.btn-delete-api').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const apiId = btn.dataset.apiId;
                                deleteApi(apiId);
                            });
                        });
                    }
                } catch (err) {
                    console.error('Erro ao carregar APIs:', err);
                }
            }
            
            // Modal para gerenciar créditos
            async function showManageCreditsModal(userId, userEmail) {
                try {
                    // Carregar saldo atual
                    const balanceResponse = await fetch(`${API_BASE}/api/admin/credits/balance/${userId}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const balanceData = await balanceResponse.json();
                    const currentBalance = balanceData.balance || 0;
                    
                    const modalHtml = `
                        <div id="manage-credits-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                            <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-bold text-white">Gerenciar Créditos</h2>
                                    <button id="close-manage-credits-modal" class="text-gray-400 hover:text-white">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <div class="mb-4">
                                    <p class="text-sm text-gray-400 mb-1">Usuário:</p>
                                    <p class="text-white font-semibold">${userEmail}</p>
                                </div>
                                <div class="mb-6 p-4 bg-gray-800 rounded-lg border border-gray-700">
                                    <p class="text-sm text-gray-400 mb-1">Saldo Atual:</p>
                                    <p class="text-2xl font-bold text-yellow-400">${parseFloat(currentBalance).toFixed(2)}</p>
                                </div>
                                <form id="manage-credits-form" class="space-y-4">
                                    <input type="hidden" id="manage-credits-user-id" value="${userId}">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Adicionar Créditos</label>
                                        <input type="number" id="manage-credits-amount" step="0.01" min="0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Descrição (opcional)</label>
                                        <input type="text" id="manage-credits-description" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="Ex: Bônus promocional">
                                    </div>
                                    <div class="flex gap-3 pt-4">
                                        <button type="button" id="reset-credits-btn" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                                            Zerar
                                        </button>
                                        <button type="button" id="cancel-manage-credits" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                            Adicionar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    document.getElementById('close-manage-credits-modal')?.addEventListener('click', () => {
                        document.getElementById('manage-credits-modal')?.remove();
                    });
                    
                    document.getElementById('cancel-manage-credits')?.addEventListener('click', () => {
                        document.getElementById('manage-credits-modal')?.remove();
                    });
                    
                    document.getElementById('reset-credits-btn')?.addEventListener('click', async () => {
                        if (!confirm('Tem certeza que deseja zerar os créditos deste usuário?')) return;
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/credits/reset`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({ user_id: userId })
                            });
                            
                            if (response.ok) {
                                showMessage('admin-success-message', 'Créditos zerados com sucesso');
                                document.getElementById('manage-credits-modal')?.remove();
                                loadAdminCredits();
                            } else {
                                throw new Error('Erro ao zerar créditos');
                            }
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                        }
                    });
                    
                    document.getElementById('manage-credits-form')?.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const amount = parseFloat(document.getElementById('manage-credits-amount').value);
                        const description = document.getElementById('manage-credits-description').value;
                        
                        if (!amount || amount <= 0) {
                            showMessage('admin-error-message', 'Valor inválido', true);
                            return;
                        }
                        
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/credits/add`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({
                                    user_id: userId,
                                    amount: amount,
                                    description: description || 'Créditos adicionados pelo administrador'
                                })
                            });
                            
                            if (response.ok) {
                                showMessage('admin-success-message', 'Créditos adicionados com sucesso');
                                document.getElementById('manage-credits-modal')?.remove();
                                loadAdminCredits();
                            } else {
                                throw new Error('Erro ao adicionar créditos');
                            }
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                        }
                    });
                } catch (err) {
                    console.error('Erro ao carregar modal de créditos:', err);
                }
            }
            
            // Modal para adicionar API
            function showAddApiModal() {
                // Implementar modal de adicionar API
                const modalHtml = `
                    <div id="add-api-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
                        <div class="bg-gray-900 border border-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-white">Adicionar Nova API</h2>
                                <button id="close-add-api-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <form id="add-api-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Nome</label>
                                        <input type="text" id="api-name" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                    <div style="display: none;">
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Provedor</label>
                                        <select id="api-provider" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                            <option value="openai">OpenAI</option>
                                            <option value="gemini">Gemini</option>
                                            <option value="claude">Claude</option>
                                            <option value="voice_premium">Voz Premium</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo</label>
                                    <input type="text" id="api-model" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200" placeholder="ex: gpt-4, gemini-pro, etc">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Chave de API</label>
                                    <input type="text" id="api-key" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Créditos/Unidade</label>
                                        <input type="number" id="api-credits-per-unit" step="0.01" value="1.0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Tamanho Unidade</label>
                                        <input type="number" id="api-unit-size" value="1000" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Markup</label>
                                        <input type="number" id="api-markup" step="0.01" value="1.0" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200">
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="api-is-active" checked class="mr-2">
                                        <span class="text-gray-300">Ativa</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="api-is-default" class="mr-2">
                                        <span class="text-gray-300">API Padrão</span>
                                    </label>
                                </div>
                                <div class="flex justify-end gap-3 pt-4">
                                    <button type="button" id="cancel-add-api" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                        Adicionar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                document.getElementById('close-add-api-modal')?.addEventListener('click', () => {
                    document.getElementById('add-api-modal')?.remove();
                });
                
                document.getElementById('cancel-add-api')?.addEventListener('click', () => {
                    document.getElementById('add-api-modal')?.remove();
                });
                
                document.getElementById('add-api-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/api-providers`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                name: document.getElementById('api-name').value,
                                provider: document.getElementById('api-provider').value,
                                model: document.getElementById('api-model').value,
                                api_key: document.getElementById('api-key').value,
                                credits_per_unit: parseFloat(document.getElementById('api-credits-per-unit').value),
                                unit_size: parseInt(document.getElementById('api-unit-size').value),
                                markup: parseFloat(document.getElementById('api-markup').value),
                                is_active: document.getElementById('api-is-active').checked ? 1 : 0,
                                is_default: document.getElementById('api-is-default').checked ? 1 : 0
                            })
                        });
                        
                        if (response.ok) {
                            showMessage('admin-success-message', 'API adicionada com sucesso');
                            document.getElementById('add-api-modal')?.remove();
                            loadAdminApis();
                        } else {
                            throw new Error('Erro ao adicionar API');
                        }
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    }
                });
            }
            
            // Carregar configurações de Pixel/Ads
            async function loadAdminPixel() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/pixel-config`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const config = await response.json();
                        if (config.facebook_pixel_id) {
                            document.getElementById('facebook-pixel-id').value = config.facebook_pixel_id;
                            document.getElementById('facebook-pixel-status').classList.remove('hidden');
                            document.getElementById('facebook-pixel-status-badge').textContent = 'Configurado';
                            document.getElementById('facebook-pixel-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                            document.getElementById('facebook-pixel-id-display').textContent = config.facebook_pixel_id;
                        }
                        if (config.google_ads_id) {
                            document.getElementById('google-ads-id').value = config.google_ads_id;
                            document.getElementById('google-ads-status').classList.remove('hidden');
                            document.getElementById('google-ads-status-badge').textContent = 'Configurado';
                            document.getElementById('google-ads-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                            document.getElementById('google-ads-id-display').textContent = config.google_ads_id;
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configurações de Pixel:', err);
                }
            }

            // Salvar Facebook Pixel
            document.getElementById('save-facebook-pixel')?.addEventListener('click', async () => {
                const pixelId = document.getElementById('facebook-pixel-id').value.trim();
                if (!pixelId) {
                    showMessage('admin-error-message', 'Digite o Pixel ID do Facebook', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/pixel-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ facebook_pixel_id: pixelId })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Facebook Pixel configurado com sucesso!');
                        document.getElementById('facebook-pixel-status').classList.remove('hidden');
                        document.getElementById('facebook-pixel-status-badge').textContent = 'Configurado';
                        document.getElementById('facebook-pixel-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        document.getElementById('facebook-pixel-id-display').textContent = pixelId;
                    } else {
                        throw new Error('Erro ao salvar configuração');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar Google Ads
            document.getElementById('save-google-ads')?.addEventListener('click', async () => {
                const adsId = document.getElementById('google-ads-id').value.trim();
                if (!adsId) {
                    showMessage('admin-error-message', 'Digite o ID de conversão do Google Ads', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/pixel-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ google_ads_id: adsId })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Google Ads configurado com sucesso!');
                        document.getElementById('google-ads-status').classList.remove('hidden');
                        document.getElementById('google-ads-status-badge').textContent = 'Configurado';
                        document.getElementById('google-ads-status-badge').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        document.getElementById('google-ads-id-display').textContent = adsId;
                    } else {
                        throw new Error('Erro ao salvar configuração');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Carregar configurações de Stripe
            async function loadAdminPayments() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const config = await response.json();
                        if (config.publishable_key) {
                            document.getElementById('stripe-publishable-key').value = config.publishable_key;
                            document.getElementById('stripe-publishable-status').textContent = 'Configurado';
                            document.getElementById('stripe-publishable-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        }
                        if (config.secret_key) {
                            document.getElementById('stripe-secret-key').value = config.secret_key;
                            document.getElementById('stripe-secret-status').textContent = 'Configurado';
                            document.getElementById('stripe-secret-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        }
                        if (config.webhook_secret) {
                            document.getElementById('stripe-webhook-secret').value = config.webhook_secret;
                            document.getElementById('stripe-webhook-status').textContent = 'Configurado';
                            document.getElementById('stripe-webhook-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                        }
                        // Carregar planos
                        if (config.plans) {
                            Object.keys(config.plans).forEach(planKey => {
                                const input = document.getElementById(`stripe-${planKey}`);
                                if (input && config.plans[planKey]) {
                                    input.value = config.plans[planKey];
                                }
                            });
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar configurações do Stripe:', err);
                }
            }

            // Salvar chave pública do Stripe
            document.getElementById('save-stripe-publishable')?.addEventListener('click', async () => {
                const key = document.getElementById('stripe-publishable-key').value.trim();
                if (!key) {
                    showMessage('admin-error-message', 'Digite a chave pública do Stripe', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ publishable_key: key })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave pública salva com sucesso!');
                        document.getElementById('stripe-publishable-status').textContent = 'Configurado';
                        document.getElementById('stripe-publishable-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                    } else {
                        throw new Error('Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar chave secreta do Stripe
            document.getElementById('save-stripe-secret')?.addEventListener('click', async () => {
                const key = document.getElementById('stripe-secret-key').value.trim();
                if (!key) {
                    showMessage('admin-error-message', 'Digite a chave secreta do Stripe', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ secret_key: key })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Chave secreta salva com sucesso!');
                        document.getElementById('stripe-secret-status').textContent = 'Configurado';
                        document.getElementById('stripe-secret-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                    } else {
                        throw new Error('Erro ao salvar chave');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar webhook secret do Stripe
            document.getElementById('save-stripe-webhook')?.addEventListener('click', async () => {
                const secret = document.getElementById('stripe-webhook-secret').value.trim();
                if (!secret) {
                    showMessage('admin-error-message', 'Digite o secret do webhook', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ webhook_secret: secret })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Webhook secret salvo com sucesso!');
                        document.getElementById('stripe-webhook-status').textContent = 'Configurado';
                        document.getElementById('stripe-webhook-status').className = 'px-3 py-1 text-xs font-semibold rounded-full bg-green-700 text-white';
                    } else {
                        throw new Error('Erro ao salvar webhook');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Salvar todos os planos do Stripe
            document.getElementById('save-all-stripe-plans')?.addEventListener('click', async () => {
                const plans = {};
                
                // Planos mensais
                const freeInput = document.getElementById('stripe-plan-free');
                if (freeInput && freeInput.value.trim()) plans['plan-free'] = freeInput.value.trim();
                
                const startInput = document.getElementById('stripe-plan-start');
                if (startInput && startInput.value.trim()) plans['plan-start'] = startInput.value.trim();
                
                const turboInput = document.getElementById('stripe-plan-turbo');
                if (turboInput && turboInput.value.trim()) plans['plan-turbo'] = turboInput.value.trim();
                
                const masterInput = document.getElementById('stripe-plan-master');
                if (masterInput && masterInput.value.trim()) plans['plan-master'] = masterInput.value.trim();
                
                // Planos anuais
                const startAnnualInput = document.getElementById('stripe-plan-start-annual');
                if (startAnnualInput && startAnnualInput.value.trim()) plans['plan-start-annual'] = startAnnualInput.value.trim();
                
                const turboAnnualInput = document.getElementById('stripe-plan-turbo-annual');
                if (turboAnnualInput && turboAnnualInput.value.trim()) plans['plan-turbo-annual'] = turboAnnualInput.value.trim();
                
                const masterAnnualInput = document.getElementById('stripe-plan-master-annual');
                if (masterAnnualInput && masterAnnualInput.value.trim()) plans['plan-master-annual'] = masterAnnualInput.value.trim();
                
                // Pacotes
                const pkg1000Input = document.getElementById('stripe-package-1000');
                if (pkg1000Input && pkg1000Input.value.trim()) plans['package-1000'] = pkg1000Input.value.trim();
                
                const pkg2500Input = document.getElementById('stripe-package-2500');
                if (pkg2500Input && pkg2500Input.value.trim()) plans['package-2500'] = pkg2500Input.value.trim();
                
                const pkg5000Input = document.getElementById('stripe-package-5000');
                if (pkg5000Input && pkg5000Input.value.trim()) plans['package-5000'] = pkg5000Input.value.trim();
                
                const pkg10000Input = document.getElementById('stripe-package-10000');
                if (pkg10000Input && pkg10000Input.value.trim()) plans['package-10000'] = pkg10000Input.value.trim();
                
                const pkg20000Input = document.getElementById('stripe-package-20000');
                if (pkg20000Input && pkg20000Input.value.trim()) plans['package-20000'] = pkg20000Input.value.trim();

                try {
                    const response = await fetch(`${API_BASE}/api/admin/stripe-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ plans })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Todos os planos foram salvos com sucesso!');
                    } else {
                        throw new Error('Erro ao salvar planos');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Toggle visibilidade de senhas
            document.getElementById('toggle-stripe-secret')?.addEventListener('click', () => {
                const input = document.getElementById('stripe-secret-key');
                input.type = input.type === 'password' ? 'text' : 'password';
            });

            document.getElementById('toggle-stripe-webhook')?.addEventListener('click', () => {
                const input = document.getElementById('stripe-webhook-secret');
                input.type = input.type === 'password' ? 'text' : 'password';
            });

            // ========== CONFIGURAÇÕES DE WHATSAPP E EMAIL ==========
            
            // Toggle visibilidade de senhas
            document.getElementById('toggle-whatsapp-token')?.addEventListener('click', () => {
                const input = document.getElementById('whatsapp-token');
                if (input) input.type = input.type === 'password' ? 'text' : 'password';
            });

            document.getElementById('toggle-smtp-password')?.addEventListener('click', () => {
                const input = document.getElementById('smtp-password');
                if (input) input.type = input.type === 'password' ? 'text' : 'password';
            });

            // Salvar token do WhatsApp
            document.getElementById('save-whatsapp-token')?.addEventListener('click', async () => {
                const token = document.getElementById('whatsapp-token')?.value.trim();
                const numberId = document.getElementById('whatsapp-number-id')?.value.trim();
                
                if (!token || !numberId) {
                    showMessage('admin-error-message', 'Preencha o token e o número do WhatsApp', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/whatsapp-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ token, number_id: numberId })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', 'Configuração do WhatsApp salva com sucesso!');
                    } else {
                        throw new Error('Erro ao salvar configuração');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Copiar URL do webhook
            document.getElementById('copy-webhook-url')?.addEventListener('click', () => {
                const url = document.getElementById('whatsapp-webhook-url')?.value;
                if (url) {
                    navigator.clipboard.writeText(window.location.origin + url).then(() => {
                        showMessage('admin-success-message', 'URL copiada para a área de transferência!');
                    });
                }
            });

            // Salvar templates de email
            // Função para salvar todos os templates de assinatura
            window.saveAllSubscriptionTemplates = async function() {
                const subscriptionPlans = [
                    'plan-start',
                    'plan-turbo',
                    'plan-master',
                    'plan-start-annual',
                    'plan-turbo-annual',
                    'plan-master-annual'
                ];
                
                let saved = 0;
                let errors = 0;
                
                for (const planKey of subscriptionPlans) {
                    const templateType = `subscription_${planKey}`;
                    const subjectInput = document.getElementById(`email-template-${templateType}-subject`);
                    const bodyInput = document.getElementById(`email-template-${templateType}-body`);
                    
                    if (subjectInput && bodyInput && (subjectInput.value.trim() || bodyInput.value.trim())) {
                        try {
                            const subject = subjectInput.value.trim() || `Assinatura ${planKey} confirmada`;
                            const body = bodyInput.value.trim() || '';
                            
                            const response = await fetch('/api/admin/email-templates', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    template_type: templateType,
                                    subject: subject,
                                    body: body
                                })
                            });
                            
                            if (response.ok) {
                                saved++;
                            } else {
                                errors++;
                            }
                        } catch (error) {
                            console.error(`Erro ao salvar template ${templateType}:`, error);
                            errors++;
                        }
                    }
                }
                
                if (saved > 0) {
                    alert(`✅ ${saved} template(s) de assinatura salvos com sucesso!${errors > 0 ? `\n⚠️ ${errors} erro(s) ao salvar.` : ''}`);
                } else if (errors > 0) {
                    alert(`❌ Erro ao salvar templates. Verifique o console.`);
                } else {
                    alert('ℹ️ Nenhum template preenchido para salvar.');
                }
            };
            
            window.saveEmailTemplate = async function(templateType) {
                const subjectEl = document.getElementById(`email-template-${templateType}-subject`);
                const bodyEl = document.getElementById(`email-template-${templateType}-body`);
                
                if (!subjectEl || !bodyEl) return;
                
                const subject = subjectEl.value.trim();
                const body = bodyEl.value.trim();
                
                if (!subject || !body) {
                    showMessage('admin-error-message', 'Preencha o assunto e o corpo do email', true);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/admin/email-templates`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ 
                            template_type: templateType,
                            subject,
                            body
                        })
                    });

                    if (response.ok) {
                        showMessage('admin-success-message', `Template de ${templateType} salvo com sucesso!`);
                    } else {
                        throw new Error('Erro ao salvar template');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            };

            window.testEmailTemplate = async function(templateType) {
                const testEmail = prompt('Digite o email para enviar o teste:', '');
                
                if (!testEmail) {
                    return; // Usuário cancelou
                }
                
                // Validar formato de email básico
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(testEmail)) {
                    showMessage('admin-error-message', 'Email inválido', true);
                    return;
                }

                try {
                    showMessage('admin-success-message', 'Enviando email de teste...', false);
                    
                    const response = await fetch(`${API_BASE}/api/admin/email-templates/test`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ 
                            template_type: templateType,
                            test_email: testEmail
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('admin-success-message', `✅ Email de teste enviado com sucesso para ${testEmail}! Verifique sua caixa de entrada.`, false);
                    } else {
                        throw new Error(data.message || 'Erro ao enviar email de teste');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message || 'Erro ao enviar email de teste', true);
                }
            };

            // Carregar configurações SMTP
            async function loadSMTPConfig() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/smtp-config`, {
                        headers: {
                            'Authorization': `Bearer ${userToken}`
                        }
                    });

                    if (response.ok) {
                        const config = await response.json();
                        console.log('[SMTP] Configurações carregadas:', config);
                        
                        if (config.host) document.getElementById('smtp-host').value = config.host;
                        if (config.port) document.getElementById('smtp-port').value = config.port;
                        if (config.email) document.getElementById('smtp-email').value = config.email;
                        if (config.password) document.getElementById('smtp-password').value = config.password;
                        if (config.secure !== undefined) document.getElementById('smtp-secure').checked = config.secure;
                    } else {
                        console.error('[SMTP] Erro ao carregar configurações:', response.status);
                    }
                } catch (err) {
                    console.error('[SMTP] Erro ao carregar configurações:', err);
                }
            }

            // Salvar configuração SMTP
            document.getElementById('save-smtp-config')?.addEventListener('click', async () => {
                const host = document.getElementById('smtp-host')?.value.trim();
                const port = parseInt(document.getElementById('smtp-port')?.value) || 587;
                const email = document.getElementById('smtp-email')?.value.trim();
                const password = document.getElementById('smtp-password')?.value.trim();
                const secure = document.getElementById('smtp-secure')?.checked;
                
                if (!host || !email) {
                    showMessage('admin-error-message', 'Preencha pelo menos o servidor SMTP e o email', true);
                    return;
                }

                // Se a senha estiver vazia, não enviar (manter a atual)
                const dataToSend = { host, port, email, secure };
                if (password) {
                    dataToSend.password = password;
                }

                try {
                    const button = document.getElementById('save-smtp-config');
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = 'Salvando...';

                    const response = await fetch(`${API_BASE}/api/admin/smtp-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify(dataToSend)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage('admin-success-message', result.message || 'Configuração SMTP salva com sucesso!');
                        // Recarregar configurações para garantir sincronização
                        setTimeout(() => loadSMTPConfig(), 500);
                    } else {
                        throw new Error(result.message || 'Erro ao salvar configuração SMTP');
                    }
                } catch (err) {
                    console.error('[SMTP] Erro ao salvar:', err);
                    showMessage('admin-error-message', err.message || 'Erro ao salvar configuração SMTP', true);
                } finally {
                    const button = document.getElementById('save-smtp-config');
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Salvar Configuração SMTP';
                    }
                }
            });
            
            // Testar configuração SMTP
            document.getElementById('test-smtp-config')?.addEventListener('click', async () => {
                const email = document.getElementById('smtp-email')?.value.trim();
                
                if (!email) {
                    showMessage('admin-error-message', 'Configure o email de envio antes de testar', true);
                    return;
                }

                try {
                    const button = document.getElementById('test-smtp-config');
                    const originalText = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Enviando teste...';

                    const response = await fetch(`${API_BASE}/api/admin/smtp-config/test`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ testEmail: email })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showMessage('admin-success-message', result.message || 'Email de teste enviado com sucesso! Verifique sua caixa de entrada.', false);
                    } else {
                        throw new Error(result.message || 'Erro ao enviar email de teste');
                    }
                } catch (err) {
                    console.error('[SMTP Test] Erro:', err);
                    showMessage('admin-error-message', err.message || 'Erro ao enviar email de teste. Verifique as configurações SMTP.', true);
                } finally {
                    const button = document.getElementById('test-smtp-config');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> Enviar Email de Teste';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });
            
            // Carregar configurações SMTP quando a aba de configurações for aberta
            if (document.getElementById('smtp-host')) {
                loadSMTPConfig();
            }

            // ========== ABA DE ASSINATURAS ==========
            let mrrChart = null;
            let subscribersChart = null;
            let plansDistributionChart = null;
            let churnChart = null;

            // Carregar dados de assinaturas
            let isLoadingSubscriptions = false;
            // Função para carregar dados de armazenamento
            async function loadAdminStorage() {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/storage/stats`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao buscar estatísticas de armazenamento.');
                    const data = await response.json();
                    
                    // Atualizar estatísticas do servidor
                    const totalSpaceGB = (data.serverTotalSpace / (1024 * 1024 * 1024)).toFixed(2);
                    document.getElementById('server-total-space').textContent = `${totalSpaceGB} GB`;
                    
                    const usersStorageGB = (data.totalUsersStorage / (1024 * 1024 * 1024)).toFixed(2);
                    document.getElementById('server-users-storage').textContent = `${usersStorageGB} GB`;
                    
                    const tempStorageMB = (data.tempAudioSize / (1024 * 1024)).toFixed(2);
                    document.getElementById('server-temp-storage').textContent = `${tempStorageMB} MB`;
                    
                    // Preencher tabela de usuários
                    const tableBody = document.getElementById('storage-table-body');
                    if (!tableBody) return;
                    
                    tableBody.innerHTML = '';
                    
                    if (data.users && data.users.length > 0) {
                        data.users.forEach((user) => {
                            const usedMB = (user.storageUsed / (1024 * 1024)).toFixed(2);
                            const limitMB = (user.storageLimit / (1024 * 1024)).toFixed(0);
                            const limitGB = (user.storageLimit / (1024 * 1024 * 1024)).toFixed(1);
                            const percentage = Math.min(user.percentage, 100);
                            
                            let limitDisplay = limitMB;
                            if (user.storageLimit >= 1024 * 1024 * 1024) {
                                limitDisplay = `${limitGB} GB`;
                            } else {
                                limitDisplay = `${limitMB} MB`;
                            }
                            
                            let progressColor = 'bg-indigo-500';
                            if (percentage >= 90) progressColor = 'bg-red-500';
                            else if (percentage >= 70) progressColor = 'bg-yellow-500';
                            
                            const planDisplay = user.plan === 'plan-free' ? 'FREE' :
                                                user.plan === 'plan-start' ? 'START' :
                                                user.plan === 'plan-turbo' ? 'TURBO' :
                                                user.plan === 'plan-master' ? 'MASTER' :
                                                user.plan.includes('annual') ? user.plan.replace('plan-', '').replace('-annual', '').toUpperCase() + ' ANUAL' :
                                                user.plan;
                            
                            tableBody.innerHTML += `
                                <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td class="p-3">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-white">${user.name || user.email}</span>
                                            <span class="text-xs text-gray-400">${user.email}</span>
                                            ${user.isAdmin ? '<span class="text-xs text-red-400 font-semibold">ADMIN</span>' : ''}
                                        </div>
                                    </td>
                                    <td class="p-3">
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-600/50 text-gray-300">
                                            ${planDisplay}
                                        </span>
                                    </td>
                                    <td class="p-3 text-sm text-white">${usedMB} MB</td>
                                    <td class="p-3 text-sm text-gray-300">${limitDisplay}</td>
                                    <td class="p-3">
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div class="${progressColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                                        </div>
                                        <span class="text-xs text-gray-400 mt-1 block">${percentage.toFixed(1)}%</span>
                                    </td>
                                    <td class="p-3">
                                        <div class="flex space-x-2">
                                            <button title="Zerar Armazenamento" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-red-500 btn-storage-reset" data-user-id="${user.userId}" data-user-email="${user.email}">
                                                <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                            </button>
                                            <button title="Alterar Limite" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-blue-500 btn-storage-limit" data-user-id="${user.userId}" data-user-email="${user.email}" data-current-limit="${user.storageLimit}">
                                                <i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">Nenhum usuário encontrado</td></tr>';
                    }
                    
                    // Adicionar event listeners aos botões
                    document.querySelectorAll('.btn-storage-reset').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const userId = btn.dataset.userId;
                            const userEmail = btn.dataset.userEmail;
                            const confirmed = await showCustomConfirm(`Tem certeza que deseja ZERAR o armazenamento do usuário ${userEmail}? Esta ação não pode ser desfeita.`);
                            if (!confirmed) return;
                            
                            try {
                                const response = await fetch(`${API_BASE}/api/admin/storage/reset/${userId}`, {
                                    method: 'PUT',
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.message || 'Erro ao zerar armazenamento');
                                
                                showMessage('admin-success-message', `Armazenamento zerado com sucesso! ${result.deletedFiles} arquivos deletados, ${(result.freedSpace / (1024 * 1024)).toFixed(2)} MB liberados.`);
                                loadAdminStorage();
                            } catch (err) {
                                showMessage('admin-error-message', err.message, true);
                            }
                        });
                    });
                    
                    document.querySelectorAll('.btn-storage-limit').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const userId = btn.dataset.userId;
                            const userEmail = btn.dataset.userEmail;
                            const currentLimit = parseInt(btn.dataset.currentLimit);
                            const currentLimitGB = (currentLimit / (1024 * 1024 * 1024)).toFixed(1);
                            const currentLimitMB = (currentLimit / (1024 * 1024)).toFixed(0);
                            
                            const currentLimitText = currentLimit >= 1024 * 1024 * 1024 ? currentLimitGB + ' GB' : currentLimitMB + ' MB';
                            const newLimit = await showCustomPrompt(
                                `Alterar limite de armazenamento para ${userEmail}\n\nLimite atual: ${currentLimitText}\n\nDigite o novo limite (ex: 500MB, 1GB, 2000MB, etc):`,
                                currentLimit >= 1024 * 1024 * 1024 ? `${currentLimitGB}GB` : `${currentLimitMB}MB`,
                                'Alterar Limite de Armazenamento'
                            );
                            
                            if (!newLimit) return;
                            
                            try {
                                const response = await fetch(`${API_BASE}/api/admin/storage/limit/${userId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Authorization': `Bearer ${userToken}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ storageLimit: newLimit })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.message || 'Erro ao alterar limite');
                                
                                showMessage('admin-success-message', result.message);
                                loadAdminStorage();
                            } catch (err) {
                                showMessage('admin-error-message', err.message, true);
                            }
                        });
                    });
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar armazenamento:', err);
                    const tableBody = document.getElementById('storage-table-body');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-400">Erro ao carregar dados: ' + err.message + '</td></tr>';
                    }
                }
            }

            async function loadAdminSubscriptions() {
                if (isLoadingSubscriptions) return; // Prevenir múltiplas chamadas simultâneas
                isLoadingSubscriptions = true;
                
                try {
                    const period = document.getElementById('subscriptions-period-filter')?.value || '30';
                    const status = document.getElementById('subscriptions-status-filter')?.value || 'all';
                    
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions?period=${period}&status=${status}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        updateSubscriptionKPIs(data.kpis);
                        updateSubscriptionCharts(data.charts);
                        updateSubscriptionTable(data.subscriptions);
                        updateSubscriptionInsights(data.insights);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || 'Erro ao carregar dados de assinaturas');
                    }
                } catch (err) {
                    console.error('Erro ao carregar assinaturas:', err);
                    showMessage('admin-error-message', err.message, true);
                } finally {
                    isLoadingSubscriptions = false;
                }
            }

            // Atualizar KPIs
            function updateSubscriptionKPIs(kpis) {
                if (!kpis) return;
                
                // KPIs principais
                const mrrEl = document.getElementById('kpi-mrr');
                const mrrChangeEl = document.getElementById('kpi-mrr-change');
                if (mrrEl) mrrEl.textContent = formatCurrency(kpis.mrr || 0);
                if (mrrChangeEl) mrrChangeEl.innerHTML = formatChange(kpis.mrr_change);
                
                const arrEl = document.getElementById('kpi-arr');
                const arrChangeEl = document.getElementById('kpi-arr-change');
                if (arrEl) arrEl.textContent = formatCurrency(kpis.arr || 0);
                if (arrChangeEl) arrChangeEl.innerHTML = formatChange(kpis.arr_change);
                
                const activeSubsEl = document.getElementById('kpi-active-subscribers');
                const activeSubsChangeEl = document.getElementById('kpi-active-subscribers-change');
                if (activeSubsEl) activeSubsEl.textContent = formatNumber(kpis.active_subscribers || 0);
                if (activeSubsChangeEl) activeSubsChangeEl.innerHTML = formatChange(kpis.active_subscribers_change);
                
                const churnEl = document.getElementById('kpi-churn-rate');
                const churnChangeEl = document.getElementById('kpi-churn-rate-change');
                if (churnEl) churnEl.textContent = `${(kpis.churn_rate || 0).toFixed(2)}%`;
                if (churnChangeEl) churnChangeEl.innerHTML = formatChange(kpis.churn_rate_change);
                
                // KPIs secundários
                document.getElementById('kpi-new-subscribers').textContent = formatNumber(kpis.new_subscribers || 0);
                document.getElementById('kpi-cancellations').textContent = formatNumber(kpis.cancellations || 0);
                document.getElementById('kpi-ltv').textContent = formatCurrency(kpis.ltv || 0);
                document.getElementById('kpi-avg-duration').textContent = `${kpis.avg_duration || 0} dias`;
            }

            // Atualizar gráficos
            function updateSubscriptionCharts(charts) {
                if (!charts) return;
                
                // Gráfico MRR
                const mrrCtx = document.getElementById('mrr-chart');
                if (mrrCtx) {
                    if (mrrChart) mrrChart.destroy();
                    mrrChart = new Chart(mrrCtx, {
                        type: 'line',
                        data: {
                            labels: charts.mrr?.labels || [],
                            datasets: [{
                                label: 'MRR',
                                data: charts.mrr?.data || [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: { 
                                        color: '#d1d5db',
                                        font: { size: 12 },
                                        padding: 15
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgb(59, 130, 246)',
                                    borderWidth: 1,
                                    padding: 12
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 11 },
                                        padding: 10,
                                        callback: (value) => 'R$ ' + value.toFixed(2)
                                    }
                                },
                                x: { 
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 10 },
                                        padding: 8,
                                        maxRotation: 0,
                                        minRotation: 0
                                    } 
                                }
                            }
                        }
                    });
                }
                
                // Gráfico de Assinantes
                const subscribersCtx = document.getElementById('subscribers-chart');
                if (subscribersCtx) {
                    if (subscribersChart) subscribersChart.destroy();
                    subscribersChart = new Chart(subscribersCtx, {
                        type: 'line',
                        data: {
                            labels: charts.subscribers?.labels || [],
                            datasets: [{
                                label: 'Assinantes Ativos',
                                data: charts.subscribers?.data || [],
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: { 
                                        color: '#d1d5db',
                                        font: { size: 12 },
                                        padding: 15
                                    } 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgb(16, 185, 129)',
                                    borderWidth: 1,
                                    padding: 12
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.05)',
                                        drawBorder: false
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 11 },
                                        padding: 10,
                                        stepSize: 1
                                    }
                                },
                                x: { 
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: { 
                                        color: '#9ca3af',
                                        font: { size: 10 },
                                        padding: 8,
                                        maxRotation: 0,
                                        minRotation: 0
                                    } 
                                }
                            }
                        }
                    });
                }
                
                // Gráfico de Distribuição por Plano
                const plansCtx = document.getElementById('plans-distribution-chart');
                if (plansCtx) {
                    if (plansDistributionChart) plansDistributionChart.destroy();
                    plansDistributionChart = new Chart(plansCtx, {
                        type: 'doughnut',
                        data: {
                            labels: charts.plans_distribution?.labels || [],
                            datasets: [{
                                data: charts.plans_distribution?.data || [],
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(139, 92, 246, 0.8)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom',
                                    labels: { color: '#d1d5db', padding: 15 }
                                }
                            }
                        }
                    });
                }
                
                // Gráfico de Churn
                const churnCtx = document.getElementById('churn-chart');
                if (churnCtx) {
                    if (churnChart) churnChart.destroy();
                    churnChart = new Chart(churnCtx, {
                        type: 'bar',
                        data: {
                            labels: charts.churn?.labels || [],
                            datasets: [{
                                label: 'Churn Rate (%)',
                                data: charts.churn?.data || [],
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderColor: 'rgb(245, 158, 11)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { labels: { color: '#d1d5db' } }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: '#9ca3af', callback: (value) => value + '%' }
                                },
                                x: { ticks: { color: '#9ca3af' } }
                            }
                        }
                    });
                }
            }

            // Atualizar tabela de assinaturas
            function updateSubscriptionTable(subscriptions) {
                const tbody = document.getElementById('subscriptions-table-body');
                if (!tbody) return;
                
                if (!subscriptions || subscriptions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-400">Nenhuma assinatura encontrada</td></tr>';
                    return;
                }
                
                tbody.innerHTML = subscriptions.map(sub => {
                    const statusBadge = {
                        'active': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500/20 text-green-400">Ativa</span>',
                        'canceled': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-500/20 text-red-400">Cancelada</span>',
                        'past_due': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-500/20 text-yellow-400">Atrasada</span>',
                        'trialing': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-500/20 text-blue-400">Em Teste</span>'
                    }[sub.status] || '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-500/20 text-gray-400">' + sub.status + '</span>';
                    
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                            <td class="p-3 text-sm text-gray-200">${sub.user_email || 'N/A'}</td>
                            <td class="p-3 text-sm text-gray-200">${sub.plan_name || 'N/A'}</td>
                            <td class="p-3">${statusBadge}</td>
                            <td class="p-3 text-sm text-gray-200">${formatCurrency(sub.monthly_amount || 0)}</td>
                            <td class="p-3 text-sm text-gray-200">${formatDate(sub.start_date)}</td>
                            <td class="p-3 text-sm text-gray-200">${formatDate(sub.next_billing_date)}</td>
                            <td class="p-3 text-sm text-gray-200">${sub.duration_days || 0} dias</td>
                            <td class="p-3 text-sm text-gray-200">${formatCurrency(sub.total_paid || 0)}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Atualizar insights
            function updateSubscriptionInsights(insights) {
                const container = document.getElementById('subscriptions-insights');
                if (!container || !insights) return;
                
                container.innerHTML = insights.map(insight => `
                    <div class="p-4 bg-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-900/20 border border-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-700 rounded-lg">
                        <div class="flex items-start gap-3">
                            <i data-lucide="${insight.icon || 'info'}" class="w-5 h-5 text-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-400 mt-0.5"></i>
                            <div>
                                <p class="text-sm font-semibold text-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-300">${insight.title}</p>
                                <p class="text-sm text-${insight.type === 'positive' ? 'green' : insight.type === 'warning' ? 'amber' : 'blue'}-200 mt-1">${insight.message}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Funções auxiliares
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            }

            function formatChange(change) {
                if (change === null || change === undefined || change === 0) return '<span class="text-gray-400">-</span>';
                const sign = change >= 0 ? '+' : '';
                const color = change >= 0 ? 'text-green-400' : 'text-red-400';
                const icon = change >= 0 ? '↑' : '↓';
                return `<span class="${color} flex items-center gap-1"><span>${icon}</span><span>${sign}${Math.abs(change).toFixed(2)}%</span></span>`;
            }

            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString('pt-BR');
            }

            // Event listeners (apenas uma vez, usando flags)
            let subscriptionsListenersAttached = false;
            function attachSubscriptionsListeners() {
                if (subscriptionsListenersAttached) return;
                subscriptionsListenersAttached = true;
                
                const periodFilter = document.getElementById('subscriptions-period-filter');
                const statusFilter = document.getElementById('subscriptions-status-filter');
                const refreshBtn = document.getElementById('refresh-subscriptions');
                const searchInput = document.getElementById('subscriptions-search');
                const exportBtn = document.getElementById('export-subscriptions');
                
                if (periodFilter) {
                    periodFilter.removeEventListener('change', loadAdminSubscriptions);
                    periodFilter.addEventListener('change', loadAdminSubscriptions);
                }
                if (statusFilter) {
                    statusFilter.removeEventListener('change', loadAdminSubscriptions);
                    statusFilter.addEventListener('change', loadAdminSubscriptions);
                }
                if (refreshBtn) {
                    refreshBtn.removeEventListener('click', loadAdminSubscriptions);
                    refreshBtn.addEventListener('click', loadAdminSubscriptions);
                }
                if (searchInput) {
                    searchInput.removeEventListener('input', handleSubscriptionsSearch);
                    searchInput.addEventListener('input', handleSubscriptionsSearch);
                }
                if (exportBtn) {
                    exportBtn.removeEventListener('click', handleExportSubscriptions);
                    exportBtn.addEventListener('click', handleExportSubscriptions);
                }
            }
            
            function handleSubscriptionsSearch(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#subscriptions-table-body tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }
            
            async function handleExportSubscriptions() {
                try {
                    const period = document.getElementById('subscriptions-period-filter')?.value || '30';
                    const status = document.getElementById('subscriptions-status-filter')?.value || 'all';
                    
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions/export?period=${period}&status=${status}`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `assinaturas_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Exportação realizada com sucesso');
                    } else {
                        throw new Error('Erro ao exportar');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }

            // Exportar relatório de receitas
            document.getElementById('export-revenue-report')?.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions/report/revenue`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `relatorio_receitas_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Relatório de receitas exportado com sucesso');
                    } else {
                        throw new Error('Erro ao exportar relatório');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Exportar relatório de assinaturas
            document.getElementById('export-subscriptions-report')?.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/subscriptions/report/subscriptions`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `relatorio_assinaturas_${Date.now()}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showMessage('admin-success-message', 'Relatório de assinaturas exportado com sucesso');
                    } else {
                        throw new Error('Erro ao exportar relatório');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            });

            // Modal para editar API
            function showEditApiModal(api) {
                // Similar ao showAddApiModal mas preenchendo os campos
                showAddApiModal();
                // Preencher campos com dados da API
                setTimeout(() => {
                    document.getElementById('api-name').value = api.name;
                    document.getElementById('api-provider').value = api.provider;
                    document.getElementById('api-model').value = api.model;
                    document.getElementById('api-key').value = api.api_key;
                    document.getElementById('api-credits-per-unit').value = api.credits_per_unit;
                    document.getElementById('api-unit-size').value = api.unit_size;
                    document.getElementById('api-markup').value = api.markup;
                    document.getElementById('api-is-active').checked = api.is_active === 1;
                    document.getElementById('api-is-default').checked = api.is_default === 1;
                    
                    // Mudar título e ação do formulário
                    document.querySelector('#add-api-modal h2').textContent = 'Editar API';
                    const form = document.getElementById('add-api-form');
                    form.removeEventListener('submit', form._submitHandler);
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/api-providers/${api.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({
                                    name: document.getElementById('api-name').value,
                                    provider: document.getElementById('api-provider').value,
                                    model: document.getElementById('api-model').value,
                                    api_key: document.getElementById('api-key').value,
                                    credits_per_unit: parseFloat(document.getElementById('api-credits-per-unit').value),
                                    unit_size: parseInt(document.getElementById('api-unit-size').value),
                                    markup: parseFloat(document.getElementById('api-markup').value),
                                    is_active: document.getElementById('api-is-active').checked ? 1 : 0,
                                    is_default: document.getElementById('api-is-default').checked ? 1 : 0
                                })
                            });
                            
                            if (response.ok) {
                                showMessage('admin-success-message', 'API atualizada com sucesso');
                                document.getElementById('add-api-modal')?.remove();
                                loadAdminApis();
                            } else {
                                throw new Error('Erro ao atualizar API');
                            }
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                        }
                    });
                }, 100);
            }
            
            // Deletar API
            async function deleteApi(apiId) {
                const confirmed = await showCustomConfirm('Tem certeza que deseja excluir esta API?');
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/admin/api-providers/${apiId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        showMessage('admin-success-message', 'API excluída com sucesso');
                        loadAdminApis();
                    } else {
                        throw new Error('Erro ao excluir API');
                    }
                } catch (err) {
                    showMessage('admin-error-message', err.message, true);
                }
            }
            
            function setupAdminListeners() {
                const adminUserTableBody = document.getElementById('admin-user-table-body');
                if (adminUserTableBody) {
                    adminUserTableBody.addEventListener('click', (e) => {
                        const button = e.target.closest('.btn-admin-action');
                        if (!button) return;

                        const action = button.dataset.action;
                        const userId = button.dataset.id;
                        const user = JSON.parse(button.dataset.user || '{}');

                        switch (action) {
                            case 'edit':
                                showEditUserModal(user);
                                break;
                            case 'change-password':
                                showChangePasswordModal(user);
                                break;
                            case 'toggle-block':
                                const isBlocked = button.dataset.isBlocked === 'true';
                                toggleUserBlockStatus(userId, !isBlocked);
                                break;
                            case 'change-plan':
                                changeUserPlan(user);
                                break;
                            case 'delete':
                                deleteUser(userId);
                                break;
                        }
                    });
                }
                
                // Função para alterar plano do usuário
                async function changeUserPlan(user) {
                    const plans = [
                        { value: 'plan-free', label: 'FREE' },
                        { value: 'plan-start', label: 'START CREATOR' },
                        { value: 'plan-turbo', label: 'TURBO MAKER' },
                        { value: 'plan-master', label: 'MASTER PRO' },
                        { value: 'plan-start-annual', label: 'START ANUAL' },
                        { value: 'plan-turbo-annual', label: 'TURBO ANUAL' },
                        { value: 'plan-master-annual', label: 'MASTER ANUAL' }
                    ];
                    
                    const currentPlan = user.subscription_plan || user.plan || 'plan-free';
                    const currentPlanLabel = plans.find(p => p.value === currentPlan)?.label || currentPlan;
                    
                    const planOptions = plans.map(p => 
                        `<option value="${p.value}" ${p.value === currentPlan ? 'selected' : ''}>${p.label}</option>`
                    ).join('');
                    
                    const message = `Alterar plano do usuário ${user.email}\n\nPlano atual: ${currentPlanLabel}\n\nSelecione o novo plano:`;
                    
                    // Criar select temporário
                    const selectHtml = `
                        <select id="temp-plan-select" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white mt-3">
                            ${planOptions}
                        </select>
                    `;
                    
                    // Usar modal customizado com select
                    const modal = document.getElementById('custom-modal-overlay');
                    const messageEl = document.getElementById('custom-modal-message');
                    const inputEl = document.getElementById('custom-modal-input');
                    const titleEl = document.getElementById('custom-modal-title-text');
                    
                    titleEl.textContent = 'Alterar Plano';
                    messageEl.innerHTML = message + selectHtml;
                    inputEl.style.display = 'none';
                    
                    modal.style.display = 'flex';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    const select = document.getElementById('temp-plan-select');
                    
                    const confirmBtn = document.getElementById('custom-modal-confirm');
                    const cancelBtn = document.getElementById('custom-modal-cancel');
                    const closeBtn = document.getElementById('custom-modal-close');
                    
                    const cleanup = () => {
                        modal.style.display = 'none';
                        messageEl.innerHTML = '';
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        closeBtn.onclick = null;
                    };
                    
                    confirmBtn.onclick = async () => {
                        const newPlan = select.value;
                        if (newPlan === currentPlan) {
                            cleanup();
                            return;
                        }
                        
                        try {
                            const response = await fetch(`${API_BASE}/api/admin/users/${user.id}/plan`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({ plan: newPlan })
                            });
                            
                            const data = await response.json();
                            if (!response.ok) throw new Error(data.message || 'Erro ao alterar plano');
                            
                            showMessage('admin-success-message', `Plano alterado com sucesso para ${plans.find(p => p.value === newPlan)?.label || newPlan}`);
                            loadAdminUsers();
                            cleanup();
                        } catch (err) {
                            showMessage('admin-error-message', err.message, true);
                            cleanup();
                        }
                    };
                    
                    cancelBtn.onclick = cleanup;
                    closeBtn.onclick = cleanup;
                }
                
                // Botão adicionar API
                document.getElementById('btn-add-api')?.addEventListener('click', () => {
                    showAddApiModal();
                });

                document.getElementById('admin-search-input').addEventListener('input', loadAdminUsers);
                document.getElementById('admin-status-filter').addEventListener('change', loadAdminUsers);
                
                // Listeners para aba de armazenamento
                document.getElementById('refresh-storage-stats')?.addEventListener('click', loadAdminStorage);
                document.getElementById('storage-search')?.addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#storage-table-body tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(search) ? '' : 'none';
                    });
                });
                document.getElementById('btn-approve-all').addEventListener('click', async () => {
                    const confirmed = await showCustomConfirm('Tem a certeza que deseja aprovar todos os utilizadores pendentes?');
                    if (!confirmed) return;
                    try {
                        const response = await fetch(`${API_BASE}/api/admin/users/approve-all`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg);
                        showMessage('admin-success-message', data.msg);
                        loadAdminUsers();
                        loadAdminStats();
                    } catch (err) {
                        showMessage('admin-error-message', err.message, true);
                    }
                });
            }


            // --- LÓGICA DE NAVEGAÇÃO SPA ---
            const navLinks = document.querySelectorAll('#main-nav a');
            const views = document.querySelectorAll('main > div[id^="view-"]');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const hamburgerButton = document.getElementById('hamburger-button');

            // Event delegation para links de navegação - DEVE SER CONFIGURADO PRIMEIRO
            const mainNav = document.getElementById('main-nav');
            if (mainNav) {
                mainNav.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (!link) return;
                    
                    // Se o link tem data-view, usar navegação SPA
                    if (link.hasAttribute('data-view')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const viewName = link.getAttribute('data-view');
                        navigateToView(viewName);
                        return false;
                    }
                    // Se não tem data-view, deixar o link funcionar normalmente (navegação externa)
                    // Não fazer preventDefault, permitir navegação normal
                }, true); // Usar capture phase para garantir que executa primeiro
            }

            // Função auxiliar para atualizar o dashboard se estiver na tela de início
            function refreshDashboardIfVisible() {
                const inicioView = document.getElementById('view-inicio');
                if (inicioView && inicioView.style.display !== 'none') {
                    loadDashboard();
                    loadCreditsBalance();
                    loadCurrentPlan();
                }
            }
            
            function navigateToView(viewName, params = {}) {
                if (!viewName) return;

                // Esconder todas as views primeiro
                views.forEach(view => { 
                    if (view) {
                        view.style.display = 'none';
                        // Garantir que não há conteúdo misturado
                        view.classList.remove('active');
                    }
                });
                
                // Mostrar apenas a view ativa
                const activeView = document.getElementById('view-' + viewName);
                if (activeView) {
                    activeView.style.display = 'block';
                    activeView.classList.add('active');
                }

                // Ao entrar na tela de Prompts de Cenas, carregar histórico imediatamente
                if (viewName === 'prompts-imagens') {
                    try {
                        loadScenePromptsHistory();
                    } catch (err) {
                        console.warn('[Prompts] Falha ao carregar histórico ao entrar na view:', err);
                    }
                }

                navLinks.forEach(navLink => {
                    if (navLink) {
                        navLink.classList.remove('bg-amber-600', 'text-black', 'font-bold');
                        navLink.classList.add('text-gray-400', 'hover:bg-gray-800', 'hover:text-white', 'font-medium');
                    }
                });
                const link = document.querySelector(`a[data-view="${viewName}"]`);
                if (link) {
                    link.classList.add('bg-amber-600', 'text-black', 'font-bold');
                    link.classList.remove('text-gray-400', 'hover:bg-gray-800', 'hover:text-white', 'font-medium');
                }
                
                if (window.innerWidth < 768) { 
                    if (sidebar) sidebar.classList.add('-translate-x-full');
                    if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
                }
                
                // Carrega dados específicos da view
                if (viewName === 'admin') {
                    loadAdminStats();
                    loadAdminUsers();
                    // Inicializar sistema de abas
                    initAdminTabs();
                }
                
                if (viewName === 'configuracoes') {
                    loadAPIKeysStatus();
                }
                
                if (viewName === 'gerador-voz') {
                    // Garantir que apenas o gerador de voz seja exibido
                    const adminView = document.getElementById('view-admin');
                    if (adminView) adminView.style.display = 'none';
                    
                    // Pré-carregar vozes premium em background
                    preloadPremiumVoices();
                    
                    // Carregar vozes quando acessar o gerador
                    setTimeout(() => {
                        loadTtsVoices();
                        toggleDarkVozControls();
                    }, 100);
                }
                
                if (viewName === 'configuracoes') {
                    // Carregar preferências do usuário e status das chaves
                    loadUserPreferences();
                    loadAPIKeysStatus();
                }
                if (viewName === 'gerador-video') {
                    console.log('[Dashboard] ========== NAVEGANDO PARA GERADOR DE VÍDEO ==========');
                    console.log('[Dashboard] View name:', viewName);
                    console.log('[Dashboard] Função initVideoGenerator existe?', typeof initVideoGenerator);
                    // Aguardar um pouco para garantir que o DOM está pronto
                    setTimeout(() => {
                        console.log('[Dashboard] Chamando initVideoGenerator...');
                        if (typeof initVideoGenerator === 'function') {
                            initVideoGenerator();
                        } else {
                            console.error('[Dashboard] ❌ initVideoGenerator não é uma função!');
                        }
                    }, 300);
                }
                
                if (viewName === 'inicio') {
                    loadDashboard(); // Recarregar dashboard quando voltar para a tela inicial
                    loadCreditsBalance(); // Carregar saldo de créditos
                    loadCurrentPlan(); // Carregar plano atual
                    startDashboardAutoRefresh(); // Iniciar atualização automática
                } else {
                    stopDashboardAutoRefresh(); // Parar atualização quando sair da tela de início
                }
                if (viewName === 'historico') {
                    loadHistoryNiches();
                    loadFolders().then(() => {
                        // Atualizar estado ativo das pastas
                        setTimeout(() => {
                            document.querySelectorAll('.folder-link').forEach(btn => {
                                btn.classList.remove('active', 'bg-amber-500/10', 'border-amber-500/50');
                                btn.classList.add('border-transparent');
                            });
                        }, 100);
                        
                        if (params.folderId) {
                            const folderName = userFolders.find(f => f.id == params.folderId)?.name || 'Desconhecida';
                            historyTitle.innerText = folderName;
                            const historySubtitle = document.getElementById('history-subtitle');
                            if (historySubtitle) {
                                historySubtitle.innerText = `Análises da pasta ${folderName}`;
                            }
                            clearHistoryFilterBtn.style.display = 'flex';
                            
                            // Ativar pasta selecionada
                            setTimeout(() => {
                                const folderBtn = document.querySelector(`.folder-link[data-folder-id="${params.folderId}"]`);
                                if (folderBtn) {
                                    folderBtn.classList.add('active', 'bg-amber-500/10', 'border-amber-500/50');
                                    folderBtn.classList.remove('border-transparent');
                                }
                            }, 150);
                            
                            loadHistory(params.folderId, 1, currentHistoryLimit);
                        } else {
                            historyTitle.innerText = 'Histórico Geral';
                            const historySubtitle = document.getElementById('history-subtitle');
                            if (historySubtitle) {
                                historySubtitle.innerText = 'Todas as suas análises em um só lugar';
                            }
                            clearHistoryFilterBtn.style.display = 'none';
                            
                            // Ativar botão "Histórico Geral"
                            setTimeout(() => {
                                const folderAllBtn = document.getElementById('folder-all');
                                if (folderAllBtn) {
                                    folderAllBtn.classList.add('active', 'bg-amber-500/10', 'border-amber-500/50');
                                    folderAllBtn.classList.remove('border-transparent');
                                }
                            }, 150);
                            
                            loadHistory(null, 1, currentHistoryLimit);
                        }
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    });
                }
                if (viewName === 'canais') {
                    loadMonitoredChannels();
                    loadPinnedVideos(null); // null = mostrar todos os canais
                }
                if (viewName === 'gerador-voz') {
                    setTimeout(() => {
                        loadTtsVoices();
                    }, 100);
                }
                if (viewName === 'analisador' || viewName === 'explorar-nicho') {
                    loadFolders();
                }
                if (viewName === 'analytics') {
                    loadAnalytics();
                    loadChannels();
                }
                if (viewName === 'biblioteca') {
                    loadBibliotecaNiches();
                    loadBibliotecaTitles(1, currentBibliotecaLimit);
                    // Garantir que a tab de agentes está disponível
                    if (currentBibliotecaTab === 'agents') {
                        loadBibliotecaAgents();
                    }
                }
                if (viewName === 'viral-agents') {
                    loadViralAgents();
                }
                if (viewName === 'youtube-integration') {
                    loadYouTubeIntegrationStatus();
                    loadScheduledPosts();
                    loadMonitoredCompetitors();
                    loadAISuggestions();
                    loadViralAlerts();
                    // Aguardar um pouco para garantir que os elementos existam
                    setTimeout(() => {
                        updateChannelSelects(); // Atualizar selects de canais
                    }, 200);
                    switchYouTubeTab('channels'); // Definir tab padrão
                    
                    // ❗️Sem refresh automático (SaaS + quota): atualizar somente via ações do usuário
                    // - Clique em "Atualizar" / "Carregar Métricas"
                    // - Evento do popup OAuth (postMessage)
                } else {
                    // Parar atualização automática quando sair da view de YouTube
                    if (youtubeChannelsRefreshInterval) {
                        clearInterval(youtubeChannelsRefreshInterval);
                        youtubeChannelsRefreshInterval = null;
                        console.log('[YouTube Integration] ⏹️ Atualização automática parada');
                    }
                }
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Função auxiliar para formatar números
            function formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }

            // === FUNCIONALIDADES PARTE 2: AUTOMAÇÃO YOUTUBE ===

            // Função para trocar de tab no YouTube Integration
            window.switchYouTubeTab = function(tabName) {
                document.querySelectorAll('.youtube-tab-content').forEach(content => content.style.display = 'none');
                document.querySelectorAll('.youtube-tab-button').forEach(btn => {
                    btn.classList.remove('border-amber-500', 'text-amber-500');
                    btn.classList.add('border-transparent', 'text-gray-400');
                });
                const content = document.getElementById(`youtube-tab-content-${tabName}`);
                if (content) content.style.display = 'block';
                const button = document.getElementById(`youtube-tab-${tabName}`);
                if (button) {
                    button.classList.add('border-amber-500', 'text-amber-500');
                    button.classList.remove('border-transparent', 'text-gray-400');
                }
                
                // Carregar dados específicos da aba
                if (tabName === 'channels') {
                    // Quando abrir a aba de canais, atualizar selects
                    setTimeout(() => {
                        updateChannelSelects();
                    }, 200);
                } else if (tabName === 'competitors') {
                    loadMonitoredCompetitors();
                } else if (tabName === 'analytics') {
                    updateChannelSelects().then(() => {
                        // Auto-carregar analytics do primeiro canal se houver apenas um
                        const analyticsSelect = document.getElementById('analytics-channel-select');
                        if (analyticsSelect && analyticsSelect.options.length === 2) {
                            // Há apenas um canal (além da opção padrão)
                            analyticsSelect.value = analyticsSelect.options[1].value;
                            loadChannelAnalytics();
                        }
                    });
                } else if (tabName === 'insights') {
                    updateChannelSelects();
                } else if (tabName === 'suggestions') {
                    loadAISuggestions();
                    setTimeout(() => {
                        if (typeof setupSuggestionsForm === 'function') {
                            setupSuggestionsForm();
                        }
                    }, 100);
                } else if (tabName === 'alerts') {
                    loadViralAlerts();
                }
            };

            // A.1 - Agendamento Inteligente
            const suggestTimeForm = document.getElementById('suggest-time-form');
            if (suggestTimeForm) {
                suggestTimeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    showLoadingModal('Analisando melhor horário para publicar...', 'calendar');
                    
                    try {
                        const token = localStorage.getItem('core_token');
                        const response = await fetch(`${API_BASE}/api/youtube/suggest-best-time`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                niche: document.getElementById('suggest-time-niche').value,
                                subniche: document.getElementById('suggest-time-subniche').value
                            })
                        });
                        if (!response.ok) throw new Error('Falha ao sugerir horário');
                        const data = await response.json();
                        const resultDiv = document.getElementById('suggested-time-result');
                        if (resultDiv) {
                            document.getElementById('suggested-time').textContent = data.suggestedTime;
                            document.getElementById('suggested-days').textContent = `Melhores dias: ${data.suggestedDays.join(', ')}`;
                            document.getElementById('suggested-explanation').textContent = data.explanation;
                            const altDiv = document.getElementById('alternative-times');
                            if (altDiv && data.alternativeTimes) {
                                altDiv.innerHTML = data.alternativeTimes.map(t => 
                                    `<span class="px-3 py-1 bg-gray-700 text-gray-300 rounded text-sm">${t}</span>`
                                ).join('');
                            }
                            resultDiv.classList.remove('hidden');
                        }
                    } catch (err) {
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            // A.3 - Gerador de Metadata
            const generateMetadataForm = document.getElementById('generate-metadata-form');
            if (generateMetadataForm) {
                console.log('[Metadata Generator] Form encontrado, anexando event listener');
                generateMetadataForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[Metadata Generator] Form submetido');
                    
                    const title = document.getElementById('metadata-title').value;
                    const model = document.getElementById('metadata-model').value;
                    const modelName = model === 'gpt-4o' ? 'GPT-4o' : model === 'claude-3-7-sonnet-20250219' ? 'Claude 3.7 Sonnet' : 'Gemini 2.5 Pro';
                    
                    showLoadingModal(`Gerando metadata com ${modelName}...`, 'wand-2');
                    
                    try {
                        const niche = document.getElementById('metadata-niche').value;
                        const videoDescription = document.getElementById('metadata-description').value;
                        
                        console.log('[Metadata Generator] Dados:', { title, model, niche, videoDescription });
                        
                        if (!title) {
                            hideLoadingModal();
                            throw new Error('Título do vídeo é obrigatório');
                        }
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            hideLoadingModal();
                            throw new Error('Token de autenticação não encontrado. Faça login novamente.');
                        }
                        
                        console.log('[Metadata Generator] Enviando requisição...');
                        const response = await fetch(`${API_BASE}/api/youtube/generate-metadata`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                title: title,
                                model: model,
                                niche: niche,
                                videoDescription: videoDescription
                            })
                        });
                        
                        console.log('[Metadata Generator] Resposta recebida:', response.status, response.ok);
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ msg: 'Falha ao gerar metadata' }));
                            hideLoadingModal();
                            throw new Error(errorData.msg || 'Falha ao gerar metadata');
                        }
                        
                        const data = await response.json();
                        console.log('[Metadata Generator] Dados recebidos:', data);
                        
                        hideLoadingModal();
                        
                        const resultDiv = document.getElementById('generated-metadata-result');
                        if (resultDiv) {
                            const descriptionField = document.getElementById('generated-description');
                            if (descriptionField) {
                                descriptionField.value = data.description || '';
                            }
                            const tagsDiv = document.getElementById('generated-tags');
                            if (tagsDiv && data.tags && Array.isArray(data.tags)) {
                                tagsDiv.innerHTML = data.tags.map(tag => 
                                    `<span class="px-3 py-1 bg-amber-600/20 text-amber-400 rounded text-sm border border-amber-600/30">${tag}</span>`
                                ).join('');
                            }
                            resultDiv.classList.remove('hidden');
                            showMessage('youtube-integration-success-message', `Metadata gerada com sucesso usando ${modelName}!`);
                        } else {
                            console.error('[Metadata Generator] resultDiv não encontrado');
                        }
                    } catch (err) {
                        console.error('[Metadata Generator] Erro:', err);
                        hideLoadingModal();
                        showMessage('youtube-integration-error-message', err.message || 'Erro ao gerar metadata', true);
                    }
                });
            } else {
                console.warn('[Metadata Generator] Form não encontrado!');
            }

            window.copyToClipboard = function(elementId) {
                const el = document.getElementById(elementId);
                if (el) { el.select(); document.execCommand('copy'); showMessage('youtube-integration-success-message', 'Copiado!'); }
            };
            window.copyTagsToClipboard = function() {
                const tags = Array.from(document.querySelectorAll('#generated-tags span')).map(s => s.textContent).join(', ');
                navigator.clipboard.writeText(tags).then(() => showMessage('youtube-integration-success-message', 'Tags copiadas!'));
            };

            // B.2 - Análise de Tendências
            const scanTrendsForm = document.getElementById('scan-trends-form');
            if (scanTrendsForm) {
                scanTrendsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    showLoadingModal('Escanando tendências no YouTube...', 'search');
                    
                    try {
                        const token = localStorage.getItem('core_token');
                        const response = await fetch(`${API_BASE}/api/youtube/scan-trends`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                niche: document.getElementById('trends-niche').value,
                                subniche: document.getElementById('trends-subniche').value,
                                maxResults: parseInt(document.getElementById('trends-max-results').value || 10),
                                minViews: parseInt(document.getElementById('trends-min-views').value || 0),
                                minViewsPerDay: parseInt(document.getElementById('trends-min-views-per-day').value || 0),
                                language: document.getElementById('trends-language').value || 'pt',
                                orderBy: document.getElementById('trends-order-by').value || 'viewCount',
                                publishedAfter: parseInt(document.getElementById('trends-published-after').value || 7),
                                videoDuration: document.getElementById('trends-duration').value || 'any',
                                videoDefinition: 'any'
                            })
                        });
                        if (!response.ok) {
                            hideLoadingModal();
                            throw new Error('Falha ao escanear tendências');
                        }
                        const data = await response.json();
                        
                        hideLoadingModal();
                        
                        const resultsDiv = document.getElementById('trends-results');
                        if (resultsDiv) {
                            if (data.trends && data.trends.length > 0) {
                                resultsDiv.innerHTML = data.trends.map(t => {
                                    const isViral = t.isViral !== false; // Assume viral se não especificado
                                    return `
                                    <div class="bg-gray-800 border ${isViral ? 'border-amber-500' : 'border-gray-700'} rounded-lg p-4 hover:bg-gray-750 transition-colors">
                                        <div class="flex items-start space-x-4">
                                            ${t.thumbnailUrl ? `<img src="${t.thumbnailUrl}" alt="${t.title}" class="w-32 h-24 object-cover rounded cursor-pointer" onclick="window.open('${t.url}', '_blank')">` : ''}
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <h3 class="text-white font-semibold"><a href="${t.url}" target="_blank" class="hover:text-amber-400">${t.title}</a></h3>
                                                    ${isViral ? '<span class="bg-amber-500 text-black text-xs font-bold px-2 py-1 rounded">VIRAL</span>' : '<span class="bg-gray-600 text-gray-300 text-xs font-semibold px-2 py-1 rounded">RELEVANTE</span>'}
                                                </div>
                                                <p class="text-gray-400 text-sm mb-2">📺 ${t.channelName}</p>
                                                <div class="flex flex-wrap gap-4 text-sm">
                                                    <span class="text-gray-300">👁️ ${typeof formatNumber === 'function' ? formatNumber(t.views) : t.views.toLocaleString('pt-BR')} views</span>
                                                    <span class="text-gray-300">📊 ${typeof formatNumber === 'function' ? formatNumber(t.viewsPerDay) : t.viewsPerDay.toLocaleString('pt-BR')} views/dia</span>
                                                    <span class="text-gray-300">📅 ${t.daysSince} ${t.daysSince === 1 ? 'dia' : 'dias'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                }).join('');
                            } else {
                                resultsDiv.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhum vídeo encontrado para este nicho. Tente ajustar os termos de busca ou aumentar o número de resultados.</p>';
                            }
                        }
                        
                        // Mostrar mensagem de sucesso ou informação
                        if (data.msg) {
                            showMessage('youtube-integration-success-message', data.msg);
                        } else if (data.count > 0) {
                            showMessage('youtube-integration-success-message', `${data.count} vídeo(s) encontrado(s).`);
                        }
                    } catch (err) {
                        hideLoadingModal();
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            // B.3 - Monitoramento de Competidores
            const monitorCompetitorForm = document.getElementById('monitor-competitor-form');
            if (monitorCompetitorForm) {
                monitorCompetitorForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    showLoadingModal('Adicionando competidor para monitoramento...', 'users');
                    
                    try {
                        const token = localStorage.getItem('core_token');
                        const response = await fetch(`${API_BASE}/api/youtube/monitor-competitor`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ 
                                competitorChannelId: document.getElementById('competitor-channel-id').value,
                                competitorChannelName: document.getElementById('competitor-channel-name').value,
                                niche: document.getElementById('competitor-niche').value,
                                autoAnalyze: document.getElementById('competitor-auto-analyze').checked
                            })
                        });
                        if (!response.ok) {
                            hideLoadingModal();
                            throw new Error('Falha ao adicionar competidor');
                        }
                        const data = await response.json();
                        
                        hideLoadingModal();
                        showMessage('youtube-integration-success-message', data.msg);
                        monitorCompetitorForm.reset();
                        loadMonitoredCompetitors();
                    } catch (err) {
                        hideLoadingModal();
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            async function loadMonitoredCompetitors() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/monitored-competitors`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar competidores');
                    const data = await response.json();
                    const listDiv = document.getElementById('monitored-competitors-list');
                    if (listDiv) {
                        if (data.competitors && data.competitors.length > 0) {
                            listDiv.innerHTML = data.competitors.map(c => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h3 class="text-white font-semibold">${c.competitor_channel_name || c.competitor_channel_id}</h3>
                                            <p class="text-gray-400 text-sm">${c.niche || 'Nicho não especificado'}</p>
                                            <p class="text-gray-500 text-xs">Frequência: ${c.check_frequency || 'daily'}</p>
                                        </div>
                                        <button onclick="removeCompetitor(${c.id})" class="py-2 px-3 bg-red-600 hover:bg-red-500 text-white rounded text-sm">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            listDiv.innerHTML = '<p class="text-gray-400">Nenhum competidor monitorado.</p>';
                        }
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar competidores:', err);
                }
            }

            window.removeCompetitor = async function(id) {
                if (!confirm('Remover este competidor?')) return;
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/monitor-competitor/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao remover');
                    showMessage('youtube-integration-success-message', 'Competidor removido!');
                    loadMonitoredCompetitors();
                } catch (err) {
                    showMessage('youtube-integration-error-message', err.message, true);
                }
            };

            // B.4 - Sugestões Automáticas
            function setupSuggestionsForm() {
                const generateSuggestionsForm = document.getElementById('generate-suggestions-form');
                if (generateSuggestionsForm && !generateSuggestionsForm.hasAttribute('data-listener-attached')) {
                    console.log('[Sugestões IA] Form encontrado, anexando event listener');
                    generateSuggestionsForm.setAttribute('data-listener-attached', 'true');
                    generateSuggestionsForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Sugestões IA] Form submetido');
                        
                        showLoadingModal('Gerando sugestões de vídeos com IA...', 'sparkles');
                        
                        try {
                            const niche = document.getElementById('suggestions-niche').value;
                            const subniche = document.getElementById('suggestions-subniche').value;
                            
                            console.log('[Sugestões IA] Dados:', { niche, subniche });
                            
                            if (!niche) {
                                hideLoadingModal();
                                throw new Error('Nicho é obrigatório para gerar sugestões');
                            }
                            
                            const token = localStorage.getItem('core_token');
                            if (!token) {
                                hideLoadingModal();
                                throw new Error('Token de autenticação não encontrado. Faça login novamente.');
                            }
                            
                            console.log('[Sugestões IA] Enviando requisição...');
                            const response = await fetch(`${API_BASE}/api/youtube/generate-suggestions`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                                body: JSON.stringify({ 
                                    niche: niche,
                                    subniche: subniche || null
                                })
                            });
                            
                            console.log('[Sugestões IA] Resposta recebida:', response.status, response.ok);
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ msg: 'Falha ao gerar sugestões' }));
                                hideLoadingModal();
                                throw new Error(errorData.msg || 'Falha ao gerar sugestões');
                            }
                            
                            const data = await response.json();
                            console.log('[Sugestões IA] Dados recebidos:', data);
                            
                            hideLoadingModal();
                            showMessage('youtube-integration-success-message', data.msg || `${data.count || 0} sugestão(ões) gerada(s).`);
                            loadAISuggestions();
                        } catch (err) {
                            console.error('[Sugestões IA] Erro:', err);
                            hideLoadingModal();
                            showMessage('youtube-integration-error-message', err.message || 'Erro ao gerar sugestões', true);
                        }
                    });
                } else if (!generateSuggestionsForm) {
                    console.warn('[Sugestões IA] Form não encontrado!');
                }
            }
            
            // Configurar o form inicialmente
            setupSuggestionsForm();

            async function loadAISuggestions() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/ai-suggestions?limit=20`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar sugestões');
                    const data = await response.json();
                    const listDiv = document.getElementById('ai-suggestions-list');
                    if (listDiv) {
                        if (data.suggestions && data.suggestions.length > 0) {
                            // Função auxiliar para escapar HTML
                            const escapeHtml = (text) => {
                                if (!text) return '';
                                const div = document.createElement('div');
                                div.textContent = String(text);
                                return div.innerHTML;
                            };
                            
                            listDiv.innerHTML = data.suggestions.map(s => {
                                const safeTitle = escapeHtml(s.title || '');
                                const safeTitleForJs = safeTitle.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                return `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <h3 class="text-white font-semibold flex-1">${safeTitle}</h3>
                                                <button onclick="copySuggestionTitle('${safeTitleForJs}')" 
                                                        class="p-2 text-gray-400 hover:text-amber-500 hover:bg-gray-700 rounded-lg transition" 
                                                        title="Copiar título">
                                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                            <p class="text-gray-400 text-sm mb-2">${escapeHtml(s.description || '')}</p>
                                            <p class="text-gray-500 text-xs mb-2">${escapeHtml(s.reason || '')}</p>
                                            <div class="flex items-center space-x-4 text-xs">
                                                <span class="text-amber-400">⭐ Prioridade: ${s.priority}/10</span>
                                                <span class="text-gray-500">${escapeHtml(s.niche || '')}</span>
                                            </div>
                                        </div>
                                        <button onclick="markSuggestionViewed(${s.id})" class="ml-4 py-2 px-3 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm">
                                            <i data-lucide="check" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            }).join('');
                        } else {
                            listDiv.innerHTML = '<p class="text-gray-400">Nenhuma sugestão disponível.</p>';
                        }
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao carregar sugestões:', err);
                }
            }

            window.markSuggestionViewed = async function(id) {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/ai-suggestions/${id}/viewed`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao marcar');
                    loadAISuggestions();
                } catch (err) {
                    showMessage('youtube-integration-error-message', err.message, true);
                }
            };

            window.copySuggestionTitle = function(title) {
                navigator.clipboard.writeText(title).then(() => {
                    showMessage('youtube-integration-success-message', 'Título copiado para a área de transferência!', false);
                }).catch(err => {
                    console.error('Erro ao copiar:', err);
                    showMessage('youtube-integration-error-message', 'Erro ao copiar título', true);
                });
            };

            // B.1 - Alertas Virais
            async function loadViralAlerts() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/viral-alerts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar alertas');
                    const data = await response.json();
                    const listDiv = document.getElementById('viral-alerts-list');
                    if (listDiv) {
                        if (data.alerts && data.alerts.length > 0) {
                            listDiv.innerHTML = data.alerts.map(a => `
                                <div class="bg-gray-800 border border-amber-600/30 rounded-lg p-4">
                                    <h3 class="text-white font-semibold mb-2">
                                        <a href="${a.video_url || '#'}" target="_blank" class="hover:text-amber-400">${a.video_title || 'Vídeo Viral'}</a>
                                    </h3>
                                    <p class="text-gray-400 text-sm mb-2">Canal: ${a.competitor_channel_name || a.competitor_channel_id}</p>
                                    <div class="flex flex-wrap gap-4 text-sm">
                                        <span class="text-gray-300">👁️ ${formatNumber(a.views || 0)} views</span>
                                        <span class="text-gray-300">📊 ${formatNumber(a.views_per_day || 0)} views/dia</span>
                                    </div>
                                    <p class="text-gray-500 text-xs mt-2">${new Date(a.detected_at).toLocaleString('pt-BR')}</p>
                                </div>
                            `).join('');
                        } else {
                            listDiv.innerHTML = '<p class="text-gray-400">Nenhum alerta viral no momento.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar alertas:', err);
                }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.getAttribute('data-view');
                    navigateToView(viewName);
                });
            });

            if (hamburgerButton) {
                hamburgerButton.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.remove('-translate-x-full');
                    if (sidebarOverlay) sidebarOverlay.classList.remove('hidden');
                });
            }
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    if (sidebar) sidebar.classList.add('-translate-x-full');
                    if (sidebarOverlay) sidebarOverlay.classList.add('hidden');
                });
            }

            // --- Lógica de Download ---
            function downloadThumbnail(url, title) {
                fetch(url)
                    .then(response => response.blob())
                    .then(blob => {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `thumbnail_${title.replace(/[^a-z0-9]/gi, '_')}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    })
                    .catch(err => {
                        console.error("Erro ao baixar thumbnail:", err);
                        alert("Falha ao baixar thumbnail.");
                    });
            }
            
            function downloadBase64Image(base64Data, title) {
                const link = document.createElement('a');
                link.href = base64Data;
                link.download = `generated_thumb_${title.replace(/[^a-z0-9]/gi, '_')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }


            // --- LÓGICA DO ANALISADOR DE VÍDEOS ---
            const analisadorForm = document.getElementById('analisador-form');
            const loadingSpinner = document.getElementById('analisador-loading');
            const resultadosDiv = document.getElementById('analisador-resultados');
            const analisarButton = document.getElementById('analisar-button');
            const errorBox = document.getElementById('analisador-error'); 
            const folderSelect = document.getElementById('folder-select');
            const modelSelect = document.getElementById('model-select');
            const modelInfoText = document.getElementById('model-info-text');
            
            const thumbGeneratorDiv = document.getElementById('thumbnail-generator');
            const thumbTitleSelect = document.getElementById('thumb-title-select');
            const thumbModelSelect = document.getElementById('thumb-model-select');
            const thumbLanguageSelect = document.getElementById('thumb-language');
            const thumbPhrasesSelect = document.getElementById('thumb-phrases');
            const thumbStyleSelect = document.getElementById('thumb-style');
            const btnGenerateThumbs = document.getElementById('btn-generate-thumbs');
            const btnGenerateMoreThumbs = document.getElementById('btn-generate-more-thumbs');

            const thumbLoadingSpinner = document.getElementById('thumbnail-ideas-loading');
            const thumbResultadosDiv = document.getElementById('thumbnail-ideas-results');
            
            // Atualizar info do modelo quando mudar seleção
            if (modelSelect && modelInfoText) {
                modelSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'all') {
                        modelInfoText.textContent = 'Multimodal: 5 títulos de cada IA (total: 15)';
                        modelInfoText.classList.add('text-amber-400');
                    } else {
                        modelInfoText.textContent = 'Modo único: 5 títulos';
                        modelInfoText.classList.remove('text-amber-400');
                    }
                });
            }
            

            async function handleTitleAnalysis(event) {
                if (event) event.preventDefault();
                
                const videoUrl = document.getElementById('video-url').value;
                const model = document.getElementById('model-select').value;
                const folderId = folderSelect.value;
                
                if (loadingSpinner) loadingSpinner.style.display = 'flex';
                if (resultadosDiv) {
                    resultadosDiv.style.display = 'none';
                    resultadosDiv.innerHTML = '';
                }
                if (thumbGeneratorDiv) thumbGeneratorDiv.style.display = 'none';
                if (thumbResultadosDiv) {
                    thumbResultadosDiv.style.display = 'none';
                    thumbResultadosDiv.innerHTML = '';
                }
                if (errorBox) errorBox.style.display = 'none'; 
                setButtonLoading(analisarButton, true);
                
                currentAnalysisData = {};

                try {
                    console.log('Iniciando análise...', { API_BASE, videoUrl, model, folderId });
                    
                    // Extrair videoId ANTES de qualquer requisição
                    let videoId;
                    try {
                        videoId = videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)?.[1];
                        if (!videoId) {
                            throw new Error('URL do YouTube inválida. Use o formato: https://www.youtube.com/watch?v=...');
                        }
                        console.log('[Title Analysis] VideoId extraído:', videoId);
                    } catch (err) {
                        throw new Error('Não foi possível extrair o ID do vídeo da URL fornecida.');
                    }
                    
                    // Verificar se laozhang.ai está configurada como padrão
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Title Analysis] Erro ao verificar configuração laozhang.ai:', err);
                    }
                    
                    // Validar e normalizar o modelo selecionado
                    const modelIsString = typeof model === 'string';
                    const normalizedModel = modelIsString ? model.trim() : '';
                    
                    // IMPORTANTE: Modo multimodal (all) NUNCA usa laozhang diretamente
                    // porque laozhang não tem um modelo "all" - precisa de 3 requisições separadas
                    // A rota /api/analyze/titles já tem a lógica correta para isso
                    const isMultimodal = model === 'all';
                    const endpoint = (!isMultimodal && useLaozhang) ? '/api/analyze/titles/laozhang' : '/api/analyze/titles';
                    console.log(`[Title Analysis] Usando endpoint: ${endpoint} (laozhang: ${useLaozhang}, multimodal: ${isMultimodal})`);
                    
                    // Uma única requisição: se model === 'all', o backend retorna os 3 modelos (15 títulos)
                    const requestModel = isMultimodal ? 'all' : normalizedModel;
                    const language = document.getElementById('language-select')?.value || 'Português';
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}` 
                        },
                        body: JSON.stringify({ 
                            videoUrl, 
                            model: requestModel,
                            folderId: folderId || null,
                            language
                        })
                    });
                    
                    // Ler o texto da resposta uma única vez
                    const text = await response.text();
                    console.log('Resposta recebida:', { status: response.status, ok: response.ok, textLength: text.length });
                    
                    // Verificar se há conteúdo
                    if (!text || text.trim() === '') {
                        throw new Error('O servidor retornou uma resposta vazia. Verifique se o servidor está funcionando corretamente.');
                    }
                    
                    // Verificar se a resposta é JSON antes de tentar parsear
                    const contentType = response.headers.get('content-type');
                    let data;
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            data = JSON.parse(text);
                        } catch (parseError) {
                            console.error('Erro ao parsear JSON:', parseError, 'Texto recebido:', text.substring(0, 500));
                            throw new Error('Erro ao processar resposta do servidor. Verifique se o servidor está funcionando corretamente.');
                        }
                    } else {
                        throw new Error(`Erro no servidor: ${text.substring(0, 200)}`);
                    }
                    
                    if (!response.ok) {
                        throw new Error(data.msg || 'Erro desconhecido no servidor.');
                    }
                    
                    // Verificar se os dados estão completos antes de processar
                    if (!data.videoDetails) {
                        throw new Error('Resposta do servidor incompleta: videoDetails não encontrado.');
                    }
                    
                    // Garantir que as propriedades de receita existem
                    if (typeof data.videoDetails.estimatedRevenueUSD === 'undefined') {
                        console.warn('[Frontend] estimatedRevenueUSD não encontrado, usando valor padrão');
                        data.videoDetails.estimatedRevenueUSD = 0;
                    }
                    if (typeof data.videoDetails.estimatedRevenueBRL === 'undefined') {
                        data.videoDetails.estimatedRevenueBRL = 0;
                    }
                    if (typeof data.videoDetails.rpmUSD === 'undefined') {
                        data.videoDetails.rpmUSD = 2.0;
                    }
                    if (typeof data.videoDetails.rpmBRL === 'undefined') {
                        data.videoDetails.rpmBRL = 11.0;
                    }
                    
                    console.log('[Frontend] Dados recebidos:', {
                        hasVideoDetails: !!data.videoDetails,
                        hasEstimatedRevenueUSD: typeof data.videoDetails.estimatedRevenueUSD !== 'undefined',
                        estimatedRevenueUSD: data.videoDetails.estimatedRevenueUSD,
                        hasTitulos: !!data.titulosSugeridos,
                        titulosCount: data.titulosSugeridos?.length || 0
                    });
                    
                    currentAnalysisData = {
                        videoId: data.videoDetails.videoId,
                        niche: data.niche,
                        subniche: data.subniche,
                        model: model, 
                        generatedTitles: data.titulosSugeridos
                    };

                    // Salvar títulos gerados na biblioteca
                    await saveTitlesToLibrary(data.titulosSugeridos, {
                        niche: data.niche,
                        subniche: data.subniche,
                        views: data.videoDetails?.views || null,
                        formula: data.analiseOriginal?.formulaTitulo || null
                    });

                    populateAnalysisResults(data, videoUrl);

                    if (data.folderId) {
                        const folderName = userFolders.find(f => f.id == data.folderId)?.name || 'pasta selecionada';
                        showMessage('analisador-success-message', `Análise salva com sucesso na pasta: <strong>${folderName}</strong>`);
                    }
                    // Atualizar dashboard se estiver visível
                    refreshDashboardIfVisible();

                } catch (error) {
                    console.error('Erro ao analisar vídeo:', error);
                    
                    let errorMessage = 'Erro desconhecido ao analisar o vídeo.';
                    
                    // Tratar diferentes tipos de erro
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.name === 'TypeError') {
                        errorMessage = 'Não foi possível conectar ao servidor. Verifique se o servidor está rodando na porta 5001. Abra o terminal e execute: cd Backend && node server.js';
                    } else if (error.message.includes('inválido') || error.message.includes('expirado') || error.message.includes('configurada')) {
                        errorMessage = error.message;
                        setTimeout(() => navigateToView('configuracoes'), 2000);
                    } else if (error.message.includes('Resource exhausted') || error.message.includes('429')) {
                        errorMessage = 'Limite de requisições atingido para a API. Aguarde alguns minutos ou use outro modelo de IA (Claude ou OpenAI).';
                    } else if (error.message.includes('401') || error.message.includes('403')) {
                        errorMessage = 'Erro de autenticação. Faça login novamente.';
                        setTimeout(() => {
                            localStorage.removeItem('core_token');
                            window.location.href = 'la-casa-dark-core-auth.html';
                        }, 2000);
                    } else {
                        errorMessage = `Falha na análise: ${error.message}`;
                    }
                    
                    if (errorBox) {
                        errorBox.innerText = errorMessage;
                        errorBox.style.display = 'block';
                    }
                } finally {
                    if (loadingSpinner) loadingSpinner.style.display = 'none';
                    setButtonLoading(analisarButton, false);
                }
            }
            
            function populateAnalysisResults(data, videoUrl) {
                try {
                    if (!resultadosDiv) {
                        console.error('[Frontend] resultadosDiv não encontrado');
                        return;
                    }
                    
                    if (!data || !data.videoDetails) {
                        throw new Error('Dados incompletos: videoDetails não encontrado');
                    }
                    
                    resultadosDiv.style.display = 'block';
                    
                    document.getElementById('video-url').value = videoUrl || data.originalVideoUrl || '';
                    
                    // Garantir que todas as propriedades existem antes de usar
                    const videoDetails = data.videoDetails || {};
                    const views = videoDetails.views || 0;
                    const comments = videoDetails.comments || 0;
                    const days = videoDetails.days || 0;
                    const title = videoDetails.title || 'Sem título';
                    const originalTitle = videoDetails.originalTitle || videoDetails.title || 'Sem título';
                    const thumbnailUrl = videoDetails.thumbnailUrl || '';
                    const translatedTitle = videoDetails.translatedTitle || '';
                    
                    // Extrair valores de receita e RPM de forma segura
                    const revenueUSD = videoDetails.estimatedRevenueUSD || 0;
                    const revenueBRL = videoDetails.estimatedRevenueBRL || 0;
                    const rpmUSD = videoDetails.rpmUSD || 0;
                    const rpmBRL = videoDetails.rpmBRL || 0;
                    
                    const viewsFormatted = new Intl.NumberFormat('pt-BR').format(views);
                    const commentsFormatted = new Intl.NumberFormat('pt-BR').format(comments);
                    
                    let videoSummaryHtml = `
                        <div class="flex flex-col md:flex-row items-start space-y-4 md:space-y-0 md:space-x-6 mb-6 bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <img src="${thumbnailUrl}" alt="Thumbnail do vídeo" class="w-full md:w-48 rounded-lg object-cover">
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-white mb-2">${title}</h3>
                                ${translatedTitle ? `
                                <p class="text-base text-gray-400 mb-3 italic">${translatedTitle}</p>
                                ` : ''}
                                <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-300">
                                    <span class="flex items-center space-x-1.5">
                                        <i data-lucide="eye" class="w-4 h-4 text-amber-500"></i>
                                        <span>${viewsFormatted} views</span>
                                    </span>
                                    <span class="flex items-center space-x-1.5">
                                        <i data-lucide="calendar-days" class="w-4 h-4 text-amber-500"></i>
                                        <span>${days} dias</span>
                                    </span>
                                    <span class="flex items-center space-x-1.5">
                                        <i data-lucide="message-square" class="w-4 h-4 text-amber-500"></i>
                                        <span>${commentsFormatted} comentários</span>
                                    </span>
                                </div>
                                <div class="bg-gray-900/50 p-3 rounded-lg mb-3 border border-gray-700">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                        <div>
                                            <span class="text-gray-400 block mb-1">Receita Estimada:</span>
                                            ${revenueUSD > 0 ? `<span class="text-yellow-400 font-semibold">$${Math.round(revenueUSD)}</span>` : '<span class="text-gray-500">N/A</span>'}
                                            ${revenueBRL > 0 ? `<span class="text-yellow-300 block">R$ ${Math.round(revenueBRL)}</span>` : ''}
                                        </div>
                                        <div>
                                            <span class="text-gray-400 block mb-1">RPM (por 1K views):</span>
                                            ${rpmUSD > 0 ? `<span class="text-green-400 font-semibold">$${rpmUSD.toFixed(2)}</span>` : '<span class="text-gray-500">N/A</span>'}
                                            ${rpmBRL > 0 ? `<span class="text-green-300 block">R$ ${rpmBRL.toFixed(2)}</span>` : ''}
                                        </div>
                                    </div>
                                    ${data.niche ? `<p class="text-gray-500 text-xs mt-2">* Valores baseados no nicho "${data.niche}"</p>` : ''}
                                </div>
                                <div class="flex flex-wrap gap-2 mt-4">
                                    <button id="btn-download-thumb" data-url="${thumbnailUrl}" data-title="${originalTitle}" class="py-1 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white text-xs">
                                        <i data-lucide="download" class="w-4 h-4 mr-1.5"></i>
                                        Baixar Thumbnail Original
                                    </button>
                                    <button id="btn-load-transcript" class="py-1 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black text-xs">
                                        <i data-lucide="file-text" class="w-4 h-4 mr-1.5"></i>
                                        Carregar Transcrição
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    let nicheHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="niche-tag flex justify-between items-center">
                                <div>
                                    <strong>Nicho Detetado</strong>
                                    <span id="detected-niche">${data.niche || 'N/A'}</span>
                                </div>
                                <button title="Copiar Nicho" class="btn-copy p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${data.niche || ''}">
                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                            <div class="niche-tag flex justify-between items-center">
                                <div>
                                    <strong>Subnicho Detetado</strong>
                                    <span id="detected-subniche">${data.subniche || 'N/A'}</span>
                                </div>
                                <button title="Copiar Subnicho" class="btn-copy p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${data.subniche || ''}">
                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-6">
                            <h4 class="text-lg font-semibold text-white mb-2">Análise do Título Original</h4>
                            <p class="text-sm text-gray-300 mb-2">
                                <strong>Motivo do Sucesso:</strong> ${data.analiseOriginal.motivoSucesso || 'N/A'}
                            </p>
                            <p class="text-sm text-gray-300">
                                <strong>Fórmula:</strong> <code class="text-amber-400">${data.analiseOriginal.formulaTitulo || 'N/A'}</code>
                            </p>
                        </div>

                        <!-- Seção de Transcrição e Agente de Roteiro -->
                        <div id="transcript-section" class="bg-gray-800 p-4 rounded-lg border border-gray-700 mb-6">
                            <div class="mb-4">
                                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                                    <h4 class="text-lg font-semibold text-white">📝 Transcrição Completa do Vídeo</h4>
                                    <span class="text-xs text-gray-400">Cole o roteiro manualmente ou clique em "Carregar Transcrição"</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Assim que o campo estiver preenchido, o botão "Criar Agente de Roteiro" será liberado automaticamente.</p>
                            </div>
                            <div id="transcript-container">
                                <textarea id="full-transcript-text" class="w-full min-h-[500px] max-h-[700px] px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 text-sm resize-y" placeholder="Cole aqui a transcrição completa do vídeo ou aguarde o carregamento automático."></textarea>
                                <p class="text-xs text-gray-500 mt-2">Você pode colar manualmente o roteiro completo, colar direto da área de transferência ou utilizar o botão de transcrição automática após analisar o vídeo.</p>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    <button id="btn-paste-transcript" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="clipboard-paste" class="w-4 h-4"></i>
                                        <span>Colar do Clipboard</span>
                                    </button>
                                    <button id="btn-copy-transcript" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                        <span>Copiar Transcrição</span>
                                    </button>
                                    <button id="btn-clear-transcript" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="eraser" class="w-4 h-4"></i>
                                        <span>Limpar Campo</span>
                                    </button>
                                    <button id="btn-analyze-transcript" class="py-2 px-4 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold text-sm flex items-center space-x-2">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                                        <span>Analisar Fórmula Viral</span>
                                    </button>
                                    <button id="btn-create-agent" class="py-2 px-4 rounded-lg bg-green-600 hover:bg-green-500 text-white font-semibold text-sm flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        <span>Criar Agente de Roteiro</span>
                                    </button>
                                </div>
                                <div id="transcript-insights-panel" class="mt-5 bg-gray-900/60 border border-gray-800 rounded-lg p-4">
                                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                                        <div>
                                            <h5 class="text-base font-semibold text-white">Fórmula de Sucesso Detectada</h5>
                                    <p id="transcript-insights-status" class="text-xs text-gray-400">1) Cole ou carregue o roteiro. 2) Clique em “Analisar Fórmula Viral”.</p>
                                        </div>
                                    </div>
                                    <div id="transcript-insights-loading" class="hidden text-sm text-amber-400 mt-3">
                                        <div class="flex items-center space-x-2">
                                            <div class="loader w-4 h-4 border-2 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
                                            <span>A IA está estudando o roteiro completo...</span>
                                        </div>
                                    </div>
                                    <div id="transcript-insights-error" class="hidden text-sm text-red-400 mt-3"></div>
                                    <div id="transcript-insights-content" class="hidden mt-4 space-y-4 text-sm text-gray-100"></div>
                                </div>
                            </div>
                            <div id="transcript-loading" class="text-center py-4 hidden">
                                <p class="text-amber-400 text-sm mb-3 font-semibold">Transcrevendo vídeo em tempo real...</p>
                                <div class="w-full bg-gray-800/70 h-3 rounded-full overflow-hidden">
                                    <div id="transcript-progress-bar" class="bg-amber-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="transcript-progress-text" class="text-xs text-gray-400 mt-2">Preparando download do áudio...</p>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Títulos Gerados ${data.modelUsed && data.modelUsed.includes('Comparação') ? '<span class="text-amber-400">(Comparação Multimodal - 3 Modelos)</span>' : `(Modelo: ${formatModelNameForDisplay(data.modelUsed || 'GPT-4o')})`}</h3>
                            <button type="button" id="btn-generate-more-titles" class="py-1 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white text-xs">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-1.5"></i>
                                <span>Gerar Mais Títulos</span>
                                <div class="btn-spinner hidden"></div>
                            </button>
                        </div>
                    `;
                    
                    let titlesHtml = '<ul id="generated-titles-list" class="space-y-4">';
                    
                    // Verificar se thumbTitleSelect existe antes de usar (pode não existir quando carregado do histórico)
                    if (thumbTitleSelect) {
                    thumbTitleSelect.innerHTML = '';
                    }
                    
                    // Log para debug: verificar quantos títulos serão exibidos
                    console.log(`[Frontend] Exibindo ${data.titulosSugeridos?.length || 0} títulos na interface`);
                    
                    if (!data.titulosSugeridos || data.titulosSugeridos.length === 0) {
                        titlesHtml += '<li class="bg-gray-800 p-4 rounded-lg border border-gray-700 text-gray-400 text-center">Nenhum título encontrado para esta análise.</li>';
                    } else {
                    data.titulosSugeridos.forEach((titleObj, index) => {
                        let scoreColor = 'bg-gray-600 text-gray-200';
                        if (titleObj.pontuacao >= 8) scoreColor = 'bg-green-600 text-green-100';
                        else if (titleObj.pontuacao >= 5) scoreColor = 'bg-yellow-600 text-yellow-100';
                        else if (titleObj.pontuacao > 0) scoreColor = 'bg-red-600 text-red-100';
                        
                        // Remover prefixo do modelo (ex: "[Claude] Título" -> "Título")
                        let cleanTitle = titleObj.titulo.replace(/^\[(?:Gemini|Claude|OpenAI|GPT-4o|Claude 3\.7 Sonnet|Gemini 2\.5 Pro|Laozhang\.ai)\]\s*/i, '');
                        const escapedTitle = cleanTitle.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                        const isCheckedClass = titleObj.is_checked ? 'opacity-60' : '';
                        const isCheckedLabelClass = titleObj.is_checked ? 'line-through' : '';
                        
                        // Formatar nome do modelo para exibição
                        const formatModelNameForDisplay = (model) => {
                            if (!model) return '';
                            const m = String(model).toLowerCase();
                            if (m.includes('gemini')) return 'Gemini';
                            if (m.includes('claude')) return 'Claude';
                            if (m.includes('openai') || m.includes('gpt')) return 'GPT-4o';
                            return model;
                        };

                        titlesHtml += `
                            <li class="bg-gray-800 p-4 rounded-lg border border-gray-700 transition-opacity ${isCheckedClass}">
                                <div class="flex items-center space-x-3 flex-1">
                                    <input type="checkbox" id="check-${index}" class="title-checkbox form-checkbox h-5 w-5 bg-gray-700 border-gray-600 rounded text-amber-600 focus:ring-amber-500" data-title-id="${titleObj.id}" ${titleObj.is_checked ? 'checked' : ''}>
                                    <label for="check-${index}" class="text-gray-100 font-medium transition-all ${isCheckedLabelClass}">
                                        ${titleObj.model ? `<span class="text-amber-500 font-semibold text-xs px-2 py-0.5 bg-amber-500/20 rounded border border-amber-500/30">${formatModelNameForDisplay(titleObj.model)}</span> ` : ''}${cleanTitle}
                                    </label>
                                </div>
                                <div class="flex items-center justify-between mt-2 pl-8">
                                    <p class="text-sm text-gray-400 flex-1">
                                        ${titleObj.explicacao || ''}
                                    </p>
                                    <div class="flex items-center ml-4">
                                        ${titleObj.pontuacao > 0 ? `<span class="text-xs font-bold px-2 py-0.5 rounded-full whitespace-nowrap ${scoreColor}">${titleObj.pontuacao}/10</span>` : ''}
                                        <button title="Copiar Título" class="btn-copy p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${escapedTitle}">
                                            <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                    </div>
                                </div>
                            </li>
                        `;
                        
                        // Adicionar ao select apenas se ele existir (pode não existir quando carregado do histórico)
                        if (thumbTitleSelect) {
                        const option = document.createElement('option');
                        option.value = escapedTitle;
                        option.innerText = escapedTitle;
                        if (titleObj.is_checked) {
                            option.selected = true;
                        }
                        thumbTitleSelect.appendChild(option);
                        }
                    });
                    }
                    titlesHtml += '</ul>';
                    
                    resultadosDiv.innerHTML = videoSummaryHtml + nicheHtml + titlesHtml;
                    resultadosDiv.style.display = 'block'; // Garantir que está visível
                    
                    // Debug: verificar se a seção de transcrição está no HTML
                    console.log('[DEBUG] Seção de transcrição no HTML:', resultadosDiv.innerHTML.includes('Transcrição Completa'));
                    console.log('[DEBUG] Video ID:', data.videoDetails.videoId);
                    console.log('[DEBUG] Tamanho do HTML gerado:', resultadosDiv.innerHTML.length);
                    console.log('[DEBUG] HTML contém "btn-load-transcript":', resultadosDiv.innerHTML.includes('btn-load-transcript'));
                    
                    // Verificar se a seção de transcrição está visível no DOM
                    setTimeout(() => {
                        const transcriptSection = resultadosDiv.querySelector('[id*="transcript"]') || resultadosDiv.querySelector('button[id="btn-load-transcript"]');
                        console.log('[DEBUG] Seção de transcrição encontrada no DOM:', !!transcriptSection);
                        if (!transcriptSection) {
                            console.error('[ERRO] Seção de transcrição NÃO encontrada no DOM após renderização!');
                            console.log('[DEBUG] Primeiros 2000 caracteres do HTML:', resultadosDiv.innerHTML.substring(0, 2000));
                        }
                    }, 200);
                    
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }

                    // Inicializar funcionalidades de transcrição e agente de roteiro
                    // Aguardar um pouco para garantir que o DOM foi atualizado
                    setTimeout(() => {
                        initializeTranscriptAndAgentFeatures(data.videoDetails.videoId, data.videoDetails.title, data.videoDetails.translatedTitle || data.videoDetails.title, data.niche, data.subniche);
                    }, 100);

                    const downloadBtn = document.getElementById('btn-download-thumb');
                    if (downloadBtn) {
                        downloadBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const url = e.currentTarget.getAttribute('data-url');
                            const title = e.currentTarget.getAttribute('data-title');
                            downloadThumbnail(url, title);
                        });
                    }

                    // O botão de transcrição agora é configurado dentro de initializeTranscriptAndAgentFeatures
                    
                    const btnMoreTitles = document.getElementById('btn-generate-more-titles');
                    if (btnMoreTitles) {
                        btnMoreTitles.addEventListener('click', handleTitleAnalysis);
                    }
                    
                    // Inicializar o modelo de IA com o modelo usado na análise (mas permitir mudança)
                    // Verificar se os elementos existem antes de usar (podem não existir quando carregado do histórico)
                    if (thumbModelSelect && data.modelUsed) {
                        // Tentar encontrar o modelo correspondente no dropdown
                        const modelValue = data.modelUsed;
                        // Se o modelo usado for "Comparação", usar modelo padrão
                        if (modelValue.includes('Comparação') || modelValue === 'all') {
                            thumbModelSelect.value = 'claude-3-7-sonnet-20250219';
                        } else {
                            // Tentar encontrar o modelo exato ou usar o primeiro disponível
                            const option = Array.from(thumbModelSelect.options).find(opt => 
                                opt.value === modelValue || 
                                modelValue.includes(opt.value.split('-')[0]) // Ex: "gemini" em "gemini-2.0-flash"
                            );
                            if (option) {
                                thumbModelSelect.value = option.value;
                            }
                        }
                    }
                    
                    if (thumbGeneratorDiv) thumbGeneratorDiv.style.display = 'block';
                } catch (renderError) {
                    console.error('[Frontend] Erro ao renderizar resultados:', renderError);
                    if (errorBox) {
                        errorBox.innerText = `Erro ao exibir resultados: ${renderError.message}. Verifique o console para mais detalhes.`;
                        errorBox.style.display = 'block';
                    }
                    throw renderError; // Re-lançar para ser capturado pelo catch externo
                }
            }

            // Função para inicializar funcionalidades de transcrição e agente de roteiro
            function initializeTranscriptAndAgentFeatures(videoId, videoTitle, translatedTitle, niche, subniche) {
                console.log('[DEBUG] Inicializando funcionalidades de transcrição para videoId:', videoId);
                
                const btnLoadTranscript = document.getElementById('btn-load-transcript');
                const btnCopyTranscript = document.getElementById('btn-copy-transcript');
                const btnCreateAgent = document.getElementById('btn-create-agent');
                const btnAnalyzeTranscript = document.getElementById('btn-analyze-transcript');
                const btnPasteTranscript = document.getElementById('btn-paste-transcript');
                const btnClearTranscript = document.getElementById('btn-clear-transcript');
                const agentFormulaModal = document.getElementById('agent-formula-modal');
                const agentFormulaContent = document.getElementById('agent-formula-content');
                const agentFormulaConfirm = document.getElementById('agent-formula-confirm');
                const agentFormulaCancel = document.getElementById('agent-formula-cancel');
                const agentFormulaClose = document.getElementById('agent-formula-close');
                const transcriptSection = document.getElementById('transcript-section');
                const transcriptContainer = document.getElementById('transcript-container');
                const transcriptLoading = document.getElementById('transcript-loading');
                const transcriptProgressBar = document.getElementById('transcript-progress-bar');
                const transcriptProgressText = document.getElementById('transcript-progress-text');
                const transcriptTextarea = document.getElementById('full-transcript-text');
                const insightsStatus = document.getElementById('transcript-insights-status');
                const insightsContent = document.getElementById('transcript-insights-content');
                const insightsLoading = document.getElementById('transcript-insights-loading');
                const insightsError = document.getElementById('transcript-insights-error');
                const createAgentModal = document.getElementById('create-agent-modal');
                const createAgentForm = document.getElementById('create-agent-form');
                const btnCloseAgentModal = document.getElementById('btn-close-agent-modal');
                const btnCancelAgent = document.getElementById('btn-cancel-agent');
                const btnSubmitAgent = document.getElementById('btn-submit-agent');

                console.log('[DEBUG] Elementos encontrados:', {
                    btnLoadTranscript: !!btnLoadTranscript,
                    btnCopyTranscript: !!btnCopyTranscript,
                    btnCreateAgent: !!btnCreateAgent,
                    transcriptContainer: !!transcriptContainer,
                    createAgentModal: !!createAgentModal
                });

                if (transcriptSection) transcriptSection.style.display = 'block';
                if (transcriptContainer) transcriptContainer.style.display = 'block';

                let currentVideoId = videoId;
                let currentVideoTitle = videoTitle;
                let currentTranslatedTitle = translatedTitle;
                let currentNiche = niche;
                let currentSubniche = subniche;
                let currentViralInsights = null;
                let isAnalyzingViralFormula = false;
                let autoInsightsTriggered = false;
                let hasViralInsights = false;
                let pendingAgentPayload = null;
                let isSubmittingAgent = false;
                let transcriptProgressInterval = null;
                let transcriptProgressValue = 0;
                const MIN_WORDS_FOR_INSIGHTS = 120;

                // ===== FUNÇÕES DE PROGRESSO DO ROTEIRO MOVIDAS PARA ESCOPO GLOBAL (VER LINHA ~7110) =====

                function resetInsightsUI(message = 'Cole ou carregue o roteiro e clique em "Analisar Fórmula Viral".') {
                    currentViralInsights = null;
                    autoInsightsTriggered = false;
                    hasViralInsights = false;
                    if (insightsContent) {
                        insightsContent.innerHTML = '';
                        insightsContent.classList.add('hidden');
                    }
                    if (insightsError) {
                        insightsError.textContent = '';
                        insightsError.classList.add('hidden');
                    }
                    if (insightsStatus && message) {
                        insightsStatus.textContent = message;
                    }
                }

                function renderTranscriptInsights(analysis, provider) {
                    if (!insightsContent || !analysis) return;

                    const motivos = Array.isArray(analysis.motivosVirais) ? analysis.motivosVirais : [];
                    const gatilhos = Array.isArray(analysis.gatilhosEmocionais) ? analysis.gatilhosEmocionais : [];
                    const estrutura = Array.isArray(analysis.estruturaNarrativa) ? analysis.estruturaNarrativa : [];
                    const checklist = Array.isArray(analysis.formulaChecklist) ? analysis.formulaChecklist : [];
                    const sugestoes = Array.isArray(analysis.sugestoesAplicacao) ? analysis.sugestoesAplicacao : [];
                    const alertas = Array.isArray(analysis.alertas) ? analysis.alertas : [];
                    const elementosRetencao = Array.isArray(analysis.elementosRetencao) ? analysis.elementosRetencao : [];
                    const tecnicasViralizacao = Array.isArray(analysis.tecnicasViralizacao) ? analysis.tecnicasViralizacao : [];
                    const pontosClimaticos = Array.isArray(analysis.pontosClimaticos) ? analysis.pontosClimaticos : [];
                    const formulaViral = analysis.formulaViralCompleta || null;
                    const roteiro10 = analysis.roteiro10por10 || null;

                    let html = '';

                    if (analysis.resumo) {
                        html += `<div class="bg-blue-600/20 border border-blue-500/40 rounded-lg p-3 mb-4"><p class="text-gray-200">${analysis.resumo}</p></div>`;
                    }

                    if (motivos.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-amber-400 mb-2">Por que viralizou</h6>
                                <ul class="space-y-2">
                                    ${motivos.map(item => `
                                        <li class="flex items-start space-x-2 bg-gray-800/50 rounded-md p-2">
                                            <i data-lucide="check-circle" class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0"></i>
                                            <span class="text-gray-200">${item}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (estrutura.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-amber-400 mb-2">Estrutura narrativa</h6>
                                <div class="space-y-2">
                                    ${estrutura.map(step => `
                                        <div class="bg-gray-800/70 rounded-md px-3 py-3 border border-gray-700">
                                            <p class="text-xs uppercase text-gray-400 tracking-wide mb-1">${step.tempoAproximado || ''}</p>
                                            <p class="text-sm font-semibold text-white mb-1">${step.etapa || 'Etapa'}</p>
                                            <p class="text-sm text-gray-300 mb-2">${step.descricao || ''}</p>
                                            ${step.elementosVirais && step.elementosVirais.length ? `
                                                <div class="mt-2">
                                                    <p class="text-xs text-amber-400 font-semibold mb-1">Elementos virais:</p>
                                                    <div class="flex flex-wrap gap-1">
                                                        ${step.elementosVirais.map(el => `<span class="px-2 py-0.5 rounded bg-amber-500/20 text-xs text-amber-300">${el}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${step.pontoRetencao ? `<p class="text-xs text-green-400 mt-2"><strong>Retenção:</strong> ${step.pontoRetencao}</p>` : ''}
                                            ${step.melhoriasSugeridas ? `<p class="text-xs text-blue-400 mt-1"><strong>Melhoria:</strong> ${step.melhoriasSugeridas}</p>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (checklist.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-amber-400 mb-2">Checklist da fórmula (ticado pela IA)</h6>
                                <div class="space-y-3">
                                    ${checklist.map(item => {
                                        const statusOk = (item.status || '').toLowerCase() === 'aplicado';
                                        const icon = statusOk ? 'check-circle-2' : 'circle';
                                        const color = statusOk ? 'text-green-400' : 'text-yellow-400';
                                        return `
                                            <div class="flex items-start space-x-3 bg-gray-800/60 rounded-md p-3 border border-gray-700">
                                                <i data-lucide="${icon}" class="w-5 h-5 ${color} mt-0.5 flex-shrink-0"></i>
                                                <div class="flex-1 text-sm text-gray-200">
                                                    <p class="font-semibold text-white mb-1">${item.item || 'Elemento da fórmula'}</p>
                                                    <p class="text-gray-400 text-xs mb-2">${item.porqueFunciona || ''}</p>
                                                    ${item.exemploConcreto ? `<p class="text-gray-300 text-xs mb-2 bg-gray-900/50 rounded p-2"><span class="text-purple-400 font-semibold">Exemplo:</span> ${item.exemploConcreto}</p>` : ''}
                                                    ${item.comoAplicarNoMeuConteudo ? `<p class="text-gray-300 mt-1"><span class="text-amber-400 font-semibold">Como aplicar:</span> ${item.comoAplicarNoMeuConteudo}</p>` : ''}
                                                    ${item.upgradeSugerido ? `<p class="text-green-300 mt-2 bg-green-500/10 rounded p-2"><span class="text-green-400 font-semibold">✨ Upgrade 10/10:</span> ${item.upgradeSugerido}</p>` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (gatilhos.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-amber-400 mb-2">Gatilhos emocionais</h6>
                                <div class="space-y-2">
                                    ${gatilhos.map(trigger => {
                                        if (typeof trigger === 'string') {
                                            return `<span class="px-3 py-1 rounded-full bg-gray-800 text-xs text-gray-200 border border-gray-700">${trigger}</span>`;
                                        } else {
                                            return `
                                                <div class="bg-gray-800/50 rounded-md p-2 border border-gray-700">
                                                    <div class="flex items-center justify-between mb-1">
                                                        <span class="px-3 py-1 rounded-full bg-purple-500/20 text-xs text-purple-300 border border-purple-500/40">${trigger.gatilho || 'Gatilho'}</span>
                                                        <span class="text-xs text-gray-400">${trigger.intensidade || ''}</span>
                                                    </div>
                                                    <p class="text-xs text-gray-300 mb-1"><strong>Momento:</strong> ${trigger.momentoAplicado || ''}</p>
                                                    <p class="text-xs text-amber-300"><strong>Intensificar:</strong> ${trigger.comoIntensificar || ''}</p>
                                                </div>
                                            `;
                                        }
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (elementosRetencao.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-green-400 mb-2">🎯 Elementos de Retenção (Watch Time)</h6>
                                <div class="space-y-2">
                                    ${elementosRetencao.map(elem => `
                                        <div class="bg-green-500/10 border border-green-500/40 rounded-md p-3">
                                            <p class="text-sm font-semibold text-green-300 mb-1">${elem.elemento || ''}</p>
                                            <p class="text-xs text-gray-300 mb-2">${elem.comoFunciona || ''}</p>
                                            <p class="text-xs text-amber-300"><strong>Momento ideal:</strong> ${elem.momentoIdeal || ''}</p>
                                            <p class="text-xs text-green-300 mt-1"><strong>Intensificar:</strong> ${elem.intensificacao || ''}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (tecnicasViralizacao.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-purple-400 mb-2">🚀 Técnicas de Viralização</h6>
                                <div class="space-y-2">
                                    ${tecnicasViralizacao.map(tec => `
                                        <div class="bg-purple-500/10 border border-purple-500/40 rounded-md p-3">
                                            <p class="text-sm font-semibold text-purple-300 mb-1">${tec.tecnica || ''}</p>
                                            <p class="text-xs text-gray-300 mb-2">${tec.descricao || ''}</p>
                                            <p class="text-xs text-amber-300 mb-1"><strong>Aplicação:</strong> ${tec.aplicacao || ''}</p>
                                            <p class="text-xs text-purple-300"><strong>Potencial viral:</strong> ${tec.potencialViral || ''}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (pontosClimaticos.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-red-400 mb-2">⚡ Pontos Climáticos</h6>
                                <div class="space-y-2">
                                    ${pontosClimaticos.map(ponto => `
                                        <div class="bg-red-500/10 border border-red-500/40 rounded-md p-3">
                                            <div class="flex items-center justify-between mb-1">
                                                <p class="text-sm font-semibold text-red-300">${ponto.momento || ''}</p>
                                                <span class="text-xs text-gray-400">${ponto.tempoAproximado || ''}</span>
                                            </div>
                                            <p class="text-xs text-gray-300 mb-1"><strong>Emoção:</strong> ${ponto.impactoEmocional || ''}</p>
                                            <p class="text-xs text-amber-300"><strong>Amplificar:</strong> ${ponto.comoAmplificar || ''}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (formulaViral) {
                        html += `
                            <div class="mb-4 bg-gradient-to-r from-purple-600/20 to-blue-600/20 border border-purple-500/40 rounded-lg p-4">
                                <h6 class="text-sm font-semibold text-purple-300 mb-3">📋 Fórmula Viral Completa</h6>
                                ${formulaViral.introducao ? `
                                    <div class="mb-3 bg-gray-800/50 rounded p-3">
                                        <p class="text-xs font-semibold text-blue-400 mb-2">INTRODUÇÃO (${formulaViral.introducao.tempoIdeal || ''})</p>
                                        <p class="text-xs text-gray-300 mb-1"><strong>Objetivo:</strong> ${formulaViral.introducao.objetivo || ''}</p>
                                        <p class="text-xs text-gray-300 mb-2"><strong>Elementos:</strong> ${Array.isArray(formulaViral.introducao.elementos) ? formulaViral.introducao.elementos.join(', ') : ''}</p>
                                        <p class="text-xs text-amber-300"><strong>Fórmula:</strong> ${formulaViral.introducao.formula || ''}</p>
                                    </div>
                                ` : ''}
                                ${formulaViral.desenvolvimento ? `
                                    <div class="mb-3 bg-gray-800/50 rounded p-3">
                                        <p class="text-xs font-semibold text-green-400 mb-2">DESENVOLVIMENTO</p>
                                        <p class="text-xs text-gray-300 mb-1"><strong>Ritmo:</strong> ${formulaViral.desenvolvimento.ritmo || ''}</p>
                                        <p class="text-xs text-gray-300 mb-2"><strong>Elementos:</strong> ${Array.isArray(formulaViral.desenvolvimento.elementos) ? formulaViral.desenvolvimento.elementos.join(', ') : ''}</p>
                                        <p class="text-xs text-amber-300"><strong>Fórmula:</strong> ${formulaViral.desenvolvimento.formula || ''}</p>
                                    </div>
                                ` : ''}
                                ${formulaViral.climax ? `
                                    <div class="mb-3 bg-gray-800/50 rounded p-3">
                                        <p class="text-xs font-semibold text-red-400 mb-2">CLÍMAX</p>
                                        <p class="text-xs text-gray-300 mb-1"><strong>Intensidade:</strong> ${formulaViral.climax.intensidade || ''}</p>
                                        <p class="text-xs text-gray-300 mb-2"><strong>Elementos:</strong> ${Array.isArray(formulaViral.climax.elementos) ? formulaViral.climax.elementos.join(', ') : ''}</p>
                                        <p class="text-xs text-amber-300"><strong>Fórmula:</strong> ${formulaViral.climax.formula || ''}</p>
                                    </div>
                                ` : ''}
                                ${formulaViral.fechamento ? `
                                    <div class="bg-gray-800/50 rounded p-3">
                                        <p class="text-xs font-semibold text-amber-400 mb-2">FECHAMENTO</p>
                                        <p class="text-xs text-gray-300 mb-1"><strong>CTA:</strong> ${formulaViral.fechamento.cta || ''}</p>
                                        <p class="text-xs text-gray-300 mb-2"><strong>Elementos:</strong> ${Array.isArray(formulaViral.fechamento.elementos) ? formulaViral.fechamento.elementos.join(', ') : ''}</p>
                                        <p class="text-xs text-amber-300"><strong>Fórmula:</strong> ${formulaViral.fechamento.formula || ''}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }

                    if (roteiro10) {
                        html += `
                            <div class="mb-4 bg-gradient-to-r from-amber-600/20 to-yellow-600/20 border border-amber-500/40 rounded-lg p-4">
                                <h6 class="text-sm font-semibold text-amber-300 mb-3">⭐ Roteiro 10/10 - Fórmula Completa</h6>
                                ${roteiro10.caracteristicas && roteiro10.caracteristicas.length ? `
                                    <div class="mb-3">
                                        <p class="text-xs font-semibold text-amber-400 mb-1">Características:</p>
                                        <ul class="list-disc pl-5 space-y-1">
                                            ${roteiro10.caracteristicas.map(c => `<li class="text-xs text-gray-300">${c}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${roteiro10.diferenciais && roteiro10.diferenciais.length ? `
                                    <div class="mb-3">
                                        <p class="text-xs font-semibold text-green-400 mb-1">Diferenciais:</p>
                                        <ul class="list-disc pl-5 space-y-1">
                                            ${roteiro10.diferenciais.map(d => `<li class="text-xs text-gray-300">${d}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${roteiro10.formula ? `<p class="text-xs text-amber-300 mb-2"><strong>Fórmula:</strong> ${roteiro10.formula}</p>` : ''}
                                ${roteiro10.checklist && roteiro10.checklist.length ? `
                                    <div class="mt-3">
                                        <p class="text-xs font-semibold text-purple-400 mb-1">Checklist:</p>
                                        <ul class="list-disc pl-5 space-y-1">
                                            ${roteiro10.checklist.map(item => `<li class="text-xs text-gray-300">${item}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }

                    if (analysis.diferencialProposto) {
                        html += `
                            <div class="bg-green-600/20 border border-green-500/40 rounded-lg p-3 mb-4">
                                <p class="text-sm text-green-200"><strong>💎 Diferencial sugerido 10/10:</strong> ${analysis.diferencialProposto}</p>
                            </div>
                        `;
                    }

                    if (sugestoes.length) {
                        html += `
                            <div class="mb-4">
                                <h6 class="text-sm font-semibold text-amber-400 mb-2">Como aplicar no meu roteiro</h6>
                                <ul class="list-disc pl-5 space-y-1 text-gray-300">
                                    ${sugestoes.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    if (alertas.length) {
                        html += `
                            <div class="bg-amber-500/10 border border-amber-500/40 rounded-lg p-3">
                                <h6 class="text-sm font-semibold text-amber-300 mb-1">⚠️ Alertas / pontos de atenção</h6>
                                <ul class="list-disc pl-5 text-sm text-amber-100 space-y-1">
                                    ${alertas.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    insightsContent.innerHTML = html || '<p class="text-gray-400">A IA não conseguiu explicar o motivo do viral. Tente novamente.</p>';
                    insightsContent.classList.remove('hidden');
                    hasViralInsights = true;
                    if (insightsStatus) {
                        insightsStatus.textContent = provider
                            ? 'Fórmula viral completa gerada automaticamente.'
                            : 'Fórmula viral completa gerada automaticamente.';
                    }
                    updateCreateAgentAvailability();
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }

                async function requestTranscriptInsights(triggerSource = 'manual') {
                    if (!transcriptTextarea || !transcriptTextarea.value.trim()) {
                        showCustomModal('Roteiro necessário', 'Cole ou carregue a transcrição completa antes de analisar a fórmula viral.', 'info');
                        return;
                    }

                    const wordCount = transcriptTextarea.value.trim().split(/\s+/).length;
                    if (wordCount < MIN_WORDS_FOR_INSIGHTS) {
                        showCustomModal('Roteiro muito curto', `Precisamos de pelo menos ${MIN_WORDS_FOR_INSIGHTS} palavras para analisar a fórmula do vídeo.`, 'info');
                        return;
                    }

                    if (isAnalyzingViralFormula) return;
                    isAnalyzingViralFormula = true;
                    if (insightsLoading) insightsLoading.classList.remove('hidden');
                    if (insightsError) insightsError.classList.add('hidden');
                    if (btnAnalyzeTranscript) btnAnalyzeTranscript.disabled = true;

                    try {
                    // Verificar se laozhang.ai está configurada como padrão
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Transcript Analyze] Erro ao verificar configuração laozhang.ai:', err);
                    }
                    
                    const endpoint = useLaozhang ? '/api/video/transcript/analyze/laozhang' : '/api/video/transcript/analyze';
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                transcript: transcriptTextarea.value.trim(),
                                videoId: currentVideoId,
                                videoTitle: currentVideoTitle,
                                niche: currentNiche,
                                subniche: currentSubniche,
                                generateAgent: true // Gerar agente automaticamente com os 4 passos
                            })
                        });

                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.msg || 'Erro ao analisar o roteiro.');
                        }

                        currentViralInsights = data;
                        // Se o agente foi gerado automaticamente, incluir nos insights
                        if (data.agent) {
                            currentViralInsights.agent = data.agent;
                            currentViralInsights.agentProvider = data.agentProvider;
                        }
                        renderTranscriptInsights(data.analysis, data.provider);
                        autoInsightsTriggered = true;
                    } catch (err) {
                        console.error('Erro ao analisar fórmula viral:', err);
                        if (insightsError) {
                            insightsError.textContent = err.message || 'Erro ao analisar o roteiro.';
                            insightsError.classList.remove('hidden');
                        } else {
                            showCustomModal('Erro', err.message || 'Erro ao analisar o roteiro.', 'error');
                        }
                    } finally {
                        isAnalyzingViralFormula = false;
                        if (insightsLoading) insightsLoading.classList.add('hidden');
                        if (btnAnalyzeTranscript) btnAnalyzeTranscript.disabled = false;
                    }
                }

                function autoAnalyzeIfPossible() {
                    if (autoInsightsTriggered) return;
                    if (!transcriptTextarea || !transcriptTextarea.value.trim()) return;
                    const wordCount = transcriptTextarea.value.trim().split(/\s+/).length;
                    if (wordCount < MIN_WORDS_FOR_INSIGHTS) return;
                    autoInsightsTriggered = true;
                    requestTranscriptInsights('auto');
                }

                resetInsightsUI();

                const hasTranscriptContent = () => {
                    return transcriptTextarea && transcriptTextarea.value.trim().length > 0;
                };

                const updateCreateAgentAvailability = () => {
                    if (!btnCreateAgent) return;
                    const hasContent = transcriptTextarea && transcriptTextarea.value.trim().length > 0;
                    const ready = hasContent && hasViralInsights;
                    btnCreateAgent.disabled = !ready;
                    btnCreateAgent.classList.toggle('opacity-50', !ready);
                    btnCreateAgent.classList.toggle('cursor-not-allowed', !ready);
                    if (!hasContent) {
                        btnCreateAgent.setAttribute('title', 'Cole ou carregue a transcrição completa para habilitar');
                    } else if (!hasViralInsights) {
                        btnCreateAgent.setAttribute('title', 'Clique em “Analisar Fórmula Viral” para desbloquear o agente.');
                    } else {
                        btnCreateAgent.removeAttribute('title');
                    }
                };

                const setTranscriptLoadingState = (isLoading, status = 'idle') => {
                    if (transcriptLoading) {
                        transcriptLoading.classList.toggle('hidden', !isLoading);
                        transcriptLoading.style.display = isLoading ? 'block' : 'none';
                    }
                    if (transcriptTextarea) {
                        transcriptTextarea.readOnly = isLoading;
                        transcriptTextarea.classList.toggle('opacity-60', isLoading);
                    }
                    
                    if (isLoading) {
                        transcriptProgressValue = 0;
                        if (transcriptProgressBar) transcriptProgressBar.style.width = '5%';
                        if (transcriptProgressText) transcriptProgressText.textContent = 'Preparando áudio e detectando idioma...';
                        if (transcriptProgressInterval) clearInterval(transcriptProgressInterval);
                        transcriptProgressInterval = setInterval(() => {
                            transcriptProgressValue = Math.min(95, transcriptProgressValue + (Math.random() * 10) + 5);
                            if (transcriptProgressBar) transcriptProgressBar.style.width = transcriptProgressValue + '%';
                            if (transcriptProgressText) transcriptProgressText.textContent = `Transcrevendo... ${Math.round(transcriptProgressValue)}%`;
                        }, 700);
                    } else {
                        if (transcriptProgressInterval) {
                            clearInterval(transcriptProgressInterval);
                            transcriptProgressInterval = null;
                        }
                        if (transcriptProgressBar) transcriptProgressBar.style.width = '100%';
                        if (transcriptProgressText) {
                            if (status === 'success') {
                                transcriptProgressText.textContent = 'Transcrição carregada com sucesso!';
                            } else if (status === 'error') {
                                transcriptProgressText.textContent = 'Erro ao transcrever. Tente novamente.';
                            } else {
                                transcriptProgressText.textContent = '';
                            }
                        }
                        setTimeout(() => {
                            if (transcriptLoading) transcriptLoading.style.display = 'none';
                        }, 600);
                    }
                };

                if (transcriptTextarea) {
                    transcriptTextarea.readOnly = false;
                    transcriptTextarea.addEventListener('input', () => {
                        updateCreateAgentAvailability();
                        resetInsightsUI('O roteiro foi atualizado. Clique em “Analisar Fórmula Viral”.');
                    });
                }
                updateCreateAgentAvailability();

                if (agentFormulaCancel) {
                    agentFormulaCancel.addEventListener('click', () => {
                        closeAgentFormulaModal();
                    });
                }

                if (agentFormulaClose) {
                    agentFormulaClose.addEventListener('click', () => {
                        closeAgentFormulaModal();
                    });
                }

                if (agentFormulaConfirm) {
                    agentFormulaConfirm.addEventListener('click', () => {
                        const payload = pendingAgentPayload;
                        closeAgentFormulaModal();
                        submitAgentRequest(payload);
                    });
                }

                function buildAgentFormulaPreview(insights) {
                    if (!insights) return '<p class="text-gray-400">Sem dados suficientes para exibir a fórmula.</p>';
                    const analysis = insights.analysis || insights;
                    const agent = insights.agent || null;
                    let html = '';

                    // Mostrar dados do agente gerado com os 4 passos
                    if (agent) {
                        html += `<div class="bg-amber-600/20 border border-amber-500/40 rounded-lg p-4 mb-4">
                            <h4 class="text-sm font-semibold text-amber-400 mb-2">🤖 Agente Gerado Automaticamente</h4>
                            ${agent.agentName ? `<p class="text-white text-sm mb-2"><strong>Nome:</strong> ${agent.agentName}</p>` : ''}
                            ${agent.agentDescription ? `<p class="text-gray-300 text-sm mb-2">${agent.agentDescription}</p>` : ''}
                        </div>`;
                        
                        if (agent.introduction) {
                            html += `
                                <div class="bg-blue-600/20 border border-blue-500/40 rounded-lg p-3 mb-3">
                                    <h4 class="text-sm font-semibold text-blue-400 mb-2">📝 Introdução (PASSO 2)</h4>
                                    <p class="text-gray-200 text-sm">${agent.introduction}</p>
                                </div>
                            `;
                        }
                        
                        if (agent.subscriptionCTA) {
                            html += `
                                <div class="bg-green-600/20 border border-green-500/40 rounded-lg p-3 mb-3">
                                    <h4 class="text-sm font-semibold text-green-400 mb-2">🔔 CTA de Inscrição (PASSO 3)</h4>
                                    <p class="text-gray-200 text-sm">${agent.subscriptionCTA}</p>
                                </div>
                            `;
                        }
                        
                        if (agent.commentCTA) {
                            html += `
                                <div class="bg-purple-600/20 border border-purple-500/40 rounded-lg p-3 mb-3">
                                    <h4 class="text-sm font-semibold text-purple-400 mb-2">💬 CTA de Comentário (PASSO 4)</h4>
                                    <p class="text-gray-200 text-sm">${agent.commentCTA}</p>
                                </div>
                            `;
                        }
                        
                        if (agent.exampleScript) {
                            html += `
                                <div class="bg-gray-800/70 border border-gray-700 rounded-lg p-3 mb-3">
                                    <h4 class="text-sm font-semibold text-amber-400 mb-2">📄 Exemplo de Roteiro (PASSO 1)</h4>
                                    <p class="text-gray-300 text-xs">${agent.exampleScript.substring(0, 500)}${agent.exampleScript.length > 500 ? '...' : ''}</p>
                                </div>
                            `;
                        }
                    }

                    if (analysis.resumo) {
                        html += `<p class="text-base text-white mb-3">${analysis.resumo}</p>`;
                    }

                    if (Array.isArray(analysis.formulaChecklist) && analysis.formulaChecklist.length) {
                        html += `
                            <div>
                                <h4 class="text-sm font-semibold text-amber-400 mb-2">Checklist replicado</h4>
                                <div class="space-y-2">
                                    ${analysis.formulaChecklist.map(item => `
                                        <div class="bg-gray-800/70 rounded-md p-3">
                                            <p class="text-white font-semibold">${item.item || 'Elemento da fórmula'}</p>
                                            <p class="text-gray-300 text-sm">${item.porqueFunciona || ''}</p>
                                            ${item.comoAplicarNoMeuConteudo ? `<p class="text-gray-200 text-xs mt-1"><span class="text-amber-400 font-semibold">Como aplicar:</span> ${item.comoAplicarNoMeuConteudo}</p>` : ''}
                                            ${item.upgradeSugerido ? `<p class="text-gray-200 text-xs mt-1"><span class="text-amber-400 font-semibold">Upgrade 10/10:</span> ${item.upgradeSugerido}</p>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (Array.isArray(analysis.estruturaNarrativa) && analysis.estruturaNarrativa.length) {
                        html += `
                            <div>
                                <h4 class="text-sm font-semibold text-amber-400 mb-2">Estrutura replicada</h4>
                                <div class="space-y-1">
                                    ${analysis.estruturaNarrativa.map(step => `
                                        <div class="bg-gray-800/50 rounded-md px-3 py-2">
                                            <p class="text-xs uppercase text-gray-400 tracking-wide">${step.tempoAproximado || ''}</p>
                                            <p class="text-white font-semibold text-sm">${step.etapa || ''}</p>
                                            <p class="text-gray-300 text-sm">${step.descricao || ''}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (analysis.diferencialProposto) {
                        html += `
                            <div class="bg-green-600/20 border border-green-500/40 rounded-lg p-3">
                                <p class="text-sm text-green-200"><strong>Diferencial 10/10:</strong> ${analysis.diferencialProposto}</p>
                            </div>
                        `;
                    }

                    if (!html) {
                        html = '<p class="text-gray-400">A IA não retornou detalhes da fórmula.</p>';
                    }
                    return html;
                }

                function openAgentFormulaModal(payload) {
                    if (!agentFormulaModal || !agentFormulaContent) {
                        submitAgentRequest(payload);
                        return;
                    }
                    pendingAgentPayload = payload;
                    agentFormulaContent.innerHTML = buildAgentFormulaPreview(currentViralInsights);
                    agentFormulaModal.style.display = 'flex';
                    agentFormulaModal.classList.remove('hidden');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }

                function closeAgentFormulaModal() {
                    pendingAgentPayload = null;
                    if (agentFormulaModal) {
                        agentFormulaModal.style.display = 'none';
                        agentFormulaModal.classList.add('hidden');
                    }
                }

                async function submitAgentRequest(payload) {
                    if (!payload || isSubmittingAgent) return;
                    isSubmittingAgent = true;
                    
                    // Mostrar modal de loading
                    const loadingModal = document.getElementById('create-agent-loading-modal');
                    const progressBar = document.getElementById('create-agent-progress-bar');
                    const progressText = document.getElementById('create-agent-progress-text');
                    
                    if (loadingModal) {
                        loadingModal.style.display = 'flex';
                        loadingModal.classList.remove('hidden');
                    }
                    
                    // Simular progresso
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress = Math.min(95, progress + Math.random() * 15);
                        if (progressBar) progressBar.style.width = progress + '%';
                        if (progressText) {
                            if (progress < 30) {
                                progressText.textContent = 'Analisando fórmula viral...';
                            } else if (progress < 60) {
                                progressText.textContent = 'Gerando instruções do agente...';
                            } else if (progress < 90) {
                                progressText.textContent = 'Finalizando configuração...';
                            } else {
                                progressText.textContent = 'Quase pronto...';
                            }
                        }
                    }, 300);
                    
                    const spinner = btnSubmitAgent ? btnSubmitAgent.querySelector('.btn-spinner') : null;
                    if (btnSubmitAgent) btnSubmitAgent.disabled = true;
                    if (spinner) spinner.classList.remove('hidden');

                    try {
                        // Verificar se laozhang.ai está configurada como padrão
                        let useLaozhang = false;
                        try {
                            const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            if (settingsResponse.ok) {
                                const settings = await settingsResponse.json();
                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                            }
                        } catch (err) {
                            console.warn('[Create Agent] Erro ao verificar configuração laozhang.ai:', err);
                        }
                        
                        const endpoint = useLaozhang ? '/api/script-agents/create/laozhang' : '/api/script-agents/create';
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.msg || 'Erro ao criar agente.');
                        }

                        const agentData = await response.json();
                        
                        // Fechar modal de loading
                        clearInterval(progressInterval);
                        if (progressBar) progressBar.style.width = '100%';
                        if (progressText) progressText.textContent = 'Concluído!';
                        
                        setTimeout(() => {
                            if (loadingModal) {
                                loadingModal.style.display = 'none';
                                loadingModal.classList.add('hidden');
                            }
                        }, 500);
                        
                        showCustomModal('Agente criado', 'A fórmula foi clonada e aprimorada para o novo agente!', 'success');
                        if (createAgentModal) createAgentModal.style.display = 'none';
                        createAgentForm.reset();

                        if (typeof currentBibliotecaTab !== 'undefined' && currentBibliotecaTab === 'agents') {
                            if (typeof loadBibliotecaAgents === 'function') {
                                loadBibliotecaAgents();
                            }
                        }
                    } catch (err) {
                        console.error('Erro ao criar agente:', err);
                        
                        // Fechar modal de loading em caso de erro
                        if (typeof progressInterval !== 'undefined') clearInterval(progressInterval);
                        const loadingModal = document.getElementById('create-agent-loading-modal');
                        if (loadingModal) {
                            loadingModal.style.display = 'none';
                            loadingModal.classList.add('hidden');
                        }
                        
                        showCustomModal('Erro ao criar agente', err.message || 'Tente novamente.', 'error');
                    } finally {
                        isSubmittingAgent = false;
                        pendingAgentPayload = null;
                        if (btnSubmitAgent) btnSubmitAgent.disabled = false;
                        if (spinner) spinner.classList.add('hidden');
                    }
                }


                // Carregar transcrição
                if (btnLoadTranscript) {
                    btnLoadTranscript.addEventListener('click', async () => {
                        if (!currentVideoId) {
                            alert('ID do vídeo não disponível.');
                            return;
                        }

                        if (hasTranscriptContent()) {
                            const shouldReplace = confirm('Já existe um roteiro/transcrição preenchido manualmente. Deseja substituí-lo pela transcrição automática?');
                            if (!shouldReplace) {
                                return;
                            }
                        }

                        setTranscriptLoadingState(true);
                        btnLoadTranscript.disabled = true;
                        let transcriptLoaded = false;

                        try {
                            // Limpar e validar videoId antes de fazer a requisição
                            const cleanVideoId = String(currentVideoId || '').trim().split(':')[0].split('?')[0].split('#')[0];
                            
                            if (!cleanVideoId || cleanVideoId.length < 10) {
                                throw new Error('ID do vídeo inválido. Certifique-se de que o vídeo foi analisado corretamente.');
                            }
                            
                            console.log('[Transcrição] Carregando transcrição para videoId:', cleanVideoId);
                            
                            const response = await fetch(`${API_BASE}/api/video/transcript/${encodeURIComponent(cleanVideoId)}`, {
                                headers: {
                                    'Authorization': `Bearer ${userToken}`
                                }
                            });

                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                                throw new Error(errorData.msg || `Erro ao carregar transcrição (${response.status})`);
                            }

                            const data = await response.json();
                            if (data.transcript) {
                                transcriptTextarea.value = data.transcript;
                                resetInsightsUI('Gerando checklist automaticamente...');
                                updateCreateAgentAvailability();
                                autoAnalyzeIfPossible();
                                transcriptLoaded = true;
                            } else {
                                alert('Transcrição não disponível para este vídeo.');
                            }
                        } catch (err) {
                            console.error('Erro ao carregar transcrição:', err);
                            alert('Erro ao carregar transcrição: ' + err.message);
                        } finally {
                            setTranscriptLoadingState(false, transcriptLoaded ? 'success' : 'error');
                            btnLoadTranscript.disabled = false;
                        }
                    });
                }

                if (btnPasteTranscript) {
                    if (!(navigator.clipboard && navigator.clipboard.readText)) {
                        btnPasteTranscript.disabled = true;
                        btnPasteTranscript.classList.add('opacity-50', 'cursor-not-allowed');
                        btnPasteTranscript.title = 'Clipboard API não disponível neste navegador. Use Ctrl+V para colar.';
                    } else {
                        btnPasteTranscript.addEventListener('click', async () => {
                            try {
                                const text = await navigator.clipboard.readText();
                                if (!text) {
                                    alert('Não encontramos texto na área de transferência.');
                                    return;
                                }
                                if (transcriptTextarea) {
                                    transcriptTextarea.value = text.trim();
                                    updateCreateAgentAvailability();
                                    resetInsightsUI('Texto colado. Clique em “Analisar Fórmula Viral”.');
                                }
                                alert('Transcrição colada a partir do clipboard!');
                            } catch (clipboardErr) {
                                console.error('Erro ao ler clipboard:', clipboardErr);
                                alert('Não foi possível acessar o clipboard. Cole usando Ctrl+V.');
                            }
                        });
                    }
                }

                if (btnAnalyzeTranscript) {
                    btnAnalyzeTranscript.addEventListener('click', (e) => {
                        e.preventDefault();
                        requestTranscriptInsights('manual');
                    });
                }

                if (btnClearTranscript) {
                    btnClearTranscript.addEventListener('click', () => {
                        if (!transcriptTextarea) return;
                        if (!transcriptTextarea.value.trim().length) {
                            return;
                        }
                        const confirmClear = confirm('Tem certeza de que deseja limpar a transcrição atual?');
                        if (!confirmClear) return;
                        transcriptTextarea.value = '';
                        updateCreateAgentAvailability();
                        resetInsightsUI();
                    });
                }

                // Copiar transcrição
                if (btnCopyTranscript) {
                    btnCopyTranscript.addEventListener('click', async () => {
                        if (!transcriptTextarea || !transcriptTextarea.value.trim()) {
                            alert('Cole ou carregue uma transcrição antes de copiar.');
                            return;
                        }
                        try {
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(transcriptTextarea.value);
                            } else {
                                transcriptTextarea.select();
                                document.execCommand('copy');
                            }
                            alert('Transcrição copiada para a área de transferência!');
                        } catch (copyErr) {
                            console.error('Erro ao copiar transcrição:', copyErr);
                            alert('Não foi possível copiar automaticamente. Selecione e copie manualmente (Ctrl+C).');
                        }
                    });
                }

                // Abrir modal de criação de agente
                if (btnCreateAgent) {
                    btnCreateAgent.addEventListener('click', () => {
                        const hasTranscript = transcriptTextarea && transcriptTextarea.value.trim().length > 0;
                        if (!hasTranscript) {
                            alert('Cole ou carregue a transcrição completa antes de criar o agente.');
                            return;
                        }
                        if (!hasViralInsights) {
                            alert('Antes de criar o agente, clique em “Analisar Fórmula Viral” para que a IA leia o roteiro e gere a estrutura 10/10.');
                            return;
                        }
                        if (createAgentModal) {
                            // Preencher campos do modal com valores atuais
                            const agentNicheInput = document.getElementById('agent-niche-input');
                            const agentSubnicheInput = document.getElementById('agent-subniche-input');
                            const agentManualTranscript = document.getElementById('agent-manual-transcript');
                            
                            if (agentNicheInput) agentNicheInput.value = currentNiche || '';
                            if (agentSubnicheInput) agentSubnicheInput.value = currentSubniche || '';
                            
                            // Preencher transcrição manual com a transcrição carregada (se disponível)
                            if (agentManualTranscript && transcriptTextarea && transcriptTextarea.value) {
                                agentManualTranscript.value = transcriptTextarea.value.trim();
                            }
                            
                            createAgentModal.style.display = 'flex';
                            if (typeof lucide !== 'undefined') {
                                lucide.createIcons();
                            }
                        }
                    });
                }

                // Fechar modal
                if (btnCloseAgentModal) {
                    btnCloseAgentModal.addEventListener('click', () => {
                        if (createAgentModal) createAgentModal.style.display = 'none';
                    });
                }

                if (btnCancelAgent) {
                    btnCancelAgent.addEventListener('click', () => {
                        if (createAgentModal) createAgentModal.style.display = 'none';
                    });
                }

                // Criar agente
                if (createAgentForm) {
                    createAgentForm.addEventListener('submit', async (e) => {
                        e.preventDefault();

                        const agentName = document.getElementById('agent-name-input').value;
                        const agentNiche = document.getElementById('agent-niche-input').value;
                        const agentSubniche = document.getElementById('agent-subniche-input').value;
                        const manualTranscriptField = document.getElementById('agent-manual-transcript');
                        const manualTranscript = manualTranscriptField ? manualTranscriptField.value.trim() : '';

                        if (!agentName) {
                            alert('Por favor, informe o nome do agente.');
                            return;
                        }

                        // Se não houver transcrição manual e não houver transcrição carregada, avisar
                        const transcriptToSend = manualTranscript || (transcriptTextarea ? transcriptTextarea.value.trim() : '');

                        if (!transcriptToSend) {
                            const useManual = confirm('Nenhuma transcrição foi carregada automaticamente e você não forneceu uma transcrição manual. Deseja continuar mesmo assim? O agente será criado sem base de roteiro.');
                            if (!useManual) {
                                return;
                            }
                        }

                        openAgentFormulaModal({
                            videoId: currentVideoId,
                            videoUrl: window.location.href,
                            videoTitle: currentTranslatedTitle || currentVideoTitle,
                            agentName: agentName,
                            niche: agentNiche || currentNiche || null,
                            subniche: agentSubniche || currentSubniche || null,
                            manualTranscript: transcriptToSend || null,
                            viralInsights: currentViralInsights || null
                        });
                    });
                }
            }
            
            if (analisadorForm) {
                analisadorForm.addEventListener('submit', handleTitleAnalysis);
            }

            resultadosDiv.addEventListener('change', async (e) => {
                if (e.target.classList.contains('title-checkbox')) {
                    const checkbox = e.target;
                    const titleId = checkbox.dataset.titleId;
                    const isChecked = checkbox.checked;

                    // Adiciona/remove o estilo visual
                    const listItem = checkbox.closest('li');
                    if (listItem) {
                        listItem.classList.toggle('opacity-60', isChecked);
                        const label = listItem.querySelector('label');
                        if (label) {
                            label.classList.toggle('line-through', isChecked);
                        }
                    }

                    // Atualiza o select se o item for marcado (mas não desatualiza se for desmarcado)
                    if (isChecked) {
                        // Buscar o texto do título - pode estar no label ou no elemento pai
                        const listItem = checkbox.closest('li');
                        let titleText = null;
                        
                        if (listItem) {
                            const label = listItem.querySelector('label');
                        if (label) {
                                titleText = label.innerText.trim();
                            } else {
                                // Se não encontrar label, tentar pegar do próximo elemento
                                const nextElement = checkbox.nextElementSibling;
                                if (nextElement) {
                                    titleText = nextElement.innerText.trim();
                                }
                            }
                        }
                        
                        if (titleText) {
                            // Remover o prefixo do modelo se existir (ex: [Gemini 2.5 Pro] Título)
                            const modelMatch = titleText.match(/^\[.*?\]\s*(.+)$/);
                            if (modelMatch) {
                                titleText = modelMatch[1];
                            }
                            
                            // Atualizar o input do gerador de thumbnails completo
                            const thumbTitleInput = document.getElementById('thumb-title-input');
                            if (thumbTitleInput) {
                                thumbTitleInput.value = titleText;
                                
                                // Garantir que o gerador de thumbnails esteja visível
                                const thumbnailGenerator = document.getElementById('thumbnail-generator');
                                if (thumbnailGenerator) {
                                    thumbnailGenerator.style.display = 'block';
                                    
                                    // Navegar para a view do analisador se não estiver nela
                                    if (document.getElementById('view-analisador')?.style.display === 'none') {
                                        navigateToView('analisador');
                                    }
                                    
                                    // Scroll suave até o gerador após um pequeno delay
                                    setTimeout(() => {
                                        thumbnailGenerator.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                        // Focar no campo de título
                                        thumbTitleInput.focus();
                                    }, 200);
                                }
                                
                                console.log('[Thumbnail] Título preenchido automaticamente no gerador:', titleText);
                            }
                            
                            // Também atualizar o select antigo se existir (para compatibilidade)
                            if (thumbTitleSelect) {
                                // Verificar se o título já existe nas opções
                                let optionExists = false;
                                for (let i = 0; i < thumbTitleSelect.options.length; i++) {
                                    if (thumbTitleSelect.options[i].value === titleText || thumbTitleSelect.options[i].text === titleText) {
                                        thumbTitleSelect.selectedIndex = i;
                                        optionExists = true;
                                        break;
                                    }
                                }
                                
                                // Se não existir, adicionar como nova opção
                                if (!optionExists) {
                                    const newOption = document.createElement('option');
                                    newOption.value = titleText;
                                    newOption.text = titleText;
                                    thumbTitleSelect.appendChild(newOption);
                                    thumbTitleSelect.selectedIndex = thumbTitleSelect.options.length - 1;
                                }
                            }
                        }
                    }

                    // Salvar o estado no backend
                    try {
                        console.log(`[Biblioteca Frontend] Enviando requisição para marcar título ${titleId} como ${isChecked ? 'marcado' : 'desmarcado'}`);
                        const response = await fetch(`${API_BASE}/api/titles/${titleId}/check`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ is_checked: isChecked })
                        });
                        
                        console.log(`[Biblioteca Frontend] Resposta recebida:`, response.status, response.statusText);
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (isChecked) {
                                console.log('[Biblioteca] ✅ Título marcado e salvo na biblioteca');
                                // Mostrar mensagem de sucesso
                                const successMsg = document.getElementById('biblioteca-success-message');
                                if (successMsg) {
                                    successMsg.innerText = 'Título adicionado à biblioteca com sucesso!';
                                    successMsg.style.display = 'block';
                                    setTimeout(() => {
                                        successMsg.style.display = 'none';
                                    }, 3000);
                                }
                                // Se estiver na aba de biblioteca, recarregar
                                if (currentBibliotecaTab === 'titles') {
                                    setTimeout(() => loadBibliotecaTitles(1, currentBibliotecaLimit), 500);
                                }
                            } else {
                                console.log('[Biblioteca] Título desmarcado');
                            }
                            // Atualizar dashboard se visível
                            refreshDashboardIfVisible();
                        } else {
                            const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                            throw new Error(errorData.msg || 'Erro ao salvar título');
                        }
                    } catch (err) {
                        console.error("Falha ao salvar o estado do título:", err);
                        // Opcional: reverter a mudança visual em caso de erro
                        if (listItem) {
                            listItem.classList.toggle('opacity-60', !isChecked);
                            const label = listItem.querySelector('label');
                            if (label) {
                                label.classList.toggle('line-through', !isChecked);
                            }
                        }
                        checkbox.checked = !isChecked;
                    }
                }
            });


            // --- Lógica para Gerar Ideias de Thumbnail ---
            async function handleThumbnailGeneration(e) {
                const btn = e.currentTarget;
                setButtonLoading(btn, true);

                if (!currentAnalysisData.videoId) {
                    alert("Erro: Dados da análise original não encontrados. Por favor, analise o vídeo novamente.");
                    setButtonLoading(btn, false);
                    return;
                }
                
                const selectedTitle = thumbTitleSelect.value;
                const selectedModel = thumbModelSelect.value;
                const language = thumbLanguageSelect.value;
                const includePhrases = thumbPhrasesSelect.value === 'true';
                const style = thumbStyleSelect.value;
                const selectedRule = document.getElementById('thumb-rule-select')?.value || 'auto';
                const useStandardPrompt = document.getElementById('use-standard-prompt')?.checked || false;
                const customPrompt = document.getElementById('thumb-custom-prompt')?.value?.trim() || null;
                const noPhrases = document.getElementById('thumb-no-phrases')?.checked || false;
                const themeDetectionSelect = document.getElementById('theme-detection-select');
                const themeKey = themeDetectionSelect && themeDetectionSelect.value !== 'auto' ? themeDetectionSelect.value : undefined;
                
                // Se checkbox de usar prompt padrão estiver marcado, buscar e usar o prompt padrão
                let finalCustomPrompt = customPrompt;
                if (useStandardPrompt) {
                    try {
                        // Buscar prompt padrão para o nicho/subnicho atual
                        const currentNiche = currentAnalysisData?.niche || null;
                        const currentSubniche = currentAnalysisData?.subniche || null;
                        const currentFolderId = folderSelect?.value || null;
                        
                        let promptUrl = `${API_BASE}/api/thumbnail-style-prompts?`;
                        if (currentNiche) promptUrl += `niche=${encodeURIComponent(currentNiche)}&`;
                        if (currentSubniche) promptUrl += `subniche=${encodeURIComponent(currentSubniche)}&`;
                        if (currentFolderId) promptUrl += `folder_id=${encodeURIComponent(currentFolderId)}&`;
                        
                        console.log('[Thumbnail Gen] Buscando prompt padrão:', {
                            url: promptUrl,
                            niche: currentNiche,
                            subniche: currentSubniche,
                            folderId: currentFolderId
                        });
                        
                        const promptResponse = await fetch(promptUrl, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        
                        if (promptResponse.ok) {
                            const promptData = await promptResponse.json();
                            console.log('[Thumbnail Gen] Resposta do prompt padrão:', promptData);
                            
                            // Verificar se há prompt padrão disponível
                            if (promptData.prompt && promptData.prompt.standard_prompt) {
                                let standardPrompt = promptData.prompt.standard_prompt;
                                console.log('[Thumbnail Gen] Prompt padrão encontrado:', standardPrompt.substring(0, 100) + '...');
                                
                                // Adaptar o prompt padrão ao título selecionado (sem criar prompt novo)
                                if (selectedTitle && selectedTitle.trim()) {
                                    const titleText = selectedTitle.trim();
                                    const replacements = [
                                        /\[\s*T[ÍI]TULO\s*\]/gi,
                                        /\{\s*TITLE\s*\}/gi,
                                        /<\s*TITLE\s*>/gi,
                                        /\{\{\s*title\s*\}\}/gi,
                                        /\[TITLE\]/g
                                    ];
                                    for (const rx of replacements) {
                                        if (rx.test(standardPrompt)) {
                                            standardPrompt = standardPrompt.replace(rx, `"${titleText}"`);
                                        }
                                    }
                                    // Não prefixar "Título:" na descrição; manter o prompt de estilo limpo
                                }
                                
                                // Se houver prompt personalizado, combinar ambos, senão usar só o padrão
                                if (customPrompt && customPrompt.trim()) {
                                    finalCustomPrompt = `${standardPrompt}\n\n${customPrompt}`;
                                    console.log('[Thumbnail Gen] Combinando prompt padrão com prompt personalizado');
                                } else {
                                    finalCustomPrompt = standardPrompt;
                                    console.log('[Thumbnail Gen] Usando APENAS prompt padrão do estilo do canal/nicho');
                                }
                            } else {
                                console.warn('[Thumbnail Gen] Nenhum prompt padrão encontrado para este nicho/subnicho');
                                if (!customPrompt) {
                                    showCustomModal(
                                        '⚠️ Prompt Padrão Não Encontrado',
                                        `Não foi encontrado um prompt padrão para:\n\n` +
                                        `• Nicho: ${currentNiche || 'Não especificado'}\n` +
                                        `• Subnicho: ${currentSubniche || 'Não especificado'}\n\n` +
                                        `💡 Para usar o prompt padrão:\n` +
                                        `1. Adicione thumbnails de referência para este nicho/subnicho\n` +
                                        `2. Clique em "Analisar Estilo e Criar Prompt Padrão"\n` +
                                        `3. Marque o checkbox novamente\n\n` +
                                        `🔄 Continuando sem prompt padrão...`,
                                        'warning'
                                    );
                                }
                            }
                        } else {
                            console.warn('[Thumbnail Gen] Erro ao buscar prompt padrão:', promptResponse.status);
                        }
                    } catch (err) {
                        console.warn('[Thumbnail Gen] Erro ao buscar prompt padrão:', err);
                    }
                }

                if (thumbLoadingSpinner) thumbLoadingSpinner.style.display = 'flex';
                if (thumbResultadosDiv) {
                    thumbResultadosDiv.style.display = 'none';
                    thumbResultadosDiv.innerHTML = '';
                }

                try {
                    // Verificar se laozhang.ai está configurada como padrão
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Thumbnail Analysis] Erro ao verificar configuração laozhang.ai:', err);
                    }
                    
                    const endpoint = useLaozhang ? '/api/analyze/thumbnail/laozhang' : '/api/analyze/thumbnail';
                    
                    // Log para debug
                    console.log('[Thumbnail Gen] Enviando requisição:', {
                        useStandardPrompt,
                        hasCustomPrompt: !!customPrompt,
                        finalCustomPromptLength: finalCustomPrompt ? finalCustomPrompt.length : 0,
                        finalCustomPromptPreview: finalCustomPrompt ? finalCustomPrompt.substring(0, 200) + '...' : 'null',
                        themeKey: themeKey || 'auto (detecção automática pelo título)'
                    });
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            videoId: currentAnalysisData.videoId,
                            selectedTitle: selectedTitle,
                            model: useLaozhang ? null : selectedModel,
                            selectedModel: selectedModel,
                            niche: currentAnalysisData.niche,
                            subniche: currentAnalysisData.subniche,
                            language: language,
                            includePhrases: noPhrases ? false : includePhrases,
                            style: style,
                            thumbnailRule: selectedRule,
                            customPrompt: finalCustomPrompt,
                            theme_key: themeKey,
                            folder_id: folderSelect?.value || null
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro desconhecido');
                    if (!Array.isArray(data) || data.length === 0) throw new Error("A IA não retornou o array de ideias esperado.");

                    if (thumbResultadosDiv) {
                        thumbResultadosDiv.style.display = 'grid';
                        thumbResultadosDiv.innerHTML = '';
                        
                        data.forEach((idea, index) => {
                            const uniqueId = `thumb-idea-${Date.now()}-${index}`;
                            
                            // Garantir que seoTags seja sempre um array
                            const seoTagsArray = Array.isArray(idea.seoTags) ? idea.seoTags : (idea.seoTags ? [idea.seoTags] : []);
                            const tagsString = seoTagsArray.join(', ');
                            
                            // Garantir que frasesDeGancho seja sempre um array
                            const frasesArray = Array.isArray(idea.frasesDeGancho) ? idea.frasesDeGancho : (idea.frasesDeGancho ? [idea.frasesDeGancho] : []);
                            let phrasesOptions = frasesArray.map(phrase => `<option value="${phrase}">${phrase}</option>`).join('');
                            if (!phrasesOptions) {
                                phrasesOptions = '<option value="">Sem frases</option>';
                            }

                            // Buscar dados do contexto atual
                            const currentNiche = currentAnalysisData?.niche || '';
                            const currentSubniche = currentAnalysisData?.subniche || '';
                            const currentStyle = document.getElementById('input-style')?.value || '';

                            const styleLock = 'Keep composition, palette, typography and lighting consistent with channel references. Do not change layout. Maintain gold title at bottom with subtle glow.';
                            let promptForImage = (idea.descricaoThumbnail || '').replace(/\[FRASE DE GANCHO AQUI\]/gi, frasesArray && frasesArray[0] ? frasesArray[0] : '');
                            if (useStandardPrompt) {
                                promptForImage += `\n\n${styleLock}`;
                            }

                            let thumbHtml = `
                                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-4" id="${uniqueId}" data-niche="${currentNiche}" data-subniche="${currentSubniche}" data-style="${currentStyle}">
                                    <h4 class="text-lg font-semibold text-white">Ideia de Thumbnail ${index + 1}</h4>
                                    
                                    <!-- SEO Section -->
                                    <div class="space-y-3">
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="text-sm font-medium text-amber-400">Descrição SEO</label>
                                                <button title="Copiar Descrição" class="btn-copy p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${idea.seoDescription || ''}">
                                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                                </button>
                                            </div>
                                            <textarea readonly class="w-full h-24 text-xs p-2 bg-gray-900 border border-gray-700 rounded-md">${idea.seoDescription || 'N/A'}</textarea>
                                        </div>
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                                <label class="text-sm font-medium text-amber-400">Tags</label>
                                                <button title="Copiar Tags" class="btn-copy p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${tagsString}">
                                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                                </button>
                                            </div>
                                            <p class="text-xs p-2 bg-gray-900 border border-gray-700 rounded-md">${tagsString || 'N/A'}</p>
                                        </div>
                                    </div>
                                    
                                    <hr class="border-gray-700">

                                    <!-- Image Generation Section -->
                                    <div class="space-y-3">
                                        <div>
                                            <label for="hook-select-${uniqueId}" class="text-sm font-medium text-amber-400">Frase de Gancho</label>
                                            <select id="hook-select-${uniqueId}" class="hook-phrase-select styled-select w-full mt-1 px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-sm">
                                                ${phrasesOptions}
                                            </select>
                                        </div>
                                        <div>
                                            <div class="flex justify-between items-center mb-1">
                                            <label class="text-sm font-medium text-amber-400">Descrição para IA de Imagem</label>
                                                <button title="Copiar Prompt" class="btn-copy-prompt p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-prompt-text="${promptForImage}">
                                                    <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                                </button>
                                            </div>
                                            <p class="image-prompt-text text-sm text-gray-300 mt-1 p-2 bg-gray-900 border border-gray-700 rounded-md whitespace-pre-wrap" data-original-prompt="${promptForImage}">${promptForImage}</p>
                                        </div>
                                    </div>

                                    <button type="button" class="btn-gen-imagefx mt-4 py-2 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-gray-700 hover:bg-gray-600 text-white text-sm w-full" data-prompt="${promptForImage}" data-using-standard="${useStandardPrompt ? 'true' : 'false'}">
                                        <span class="btn-text">Gerar Imagem com ImageFX</span>
                                        <div class="btn-spinner hidden"></div>
                                    </button>
                                    
                                    <div class="imagefx-loading mt-4 flex-col items-center justify-center" style="display: none;">
                                        <div class="loader !w-20 !h-20"></div>
                                    </div>
                                    <div class="imagefx-result mt-4" style="display: none;"></div>
                                </div>
                            `;
                            thumbResultadosDiv.innerHTML += thumbHtml;
                        });
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }

                } catch (err) {
                    console.error("Erro ao gerar ideias de thumb:", err);
                    if (thumbResultadosDiv) {
                        thumbResultadosDiv.innerHTML = `<div class="error-message md:col-span-2" style="display: block;">Falha ao gerar ideias: ${err.message}</div>`;
                        thumbResultadosDiv.style.display = 'block';
                    }
                } finally {
                    if (thumbLoadingSpinner) thumbLoadingSpinner.style.display = 'none';
                    setButtonLoading(btn, false);
                }
            }
            
            // Novo gerador completo e sincronizado
            document.getElementById('btn-generate-complete-thumbnail')?.addEventListener('click', async () => {
                const titleInput = document.getElementById('thumb-title-input');
                const languageSelect = document.getElementById('thumb-language-simple');
                const styleSelect = document.getElementById('thumb-style-simple');
                const resultsDiv = document.getElementById('complete-thumbnail-results');
                const btn = document.getElementById('btn-generate-complete-thumbnail');
                
                if (!titleInput || !titleInput.value.trim()) {
                    showCustomModal('Título Obrigatório', 'Por favor, digite o título do vídeo para gerar a thumbnail completa.', 'warning');
                    return;
                }
                
                const title = titleInput.value.trim();
                const language = languageSelect?.value || 'pt-BR';
                const style = styleSelect?.value || 'photorealistic';
                const aiModelSelect = document.getElementById('thumb-ai-model-simple');
                const aiModel = aiModelSelect?.value || 'gpt-4o';
                const token = safeLocalStorageGet('core_token') || localStorage.getItem('core_token');
                const currentNiche = currentAnalysisData?.niche || null;
                const currentSubniche = currentAnalysisData?.subniche || null;
                const folderSelectElement = document.getElementById('folder-select');
                let folderId = folderSelectElement?.value || null;
                // Converter string vazia para null e garantir que seja número se não for null
                if (folderId === '' || folderId === '0' || folderId === 0) {
                    folderId = null;
                } else if (folderId) {
                    folderId = parseInt(folderId, 10);
                    if (isNaN(folderId)) folderId = null;
                }
                
                const promptVariantSelect = document.getElementById('thumb-prompt-variant-simple');
                const promptVariant = promptVariantSelect ? parseInt(promptVariantSelect.value, 10) : 1;
                
                console.log('[Thumbnail Complete] Dados enviados:', {
                    title,
                    niche: currentNiche,
                    subniche: currentSubniche,
                    folder_id: folderId,
                    language,
                    style,
                    ai_model: aiModel,
                    prompt_variant: promptVariant
                });
                
                if (!resultsDiv) {
                    console.error('[Thumbnail Complete] Área de resultados não encontrada');
                    return;
                }
                
                setButtonLoading(btn, true);
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
                
                try {
                    showLoadingModal('Gerando thumbnail completa com headline, SEO e tags...', 'image');
                    
                    const resp = await fetch(`${API_BASE}/api/generate/thumbnail/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ 
                            title, 
                            niche: currentNiche, 
                            subniche: currentSubniche, 
                            folder_id: folderId, 
                            language, 
                            style, 
                            ai_model: aiModel,
                            prompt_variant: promptVariant,
                            variations: 2 
                        })
                    });
                    
                    const data = await resp.json();
                    document.getElementById('generic-loading-modal')?.remove();
                    
                    if (!resp.ok) throw new Error(data.msg || 'Erro ao gerar thumbnail completa');
                    
                    if (!data.images || data.images.length === 0) {
                        showCustomModal('Aviso', 'Nenhuma imagem foi gerada.', 'warning');
                        return;
                    }
                    
                    // Exibir resultados completos
                    resultsDiv.innerHTML = data.images.map((imgObj, i) => `
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 space-y-4">
                            <h4 class="text-lg font-semibold text-white">Variação ${i + 1}</h4>
                            
                            <!-- Thumbnail Gerada -->
                            <div>
                                <img src="${imgObj.imageUrl}" alt="Thumbnail gerada" class="rounded-lg w-full mb-3" style="max-height: 400px; object-fit: contain;">
                                <div class="flex gap-2">
                                    <a download="thumbnail-${i + 1}.png" href="${imgObj.imageUrl}" class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-500 text-black rounded-lg text-sm font-semibold text-center">
                                        <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                        Baixar Imagem
                                    </a>
                                    <span class="px-4 py-2 rounded-lg text-sm ${imgObj.savedToLibrary ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-200'}">
                                        ${imgObj.savedToLibrary ? '✅ Salvo!' : 'Não salvo'}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Headline de Impacto -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-amber-400">📢 Headline de Impacto</label>
                                    <button title="Copiar Headline" class="btn-copy p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${imgObj.headline || imgObj.headlineText || ''}">
                                        <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                    </button>
                                </div>
                                <div class="px-4 py-3 bg-gray-900 border border-amber-700/50 rounded-lg">
                                    <p class="text-lg font-bold text-amber-300">${imgObj.headline || imgObj.headlineText || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <!-- Descrição SEO -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-amber-400">🔍 Descrição SEO</label>
                                    <button title="Copiar Descrição SEO" class="btn-copy p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${imgObj.seoDescription || ''}">
                                        <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                    </button>
                                </div>
                                <textarea readonly class="w-full h-24 text-sm p-3 bg-gray-900 border border-gray-700 rounded-lg text-gray-200 resize-none">${imgObj.seoDescription || 'N/A'}</textarea>
                            </div>
                            
                            <!-- Tags -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-amber-400">🏷️ Tags Principais</label>
                                    <button title="Copiar Tags" class="btn-copy p-1 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-500" data-copy-text="${Array.isArray(imgObj.tags) ? imgObj.tags.join(', ') : (imgObj.tags || '')}">
                                        <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                                    </button>
                                </div>
                                <div class="px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg">
                                    <p class="text-sm text-gray-300">${Array.isArray(imgObj.tags) ? imgObj.tags.join(', ') : (imgObj.tags || 'N/A')}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    resultsDiv.style.display = 'grid';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Adicionar listeners para botões de copiar
                    resultsDiv.querySelectorAll('.btn-copy').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const text = btn.getAttribute('data-copy-text');
                            if (text) {
                                navigator.clipboard.writeText(text).then(() => {
                                    const originalHTML = btn.innerHTML;
                                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 pointer-events-none text-green-500"></i>';
                                    btn.classList.add('text-green-500');
                                    setTimeout(() => {
                                        btn.innerHTML = originalHTML;
                                        btn.classList.remove('text-green-500');
                                        if (typeof lucide !== 'undefined') lucide.createIcons();
                                    }, 2000);
                                }).catch(err => {
                                    console.error('Erro ao copiar:', err);
                                    alert('Erro ao copiar. Tente selecionar o texto manualmente.');
                                });
                            }
                        });
                    });
                    
                } catch (err) {
                    document.getElementById('generic-loading-modal')?.remove();
                    console.error('[Thumbnail Complete] Erro:', err);
                    showCustomModal('Erro', err.message || 'Falha ao gerar thumbnail completa.', 'error');
                } finally {
                    setButtonLoading(btn, false);
                }
            });
            
            document.getElementById('btn-generate-by-title-integrated')?.addEventListener('click', async () => {
                const title = thumbTitleSelect?.value || '';
                if (!title || !title.trim()) { showCustomModal('Título obrigatório', 'Selecione ou digite o título no Gerador.', 'info'); return; }
                const languageText = thumbLanguageSelect?.value || 'Português';
                const langMap = { 'Português': 'pt-BR', 'Espanhol': 'es-ES', 'Inglês': 'en-US' };
                const languageCode = langMap[languageText] || 'pt-BR';
                const artStyle = thumbStyleSelect?.value || 'photorealistic';
                const token = safeLocalStorageGet('core_token') || localStorage.getItem('core_token');
                const currentNiche = currentAnalysisData?.niche || null;
                const currentSubniche = currentAnalysisData?.subniche || null;
                const folderId = document.getElementById('folder-select')?.value || null;
                const themeKey = themeDetectionSelect && themeDetectionSelect.value !== 'auto' ? themeDetectionSelect.value : undefined;
                const panel = document.getElementById('gen-by-title-results');
                try {
                    if (panel) { panel.style.display = 'none'; panel.innerHTML = ''; }
                    showLoadingModal('Gerando por título com estilo travado...', 'image');
                    const resp = await fetch(`${API_BASE}/api/generate/imagefx/by-title`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ title, niche: currentNiche, subniche: currentSubniche, folder_id: folderId, language: languageCode, style: artStyle, variations: 2, prompt_ai: 'none', theme_key: themeKey })
                    });
                    const data = await resp.json();
                    document.getElementById('generic-loading-modal')?.remove();
                    if (!resp.ok) throw new Error(data.msg || 'Falha ao gerar por título');
                    const imgs = Array.isArray(data.images) ? data.images : [];
                    if (imgs.length === 0) { showCustomModal('Aviso', 'Nenhuma imagem retornada.', 'warning'); return; }
                    if (panel) {
                        panel.innerHTML = imgs.map((obj, i) => `
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                                <p class="text-xs text-gray-400 mb-2">Variação ${i + 1}</p>
                                <img src="${obj.imageUrl}" class="rounded-lg w-full mb-3" style="max-height: 380px; object-fit: contain;">
                                <div class="flex gap-2">
                                    <a download="thumb-${i + 1}.png" href="${obj.imageUrl}" class="px-3 py-2 bg-amber-600 hover:bg-amber-500 text-black rounded-lg text-xs">Baixar</a>
                                    <span class="px-3 py-2 rounded-lg text-xs ${obj.savedToLibrary ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-200'}">${obj.savedToLibrary ? 'Salvo!' : 'Não salvo'}</span>
                                </div>
                            </div>
                        `).join('');
                        panel.style.display = 'grid';
                    }
                } catch (err) {
                    document.getElementById('generic-loading-modal')?.remove();
                    showCustomModal('Erro', err.message || 'Falha ao gerar por título.', 'error');
                }
            });
            
            // --- Gerar por Título (segue prompt padrão) ---
            document.getElementById('btn-generate-by-title')?.addEventListener('click', async () => {
                const title = document.getElementById('gen-title-input')?.value.trim();
                const variantRaw = document.getElementById('gen-prompt-variant')?.value || 'auto';
                const variations = parseInt(document.getElementById('gen-variations')?.value || '1', 10);
                const promptAi = document.getElementById('gen-prompt-ai')?.value || 'none';
                const headlineLang = document.getElementById('gen-headline-lang')?.value || 'pt-BR';
                const artStyle = document.getElementById('gen-art-style')?.value || (document.getElementById('scene-style-select')?.value || 'photorealistic');
                const themeDetectionSelect = document.getElementById('theme-detection-select');
                const themeKey = themeDetectionSelect && themeDetectionSelect.value !== 'auto' ? themeDetectionSelect.value : undefined;
                const panel = document.getElementById('gen-by-title-results');
                try {
                    if (!title) { showCustomModal('Título obrigatório', 'Digite o título para gerar as thumbnails.', 'info'); return; }
                    const token = localStorage.getItem('core_token');
                    const currentNiche = currentAnalysisData?.niche || null;
                    const currentSubniche = currentAnalysisData?.subniche || null;
                    const folderId = document.getElementById('folder-select')?.value || null;
                    const variant = variantRaw === 'auto' ? undefined : parseInt(variantRaw, 10);
                    panel.innerHTML = '';
                    showLoadingModal('Gerando thumbnails pelo título...', 'image');
                    const resp = await fetch(`${API_BASE}/api/generate/imagefx/by-title`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ title, niche: currentNiche, subniche: currentSubniche, folder_id: folderId, prompt_variant: variant, language: headlineLang, style: artStyle, variations, prompt_ai: promptAi, theme_key: themeKey })
                    });
                    const data = await resp.json();
                    document.getElementById('generic-loading-modal')?.remove();
                    if (!resp.ok) throw new Error(data.msg || 'Erro ao gerar por título');
                    const imgs = Array.isArray(data.images) ? data.images : [];
                    if (imgs.length === 0) { showCustomModal('Aviso', 'Nenhuma imagem retornada.', 'warning'); return; }
                    panel.innerHTML = imgs.map((obj, i) => `
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                            <p class="text-xs text-gray-400 mb-2">Variação ${i + 1}</p>
                            <img src="${obj.imageUrl}" class="rounded-lg w-full mb-3" style="max-height: 380px; object-fit: contain;">
                            <div class="flex gap-2">
                                <a download="thumb-${i + 1}.png" href="${obj.imageUrl}" class="px-3 py-2 bg-amber-600 hover:bg-amber-500 text-black rounded-lg text-xs">Baixar</a>
                                <span class="px-3 py-2 rounded-lg text-xs ${obj.savedToLibrary ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-200'}">${obj.savedToLibrary ? 'Salvo!' : 'Não salvo'}</span>
                            </div>
                        </div>
                    `).join('');
                    console.log('[ByTitle] Prompt usado:', (data.promptUsed || '').substring(0, 300) + '...');
                    // Integra com Gerador de Ideias de Thumbnail
                    try {
                        const titleInput = document.getElementById('thumb-title-select');
                        if (titleInput) {
                            // Garantir opção e selecionar
                            let exists = false;
                            for (let i = 0; i < titleInput.options.length; i++) {
                                if (titleInput.options[i].value === title) { titleInput.selectedIndex = i; exists = true; break; }
                            }
                            if (!exists) {
                                const opt = document.createElement('option');
                                opt.value = title; opt.text = title; titleInput.appendChild(opt);
                                titleInput.selectedIndex = titleInput.options.length - 1;
                            }
                        }
                        const langMap = { 'pt-BR': 'pt', 'es-ES': 'es', 'en-US': 'en' };
                        const langSel = document.getElementById('thumb-language');
                        if (langSel) {
                            const code = langMap[headlineLang] || 'pt';
                            for (let i = 0; i < langSel.options.length; i++) {
                                const txt = langSel.options[i].text.toLowerCase();
                                if ((code === 'pt' && txt.includes('portugu')) || (code === 'es' && txt.includes('espa')) || (code === 'en' && txt.includes('english'))) {
                                    langSel.selectedIndex = i; break;
                                }
                            }
                        }
                        const styleSel = document.getElementById('thumb-style');
                        if (styleSel) {
                            for (let i = 0; i < styleSel.options.length; i++) {
                                if (styleSel.options[i].value === artStyle) { styleSel.selectedIndex = i; break; }
                            }
                        }
                        const useStd = document.getElementById('use-standard-prompt');
                        if (useStd) useStd.checked = true;
                        const genBtn = document.getElementById('btn-generate-thumbs');
                        if (genBtn) genBtn.click();
                        const genDiv = document.getElementById('thumbnail-generator');
                        if (genDiv) genDiv.style.display = 'block';
                    } catch (e) {
                        console.warn('[ByTitle] Integração com Gerador falhou:', e.message);
                    }
                } catch (err) {
                    document.getElementById('generic-loading-modal')?.remove();
                    showCustomModal('Erro', err.message || 'Falha ao gerar por título.', 'error');
                }
            });
            
            if (btnGenerateThumbs) {
                btnGenerateThumbs.addEventListener('click', handleThumbnailGeneration);
            }
            if (btnGenerateMoreThumbs) {
                btnGenerateMoreThumbs.addEventListener('click', handleThumbnailGeneration);
            }

            // --- Gerenciamento de Thumbnails de Referência ---
            const thumbnailRefManager = document.getElementById('thumbnail-references-manager');
            const thumbnailRefUploadForm = document.getElementById('thumbnail-reference-upload-form');
            const thumbnailRefList = document.getElementById('thumbnail-references-list');
            const thumbnailGenerator = document.getElementById('thumbnail-generator');
            const refFolderSelect = document.getElementById('ref-folder-select');
            const refNicheInput = document.getElementById('ref-niche');
            const refSubnicheInput = document.getElementById('ref-subniche');
            const themeDetectionSelect = document.getElementById('theme-detection-select');
            const seedThemesBtn = document.getElementById('btn-seed-themes');
            const seedStatus = document.getElementById('seed-status');

            async function loadAmbientationThemes() {
                try {
                    const token = safeLocalStorageGet('core_token');
                    const res = await fetch(`${API_BASE}/api/ambientations`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const list = await res.json();
                    if (Array.isArray(list) && themeDetectionSelect) {
                        themeDetectionSelect.innerHTML = '<option value="auto" selected>Automática pelo Título (Recomendado)</option>';
                        list.forEach(item => {
                            const opt = document.createElement('option');
                            opt.value = item.theme_key || String(item.id);
                            opt.textContent = `${item.theme_key || 'tema'} — ${item.keywords || ''}`;
                            themeDetectionSelect.appendChild(opt);
                        });
                    }
                } catch (e) {
                    console.warn('[Ambientations] Falha ao carregar temas:', e.message);
                }
            }

            seedThemesBtn?.addEventListener('click', async () => {
                try {
                    seedStatus.textContent = 'Populando biblioteca...';
                    const token = safeLocalStorageGet('core_token');
                    const res = await fetch(`${API_BASE}/api/ambientations/seed`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.msg || 'Erro ao popular biblioteca');
                    seedStatus.textContent = 'Biblioteca populada com 20 temas.';
                    await loadAmbientationThemes();
                } catch (e) {
                    seedStatus.textContent = 'Falha ao popular biblioteca.';
                } finally {
                    setTimeout(() => { seedStatus.textContent = ''; }, 3000);
                }
            });

            loadAmbientationThemes();
            
            // Preencher campos automaticamente quando a análise for concluída
            function updateThumbnailRefFields() {
                if (currentAnalysisData && currentAnalysisData.niche && refNicheInput) {
                    refNicheInput.value = currentAnalysisData.niche;
                }
                if (currentAnalysisData && currentAnalysisData.subniche && refSubnicheInput) {
                    refSubnicheInput.value = currentAnalysisData.subniche;
                }
                // Sincronizar pasta quando folderSelect mudar
                if (folderSelect && refFolderSelect) {
                    refFolderSelect.value = folderSelect.value || '';
                }
            }
            
            // Carregar pastas no select de referência
            function loadFoldersIntoRefSelect() {
                if (!refFolderSelect) return;
                const currentValue = refFolderSelect.value;
                refFolderSelect.innerHTML = '<option value="">Nenhuma pasta</option>';
                if (userFolders && userFolders.length > 0) {
                    userFolders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name;
                        refFolderSelect.appendChild(option);
                    });
                    if (currentValue) {
                        refFolderSelect.value = currentValue;
                    }
                }
            }
            
            // Sincronizar seleção de pasta
            if (folderSelect && refFolderSelect) {
                folderSelect.addEventListener('change', () => {
                    if (refFolderSelect) {
                        refFolderSelect.value = folderSelect.value || '';
                    }
                });
            }
            
            // Carregar pastas quando userFolders for atualizado
            if (userFolders && userFolders.length > 0) {
                loadFoldersIntoRefSelect();
            }
            
            // Observar mudanças em currentAnalysisData para atualizar campos
            let lastAnalysisData = JSON.stringify(currentAnalysisData);
            setInterval(() => {
                const current = JSON.stringify(currentAnalysisData);
                if (current !== lastAnalysisData) {
                    lastAnalysisData = current;
                    updateThumbnailRefFields();
                }
            }, 500);
            
            // Mostrar gerenciador quando o gerador de thumbnails estiver visível
            if (thumbnailGenerator) {
                const observer = new MutationObserver(() => {
                    if (thumbnailGenerator.style.display !== 'none') {
                        if (thumbnailRefManager) thumbnailRefManager.style.display = 'block';
                        loadThumbnailReferences();
                        updateThumbnailRefFields();
                        loadFoldersIntoRefSelect();
                        
                        // Carregar prompts padrão e atualizar seletor
                        const currentNiche = refNicheInput ? refNicheInput.value.trim() : (currentAnalysisData?.niche || null);
                        const currentSubniche = refSubnicheInput ? refSubnicheInput.value.trim() : (currentAnalysisData?.subniche || null);
                        const currentFolderId = refFolderSelect ? refFolderSelect.value : (folderSelect?.value || null);
                        checkStandardPrompt(currentNiche, currentSubniche, currentFolderId);
                    } else {
                        if (thumbnailRefManager) thumbnailRefManager.style.display = 'none';
                    }
                });
                observer.observe(thumbnailGenerator, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Função para carregar thumbnails de referência
            async function loadThumbnailReferences() {
                if (!thumbnailRefList) return;
                
                try {
                    thumbnailRefList.innerHTML = '<p class="text-gray-400 text-sm col-span-full">Carregando...</p>';
                    
                    // Obter valores atuais de niche/subniche
                    const currentNiche = refNicheInput ? refNicheInput.value.trim() : null;
                    const currentSubniche = refSubnicheInput ? refSubnicheInput.value.trim() : null;
                    const currentFolderId = refFolderSelect ? refFolderSelect.value : null;
                    
                    let url = `${API_BASE}/api/thumbnail-references?`;
                    if (currentNiche) url += `niche=${encodeURIComponent(currentNiche)}&`;
                    if (currentSubniche) url += `subniche=${encodeURIComponent(currentSubniche)}&`;
                    if (currentFolderId) url += `folder_id=${encodeURIComponent(currentFolderId)}&`;
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    }).catch(err => {
                        console.error('[Thumbnail Ref] Erro de rede ao carregar:', err);
                        throw new Error(`Erro de conexão: ${err.message}. Verifique sua conexão com a internet.`);
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Erro desconhecido');
                        let errorMsg = 'Erro ao carregar thumbnails';
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMsg = errorData.msg || errorMsg;
                        } catch (e) {
                            errorMsg = response.status === 404 ? 'Endpoint não encontrado' : 
                                       response.status === 500 ? 'Erro no servidor' : 
                                       response.status === 401 ? 'Não autorizado' : 
                                       `Erro ${response.status}: ${errorText}`;
                        }
                        throw new Error(errorMsg);
                    }
                    
                    const data = await response.json().catch(err => {
                        console.error('[Thumbnail Ref] Erro ao parsear resposta:', err);
                        throw new Error('Erro ao processar resposta do servidor');
                    });
                    const references = data.references || [];
                    
                    if (references.length === 0) {
                        thumbnailRefList.innerHTML = '<p class="text-gray-400 text-sm col-span-full">Nenhuma thumbnail de referência salva ainda.</p>';
                        document.getElementById('style-prompt-info')?.classList.add('hidden');
                        return;
                    }
                    
                    thumbnailRefList.innerHTML = references.map(ref => `
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 relative group">
                            <img src="${ref.thumbnail_base64 || ''}" alt="Thumbnail de referência" class="w-full h-32 object-cover rounded mb-3">
                            <div class="text-sm">
                                ${ref.channel_name ? `<p class="text-white font-semibold">${ref.channel_name}</p>` : ''}
                                ${ref.niche ? `<p class="text-gray-300">Nicho: ${ref.niche}</p>` : ''}
                                ${ref.subniche ? `<p class="text-gray-400">Subnicho: ${ref.subniche}</p>` : ''}
                                ${ref.description ? `<p class="text-gray-400 text-xs mt-2">${ref.description}</p>` : ''}
                                <p class="text-gray-500 text-xs mt-2">${new Date(ref.created_at).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <button onclick="deleteThumbnailReference(${ref.id})" class="absolute top-2 right-2 p-2 bg-red-600 hover:bg-red-500 text-white rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `).join('');
                    
                    // Verificar se existe prompt padrão para este nicho/subnicho
                    await checkStandardPrompt(currentNiche, currentSubniche, currentFolderId);
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('[Thumbnail Ref] Erro ao carregar:', err);
                    const errorMessage = err.message || 'Erro desconhecido ao carregar thumbnails';
                    
                    // Determinar tipo de erro e mensagem apropriada
                    let userMessage = 'Erro ao carregar thumbnails de referência.';
                    let suggestions = [];
                    
                    if (errorMessage.includes('conexão') || errorMessage.includes('connection') || errorMessage.includes('network') || errorMessage.includes('fetch') || errorMessage.includes('Failed to fetch')) {
                        userMessage = 'Erro de conexão ao carregar thumbnails.';
                        suggestions.push('Verifique sua conexão com a internet');
                        suggestions.push('Verifique se o servidor está rodando');
                        suggestions.push('Tente recarregar a página');
                    } else if (errorMessage.includes('401') || errorMessage.includes('Não autorizado')) {
                        userMessage = 'Sessão expirada.';
                        suggestions.push('Faça login novamente');
                    } else if (errorMessage.includes('404') || errorMessage.includes('não encontrado')) {
                        userMessage = 'Endpoint não encontrado.';
                        suggestions.push('Recarregue a página');
                        suggestions.push('Verifique se o servidor está atualizado');
                    } else if (errorMessage.includes('500') || errorMessage.includes('servidor')) {
                        userMessage = 'Erro no servidor.';
                        suggestions.push('Tente novamente em alguns segundos');
                        suggestions.push('Se o problema persistir, contate o suporte');
                    }
                    
                    thumbnailRefList.innerHTML = `
                        <div class="col-span-full bg-red-900/30 border border-red-700 rounded-lg p-4">
                            <p class="text-red-400 font-semibold mb-2">❌ ${userMessage}</p>
                            <p class="text-red-300 text-sm mb-2">Detalhes: ${errorMessage}</p>
                            ${suggestions.length > 0 ? `
                                <div class="mt-3">
                                    <p class="text-red-300 text-xs font-semibold mb-1">💡 Tente:</p>
                                    <ul class="text-red-300 text-xs list-disc list-inside">
                                        ${suggestions.map(s => `<li>${s}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <button onclick="loadThumbnailReferences()" class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-semibold">
                                🔄 Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }
            
            // Função para deletar thumbnail de referência
            window.deleteThumbnailReference = async function(id) {
                // Usar showCustomConfirm que retorna Promise
                const confirmed = await showCustomConfirm('Tem certeza que deseja deletar esta thumbnail de referência?', 'Confirmar Exclusão');
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`${API_BASE}/api/thumbnail-references/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) throw new Error('Erro ao deletar thumbnail');
                    
                    loadThumbnailReferences();
                    showCustomModal('Sucesso', 'Thumbnail de referência deletada com sucesso!', 'success');
                } catch (err) {
                    console.error('[Thumbnail Ref] Erro ao deletar:', err);
                    showCustomModal('Erro', 'Erro ao deletar thumbnail de referência: ' + err.message, 'error');
                }
            };
            
            // Função para verificar prompt padrão
            async function checkStandardPrompt(niche, subniche, folderId) {
                try {
                    let url = `${API_BASE}/api/thumbnail-style-prompts?`;
                    if (niche) url += `niche=${encodeURIComponent(niche)}&`;
                    if (subniche) url += `subniche=${encodeURIComponent(subniche)}&`;
                    if (folderId) url += `folder_id=${encodeURIComponent(folderId)}&`;
                    
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    const stylePromptInfo = document.getElementById('style-prompt-info');
                    const promptDisplay1 = document.getElementById('standard-prompt-display-1');
                    const promptDisplay2 = document.getElementById('standard-prompt-display-2');
                    const promptDisplay3 = document.getElementById('standard-prompt-display-3');
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.prompts && stylePromptInfo) {
                            stylePromptInfo.classList.remove('hidden');
                            
                            // Preencher os 3 prompts
                            if (promptDisplay1 && data.prompts.prompt_1) {
                                promptDisplay1.value = data.prompts.prompt_1;
                            }
                            if (promptDisplay2 && data.prompts.prompt_2) {
                                promptDisplay2.value = data.prompts.prompt_2;
                            }
                            if (promptDisplay3 && data.prompts.prompt_3) {
                                promptDisplay3.value = data.prompts.prompt_3;
                            }
                            
                            // Atualizar botões de seleção
                            const selectedPrompt = data.prompt_selected || 1;
                            updatePromptSelectionButtons(selectedPrompt);
                            
                            // Ativar tab do prompt selecionado
                            showPromptTab(`prompt-${selectedPrompt}`);
                            
                            // Atualizar seletor de prompt padrão no gerador de thumbnail
                            const thumbPromptVariantSelect = document.getElementById('thumb-prompt-variant-simple');
                            if (thumbPromptVariantSelect) {
                                // Garantir que o valor selecionado está correto
                                if (thumbPromptVariantSelect.value !== String(selectedPrompt)) {
                                    thumbPromptVariantSelect.value = String(selectedPrompt);
                                }
                                console.log('[Thumbnail Generator] Seletor de prompt atualizado para:', selectedPrompt);
                            }
                        } else if (stylePromptInfo) {
                            stylePromptInfo.classList.add('hidden');
                        }
                    } else {
                        if (stylePromptInfo) stylePromptInfo.classList.add('hidden');
                    }
                } catch (err) {
                    console.error('[Style Prompt] Erro ao verificar prompt padrão:', err);
                    document.getElementById('style-prompt-info')?.classList.add('hidden');
                }
            }
            
            // Função para analisar estilo e criar prompt padrão
            async function analyzeThumbnailStyle(forceReanalyze = false) {
                const currentNiche = refNicheInput ? refNicheInput.value.trim() : null;
                const currentSubniche = refSubnicheInput ? refSubnicheInput.value.trim() : null;
                const currentFolderId = refFolderSelect ? refFolderSelect.value : null;
                
                if (!currentNiche && !currentSubniche) {
                    showCustomModal(
                        '⚠️ Informação Necessária',
                        `Para analisar o estilo das thumbnails, é necessário informar:\n\n` +
                        `📋 Campos obrigatórios:\n` +
                        `• Nicho (obrigatório)\n` +
                        `• Subnicho (obrigatório)\n\n` +
                        `💡 Estes campos são necessários para associar corretamente o estilo visual ao seu canal/nicho.\n\n` +
                        `✅ Preencha pelo menos o nicho ou subnicho e tente novamente.`,
                        'warning'
                    );
                    return;
                }
                
                const btn = document.getElementById(forceReanalyze ? 'btn-reanalyze-style' : 'btn-analyze-style');
                if (!btn) {
                    console.error('[Style Analysis] Botão não encontrado');
                    return;
                }
                
                const originalText = btn.textContent;
                
                // Buscar informações do modelo selecionado
                const selectedModel = document.getElementById('analyze-model-select')?.value || 'auto';
                const modelName = selectedModel === 'auto' 
                    ? 'modelo automático (será escolhido automaticamente)' 
                    : selectedModel === 'claude-3-7-sonnet-20250219' 
                        ? 'Claude 3.7 Sonnet'
                        : selectedModel === 'gpt-4o'
                            ? 'GPT-4o'
                            : selectedModel === 'gemini-2.5-pro'
                                ? 'Gemini 2.5 Pro'
                                : selectedModel;
                
                // Contar thumbnails de referência
                const thumbnailCount = document.querySelectorAll('#thumbnail-references-list .thumbnail-ref-item').length;
                
                // Mostrar mensagem de início detalhada
                showCustomModal(
                    '🔄 Análise em Andamento',
                    `📊 Analisando o estilo visual das thumbnails de referência...\n\n` +
                    `📋 Detalhes da análise:\n` +
                    `• Nicho: ${currentNiche || 'Não especificado'}\n` +
                    `• Subnicho: ${currentSubniche || 'Não especificado'}\n` +
                    `• Thumbnails encontradas: ${thumbnailCount}\n` +
                    `• Modelo de IA: ${modelName}\n\n` +
                    `⏳ Processando... Isso pode levar de 10 a 30 segundos.\n\n` +
                    `💡 O sistema está analisando as thumbnails de referência e criando 3 prompts padrão diferentes que replicarão fielmente o estilo visual do seu canal/nicho.`,
                    'info'
                );
                
                setButtonLoading(btn, true);
                btn.disabled = true;
                btn.textContent = 'Analisando...';
                
                try {
                    const response = await fetch(`${API_BASE}/api/thumbnail-references/analyze-style`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            niche: currentNiche || null,
                            subniche: currentSubniche || null,
                            folder_id: currentFolderId || null,
                            force_reanalyze: forceReanalyze,
                            model: document.getElementById('analyze-model-select')?.value || 'auto'
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao analisar estilo');
                    }
                    
                    const data = await response.json();
                    
                    // Fechar modal de loading e mostrar sucesso
                    const modal = document.getElementById('custom-modal');
                    if (modal) modal.style.display = 'none';
                    
                    showCustomModal(
                        '✅ Análise Concluída com Sucesso!',
                        `🎨 Estilo visual analisado e 3 prompts padrão criados!\n\n` +
                        `📊 Resultado da análise:\n` +
                        `• Nicho analisado: "${currentNiche || 'geral'}"\n` +
                        `• Subnicho analisado: "${currentSubniche || 'geral'}"\n` +
                        `• Thumbnails processadas: ${thumbnailCount}\n` +
                        `• Modelo utilizado: ${modelName}\n\n` +
                        `✨ Próximos passos:\n` +
                        `1. Selecione qual dos 3 prompts padrão usar (Prompt 1, 2 ou 3)\n` +
                        `2. Marque o checkbox "Usar Prompt Padrão do Estilo do Canal/Nicho" no gerador de thumbnails\n` +
                        `3. Todas as futuras gerações seguirão automaticamente este estilo visual\n\n` +
                        `💡 Dica: Você pode re-analisar a qualquer momento para atualizar os prompts padrão.`,
                        'success'
                    );
                    
                    // Atualizar informações
                    await checkStandardPrompt(currentNiche, currentSubniche, currentFolderId);
                } catch (err) {
                    console.error('[Style Analysis] Erro:', err);
                    
                    // Fechar modal de loading e mostrar erro
                    const modal = document.getElementById('custom-modal');
                    if (modal) modal.style.display = 'none';
                    
                    // Extrair informações úteis do erro
                    let errorDetails = err.message || 'Erro desconhecido';
                    let suggestions = [];
                    
                    if (errorDetails.includes('API') || errorDetails.includes('key') || errorDetails.includes('chave')) {
                        suggestions.push('• Verifique se as chaves de API estão configuradas corretamente nas Configurações');
                        suggestions.push('• Certifique-se de que a chave do modelo selecionado está ativa e válida');
                    } else if (errorDetails.includes('thumbnail') || errorDetails.includes('referência')) {
                        suggestions.push('• Certifique-se de que há pelo menos uma thumbnail de referência salva');
                        suggestions.push('• Verifique se as thumbnails estão associadas ao nicho/subnicho correto');
                    } else if (errorDetails.includes('network') || errorDetails.includes('fetch') || errorDetails.includes('conexão')) {
                        suggestions.push('• Verifique sua conexão com a internet');
                        suggestions.push('• Tente novamente em alguns segundos');
                    } else {
                        suggestions.push('• Há thumbnails de referência salvas para este nicho/subnicho');
                        suggestions.push('• As APIs estão configuradas corretamente');
                        suggestions.push('• A conexão com o servidor está funcionando');
                    }
                    
                    showCustomModal(
                        '❌ Erro na Análise do Estilo',
                        `Não foi possível analisar o estilo visual das thumbnails de referência.\n\n` +
                        `🔍 Detalhes do erro:\n` +
                        `• ${errorDetails}\n\n` +
                        `💡 O que verificar:\n` +
                        suggestions.join('\n') + `\n\n` +
                        `🔄 Se o problema persistir, tente:\n` +
                        `• Selecionar um modelo de IA diferente\n` +
                        `• Re-analisar o estilo novamente\n` +
                        `• Verificar os logs do console para mais detalhes`,
                        'error'
                    );
                } finally {
                    setButtonLoading(btn, false);
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }
            
            // Função auxiliar para atualizar botões de seleção de prompt
            function updatePromptSelectionButtons(selectedNum) {
                [1, 2, 3].forEach(num => {
                    const btn = document.getElementById(`select-prompt-${num}`);
                    if (btn) {
                        if (num === selectedNum) {
                            btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                            btn.classList.add('bg-amber-700', 'hover:bg-amber-600');
                        } else {
                            btn.classList.remove('bg-amber-700', 'hover:bg-amber-600');
                            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        }
                    }
                });
            }
            
            // Função para mostrar tab de prompt
            function showPromptTab(tabName) {
                // Esconder todos os conteúdos
                document.querySelectorAll('.prompt-content').forEach(content => {
                    content.classList.add('hidden');
                });
                // Remover active de todas as tabs
                document.querySelectorAll('.prompt-tab').forEach(tab => {
                    tab.classList.remove('active', 'border-amber-500', 'text-amber-300');
                    tab.classList.add('border-transparent', 'text-gray-400');
                });
                // Mostrar conteúdo selecionado
                const content = document.getElementById(`${tabName}-content`);
                const tab = document.querySelector(`.prompt-tab[data-tab="${tabName}"]`);
                if (content) content.classList.remove('hidden');
                if (tab) {
                    tab.classList.add('active', 'border-amber-500', 'text-amber-300');
                    tab.classList.remove('border-transparent', 'text-gray-400');
                }
            }
            
            // Event listeners para tabs e seleção de prompts
            document.addEventListener('click', async (e) => {
                // Tabs de prompts
                if (e.target.classList.contains('prompt-tab')) {
                    const tabName = e.target.getAttribute('data-tab');
                    showPromptTab(tabName);
                }
                
                // Botões de seleção de prompt
                if (e.target.classList.contains('prompt-select-btn')) {
                    const promptNum = parseInt(e.target.getAttribute('data-prompt-num'));
                    const currentNiche = refNicheInput ? refNicheInput.value.trim() : null;
                    const currentSubniche = refSubnicheInput ? refSubnicheInput.value.trim() : null;
                    const currentFolderId = refFolderSelect ? refFolderSelect.value : null;
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/thumbnail-style-prompts/select`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                niche: currentNiche || null,
                                subniche: currentSubniche || null,
                                folder_id: currentFolderId || null,
                                prompt_number: promptNum
                            })
                        });
                        
                        if (response.ok) {
                            updatePromptSelectionButtons(promptNum);
                            showPromptTab(`prompt-${promptNum}`);
                            showCustomModal(
                                '✅ Prompt Selecionado!',
                                `O Prompt ${promptNum} foi selecionado como padrão para as gerações de thumbnails.\n\n` +
                                `📋 Informações:\n` +
                                `• Prompt ativo: Prompt ${promptNum}\n` +
                                `• Este prompt será usado quando você marcar "Usar Prompt Padrão do Estilo do Canal/Nicho"\n\n` +
                                `💡 Você pode alternar entre os 3 prompts a qualquer momento clicando nos botões "Prompt 1", "Prompt 2" ou "Prompt 3".`,
                                'success'
                            );
                        } else {
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (e) {
                                errorData = { msg: `Erro ${response.status}: ${response.statusText}` };
                            }
                            
                            // Se for 404, significa que não há prompt padrão criado ainda
                            if (response.status === 404 || errorData.msg?.includes('Nenhum prompt padrão encontrado')) {
                                throw new Error('PROMPT_NAO_ENCONTRADO');
                            } else {
                                throw new Error(errorData.msg || 'Erro ao selecionar prompt');
                            }
                        }
                    } catch (err) {
                        console.error('[Prompt Select] Erro:', err);
                        
                        if (err.message === 'PROMPT_NAO_ENCONTRADO') {
                            showCustomModal(
                                '⚠️ Prompt Padrão Não Encontrado',
                                `Não foi encontrado um prompt padrão para:\n\n` +
                                `📋 Informações:\n` +
                                `• Nicho: ${currentNiche || 'Não especificado'}\n` +
                                `• Subnicho: ${currentSubniche || 'Não especificado'}\n` +
                                `• Pasta: ${currentFolderId || 'Nenhuma'}\n\n` +
                                `💡 Para usar os prompts padrão:\n` +
                                `1. Adicione thumbnails de referência para este nicho/subnicho\n` +
                                `2. Clique em "Analisar Estilo e Criar Prompt Padrão"\n` +
                                `3. Aguarde a análise ser concluída (3 prompts serão gerados)\n` +
                                `4. Depois, você poderá selecionar qual dos 3 prompts usar\n\n` +
                                `🔄 Após criar os prompts padrão, você poderá selecioná-los aqui.`,
                                'warning'
                            );
                        } else {
                            showCustomModal(
                                '❌ Erro ao Selecionar Prompt',
                                `Não foi possível selecionar o Prompt ${promptNum} como padrão.\n\n` +
                                `🔍 Detalhes do erro:\n` +
                                `• ${err.message}\n\n` +
                                `💡 Tente novamente. Se o problema persistir, verifique sua conexão com o servidor.`,
                                'error'
                            );
                        }
                    }
                }
            });
            
            // Event listeners para análise de estilo (adicionar quando os elementos existirem)
            function attachStyleAnalysisListeners() {
                const btnAnalyzeStyle = document.getElementById('btn-analyze-style');
                const btnReanalyzeStyle = document.getElementById('btn-reanalyze-style');
                
                if (btnAnalyzeStyle && !btnAnalyzeStyle.hasAttribute('data-listener-attached')) {
                    btnAnalyzeStyle.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('[Style Analysis] Botão clicado - iniciando análise...');
                        analyzeThumbnailStyle(false);
                    });
                    btnAnalyzeStyle.setAttribute('data-listener-attached', 'true');
                    console.log('[Style Analysis] Listener adicionado ao btn-analyze-style');
                }
                
                if (btnReanalyzeStyle && !btnReanalyzeStyle.hasAttribute('data-listener-attached')) {
                    btnReanalyzeStyle.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('[Style Analysis] Botão re-análise clicado...');
                        analyzeThumbnailStyle(true);
                    });
                    btnReanalyzeStyle.setAttribute('data-listener-attached', 'true');
                    console.log('[Style Analysis] Listener adicionado ao btn-reanalyze-style');
                }
            }
            
            // Tentar anexar listeners imediatamente e também quando a seção for exibida
            attachStyleAnalysisListeners();
            
            // Re-anexar quando o gerenciador de thumbnails for exibido
            if (thumbnailRefManager) {
                const managerObserver = new MutationObserver(() => {
                    if (thumbnailRefManager.style.display !== 'none') {
                        setTimeout(attachStyleAnalysisListeners, 100);
                    }
                });
                managerObserver.observe(thumbnailRefManager, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Upload de thumbnail de referência
            if (thumbnailRefUploadForm) {
                thumbnailRefUploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const fileInput = document.getElementById('ref-thumbnail-file');
                    const folderId = refFolderSelect ? refFolderSelect.value : null;
                    const channelName = document.getElementById('ref-channel-name').value.trim();
                    const niche = document.getElementById('ref-niche').value.trim();
                    const subniche = document.getElementById('ref-subniche').value.trim();
                    const description = document.getElementById('ref-description').value.trim();
                    
                    if (!fileInput.files || !fileInput.files[0]) {
                        alert('Por favor, selecione uma imagem.');
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    if (file.size > 5 * 1024 * 1024) {
                        showCustomModal(
                            '⚠️ Arquivo Muito Grande',
                            `A imagem selecionada excede o tamanho máximo permitido.\n\n` +
                            `📊 Informações:\n` +
                            `• Tamanho do arquivo: ${(file.size / 1024 / 1024).toFixed(2)} MB\n` +
                            `• Tamanho máximo permitido: 5 MB\n\n` +
                            `💡 Solução:\n` +
                            `• Redimensione a imagem ou use uma versão menor\n` +
                            `• A imagem será redimensionada automaticamente para 16:9 (1280x720px) após o upload\n\n` +
                            `🔄 Selecione uma imagem menor e tente novamente.`,
                            'warning'
                        );
                        return;
                    }
                    
                    const btn = document.getElementById('btn-upload-reference');
                    setButtonLoading(btn, true);
                    
                    try {
                        // Converter para base64
                        const reader = new FileReader();
                        const base64 = await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        
                        const response = await fetch(`${API_BASE}/api/thumbnail-references/upload`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                thumbnail_base64: base64,
                                folder_id: folderId || null,
                                channel_name: channelName || null,
                                niche: niche || null,
                                subniche: subniche || null,
                                description: description || null
                            })
                        });
                        
                        const responseData = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(responseData.msg || 'Erro ao fazer upload');
                        }
                        
                        // Limpar formulário
                        thumbnailRefUploadForm.reset();
                        
                        // Recarregar lista
                        loadThumbnailReferences();
                        
                        const styleAnalyzed = responseData.styleAnalyzed || false;
                        
                        showCustomModal(
                            '✅ Thumbnail Salva com Sucesso!',
                            `A thumbnail de referência foi adicionada à biblioteca.\n\n` +
                            `📋 Informações salvas:\n` +
                            `• Nicho: ${niche || 'Não especificado'}\n` +
                            `• Subnicho: ${subniche || 'Não especificado'}\n` +
                            `• Canal: ${channelName || 'Não especificado'}\n` +
                            `• Descrição: ${description || 'Não fornecida'}\n\n` +
                            (styleAnalyzed ? 
                                `✨ Estilo analisado automaticamente!\n` +
                                `O sistema já analisou o estilo visual e criou 3 prompts padrão.\n` +
                                `Agora você pode usar o Gerador de Thumbnail Completa para gerar thumbnails prontas com headline, SEO e tags.` :
                            `💡 Próximo passo:\n` +
                                `Adicione mais thumbnails de referência ou clique em "Analisar Estilo e Criar Prompt Padrão" para gerar prompts que replicarão o estilo visual.`),
                            'success'
                        );
                    } catch (err) {
                        console.error('[Thumbnail Ref] Erro no upload:', err);
                        alert('Erro ao fazer upload: ' + err.message);
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });
            }

            // Event listener for hook phrase selection
            thumbResultadosDiv.addEventListener('change', (e) => {
                if (e.target.classList.contains('hook-phrase-select')) {
                    const select = e.target;
                    const selectedPhrase = select.value;
                    
                    if (!selectedPhrase || selectedPhrase.trim() === '') {
                        console.warn('[Thumbnail] Frase de gancho vazia selecionada');
                        return;
                    }
                    
                    const card = select.closest('.bg-gray-800');
                    if (!card) {
                        console.error('[Thumbnail] Card não encontrado');
                        return;
                    }
                    
                    const promptTextElement = card.querySelector('.image-prompt-text');
                    if (!promptTextElement) {
                        console.error('[Thumbnail] Elemento de prompt não encontrado');
                        return;
                    }
                    
                    const originalPrompt = promptTextElement.dataset.originalPrompt;
                    if (!originalPrompt) {
                        console.error('[Thumbnail] Prompt original não encontrado no data attribute');
                        return;
                    }
                    
                    const generateBtn = card.querySelector('.btn-gen-imagefx');
                    if (!generateBtn) {
                        console.error('[Thumbnail] Botão de gerar imagem não encontrado');
                        return;
                    }
                    
                    const copyBtn = card.querySelector('.btn-copy-prompt');
                    if (!copyBtn) {
                        console.error('[Thumbnail] Botão de copiar prompt não encontrado');
                    }

                    // Substituir placeholder de forma mais robusta (case-insensitive e diferentes variações)
                    let newPrompt = originalPrompt;
                    
                    // Tentar diferentes variações do placeholder
                    const placeholderVariations = [
                        '[FRASE DE GANCHO AQUI]',
                        '[FRASE DE GANCHO AQUI]',
                        '[Frase de Gancho Aqui]',
                        '[frase de gancho aqui]',
                        '[FRASE DE GANCHO]',
                        '[Frase de Gancho]',
                        '[frase de gancho]',
                        'FRASE DE GANCHO AQUI',
                        'Frase de Gancho Aqui',
                        'frase de gancho aqui',
                        'FRASE DE GANCHO',
                        'Frase de Gancho',
                        'frase de gancho'
                    ];
                    
                    let replaced = false;
                    for (const placeholder of placeholderVariations) {
                        if (newPrompt.includes(placeholder)) {
                            newPrompt = newPrompt.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), selectedPhrase);
                            replaced = true;
                            break;
                        }
                    }
                    
                    // Se não encontrou nenhum placeholder, tentar substituir qualquer texto entre colchetes que pareça ser um placeholder
                    if (!replaced) {
                        newPrompt = newPrompt.replace(/\[.*?gancho.*?\]/gi, selectedPhrase);
                        replaced = true;
                    }
                    
                    // Atualizar o texto exibido e o atributo data-prompt do botão
                    promptTextElement.textContent = newPrompt;
                    generateBtn.setAttribute('data-prompt', newPrompt);
                    
                    // Atualizar também o botão de copiar
                    if (copyBtn) {
                        copyBtn.setAttribute('data-prompt-text', newPrompt);
                    }
                    
                    console.log('[Thumbnail] Frase de gancho atualizada:', {
                        fraseSelecionada: selectedPhrase,
                        promptAtualizado: newPrompt.substring(0, 100) + '...'
                    });
                }
            });
            
            // Event listener para copiar prompt da imagem
            thumbResultadosDiv.addEventListener('click', (e) => {
                if (e.target.closest('.btn-copy-prompt')) {
                    const copyBtn = e.target.closest('.btn-copy-prompt');
                    const promptText = copyBtn.getAttribute('data-prompt-text');
                    
                    if (promptText) {
                        navigator.clipboard.writeText(promptText).then(() => {
                            // Feedback visual
                            const originalHTML = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 pointer-events-none text-green-500"></i>';
                            copyBtn.classList.add('text-green-500');
                            
                            setTimeout(() => {
                                copyBtn.innerHTML = originalHTML;
                                copyBtn.classList.remove('text-green-500');
                                if (typeof lucide !== 'undefined') lucide.createIcons();
                            }, 2000);
                        }).catch(err => {
                            console.error('[Thumbnail] Erro ao copiar prompt:', err);
                            alert('Erro ao copiar prompt. Tente selecionar o texto manualmente.');
                        });
                    }
                }
            });


            // --- Lógica para Gerar Imagem com ImageFX (via event delegation) ---
            thumbResultadosDiv.addEventListener('click', async (e) => {
                const targetButton = e.target.closest('.btn-gen-imagefx');
                if (!targetButton) return;

                e.preventDefault();
                
                const card = targetButton.closest('.bg-gray-800');
                if (!card) {
                    console.error('[ImageFX] Card não encontrado');
                    return;
                }
                
                // Buscar a frase de gancho selecionada no momento
                const hookSelect = card.querySelector('.hook-phrase-select');
                const selectedPhrase = hookSelect ? hookSelect.value : null;
                
                // Buscar o prompt original
                const promptTextElement = card.querySelector('.image-prompt-text');
                const originalPrompt = promptTextElement ? promptTextElement.dataset.originalPrompt : null;
                
                // Obter o prompt atual do botão
                let promptDesc = targetButton.getAttribute('data-prompt');
                const usingStandard = (targetButton.getAttribute('data-using-standard') === 'true');
                
                // CRÍTICO: Garantir que a frase de gancho está sempre incluída no prompt
                if (selectedPhrase && selectedPhrase.trim() !== '' && promptDesc) {
                    // Lista de variações do placeholder
                    const placeholderVariations = [
                        '[FRASE DE GANCHO AQUI]',
                        '[FRASE DE GANCHO]',
                        '[Frase de Gancho Aqui]',
                        '[frase de gancho aqui]',
                        '[FRASE DE GANCHO AQUI]',
                        '[Frase de Gancho]',
                        '[frase de gancho]',
                        'FRASE DE GANCHO AQUI',
                        'Frase de Gancho Aqui',
                        'frase de gancho aqui'
                    ];
                    
                    let replaced = false;
                    
                    // Tentar substituir qualquer variação do placeholder
                    for (const placeholder of placeholderVariations) {
                        const regex = new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                        if (regex.test(promptDesc)) {
                            promptDesc = promptDesc.replace(regex, selectedPhrase);
                            replaced = true;
                            break;
                        }
                    }
                    
                    // Se não encontrou placeholder, tentar regex genérico
                    if (!replaced) {
                        const genericRegex = /\[.*?gancho.*?\]/gi;
                        if (genericRegex.test(promptDesc)) {
                            promptDesc = promptDesc.replace(genericRegex, selectedPhrase);
                            replaced = true;
                        }
                    }
                    
                    // Se estiver usando prompt padrão, não inserir bloco de tipografia; só substitui placeholders.
                    // Caso contrário (prompt gerado), manter lógica anterior de inserção inteligente.
                    if (!usingStandard) {
                        if (!replaced && !promptDesc.toLowerCase().includes(selectedPhrase.toLowerCase())) {
                            const textMentions = [
                                /(with.*?text.*?that.*?says?)/gi,
                                /(featuring.*?text.*?that.*?reads?)/gi,
                                /(displaying.*?text.*?that.*?says?)/gi,
                                /(showing.*?text.*?that.*?says?)/gi,
                                /(professional.*?text.*?design)/gi,
                                /(photoshop.*?text)/gi
                            ];
                            
                            let textMentionFound = false;
                            for (const mention of textMentions) {
                                if (mention.test(promptDesc)) {
                                    promptDesc = promptDesc.replace(mention, `$1 "${selectedPhrase}"`);
                                    textMentionFound = true;
                                    break;
                                }
                            }
                            
                            if (!textMentionFound) {
                                promptDesc += `, with professional Photoshop-quality text design displaying "${selectedPhrase}" in large, bold, vibrant typography with professional layer effects including drop shadow, stroke, outer glow, and bevel & emboss, positioned strategically in the composition`;
                            }
                        }
                    }
                    
                    // Atualizar o atributo data-prompt e o texto exibido
                    targetButton.setAttribute('data-prompt', promptDesc);
                    if (promptTextElement) {
                        promptTextElement.textContent = promptDesc;
                    }
                    
                    console.log('[ImageFX] Frase de gancho garantida no prompt:', {
                        fraseSelecionada: selectedPhrase,
                        promptAtualizado: promptDesc.substring(0, 200) + '...',
                        foiSubstituido: replaced
                    });
                } else if (!selectedPhrase || selectedPhrase.trim() === '') {
                    console.warn('[ImageFX] Nenhuma frase de gancho selecionada - gerando sem texto');
                }
                
                const imageFxLoading = card.querySelector('.imagefx-loading');
                const imageFxResult = card.querySelector('.imagefx-result');

                if (!promptDesc || promptDesc === 'N/A' || promptDesc.trim() === '') {
                    alert("Descrição da thumbnail não encontrada para gerar a imagem.");
                    console.error('[ImageFX] Prompt inválido:', promptDesc);
                    return;
                }
                
                console.log('[ImageFX] Gerando imagem com prompt:', {
                    fraseSelecionada: selectedPhrase,
                    promptLength: promptDesc.length,
                    promptPreview: promptDesc.substring(0, 150) + '...'
                });
                
                if (imageFxLoading) imageFxLoading.style.display = 'flex';
                if (imageFxResult) imageFxResult.style.display = 'none';
                setButtonLoading(targetButton, true);

                try {
                    // Obter dados do contexto atual (niche, subniche, style, etc.)
                    const nicheData = card.getAttribute('data-niche') || currentAnalysisData?.niche || '';
                    const subnicheData = card.getAttribute('data-subniche') || currentAnalysisData?.subniche || '';
                    const styleData = card.getAttribute('data-style') || document.getElementById('input-style')?.value || '';
                    const views = currentAnalysisData?.videoDetails?.views || 0;
                    
                    const response = await fetch(`${API_BASE}/api/generate/imagefx`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ 
                            prompt: promptDesc,
                            niche: nicheData,
                            subniche: subnicheData,
                            style: styleData,
                            saveToLibrary: true // Salvar automaticamente na biblioteca
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg || 'Erro desconhecido');

                    if (imageFxResult) {
                        const imageUrl = data.imageUrl;
                        const savedToLibrary = data.savedToLibrary || false;
                        const libraryId = data.libraryId || null;
                        
                        imageFxResult.innerHTML = `
                            <img src="${imageUrl}" alt="Imagem gerada" class="rounded-lg w-full mb-3" style="max-height: 400px; object-fit: contain;">
                            <div class="flex gap-2">
                                <button type="button" class="btn-download-image flex-1 py-2 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold bg-amber-600 hover:bg-amber-500 text-black text-xs" data-url="${imageUrl}" data-title="${promptDesc.substring(0, 20)}">
                                    <i data-lucide="download" class="w-4 h-4 mr-1.5"></i>
                                    <span>Baixar Imagem</span>
                                </button>
                                <button type="button" class="btn-save-to-library py-2 px-3 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-2 disabled:opacity-50 font-bold ${savedToLibrary ? 'bg-green-600 hover:bg-green-500' : 'bg-blue-600 hover:bg-blue-500'} text-white text-xs" 
                                        data-image-url="${imageUrl}"
                                        data-prompt="${promptDesc.replace(/"/g, '&quot;')}"
                                        data-niche="${nicheData}"
                                        data-subniche="${subnicheData}"
                                        data-style="${styleData}"
                                        data-views="${views}"
                                        data-library-id="${libraryId || ''}"
                                        ${savedToLibrary ? 'disabled' : ''}>
                                    <i data-lucide="${savedToLibrary ? 'check' : 'save'}" class="w-4 h-4 mr-1.5"></i>
                                    <span>${savedToLibrary ? 'Salvo!' : 'Salvar na Biblioteca'}</span>
                                </button>
                            </div>
                        `;
                        imageFxResult.style.display = 'block';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }

                } catch (err) {
                    console.error("Erro ao gerar imagem com ImageFX:", err);
                     if (imageFxResult) {
                        imageFxResult.innerHTML = `<div class="error-message" style="display: block;">Falha na geração ImageFX: ${err.message}</div>`;
                        imageFxResult.style.display = 'block';
                    }
                } finally {
                    if (imageFxLoading) imageFxLoading.style.display = 'none';
                    setButtonLoading(targetButton, false);
                }
            });
            
            thumbResultadosDiv.addEventListener('click', (e) => {
                // Download de imagem
                const downloadButton = e.target.closest('.btn-download-image');
                if (downloadButton) {
                    e.preventDefault();
                    const url = downloadButton.getAttribute('data-url');
                    const title = downloadButton.getAttribute('data-title');
                    downloadBase64Image(url, title);
                    return;
                }
            });


            // --- LÓGICA DE PASTAS E HISTÓRICO ---
            const newFolderForm = document.getElementById('new-folder-form');
            const folderList = document.getElementById('folder-list');
            const historyTableBody = document.getElementById('history-table-body');
            const historyTitle = document.getElementById('history-title');
            const clearHistoryFilterBtn = document.getElementById('clear-history-filter');
            const selectAllHistory = document.getElementById('select-all-history');
            const deleteSelectedBtn = document.getElementById('delete-selected-history');

            async function loadFolders() {
                try {
                    console.log('Carregando pastas...', { API_BASE });
                    const response = await fetch(`${API_BASE}/api/folders`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('Resposta de /api/folders:', { status: response.status, ok: response.ok });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            console.error('Endpoint /api/folders não encontrado. Verifique se o servidor está rodando.');
                            console.error('API_BASE:', API_BASE, 'URL completa:', `${API_BASE}/api/folders`);
                            userFolders = []; // Define como array vazio em caso de erro
                            return;
                        }
                        throw new Error('Falha ao carregar pastas.');
                    }
                    userFolders = await response.json();
                    console.log('Pastas carregadas:', userFolders.length);
                    
                    folderSelect.innerHTML = '<option value="">Histórico Geral</option>';
                    userFolders.forEach(folder => {
                        folderSelect.innerHTML += `<option value="${folder.id}">${folder.name}</option>`;
                    });
                    
                    folderList.innerHTML = '';
                    userFolders.forEach(folder => {
                        folderList.innerHTML += `
                            <button class="folder-link w-full text-left px-4 py-3 rounded-lg transition-all duration-200 hover:bg-gray-800/50 hover:border-amber-500/30 border border-transparent group" data-folder-id="${folder.id}" data-folder-name="${folder.name}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3 flex-1">
                                        <i data-lucide="folder" class="w-4 h-4 text-amber-500/70"></i>
                                        <span class="text-gray-200 font-medium truncate">${folder.name}</span>
                                    </div>
                                    <button title="Excluir Pasta" class="delete-folder-btn p-1.5 rounded hover:bg-red-500/20 text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all" data-folder-id="${folder.id}" data-folder-name="${folder.name}">
                                    <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                                </div>
                            </button>`;
                    });
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                } catch (err) {
                    console.error(err.message);
                }
            }
            
            let currentHistoryPage = 1;
            let currentHistoryLimit = 50; // Valor padrão
            let currentHistoryFolderId = null;
            
            // Inicializar seletor de limite ao carregar
            document.addEventListener('DOMContentLoaded', () => {
                const historyLimitSelect = document.getElementById('history-limit');
                if (historyLimitSelect) {
                    historyLimitSelect.value = currentHistoryLimit.toString();
                }
            });
            
            async function loadHistory(folderId = null, page = 1, limit = currentHistoryLimit) {
                currentHistoryPage = page;
                currentHistoryLimit = limit;
                currentHistoryFolderId = folderId;
                
                const search = document.getElementById('history-search')?.value || '';
                const niche = document.getElementById('history-niche-filter')?.value || '';
                const dateFilter = document.getElementById('history-date-filter')?.value || '';
                
                let url = `${API_BASE}/api/history?page=${page}&limit=${limit}`;
                if (folderId) {
                    url += `&folderId=${folderId}`;
                }
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                if (niche) {
                    url += `&niche=${encodeURIComponent(niche)}`;
                }
                if (dateFilter) {
                    url += `&dateFilter=${encodeURIComponent(dateFilter)}`;
                }
                
                try {
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar histórico.');
                    const result = await response.json();
                    
                    // Garantir que history é sempre um array
                    const history = Array.isArray(result) ? result : (result.data || result.history || result.items || []);
                    const pagination = result.pagination || {};
                    
                    historyTableBody.innerHTML = '';
                    if (!Array.isArray(history) || history.length === 0) {
                        historyTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="p-8 text-center">
                                    <div class="flex flex-col items-center justify-center space-y-3">
                                        <i data-lucide="inbox" class="w-12 h-12 text-gray-600"></i>
                                        <p class="text-gray-400 font-medium">Nenhuma análise encontrada</p>
                                        <p class="text-gray-500 text-sm">Comece analisando um vídeo para ver seu histórico aqui</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        const paginationEl = document.getElementById('history-pagination');
                        if (paginationEl) paginationEl.style.display = 'none';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        return;
                    }
                    
                    history.forEach(item => {
                        // Converter para fuso horário de Brasília/São Paulo (America/Sao_Paulo)
                        const dateObj = new Date(item.analyzed_at);
                        
                        // Formatar data e hora no fuso de Brasília usando Intl.DateTimeFormat
                        const dateFormatter = new Intl.DateTimeFormat('pt-BR', {
                            timeZone: 'America/Sao_Paulo',
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        
                        const timeFormatter = new Intl.DateTimeFormat('pt-BR', {
                            timeZone: 'America/Sao_Paulo',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                        
                        const date = dateFormatter.format(dateObj);
                        const time = timeFormatter.format(dateObj);
                        
                        // Truncar título se muito longo
                        const title = item.original_title || 'Sem título';
                        const truncatedTitle = title.length > 50 ? title.substring(0, 50) + '...' : title;
                        
                        // Truncar nicho se muito longo
                        const niche = item.detected_subniche || 'N/A';
                        const truncatedNiche = niche.length > 30 ? niche.substring(0, 30) + '...' : niche;
                        
                        historyTableBody.innerHTML += `
                            <tr class="hover:bg-gray-800/30 transition-colors">
                                <td class="p-3">
                                    <input type="checkbox" class="history-checkbox bg-gray-700 border-gray-600 rounded text-amber-500 focus:ring-amber-500 focus:ring-2" data-id="${item.id}">
                                </td>
                                <td class="p-3">
                                    <p class="text-gray-200 font-medium truncate" style="max-width: 250px;" title="${title}">${truncatedTitle}</p>
                                </td>
                                <td class="p-3">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400 border border-amber-500/20 truncate" style="max-width: 200px;" title="${niche}">
                                        ${truncatedNiche}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <div class="flex flex-col whitespace-nowrap" style="min-width: 140px;">
                                        <span class="text-gray-200 text-sm font-medium">${date}</span>
                                        <span class="text-gray-400 text-xs">${time}</span>
                                    </div>
                                </td>
                                <td class="p-3">
                                    <div class="flex items-center justify-center" style="min-width: 80px;">
                                        <button title="Carregar Análise" class="p-2 rounded-lg hover:bg-amber-500/20 transition-all text-gray-400 hover:text-amber-500 border border-transparent hover:border-amber-500/30 btn-history-action" data-action="load" data-id="${item.id}">
                                        <i data-lucide="upload" class="pointer-events-none w-4 h-4"></i>
                                    </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Carregar vídeos gerados
                    loadGeneratedVideos();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Atualizar paginação
                    updateHistoryPagination(pagination);
                    
                } catch (err) {
                    console.error('Erro ao carregar histórico:', err);
                    const errorMessage = err.message || 'Erro desconhecido ao carregar histórico.';
                    if (historyTableBody) {
                        historyTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="p-8 text-center">
                                    <div class="flex flex-col items-center justify-center space-y-3">
                                        <i data-lucide="alert-circle" class="w-12 h-12 text-red-500"></i>
                                        <p class="text-red-400 font-medium">Erro ao carregar histórico</p>
                                        <p class="text-gray-500 text-sm">${errorMessage}</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                    const paginationEl = document.getElementById('history-pagination');
                    if (paginationEl) paginationEl.style.display = 'none';
                }
            }
            
            // Carregar vídeos gerados
            async function loadGeneratedVideos() {
                try {
                    const response = await fetch(`${API_BASE}/api/videos/generated`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar vídeos gerados.');
                    const result = await response.json();
                    
                    const videos = result.videos || [];
                    if (videos.length === 0) return;
                    
                    // Adicionar seção de vídeos gerados antes da tabela de histórico
                    const historyContainer = document.querySelector('#view-historico .md\\:col-span-2 > div');
                    if (!historyContainer) return;
                    
                    // Verificar se já existe a seção
                    let videosSection = document.getElementById('generated-videos-section');
                    if (!videosSection) {
                        videosSection = document.createElement('div');
                        videosSection.id = 'generated-videos-section';
                        videosSection.className = 'mb-8';
                        historyContainer.insertBefore(videosSection, historyContainer.firstChild);
                    }
                    
                    videosSection.innerHTML = `
                        <h2 class="text-2xl font-bold text-white mb-4">🎬 Vídeos Gerados</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${videos.map(video => {
                                // Converter para fuso horário de Brasília
                                const videoDate = new Date(video.created_at);
                                const dateFormatter = new Intl.DateTimeFormat('pt-BR', {
                                    timeZone: 'America/Sao_Paulo',
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                });
                                const date = dateFormatter.format(videoDate);
                                const promptPreview = video.prompt ? (video.prompt.length > 50 ? video.prompt.substring(0, 50) + '...' : video.prompt) : 'Sem descrição';
                                return `
                                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                        <div class="mb-2">
                                            <p class="text-sm text-gray-400 truncate">${promptPreview}</p>
                                            <p class="text-xs text-gray-500 mt-1">${date} • ${video.model || 'N/A'}</p>
                                        </div>
                                        <a href="${video.video_uri}" target="_blank" class="text-amber-500 hover:text-amber-400 text-sm font-medium flex items-center gap-2">
                                            <i data-lucide="play" class="w-4 h-4"></i>
                                            Assistir Vídeo
                                        </a>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (error) {
                    console.error('Erro ao carregar vídeos gerados:', error);
                }
            }
            
            function updateHistoryPagination(pagination) {
                const paginationInfo = document.getElementById('history-pagination-info');
                const paginationControls = document.getElementById('history-pagination-controls');
                const paginationContainer = document.getElementById('history-pagination');
                const historyLimitSelect = document.getElementById('history-limit');
                
                // Sempre mostrar paginação se houver dados
                if (pagination && pagination.total > 0) {
                paginationContainer.style.display = 'flex';
                
                    // Atualizar seletor de limite
                    if (historyLimitSelect) {
                        const currentLimit = pagination.limit || currentHistoryLimit;
                        if (currentLimit === 10) historyLimitSelect.value = '10';
                        else if (currentLimit === 50) historyLimitSelect.value = '50';
                        else if (currentLimit === 100) historyLimitSelect.value = '100';
                    }
                    
                    // Info melhorada
                const start = ((pagination.page - 1) * pagination.limit) + 1;
                const end = Math.min(pagination.page * pagination.limit, pagination.total);
                    paginationInfo.innerHTML = `<span class="text-gray-300">Mostrando <span class="text-amber-500 font-bold">${start}-${end}</span> de <span class="text-amber-500 font-bold">${pagination.total}</span> análises</span>`;
                } else {
                    paginationContainer.style.display = 'none';
                    return;
                }
                
                // Controles melhorados
                paginationControls.innerHTML = '';
                
                // Botão Anterior
                if (pagination.hasPrev) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 text-sm font-medium transition-all flex items-center space-x-1';
                    prevBtn.innerHTML = '<i data-lucide="chevron-left" class="w-4 h-4"></i><span class="hidden sm:inline">Anterior</span>';
                    prevBtn.onclick = () => loadHistory(currentHistoryFolderId, pagination.page - 1, currentHistoryLimit);
                    paginationControls.appendChild(prevBtn);
                }
                
                // Números de página
                const maxPages = 5;
                let startPage = Math.max(1, pagination.page - Math.floor(maxPages / 2));
                let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);
                if (endPage - startPage < maxPages - 1) {
                    startPage = Math.max(1, endPage - maxPages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${i === pagination.page ? 'bg-gradient-to-r from-amber-600 to-amber-500 text-black font-bold shadow-lg shadow-amber-500/30' : 'bg-gray-800/50 border border-gray-700 text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400'}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => loadHistory(currentHistoryFolderId, i, currentHistoryLimit);
                    paginationControls.appendChild(pageBtn);
                }
                
                // Botão Próximo
                if (pagination.hasNext) {
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 text-sm font-medium transition-all flex items-center space-x-1';
                    nextBtn.innerHTML = '<span class="hidden sm:inline">Próximo</span><i data-lucide="chevron-right" class="w-4 h-4"></i>';
                    nextBtn.onclick = () => loadHistory(currentHistoryFolderId, pagination.page + 1, currentHistoryLimit);
                    paginationControls.appendChild(nextBtn);
                }
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            newFolderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const folderNameInput = document.getElementById('new-folder-name');
                const name = folderNameInput.value;
                if (!name) return;
                
                try {
                    const response = await fetch(`${API_BASE}/api/folders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ name })
                    });
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.msg || 'Erro ao criar pasta.');
                    }
                    folderNameInput.value = '';
                    loadFolders();
                    showMessage('historico-success-message', 'Pasta criada com sucesso!');
                } catch (err) {
                    showMessage('historico-error-message', err.message, true);
                }
            });
            
            folderList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-folder-btn');
                if (deleteBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const folderId = deleteBtn.dataset.folderId;
                    const folderName = deleteBtn.dataset.folderName;
                    if (confirm(`Tem a certeza que deseja excluir a pasta "${folderName}"? As análises dentro dela serão movidas para o Histórico Geral.`)) {
                        try {
                            const response = await fetch(`${API_BASE}/api/folders/${folderId}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            const data = await response.json();
                            if (!response.ok) throw new Error(data.msg);
                            showMessage('historico-success-message', data.msg);
                            loadFolders();
                            if (historyTitle.innerText.includes(folderName)) {
                                historyTitle.innerText = 'Histórico Geral';
                                const historySubtitle = document.getElementById('history-subtitle');
                                if (historySubtitle) {
                                    historySubtitle.innerText = 'Todas as suas análises em um só lugar';
                                }
                                clearHistoryFilterBtn.style.display = 'none';
                                
                                // Atualizar estado ativo
                                document.querySelectorAll('.folder-link').forEach(btn => {
                                    btn.classList.remove('active', 'bg-amber-500/10', 'border-amber-500/50');
                                    btn.classList.add('border-transparent');
                                });
                                const folderAllBtn = document.getElementById('folder-all');
                                if (folderAllBtn) {
                                    folderAllBtn.classList.add('active', 'bg-amber-500/10', 'border-amber-500/50');
                                    folderAllBtn.classList.remove('border-transparent');
                                }
                                
                                loadHistory();
                            }
                        } catch (err) {
                            showMessage('historico-error-message', err.message, true);
                        }
                    }
                    return;
                }

                const link = e.target.closest('.folder-link');
                if (link) {
                    e.preventDefault();
                    const folderId = link.dataset.folderId;
                    const folderName = link.dataset.folderName;
                    
                    // Atualizar título e subtítulo
                    historyTitle.innerText = folderId ? folderName : 'Histórico Geral';
                    const historySubtitle = document.getElementById('history-subtitle');
                    if (historySubtitle) {
                        historySubtitle.innerText = folderId ? `Análises da pasta ${folderName}` : 'Todas as suas análises em um só lugar';
                    }
                    
                    // Atualizar estado ativo das pastas
                    document.querySelectorAll('.folder-link').forEach(btn => {
                        btn.classList.remove('active', 'bg-amber-500/10', 'border-amber-500/50');
                        btn.classList.add('border-transparent');
                    });
                    link.classList.add('active', 'bg-amber-500/10', 'border-amber-500/50');
                    link.classList.remove('border-transparent');
                    
                    clearHistoryFilterBtn.style.display = folderId ? 'flex' : 'none';
                    loadHistory(folderId || null, 1, currentHistoryLimit);
                }
            });
            
            clearHistoryFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                historyTitle.innerText = 'Histórico Geral';
                clearHistoryFilterBtn.style.display = 'none';
                loadHistory(null, 1, currentHistoryLimit);
            });
            
            // Event listeners para filtros
            const historySearch = document.getElementById('history-search');
            const historyNicheFilter = document.getElementById('history-niche-filter');
            const historyDateFilter = document.getElementById('history-date-filter');
            
            if (historySearch) {
                let searchTimeout;
                historySearch.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        loadHistory(currentHistoryFolderId, 1, currentHistoryLimit);
                    }, 500);
                });
            }
            
            if (historyNicheFilter) {
                historyNicheFilter.addEventListener('change', () => {
                    loadHistory(currentHistoryFolderId, 1, currentHistoryLimit);
                });
            }
            
            if (historyDateFilter) {
                historyDateFilter.addEventListener('change', () => {
                    loadHistory(currentHistoryFolderId, 1, currentHistoryLimit);
                });
            }
            
            // Carregar nichos únicos para o filtro
            async function loadHistoryNiches() {
                try {
                    const response = await fetch(`${API_BASE}/api/history/niches`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const niches = data.niches || [];
                        if (historyNicheFilter) {
                            const currentValue = historyNicheFilter.value;
                            historyNicheFilter.innerHTML = '<option value="">Todos os Nichos</option>';
                            niches.forEach(niche => {
                                const option = document.createElement('option');
                                option.value = niche;
                                option.textContent = niche;
                                historyNicheFilter.appendChild(option);
                            });
                            if (currentValue && niches.includes(currentValue)) {
                                historyNicheFilter.value = currentValue;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar nichos do histórico:', err);
                }
            }
            
            // Filtro de limite por página
            const historyLimitSelect = document.getElementById('history-limit');
            if (historyLimitSelect) {
                // Definir valor inicial baseado no currentHistoryLimit
                const setLimitValue = () => {
                    if (currentHistoryLimit === 10) historyLimitSelect.value = '10';
                    else if (currentHistoryLimit === 50) historyLimitSelect.value = '50';
                    else if (currentHistoryLimit === 100) historyLimitSelect.value = '100';
                    else historyLimitSelect.value = '50'; // Padrão
                };
                
                // Definir valor inicial
                setLimitValue();
                
                historyLimitSelect.addEventListener('change', (e) => {
                    const newLimit = parseInt(e.target.value);
                    currentHistoryLimit = newLimit;
                    loadHistory(currentHistoryFolderId, 1, newLimit);
                });
            }

            historyTableBody.addEventListener('click', async (e) => {
                const button = e.target.closest('.btn-history-action');
                if (button) {
                    const action = button.dataset.action;
                    const id = button.dataset.id;
                    
                    if (action === 'load') {
                        try {
                            const response = await fetch(`${API_BASE}/api/history/load/${id}`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            const data = await response.json();
                            if (!response.ok) throw new Error(data.msg || 'Falha ao carregar dados.');
                            
                            // Log para debug: verificar quantos títulos foram carregados
                            console.log(`[Histórico Frontend] Carregando análise ${id}: ${data.titulosSugeridos?.length || 0} títulos recebidos`);
                            if (data.titulosSugeridos && data.titulosSugeridos.length > 0) {
                                const titlesByModel = {};
                                data.titulosSugeridos.forEach(t => {
                                    const model = t.model || 'Desconhecido';
                                    titlesByModel[model] = (titlesByModel[model] || 0) + 1;
                                });
                                console.log(`[Histórico Frontend] Títulos por modelo:`, titlesByModel);
                            }
                            
                            navigateToView('analisador');
                            
                            if (thumbGeneratorDiv) thumbGeneratorDiv.style.display = 'none';
                            if (thumbResultadosDiv) {
                                thumbResultadosDiv.style.display = 'none';
                                thumbResultadosDiv.innerHTML = '';
                            }
                            
                            populateAnalysisResults(data, data.originalVideoUrl);
                            
                            currentAnalysisData = {
                                videoId: data.videoDetails.videoId,
                                niche: data.niche,
                                subniche: data.subniche,
                                model: data.modelUsed,
                                generatedTitles: data.titulosSugeridos,
                                videoDetails: data.videoDetails // Incluir videoDetails para acesso a views, etc.
                            };
                            
                        } catch (err) {
                            showMessage('analisador-error', `Falha ao carregar análise: ${err.message}`, true);
                        }
                    }
                }

                if (e.target.classList.contains('history-checkbox')) {
                    const checked = document.querySelectorAll('.history-checkbox:checked').length > 0;
                    deleteSelectedBtn.classList.toggle('hidden', !checked);
                }
            });

            selectAllHistory.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.history-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
                deleteSelectedBtn.classList.toggle('hidden', !e.target.checked || checkboxes.length === 0);
            });

            deleteSelectedBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.history-checkbox:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                if (confirm(`Tem a certeza que deseja excluir ${selectedIds.length} análise(s)?`)) {
                    try {
                        const response = await fetch(`${API_BASE}/api/history`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ ids: selectedIds })
                        });
                        if (!response.ok) throw new Error('Falha ao excluir.');
                        
                        const currentFolderId = document.querySelector('.folder-link.active')?.dataset.folderId || currentHistoryFolderId;
                        loadHistory(currentFolderId, currentHistoryPage, currentHistoryLimit);
                        showMessage('historico-success-message', 'Análises excluídas.');
                        deleteSelectedBtn.classList.add('hidden');
                        selectAllHistory.checked = false;
                    } catch (err) {
                        showMessage('historico-error-message', err.message, true);
                    }
                }
            });

            // --- LÓGICA DE CANAIS MONITORADOS ---
            const newChannelForm = document.getElementById('new-channel-form');
            const channelTableBody = document.getElementById('channel-table-body');
            const modal = document.getElementById('channel-videos-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalLoading = document.getElementById('modal-loading');
            const modalError = document.getElementById('modal-error');
            const modalVideoList = document.getElementById('modal-video-list');

            function showModal(isLoading = false, error = null) {
                modal.style.display = 'flex';
                modalLoading.style.display = isLoading ? 'block' : 'none';
                modalError.style.display = error ? 'block' : 'none';
                modalVideoList.style.display = !isLoading && !error ? 'block' : 'none';
                if (error) modalError.innerText = error;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function hideModal() {
                modal.style.display = 'none';
                modalVideoList.innerHTML = '';
            }

            if(modalCloseBtn) modalCloseBtn.addEventListener('click', hideModal);
            if(modal) modal.addEventListener('click', (e) => {
                if (e.target === modal) hideModal();
            });
            
            async function loadMonitoredChannels() {
                try {
                    console.log('[Canais Monitorados] Carregando lista de canais...');
                    const response = await fetch(`${API_BASE}/api/channels/monitor`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Falha ao carregar canais.' }));
                        throw new Error(errorData.msg || 'Falha ao carregar canais.');
                    }
                    const channels = await response.json();
                    
                    console.log(`[Canais Monitorados] ${channels ? channels.length : 0} canal(is) encontrado(s)`, channels);
                    
                    channelTableBody.innerHTML = '';
                    if (!channels || channels.length === 0) {
                        channelTableBody.innerHTML = '<tr><td colspan="3" class="p-3 border-b border-gray-700 bg-gray-900 text-center text-gray-500 py-4">Nenhum canal monitorado. Adicione um canal para começar.</td></tr>';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        return;
                    }
                    
                    // Verificar limite de 5 canais
                    if (channels.length >= 5) {
                        const limitMsg = document.getElementById('canais-limit-message');
                        if (limitMsg) {
                            limitMsg.textContent = `Limite de 5 canais atingido (${channels.length}/5). Exclua um canal para adicionar outro.`;
                            limitMsg.style.display = 'block';
                            limitMsg.className = 'error-message mb-4';
                        }
                    } else {
                        const limitMsg = document.getElementById('canais-limit-message');
                        if (limitMsg) limitMsg.style.display = 'none';
                    }
                    
                    channels.forEach((channel, index) => {
                        const escapedName = (channel.channel_name || '').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
                        const escapedUrl = (channel.channel_url || '').replace(/"/g, '&quot;');
                        channelTableBody.innerHTML += `
                            <tr>
                                <td class="p-3 border-b border-gray-700 bg-gray-900">${escapedName}</td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900 max-w-xs truncate">
                                    <a href="${escapedUrl}" target="_blank" class="text-amber-500 hover:text-amber-400" title="${escapedUrl}">${escapedUrl}</a>
                                </td>
                                <td class="p-3 border-b border-gray-700 bg-gray-900 flex space-x-1">
                                    <button title="Verificar Vídeos" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-gray-400 hover:text-green-500 btn-channel-action" data-action="check" data-id="${channel.id}">
                                        <i data-lucide="search" class="pointer-events-none w-4 h-4"></i>
                                    </button>
                                    <button title="Excluir Canal" class="p-2 rounded-md hover:bg-gray-700 transition-colors text-gray-400 hover:text-red-500 btn-channel-action" data-action="delete" data-id="${channel.id}">
                                        <i data-lucide="trash-2" class="pointer-events-none w-4 h-4"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    console.log('[Canais Monitorados] Lista atualizada com sucesso.');
                    
                } catch (err) {
                    console.error('[Canais Monitorados] Erro ao carregar:', err);
                    showMessage('canais-error-message', err.message, true);
                }
            }
            
            if (newChannelForm) {
                newChannelForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('btn-add-channel');
                    setButtonLoading(btn, true);
                    
                    const channelName = document.getElementById('new-channel-name').value.trim();
                    const channelUrl = document.getElementById('new-channel-url').value.trim();
                    
                    if (!channelName || !channelUrl) {
                        showMessage('canais-error-message', 'Nome e URL do canal são obrigatórios.', true);
                        setButtonLoading(btn, false);
                        return;
                    }
                    
                    try {
                        console.log('[Adicionar Canal] Enviando requisição...', { channelName, channelUrl });
                        const response = await fetch(`${API_BASE}/api/channels/monitor`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ channelName, channelUrl })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro ao adicionar canal.');
                        
                        console.log('[Adicionar Canal] Canal adicionado com sucesso:', data);
                        
                        // Limpar formulário
                        document.getElementById('new-channel-name').value = '';
                        document.getElementById('new-channel-url').value = '';
                        
                        // Recarregar lista de canais e vídeos fixados
                        await loadMonitoredChannels();
                        await loadPinnedVideos(null); // null = mostrar todos os canais
                        
                        showMessage('canais-success-message', `Canal "${channelName}" adicionado com sucesso!`);
                        
                    } catch (err) {
                        showMessage('canais-error-message', err.message, true);
                    } finally {
                        setButtonLoading(btn, false);
                    }
                });
            }
            
            if (channelTableBody) {
                channelTableBody.addEventListener('click', async (e) => {
                    const button = e.target.closest('.btn-channel-action');
                    if (!button) return;
                    
                    const action = button.dataset.action;
                    const channelId = button.dataset.id;
                    
                    if (action === 'delete') {
                         if (confirm('Tem certeza que deseja remover este canal?')) {
                            try {
                                const response = await fetch(`${API_BASE}/api/channels/monitor/${channelId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({ msg: 'Falha ao remover canal.' }));
                                    throw new Error(errorData.msg || 'Falha ao remover canal.');
                                }
                                await loadMonitoredChannels();
                                // Manter o canal selecionado no dropdown (ou null se não houver seleção)
                                const channelSelect = document.getElementById('pinned-channel-select');
                                const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                                await loadPinnedVideos(selectedChannelId);
                                showMessage('canais-success-message', 'Canal removido com sucesso.');
                            } catch (err) {
                                showMessage('canais-error-message', err.message, true);
                            }
                        }
                    }
                    if (action === 'check') {
                        const channelName = button.closest('tr').querySelector('td').innerText;
                        modalTitle.innerText = `Vídeos de: ${channelName}`;
                        showModal(true);

                        try {
                            const response = await fetch(`${API_BASE}/api/channels/monitor/${channelId}/check`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                let errorMsg = 'Erro desconhecido';
                                try {
                                    const errorData = JSON.parse(errorText);
                                    errorMsg = errorData.msg || errorMsg;
                                } catch (e) {
                                    errorMsg = errorText.substring(0, 100) || 'Erro ao buscar vídeos do canal';
                                }
                                throw new Error(errorMsg);
                            }
                            
                            const data = await response.json();

                            const createVideoListHTML = (videos, isPinned = false) => {
                                if (!videos || videos.length === 0) return '<p class="text-gray-500 text-center py-4">Nenhum vídeo encontrado.</p>';
                                return videos.map(video => {
                                    const escapedTitle = (video.title || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                                    const revenueUSD = video.estimatedRevenueUSD || 0;
                                    const rpmUSD = video.rpmUSD || 0;
                                    return `
                                    <div class="flex items-start space-x-4 bg-gray-800 p-3 rounded-lg">
                                        <img src="${video.thumbnail}" alt="thumb" class="w-32 h-18 object-cover rounded">
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-200 line-clamp-2">${video.title}</p>
                                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-400 mt-1">
                                                <span class="flex items-center"><i data-lucide="eye" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.views || 0)}</span>
                                                <span class="flex items-center"><i data-lucide="thumbs-up" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.likes || 0)}</span>
                                                <span class="flex items-center"><i data-lucide="message-square" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.comments || 0)}</span>
                                            </div>
                                            ${revenueUSD > 0 || rpmUSD > 0 ? `
                                            <div class="mt-2 text-xs">
                                                <span class="text-green-400 font-semibold">$${Math.round(revenueUSD)}</span>
                                                <span class="text-gray-500 mx-1">•</span>
                                                <span class="text-amber-400 font-semibold">RPM: $${rpmUSD.toFixed(2)}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                        <div class="flex flex-col space-y-2">
                                            <button class="btn-analyze-from-modal py-2 px-3 rounded-lg transition duration-300 text-xs font-bold bg-amber-600 hover:bg-amber-500 text-black whitespace-nowrap" data-video-id="${video.videoId}">Analisar</button>
                                            ${isPinned ? 
                                                `<button title="Remover Fixado" class="btn-unpin-video p-2 rounded-md hover:bg-gray-700 text-amber-500" data-pin-id="${video.pinId}" data-channel-id="${channelId}"><i data-lucide="x" class="w-4 h-4 pointer-events-none"></i></button>` :
                                                `<button title="Fixar" class="btn-pin-video p-2 rounded-md hover:bg-gray-700 text-gray-400 hover:text-amber-400" data-channel-id="${channelId}" data-video-id="${video.videoId}" data-title="${escapedTitle}" data-thumbnail="${video.thumbnail}"><i data-lucide="pin" class="w-4 h-4 pointer-events-none"></i></button>`
                                            }
                                        </div>
                                    </div>
                                `}).join('');
                            };

                            modalVideoList.innerHTML = `
                                <div>
                                    <h3 class="text-lg font-semibold text-amber-500 mb-2">Vídeos Fixados</h3>
                                    <div class="space-y-3">${createVideoListHTML(data.pinned, true)}</div>
                                </div>
                                <hr class="border-gray-700 my-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-amber-500 mb-2">5 Vídeos Mais Populares</h3>
                                    <div class="space-y-3">${createVideoListHTML(data.popular)}</div>
                                </div>
                                <hr class="border-gray-700 my-6">
                                <div>
                                    <h3 class="text-lg font-semibold text-amber-500 mb-2">5 Vídeos Mais Recentes</h3>
                                    <div class="space-y-3">${createVideoListHTML(data.latest)}</div>
                                </div>
                            `;
                            showModal(false);

                        } catch (err) {
                            showModal(false, `Falha ao buscar vídeos: ${err.message}`);
                        }
                    }
                });
            }

            async function pinVideo(channelId, videoId, title, thumbnail, buttonElement) {
                try {
                    const response = await fetch(`${API_BASE}/api/videos/pin`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ channelId, videoId, title, thumbnail })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg);
                    
                    buttonElement.classList.add('text-amber-500');
                    buttonElement.disabled = true;
                    buttonElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 pointer-events-none"></i>';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    showMessage('canais-success-message', 'Vídeo fixado com sucesso!');
                    
                    // Refresh the modal content
                    const checkButton = document.querySelector(`.btn-channel-action[data-action="check"][data-id="${channelId}"]`);
                    if (checkButton) checkButton.click();
                    
                    // Atualizar seção de vídeos fixados em tempo real (manter canal selecionado)
                    const channelSelect = document.getElementById('pinned-channel-select');
                    const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                    await loadPinnedVideos(selectedChannelId);

                } catch (err) {
                    showMessage('canais-error-message', err.message, true);
                }
            }
            
            async function unpinVideo(pinId, channelId, buttonElement) {
                 try {
                    const response = await fetch(`${API_BASE}/api/videos/unpin/${pinId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg);
                    
                    showMessage('canais-success-message', 'Vídeo removido dos fixados.');
                    
                    // Refresh the modal content and pinned videos section
                    const checkButton = document.querySelector(`.btn-channel-action[data-action="check"][data-id="${channelId}"]`);
                    if (checkButton) checkButton.click();
                    // Manter o canal selecionado no dropdown
                    const channelSelect = document.getElementById('pinned-channel-select');
                    const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                    await loadPinnedVideos(selectedChannelId);

                } catch (err) {
                    showMessage('canais-error-message', err.message, true);
                }
            }
            
            let allChannelsForPinned = [];
            let allPinnedVideosByChannel = {};
            
            async function loadPinnedVideos(selectedChannelId = null) {
                const pinnedSection = document.getElementById('pinned-videos-section');
                const channelSelect = document.getElementById('pinned-channel-select');
                if (!pinnedSection) return;
                
                try {
                    // Buscar todos os canais monitorados
                    const channelsResponse = await fetch(`${API_BASE}/api/channels/monitor`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!channelsResponse.ok) throw new Error('Falha ao carregar canais.');
                    const channels = await channelsResponse.json();
                    allChannelsForPinned = channels || [];
                    
                    // Atualizar dropdown de canais
                    if (channelSelect) {
                        channelSelect.innerHTML = '<option value="">Todos os Canais</option>';
                        allChannelsForPinned.forEach(channel => {
                            const option = document.createElement('option');
                            option.value = channel.id;
                            option.textContent = channel.channel_name;
                            if (selectedChannelId && channel.id == selectedChannelId) {
                                option.selected = true;
                            }
                            channelSelect.appendChild(option);
                        });
                    }
                    
                    if (allChannelsForPinned.length === 0) {
                        pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum canal monitorado. Adicione um canal para começar.</p>';
                        return;
                    }
                    
                    // Buscar vídeos fixados de todos os canais (ou apenas do canal selecionado)
                    const channelsToFetch = selectedChannelId 
                        ? allChannelsForPinned.filter(c => c.id == selectedChannelId)
                        : allChannelsForPinned;
                    
                    allPinnedVideosByChannel = {};
                    for (const channel of channelsToFetch) {
                        try {
                            const pinnedResponse = await fetch(`${API_BASE}/api/channels/${channel.id}/pinned`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            if (pinnedResponse.ok) {
                                const pinned = await pinnedResponse.json();
                                if (pinned && pinned.length > 0) {
                                    allPinnedVideosByChannel[channel.id] = {
                                        channelName: channel.channel_name,
                                        channelId: channel.id,
                                        videos: pinned
                                    };
                                }
                            }
                        } catch (err) {
                            console.error(`Erro ao buscar vídeos fixados do canal ${channel.id}:`, err);
                        }
                    }
                    
                    const channelsWithPinnedVideos = Object.values(allPinnedVideosByChannel);
                    
                    if (channelsWithPinnedVideos.length === 0) {
                        if (selectedChannelId) {
                            pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Este canal não possui vídeos fixados ainda. Fixe vídeos ao buscar vídeos do canal.</p>';
                        } else {
                            pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum vídeo fixado ainda. Fixe vídeos ao buscar vídeos de um canal.</p>';
                        }
                        return;
                    }
                    
                    // Exibir vídeos fixados (agrupados por canal se "Todos os Canais", ou apenas do canal selecionado)
                    if (selectedChannelId) {
                        // Mostrar apenas vídeos do canal selecionado
                        const channelData = allPinnedVideosByChannel[selectedChannelId];
                        if (channelData) {
                            const { channelName, channelId, videos } = channelData;
                            const videosHtml = videos.map(video => {
                                const escapedTitle = (video.title || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                                return createPinnedVideoCard(video, channelId, escapedTitle);
                            }).join('');
                            
                            pinnedSection.innerHTML = `
                                <div class="col-span-full mb-4">
                                    <h3 class="text-lg font-semibold text-amber-500 mb-3 flex items-center">
                                        <i data-lucide="tv" class="w-5 h-5 mr-2"></i>
                                        ${channelName}
                                        <span class="ml-2 text-sm text-gray-400">(${videos.length} vídeo${videos.length !== 1 ? 's' : ''} fixado${videos.length !== 1 ? 's' : ''})</span>
                                    </h3>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 col-span-full">
                                    ${videosHtml}
                                </div>
                            `;
                        } else {
                            pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Este canal não possui vídeos fixados ainda.</p>';
                        }
                    } else {
                        // Mostrar todos os canais agrupados
                        pinnedSection.innerHTML = channelsWithPinnedVideos.map(channelData => {
                            const { channelName, channelId, videos } = channelData;
                            const videosHtml = videos.map(video => {
                                const escapedTitle = (video.title || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                                return createPinnedVideoCard(video, channelId, escapedTitle);
                            }).join('');
                            
                            return `
                                <div class="col-span-full mb-6">
                                    <h3 class="text-lg font-semibold text-amber-500 mb-3 flex items-center">
                                        <i data-lucide="tv" class="w-5 h-5 mr-2"></i>
                                        ${channelName}
                                        <span class="ml-2 text-sm text-gray-400">(${videos.length} vídeo${videos.length !== 1 ? 's' : ''} fixado${videos.length !== 1 ? 's' : ''})</span>
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        ${videosHtml}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    function createPinnedVideoCard(video, channelId, escapedTitle) {
                        return `
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 hover:border-amber-500 transition-colors">
                                <img src="${video.thumbnail}" alt="thumb" class="w-full h-40 object-cover rounded-lg mb-3">
                                <div class="space-y-2">
                                    <p class="text-sm font-medium text-white line-clamp-2" title="${escapedTitle}">${escapedTitle}</p>
                                    <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
                                        <span class="flex items-center"><i data-lucide="eye" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.views || 0)}</span>
                                        <span class="flex items-center"><i data-lucide="thumbs-up" class="w-3 h-3 mr-1"></i>${new Intl.NumberFormat('pt-BR').format(video.likes || 0)}</span>
                                    </div>
                                    ${video.estimatedRevenueUSD > 0 || video.rpmUSD > 0 ? `
                                    <div class="mt-2 p-2 bg-gray-800 rounded text-xs">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-gray-400">Receita:</span>
                                            <span class="text-green-400 font-bold">$${Math.round(video.estimatedRevenueUSD || 0)}</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-gray-400">RPM:</span>
                                            <span class="text-amber-400 font-bold">$${(video.rpmUSD || 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                    <div class="flex items-center gap-2 mt-3">
                                        <button class="btn-analyze-from-pinned flex-1 py-2 px-3 rounded-lg transition duration-300 text-xs font-bold bg-amber-600 hover:bg-amber-500 text-black" data-video-id="${video.videoId}">
                                            Analisar
                                        </button>
                                        <button title="Remover Fixado" class="btn-unpin-from-section p-2 rounded-md hover:bg-gray-700 text-red-500" data-pin-id="${video.pinId}" data-channel-id="${channelId}">
                                            <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    // Event listener para mudança de canal no dropdown
                    if (channelSelect) {
                        // Remover listener antigo se existir
                        const oldHandler = channelSelect._changeHandler;
                        if (oldHandler) {
                            channelSelect.removeEventListener('change', oldHandler);
                        }
                        
                        const changeHandler = (e) => {
                            const selectedChannelId = e.target.value || null;
                            loadPinnedVideos(selectedChannelId);
                        };
                        
                        channelSelect._changeHandler = changeHandler;
                        channelSelect.addEventListener('change', changeHandler);
                    }
                    
                    // Event listeners para botões (usar event delegation)
                    const oldClickHandler = pinnedSection._clickHandler;
                    if (oldClickHandler) {
                        pinnedSection.removeEventListener('click', oldClickHandler);
                    }
                    
                    const clickHandler = async (e) => {
                        const analyzeBtn = e.target.closest('.btn-analyze-from-pinned');
                        if (analyzeBtn) {
                            const videoId = analyzeBtn.dataset.videoId;
                            const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                            navigateToView('analisador');
                            const urlInput = document.getElementById('video-url-input') || document.getElementById('video-url');
                            if (urlInput) urlInput.value = videoUrl;
                            const analisarBtn = document.getElementById('analisar-button');
                            if (analisarBtn) analisarBtn.click();
                            return;
                        }
                        
                        const unpinBtn = e.target.closest('.btn-unpin-from-section');
                        if (unpinBtn) {
                            const pinId = unpinBtn.dataset.pinId;
                            const channelId = unpinBtn.dataset.channelId;
                            await unpinVideo(pinId, channelId, unpinBtn);
                            // Recarregar mantendo o canal selecionado
                            const selectedChannelId = channelSelect ? channelSelect.value || null : null;
                            await loadPinnedVideos(selectedChannelId);
                            return;
                        }
                    };
                    
                    pinnedSection._clickHandler = clickHandler;
                    pinnedSection.addEventListener('click', clickHandler);
                    
                } catch (err) {
                    console.error('Erro ao carregar vídeos fixados:', err);
                    pinnedSection.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Erro ao carregar vídeos fixados.</p>';
                }
            }

            if (modalVideoList) {
                modalVideoList.addEventListener('click', (e) => {
                    const analyzeButton = e.target.closest('.btn-analyze-from-modal');
                    if (analyzeButton) {
                        const videoId = analyzeButton.dataset.videoId;
                        const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                        
                        hideModal();
                        navigateToView('analisador');
                        
                        const videoUrlInput = document.getElementById('video-url');
                        const analisadorForm = document.getElementById('analisador-form');
                        videoUrlInput.value = videoUrl;
                        analisadorForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                        return;
                    }

                    const pinButton = e.target.closest('.btn-pin-video');
                    if (pinButton) {
                        const channelId = pinButton.dataset.channelId;
                        const videoId = pinButton.dataset.videoId;
                        const title = pinButton.dataset.title;
                        const thumbnail = pinButton.dataset.thumbnail;
                        pinVideo(channelId, videoId, title, thumbnail, pinButton);
                        return;
                    }
                    
                    const unpinButton = e.target.closest('.btn-unpin-video');
                    if (unpinButton) {
                        const pinId = unpinButton.dataset.pinId;
                        const channelId = unpinButton.dataset.channelId;
                        unpinVideo(pinId, channelId, unpinButton);
                        return;
                    }
                });
            }


            // --- LÓGICA DE CONFIGURAÇÕES (API KEYS) ---
            
            // Função para carregar status das chaves salvas
            async function loadAPIKeysStatus() {
                try {
                    const userToken = localStorage.getItem('core_token');
                    if (!userToken) return;
                    
                    const response = await fetch(`${API_BASE}/api/keys/status`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) return;
                    
                    const status = await response.json();
                    
                    // Atualizar placeholders dos campos com versões mascaradas
                    const claudeInput = document.getElementById('key-claude');
                    const geminiInput = document.getElementById('key-gemini');
                    const openaiInput = document.getElementById('key-openai');
                    const youtubeInput = document.getElementById('key-youtube');
                    
                    if (status.claude?.exists && claudeInput && !claudeInput.value) {
                        claudeInput.placeholder = `Chave salva: ${status.claude.masked}`;
                        claudeInput.setAttribute('data-has-saved-key', 'true');
                    }
                    
                    if (status.gemini?.exists && geminiInput && !geminiInput.value) {
                        geminiInput.placeholder = `Chave salva: ${status.gemini.masked}`;
                        geminiInput.setAttribute('data-has-saved-key', 'true');
                    }
                    
                    if (status.openai?.exists && openaiInput && !openaiInput.value) {
                        openaiInput.placeholder = `Chave salva: ${status.openai.masked}`;
                        openaiInput.setAttribute('data-has-saved-key', 'true');
                    }
                    
                    if (status.youtube?.exists && youtubeInput && !youtubeInput.value) {
                        youtubeInput.placeholder = `Chave salva: ${status.youtube.masked}`;
                        youtubeInput.setAttribute('data-has-saved-key', 'true');
                    }
                } catch (err) {
                    console.error('Erro ao carregar status das chaves:', err);
                }
            }
            
            async function saveKey(serviceName, apiKey) {
                if (!apiKey) return Promise.resolve(null);
                const response = await fetch(`${API_BASE}/api/keys/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({ service_name: serviceName, api_key: apiKey })
                });
                const data = await response.json();
                if (!response.ok) {
                    // Se for erro de plano, mostrar mensagem especial
                    if (response.status === 403 && data.requiresUpgrade) {
                        throw new Error(data.msg || 'Você precisa fazer upgrade para usar esta funcionalidade.');
                    }
                    throw new Error(data.msg || `Erro ao salvar ${serviceName}.`);
                }
                return data;
            }
            
            const configForm = document.getElementById('config-form');
            if (configForm) {
                configForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const saveButton = document.getElementById('btn-save-all');
                    setButtonLoading(saveButton, true);

                    // Verificar se usuário tem plano premium antes de salvar
                    const userToken = localStorage.getItem('core_token');
                    let hasPremiumPlan = false;
                    try {
                        const userResponse = await fetch(`${API_BASE}/api/auth/me`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            const userPlan = userData.plan || userData.subscription_plan || 'plan-free';
                            hasPremiumPlan = userPlan === 'plan-master' || 
                                           userPlan === 'plan-master-annual' || 
                                           userPlan === 'plan-start-annual' || 
                                           userPlan === 'plan-turbo-annual' ||
                                           userData.isAdmin;
                        }
                    } catch (err) {
                        console.error('Erro ao verificar plano:', err);
                    }
                    
                    const claudeKey = document.getElementById('key-claude').value;
                    const geminiKey = document.getElementById('key-gemini').value;
                    const openaiKey = document.getElementById('key-openai').value;
                    const youtubeKey = document.getElementById('key-youtube').value;
                    const imagefxKey = document.getElementById('key-imagefx').value;
                    // Cookies do Meta.ai removidos
                    const useCreditsPref = document.getElementById('pref-use-credits').checked;

                    // Verificar se está tentando salvar APIs bloqueadas
                    if (!hasPremiumPlan && (claudeKey || geminiKey || openaiKey)) {
                        showMessage('config-error-message', "Você precisa ter o plano MASTER ou um plano ANUAL para usar suas próprias chaves de API. Faça upgrade para desbloquear este recurso.", true);
                        setButtonLoading(saveButton, false);
                        return;
                    }

                    try {
                        const promises = [];
                        if (claudeKey && hasPremiumPlan) promises.push(saveKey('claude', claudeKey));
                        if (geminiKey && hasPremiumPlan) promises.push(saveKey('gemini', geminiKey));
                        if (openaiKey && hasPremiumPlan) promises.push(saveKey('openai', openaiKey));
                        if (youtubeKey) promises.push(saveKey('youtube', youtubeKey));
                        if (imagefxKey) promises.push(saveKey('imagefx', imagefxKey));
                        
                        // Salvar preferência de uso de créditos
                        promises.push(saveUserPreference(useCreditsPref));

                        if (promises.length === 0) {
                            showMessage('config-error-message', "Nenhuma chave foi preenchida para salvar.", true);
                        } else {
                            await Promise.all(promises);
                            showMessage('config-success-message', "Configurações salvas com sucesso!");
                            updatePreferenceStatus(useCreditsPref);
                            
                            // Limpar apenas campos que foram preenchidos (salvos com sucesso)
                            // Não limpar se o campo estava vazio (significa que não foi alterado)
                            const claudeInput = document.getElementById('key-claude');
                            const geminiInput = document.getElementById('key-gemini');
                            const openaiInput = document.getElementById('key-openai');
                            const youtubeInput = document.getElementById('key-youtube');
                            
                            // Limpar apenas se havia valor e foi salvo com sucesso
                            if (claudeKey && claudeInput && !claudeInput.disabled) {
                                claudeInput.value = '';
                                claudeInput.removeAttribute('data-has-saved-key');
                            }
                            if (geminiKey && geminiInput && !geminiInput.disabled) {
                                geminiInput.value = '';
                                geminiInput.removeAttribute('data-has-saved-key');
                            }
                            if (openaiKey && openaiInput && !openaiInput.disabled) {
                                openaiInput.value = '';
                                openaiInput.removeAttribute('data-has-saved-key');
                            }
                            if (youtubeKey && youtubeInput) {
                                youtubeInput.value = '';
                                youtubeInput.removeAttribute('data-has-saved-key');
                            }
                            
                            // Removido: limpeza de cookies do Meta.ai
                            
                            // Recarregar status das chaves para atualizar placeholders
                            setTimeout(() => {
                                loadAPIKeysStatus();
                            }, 500);
                        }
                    } catch (err) {
                        showMessage('config-error-message', err.message, true);
                    } finally {
                        setButtonLoading(saveButton, false);
                    }
                });
            }

            // Validação de cookies do Meta.ai removida

            // Toggles para mostrar/ocultar senhas dos campos de API
            document.getElementById('toggle-key-claude')?.addEventListener('click', () => {
                const input = document.getElementById('key-claude');
                const button = document.getElementById('toggle-key-claude');
                if (input) {
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    const icon = button.querySelector('i[data-lucide]');
                    if (icon) {
                        icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });

            document.getElementById('toggle-key-gemini')?.addEventListener('click', () => {
                const input = document.getElementById('key-gemini');
                const button = document.getElementById('toggle-key-gemini');
                if (input) {
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    const icon = button.querySelector('i[data-lucide]');
                    if (icon) {
                        icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });

            document.getElementById('toggle-key-openai')?.addEventListener('click', () => {
                const input = document.getElementById('key-openai');
                const button = document.getElementById('toggle-key-openai');
                if (input) {
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    const icon = button.querySelector('i[data-lucide]');
                    if (icon) {
                        icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });

            document.getElementById('toggle-key-youtube')?.addEventListener('click', () => {
                const input = document.getElementById('key-youtube');
                const button = document.getElementById('toggle-key-youtube');
                if (input) {
                    const isPassword = input.type === 'password';
                    input.type = isPassword ? 'text' : 'password';
                    const icon = button.querySelector('i[data-lucide]');
                    if (icon) {
                        icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            });

            const validateButton = document.getElementById('btn-validate-all');
            if (validateButton) {
                validateButton.addEventListener('click', async () => {
                    setButtonLoading(validateButton, true);

                    try {
                        const response = await fetch(`${API_BASE}/api/keys/validate-all`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.msg || 'Erro desconhecido do servidor.');

                        // Formatar resultados da validação com HTML
                        let resultsHtml = '';
                        let allValid = true;
                        let hasResults = false;
                        let validCount = 0;
                        let invalidCount = 0;

                        data.results.forEach(result => {
                            hasResults = true;
                            const serviceName = result.service.charAt(0).toUpperCase() + result.service.slice(1);
                            
                            if (result.success) {
                                validCount++;
                                resultsHtml += '<div class="bg-green-900/30 border border-green-500/50 rounded-lg p-4 mb-3">';
                                resultsHtml += '<div class="flex items-center gap-3">';
                                resultsHtml += '<div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">';
                                resultsHtml += '<i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>';
                                resultsHtml += '</div>';
                                resultsHtml += '<div class="flex-1">';
                                resultsHtml += '<div class="text-green-400 font-semibold text-lg">' + serviceName + '</div>';
                                resultsHtml += '<div class="text-green-300 text-sm mt-1">✓ Chave válida e funcional</div>';
                                if (result.message) {
                                    resultsHtml += '<div class="text-green-200 text-xs mt-2">' + result.message + '</div>';
                                }
                                if (result.warning) {
                                    resultsHtml += '<div class="text-yellow-300 text-xs mt-2 flex items-start gap-1">';
                                    resultsHtml += '<i data-lucide="alert-triangle" class="w-3 h-3 mt-0.5 flex-shrink-0"></i>';
                                    resultsHtml += '<span>' + result.warning + '</span></div>';
                                }
                                resultsHtml += '</div></div></div>';
                            } else {
                                allValid = false;
                                invalidCount++;
                                resultsHtml += '<div class="bg-red-900/30 border border-red-500/50 rounded-lg p-4 mb-3">';
                                resultsHtml += '<div class="flex items-center gap-3">';
                                resultsHtml += '<div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0">';
                                resultsHtml += '<i data-lucide="x-circle" class="w-5 h-5 text-red-400"></i>';
                                resultsHtml += '</div>';
                                resultsHtml += '<div class="flex-1">';
                                resultsHtml += '<div class="text-red-400 font-semibold text-lg">' + serviceName + '</div>';
                                resultsHtml += '<div class="text-red-300 text-sm mt-1">✗ Chave inválida</div>';
                                if (result.error) {
                                    resultsHtml += '<div class="text-red-200 text-xs mt-2">' + result.error + '</div>';
                                }
                                resultsHtml += '</div></div></div>';
                            }
                        });

                        if (!hasResults) {
                            resultsHtml = '<div class="text-gray-300 text-center py-4">Nenhuma chave de API encontrada para validação.</div>';
                        }

                        // Usar modal centralizado para mostrar resultados com HTML
                        const modalType = allValid && hasResults ? 'success' : (invalidCount > 0 ? 'error' : 'info');
                        let modalTitle = 'Resultados da Validação';
                        if (allValid && hasResults) {
                            modalTitle = '✓ Validação Concluída (' + validCount + ' válida' + (validCount > 1 ? 's' : '') + ')';
                        } else if (invalidCount > 0) {
                            modalTitle = '⚠ Validação com Problemas (' + validCount + ' válida' + (validCount !== 1 ? 's' : '') + ', ' + invalidCount + ' inválida' + (invalidCount !== 1 ? 's' : '') + ')';
                        }
                        
                        console.log('[Validação] Mostrando modal:', {
                            title: modalTitle,
                            type: modalType,
                            htmlLength: resultsHtml.length,
                            htmlPreview: resultsHtml.substring(0, 300),
                            validCount: validCount,
                            invalidCount: invalidCount
                        });
                        
                        // Garantir que temos conteúdo HTML
                        if (!resultsHtml || resultsHtml.trim() === '') {
                            resultsHtml = '<div class="text-red-400">Erro: Nenhum resultado foi gerado.</div>';
                        }
                        
                        showCustomModalHTML(modalTitle, resultsHtml, modalType);

                    } catch (err) {
                        showCustomModal('Erro na Validação', err.message, 'error');
                    } finally {
                        setButtonLoading(validateButton, false);
                    }
                });
            }
            
            // --- LÓGICA DE PREFERÊNCIAS DO USUÁRIO ---
            async function loadUserPreferences() {
                try {
                    const response = await fetch(`${API_BASE}/api/user/preferences`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const checkbox = document.getElementById('pref-use-credits');
                        if (checkbox) {
                            checkbox.checked = data.use_credits_instead_of_own_api || false;
                            updatePreferenceStatus(data.use_credits_instead_of_own_api || false);
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar preferências:', err);
                }
            }
            
            async function saveUserPreference(useCredits) {
                try {
                    const response = await fetch(`${API_BASE}/api/user/preferences`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            use_credits_instead_of_own_api: useCredits
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao salvar preferência');
                    }
                    
                    return await response.json();
                } catch (err) {
                    console.error('Erro ao salvar preferência:', err);
                    throw err;
                }
            }
            
            function updatePreferenceStatus(useCredits) {
                const statusMessage = document.getElementById('pref-status-message');
                if (statusMessage) {
                    const statusText = statusMessage.querySelector('span');
                    if (statusText) {
                        if (useCredits) {
                            statusText.textContent = 'Preferência salva: O sistema usará seus créditos mesmo quando você tiver chaves de API próprias.';
                        } else {
                            statusText.textContent = 'Preferência salva: O sistema usará suas chaves de API próprias quando disponíveis.';
                        }
                        statusMessage.classList.remove('hidden');
                    }
                }
            }
            
            // Event listener para mudança imediata do checkbox
            const prefCheckbox = document.getElementById('pref-use-credits');
            if (prefCheckbox) {
                prefCheckbox.addEventListener('change', async (e) => {
                    try {
                        await saveUserPreference(e.target.checked);
                        updatePreferenceStatus(e.target.checked);
                    } catch (err) {
                        console.error('Erro ao salvar preferência:', err);
                        // Reverter checkbox em caso de erro
                        e.target.checked = !e.target.checked;
                    }
                });
            }
            
            // --- LÓGICA DE EXPLORAR NICHO ---
            const findSubnicheForm = document.getElementById('find-subniche-form');
            const analyzeCompetitorForm = document.getElementById('analyze-competitor-form');

            if (findSubnicheForm) {
                findSubnicheForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('btn-find-subniche');
                    const loading = document.getElementById('subniche-loading');
                    const resultsDiv = document.getElementById('subniche-results');
                    const errorMsg = document.getElementById('niche-error-message');
                    
                    const nichePrincipal = document.getElementById('niche-principal').value.trim();
                    const ideiaInicial = document.getElementById('ideia-inicial').value.trim();
                    const model = document.getElementById('niche-model-select').value;
                    
                    if (!nichePrincipal || !ideiaInicial) {
                        showMessage('niche-error-message', 'Por favor, preencha todos os campos.', true);
                        return;
                    }
                    
                    // Esconder mensagens de erro anteriores e mostrar loading
                    if (errorMsg) errorMsg.style.display = 'none';
                    if (loading) loading.style.display = 'block';
                    if (resultsDiv) resultsDiv.innerHTML = '';
                    
                    setButtonLoading(btn, true);

                    try {
                        // Verificar se laozhang.ai está configurada como padrão
                        let useLaozhang = false;
                        try {
                            const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                headers: { 'Authorization': `Bearer ${userToken}` }
                            });
                            if (settingsResponse.ok) {
                                const settings = await settingsResponse.json();
                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                            }
                        } catch (err) {
                            console.warn('[Find Subniche] Erro ao verificar configuração laozhang.ai:', err);
                        }
                        
                        const endpoint = useLaozhang ? '/api/niche/find-subniche/laozhang' : '/api/niche/find-subniche';
                        const selectedModel = document.getElementById('niche-model-select')?.value || model;
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                            body: JSON.stringify({ 
                                nichePrincipal, 
                                ideiaInicial, 
                                model: useLaozhang ? null : model,
                                selectedModel: selectedModel
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ msg: `Erro ${response.status}: ${response.statusText}` }));
                            throw new Error(errorData.msg || `Erro ao buscar subnichos: ${response.status}`);
                        }
                        
                        const data = await response.json();
                    
                    let recommendationContent = data.recommendation;
                    let escapedRec;
                    let contentHtml;

                    // Tentar parsear se for string JSON
                    if (typeof recommendationContent === 'string') {
                        try {
                            const parsed = JSON.parse(recommendationContent);
                            recommendationContent = parsed;
                        } catch (e) {
                            // Não é JSON, manter como string
                        }
                    }

                    if (typeof recommendationContent === 'object' && recommendationContent !== null) {
                        contentHtml = formatNicheRecommendation(recommendationContent);
                        escapedRec = JSON.stringify(recommendationContent, null, 2);
                    } else {
                        recommendationContent = String(recommendationContent);
                        contentHtml = `<div class="prose prose-invert max-w-none"><p class="text-gray-300 whitespace-pre-wrap">${recommendationContent.replace(/\n/g, '<br>')}</p></div>`;
                        escapedRec = recommendationContent.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    }

                    resultsDiv.innerHTML = `
                        <div class="relative">
                            <button title="Copiar Sugestão" class="btn-copy absolute top-2 right-2 z-10 p-2 rounded-md hover:bg-gray-800 text-gray-400 hover:text-amber-500 transition" data-copy-text='${escapedRec}'>
                                <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <div class="pr-12">
                                ${contentHtml}
                            </div>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                } catch (err) {
                    showMessage('niche-error-message', err.message, true);
                } finally {
                    setButtonLoading(btn, false);
                    loading.style.display = 'none';
                }
                });
            }

            if (analyzeCompetitorForm) {
                analyzeCompetitorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-analyze-competitor');
                const loading = document.getElementById('competitor-loading');
                const resultsDiv = document.getElementById('competitor-analysis-results');

                setButtonLoading(btn, true);
                loading.style.display = 'block';
                resultsDiv.innerHTML = '';
                showMessage('niche-error-message', '', true);

                const competitorUrl = document.getElementById('competitor-url').value;
                const model = document.getElementById('competitor-model-select').value;

                try {
                    // Verificar se laozhang.ai está configurada como padrão
                    let useLaozhang = false;
                    try {
                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (settingsResponse.ok) {
                            const settings = await settingsResponse.json();
                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                        }
                    } catch (err) {
                        console.warn('[Analyze Competitor] Erro ao verificar configuração laozhang.ai:', err);
                    }
                    
                    const endpoint = useLaozhang ? '/api/niche/analyze-competitor/laozhang' : '/api/niche/analyze-competitor';
                    const selectedModel = document.getElementById('competitor-model-select')?.value || model;
                    
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ 
                            competitorUrl, 
                            model: useLaozhang ? null : model,
                            selectedModel: selectedModel
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.msg);

                    // Se a resposta vier com 'analysis' wrapper, extrair
                    const analysisData = data.analysis || data;
                    
                    let html = '';
                    let textToCopy = '';
                    
                    // Formatação melhorada para análise de competidor
                    const formatCompetitorAnalysis = (data) => {
                        let html = '<div class="space-y-6">';
                        
                        // Content Strategies
                        if (data.content_strategies) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">📹 Estratégias de Conteúdo</h3>
                                    ${data.content_strategies.overview ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Visão Geral:</strong> ${data.content_strategies.overview}</p>` : ''}
                                    ${data.content_strategies.playlist_strategy ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Estratégia de Playlists:</strong> ${data.content_strategies.playlist_strategy}</p>` : ''}
                                    ${data.content_strategies.storytelling ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Storytelling:</strong> ${data.content_strategies.storytelling}</p>` : ''}
                                    ${data.content_strategies.engagement_tactics ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Táticas de Engajamento:</strong> ${data.content_strategies.engagement_tactics}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Title and Thumbnail Patterns
                        if (data.title_and_thumbnail_patterns) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">🎨 Padrões de Títulos e Thumbnails</h3>
                                    ${data.title_and_thumbnail_patterns.title_patterns ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Padrões de Títulos:</strong> ${data.title_and_thumbnail_patterns.title_patterns}</p>` : ''}
                                    ${data.title_and_thumbnail_patterns.thumbnail_patterns ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Padrões de Thumbnails:</strong> ${data.title_and_thumbnail_patterns.thumbnail_patterns}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Posting Frequency
                        if (data.posting_frequency) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">📅 Frequência de Postagem</h3>
                                    ${data.posting_frequency.current_frequency ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Frequência Atual:</strong> ${data.posting_frequency.current_frequency}</p>` : ''}
                                    ${data.posting_frequency.recommendation ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Recomendação:</strong> ${data.posting_frequency.recommendation}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Niche and Subniches
                        if (data.niche_and_subniches) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">🎯 Nicho e Subnichos</h3>
                                    ${data.niche_and_subniches.primary_niche ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Nicho Principal:</strong> ${data.niche_and_subniches.primary_niche}</p>` : ''}
                                    ${data.niche_and_subniches.subniches && Array.isArray(data.niche_and_subniches.subniches) ? `
                                        <div>
                                            <strong class="text-white">Subnichos:</strong>
                                            <ul class="list-disc list-inside space-y-1 pl-4 mt-2">
                                                ${data.niche_and_subniches.subniches.map(sub => `<li class="text-gray-300">${sub}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }
                        
                        // Differentiation Opportunities
                        if (data.differentiation_opportunities) {
                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-6 border border-gray-700">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">💡 Oportunidades de Diferenciação</h3>
                                    ${data.differentiation_opportunities.live_interactions ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Interações ao Vivo:</strong> ${data.differentiation_opportunities.live_interactions}</p>` : ''}
                                    ${data.differentiation_opportunities.exclusive_interviews ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Entrevistas Exclusivas:</strong> ${data.differentiation_opportunities.exclusive_interviews}</p>` : ''}
                                    ${data.differentiation_opportunities.collaborations ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Colaborações:</strong> ${data.differentiation_opportunities.collaborations}</p>` : ''}
                                    ${data.differentiation_opportunities.content_gaps ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Lacunas de Conteúdo:</strong> ${data.differentiation_opportunities.content_gaps}</p>` : ''}
                                    ${data.differentiation_opportunities.unique_angles ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Ângulos Únicos:</strong> ${data.differentiation_opportunities.unique_angles}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        // Strategic Recommendations
                        if (data.strategic_recommendations) {
                            html += `
                                <div class="bg-gradient-to-r from-amber-900/30 to-amber-800/20 rounded-lg p-6 border border-amber-700/50">
                                    <h3 class="text-2xl font-bold text-amber-400 mb-4">🚀 Recomendações Estratégicas</h3>
                                    ${data.strategic_recommendations.channel_name_suggestions && Array.isArray(data.strategic_recommendations.channel_name_suggestions) ? `
                                        <div class="mb-4">
                                            <strong class="text-white">Sugestões de Nome do Canal:</strong>
                                            <ul class="list-disc list-inside space-y-1 pl-4 mt-2">
                                                ${data.strategic_recommendations.channel_name_suggestions.map(name => `<li class="text-gray-300">${name}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${data.strategic_recommendations.first_videos_ideas && Array.isArray(data.strategic_recommendations.first_videos_ideas) ? `
                                        <div class="mb-4">
                                            <strong class="text-white">Ideias para Primeiros Vídeos:</strong>
                                            <ul class="list-disc list-inside space-y-1 pl-4 mt-2">
                                                ${data.strategic_recommendations.first_videos_ideas.map(idea => `<li class="text-gray-300">${idea}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${data.strategic_recommendations.growth_strategy ? `<p class="text-gray-300 mb-3 leading-relaxed"><strong class="text-white">Estratégia de Crescimento:</strong> ${data.strategic_recommendations.growth_strategy}</p>` : ''}
                                    ${data.strategic_recommendations.monetization_opportunities ? `<p class="text-gray-300 leading-relaxed"><strong class="text-white">Oportunidades de Monetização:</strong> ${data.strategic_recommendations.monetization_opportunities}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        html += '</div>';
                        return html;
                    };
                    
                    // Usar formatação melhorada se os dados seguirem o formato esperado
                    if (analysisData.content_strategies || analysisData.title_and_thumbnail_patterns || analysisData.differentiation_opportunities) {
                        html = formatCompetitorAnalysis(analysisData);
                        textToCopy = JSON.stringify(analysisData, null, 2);
                    } else {
                        // Fallback para formatação genérica
                        for (const key in analysisData) {
                            const title = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            html += `<div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700 mb-4"><h3 class="text-xl font-semibold text-amber-400 mb-3">${title}</h3>`;
                            const value = analysisData[key];
                            
                            if (typeof value === 'object' && value !== null) {
                                html += renderObjectAsList(value);
                            } else {
                                html += `<p class="text-gray-300 leading-relaxed">${value}</p>`;
                            }
                            html += '</div>';
                        }
                        textToCopy = JSON.stringify(analysisData, null, 2);
                    }
                    const escapedText = textToCopy.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    
                    resultsDiv.innerHTML = `
                        <div class="relative">
                            <button title="Copiar Análise Completa" class="btn-copy absolute top-2 right-2 z-10 p-2 rounded-md hover:bg-gray-800 text-gray-400 hover:text-amber-500 transition" data-copy-text='${escapedText}'>
                                <i data-lucide="copy" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <div class="pr-12">
                                ${html}
                            </div>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                } catch (err) {
                    showMessage('niche-error-message', err.message, true);
                } finally {
                    setButtonLoading(btn, false);
                    loading.style.display = 'none';
                }
                });
            }


            // --- LÓGICA DE LOGOUT ---
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('core_token');
                    window.location.href = 'la-casa-dark-core-auth.html';
                });
            }
            
            // --- LÓGICA DE COPIAR PARA CLIPBOARD (Event Delegation) ---
            document.body.addEventListener('click', async (e) => {
                const copyBtn = e.target.closest('.btn-copy');
                if (!copyBtn) return;

                const textToCopy = copyBtn.dataset.copyText;
                if (textToCopy) {
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        
                        const originalIcon = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-500"></i>';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        
                        setTimeout(() => {
                            copyBtn.innerHTML = originalIcon;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }, 2000);

                    } catch (err) {
                        console.error('Falha ao copiar texto: ', err);
                        alert('Não foi possível copiar o texto.');
                    }
                }
            });
            
            // --- FUNÇÕES DO DASHBOARD INICIAL ---
            function formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toLocaleString('pt-BR');
            }
            
            // Variável para controlar o intervalo de atualização automática
            let dashboardAutoRefreshInterval = null;
            
            // Função para iniciar atualização automática do dashboard
            function startDashboardAutoRefresh() {
                // Limpar intervalo anterior se existir
                if (dashboardAutoRefreshInterval) {
                    clearInterval(dashboardAutoRefreshInterval);
                }
                
                // Atualizar a cada 10 segundos quando a tela de início estiver visível
                dashboardAutoRefreshInterval = setInterval(() => {
                    const inicioView = document.getElementById('view-inicio');
                    if (inicioView && inicioView.style.display !== 'none') {
                        console.log('[Dashboard] Atualização automática...');
                        loadDashboard();
                    }
                }, 10000); // 10 segundos
            }
            
            // Função para parar atualização automática
            function stopDashboardAutoRefresh() {
                if (dashboardAutoRefreshInterval) {
                    clearInterval(dashboardAutoRefreshInterval);
                    dashboardAutoRefreshInterval = null;
                }
            }

            // Função para carregar saldo de créditos
            async function loadCreditsBalance() {
                try {
                    console.log('[CRÉDITOS] Carregando saldo de créditos...');
                    const response = await fetch(`${API_BASE}/api/credits/balance`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) {
                        console.error('[CRÉDITOS] Erro ao carregar saldo:', response.status, response.statusText);
                        const errorText = await response.text();
                        console.error('[CRÉDITOS] Resposta do erro:', errorText);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('[CRÉDITOS] Saldo recebido:', data);
                    const creditsBalanceEl = document.getElementById('stat-credits-balance');
                    if (creditsBalanceEl) {
                        creditsBalanceEl.textContent = parseFloat(data.balance || 0).toFixed(2);
                        console.log('[CRÉDITOS] Saldo atualizado no elemento:', parseFloat(data.balance || 0).toFixed(2));
                    } else {
                        console.error('[CRÉDITOS] Elemento stat-credits-balance não encontrado!');
                    }
                    
                    // Atualizar também no sidebar se existir
                    const sidebarCreditsEl = document.getElementById('sidebar-user-credits-balance');
                    if (sidebarCreditsEl) {
                        sidebarCreditsEl.textContent = parseFloat(data.balance || 0).toFixed(2);
                    }
                    
                    // Carregar armazenamento se disponível
                    if (data.storageUsed !== undefined && data.storageLimit !== undefined) {
                        console.log('[STORAGE] Dados recebidos:', {
                            storageUsed: data.storageUsed,
                            storageLimit: data.storageLimit,
                            storageUsedMB: (data.storageUsed / (1024 * 1024)).toFixed(2),
                            storageLimitGB: (data.storageLimit / (1024 * 1024 * 1024)).toFixed(2)
                        });
                        updateStorageDisplay(data.storageUsed, data.storageLimit);
                        updateSidebarStorage(data.storageUsed, data.storageLimit);
                    } else {
                        console.warn('[STORAGE] Dados de armazenamento não disponíveis na resposta:', data);
                    }
                } catch (err) {
                    console.error('[CRÉDITOS] Erro ao carregar saldo de créditos:', err);
                }
            }
            
            // Função para carregar plano atual do usuário
            async function loadCurrentPlan() {
                try {
                    console.log('[PLANO] Carregando plano atual...');
                    const response = await fetch(`${API_BASE}/api/user/permissions`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) {
                        console.error('[PLANO] Erro ao carregar plano:', response.status, response.statusText);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('[PLANO] Plano recebido:', data);
                    
                    const planName = data.plan || 'plan-free';
                    const planDisplayName = getPlanDisplayName(planName);
                    
                    const sidebarPlanEl = document.getElementById('sidebar-current-plan');
                    if (sidebarPlanEl) {
                        sidebarPlanEl.textContent = planDisplayName;
                    }
                } catch (err) {
                    console.error('[PLANO] Erro ao carregar plano:', err);
                    const sidebarPlanEl = document.getElementById('sidebar-current-plan');
                    if (sidebarPlanEl) {
                        sidebarPlanEl.textContent = 'Erro ao carregar';
                    }
                }
            }
            
            // Função para obter nome amigável do plano
            function getPlanDisplayName(planKey) {
                const planNames = {
                    'plan-free': 'FREE',
                    'plan-start': 'START CREATOR',
                    'plan-turbo': 'TURBO MAKER',
                    'plan-master': 'MASTER PRO',
                    'plan-start-annual': 'START CREATOR Anual',
                    'plan-turbo-annual': 'TURBO MAKER Anual',
                    'plan-master-annual': 'MASTER PRO Anual',
                    'admin': 'ADMIN'
                };
                return planNames[planKey] || planKey.toUpperCase().replace('PLAN-', '').replace(/-/g, ' ');
            }
            
            // Função para atualizar exibição de armazenamento
            function updateStorageDisplay(used, limit) {
                // Garantir que os valores são números
                used = Number(used) || 0;
                limit = Number(limit) || 0;
                
                console.log('[STORAGE] Atualizando display principal:', { used, limit, usedMB: (used / (1024 * 1024)).toFixed(2) });
                
                const usedMB = (used / (1024 * 1024)).toFixed(2);
                const limitMB = (limit / (1024 * 1024)).toFixed(0);
                const limitGB = (limit / (1024 * 1024 * 1024)).toFixed(1);
                const percentage = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
                
                const storageUsedEl = document.getElementById('stat-storage-used');
                const storageLimitEl = document.getElementById('stat-storage-limit');
                const storageProgressEl = document.getElementById('stat-storage-progress');
                const storagePercentageEl = document.getElementById('stat-storage-percentage');
                
                console.log('[STORAGE] Elementos encontrados:', {
                    storageUsedEl: !!storageUsedEl,
                    storageLimitEl: !!storageLimitEl,
                    storageProgressEl: !!storageProgressEl,
                    storagePercentageEl: !!storagePercentageEl
                });
                
                if (storageUsedEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        // Mostrar em GB se for >= 1GB
                        storageUsedEl.textContent = `${(used / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                    } else {
                        storageUsedEl.textContent = `${usedMB} MB`;
                    }
                }
                
                if (storageLimitEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        storageLimitEl.textContent = `de ${limitGB} GB`;
                    } else {
                        storageLimitEl.textContent = `de ${limitMB} MB`;
                    }
                }
                
                if (storageProgressEl) {
                    storageProgressEl.style.width = `${percentage}%`;
                    // Mudar cor baseado no uso
                    if (percentage >= 90) {
                        storageProgressEl.className = 'bg-red-500 h-2 rounded-full transition-all duration-300';
                    } else if (percentage >= 70) {
                        storageProgressEl.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
                    } else {
                        storageProgressEl.className = 'bg-indigo-500 h-2 rounded-full transition-all duration-300';
                    }
                }
                
                if (storagePercentageEl) {
                    storagePercentageEl.textContent = `${percentage.toFixed(1)}% usado`;
                }
            }
            
            // Função para atualizar armazenamento no sidebar
            function updateSidebarStorage(used, limit) {
                // Garantir que os valores são números
                used = Number(used) || 0;
                limit = Number(limit) || 0;
                
                console.log('[STORAGE] Atualizando sidebar:', { used, limit, usedMB: (used / (1024 * 1024)).toFixed(2) });
                
                const usedMB = (used / (1024 * 1024)).toFixed(2);
                const limitMB = (limit / (1024 * 1024)).toFixed(0);
                const limitGB = (limit / (1024 * 1024 * 1024)).toFixed(1);
                const percentage = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
                
                const sidebarUsedEl = document.getElementById('sidebar-storage-used');
                const sidebarLimitEl = document.getElementById('sidebar-storage-limit');
                const sidebarProgressEl = document.getElementById('sidebar-storage-progress');
                
                console.log('[STORAGE] Elementos encontrados:', {
                    sidebarUsedEl: !!sidebarUsedEl,
                    sidebarLimitEl: !!sidebarLimitEl,
                    sidebarProgressEl: !!sidebarProgressEl
                });
                
                if (sidebarUsedEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        const usedGB = (used / (1024 * 1024 * 1024)).toFixed(2);
                        sidebarUsedEl.textContent = `${usedGB} GB`;
                        console.log('[STORAGE] Sidebar usado atualizado para:', `${usedGB} GB`);
                    } else {
                        sidebarUsedEl.textContent = `${usedMB} MB`;
                        console.log('[STORAGE] Sidebar usado atualizado para:', `${usedMB} MB`);
                    }
                } else {
                    console.error('[STORAGE] Elemento sidebar-storage-used não encontrado!');
                }
                
                if (sidebarLimitEl) {
                    if (limit >= 1024 * 1024 * 1024) {
                        sidebarLimitEl.textContent = `de ${limitGB} GB`;
                        console.log('[STORAGE] Sidebar limite atualizado para:', `de ${limitGB} GB`);
                    } else {
                        sidebarLimitEl.textContent = `de ${limitMB} MB`;
                        console.log('[STORAGE] Sidebar limite atualizado para:', `de ${limitMB} MB`);
                    }
                } else {
                    console.error('[STORAGE] Elemento sidebar-storage-limit não encontrado!');
                }
                
                if (sidebarProgressEl) {
                    sidebarProgressEl.style.width = `${percentage}%`;
                    console.log('[STORAGE] Sidebar progress atualizado para:', `${percentage}%`);
                    if (percentage >= 90) {
                        sidebarProgressEl.className = 'bg-red-500 h-1.5 rounded-full transition-all duration-300';
                    } else if (percentage >= 70) {
                        sidebarProgressEl.className = 'bg-yellow-500 h-1.5 rounded-full transition-all duration-300';
                    } else {
                        sidebarProgressEl.className = 'bg-indigo-500 h-1.5 rounded-full transition-all duration-300';
                    }
                }
            }
            
            // Função para carregar histórico de créditos
            async function loadCreditsHistory() {
                try {
                    const response = await fetch(`${API_BASE}/api/credits/transactions`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    
                    if (!response.ok) throw new Error('Erro ao carregar histórico');
                    
                    const data = await response.json();
                    const transactions = data.data || [];
                    
                    // Criar modal com histórico
                    const modalHtml = `
                        <div id="credits-history-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-xl font-bold text-white">Histórico de Créditos</h3>
                                    <button id="close-credits-history-modal" class="text-gray-400 hover:text-white">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                <div id="credits-history-list" class="space-y-3">
                                    ${transactions.length === 0 
                                        ? '<p class="text-gray-400 text-center py-8">Nenhuma transação encontrada</p>'
                                        : transactions.map(t => {
                                            const isCredit = t.isCredit || t.transaction_type === 'credit' || t.transaction_type === 'refund' || (t.amount && t.amount > 0);
                                            const amount = Math.abs(parseFloat(t.amount || 0));
                                            const date = new Date(t.created_at);
                                            
                                            // Informações da operação
                                            let operationDetails = '';
                                            if (t.operation) {
                                                const op = t.operation;
                                                operationDetails = `
                                                    <div class="mt-2 pt-2 border-t border-gray-700">
                                                        <div class="flex flex-wrap gap-2 text-xs">
                                                            ${op.typeName ? `<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">${op.typeName}</span>` : ''}
                                                            ${op.model && op.model !== 'N/A' ? `<span class="px-2 py-1 bg-purple-500/20 text-purple-400 rounded">${op.model}</span>` : ''}
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                            
                                            return `
                                                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition">
                                                    <div class="flex justify-between items-start">
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span class="text-lg font-bold ${isCredit ? 'text-green-400' : 'text-red-400'}">
                                                                    ${isCredit ? '+' : '-'} ${amount.toFixed(2)} créditos
                                                                </span>
                                                                ${isCredit 
                                                                    ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded">Crédito</span>'
                                                                    : '<span class="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded">Débito</span>'
                                                                }
                                                            </div>
                                                            <p class="text-white font-medium mb-1">${t.description || 'Transação'}</p>
                                                            ${operationDetails}
                                                            <p class="text-gray-500 text-xs mt-2">
                                                                <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                                                ${date.toLocaleString('pt-BR', { 
                                                                    day: '2-digit', 
                                                                    month: '2-digit', 
                                                                    year: 'numeric',
                                                                    hour: '2-digit',
                                                                    minute: '2-digit'
                                                                })}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                    document.getElementById('close-credits-history-modal')?.addEventListener('click', () => {
                        document.getElementById('credits-history-modal')?.remove();
                    });
                } catch (error) {
                    console.error('Erro ao carregar histórico:', error);
                }
            }
            
            // Event listener para ver histórico de créditos
            const viewCreditsHistoryBtn = document.getElementById('view-credits-history-btn');
            if (viewCreditsHistoryBtn) {
                viewCreditsHistoryBtn.addEventListener('click', async () => {
                    await loadCreditsHistory();
                });
            }
            
            // Event listeners para botões de comprar créditos
            const sidebarBuyCreditsBtn = document.getElementById('sidebar-buy-credits-btn');
            if (sidebarBuyCreditsBtn) {
                sidebarBuyCreditsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Simplesmente redirecionar - a página de planos fará a verificação se necessário
                    console.log('Redirecionando para página de planos...');
                    window.location.href = '/plans.html#pacotes';
                });
            }
            
            const mainBuyCreditsBtn = document.getElementById('main-buy-credits-btn');
            if (mainBuyCreditsBtn) {
                mainBuyCreditsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Simplesmente redirecionar - a página de planos fará a verificação se necessário
                    console.log('Redirecionando para página de planos...');
                    window.location.href = '/plans.html#pacotes';
                });
            }
            
            // Event listener para histórico no sidebar
            const sidebarViewCreditsHistory = document.getElementById('sidebar-view-credits-history');
            if (sidebarViewCreditsHistory) {
                sidebarViewCreditsHistory.addEventListener('click', async () => {
                    await loadCreditsHistory();
                });
            }
            
            // Event listener para botão de upgrade no sidebar
            const sidebarUpgradePlanBtn = document.getElementById('sidebar-upgrade-plan-btn');
            if (sidebarUpgradePlanBtn) {
                sidebarUpgradePlanBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Redirecionar para página de planos
                    console.log('Redirecionando para página de planos...');
                    window.location.href = '/plans.html#pacotes';
                });
            }
            

            async function loadDashboard() {
                try {
                    // 1) Priorizar dados do canal YouTube principal (canal configurado)
                    let ytData = null;
                    try {
                        const ytToken = localStorage.getItem('core_token') || userToken;
                        const chResp = await fetch(`${API_BASE}/api/youtube/channels`, {
                            headers: { 'Authorization': `Bearer ${ytToken}` }
                        });
                        if (chResp.ok) {
                            const chJson = await chResp.json();
                            const channels = chJson.channels || [];
                            if (channels.length > 0) {
                                const preferredId = localStorage.getItem('primary_youtube_integration_id');
                                const chosen = preferredId ? (channels.find(c => String(c.id) === String(preferredId)) || channels[0]) : channels[0];
                                const endDate = new Date();
                                const startDate = new Date(Date.now() - 28 * 24 * 60 * 60 * 1000);
                                const aResp = await fetch(`${API_BASE}/api/youtube/channels/${chosen.id}/analytics?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`, {
                                    headers: { 'Authorization': `Bearer ${ytToken}` }
                                });
                                if (aResp.ok) {
                                    ytData = await aResp.json();
                                }
                            }
                        }
                    } catch (e) {
                        ytData = null;
                    }

                    // 2) Ainda carregar dashboard interno (para créditos, próximos passos etc.)
                    const response = await fetch(`${API_BASE}/api/analytics/dashboard`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const data = response.ok ? await response.json() : { stats: {}, recentVideos: [] };
                    
                    // Atualizar estatísticas principais (com verificação de existência)
                    const statTotalVideos = document.getElementById('stat-total-videos');
                    const statTotalViews = document.getElementById('stat-total-views');
                    const statTotalRevenue = document.getElementById('stat-total-revenue');
                    const statViralVideos = document.getElementById('stat-viral-videos');
                    
                    // Se tiver dados do YouTube, preencher baseado no canal
                    if (ytData?.analytics?.rows?.length && ytData?.analytics?.columnHeaders?.length) {
                        const row = ytData.analytics.rows[0];
                        const headers = ytData.analytics.columnHeaders.map(h => h.name);
                        const get = (name) => {
                            const idx = headers.findIndex(h => h === name);
                            return idx >= 0 ? row[idx] : null;
                        };
                        const views = parseInt(get('views') || 0);
                        const likes = parseInt(get('likes') || 0);
                        const comments = parseInt(get('comments') || 0);
                        const revenue = parseFloat(ytData.estimatedRevenue || ytData.estimatedAdRevenue || 0);
                        const videoCount = parseInt(ytData.channelStats?.videoCount || 0);
                        const viral = (ytData.topVideosAnalysis || []).filter(v => (v.viewCount || 0) >= 1000000).length;

                        if (statTotalVideos) statTotalVideos.textContent = formatNumber(videoCount || 0);
                        if (statTotalViews) statTotalViews.textContent = formatNumber(views || 0);
                        if (statTotalRevenue) statTotalRevenue.textContent = '$' + formatNumber(Math.round(revenue || 0));
                        if (statViralVideos) statViralVideos.textContent = formatNumber(viral || 0);

                        // Métricas adicionais
                        const statAvgCtr = document.getElementById('stat-avg-ctr');
                        const statTotalLikes = document.getElementById('stat-total-likes');
                        const statTotalComments = document.getElementById('stat-total-comments');
                        const statAvgRpm = document.getElementById('stat-avg-rpm');
                        if (statAvgCtr) statAvgCtr.textContent = (ytData.advanced?.impressionsCtr ? ytData.advanced.impressionsCtr.toFixed(2) : 0).toFixed(1) + '%';
                        if (statTotalLikes) statTotalLikes.textContent = formatNumber(likes || 0);
                        if (statTotalComments) statTotalComments.textContent = formatNumber(comments || 0);
                        const rpm = views > 0 && revenue > 0 ? (revenue / (views / 1000)) : 0;
                        if (statAvgRpm) statAvgRpm.textContent = '$' + (rpm || 0).toFixed(2);
                    } else {
                        // fallback: dashboard interno
                        if (statTotalVideos) statTotalVideos.textContent = formatNumber(data.stats.totalVideos || 0);
                        if (statTotalViews) statTotalViews.textContent = formatNumber(data.stats.totalViews || 0);
                        if (statTotalRevenue) statTotalRevenue.textContent = '$' + formatNumber(Math.round(data.stats.totalRevenue || 0));
                        if (statViralVideos) statViralVideos.textContent = formatNumber(data.stats.viralVideos || 0);
                    }
                    
                    // Atualizar status dos cards
                    const statVideosStatus = document.getElementById('stat-videos-status');
                    const statViewsStatus = document.getElementById('stat-views-status');
                    const statRevenueStatus = document.getElementById('stat-revenue-status');
                    
                    if (statVideosStatus) {
                        statVideosStatus.textContent = (data.stats.totalVideos || 0) > 0 ? 'ATIVO' : 'SEM DADOS';
                        statVideosStatus.className = (data.stats.totalVideos || 0) > 0 
                            ? 'absolute top-3 right-3 text-xs font-semibold text-green-400 uppercase tracking-wider' 
                            : 'absolute top-3 right-3 text-xs font-semibold text-gray-500 uppercase tracking-wider';
                    }
                    if (statViewsStatus) {
                        statViewsStatus.textContent = (data.stats.totalViews || 0) > 0 ? 'ATIVO' : 'SEM DADOS';
                        statViewsStatus.className = (data.stats.totalViews || 0) > 0 
                            ? 'absolute top-3 right-3 text-xs font-semibold text-green-400 uppercase tracking-wider' 
                            : 'absolute top-3 right-3 text-xs font-semibold text-gray-500 uppercase tracking-wider';
                    }
                    if (statRevenueStatus) {
                        statRevenueStatus.textContent = (data.stats.totalRevenue || 0) > 0 ? 'ATIVO' : 'SEM DADOS';
                        statRevenueStatus.className = (data.stats.totalRevenue || 0) > 0 
                            ? 'absolute top-3 right-3 text-xs font-semibold text-green-400 uppercase tracking-wider' 
                            : 'absolute top-3 right-3 text-xs font-semibold text-gray-500 uppercase tracking-wider';
                    }
                    
                    // Carregar saldo de créditos
                    loadCreditsBalance();
                    loadCurrentPlan();
                    
                    // (métricas adicionais são preenchidas acima quando ytData existe; se não, já vem do interno)
                    if (!ytData?.analytics?.rows?.length) {
                        const statAvgCtr = document.getElementById('stat-avg-ctr');
                        const statTotalLikes = document.getElementById('stat-total-likes');
                        const statTotalComments = document.getElementById('stat-total-comments');
                        const statAvgRpm = document.getElementById('stat-avg-rpm');
                        if (statAvgCtr) statAvgCtr.textContent = (data.stats.avgCtr || 0).toFixed(1) + '%';
                        if (statTotalLikes) statTotalLikes.textContent = formatNumber(data.stats.totalLikes || 0);
                        if (statTotalComments) statTotalComments.textContent = formatNumber(data.stats.totalComments || 0);
                        if (statAvgRpm) statAvgRpm.textContent = '$' + (data.stats.rpmUSD || 0).toFixed(2);
                    }
                    
                    // Carregar vídeos recentes
                    if (ytData?.topVideosAnalysis?.length) {
                        // Reaproveitar UI com adaptação rápida
                        const mapped = ytData.topVideosAnalysis.slice(0, 5).map(v => ({
                            title_used: v.title,
                            actual_views: v.viewCount,
                            actual_ctr: ytData.advanced?.impressionsCtr || 0,
                            revenue_estimate: 0,
                            channel_name: ytData.channelSnippet?.title || 'YouTube'
                        }));
                        loadRecentVideos(mapped);
                    } else {
                        loadRecentVideos(data.recentVideos || []);
                    }
                    
                    // Carregar atividade recente
                    loadRecentActivity(data);
                    
                    // Gerar dicas da IA
                    generateAITips(data);
                    
                    // Gerar próximos passos
                    generateNextSteps(data);
                    
                } catch (err) {
                    console.error('Erro ao carregar dashboard:', err);
                }
            }

            function loadRecentVideos(videos) {
                const container = document.getElementById('recent-videos');
                if (!container) return;
                
                if (!videos || videos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i data-lucide="video-off" class="w-12 h-12 mx-auto mb-3 text-gray-600"></i>
                            <p class="text-sm">Nenhuma execução registrada</p>
                            <p class="text-xs mt-2 text-gray-500">Inicie uma análise para alimentar o núcleo operacional</p>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }
                
                const videosHtml = videos.slice(0, 5).map(video => {
                    const views = formatNumber(video.actual_views || 0);
                    const ctr = (video.actual_ctr || 0).toFixed(1);
                    const revenue = video.revenue_estimate ? '$' + formatNumber(Math.round(video.revenue_estimate)) : 'N/A';
                    const channelName = video.channel_name || 'Canal Desconhecido';
                    
                    return `
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-amber-500/50 transition-colors">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-white font-semibold mb-2 line-clamp-2">${(video.title_used || 'Sem título').substring(0, 60)}${(video.title_used || '').length > 60 ? '...' : ''}</h4>
                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-400">
                                        <span><i data-lucide="eye" class="w-3 h-3 inline mr-1"></i>${views} views</span>
                                        <span><i data-lucide="trending-up" class="w-3 h-3 inline mr-1"></i>${ctr}% CTR</span>
                                        <span><i data-lucide="dollar-sign" class="w-3 h-3 inline mr-1"></i>${revenue}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">${channelName}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = videosHtml;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function loadRecentActivity(data) {
                const container = document.getElementById('recent-activity');
                if (!container) return;
                
                const activities = [];
                
                if (data.stats.totalVideos > 0) {
                    activities.push({
                        icon: 'video',
                        text: `${data.stats.totalVideos} vídeo${data.stats.totalVideos > 1 ? 's' : ''} analisado${data.stats.totalVideos > 1 ? 's' : ''}`,
                        time: 'Total'
                    });
                }
                
                if (data.stats.viralVideos > 0) {
                    activities.push({
                        icon: 'trending-up',
                        text: `${data.stats.viralVideos} vídeo${data.stats.viralVideos > 1 ? 's' : ''} viral${data.stats.viralVideos > 1 ? 'is' : ''} (1M+ views)`,
                        time: 'Destaque'
                    });
                }
                
                if (data.stats.totalViews > 0) {
                    activities.push({
                        icon: 'eye',
                        text: `${formatNumber(data.stats.totalViews)} views acumuladas`,
                        time: 'Total'
                    });
                }
                
                if (data.stats.totalRevenue > 0) {
                    activities.push({
                        icon: 'dollar-sign',
                        text: `$${formatNumber(data.stats.totalRevenue)} em receita estimada`,
                        time: 'Total'
                    });
                }
                
                if (activities.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-4">
                            <i data-lucide="activity" class="w-8 h-8 mx-auto mb-2 text-gray-600"></i>
                            <p class="text-sm">Nenhum registro operacional ainda.</p>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }
                
                const activitiesHtml = activities.map(activity => `
                    <div class="flex items-center space-x-3 p-3 bg-gray-800 rounded-lg">
                        <div class="p-2 bg-amber-500/20 rounded-lg">
                            <i data-lucide="${activity.icon}" class="w-4 h-4 text-amber-500"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-white">${activity.text}</p>
                            <p class="text-xs text-gray-400">${activity.time}</p>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = activitiesHtml;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            async function generateAITips(data) {
                const container = document.getElementById('ai-tips');
                if (!container) return;
                
                const tips = [];
                const stats = data.stats || {};
                const recentVideos = data.recentVideos || [];
                
                // === ANÁLISE DE PERFORMANCE GERAL ===
                if (stats.totalVideos === 0) {
                    tips.push({
                        type: 'info',
                        icon: 'lightbulb',
                        title: '🚀 Comece Sua Jornada Viral',
                        text: 'Você ainda não analisou nenhum vídeo. Use o Analisador de Vídeos para descobrir os segredos por trás de vídeos que geraram milhões de views. Analise pelo menos 5-10 vídeos virais do seu nicho para entender os padrões de sucesso.'
                    });
                } else if (stats.totalVideos < 5) {
                    tips.push({
                        type: 'success',
                        icon: 'rocket',
                        title: '📈 Bom Começo! Continue Acelerando',
                        text: `Você já analisou ${stats.totalVideos} vídeo${stats.totalVideos > 1 ? 's' : ''}. Para maximizar seus resultados, analise pelo menos 10 vídeos virais do seu nicho. Isso ajudará a IA a entender melhor os padrões de sucesso e gerar títulos mais precisos.`
                    });
                } else if (stats.totalVideos < 20) {
                    tips.push({
                        type: 'success',
                        icon: 'trending-up',
                        title: '💪 Você Está no Caminho Certo!',
                        text: `Excelente! Você já analisou ${stats.totalVideos} vídeos. Analise mais 10-15 vídeos para criar uma base sólida de dados. Quanto mais vídeos você analisar, mais precisas serão as recomendações da IA.`
                    });
                }
                
                // === ANÁLISE DE CTR DETALHADA ===
                if (stats.avgCtr > 0) {
                    if (stats.avgCtr < 3) {
                        tips.push({
                            type: 'warning',
                            icon: 'alert-triangle',
                            title: '⚠️ CTR Crítico: Ação Imediata Necessária',
                            text: `Seu CTR médio é ${stats.avgCtr.toFixed(1)}%, que está MUITO abaixo do ideal (10%+). Ações urgentes: 1) Use títulos com números e perguntas, 2) Thumbnails com rostos humanos e expressões intensas, 3) Palavras poderosas como "SECRETO", "REVELADO", "PROIBIDO", 4) Teste A/B com 5-10 variações antes de publicar.`
                        });
                    } else if (stats.avgCtr < 5) {
                        tips.push({
                            type: 'warning',
                            icon: 'alert-circle',
                            title: '📊 CTR Pode Melhorar Significativamente',
                            text: `Seu CTR médio é ${stats.avgCtr.toFixed(1)}% (meta: 10%+). Estratégias: 1) Títulos entre 40-60 caracteres com números, 2) Thumbnails com alto contraste e cores vibrantes, 3) Use a função "Validação de Título" antes de publicar, 4) Analise seus vídeos de maior CTR e replique os padrões.`
                        });
                    } else if (stats.avgCtr < 8) {
                        tips.push({
                            type: 'info',
                            icon: 'target',
                            title: '🎯 CTR Bom, Mas Pode Ser Excelente',
                            text: `Seu CTR de ${stats.avgCtr.toFixed(1)}% está acima da média do YouTube (2-3%), mas pode chegar a 10-15%+. Foque em: 1) Thumbnails com texto grande e legível, 2) Títulos que geram curiosidade extrema, 3) Teste diferentes horários de publicação, 4) Use a Biblioteca Virais para estudar títulos que geraram CTR alto.`
                        });
                    } else if (stats.avgCtr >= 10) {
                        tips.push({
                            type: 'success',
                            icon: 'award',
                            title: '🏆 CTR Excepcional! Você é um Expert',
                            text: `Parabéns! Seu CTR médio de ${stats.avgCtr.toFixed(1)}% está no TOP 5% dos criadores. Continue: 1) Documente o que funciona nos seus vídeos de maior CTR, 2) Replique essas estratégias, 3) Experimente nichos com RPM mais alto para maximizar receita, 4) Compartilhe suas estratégias com a comunidade.`
                        });
                    }
                }
                
                // === ANÁLISE DE RECEITA E MONETIZAÇÃO ===
                if (stats.totalRevenue > 0) {
                    const revenuePerVideo = stats.totalRevenue / stats.totalVideos;
                    const viewsPerVideo = stats.totalViews / stats.totalVideos;
                    const rpm = stats.rpmUSD || 0;
                    
                    if (revenuePerVideo < 10) {
                        tips.push({
                            type: 'info',
                            icon: 'dollar-sign',
                            title: '💰 Potencial de Monetização',
                            text: `Você está gerando $${revenuePerVideo.toFixed(2)} por vídeo em média. Para aumentar: 1) Foque em nichos com RPM alto (Finanças: $15-18, Tech: $7-8), 2) Aumente o CTR para ter mais views, 3) Publique mais frequentemente, 4) Use a função "ROI Calculator" para acompanhar seu retorno.`
                        });
                    } else if (revenuePerVideo < 50) {
                        tips.push({
                            type: 'success',
                            icon: 'trending-up',
                            title: '💵 Receita Crescendo Bem',
                            text: `Excelente! Você está gerando $${revenuePerVideo.toFixed(2)} por vídeo. Para escalar: 1) Analise seus vídeos de maior receita e replique, 2) Considere nichos com RPM mais alto, 3) Publique 2-3x por semana, 4) Use o Heatmap de Sucesso para identificar fórmulas que geram mais receita.`
                        });
                    } else {
                        tips.push({
                            type: 'success',
                            icon: 'zap',
                            title: '🚀 Receita Excelente! Continue Escalando',
                            text: `Impressionante! $${revenuePerVideo.toFixed(2)} por vídeo é um resultado excepcional. Estratégias avançadas: 1) Automatize publicação com Integração YouTube, 2) Crie séries de vídeos para aumentar retenção, 3) Explore afiliados e sponsorships, 4) Use o Leaderboard para identificar seus melhores títulos/thumbnails.`
                        });
                    }
                    
                    // Análise de RPM
                    if (rpm > 0) {
                        if (rpm < 3) {
                            tips.push({
                                type: 'info',
                                icon: 'arrow-up',
                                title: '📈 Seu RPM Pode Aumentar',
                                text: `Seu RPM atual é $${rpm.toFixed(2)}. Para aumentar: 1) Considere nichos com RPM mais alto (Finanças: $15-18, Investimentos: $18+), 2) Melhore a retenção do público (vídeos mais longos e engajantes), 3) Publique em horários de pico, 4) Use SEO otimizado para atrair audiência de maior valor.`
                            });
                        } else if (rpm >= 10) {
                            tips.push({
                                type: 'success',
                                icon: 'star',
                                title: '⭐ RPM Premium! Você Está em Nicho Lucrativo',
                                text: `Seu RPM de $${rpm.toFixed(2)} indica que você está em um nicho de alto valor. Continue: 1) Mantenha a qualidade do conteúdo, 2) Publique consistentemente, 3) Construa autoridade no nicho, 4) Explore oportunidades de monetização adicional (afiliados, produtos digitais).`
                            });
                        }
                    }
                } else if (stats.totalViews > 0) {
                    tips.push({
                        type: 'info',
                        icon: 'dollar-sign',
                        title: '💡 Ative o Rastreamento de Receita',
                        text: `Você tem ${formatNumber(stats.totalViews)} views, mas não está rastreando receita. Vá em Analytics > Registrar Novo Vídeo e registre seus vídeos publicados para ver quanto dinheiro você está gerando. Isso ajudará a identificar quais títulos/thumbnails geram mais receita.`
                    });
                }
                
                // === ANÁLISE DE ENGAGEMENT ===
                if (stats.totalViews > 0 && stats.totalLikes > 0) {
                    const likesPerView = (stats.totalLikes / stats.totalViews) * 100;
                    const commentsPerView = (stats.totalComments / stats.totalViews) * 100;
                    
                    if (likesPerView < 1) {
                        tips.push({
                            type: 'warning',
                            icon: 'thumbs-down',
                            title: '👎 Engajamento Baixo: Melhore o Conteúdo',
                            text: `Apenas ${likesPerView.toFixed(2)}% dos viewers estão dando like. Isso indica que o conteúdo não está entregando o que o título/thumbnail promete. Ações: 1) Alinhe título/thumbnail com o conteúdo, 2) Melhore a qualidade do vídeo, 3) Adicione CTAs para like/compartilhar, 4) Analise comentários para entender o que o público quer.`
                        });
                    } else if (likesPerView >= 3) {
                        tips.push({
                            type: 'success',
                            icon: 'thumbs-up',
                            title: '👍 Engajamento Excelente!',
                            text: `Parabéns! ${likesPerView.toFixed(2)}% de taxa de likes é excepcional. Seu conteúdo está entregando valor. Continue: 1) Replique o formato dos vídeos com maior engajamento, 2) Crie séries baseadas nesses vídeos, 3) Use os comentários para gerar novos vídeos, 4) Compartilhe esses vídeos em outras plataformas.`
                        });
                    }
                    
                    if (commentsPerView < 0.1) {
                        tips.push({
                            type: 'info',
                            icon: 'message-square',
                            title: '💬 Aumente Comentários para Mais Engajamento',
                            text: `Apenas ${commentsPerView.toFixed(3)}% dos viewers estão comentando. Para aumentar: 1) Faça perguntas no vídeo, 2) Peça opiniões nos comentários, 3) Responda todos os comentários, 4) Crie polêmica saudável, 5) Use finais que geram discussão.`
                        });
                    }
                }
                
                // === ANÁLISE DE VÍDEOS VIRAIS ===
                if (stats.viralVideos > 0) {
                    const viralRate = (stats.viralVideos / stats.totalVideos) * 100;
                    tips.push({
                        type: 'success',
                        icon: 'zap',
                        title: '⚡ Você Tem Vídeos Virais!',
                        text: `Você tem ${stats.viralVideos} vídeo${stats.viralVideos > 1 ? 's' : ''} com 1M+ views (${viralRate.toFixed(1)}% de taxa viral). Ações estratégicas: 1) Analise profundamente esses vídeos na Biblioteca, 2) Identifique padrões (título, thumbnail, nicho, horário), 3) Replique a fórmula, 4) Crie séries baseadas nesses vídeos, 5) Use o Score Predictor antes de publicar novos vídeos.`
                    });
                } else if (stats.totalVideos >= 10) {
                    tips.push({
                        type: 'info',
                        icon: 'target',
                        title: '🎯 Estratégia para Viralizar',
                        text: `Você já tem ${stats.totalVideos} vídeos, mas nenhum viral ainda. Estratégias: 1) Analise vídeos que viralizaram no seu nicho usando o Analisador, 2) Use títulos com pontuação 9+ da IA, 3) Foque em nichos com maior potencial viral, 4) Publique em horários de pico (terça-quinta, 14h-16h), 5) Use o Heatmap de Sucesso para identificar fórmulas que funcionam.`
                    });
                }
                
                // === ANÁLISE DE PERFORMANCE POR VÍDEO ===
                if (recentVideos.length > 0) {
                    const topVideo = recentVideos.reduce((max, v) => (v.actual_views || 0) > (max.actual_views || 0) ? v : max, recentVideos[0]);
                    const avgViewsPerVideo = stats.totalViews / stats.totalVideos;
                    
                    if (topVideo && topVideo.actual_views > avgViewsPerVideo * 2) {
                        tips.push({
                            type: 'success',
                            icon: 'star',
                            title: '⭐ Você Tem um Vídeo Destaque!',
                            text: `"${(topVideo.title_used || 'Sem título').substring(0, 50)}..." tem ${formatNumber(topVideo.actual_views)} views, muito acima da sua média. Analise: 1) Qual foi o título usado? 2) Qual foi a thumbnail? 3) Qual foi o nicho? 4) Replique essa fórmula em novos vídeos. Use a Biblioteca para salvar esse título/thumbnail como favorito.`
                        });
                    }
                    
                    // Análise de CTR por vídeo
                    const videosWithHighCtr = recentVideos.filter(v => v.actual_ctr && v.actual_ctr >= 8);
                    if (videosWithHighCtr.length > 0) {
                        tips.push({
                            type: 'success',
                            icon: 'trending-up',
                            title: '📊 Você Tem Vídeos com CTR Alto',
                            text: `${videosWithHighCtr.length} vídeo${videosWithHighCtr.length > 1 ? 's' : ''} com CTR acima de 8%. Esses são seus modelos de sucesso! Ações: 1) Estude esses títulos/thumbnails na Biblioteca, 2) Use o Gerador de Thumbnails para criar variações, 3) Aplique essas fórmulas em novos vídeos, 4) Use o Comparação com Competidores para ver como você se compara.`
                        });
                    }
                }
                
                // === ANÁLISE DE CONSISTÊNCIA ===
                if (stats.totalVideos >= 5) {
                    const daysSinceFirst = recentVideos.length > 0 && recentVideos[0].published_at 
                        ? Math.floor((new Date() - new Date(recentVideos[0].published_at)) / (1000 * 60 * 60 * 24))
                        : 0;
                    
                    if (daysSinceFirst > 0) {
                        const videosPerWeek = (stats.totalVideos / (daysSinceFirst / 7));
                        if (videosPerWeek < 1) {
                            tips.push({
                                type: 'warning',
                                icon: 'calendar',
                                title: '📅 Consistência é Chave para o Sucesso',
                                text: `Você está publicando menos de 1 vídeo por semana. Para crescer no YouTube: 1) Publique pelo menos 2-3x por semana, 2) Use a Integração YouTube para agendar publicações, 3) Crie um calendário de conteúdo, 4) Use o Gerador de Roteiros (em breve) para acelerar a criação.`
                            });
                        } else if (videosPerWeek >= 3) {
                            tips.push({
                                type: 'success',
                                icon: 'check-circle',
                                title: '✅ Excelente Consistência!',
                                text: `Você está publicando ${videosPerWeek.toFixed(1)} vídeos por semana. Isso é ótimo! Continue: 1) Mantenha a qualidade mesmo com alta frequência, 2) Use automação para economizar tempo, 3) Analise quais dias/horários performam melhor, 4) Crie templates de títulos/thumbnails para acelerar.`
                            });
                        }
                    }
                }
                
                // === ANÁLISE DE ROI E EFICIÊNCIA ===
                if (stats.totalRevenue > 0 && stats.totalVideos > 0) {
                    const costPerAnalysis = 0.50; // Custo estimado por análise
                    const totalCost = stats.totalVideos * costPerAnalysis;
                    const roi = ((stats.totalRevenue - totalCost) / totalCost) * 100;
                    
                    if (roi > 1000) {
                        tips.push({
                            type: 'success',
                            icon: 'trending-up',
                            title: '💰 ROI Excepcional! Você Está no Caminho Certo',
                            text: `Seu ROI é de ${roi.toFixed(0)}%! Para cada $1 investido, você está gerando $${(stats.totalRevenue / totalCost).toFixed(2)}. Continue: 1) Aumente o investimento em análises, 2) Escale para mais canais, 3) Automatize o processo, 4) Use o ROI Calculator para acompanhar em tempo real.`
                        });
                    } else if (roi > 0) {
                        tips.push({
                            type: 'info',
                            icon: 'dollar-sign',
                            title: '📊 ROI Positivo - Continue Investindo',
                            text: `Seu ROI é de ${roi.toFixed(0)}%. Você está no caminho certo! Para melhorar: 1) Foque em vídeos com maior potencial (use Score Predictor), 2) Otimize títulos/thumbnails antes de publicar, 3) Publique mais frequentemente, 4) Analise nichos com maior RPM.`
                        });
                    }
                }
                
                // === DICAS ESPECÍFICAS BASEADAS EM PADRÕES ===
                if (stats.totalVideos >= 3) {
                    const avgViews = stats.totalViews / stats.totalVideos;
                    
                    if (avgViews < 10000) {
                        tips.push({
                            type: 'info',
                            icon: 'eye',
                            title: '👁️ Potencial de Crescimento',
                            text: `Sua média de ${formatNumber(avgViews)} views por vídeo indica grande potencial. Estratégias: 1) Analise vídeos com 100K+ views do seu nicho, 2) Use títulos com pontuação 9+ da IA, 3) Otimize thumbnails para CTR acima de 10%, 4) Publique em horários de pico, 5) Use SEO otimizado (tags, descrição).`
                        });
                    } else if (avgViews >= 100000) {
                        tips.push({
                            type: 'success',
                            icon: 'award',
                            title: '🏆 Performance Excepcional!',
                            text: `Sua média de ${formatNumber(avgViews)} views por vídeo está no TOP 1% dos criadores. Você domina o jogo! Próximos passos: 1) Escale para múltiplos canais, 2) Explore monetização avançada (afiliados, produtos), 3) Construa uma marca pessoal, 4) Use o Leaderboard para identificar seus melhores conteúdos.`
                        });
                    }
                }
                
                // === DICAS DE OTIMIZAÇÃO TÉCNICA ===
                if (stats.totalVideos > 0) {
                    tips.push({
                        type: 'info',
                        icon: 'settings',
                        title: '⚙️ Otimize Antes de Publicar',
                        text: 'Use as ferramentas de validação: 1) Validação de Título para garantir que segue melhores práticas, 2) Validação de Thumbnail para verificar contraste e composição, 3) Score Predictor para prever views antes de publicar, 4) Comparação com Competidores para ver como você se compara. Essas ferramentas aumentam suas chances de sucesso em até 300%.'
                    });
                }
                
                // === DICAS DE ESTRATÉGIA AVANÇADA ===
                if (stats.totalVideos >= 10) {
                    tips.push({
                        type: 'info',
                        icon: 'brain',
                        title: '🧠 Estratégias Avançadas',
                        text: 'Você já tem experiência suficiente! Estratégias avançadas: 1) Use o Heatmap de Sucesso para identificar fórmulas que funcionam por nicho, 2) Crie séries de vídeos baseadas nos seus maiores sucessos, 3) Use A/B Testing (em breve) para testar variações, 4) Analise tendências semanais, 5) Construa uma biblioteca pessoal de títulos/thumbnails virais.'
                    });
                }
                
                // Limitar a 8 dicas mais relevantes para não sobrecarregar
                tips.sort((a, b) => {
                    const priority = { 'warning': 3, 'success': 2, 'info': 1 };
                    return (priority[b.type] || 0) - (priority[a.type] || 0);
                });
                
                const topTips = tips.slice(0, 6); // Reduzir para 6 dicas para layout mais compacto
                
                // Se não houver dicas, adicionar uma padrão
                if (topTips.length === 0) {
                    topTips.push({
                        type: 'info',
                        icon: 'sparkles',
                        title: '✨ Continue o Bom Trabalho!',
                        text: 'Mantenha a consistência analisando vídeos virais regularmente e testando diferentes estratégias de títulos e thumbnails. Use todas as ferramentas disponíveis para maximizar seus resultados.'
                    });
                }
                
                // Renderizar dicas de forma mais compacta
                container.innerHTML = '';
                topTips.forEach(tip => {
                    const tipClass = tip.type === 'warning' 
                        ? 'bg-red-900/20 border-red-700/30' 
                        : tip.type === 'success' 
                        ? 'bg-green-900/20 border-green-700/30' 
                        : 'bg-gray-800/40 border-amber-700/20';
                    
                    const iconClass = tip.type === 'warning' 
                        ? 'text-red-400' 
                        : tip.type === 'success' 
                        ? 'text-green-400' 
                        : 'text-amber-400';
                    
                    container.innerHTML += `
                        <div class="${tipClass} rounded-lg p-2.5 border">
                            <div class="flex items-start space-x-2">
                                <i data-lucide="${tip.icon}" class="w-4 h-4 ${iconClass} mt-0.5 flex-shrink-0"></i>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-xs font-semibold text-white mb-1 leading-tight">${tip.title}</h3>
                                    <p class="text-gray-300 text-xs leading-relaxed">${tip.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function generateNextSteps(data) {
                const container = document.getElementById('next-steps');
                if (!container) return;
                
                const steps = [];
                const stats = data.stats || {};
                
                if (stats.totalVideos === 0) {
                    steps.push({
                        icon: 'youtube',
                        text: 'Analise seu primeiro vídeo viral usando o Analisador de Vídeos',
                        action: 'analisador'
                    });
                    steps.push({
                        icon: 'settings',
                        text: 'Configure suas chaves de API (Gemini, Claude, OpenAI) nas Configurações',
                        action: 'configuracoes'
                    });
                } else {
                    if (stats.totalVideos < 5) {
                        steps.push({
                            icon: 'youtube',
                            text: `Continue analisando vídeos. Você já tem ${stats.totalVideos}, tente chegar a pelo menos 10.`,
                            action: 'analisador'
                        });
                    }
                    
                    if (stats.viralVideos === 0 && stats.totalVideos >= 5) {
                        steps.push({
                            icon: 'trending-up',
                            text: 'Explore novos nichos usando a ferramenta Explorar Nicho para encontrar oportunidades',
                            action: 'explorar-nicho'
                        });
                    }
                    
                    steps.push({
                        icon: 'image',
                        text: 'Gere thumbnails para seus títulos mais promissores usando o Gerador de Thumbnails',
                        action: 'analisador'
                    });
                    
                    steps.push({
                        icon: 'book',
                        text: 'Organize seus títulos favoritos na Biblioteca Virais para acesso rápido',
                        action: 'biblioteca'
                    });
                }
                
                steps.push({
                    icon: 'bar-chart-3',
                    text: 'Acompanhe o desempenho dos seus vídeos na seção Analytics',
                    action: 'analytics'
                });
                
                const stepsHtml = steps.map((step, index) => `
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-amber-500/50 transition-colors cursor-pointer" onclick="navigateToView('${step.action}')">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-500 font-bold text-sm">
                                ${index + 1}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <i data-lucide="${step.icon}" class="w-4 h-4 text-amber-500"></i>
                                    <p class="text-white text-sm font-medium">${step.text}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = stepsHtml;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // --- CARREGAMENTO INICIAL ---
            // Garantir que a view 'inicio' está visível por padrão
            const inicioViewOnLoad = document.getElementById('view-inicio');
            if (inicioViewOnLoad) {
                inicioViewOnLoad.style.display = 'block';
                inicioViewOnLoad.classList.add('active'); // Adicionar classe active para o CSS não esconder
            }
            // Esconder todas as outras views e remover classe active
            const allViews = document.querySelectorAll('[id^="view-"]');
            allViews.forEach(view => {
                if (view && view.id !== 'view-inicio') {
                    view.style.display = 'none';
                    view.classList.remove('active');
                }
            });
            
            checkUserRoleAndLoadAdmin();
            loadFolders();
            loadDashboard(); // Carregar dashboard na tela inicial
            startDashboardAutoRefresh(); // Iniciar atualização automática do dashboard
            setupAdminListeners();

            // === FUNCIONALIDADES DE ANALYTICS ===
            async function loadAnalytics() {
                console.log('[Analytics] Iniciando carregamento...');
                if (!userToken) {
                    console.error('[Analytics] Token de usuário não encontrado');
                    const errorMsg = document.getElementById('analytics-error-message');
                    if (errorMsg) showMessage('analytics-error-message', 'Token de autenticação não encontrado. Por favor, faça login novamente.', true);
                    return;
                }
                try {
                    console.log('[Analytics] Fazendo requisição para:', `${API_BASE}/api/analytics/dashboard`);
                    const response = await fetch(`${API_BASE}/api/analytics/dashboard`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('[Analytics] Resposta recebida:', response.status, response.statusText);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar analytics: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('[Analytics] Dados recebidos:', data);

                    const totalViewsEl = document.getElementById('stats-total-views');
                    const avgCtrEl = document.getElementById('stats-avg-ctr');
                    const totalRevenueEl = document.getElementById('stats-total-revenue');
                    const viralVideosEl = document.getElementById('stats-viral-videos');

                    if (totalViewsEl) totalViewsEl.textContent = formatNumber(data.stats.totalViews || 0);
                    if (avgCtrEl) avgCtrEl.textContent = (data.stats.avgCtr || 0).toFixed(1) + '%';
                    if (totalRevenueEl) {
                        const revenueUSD = data.stats.totalRevenue || 0;
                        totalRevenueEl.textContent = '$' + formatNumber(Math.round(revenueUSD));
                    }
                    const totalRevenueBrlEl = document.getElementById('stats-total-revenue-brl');
                    if (totalRevenueBrlEl) {
                        const revenueUSD = data.stats.totalRevenue || 0;
                        const revenueBRL = revenueUSD * 5.50; // Taxa de câmbio USD para BRL
                        totalRevenueBrlEl.textContent = 'R$ ' + formatNumber(Math.round(revenueBRL));
                    }
                    const rpmEl = document.getElementById('stats-rpm');
                    if (rpmEl) rpmEl.textContent = `RPM: $${(data.stats.rpmUSD || 0).toFixed(2)} / R$ ${(data.stats.rpmBRL || 0).toFixed(2)}`;
                    if (viralVideosEl) viralVideosEl.textContent = data.stats.viralVideos || 0;

                    const videosList = document.getElementById('analytics-videos-list');
                    if (videosList) {
                        if (data.recentVideos && data.recentVideos.length > 0) {
                            videosList.innerHTML = data.recentVideos.map(video => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-white font-semibold mb-1">${escapeHtml(video.title_used || 'Sem título')}</h3>
                                        <p class="text-gray-400 text-sm mb-1">${formatNumber(parseInt(video.actual_views || 0))} views • CTR: ${(parseFloat(video.actual_ctr || 0)).toFixed(1)}%</p>
                                        <p class="text-gray-400 text-xs mb-1">Receita: $${formatNumber(Math.round(parseFloat(video.revenue_estimate || 0)))} / R$ ${formatNumber(Math.round(parseFloat(video.revenue_estimate || 0) * 5.50))}</p>
                                        ${video.channel_name ? `<p class="text-blue-400 text-xs mb-1">Canal: ${escapeHtml(video.channel_name)}</p>` : ''}
                                        ${video.youtube_video_id ? `<a href="https://www.youtube.com/watch?v=${video.youtube_video_id}" target="_blank" class="text-amber-500 hover:text-amber-400 text-xs">Ver no YouTube</a>` : ''}
                                        ${video.published_at ? `<p class="text-gray-500 text-xs mt-1">Publicado: ${new Date(video.published_at).toLocaleDateString('pt-BR')}</p>` : ''}
                                    </div>
                                    <div class="flex items-center gap-2 ml-4">
                                        <button onclick="updateVideoMetrics(${video.id})" class="py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black rounded-lg font-bold text-sm" title="Atualizar métricas">
                                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="deleteVideoTracking(${video.id})" class="py-2 px-4 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold text-sm" title="Excluir do tracking">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            videosList.innerHTML = '<p class="text-gray-400">Nenhum vídeo trackado ainda.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar analytics:', err);
                    const errorMsg = document.getElementById('analytics-error-message');
                    if (errorMsg) {
                        showMessage('analytics-error-message', err.message || 'Erro ao carregar analytics. Verifique o console para mais detalhes.', true);
                    }
                    // Mesmo com erro, mostrar interface vazia
                    const totalViewsEl = document.getElementById('stats-total-views');
                    const avgCtrEl = document.getElementById('stats-avg-ctr');
                    const totalRevenueEl = document.getElementById('stats-total-revenue');
                    const viralVideosEl = document.getElementById('stats-viral-videos');
                    if (totalViewsEl) totalViewsEl.textContent = '0';
                    if (avgCtrEl) avgCtrEl.textContent = '0%';
                    if (totalRevenueEl) totalRevenueEl.textContent = '$0';
                    if (viralVideosEl) viralVideosEl.textContent = '0';
                }
            }

            window.updateVideoMetrics = async function(trackingId) {
                try {
                    const response = await fetch(`${API_BASE}/api/analytics/update/${trackingId}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar métricas.');
                    showMessage('analytics-success-message', 'Métricas atualizadas com sucesso!');
                    await loadAnalytics();
                    // Atualizar dashboard se estiver visível
                    refreshDashboardIfVisible();
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            window.deleteVideoTracking = async function(trackingId) {
                const confirmed = await showCustomConfirm(
                    'Tem certeza que deseja excluir este vídeo do tracking? Esta ação não pode ser desfeita.',
                    'Confirmar Exclusão'
                );
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/analytics/track/${trackingId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || 'Falha ao excluir vídeo.');
                    }
                    showMessage('analytics-success-message', 'Vídeo excluído do tracking com sucesso!');
                    await loadAnalytics();
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            // === GERENCIAMENTO DE CANAIS ===
            let currentEditingChannelId = null;

            async function loadChannels() {
                try {
                    const response = await fetch(`${API_BASE}/api/channels`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar canais.');
                    const channels = await response.json();
                    
                    const channelsList = document.getElementById('channels-list');
                    const channelSelect = document.getElementById('register-video-channel');
                    
                    if (channelsList) {
                        if (channels.length > 0) {
                            channelsList.innerHTML = channels.map(channel => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 flex items-center justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-white font-semibold">${escapeHtml(channel.channel_name)}</h3>
                                        <p class="text-gray-400 text-sm">${escapeHtml(channel.niche || 'Sem nicho')} • ${escapeHtml(channel.language || 'pt-BR')} • ${escapeHtml(channel.country || 'BR')}</p>
                                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded ${channel.is_active ? 'bg-green-600' : 'bg-gray-600'}">${channel.is_active ? 'Ativo' : 'Inativo'}</span>
                                    </div>
                                    <div class="flex items-center gap-2 ml-4">
                                        <button onclick="editChannel(${channel.id})" class="p-2 text-blue-400 hover:text-blue-300" title="Editar canal">
                                            <i data-lucide="edit"></i>
                                        </button>
                                        <button onclick="toggleChannelStatus(${channel.id}, ${channel.is_active})" class="p-2 ${channel.is_active ? 'text-yellow-400' : 'text-green-400'} hover:opacity-80" title="${channel.is_active ? 'Desativar' : 'Ativar'}">
                                            <i data-lucide="${channel.is_active ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button onclick="deleteChannel(${channel.id})" class="p-2 text-red-600 hover:text-red-500" title="Excluir canal">
                                            <i data-lucide="trash-2"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            channelsList.innerHTML = '<p class="text-gray-400">Nenhum canal cadastrado. Adicione um canal para organizar seus vídeos por nicho e idioma.</p>';
                        }
                    }

                    if (channelSelect) {
                        channelSelect.innerHTML = '<option value="">Selecione um canal (opcional)</option>' + 
                            channels.filter(c => c.is_active).map(channel => 
                                `<option value="${channel.id}">${escapeHtml(channel.channel_name)}</option>`
                            ).join('');
                    }
                } catch (err) {
                    console.error('Erro ao carregar canais:', err);
                }
            }

            window.showAddChannelModal = function() {
                currentEditingChannelId = null;
                document.getElementById('channel-modal-title').textContent = 'Adicionar Canal';
                document.getElementById('channel-form').reset();
                document.getElementById('channel-modal').classList.remove('hidden');
                document.getElementById('channel-modal').classList.add('flex');
            };

            window.hideChannelModal = function() {
                document.getElementById('channel-modal').classList.add('hidden');
                document.getElementById('channel-modal').classList.remove('flex');
                currentEditingChannelId = null;
            };

            window.editChannel = async function(channelId) {
                try {
                    const response = await fetch(`${API_BASE}/api/channels`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao carregar canais.');
                    const channels = await response.json();
                    const channel = channels.find(c => c.id === channelId);
                    if (!channel) throw new Error('Canal não encontrado.');
                    
                    currentEditingChannelId = channelId;
                    document.getElementById('channel-modal-title').textContent = 'Editar Canal';
                    document.getElementById('channel-name').value = channel.channel_name;
                    document.getElementById('channel-url').value = channel.channel_url || '';
                    document.getElementById('channel-niche').value = channel.niche || '';
                    document.getElementById('channel-language').value = channel.language || 'pt-BR';
                    document.getElementById('channel-country').value = channel.country || 'BR';
                    document.getElementById('channel-modal').classList.remove('hidden');
                    document.getElementById('channel-modal').classList.add('flex');
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            window.toggleChannelStatus = async function(channelId, currentStatus) {
                try {
                    const response = await fetch(`${API_BASE}/api/channels/${channelId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isActive: !currentStatus })
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar status do canal.');
                    await loadChannels();
                    await loadAnalytics();
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            window.deleteChannel = async function(channelId) {
                const confirmed = await showCustomConfirm(
                    'Tem certeza que deseja excluir este canal? Esta ação não pode ser desfeita.',
                    'Confirmar Exclusão'
                );
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/channels/${channelId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) throw new Error('Falha ao excluir canal.');
                    await loadChannels();
                    await loadAnalytics();
                    showMessage('analytics-success-message', 'Canal excluído com sucesso!');
                } catch (err) {
                    showMessage('analytics-error-message', err.message, true);
                }
            };

            // Auto-preenchimento de canal ao digitar URL (usando event delegation para funcionar quando modal abrir)
            let channelUrlTimeout;
            document.addEventListener('input', (e) => {
                if (e.target.id === 'channel-url') {
                    clearTimeout(channelUrlTimeout);
                    const url = e.target.value.trim();
                    if (url && url.includes('youtube.com')) {
                        channelUrlTimeout = setTimeout(async () => {
                            try {
                                const response = await fetch(`${API_BASE}/api/channels/fetch-info`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${userToken}`
                                    },
                                    body: JSON.stringify({ channelUrl: url })
                                });
                                if (response.ok) {
                                    const data = await response.json();
                                    console.log('[Canais] Dados recebidos do servidor:', data);
                                    if (data.channelName) {
                                        const nameInput = document.getElementById('channel-name');
                                        if (nameInput) {
                                            nameInput.value = data.channelName;
                                            console.log('[Canais] Nome do canal preenchido:', data.channelName);
                                        }
                                    }
                                    if (data.channelId) {
                                        const hiddenInput = document.getElementById('channel-id-hidden');
                                        if (hiddenInput) {
                                            hiddenInput.setAttribute('data-channel-id', data.channelId);
                                            console.log('[Canais] ID do canal salvo:', data.channelId);
                                        }
                                    }
                                    if (data.niche) {
                                        const nicheInput = document.getElementById('channel-niche');
                                        if (nicheInput) {
                                            nicheInput.value = data.niche;
                                            console.log('[Canais] Nicho preenchido:', data.niche);
                                        }
                                    } else {
                                        console.warn('[Canais] Nicho não retornado pelo servidor');
                                    }
                                    if (data.language) {
                                        const langInput = document.getElementById('channel-language');
                                        if (langInput) {
                                            langInput.value = data.language;
                                            console.log('[Canais] Idioma preenchido:', data.language);
                                        }
                                    }
                                    if (data.country) {
                                        const countryInput = document.getElementById('channel-country');
                                        if (countryInput) {
                                            countryInput.value = data.country;
                                            console.log('[Canais] País preenchido:', data.country);
                                        }
                                    }
                                    showMessage('analytics-success-message', 'Informações do canal carregadas com sucesso!');
                                } else {
                                    const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                                    console.error('[Canais] Erro ao buscar informações:', errorData);
                                    showMessage('analytics-error-message', errorData.msg || 'Erro ao buscar informações do canal.', true);
                                }
                            } catch (err) {
                                console.error('Erro ao buscar informações do canal:', err);
                            }
                        }, 1000); // Aguardar 1 segundo após parar de digitar
                    }
                }
            });

            const channelForm = document.getElementById('channel-form');
            if (channelForm) {
                channelForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const channelName = document.getElementById('channel-name').value;
                    const channelUrl = document.getElementById('channel-url').value;
                    const channelIdHidden = document.getElementById('channel-id-hidden');
                    const channelId = channelIdHidden?.getAttribute('data-channel-id') || null;
                    const niche = document.getElementById('channel-niche').value;
                    const language = document.getElementById('channel-language').value;
                    const country = document.getElementById('channel-country').value;

                    try {
                        const response = await fetch(`${API_BASE}/api/channels`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                channelName,
                                channelUrl,
                                channelId,
                                niche,
                                language,
                                country
                            })
                        });
                        if (!response.ok) {
                            const data = await response.json();
                            throw new Error(data.msg || 'Falha ao salvar canal.');
                        }
                        
                        hideChannelModal();
                        await loadChannels();
                        showMessage('analytics-success-message', 'Canal salvo com sucesso!');
                    } catch (err) {
                        showMessage('analytics-error-message', err.message, true);
                    }
                });
            }

            const registerVideoForm = document.getElementById('register-video-form');
            if (registerVideoForm) {
                registerVideoForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('[Analytics] Registrando vídeo...', { API_BASE, hasToken: !!userToken });
                    
                    const channelId = document.getElementById('register-video-channel')?.value;
                    const url = document.getElementById('register-video-url')?.value;
                    const title = document.getElementById('register-video-title')?.value;
                    const ctr = document.getElementById('register-video-ctr')?.value;
                    const views = document.getElementById('register-video-views')?.value;

                    if (!url || !title) {
                        const errorMsg = document.getElementById('analytics-error-message');
                        if (errorMsg) {
                            showMessage('analytics-error-message', 'URL e título são obrigatórios.', true);
                        } else {
                            alert('URL e título são obrigatórios.');
                        }
                        return;
                    }

                    try {
                        const videoId = url.match(/[?&]v=([^&]+)/)?.[1];
                        if (!videoId) {
                            throw new Error('URL do YouTube inválida. Use o formato: https://www.youtube.com/watch?v=VIDEO_ID');
                        }

                        console.log('[Analytics] Enviando dados:', { videoId, title, ctr, views, channelId });
                        
                        const response = await fetch(`${API_BASE}/api/analytics/track`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({
                                channelId: channelId || null,
                                youtubeVideoId: videoId,
                                titleUsed: title,
                                predictedCtr: ctr ? parseFloat(ctr) : null,
                                predictedViews: views ? parseInt(views) : null
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ msg: 'Falha ao registrar vídeo.' }));
                            throw new Error(errorData.msg || 'Falha ao registrar vídeo.');
                        }
                        
                        const data = await response.json();
                        console.log('[Analytics] Vídeo registrado com sucesso:', data);
                        
                        registerVideoForm.reset();
                        await loadAnalytics();
                        
                        // Mostrar mensagem de sucesso
                        const successMsg = document.getElementById('analytics-success-message');
                        if (successMsg) {
                            showMessage('analytics-success-message', 'Vídeo registrado com sucesso!');
                        }
                        
                        // Atualizar dashboard se estiver visível
                        refreshDashboardIfVisible();
                    } catch (err) {
                        console.error('[Analytics] Erro ao registrar vídeo:', err);
                        const errorMsg = document.getElementById('analytics-error-message');
                        if (errorMsg) {
                            showMessage('analytics-error-message', err.message, true);
                        } else {
                            alert('Erro ao registrar vídeo: ' + err.message);
                        }
                    }
                });
            } else {
                console.warn('[Analytics] Formulário register-video-form não encontrado');
            }

            // === FUNCIONALIDADES DE BIBLIOTECA ===
            let currentBibliotecaTab = 'titles';
            
            const bibliotecaTabTitles = document.getElementById('biblioteca-tab-titles');
            const bibliotecaTabThumbnails = document.getElementById('biblioteca-tab-thumbnails');
            const bibliotecaTabAgents = document.getElementById('biblioteca-tab-agents');
            const bibliotecaTabScripts = document.getElementById('biblioteca-tab-scripts');
            
            if (bibliotecaTabTitles) {
                bibliotecaTabTitles.addEventListener('click', () => {
                    currentBibliotecaTab = 'titles';
                    document.getElementById('biblioteca-titles-section').style.display = 'block';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'none';
                    document.getElementById('biblioteca-agents-section').style.display = 'none';
                    bibliotecaTabTitles.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.remove('text-gray-400');
                    bibliotecaTabThumbnails?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails?.classList.add('text-gray-400');
                    bibliotecaTabAgents?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents?.classList.add('text-gray-400');
                    loadBibliotecaNiches();
                    loadBibliotecaTitles();
                });
            }

            if (bibliotecaTabThumbnails) {
                bibliotecaTabThumbnails.addEventListener('click', () => {
                    currentBibliotecaTab = 'thumbnails';
                    document.getElementById('biblioteca-titles-section').style.display = 'none';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'block';
                    document.getElementById('biblioteca-agents-section').style.display = 'none';
                    bibliotecaTabThumbnails.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails.classList.remove('text-gray-400');
                    bibliotecaTabTitles.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.add('text-gray-400');
                    bibliotecaTabAgents?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents?.classList.add('text-gray-400');
                    loadBibliotecaNiches();
                    loadBibliotecaThumbnails();
                });
            }

            if (bibliotecaTabAgents) {
                bibliotecaTabAgents.addEventListener('click', () => {
                    currentBibliotecaTab = 'agents';
                    document.getElementById('biblioteca-titles-section').style.display = 'none';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'none';
                    document.getElementById('biblioteca-agents-section').style.display = 'block';
                    document.getElementById('biblioteca-scripts-section').style.display = 'none';
                    bibliotecaTabAgents.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents.classList.remove('text-gray-400');
                    bibliotecaTabTitles.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.add('text-gray-400');
                    bibliotecaTabThumbnails?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails?.classList.add('text-gray-400');
                    bibliotecaTabScripts?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabScripts?.classList.add('text-gray-400');
                    loadBibliotecaAgents();
                });
            }

            if (bibliotecaTabScripts) {
                bibliotecaTabScripts.addEventListener('click', () => {
                    currentBibliotecaTab = 'scripts';
                    document.getElementById('biblioteca-titles-section').style.display = 'none';
                    document.getElementById('biblioteca-thumbnails-section').style.display = 'none';
                    document.getElementById('biblioteca-agents-section').style.display = 'none';
                    document.getElementById('biblioteca-scripts-section').style.display = 'block';
                    bibliotecaTabScripts.classList.add('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabScripts.classList.remove('text-gray-400');
                    bibliotecaTabTitles.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabTitles.classList.add('text-gray-400');
                    bibliotecaTabThumbnails?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabThumbnails?.classList.add('text-gray-400');
                    bibliotecaTabAgents?.classList.remove('text-amber-500', 'border-b-2', 'border-amber-500');
                    bibliotecaTabAgents?.classList.add('text-gray-400');
                    loadBibliotecaScripts();
                });
            }

            async function loadBibliotecaNiches() {
                console.log('[Biblioteca] Carregando nichos...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usuário não encontrado');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE}/api/library/niches`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        throw new Error('Erro ao carregar nichos');
                    }
                    const data = await response.json();
                    const niches = data.niches || [];
                    
                    const nicheFilter = document.getElementById('biblioteca-niche-filter');
                    if (nicheFilter) {
                        const currentValue = nicheFilter.value;
                        nicheFilter.innerHTML = '<option value="">Todos os Nichos</option>';
                        niches.forEach(niche => {
                            const option = document.createElement('option');
                            option.value = niche;
                            option.textContent = niche;
                            nicheFilter.appendChild(option);
                        });
                        // Restaurar valor anterior se ainda existir
                        if (currentValue && niches.includes(currentValue)) {
                            nicheFilter.value = currentValue;
                        }
                    }
                } catch (err) {
                    console.error('[Biblioteca] Erro ao carregar nichos:', err);
                }
            }

            let currentBibliotecaPage = 1;
            let currentBibliotecaLimit = 6;
            
            async function loadBibliotecaTitles(page = currentBibliotecaPage, limit = currentBibliotecaLimit) {
                currentBibliotecaPage = page;
                currentBibliotecaLimit = limit;
                
                console.log('[Biblioteca] Carregando títulos...', { page, limit });
                if (!userToken) {
                    console.error('[Biblioteca] Token de usuário não encontrado');
                    return;
                }
                try {
                    const search = document.getElementById('biblioteca-search')?.value || '';
                    const niche = document.getElementById('biblioteca-niche-filter')?.value || '';
                    const minViews = document.getElementById('biblioteca-views-filter')?.value || '';
                    const favoritesBtn = document.getElementById('biblioteca-favorites-only');
                    const favorites = favoritesBtn?.classList.contains('active') ? 'true' : '';

                    let url = `${API_BASE}/api/library/titles?page=${page}&limit=${limit}`;
                    if (search) url += `&search=${encodeURIComponent(search)}`;
                    if (niche) url += `&niche=${encodeURIComponent(niche)}`;
                    if (minViews) url += `&minViews=${minViews}`;
                    if (favorites) url += `&favorite=${favorites}`;

                    console.log('[Biblioteca] URL:', url);
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('[Biblioteca] Resposta:', response.status);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar títulos: ${response.status}`);
                    }
                    const result = await response.json();
                    const titles = result.data || result; // Suportar formato antigo e novo
                    const pagination = result.pagination || {};
                    console.log('[Biblioteca] Títulos recebidos:', titles.length, 'Total:', pagination.total || titles.length);

                    const list = document.getElementById('biblioteca-titles-list');
                    if (list) {
                        if (titles.length > 0) {
                            list.innerHTML = titles.map(title => {
                                const views = parseInt(title.original_views || 0);
                                const score = title.viral_score || 0;
                                const scoreColor = score >= 8 ? 'text-green-400' : score >= 6 ? 'text-yellow-400' : 'text-gray-400';
                                
                                return `
                                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 hover:border-amber-500/50 transition-all shadow-lg hover:shadow-amber-500/10">
                                        <div class="flex items-start gap-3 mb-4">
                                            <input type="checkbox" class="title-library-checkbox w-5 h-5 bg-gray-700 border-gray-600 rounded text-amber-500 focus:ring-amber-500 focus:ring-2 flex-shrink-0 mt-1" data-title-id="${title.id}">
                                            <div class="flex-1">
                                                <h3 class="text-white font-bold text-lg mb-2 line-clamp-2" title="${escapeHtml(title.title || 'Sem título')}">${escapeHtml(title.title || 'Sem título')}</h3>
                                                <div class="flex flex-wrap items-center gap-2 mb-3">
                                                    ${title.niche ? `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-amber-500/10 text-amber-400 border border-amber-500/20">${escapeHtml(title.niche)}</span>` : ''}
                                                    ${title.subniche ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs text-gray-400 bg-gray-700/50">${escapeHtml(title.subniche)}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2 flex-shrink-0">
                                                <button onclick="toggleTitleFavorite(${title.id}, ${title.is_favorite || 0})" class="p-2 rounded-lg ${title.is_favorite ? 'text-red-500 bg-red-500/10' : 'text-gray-400 hover:text-red-500 hover:bg-red-500/10'} transition-all" title="${title.is_favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                                                    <i data-lucide="heart" class="w-5 h-5 ${title.is_favorite ? 'fill-current' : ''}"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-3 mb-4">
                                            <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-700/50">
                                                <p class="text-xs text-gray-500 mb-1">Views Originais</p>
                                                <p class="text-white font-bold text-sm">${views > 0 ? formatNumber(views) : 'N/A'}</p>
                                            </div>
                                            <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-700/50">
                                                <p class="text-xs text-gray-500 mb-1">Score Viral em Potencial</p>
                                                <p class="${scoreColor} font-bold text-sm">${score > 0 ? score.toFixed(1) : '0'}/10</p>
                                            </div>
                                        </div>
                                        
                                        ${title.formula_type ? `
                                            <div class="mt-3 pt-3 border-t border-gray-700">
                                                <p class="text-xs text-gray-500 mb-1">Fórmula</p>
                                                <p class="text-gray-300 text-xs line-clamp-2">${escapeHtml(title.formula_type)}</p>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="mt-4 flex gap-2">
                                            <button onclick="copyTitleToClipboard('${escapeHtml(title.title || '').replace(/'/g, "\\'")}')" class="flex-1 py-2 px-3 bg-amber-600/20 hover:bg-amber-600/30 border border-amber-500/30 text-amber-400 rounded-lg transition-all text-sm font-medium flex items-center justify-center gap-2">
                                                <i data-lucide="copy" class="w-4 h-4"></i>
                                                <span>Copiar</span>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            list.innerHTML = `
                                <div class="col-span-full text-center py-12">
                                    <i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
                                    <p class="text-gray-400 font-medium text-lg mb-2">Nenhum título encontrado</p>
                                    <p class="text-gray-500 text-sm">Marque títulos como escolhidos nas análises para vê-los aqui</p>
                                </div>
                            `;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }
                        
                        // Atualizar paginação
                        updateBibliotecaPagination(pagination);
                        
                        // Adicionar event listeners para checkboxes
                        document.querySelectorAll('.title-library-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', updateBibliotecaSelection);
                        });
                    }
                } catch (err) {
                    console.error('Erro ao carregar títulos:', err);
                    const list = document.getElementById('biblioteca-titles-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400 col-span-full text-center py-8">Erro ao carregar títulos: ${err.message}</p>`;
                    }
                }
            }
            
            // Função para atualizar seleção em lote
            function updateBibliotecaSelection() {
                const checkboxes = document.querySelectorAll('.title-library-checkbox:checked');
                const count = checkboxes.length;
                const countSpan = document.getElementById('selected-count-number');
                const countContainer = document.getElementById('selected-titles-count');
                const deleteBtn = document.getElementById('delete-selected-titles');
                
                if (countSpan) countSpan.textContent = count;
                if (countContainer) countContainer.classList.toggle('hidden', count === 0);
                if (deleteBtn) deleteBtn.classList.toggle('hidden', count === 0);
            }
            
            // Função para atualizar paginação
            function updateBibliotecaPagination(pagination) {
                const paginationContainer = document.getElementById('biblioteca-titles-pagination');
                const paginationInfo = document.getElementById('biblioteca-titles-pagination-info');
                const paginationControls = document.getElementById('biblioteca-titles-pagination-controls');
                const limitSelect = document.getElementById('biblioteca-titles-limit');
                
                if (!pagination || !pagination.total || pagination.totalPages <= 1) {
                    if (paginationContainer) paginationContainer.style.display = 'none';
                    return;
                }
                
                if (paginationContainer) paginationContainer.style.display = 'flex';
                
                // Atualizar seletor de limite
                if (limitSelect) {
                    limitSelect.value = pagination.limit || currentBibliotecaLimit;
                }
                
                // Info
                if (paginationInfo) {
                    const start = ((pagination.page - 1) * pagination.limit) + 1;
                    const end = Math.min(pagination.page * pagination.limit, pagination.total);
                    paginationInfo.innerHTML = `<span class="text-gray-300">Mostrando <span class="text-amber-500 font-bold">${start}-${end}</span> de <span class="text-amber-500 font-bold">${pagination.total}</span> títulos</span>`;
                }
                
                // Controles
                if (paginationControls) {
                    paginationControls.innerHTML = '';
                    
                    // Botão Anterior
                    if (pagination.hasPrev) {
                        const prevBtn = document.createElement('button');
                        prevBtn.className = 'px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 text-sm font-medium transition-all flex items-center space-x-1';
                        prevBtn.innerHTML = '<i data-lucide="chevron-left" class="w-4 h-4"></i><span class="hidden sm:inline">Anterior</span>';
                        prevBtn.onclick = () => loadBibliotecaTitles(pagination.page - 1, currentBibliotecaLimit);
                        paginationControls.appendChild(prevBtn);
                    }
                    
                    // Números de página
                    const maxPages = 5;
                    let startPage = Math.max(1, pagination.page - Math.floor(maxPages / 2));
                    let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);
                    if (endPage - startPage < maxPages - 1) {
                        startPage = Math.max(1, endPage - maxPages + 1);
                    }
                    
                    for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = `px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${i === pagination.page ? 'bg-gradient-to-r from-amber-600 to-amber-500 text-black font-bold shadow-lg shadow-amber-500/30' : 'bg-gray-800/50 border border-gray-700 text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400'}`;
                        pageBtn.textContent = i;
                        pageBtn.onclick = () => loadBibliotecaTitles(i, currentBibliotecaLimit);
                        paginationControls.appendChild(pageBtn);
                    }
                    
                    // Botão Próximo
                    if (pagination.hasNext) {
                        const nextBtn = document.createElement('button');
                        nextBtn.className = 'px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 text-sm font-medium transition-all flex items-center space-x-1';
                        nextBtn.innerHTML = '<span class="hidden sm:inline">Próximo</span><i data-lucide="chevron-right" class="w-4 h-4"></i>';
                        nextBtn.onclick = () => loadBibliotecaTitles(pagination.page + 1, currentBibliotecaLimit);
                        paginationControls.appendChild(nextBtn);
                    }
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }

            async function loadBibliotecaScripts() {
                console.log('[Biblioteca] Carregando roteiros gerados...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usuário não encontrado');
                    return;
                }
                try {
                    const list = document.getElementById('biblioteca-scripts-list');
                    if (!list) {
                        console.error('[Biblioteca] Elemento biblioteca-scripts-list não encontrado');
                        return;
                    }

                    list.innerHTML = '<p class="text-gray-400">Carregando roteiros...</p>';

                    const response = await fetch(`${API_BASE}/api/scripts`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar roteiros: ${response.status}`);
                    }

                    const data = await response.json();
                    const scripts = data.scripts || [];
                    console.log('[Biblioteca] Roteiros recebidos:', scripts.length);

                    if (list) {
                        if (scripts.length > 0) {
                            list.innerHTML = scripts.map(script => {
                                const createdDate = new Date(script.created_at || script.createdAt || Date.now());
                                const dateStr = createdDate.toLocaleDateString('pt-BR', { 
                                    day: '2-digit', 
                                    month: '2-digit', 
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                // Calcular tempo aproximado (130 palavras/minuto para narração mais rigorosa, ~5 caracteres/palavra = 650 caracteres/minuto)
                                const charCount = script.script_content?.length || 0;
                                const estimatedMinutes = Math.ceil(charCount / 650);
                                
                                return `
                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-amber-500 transition-colors">
                                        <div class="flex items-start space-x-4 mb-4">
                                            <div class="flex-shrink-0 pt-1">
                                                <input type="checkbox" class="script-checkbox w-5 h-5 text-amber-600 bg-gray-700 border-gray-600 rounded focus:ring-amber-500 focus:ring-2" data-script-id="${script.id}">
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="text-lg font-semibold text-white mb-2">${escapeHtml(script.title || 'Sem título')}</h3>
                                                <div class="space-y-1 text-sm text-gray-400">
                                                    ${script.niche ? `<p><span class="text-amber-500">Nicho:</span> ${escapeHtml(script.niche)}</p>` : ''}
                                                    ${script.subniche ? `<p><span class="text-amber-500">Sub-nicho:</span> ${escapeHtml(script.subniche)}</p>` : ''}
                                                    ${script.model_used ? `<p><span class="text-amber-500">Modelo:</span> ${escapeHtml(window.formatModelNameForDisplay ? window.formatModelNameForDisplay(script.model_used) : script.model_used)}</p>` : ''}
                                                    <p class="text-xs text-gray-500 mt-2">Gerado em: ${dateStr}</p>
                                                    <p class="text-xs text-gray-500">Tamanho: ${charCount.toLocaleString('pt-BR')} caracteres</p>
                                                    <p class="text-xs text-amber-400 font-medium">Duração aproximada: ${estimatedMinutes} minuto${estimatedMinutes !== 1 ? 's' : ''}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2 mt-4">
                                            <button class="btn-view-script flex-1 py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors flex items-center justify-center space-x-2" data-script-id="${script.id}" data-script-title="${escapeHtml(script.title)}" data-script-duration="${script.duration_minutes || estimatedMinutes}">
                                                <i data-lucide="eye"></i>
                                                <span>Ver Roteiro</span>
                                            </button>
                                            <button class="btn-download-script-srt py-2 px-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors" data-script-id="${script.id}" data-script-content="${escapeHtml((script.script_content || '').substring(0, 1000))}" data-script-title="${escapeHtml(script.title)}" title="Baixar SRT">
                                                <i data-lucide="download"></i>
                                            </button>
                                            <button class="btn-delete-script py-2 px-3 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors" data-script-id="${script.id}" title="Excluir roteiro">
                                                <i data-lucide="trash-2"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            // Adicionar event listeners para checkboxes
                            document.querySelectorAll('.script-checkbox').forEach(checkbox => {
                                checkbox.addEventListener('change', updateDeleteButton);
                            });
                            
                            // Event listener para selecionar todos
                            const selectAllBtn = document.getElementById('select-all-scripts');
                            const deleteSelectedBtn = document.getElementById('delete-selected-scripts');
                            if (selectAllBtn) {
                                selectAllBtn.addEventListener('click', () => {
                                    const checkboxes = document.querySelectorAll('.script-checkbox');
                                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                                    checkboxes.forEach(cb => {
                                        cb.checked = !allChecked;
                                    });
                                    updateDeleteButton();
                                });
                            }
                            
                            // Event listener para apagar selecionados
                            if (deleteSelectedBtn) {
                                deleteSelectedBtn.addEventListener('click', async () => {
                                    const selectedIds = Array.from(document.querySelectorAll('.script-checkbox:checked'))
                                        .map(cb => cb.getAttribute('data-script-id'));
                                    
                                    if (selectedIds.length === 0) {
                                        showMessage('biblioteca-error-message', 'Nenhum roteiro selecionado.', true);
                                        return;
                                    }
                                    
                                    const confirmed = await showStyledConfirm(
                                        `Tem certeza que deseja excluir ${selectedIds.length} roteiro(s)?`,
                                        'Confirmar Exclusão'
                                    );
                                    if (!confirmed) {
                                        return;
                                    }
                                    
                                    try {
                                        const deletePromises = selectedIds.map(id => 
                                            fetch(`${API_BASE}/api/scripts/${id}`, {
                                                method: 'DELETE',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            })
                                        );
                                        
                                        const results = await Promise.all(deletePromises);
                                        const failed = results.filter(r => !r.ok).length;
                                        
                                        if (failed === 0) {
                                            showMessage('biblioteca-success-message', `${selectedIds.length} roteiro(s) excluído(s) com sucesso!`);
                                            loadBibliotecaScripts();
                                        } else {
                                            showMessage('biblioteca-error-message', `${failed} roteiro(s) não puderam ser excluídos.`, true);
                                        }
                                    } catch (err) {
                                        showMessage('biblioteca-error-message', 'Erro ao excluir roteiros: ' + err.message, true);
                                    }
                                });
                            }
                            
                            // Função para atualizar botão de apagar selecionados
                            function updateDeleteButton() {
                                const selectedCount = document.querySelectorAll('.script-checkbox:checked').length;
                                const deleteBtn = document.getElementById('delete-selected-scripts');
                                const countSpan = document.getElementById('selected-count');
                                
                                if (deleteBtn) {
                                    deleteBtn.style.display = selectedCount > 0 ? 'flex' : 'none';
                                }
                                if (countSpan) {
                                    countSpan.textContent = selectedCount;
                                }
                            }
                            
                            // Adicionar event listeners
                            document.querySelectorAll('.btn-view-script').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const scriptId = btn.getAttribute('data-script-id');
                                    const scriptTitle = btn.getAttribute('data-script-title');
                                    const scriptDuration = parseInt(btn.getAttribute('data-script-duration')) || 5;
                                    try {
                                        const response = await fetch(`${API_BASE}/api/scripts/${scriptId}`, {
                                            headers: { 'Authorization': `Bearer ${userToken}` }
                                        });
                                        if (!response.ok) throw new Error('Erro ao carregar roteiro');
                                        const data = await response.json();
                                        showScriptResult(data.script.script_content || data.script.content || '', scriptTitle, scriptDuration);
                                    } catch (err) {
                                        alert('Erro ao carregar roteiro: ' + err.message);
                                    }
                                });
                            });

                            document.querySelectorAll('.btn-download-script-srt').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    const scriptContent = btn.getAttribute('data-script-content');
                                    const scriptTitle = btn.getAttribute('data-script-title');
                                    // Carregar conteúdo completo
                                    fetch(`${API_BASE}/api/scripts/${btn.getAttribute('data-script-id')}`, {
                                        headers: { 'Authorization': `Bearer ${userToken}` }
                                    })
                                    .then(res => res.json())
                                    .then(data => {
                                        let fullContent = data.script?.script_content || data.script?.content || '';
                                        
                                        // Remover marcações de pausa dramática (entre chaves {} ou colchetes [])
                                        // Remover marcações de PARTE X e intervalos de tempo
                                        fullContent = fullContent
                                            .replace(/\{[^}]*\}/g, '') // Remove {texto}
                                            .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                                            .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00"
                                            .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00"
                                            .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no início da linha
                                            .replace(/\s+/g, ' ') // Normalizar espaços
                                            .trim();
                                        
                                        // Estimar duração baseado no tamanho (130 palavras/minuto para narração mais rigorosa, ~5 caracteres/palavra)
                                        const estimatedDuration = Math.max(5, Math.ceil(fullContent.length / (130 * 5)));
                                        const srtContent = generateSRT(fullContent, estimatedDuration);
                                        downloadSRT(srtContent, scriptTitle || 'roteiro');
                                    })
                                    .catch(err => {
                                        showStyledAlert('Erro ao baixar SRT: ' + err.message, 'Erro');
                                    });
                                });
                            });

                            document.querySelectorAll('.btn-delete-script').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const scriptId = btn.getAttribute('data-script-id');
                                    const confirmed = await showStyledConfirm(
                                        'Tem certeza que deseja excluir este roteiro?',
                                        'Confirmar Exclusão'
                                    );
                                    if (confirmed) {
                                        try {
                                            const response = await fetch(`${API_BASE}/api/scripts/${scriptId}`, {
                                                method: 'DELETE',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            });
                                            if (!response.ok) throw new Error('Erro ao excluir roteiro');
                                            loadBibliotecaScripts();
                                            showMessage('biblioteca-success-message', 'Roteiro excluído com sucesso!');
                                        } catch (err) {
                                            showMessage('biblioteca-error-message', 'Erro ao excluir roteiro: ' + err.message, true);
                                        }
                                    }
                                });
                            });

                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            list.innerHTML = `
                                <div class="col-span-full text-center py-12">
                                    <i data-lucide="file-text" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                                    <p class="text-gray-400 text-lg mb-2">Nenhum roteiro gerado ainda</p>
                                    <p class="text-gray-500 text-sm">Os roteiros gerados pelos agentes aparecerão aqui</p>
                                </div>
                            `;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }
                    }
                } catch (err) {
                    console.error('[Biblioteca] Erro ao carregar roteiros:', err);
                    const list = document.getElementById('biblioteca-scripts-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar roteiros: ${err.message}</p>`;
                    }
                }
            }

            async function loadBibliotecaAgents() {
                console.log('[Biblioteca] Carregando agentes de roteiro...');
                if (!userToken) {
                    console.error('[Biblioteca] Token de usuário não encontrado');
                    return;
                }
                try {
                    const list = document.getElementById('biblioteca-agents-list');
                    if (!list) {
                        console.error('[Biblioteca] Elemento biblioteca-agents-list não encontrado');
                        return;
                    }

                    list.innerHTML = '<p class="text-gray-400">Carregando agentes...</p>';

                    const response = await fetch(`${API_BASE}/api/script-agents`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar agentes: ${response.status}`);
                    }

                    const data = await response.json();
                    const agents = data.agents || [];
                    console.log('[Biblioteca] Agentes recebidos:', agents.length);

                    if (list) {
                        if (agents.length > 0) {
                            list.innerHTML = agents.map(agent => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 hover:border-amber-500 transition-colors">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-white mb-2">${escapeHtml(agent.agent_name || 'Sem nome')}</h3>
                                            <div class="space-y-1 text-sm text-gray-400">
                                                ${agent.niche ? `<p><span class="text-amber-500">Nicho:</span> ${escapeHtml(agent.niche)}</p>` : ''}
                                                ${agent.subniche ? `<p><span class="text-amber-500">Sub-nicho:</span> ${escapeHtml(agent.subniche)}</p>` : ''}
                                                ${agent.source_video_title ? `<p class="text-xs text-gray-500 mt-2">Baseado em: ${escapeHtml(agent.source_video_title.substring(0, 50))}${agent.source_video_title.length > 50 ? '...' : ''}</p>` : ''}
                                                <p class="text-xs text-gray-500 mt-2">Usado ${agent.usage_count || 0} vez${agent.usage_count !== 1 ? 'es' : ''}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2 mt-4">
                                        <button class="btn-use-agent flex-1 py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition-colors flex items-center justify-center space-x-2" data-agent-id="${agent.id}" data-agent-name="${escapeHtml(agent.agent_name)}">
                                            <i data-lucide="play"></i>
                                            <span>Usar Agente</span>
                                        </button>
                                        <button class="btn-delete-agent py-2 px-3 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors" data-agent-id="${agent.id}" title="Excluir agente">
                                            <i data-lucide="trash-2"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            
                            // Adicionar event listeners
                            document.querySelectorAll('.btn-use-agent').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const agentId = btn.getAttribute('data-agent-id');
                                    const agentName = btn.getAttribute('data-agent-name');
                                    openGenerateScriptModal(agentId, agentName);
                                });
                            });

                            document.querySelectorAll('.btn-delete-agent').forEach(btn => {
                                btn.addEventListener('click', async () => {
                                    const agentId = btn.getAttribute('data-agent-id');
                                    if (confirm('Tem certeza que deseja excluir este agente?')) {
                                        try {
                                            const response = await fetch(`${API_BASE}/api/script-agents/${agentId}`, {
                                                method: 'DELETE',
                                                headers: { 'Authorization': `Bearer ${userToken}` }
                                            });
                                            if (!response.ok) throw new Error('Erro ao excluir agente');
                                            loadBibliotecaAgents();
                                            showMessage('biblioteca-success-message', 'Agente excluído com sucesso!');
                                        } catch (err) {
                                            showMessage('biblioteca-error-message', 'Erro ao excluir agente: ' + err.message, true);
                                        }
                                    }
                                });
                            });

                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        } else {
                            list.innerHTML = `
                                <div class="col-span-full text-center py-12">
                                    <i data-lucide="bot" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
                                    <p class="text-gray-400 text-lg mb-2">Nenhum agente de roteiro criado ainda</p>
                                    <p class="text-gray-500 text-sm">Crie seu primeiro agente a partir de um vídeo analisado</p>
                                </div>
                            `;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }
                    }
                } catch (err) {
                    console.error('[Biblioteca] Erro ao carregar agentes:', err);
                    const list = document.getElementById('biblioteca-agents-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar agentes: ${err.message}</p>`;
                    }
                }
            }

            function openGenerateScriptModal(agentId, agentName) {
                console.log(`[Generate Script Modal] Abrindo modal - agentId: ${agentId}, agentName: ${agentName}`);
                
                // Criar modal dinamicamente ou usar existente
                let modal = document.getElementById('generate-script-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'generate-script-modal';
                    modal.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center';
                    modal.innerHTML = `
                        <div class="bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Gerar Roteiro com Agente</h3>
                                <button id="close-generate-script-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <form id="generate-script-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Agente <span class="text-amber-500">*</span></label>
                                    <input type="text" id="generate-script-agent-name" readonly class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 cursor-not-allowed" required>
                                    <input type="hidden" id="generate-script-agent-id" value="">
                                    <p class="text-xs text-gray-400 mt-1">Agente selecionado para gerar o roteiro</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Título do Vídeo <span class="text-amber-500">*</span></label>
                                    <input type="text" id="generate-script-title" placeholder="Cole aqui o título do vídeo para o qual deseja gerar o roteiro..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                                    <p class="text-xs text-gray-400 mt-1">O agente irá analisar o título e gerar um roteiro completo seguindo a estrutura do vídeo viral original.</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Duração (min) <span class="text-amber-500">*</span></label>
                                        <input type="number" id="generate-script-duration" min="3" max="120" value="5" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                                        <p class="text-xs text-gray-400 mt-1">Palavras: ~<span id="duration-words">650</span></p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Partes (Automático)</label>
                                        <input type="text" id="generate-script-parts" readonly class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 cursor-not-allowed">
                                        <p class="text-xs text-gray-400 mt-1">Partes de 3 minutos cada</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Idioma do Roteiro <span class="text-amber-500">*</span></label>
                                        <select id="generate-script-language" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                                            <option value="pt" selected>Português (Brasil)</option>
                                            <option value="pt-PT">Português (Portugal)</option>
                                            <option value="es">Español</option>
                                            <option value="en">English</option>
                                            <option value="fr">Français</option>
                                            <option value="de">Deutsch</option>
                                            <option value="it">Italiano</option>
                                            <option value="ru">Русский</option>
                                            <option value="ja">日本語</option>
                                            <option value="zh">中文</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Call to Action (CTA) - Onde incluir?</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="cta-inicio" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500">
                                            <span class="text-sm text-gray-300">CTA no Início (primeiros 30 segundos)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="cta-meio" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500">
                                            <span class="text-sm text-gray-300">CTA no Meio (aproximadamente na metade do vídeo)</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="cta-final" class="w-4 h-4 text-amber-600 bg-gray-800 border-gray-700 rounded focus:ring-amber-500" checked>
                                            <span class="text-sm text-gray-300">CTA no Final (últimos 30 segundos)</span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Marque onde deseja incluir chamadas para ação (like, subscribe, comentar, etc.)</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo de IA</label>
                                    <select id="generate-script-model" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="claude-3-7-sonnet-20250219" selected>Claude 3.7 Sonnet (Fev/25) ⭐ Recomendado</option>
                                        <option value="gpt-4o">GPT-4o (2025)</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Tópico Adicional (Opcional)</label>
                                    <textarea id="generate-script-topic" rows="3" placeholder="Se desejar, adicione informações adicionais sobre o tópico ou contexto específico..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                                    <p class="text-xs text-gray-400 mt-1">Opcional: Use apenas se quiser fornecer contexto adicional além do título.</p>
                                </div>
                                <div class="flex space-x-4">
                                    <button type="button" id="cancel-generate-script" class="flex-1 py-3 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                    <button type="submit" id="submit-generate-script" class="flex-1 py-3 px-4 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold flex items-center justify-center space-x-2">
                                        <span>Gerar Roteiro</span>
                                        <div class="btn-spinner hidden"></div>
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    document.getElementById('close-generate-script-modal').addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                    
                    // Atualizar partes quando a duração mudar
                    const durationInput = document.getElementById('generate-script-duration');
                    if (durationInput) {
                        durationInput.addEventListener('input', updateScriptParts);
                        durationInput.addEventListener('change', updateScriptParts);
                    }
                    document.getElementById('cancel-generate-script').addEventListener('click', () => {
                        modal.style.display = 'none';
                    });

                    document.getElementById('generate-script-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const agentNameField = document.getElementById('generate-script-agent-name');
                        const agentIdField = document.getElementById('generate-script-agent-id');
                        const title = document.getElementById('generate-script-title').value.trim();
                        const topic = document.getElementById('generate-script-topic').value.trim();
                        const duration = document.getElementById('generate-script-duration').value;
                        const language = document.getElementById('generate-script-language').value;
                        const model = document.getElementById('generate-script-model').value;
                        const ctaInicio = document.getElementById('cta-inicio').checked;
                        const ctaMeio = document.getElementById('cta-meio').checked;
                        const ctaFinal = document.getElementById('cta-final').checked;
                        
                        const agentId = agentIdField ? agentIdField.value : null;
                        
                        console.log(`[Generate Script] Submetendo formulário - agentId: ${agentId}, agentName: ${agentNameField?.value}`);
                        
                        if (!agentId || !agentNameField || !agentNameField.value) {
                            alert('Erro: Agente não encontrado. Por favor, selecione um agente novamente.');
                            return;
                        }
                        
                        if (!title) {
                            alert('Por favor, informe o título do vídeo.');
                            return;
                        }

                        if (!duration) {
                            alert('Por favor, selecione a duração do roteiro.');
                            return;
                        }

                        if (!language) {
                            alert('Por favor, selecione o idioma do roteiro.');
                            return;
                        }

                        const btn = document.getElementById('submit-generate-script');
                        setButtonLoading(btn, true);
                        
                        // Calcular duração ajustada (mesma lógica do updateScriptParts)
                        const baseDuration = parseInt(duration) || 5;
                        const additionalMinutes = Math.min(5, Math.max(3, Math.ceil(baseDuration * 0.2))); // 20% da duração, mínimo 3, máximo 5
                        const adjustedDuration = baseDuration + additionalMinutes;
                        const parsedDuration = adjustedDuration; // Usar duração ajustada
                        
                        const partsInput = document.getElementById('generate-script-parts');
                        const partsCount = partsInput ? (parseInt(partsInput.value) || Math.max(1, Math.ceil(parsedDuration / 3))) : Math.max(1, Math.ceil(parsedDuration / 3));
                        const sessionId = (window.crypto && typeof window.crypto.randomUUID === 'function')
                            ? window.crypto.randomUUID()
                            : `session-${Date.now()}`;
                        
                        console.log(`[Generate Script] Duração original: ${baseDuration} min, Duração ajustada enviada: ${parsedDuration} min (+${additionalMinutes} min)`);
                        
                        // Mostrar modal de progresso real-time
                        showProgressModal(parsedDuration, partsCount);
                        startScriptProgressStream(sessionId, partsCount);
                        
                        try {
                            // Verificar se laozhang.ai está configurada como padrão
                            let useLaozhang = false;
                            try {
                                const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                if (settingsResponse.ok) {
                                    const settings = await settingsResponse.json();
                                    useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                                }
                            } catch (err) {
                                console.warn('[Generate Script] Erro ao verificar configuração laozhang.ai:', err);
                            }
                            
                            const endpoint = useLaozhang ? `/api/script-agents/${agentId}/generate/laozhang` : `/api/script-agents/${agentId}/generate`;
                            const selectedModel = model || 'claude-3-7-sonnet-20250219';
                            
                            const response = await fetch(`${API_BASE}${endpoint}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${userToken}`
                                },
                                body: JSON.stringify({ 
                                    title: title,
                                    topic: topic || null,
                                    duration: parsedDuration,
                                    language: language,
                                    cta: {
                                        inicio: ctaInicio,
                                        meio: ctaMeio,
                                        final: ctaFinal
                                    },
                                    model: useLaozhang ? null : selectedModel,
                                    selectedModel: selectedModel,
                                    parts: partsCount,
                                    sessionId
                                })
                            });

                            if (!response.ok) {
                                hideProgressModal();
                                const errorData = await response.json();
                                throw new Error(errorData.msg || 'Erro ao gerar roteiro');
                            }

                            const data = await response.json();
                            console.log('[Roteiro] Dados recebidos:', data);
                            
                            modal.style.display = 'none';
                            
                            // Extrair o roteiro (pode vir em diferentes formatos)
                            let scriptText = '';
                            if (typeof data.script === 'string') {
                                scriptText = data.script;
                            } else if (data.script && typeof data.script === 'object') {
                                // Se for objeto, tentar extrair conteúdo
                                if (data.script.content) {
                                    scriptText = data.script.content;
                                } else if (data.script.script && Array.isArray(data.script.script)) {
                                    // Se for array de objetos (formato JSON)
                                    scriptText = data.script.script.map(item => {
                                        if (item.content) {
                                            const timeStr = item.time ? `[${item.time}] ` : '';
                                            return timeStr + item.content;
                                        }
                                        return '';
                                    }).filter(Boolean).join('\n\n');
                                } else if (data.script.roteiro) {
                                    scriptText = data.script.roteiro;
                                } else {
                                    scriptText = JSON.stringify(data.script, null, 2);
                                }
                            } else {
                                scriptText = data.script || '';
                            }
                            
                            console.log('[Roteiro] Script extraído (primeiros 200 caracteres):', scriptText.substring(0, 200));
                            
                            // Limpar JSON se ainda houver
                            scriptText = scriptText
                                .replace(/\{[\s\S]*?"roteiro"[\s\S]*?\}/g, '')
                                .replace(/"roteiro"\s*:\s*"([^"]+)"/gi, '$1')
                                .replace(/"duracao"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/"estrutura"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/\{[\s\S]*\}/g, '')
                                .trim();
                            
                            if (!scriptText || scriptText.length === 0) {
                                console.error('[Roteiro] Script vazio após processamento');
                                hideProgressModal();
                                alert('Erro: O roteiro gerado está vazio. Por favor, tente novamente.');
                                return;
                            }
                            
                            // Validar quantidade de palavras antes de fechar o modal
                            const wordCount = scriptText.trim().split(/\s+/).filter(w => w.length > 0).length;
                            const expectedWords = parsedDuration * 130; // 130 palavras/minuto (mais rigoroso)
                            const minWords = expectedWords - 40; // Margem menor para ser mais rigoroso
                            const maxWords = expectedWords + 100;
                            
                            console.log(`[Roteiro] Validação: ${wordCount} palavras encontradas, esperado: ${expectedWords} (tolerância: ${minWords}-${maxWords})`);
                            
                            // Atualizar barra de progresso com informação de palavras
                            const progressBar = document.getElementById('progress-bar');
                            const progressText = document.getElementById('progress-text');
                            
                            // Se estiver muito abaixo do mínimo, avisar mas continuar (o backend já tentou expandir)
                            if (wordCount < minWords) {
                                const percentage = Math.round((wordCount / expectedWords) * 100);
                                if (progressBar) progressBar.style.width = '95%';
                                if (progressText) {
                                    progressText.textContent = `Roteiro gerado: ${wordCount} palavras (${percentage}% da meta de ${expectedWords}). Finalizando...`;
                                }
                                
                                // Avisar que está abaixo do ideal, mas continuar
                                console.warn(`[Roteiro] Roteiro abaixo do ideal: ${wordCount} palavras (meta: ${expectedWords}), mas continuando...`);
                            }
                            
                            if (wordCount > maxWords) {
                                console.warn(`[Roteiro] Roteiro muito longo: ${wordCount} palavras (máximo: ${maxWords}), mas continuando...`);
                            }
                            
                            setTimeout(() => {
                                hideProgressModal();
                                // Calcular informações do roteiro
                                const wordCount = scriptText.trim().split(/\s+/).filter(w => w.length > 0).length;
                                const estimatedMinutes = Math.round((wordCount / 130) * 10) / 10; // 130 palavras/minuto
                                showScriptResult(scriptText, agentName, parsedDuration, wordCount, estimatedMinutes);
                            }, 1200);
                        } catch (err) {
                            hideProgressModal();
                            alert('Erro ao gerar roteiro: ' + err.message);
                        } finally {
                            setButtonLoading(btn, false);
                        }
                    });
                }

                // Atualizar campos do agente
                const agentNameInput = document.getElementById('generate-script-agent-name');
                const agentIdInput = document.getElementById('generate-script-agent-id');
                if (agentNameInput) {
                    agentNameInput.value = agentName || '';
                }
                if (agentIdInput) {
                    agentIdInput.value = agentId || '';
                }
                console.log(`[Generate Script Modal] Atualizando modal - agentId: ${agentId}, agentName: ${agentName}`);
                
                document.getElementById('generate-script-title').value = '';
                document.getElementById('generate-script-topic').value = '';
                const durationInput = document.getElementById('generate-script-duration');
                if (durationInput) {
                    durationInput.value = '5';
                    // Atualizar palavras inicialmente (5 min * 130 palavras/min = 650 palavras)
                    const wordsSpan = document.getElementById('duration-words');
                    if (wordsSpan) {
                        wordsSpan.textContent = '650';
                    }
                }
                document.getElementById('generate-script-language').value = 'pt';
                document.getElementById('generate-script-model').value = 'claude-3-7-sonnet-20250219';
                document.getElementById('cta-inicio').checked = false;
                document.getElementById('cta-meio').checked = false;
                document.getElementById('cta-final').checked = true;
                
                // Atualizar partes automaticamente
                setTimeout(() => {
                    updateScriptParts();
                }, 100);
                
                modal.style.display = 'flex';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function updateScriptParts() {
                const durationInput = document.getElementById('generate-script-duration');
                const partsInput = document.getElementById('generate-script-parts');
                const wordsSpan = document.getElementById('duration-words');
                
                if (durationInput && partsInput && wordsSpan) {
                    const duration = parseInt(durationInput.value) || 5;
                    // Adicionar 3-5 minutos a mais na duração mostrada ao usuário
                    const additionalMinutes = Math.min(5, Math.max(3, Math.ceil(duration * 0.2))); // 20% da duração, mínimo 3, máximo 5
                    const displayedDuration = duration + additionalMinutes;
                    const basePartDuration = 3;
                    const numberOfParts = Math.max(1, Math.ceil(displayedDuration / basePartDuration));
                    const wordsTarget = displayedDuration * 130; // 130 palavras/minuto (mais rigoroso)
                    
                    partsInput.value = numberOfParts;
                    // Atualizar texto mostrando duração ajustada
                    const parentElement = wordsSpan.parentElement;
                    if (parentElement) {
                        parentElement.innerHTML = `Palavras: ~<span id="duration-words">${wordsTarget.toLocaleString('pt-BR')}</span> <span class="text-amber-500">(duração ajustada: ${displayedDuration} min)</span>`;
                    } else {
                    wordsSpan.textContent = wordsTarget.toLocaleString('pt-BR');
                    }
                }
            }

            // ===== FUNÇÕES DE PROGRESSO DO ROTEIRO (ESCOPO GLOBAL) =====
            function showProgressModal(duration, partsCount = 1) {
                let progressModal = document.getElementById('script-progress-modal');
                if (!progressModal) {
                    progressModal = document.createElement('div');
                    progressModal.id = 'script-progress-modal';
                    progressModal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center';
                    progressModal.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4 transform transition-all">
                            <div class="text-center mb-6">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-4 ring-4 ring-amber-500/20 animate-pulse">
                                    <i data-lucide="sparkles" class="w-10 h-10 text-amber-400 animate-spin"></i>
                                </div>
                                <h3 class="text-3xl font-bold text-white mb-2 bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-400 bg-clip-text text-transparent animate-pulse">Gerando Roteiro...</h3>
                                <p class="text-gray-300 text-sm mb-1" id="progress-main-status">Inicializando geração...</p>
                                <p class="text-gray-400 text-xs" id="progress-sub-status">Preparando IA e carregando fórmula viral</p>
                            </div>
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-white font-bold text-lg" id="progress-parts-counter">0/0</span>
                                        <span class="text-gray-400 text-sm">partes</span>
                                    </div>
                                    <span id="progress-percentage" class="text-amber-400 font-bold text-2xl">0%</span>
                                </div>
                                <div class="w-full bg-gray-800/50 rounded-full h-4 overflow-hidden border border-gray-700/50 shadow-inner">
                                    <div id="progress-bar" class="h-full bg-gradient-to-r from-amber-500 via-yellow-400 to-amber-500 rounded-full transition-all duration-500 ease-out relative" style="width: 0%; background-size: 200% 100%; animation: shimmer 2s infinite;">
                                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent animate-shimmer"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="parts-progress" class="mb-4 max-h-48 overflow-y-auto space-y-2" style="display: none;">
                                <p class="text-xs text-gray-400 mb-1">Partes:</p>
                                <div id="parts-list" class="space-y-1 max-h-32 overflow-y-auto"></div>
                            </div>
                            <p id="progress-text" class="text-center text-gray-400 text-xs">Iniciando...</p>
                        </div>
                    `;
                    document.body.appendChild(progressModal);
                }
                
                const wordsTarget = duration * 150;
                const minWords = wordsTarget - 50;
                const maxWords = wordsTarget + 100;
                
                progressModal.dataset.wordsTarget = wordsTarget;
                progressModal.dataset.minWords = minWords;
                progressModal.dataset.maxWords = maxWords;
                progressModal.dataset.duration = duration;
                progressModal.dataset.numberOfParts = partsCount;
                progressModal.dataset.currentPart = 0;
                progressModal.dataset.completedParts = 0;
                progressModal.dataset.renderedParts = 0;
                
                renderPartIndicators(partsCount);
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const progressMainStatus = document.getElementById('progress-main-status');
                const progressSubStatus = document.getElementById('progress-sub-status');
                const progressPercentage = document.getElementById('progress-percentage');
                const progressPartsCounter = document.getElementById('progress-parts-counter');
                
                if (progressBar) progressBar.style.width = '0%';
                if (progressPercentage) progressPercentage.textContent = '0%';
                if (progressMainStatus) progressMainStatus.textContent = 'Inicializando geração...';
                if (progressSubStatus) progressSubStatus.textContent = `Preparando IA do agente (meta: ${wordsTarget.toLocaleString('pt-BR')} palavras)...`;
                if (progressPartsCounter) progressPartsCounter.textContent = `0/${partsCount}`;
                if (progressText) progressText.textContent = 'Iniciando geração...';
                
                progressModal.style.display = 'flex';
            }
            
            function renderPartIndicators(totalParts) {
                const progressModal = document.getElementById('script-progress-modal');
                const partsProgress = document.getElementById('parts-progress');
                const partsList = document.getElementById('parts-list');
                if (!progressModal || !partsProgress || !partsList) return;
                
                if (totalParts > 1) {
                    partsProgress.style.display = 'block';
                    partsList.innerHTML = '';
                    for (let i = 1; i <= totalParts; i++) {
                        const partDiv = document.createElement('div');
                        partDiv.id = `part-${i}`;
                        partDiv.className = 'flex items-center justify-between bg-gray-800/70 rounded-md px-3 py-2 text-xs';
                        partDiv.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="part-${i}-indicator"></div>
                                <span class="text-gray-300 font-semibold">Parte ${i}</span>
                            </div>
                            <span class="text-gray-500 text-[11px]" id="part-${i}-status">Aguardando...</span>
                        `;
                        partsList.appendChild(partDiv);
                    }
                } else {
                    partsProgress.style.display = 'none';
                    partsList.innerHTML = '';
                }
                
                progressModal.dataset.renderedParts = totalParts;
            }
            
            function updatePartProgress(partNumber, status, percentage = 0) {
                const partDiv = document.getElementById(`part-${partNumber}`);
                const partIndicator = document.getElementById(`part-${partNumber}-indicator`);
                const partStatus = document.getElementById(`part-${partNumber}-status`);
                
                if (partIndicator && partStatus) {
                    if (status === 'generating') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse ring-2 ring-amber-400/50';
                        partStatus.textContent = percentage > 0 ? `⏳ Gerando... ${percentage}%` : '⏳ Gerando...';
                        partStatus.className = 'text-amber-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-amber-900/20 rounded-md px-3 py-2 text-xs border border-amber-700/30';
                    } else if (status === 'completed') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-green-500 ring-2 ring-green-400/50';
                        partStatus.textContent = '✓ Concluída';
                        partStatus.className = 'text-green-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-green-900/20 rounded-md px-3 py-2 text-xs border border-green-700/30';
                    } else if (status === 'expanding') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse ring-2 ring-blue-400/50';
                        partStatus.textContent = percentage > 0 ? `📝 Expandindo... ${percentage}%` : '📝 Expandindo...';
                        partStatus.className = 'text-blue-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-blue-900/20 rounded-md px-3 py-2 text-xs border border-blue-700/30';
                    } else if (status === 'waiting') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-gray-700 animate-pulse';
                        partStatus.textContent = '⏸ Aguardando...';
                        partStatus.className = 'text-gray-500 text-[11px]';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-gray-800/70 rounded-md px-3 py-2 text-xs';
                    } else if (status === 'warning') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-yellow-500 ring-2 ring-yellow-400/50';
                        partStatus.textContent = '⚠ Revisar manualmente';
                        partStatus.className = 'text-yellow-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-yellow-900/20 rounded-md px-3 py-2 text-xs border border-yellow-700/30';
                    } else if (status === 'error') {
                        partIndicator.className = 'w-2.5 h-2.5 rounded-full bg-red-500 ring-2 ring-red-400/50';
                        partStatus.textContent = '❌ Erro na geração';
                        partStatus.className = 'text-red-400 text-[11px] font-medium';
                        if (partDiv) partDiv.className = 'flex items-center justify-between bg-red-900/20 rounded-md px-3 py-2 text-xs border border-red-700/30';
                    }
                }
            }
            
            function handleScriptProgressUpdate(data) {
                const progressModal = document.getElementById('script-progress-modal');
                if (!progressModal || !data) return;
                
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const progressMainStatus = document.getElementById('progress-main-status');
                const progressSubStatus = document.getElementById('progress-sub-status');
                const progressPercentage = document.getElementById('progress-percentage');
                const progressPartsCounter = document.getElementById('progress-parts-counter');
                
                // Atualizar número total de partes
                if (typeof data.totalParts === 'number') {
                    const rendered = parseInt(progressModal.dataset.renderedParts) || 0;
                    if (rendered !== data.totalParts) {
                        renderPartIndicators(data.totalParts);
                    }
                    progressModal.dataset.numberOfParts = data.totalParts;
                }
                
                // Atualizar parte atual e calcular porcentagem baseado em partes concluídas
                let completedParts = 0;
                if (typeof data.currentPart === 'number') {
                    progressModal.dataset.currentPart = data.currentPart;
                    completedParts = data.currentPart;
                } else if (data.details && typeof data.details.completedParts !== 'undefined') {
                    completedParts = data.details.completedParts;
                } else if (data.details && data.details.status === 'completed' && data.details.partNumber) {
                    completedParts = data.details.partNumber;
                }
                
                    const totalParts = parseInt(progressModal.dataset.numberOfParts) || 1;
                
                // Atualizar contador de partes (X/5 partes)
                if (progressPartsCounter && completedParts > 0) {
                    progressPartsCounter.textContent = `${completedParts}/${totalParts} partes`;
                }
                
                // Calcular porcentagem baseado em partes concluídas
                let calculatedProgress = 0;
                if (completedParts > 0 && totalParts > 0) {
                    calculatedProgress = Math.min(95, Math.round((completedParts / totalParts) * 100));
                } else if (typeof data.progress === 'number') {
                    calculatedProgress = data.progress;
                }
                
                // Atualizar barra de progresso e porcentagem
                if (progressBar && progressPercentage) {
                    const safeProgress = Math.max(0, Math.min(100, calculatedProgress));
                    progressBar.style.width = `${safeProgress}%`;
                    progressBar.style.transition = 'width 0.5s ease-out';
                    progressPercentage.textContent = `${Math.round(safeProgress)}%`;
                }
                
                // Atualizar mensagens principais e secundárias
                if (data.stage) {
                    const stageMessages = {
                        'preparing': {
                            main: 'Preparando IA do agente...',
                            sub: 'Carregando fórmula viral e configurações'
                        },
                        'generating': {
                            main: 'Gerando roteiro com IA...',
                            sub: data.details?.partNumber ? `Processando parte ${data.details.partNumber}...` : 'Criando conteúdo otimizado'
                        },
                        'expanding': {
                            main: 'Expandindo conteúdo...',
                            sub: 'Ajustando minutagem e detalhando narrativa'
                        },
                        'optimizing': {
                            main: 'Otimizando roteiro...',
                            sub: 'Aplicando melhorias e validações'
                        },
                        'validating': {
                            main: 'Validando qualidade...',
                            sub: 'Verificando estrutura e elementos virais'
                        },
                        'finalizing': {
                            main: 'Finalizando...',
                            sub: 'Preparando roteiro final'
                        }
                    };
                    
                    const stageInfo = stageMessages[data.stage] || {
                        main: data.message || 'Processando...',
                        sub: 'Aguarde enquanto geramos seu roteiro'
                    };
                    
                    if (progressMainStatus) progressMainStatus.textContent = stageInfo.main;
                    if (progressSubStatus) progressSubStatus.textContent = stageInfo.sub;
                } else if (data.message) {
                    if (progressMainStatus) progressMainStatus.textContent = data.message;
                    if (progressSubStatus) {
                        const progress = typeof data.progress === 'number' ? Math.round(data.progress) : 0;
                        progressSubStatus.textContent = `Progresso: ${progress}% - Aguarde...`;
                    }
                }
                
                if (data.message && progressText) {
                    progressText.textContent = data.message;
                }
                
                if (data.details && data.details.partNumber && data.details.status) {
                    updatePartProgress(
                        data.details.partNumber,
                        data.details.status,
                        data.details.percentage || 0
                    );
                    
                    // Atualizar contador de partes baseado no status
                    const totalParts = parseInt(progressModal.dataset.numberOfParts) || 1;
                    if (data.details.status === 'generating') {
                        // Parte começando a ser gerada
                        if (progressPartsCounter) {
                            progressPartsCounter.textContent = `${data.details.partNumber}/${totalParts} partes`;
                        }
                        if (progressMainStatus) {
                        progressMainStatus.textContent = `Gerando parte ${data.details.partNumber}...`;
                        }
                        if (progressSubStatus) {
                        progressSubStatus.textContent = `Criando conteúdo narrativo (${data.details.percentage || 0}%)`;
                        }
                        // Atualizar porcentagem baseado na parte sendo gerada
                        const partProgress = Math.min(95, 10 + ((data.details.partNumber - 1 + (data.details.percentage || 0) / 100) / totalParts) * 85);
                        if (progressBar) progressBar.style.width = `${partProgress}%`;
                        if (progressPercentage) progressPercentage.textContent = `${Math.round(partProgress)}%`;
                    } else if (data.details.status === 'expanding') {
                        if (progressMainStatus) {
                        progressMainStatus.textContent = `Expandindo parte ${data.details.partNumber}...`;
                        }
                        if (progressSubStatus) {
                        progressSubStatus.textContent = 'Ajustando minutagem e detalhando';
                        }
                    } else if (data.details.status === 'completed') {
                        // Parte concluída
                        if (progressPartsCounter) {
                            progressPartsCounter.textContent = `${data.details.partNumber}/${totalParts} partes`;
                        }
                        if (progressMainStatus) {
                        progressMainStatus.textContent = `Parte ${data.details.partNumber} concluída!`;
                        }
                        if (progressSubStatus) {
                            progressSubStatus.textContent = data.details.partNumber < totalParts ? 'Continuando com próxima parte...' : 'Finalizando roteiro...';
                        }
                        // Atualizar porcentagem baseado em partes concluídas
                        const completedProgress = Math.min(95, 10 + (data.details.partNumber / totalParts) * 85);
                        if (progressBar) {
                            progressBar.style.width = `${completedProgress}%`;
                            progressBar.style.transition = 'width 0.5s ease-out';
                        }
                        if (progressPercentage) {
                            progressPercentage.textContent = `${Math.round(completedProgress)}%`;
                        }
                    }
                }
                
                if (data.stage === 'failed' || data.stage === 'error') {
                    if (progressMainStatus) progressMainStatus.textContent = 'Erro na geração';
                    if (progressSubStatus) progressSubStatus.textContent = 'Tente novamente em alguns instantes';
                    setTimeout(() => hideProgressModal(), 2000);
                }
            }
            
            function startProgressFallback(totalParts) {
                if (scriptProgressFallbackInterval) return;
                let fallbackValue = 0;
                scriptProgressFallbackInterval = setInterval(() => {
                    fallbackValue = Math.min(95, fallbackValue + (Math.random() * 6 + 3));
                    handleScriptProgressUpdate({
                        progress: fallbackValue,
                        message: `Gerando roteiro... (${Math.round(fallbackValue)}% estimado)`,
                        totalParts,
                        details: {
                            completedParts: Math.floor((fallbackValue / 100) * totalParts)
                        }
                    });
                }, 800);
            }
            
            function startScriptProgressStream(sessionId, totalParts) {
                currentProgressSessionId = sessionId;
                
                if (scriptProgressSource) {
                    scriptProgressSource.close();
                    scriptProgressSource = null;
                }
                if (scriptProgressFallbackInterval) {
                    clearInterval(scriptProgressFallbackInterval);
                    scriptProgressFallbackInterval = null;
                }
                
                if (typeof EventSource === 'undefined') {
                    startProgressFallback(totalParts);
                    return;
                }
                
                const source = new EventSource(`${API_BASE}/api/script-agents/progress/${sessionId}?token=${encodeURIComponent(userToken)}`);
                scriptProgressSource = source;
                source.onmessage = (event) => {
                    try {
                        const payload = JSON.parse(event.data);
                        handleScriptProgressUpdate(payload);
                    } catch (err) {
                        console.error('[Progresso] Erro ao ler SSE:', err);
                    }
                };
                source.onerror = () => {
                    if (scriptProgressSource) {
                        scriptProgressSource.close();
                        scriptProgressSource = null;
                    }
                    startProgressFallback(totalParts);
                };
            }
            
            function stopScriptProgressStream() {
                if (scriptProgressSource) {
                    scriptProgressSource.close();
                    scriptProgressSource = null;
                }
                if (scriptProgressFallbackInterval) {
                    clearInterval(scriptProgressFallbackInterval);
                    scriptProgressFallbackInterval = null;
                }
                currentProgressSessionId = null;
            }
            
            function hideProgressModal() {
                const progressModal = document.getElementById('script-progress-modal');
                if (progressModal) {
                    stopScriptProgressStream();
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) progressBar.style.width = '100%';
                    
                    setTimeout(() => {
                        progressModal.style.display = 'none';
                    }, 500);
                }
            }
            // ===== FIM DAS FUNÇÕES DE PROGRESSO =====

            // Função para limpar marcações de partes do roteiro
            function cleanScriptForCopy(script) {
                if (!script || typeof script !== 'string') return script;
                
                let cleaned = script;
                
                // Remover marcações de PARTE X com intervalos de tempo
                cleaned = cleaned.replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '');
                cleaned = cleaned.replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '');
                cleaned = cleaned.replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '');
                cleaned = cleaned.replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '');
                cleaned = cleaned.replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gmi, '');
                cleaned = cleaned.replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '');
                cleaned = cleaned.replace(/PARTE\s+\d+\s*$/gmi, '');
                cleaned = cleaned.replace(/Parte\s+\d+\s*$/gmi, '');
                
                // Remover marcações entre chaves e colchetes
                cleaned = cleaned.replace(/\{[^}]*\}/g, '');
                cleaned = cleaned.replace(/\[[^\]]*\]/g, '');
                
                // Limpar múltiplas quebras de linha
                cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
                cleaned = cleaned.replace(/\s+\n/g, '\n');
                cleaned = cleaned.replace(/\n\s+/g, '\n');
                
                return cleaned.trim();
            }

            // Função para gerar arquivo SRT
            function generateSRT(text, durationMinutes) {
                const cleanedText = cleanScriptForCopy(text);
                const sentences = cleanedText.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 0);
                const totalSeconds = durationMinutes * 60;
                const secondsPerSentence = totalSeconds / sentences.length;
                
                let srt = '';
                let currentTime = 0;
                
                sentences.forEach((sentence, index) => {
                    const startTime = currentTime;
                    const endTime = Math.min(totalSeconds, currentTime + secondsPerSentence);
                    
                    const start = formatSRTTime(startTime);
                    const end = formatSRTTime(endTime);
                    
                    srt += `${index + 1}\n${start} --> ${end}\n${sentence.trim()}\n\n`;
                    
                    currentTime = endTime;
                });
                
                return srt;
            }

            // Função para formatar tempo no formato SRT (HH:MM:SS,mmm)
            function formatSRTTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                const milliseconds = Math.floor((seconds % 1) * 1000);
                
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')},${String(milliseconds).padStart(3, '0')}`;
            }

            // Função para baixar arquivo SRT
            function downloadSRT(srtContent, filename) {
                const blob = new Blob([srtContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename || 'roteiro'}.srt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // Função para exibir resultado do roteiro gerado
            function showScriptResult(scriptText, agentName, requestedDuration, wordCount, estimatedMinutes) {
                const cleanedScript = cleanScriptForCopy(scriptText);
                const actualWordCount = wordCount || cleanedScript.trim().split(/\s+/).filter(w => w.length > 0).length;
                const actualMinutes = estimatedMinutes || Math.round((actualWordCount / 130) * 10) / 10;
                
                // Criar ou obter modal
                let modal = document.getElementById('script-result-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'script-result-modal';
                    modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
                    document.body.appendChild(modal);
                }
                
                const statusClass = actualMinutes <= requestedDuration * 1.1 ? 'text-green-400' : 'text-amber-400';
                const statusIcon = actualMinutes <= requestedDuration * 1.1 ? '✓' : '⚠';
                
                modal.innerHTML = `
                    <div class="bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                        <div class="flex justify-between items-center p-6 border-b border-gray-700">
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-2">Roteiro Gerado</h3>
                                <div class="flex items-center gap-4 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-400">Agente:</span>
                                        <span class="text-amber-400 font-semibold">${escapeHtml(agentName || 'N/A')}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-400">Duração solicitada:</span>
                                        <span class="text-white font-semibold">${requestedDuration} min</span>
                                    </div>
                                </div>
                            </div>
                            <button id="close-script-result-modal" class="text-gray-400 hover:text-white transition">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6 border-b border-gray-700 bg-gray-800/50">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                                    <p class="text-xs text-gray-400 mb-1">Palavras</p>
                                    <p class="text-xl font-bold text-white">${actualWordCount.toLocaleString('pt-BR')}</p>
                                </div>
                                <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                                    <p class="text-xs text-gray-400 mb-1">Duração Estimada</p>
                                    <p class="text-xl font-bold ${statusClass}">${statusIcon} ${actualMinutes.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })} min</p>
                                </div>
                                <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                                    <p class="text-xs text-gray-400 mb-1">Status</p>
                                    <p class="text-sm font-semibold ${statusClass}">${actualMinutes <= requestedDuration * 1.1 ? 'Dentro do esperado' : 'Acima do esperado'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-6">
                            <textarea id="script-result-text" readonly class="w-full h-full min-h-[400px] px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 text-sm resize-none font-mono">${escapeHtml(cleanedScript)}</textarea>
                        </div>
                        <div class="flex justify-end gap-3 p-6 border-t border-gray-700 bg-gray-800/50">
                            <button id="copy-script-btn" class="px-6 py-3 bg-amber-600 hover:bg-amber-500 text-black font-semibold rounded-lg transition flex items-center gap-2">
                                <i data-lucide="clipboard-copy" class="w-5 h-5"></i>
                                <span>Copiar Roteiro</span>
                            </button>
                            <button id="download-srt-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-lg transition flex items-center gap-2">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                <span>Baixar SRT</span>
                            </button>
                            <button id="close-script-result-btn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition">
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
                
                // Event listeners
                document.getElementById('close-script-result-modal').addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                document.getElementById('close-script-result-btn').addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                document.getElementById('copy-script-btn').addEventListener('click', () => {
                    const cleaned = cleanScriptForCopy(cleanedScript);
                    navigator.clipboard.writeText(cleaned).then(() => {
                        const btn = document.getElementById('copy-script-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i> <span>Copiado!</span>';
                        btn.classList.remove('bg-amber-600', 'hover:bg-amber-500');
                        btn.classList.add('bg-green-600', 'hover:bg-green-500');
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('bg-green-600', 'hover:bg-green-500');
                            btn.classList.add('bg-amber-600', 'hover:bg-amber-500');
                        }, 2000);
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }).catch(err => {
                        alert('Erro ao copiar: ' + err.message);
                    });
                });
                
                document.getElementById('download-srt-btn').addEventListener('click', () => {
                    const cleaned = cleanScriptForCopy(cleanedScript);
                    const srtContent = generateSRT(cleaned, actualMinutes);
                    downloadSRT(srtContent, `${agentName || 'roteiro'}-${actualMinutes}min`);
                });
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Função para formatar roteiro em partes (cada parte ~3 minutos, dividida em 5 parágrafos)
            function formatScriptIntoParts(script, totalDuration) {
                if (!script || !script.trim()) {
                    return '<p class="text-gray-400">Roteiro vazio.</p>';
                }
                
                // Calcular número de partes (cada parte = 3 minutos)
                const partDuration = 3;
                const numberOfParts = Math.max(1, Math.ceil(totalDuration / partDuration));
                
                // Dividir o texto em parágrafos (separados por quebras de linha duplas ou pontos finais)
                let paragraphs = script
                    .split(/\n\n+/)
                    .map(p => p.trim())
                    .filter(p => p.length > 0);
                
                // Se não houver parágrafos claros, dividir por pontos finais
                if (paragraphs.length === 1 || paragraphs.length < numberOfParts) {
                    const sentences = script.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 0);
                    // Agrupar sentenças em parágrafos de ~3-5 sentenças
                    paragraphs = [];
                    for (let i = 0; i < sentences.length; i += 4) {
                        paragraphs.push(sentences.slice(i, i + 4).join(' '));
                    }
                }
                
                // Calcular quantos parágrafos por parte (5 parágrafos por parte)
                const paragraphsPerPart = 5;
                const totalParagraphs = paragraphs.length;
                const paragraphsPerPartCalculated = Math.max(1, Math.ceil(totalParagraphs / numberOfParts));
                
                let formattedHTML = '';
                let currentParagraphIndex = 0;
                
                for (let partIndex = 0; partIndex < numberOfParts; partIndex++) {
                    const partNumber = partIndex + 1;
                    const startTime = partIndex * partDuration;
                    const endTime = Math.min(totalDuration, (partIndex + 1) * partDuration);
                    
                    formattedHTML += `
                        <div class="mb-8 pb-6 border-b border-gray-700/50 last:border-b-0">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-bold text-amber-400">PARTE ${partNumber}</h4>
                                <span class="text-sm text-gray-500">${String(Math.floor(startTime / 60)).padStart(2, '0')}:${String(startTime % 60).padStart(2, '0')} - ${String(Math.floor(endTime / 60)).padStart(2, '0')}:${String(endTime % 60).padStart(2, '0')}</span>
                            </div>
                            <div class="space-y-4">
                    `;
                    
                    // Pegar parágrafos para esta parte
                    const partParagraphs = paragraphs.slice(
                        currentParagraphIndex,
                        currentParagraphIndex + paragraphsPerPartCalculated
                    );
                    
                    partParagraphs.forEach((paragraph) => {
                        formattedHTML += `
                            <p class="text-gray-300 leading-relaxed text-base">
                                ${escapeHtml(paragraph)}
                            </p>
                        `;
                    });
                    
                    currentParagraphIndex += partParagraphs.length;
                    
                    formattedHTML += `
                            </div>
                        </div>
                    `;
                    
                    // Se já processou todos os parágrafos, parar
                    if (currentParagraphIndex >= totalParagraphs) {
                        break;
                    }
                }
                
                return formattedHTML;
            }

            function showScriptResult(script, agentName, duration = 5) {
                let resultModal = document.getElementById('script-result-modal');
                if (!resultModal) {
                    resultModal = document.createElement('div');
                    resultModal.id = 'script-result-modal';
                    resultModal.className = 'fixed inset-0 bg-black/60 z-50 flex items-center justify-center';
                    resultModal.innerHTML = `
                        <div class="bg-gray-900 border-2 border-amber-500 rounded-xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Roteiro Gerado</h3>
                                <button id="close-script-result-modal" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div id="script-result-content" class="prose prose-invert max-w-none text-gray-300"></div>
                            <div class="mt-4 flex space-x-2">
                                <button id="copy-script-result" class="flex-1 py-3 px-4 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold flex items-center justify-center space-x-2">
                                    <i data-lucide="copy"></i>
                                    <span>Copiar Roteiro</span>
                                </button>
                                <button id="download-srt-result" class="flex-1 py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-semibold flex items-center justify-center space-x-2">
                                    <i data-lucide="download"></i>
                                    <span>Baixar SRT</span>
                                </button>
                                <button id="close-script-result-btn" class="flex-1 py-3 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Fechar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(resultModal);

                    document.getElementById('close-script-result-modal').addEventListener('click', () => {
                        resultModal.style.display = 'none';
                    });
                    document.getElementById('close-script-result-btn').addEventListener('click', () => {
                        resultModal.style.display = 'none';
                    });
                    document.getElementById('copy-script-result').addEventListener('click', () => {
                        // Pegar o texto limpo (sem formatação HTML) para copiar
                        const contentDiv = document.getElementById('script-result-content');
                        let content = contentDiv.textContent || contentDiv.innerText || '';
                        
                        // Remover marcações de pausa dramática (entre chaves {} ou colchetes [])
                        // Remover marcações de PARTE X e intervalos de tempo
                        content = content
                            .replace(/\{[^}]*\}/g, '') // Remove {texto}
                            .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                            .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00"
                            .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00"
                            .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no início da linha
                            .replace(/\s+/g, ' ') // Normalizar espaços
                            .trim();
                        
                        navigator.clipboard.writeText(content).then(() => {
                            // Mostrar modal profissional de sucesso
                            showCopySuccessModal();
                        }).catch(err => {
                            console.error('Erro ao copiar:', err);
                            showCopySuccessModal();
                        });
                    });
                    
                    document.getElementById('download-srt-result').addEventListener('click', () => {
                        // Pegar o texto limpo (sem formatação HTML) para gerar SRT
                        const contentDiv = document.getElementById('script-result-content');
                        let content = contentDiv.textContent || contentDiv.innerText || '';
                        
                        // Remover marcações de pausa dramática (entre chaves {} ou colchetes [])
                        // Remover marcações de PARTE X e intervalos de tempo
                        content = content
                            .replace(/\{[^}]*\}/g, '') // Remove {texto}
                            .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                            .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00"
                            .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00"
                            .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no início da linha
                            .replace(/\s+/g, ' ') // Normalizar espaços
                            .trim();
                        
                        const savedDuration = resultModal.dataset.duration || duration || 5;
                        const srtContent = generateSRT(content, parseInt(savedDuration));
                        downloadSRT(srtContent, agentName || 'roteiro');
                    });
                }
                
                // Guardar duração para gerar SRT
                resultModal.dataset.duration = duration || 5;

                // Processar e limpar o script antes de exibir
                console.log('[Roteiro] showScriptResult chamado com:', typeof script, script?.substring?.(0, 100));
                
                let cleanScript = '';
                if (script) {
                    if (typeof script === 'string') {
                        cleanScript = script;
                    } else if (typeof script === 'object') {
                        cleanScript = JSON.stringify(script);
                    } else {
                        cleanScript = String(script);
                    }
                }
                
                // Se script estiver vazio, mostrar mensagem de erro
                if (!cleanScript || cleanScript.trim().length === 0) {
                    cleanScript = 'Erro: O roteiro não foi gerado ou está vazio. Por favor, tente novamente.';
                    console.error('[Roteiro] Script vazio recebido');
                }
                
                // Se o script contém JSON, extrair o conteúdo
                if (typeof cleanScript === 'string' && cleanScript.includes('{')) {
                    try {
                        // Tentar parsear JSON
                        const jsonMatch = cleanScript.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const jsonObj = JSON.parse(jsonMatch[0]);
                            
                            // Extrair conteúdo baseado na estrutura
                            if (jsonObj.script && Array.isArray(jsonObj.script)) {
                                cleanScript = jsonObj.script.map(item => {
                                    if (item.content) {
                                        const timeStr = item.time ? `[${item.time}] ` : '';
                                        return timeStr + item.content;
                                    }
                                    return '';
                                }).filter(Boolean).join('\n\n');
                            } else if (jsonObj.roteiro) {
                                cleanScript = jsonObj.roteiro;
                            } else if (jsonObj.content) {
                                cleanScript = jsonObj.content;
                            } else if (jsonObj.script && typeof jsonObj.script === 'string') {
                                cleanScript = jsonObj.script;
                            }
                        }
                    } catch (e) {
                        // Se falhar, tentar extração por regex
                        const roteiroMatch = cleanScript.match(/"roteiro"\s*:\s*"([^"]+)"/i);
                        if (roteiroMatch) {
                            cleanScript = roteiroMatch[1];
                        } else {
                            // Remover JSON manualmente
                            cleanScript = cleanScript
                                .replace(/\{[\s\S]*?"roteiro"[\s\S]*?\}/g, '')
                                .replace(/"roteiro"\s*:\s*"([^"]+)"/gi, '$1')
                                .replace(/"duracao"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/"estrutura"\s*:\s*"([^"]+)"/gi, '')
                                .replace(/\{[\s\S]*\}/g, '')
                                .trim();
                        }
                    }
                }
                
                // Remover TODAS as marcações para voice over (limpar completamente para narração)
                cleanScript = cleanScript
                    // Remover marcações de PARTE X com intervalos de tempo (mais agressivo)
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "PARTE 1 0:00 - 3:00"
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "Parte 1 0:00 - 3:00"
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "PARTE 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "Parte 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00" (qualquer variação)
                    .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00" (qualquer variação)
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gmi, '') // Remove linha que começa com "0:00 - 3:00"
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no início da linha (sem quebra)
                    .replace(/PARTE\s+\d+\s*$/gmi, '') // Remove "PARTE 1" sozinho no final da linha
                    .replace(/Parte\s+\d+\s*$/gmi, '') // Remove "Parte 1" sozinho no final da linha
                    // Remover marcações de cenas (Cena 1:, Cena 2:, etc.)
                    .replace(/^Cena\s+\d+:\s*/gmi, '') // Remove "Cena 1:", "Cena 2:", etc.
                    .replace(/^CENA\s+\d+:\s*/gmi, '') // Remove "CENA 1:", "CENA 2:", etc.
                    .replace(/^Scene\s+\d+:\s*/gmi, '') // Remove "Scene 1:", "Scene 2:", etc.
                    .replace(/^SCENE\s+\d+:\s*/gmi, '') // Remove "SCENE 1:", "SCENE 2:", etc.
                    .replace(/^Parte\s+\d+:\s*/gmi, '') // Remove "Parte 1:", "Parte 2:", etc.
                    .replace(/^PARTE\s+\d+:\s*/gmi, '') // Remove "PARTE 1:", "PARTE 2:", etc.
                    // Remover marcações de tempo
                    .replace(/\[?\d{1,2}:\d{2}-\d{1,2}:\d{2}\]?\s*/g, '') // Remove [0:00-0:30]
                    .replace(/\(\d{1,2}:\d{2}\)\s*/g, '') // Remove (0:30)
                    .replace(/^\d{1,2}:\d{2}\s*/gm, '') // Remove 0:30 no início da linha
                    // Remover títulos de seções
                    .replace(/^[A-Z][A-Z\s]+:\s*/gm, '') // Remove títulos em maiúsculas seguidos de dois pontos
                    // Limpar espaços e quebras excessivas
                    .replace(/\n{3,}/g, '\n\n') // Remove múltiplas quebras de linha
                    .replace(/^\s+/gm, '') // Remove espaços no início de cada linha
                    .replace(/\s+$/gm, '') // Remove espaços no final de cada linha
                    .trim();
                
                // Formatar roteiro em partes (cada parte ~3 minutos, dividida em 5 parágrafos)
                const formattedScript = formatScriptIntoParts(cleanScript, duration || 5);
                
                // Usar innerHTML para permitir formatação HTML
                const contentDiv = document.getElementById('script-result-content');
                contentDiv.innerHTML = formattedScript;
                resultModal.style.display = 'flex';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            // Funções para modais estilizados (substituir alert e confirm)
            function showStyledAlert(message, title = 'Aviso') {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.id = 'styled-alert-modal';
                    modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center';
                    modal.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all animate-scale-in">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-6 ring-4 ring-amber-500/20">
                                    <i data-lucide="alert-circle" class="w-12 h-12 text-amber-400"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3 bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-400 bg-clip-text text-transparent">
                                    ${escapeHtml(title)}
                                </h3>
                                <p class="text-gray-300 text-sm mb-6 whitespace-pre-wrap">
                                    ${escapeHtml(message)}
                                </p>
                                <button id="styled-alert-ok" class="w-full py-3 px-6 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold transition-colors flex items-center justify-center space-x-2">
                                    <span>OK</span>
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Animar entrada
                    setTimeout(() => {
                        const content = modal.querySelector('.animate-scale-in');
                        if (content) {
                            content.style.transform = 'scale(1)';
                            content.style.opacity = '1';
                        }
                    }, 10);
                    
                    // Fechar ao clicar no botão
                    document.getElementById('styled-alert-ok').addEventListener('click', () => {
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                            resolve();
                        }, 200);
                    });
                    
                    // Fechar ao clicar fora
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.opacity = '0';
                            modal.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                modal.remove();
                                resolve();
                            }, 200);
                }
                    });
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            }
            
            function showStyledConfirm(message, title = 'Confirmação') {
                return new Promise((resolve) => {
                    // Remover qualquer banner verde de sucesso que possa existir ANTES de criar o modal
                    const existingSuccessBanners = document.querySelectorAll('.bg-green-600, .bg-green-500, .bg-green-700, [class*="green"], [class*="success"], [class*="excluído"], [class*="sucesso"]');
                    existingSuccessBanners.forEach(banner => {
                        // Remover qualquer banner verde, independente de onde esteja
                        const text = banner.textContent || banner.innerText || '';
                        if (text.includes('excluído') || text.includes('sucesso') || 
                            banner.classList.contains('bg-green-600') || banner.classList.contains('bg-green-500') ||
                            banner.classList.contains('bg-green-700')) {
                            banner.remove();
                        }
                    });
                    
                    // Também limpar qualquer mensagem de sucesso que possa estar sendo exibida
                    const successMessages = document.querySelectorAll('#biblioteca-success-message, .success-message');
                    successMessages.forEach(msg => {
                        if (msg.textContent && (msg.textContent.includes('excluído') || msg.textContent.includes('sucesso'))) {
                            msg.style.display = 'none';
                            msg.textContent = '';
                        }
                    });
                    
                    const modal = document.createElement('div');
                    modal.id = 'styled-confirm-modal';
                    modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center';
                    modal.innerHTML = `
                        <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all animate-scale-in">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-amber-500/30 to-amber-600/20 rounded-full mb-6 ring-4 ring-amber-500/20">
                                    <i data-lucide="help-circle" class="w-12 h-12 text-amber-400"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-3 bg-gradient-to-r from-amber-400 via-yellow-400 to-amber-400 bg-clip-text text-transparent">
                                    ${escapeHtml(title)}
                                </h3>
                                <p class="text-gray-300 text-sm mb-6 whitespace-pre-wrap">
                                    ${escapeHtml(message)}
                                </p>
                                <div class="flex space-x-3">
                                    <button id="styled-confirm-cancel" class="flex-1 py-3 px-6 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors">
                                        Cancelar
                                    </button>
                                    <button id="styled-confirm-ok" class="flex-1 py-3 px-6 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold transition-colors">
                                        Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Garantir que nenhum banner verde seja adicionado após a criação do modal
                    let modalObserver = null;
                    modalObserver = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            mutation.addedNodes.forEach((node) => {
                                if (node.nodeType === 1) { // Element node
                                    // Buscar banners verdes dentro do node
                                    const greenBanners = node.querySelectorAll ? node.querySelectorAll('.bg-green-600, .bg-green-500, .bg-green-700, [class*="green"], [class*="success"], [class*="excluído"], [class*="sucesso"]') : [];
                                    greenBanners.forEach(banner => {
                                        if (banner.closest('#styled-confirm-modal')) {
                                            const text = banner.textContent || banner.innerText || '';
                                            if (text.includes('excluído') || text.includes('sucesso') || 
                                                banner.classList.contains('bg-green-600') || banner.classList.contains('bg-green-500') ||
                                                banner.classList.contains('bg-green-700')) {
                                                banner.remove();
                                            }
                                        }
                                    });
                                    // Verificar se o próprio node é um banner verde
                                    if (node.classList && (node.classList.contains('bg-green-600') || node.classList.contains('bg-green-500') || 
                                        node.classList.contains('bg-green-700') ||
                                        Array.from(node.classList).some(c => c.includes('green')) ||
                                        Array.from(node.classList).some(c => c.includes('success')) ||
                                        Array.from(node.classList).some(c => c.includes('excluído')) ||
                                        Array.from(node.classList).some(c => c.includes('sucesso')))) {
                                        if (node.closest('#styled-confirm-modal')) {
                                            const text = node.textContent || node.innerText || '';
                                            if (text.includes('excluído') || text.includes('sucesso') || 
                                                node.classList.contains('bg-green-600') || node.classList.contains('bg-green-500') ||
                                                node.classList.contains('bg-green-700')) {
                                                node.remove();
                                            }
                                        }
                                    }
                                }
                            });
                        });
                    });
                    modalObserver.observe(modal, { childList: true, subtree: true });
                    
                    // Remover banners verdes imediatamente após criar o modal e antes de animar
                    const removeGreenBanners = () => {
                        const greenBanners = modal.querySelectorAll('.bg-green-600, .bg-green-500, .bg-green-700, [class*="green"], [class*="success"], [class*="excluído"], [class*="sucesso"]');
                        greenBanners.forEach(banner => {
                            // Verificar se contém texto sobre exclusão bem-sucedida
                            const text = banner.textContent || banner.innerText || '';
                            if (text.includes('excluído') || text.includes('sucesso') || 
                                banner.classList.contains('bg-green-600') || banner.classList.contains('bg-green-500') ||
                                banner.classList.contains('bg-green-700')) {
                                banner.remove();
                            }
                        });
                    };
                    
                    // Remover imediatamente
                    removeGreenBanners();
                    
                    // Animar entrada
                    setTimeout(() => {
                        const content = modal.querySelector('.animate-scale-in');
                        if (content) {
                            content.style.transform = 'scale(1)';
                            content.style.opacity = '1';
                        }
                        // Remover novamente após animação
                        removeGreenBanners();
                    }, 10);
                    
                    // Remover periodicamente enquanto o modal estiver aberto
                    const bannerRemovalInterval = setInterval(() => {
                        removeGreenBanners();
                    }, 100);
                    
                    const closeModal = (result) => {
                        if (modalObserver) {
                            modalObserver.disconnect();
                            modalObserver = null;
                        }
                        if (typeof bannerRemovalInterval !== 'undefined') {
                            clearInterval(bannerRemovalInterval);
                        }
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                            resolve(result);
                        }, 200);
                    };
                    
                    // Fechar ao clicar nos botões
                    document.getElementById('styled-confirm-ok').addEventListener('click', () => closeModal(true));
                    document.getElementById('styled-confirm-cancel').addEventListener('click', () => closeModal(false));
                
                    // Fechar ao clicar fora (cancela)
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeModal(false);
                        }
                    });
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
            }
            
            // Substituir alert e confirm globais
            window.alert = showStyledAlert;
            window.confirm = showStyledConfirm;
            
            // Função para mostrar modal profissional de sucesso ao copiar
            function showCopySuccessModal() {
                // Remover modal anterior se existir
                const existingModal = document.getElementById('copy-success-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const modal = document.createElement('div');
                modal.id = 'copy-success-modal';
                modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center';
                modal.innerHTML = `
                    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 border-2 border-amber-500/50 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all animate-scale-in">
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-500/30 to-emerald-600/20 rounded-full mb-6 ring-4 ring-green-500/20">
                                <i data-lucide="check-circle" class="w-12 h-12 text-green-400"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-3 bg-gradient-to-r from-green-400 via-emerald-400 to-green-400 bg-clip-text text-transparent">
                                Roteiro Copiado!
                            </h3>
                            <p class="text-gray-300 text-sm mb-6">
                                O roteiro foi copiado para a área de transferência e está pronto para uso.
                            </p>
                            <button id="close-copy-success-modal" class="w-full py-3 px-6 rounded-lg bg-amber-600 hover:bg-amber-500 text-black font-semibold transition-colors flex items-center justify-center space-x-2">
                                <span>OK</span>
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Animar entrada
                setTimeout(() => {
                    modal.querySelector('.animate-scale-in').style.transform = 'scale(1)';
                    modal.querySelector('.animate-scale-in').style.opacity = '1';
                }, 10);
                
                // Fechar ao clicar no botão
                document.getElementById('close-copy-success-modal').addEventListener('click', () => {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        modal.remove();
                    }, 200);
                });
                
                // Fechar ao clicar fora
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                        }, 200);
                    }
                });
                
                // Fechar automaticamente após 3 segundos
                setTimeout(() => {
                    if (document.getElementById('copy-success-modal')) {
                        modal.style.opacity = '0';
                        modal.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            modal.remove();
                        }, 200);
                    }
                }, 3000);
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            function generateSRT(text, duration) {
                // Remover marcações de pausa dramática (entre chaves {} ou colchetes [])
                // Remover marcações de PARTE X e intervalos de tempo (mais agressivo)
                let cleanText = text
                    .replace(/\{[^}]*\}/g, '') // Remove {texto}
                    .replace(/\[[^\]]*\]/g, '') // Remove [texto]
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "PARTE 1 0:00 - 3:00"
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gi, '') // Remove linha inteira com "Parte 1 0:00 - 3:00"
                    .replace(/PARTE\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "PARTE 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/Parte\s+\d+.*?\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/gi, '') // Remove "Parte 1 0:00 - 3:00" (sem quebra de linha)
                    .replace(/PARTE\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "PARTE 1 0:00 - 3:00" (qualquer variação)
                    .replace(/Parte\s+\d+.*?(\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/gi, '') // Remove "Parte 1 0:00 - 3:00" (qualquer variação)
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}.*?\n/gmi, '') // Remove linha que começa com "0:00 - 3:00"
                    .replace(/^\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}\s*/gmi, '') // Remove "0:00 - 3:00" no início da linha (sem quebra)
                    .replace(/PARTE\s+\d+\s*$/gmi, '') // Remove "PARTE 1" sozinho no final da linha
                    .replace(/Parte\s+\d+\s*$/gmi, '') // Remove "Parte 1" sozinho no final da linha
                    .replace(/\[?\d{1,2}:\d{2}-\d{1,2}:\d{2}\]?\s*/g, '') // Remove marcações de tempo [0:00-0:30]
                    .replace(/\(\d{1,2}:\d{2}\)\s*/g, '') // Remove (0:30)
                    .replace(/^\d{1,2}:\d{2}\s*/gm, '') // Remove 0:30 no início da linha
                    .replace(/\s+/g, ' ') // Normalizar espaços
                    .trim();
                
                // Dividir texto em partes de até 499 caracteres, respeitando palavras e frases
                const maxChars = 499;
                const gapBetweenSubtitles = 10; // 10 segundos entre partes
                const parts = [];
                let currentPart = '';
                
                // Dividir por frases completas primeiro (pontos, exclamação, interrogação)
                const sentences = cleanText.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 0);
                
                for (const sentence of sentences) {
                    const sentenceTrimmed = sentence.trim();
                    
                    // Se a frase sozinha já ultrapassa 499 caracteres, dividir por vírgulas
                    if (sentenceTrimmed.length > maxChars) {
                        // Se já tem uma parte em construção, salvá-la
                        if (currentPart.trim()) {
                            parts.push(currentPart.trim());
                            currentPart = '';
                        }
                        
                        // Dividir a frase longa por vírgulas ou pontos e vírgulas
                        const subParts = sentenceTrimmed.split(/(?<=[,;])\s+/);
                        for (const subPart of subParts) {
                            if ((currentPart + ' ' + subPart).trim().length <= maxChars) {
                                currentPart += (currentPart ? ' ' : '') + subPart;
                            } else {
                                if (currentPart.trim()) {
                                    parts.push(currentPart.trim());
                                }
                                // Se a subparte sozinha é maior que 499, dividir por espaços (palavras)
                                if (subPart.length > maxChars) {
                                    const words = subPart.split(/\s+/);
                                    let wordPart = '';
                                    for (const word of words) {
                                        if ((wordPart + ' ' + word).trim().length <= maxChars) {
                                            wordPart += (wordPart ? ' ' : '') + word;
                    } else {
                                            if (wordPart.trim()) {
                                                parts.push(wordPart.trim());
                                            }
                                            wordPart = word;
                                        }
                                    }
                                    currentPart = wordPart;
                                } else {
                                    currentPart = subPart;
                                }
                            }
                        }
                    } else {
                        // Verificar se adicionar esta frase ultrapassa 499 caracteres
                        const testPart = currentPart ? currentPart + ' ' + sentenceTrimmed : sentenceTrimmed;
                        if (testPart.length <= maxChars) {
                            currentPart = testPart;
                        } else {
                            // Salvar parte atual e começar nova
                            if (currentPart.trim()) {
                                parts.push(currentPart.trim());
                            }
                            currentPart = sentenceTrimmed;
                        }
                    }
                }
                
                // Adicionar última parte se houver
                if (currentPart.trim()) {
                    parts.push(currentPart.trim());
                }
                
                // Calcular tempo total (duração em segundos)
                const totalSeconds = duration * 60;
                
                // Calcular tempo por parte considerando os espaços de 10 segundos
                const totalGapTime = (parts.length - 1) * gapBetweenSubtitles;
                const availableTime = Math.max(totalSeconds - totalGapTime, totalSeconds * 0.5);
                const secondsPerPart = availableTime / Math.max(parts.length, 1);
                
                // Gerar SRT
                let srtContent = '';
                let currentTime = 0;
                let subtitleIndex = 1;
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                        const startTime = formatSRTTime(currentTime);
                    const displayDuration = Math.max(secondsPerPart, 3); // Mínimo 3 segundos
                        currentTime += displayDuration;
                    const endTime = formatSRTTime(currentTime);
                        
                    srtContent += `${subtitleIndex}\n${startTime} --> ${endTime}\n${part}\n\n`;
                        subtitleIndex++;
                        
                    // Adicionar espaço de 10 segundos antes da próxima parte (exceto na última)
                    if (i < parts.length - 1) {
                            currentTime += gapBetweenSubtitles;
                    }
                }
                
                return srtContent;
            }
            
            function formatSRTTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                const milliseconds = Math.floor((seconds % 1) * 1000);
                
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')},${String(milliseconds).padStart(3, '0')}`;
            }
            
            function downloadSRT(content, filename) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename.replace(/[^a-z0-9]/gi, '_')}.srt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            let currentBibliotecaThumbPage = 1;
            let currentBibliotecaThumbLimit = 6;

            async function loadBibliotecaThumbnails(page = currentBibliotecaThumbPage, limit = currentBibliotecaThumbLimit) {
                console.log('[Biblioteca] Carregando thumbnails...');
                currentBibliotecaThumbPage = page;
                currentBibliotecaThumbLimit = limit;
                if (!userToken) {
                    console.error('[Biblioteca] Token de usuário não encontrado');
                    return;
                }
                try {
                    const search = document.getElementById('biblioteca-search')?.value || '';
                    const niche = document.getElementById('biblioteca-niche-filter')?.value || '';
                    const minViews = document.getElementById('biblioteca-views-filter')?.value || '';
                    const favoritesBtn = document.getElementById('biblioteca-favorites-only');
                    const favorites = favoritesBtn?.classList.contains('active') ? 'true' : '';

                    let url = `${API_BASE}/api/library/thumbnails?page=${page}&limit=${limit}&`;
                    if (search) url += `search=${encodeURIComponent(search)}&`;
                    if (niche) url += `niche=${encodeURIComponent(niche)}&`;
                    if (minViews) url += `minViews=${minViews}&`;
                    if (favorites) url += `favorite=${favorites}&`;

                    console.log('[Biblioteca] URL thumbnails:', url);
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    console.log('[Biblioteca] Resposta thumbnails:', response.status);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar thumbnails: ${response.status}`);
                    }
                    const result = await response.json();
                    const thumbnails = result.data || result;
                    const pagination = result.pagination || {};
                    console.log('[Biblioteca] Thumbnails recebidos:', thumbnails.length);

                    const list = document.getElementById('biblioteca-thumbnails-list');
                    if (list) {
                        if (thumbnails.length > 0) {
                            list.innerHTML = thumbnails.map(thumb => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 relative overflow-hidden">
                                    <div class="absolute top-3 left-3 z-10">
                                        <input type="checkbox" class="thumbnail-library-checkbox w-5 h-5 bg-gray-700 border-gray-600 rounded text-amber-500 focus:ring-amber-500 focus:ring-2" data-thumb-id="${thumb.id}">
                                    </div>
                                    ${thumb.thumbnail_url ? `
                                        <div class="w-full h-48 mb-3 rounded-lg overflow-hidden bg-gray-900 flex items-center justify-center">
                                            <img src="${escapeHtml(thumb.thumbnail_url)}" alt="Thumbnail" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<p class=\\'text-gray-500 text-xs\\'>Erro ao carregar imagem</p>'">
                                        </div>
                                    ` : ''}
                                    ${!thumb.thumbnail_url && thumb.thumbnail_description ? `
                                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-3 mb-3 min-h-[120px] flex items-center justify-center">
                                            <p class="text-gray-400 text-xs text-center line-clamp-4" title="${escapeHtml(thumb.thumbnail_description)}">${escapeHtml(thumb.thumbnail_description.substring(0, 200))}${thumb.thumbnail_description.length > 200 ? '...' : ''}</p>
                                        </div>
                                    ` : ''}
                                    <div class="flex items-start justify-between gap-2">
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-white font-semibold text-sm mb-1 truncate" title="${escapeHtml(thumb.niche || 'N/A')} • ${escapeHtml(thumb.subniche || 'N/A')}">${escapeHtml(thumb.niche || 'N/A')} • ${escapeHtml(thumb.subniche || 'N/A')}</h3>
                                            <p class="text-gray-400 text-xs mb-1">${formatNumber(parseInt(thumb.original_views || 0))} views${thumb.original_ctr ? ` • CTR: ${(parseFloat(thumb.original_ctr || 0)).toFixed(1)}%` : ''}</p>
                                            ${thumb.style ? `<p class="text-gray-500 text-xs mb-1 truncate">Estilo: ${escapeHtml(thumb.style)}</p>` : ''}
                                            ${thumb.viral_score ? `<p class="text-amber-400 text-xs mb-1">Score Viral: ${thumb.viral_score}/10</p>` : ''}
                                        </div>
                                        <div class="flex items-center gap-1 flex-shrink-0">
                                            <button onclick="toggleThumbnailFavorite(${thumb.id}, ${thumb.is_favorite || 0})" class="p-2 ${thumb.is_favorite ? 'text-red-600 fill-red-600' : 'text-gray-400'} hover:text-red-500 transition-colors" title="${thumb.is_favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                                                <i data-lucide="heart" class="w-4 h-4 ${thumb.is_favorite ? 'fill-current' : ''}"></i>
                                            </button>
                                            <button onclick="deleteThumbnailFromLibrary(${thumb.id})" class="p-2 text-red-600 hover:text-red-500 transition-colors" title="Excluir thumbnail">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${thumb.thumbnail_description ? `
                                        <div class="mt-3 pt-3 border-t border-gray-700">
                                            <p class="text-gray-500 text-xs mb-2 line-clamp-3" title="${escapeHtml(thumb.thumbnail_description)}">${escapeHtml(thumb.thumbnail_description)}</p>
                                            <div class="flex items-center gap-2">
                                                ${thumb.thumbnail_url ? `
                                                    <button class="btn-download-thumbnail flex-1 py-1.5 px-3 bg-amber-600 hover:bg-amber-500 text-black rounded-lg font-bold text-xs flex items-center justify-center gap-1" data-url="${escapeHtml(thumb.thumbnail_url)}" data-title="${escapeHtml((thumb.thumbnail_description || '').substring(0, 30))}" title="Baixar imagem">
                                                        <i data-lucide="download" class="w-3 h-3"></i>
                                                        <span>Baixar</span>
                                                    </button>
                                                ` : ''}
                                                <button class="btn-copy-thumbnail-prompt flex-1 py-1.5 px-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1" data-prompt="${escapeHtml(thumb.thumbnail_description)}" title="Copiar prompt">
                                                    <i data-lucide="copy" class="w-3 h-3"></i>
                                                    <span>Copiar Prompt</span>
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('');
                            if (typeof lucide !== 'undefined') lucide.createIcons();

                            // Atualizar paginação
                            updateBibliotecaThumbnailsPagination(pagination);

                            // listeners seleção
                            document.querySelectorAll('.thumbnail-library-checkbox').forEach(cb => {
                                cb.addEventListener('change', updateBibliotecaThumbnailsSelection);
                            });
                        } else {
                            list.innerHTML = '<p class="text-gray-400">Nenhuma thumbnail encontrada. As thumbnails serão salvas automaticamente quando você gerar ideias de thumbnail no Analisador de Títulos Virais.</p>';
                            updateBibliotecaThumbnailsPagination(null);
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar thumbnails:', err);
                    const list = document.getElementById('biblioteca-thumbnails-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar thumbnails: ${err.message}</p>`;
                    }
                }
            }

            function updateBibliotecaThumbnailsSelection() {
                const checked = document.querySelectorAll('.thumbnail-library-checkbox:checked');
                const count = checked.length;
                const countEl = document.getElementById('selected-thumbnails-count-number');
                const container = document.getElementById('selected-thumbnails-count');
                const deleteBtn = document.getElementById('delete-selected-thumbnails');
                if (countEl) countEl.textContent = count;
                if (container) container.classList.toggle('hidden', count === 0);
                if (deleteBtn) deleteBtn.classList.toggle('hidden', count === 0);
            }

            function updateBibliotecaThumbnailsPagination(pagination) {
                const paginationContainer = document.getElementById('biblioteca-thumbnails-pagination');
                const paginationInfo = document.getElementById('biblioteca-thumbnails-pagination-info');
                const paginationControls = document.getElementById('biblioteca-thumbnails-pagination-controls');
                const limitSelect = document.getElementById('biblioteca-thumbnails-limit');

                if (!pagination || !pagination.total || pagination.totalPages <= 1) {
                    if (paginationContainer) paginationContainer.style.display = 'none';
                    return;
                }
                if (paginationContainer) paginationContainer.style.display = 'flex';
                if (limitSelect) limitSelect.value = pagination.limit || currentBibliotecaThumbLimit;

                if (paginationInfo) {
                    const start = ((pagination.page - 1) * pagination.limit) + 1;
                    const end = Math.min(pagination.page * pagination.limit, pagination.total);
                    paginationInfo.innerHTML = `<span class="text-gray-300">Mostrando <span class="text-amber-500 font-bold">${start}-${end}</span> de <span class="text-amber-500 font-bold">${pagination.total}</span> thumbnails</span>`;
                }
                if (paginationControls) {
                    paginationControls.innerHTML = '';
                    if (pagination.hasPrev) {
                        const prevBtn = document.createElement('button');
                        prevBtn.className = 'px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 text-sm font-medium transition-all flex items-center space-x-1';
                        prevBtn.innerHTML = '<i data-lucide="chevron-left" class="w-4 h-4"></i><span class="hidden sm:inline">Anterior</span>';
                        prevBtn.onclick = () => loadBibliotecaThumbnails(pagination.page - 1, currentBibliotecaThumbLimit);
                        paginationControls.appendChild(prevBtn);
                    }

                    const maxPages = 5;
                    let startPage = Math.max(1, pagination.page - Math.floor(maxPages / 2));
                    let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);
                    if (endPage - startPage < maxPages - 1) startPage = Math.max(1, endPage - maxPages + 1);
                    for (let i = startPage; i <= endPage; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = `px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${i === pagination.page ? 'bg-gradient-to-r from-amber-600 to-amber-500 text-black font-bold shadow-lg shadow-amber-500/30' : 'bg-gray-800/50 border border-gray-700 text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400'}`;
                        pageBtn.textContent = i;
                        pageBtn.onclick = () => loadBibliotecaThumbnails(i, currentBibliotecaThumbLimit);
                        paginationControls.appendChild(pageBtn);
                    }

                    if (pagination.hasNext) {
                        const nextBtn = document.createElement('button');
                        nextBtn.className = 'px-3 py-1.5 bg-gray-800/50 border border-gray-700 rounded-lg text-gray-300 hover:bg-amber-500/20 hover:border-amber-500/50 hover:text-amber-400 text-sm font-medium transition-all flex items-center space-x-1';
                        nextBtn.innerHTML = '<span class="hidden sm:inline">Próximo</span><i data-lucide="chevron-right" class="w-4 h-4"></i>';
                        nextBtn.onclick = () => loadBibliotecaThumbnails(pagination.page + 1, currentBibliotecaThumbLimit);
                        paginationControls.appendChild(nextBtn);
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }

            window.toggleTitleFavorite = async function(id, currentState) {
                try {
                    const response = await fetch(`${API_BASE}/api/library/titles/${id}/favorite`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isFavorite: !currentState })
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar favorito.');
                    await loadBibliotecaTitles(currentBibliotecaPage, currentBibliotecaLimit);
                    showToast('Favorito atualizado com sucesso!', 'success');
                } catch (err) {
                    console.error('Erro ao atualizar favorito:', err);
                    showToast('Erro ao atualizar favorito.', 'error');
                }
            };

            window.toggleThumbnailFavorite = async function(id, currentState) {
                try {
                    const response = await fetch(`${API_BASE}/api/library/thumbnails/${id}/favorite`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isFavorite: !currentState })
                    });
                    if (!response.ok) throw new Error('Falha ao atualizar favorito.');
                    await loadBibliotecaThumbnails();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('Erro ao atualizar favorito:', err);
                    showMessage('biblioteca-error-message', 'Erro ao atualizar favorito.', true);
                }
            };

            // Função para copiar título para clipboard
            window.copyTitleToClipboard = async function(titleText) {
                try {
                    await navigator.clipboard.writeText(titleText);
                    showToast('Título copiado para a área de transferência!', 'success');
                } catch (err) {
                    console.error('Erro ao copiar título:', err);
                    // Fallback: usar método antigo
                    const textarea = document.createElement('textarea');
                    textarea.value = titleText;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Título copiado para a área de transferência!', 'success');
                    } catch (fallbackErr) {
                        showToast('Erro ao copiar título. Tente selecionar e copiar manualmente.', 'error');
                    }
                    document.body.removeChild(textarea);
                }
            };

            window.deleteTitleFromLibrary = async function(id) {
                const confirmed = await showCustomConfirm('Tem certeza que deseja excluir este título da biblioteca? Esta ação não pode ser desfeita.', 'Confirmar Exclusão');
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/library/titles/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || 'Falha ao excluir título.');
                    }
                    await loadBibliotecaTitles(currentBibliotecaPage, currentBibliotecaLimit);
                    showMessage('biblioteca-success-message', 'Título excluído da biblioteca com sucesso!');
                } catch (err) {
                    console.error('Erro ao excluir título:', err);
                    showToast(err.message || 'Erro ao excluir título.', 'error');
                }
            };
            
            // Excluir títulos selecionados em lote (tornar global)
            window.deleteSelectedTitles = async function() {
                const checkboxes = document.querySelectorAll('.title-library-checkbox:checked');
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.titleId));
                
                if (selectedIds.length === 0) {
                    showToast('Nenhum título selecionado.', 'error');
                    return;
                }
                
                const confirmed = await showCustomConfirm(`Tem certeza que deseja excluir ${selectedIds.length} título(s) da biblioteca? Esta ação não pode ser desfeita.`, 'Confirmar Exclusão');
                if (!confirmed) return;
                
                try {
                    const resp = await fetch(`${API_BASE}/api/library/titles/bulk-delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ ids: selectedIds })
                    });
                    if (!resp.ok) {
                        const errData = await resp.json().catch(() => ({}));
                        throw new Error(errData.msg || 'Erro ao excluir títulos selecionados.');
                    }
                    const data = await resp.json().catch(() => ({}));
                    await loadBibliotecaTitles(currentBibliotecaPage, currentBibliotecaLimit);
                    const selectAll = document.getElementById('select-all-titles');
                    if (selectAll) selectAll.checked = false;
                    updateBibliotecaSelection();
                    showMessage('biblioteca-success-message', data.msg || `${selectedIds.length} título(s) excluído(s) com sucesso!`);
                } catch (err) {
                    console.error('Erro ao excluir títulos:', err);
                    showToast('Erro ao excluir títulos selecionados.', 'error');
                }
            };

            window.deleteThumbnailFromLibrary = async function(id) {
                const confirmed = await showCustomConfirm('Tem certeza que deseja excluir esta thumbnail da biblioteca? Esta ação não pode ser desfeita.', 'Confirmar Exclusão');
                if (!confirmed) return;
                try {
                    const response = await fetch(`${API_BASE}/api/library/thumbnails/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || 'Falha ao excluir thumbnail.');
                    }
                    await loadBibliotecaThumbnails(currentBibliotecaThumbPage, currentBibliotecaThumbLimit);
                    showMessage('biblioteca-success-message', 'Thumbnail excluída da biblioteca com sucesso!');
                } catch (err) {
                    showMessage('biblioteca-error-message', err.message, true);
                }
            };

            // Excluir thumbnails selecionadas em lote
            window.deleteSelectedThumbnails = async function() {
                const checkboxes = document.querySelectorAll('.thumbnail-library-checkbox:checked');
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.thumbId));
                if (!selectedIds.length) return;

                const confirmed = await showCustomConfirm(
                    `Tem certeza que deseja excluir ${selectedIds.length} thumbnail(s) da biblioteca? Esta ação não pode ser desfeita.`,
                    'Confirmar Exclusão'
                );
                if (!confirmed) return;

                try {
                    const resp = await fetch(`${API_BASE}/api/library/thumbnails/bulk-delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ ids: selectedIds })
                    });
                    if (!resp.ok) {
                        const errData = await resp.json().catch(() => ({}));
                        throw new Error(errData.msg || 'Falha ao excluir thumbnails.');
                    }
                    const data = await resp.json().catch(() => ({}));
                    await loadBibliotecaThumbnails(currentBibliotecaThumbPage, currentBibliotecaThumbLimit);
                    // Reset seleção
                    const selectAll = document.getElementById('select-all-thumbnails');
                    if (selectAll) selectAll.checked = false;
                    updateBibliotecaThumbnailsSelection();
                    showMessage('biblioteca-success-message', data.msg || `${selectedIds.length} thumbnail(s) excluída(s) com sucesso!`);
                } catch (err) {
                    showMessage('biblioteca-error-message', err.message || 'Erro ao excluir thumbnails.', true);
                }
            };

            // Event delegation para botões de download e copiar prompt
            document.addEventListener('click', async (e) => {
                // Download de thumbnail
                if (e.target.closest('.btn-download-thumbnail')) {
                    const btn = e.target.closest('.btn-download-thumbnail');
                    const imageUrl = btn.getAttribute('data-url');
                    const title = btn.getAttribute('data-title') || 'thumbnail';
                    
                    try {
                        // Tentar download direto primeiro
                        const link = document.createElement('a');
                        link.href = imageUrl;
                        link.download = `${title.replace(/[^a-z0-9]/gi, '_')}.jpg`;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Mensagem de sucesso
                        setTimeout(() => {
                            showMessage('biblioteca-success-message', 'Download iniciado! Se não funcionar devido a CORS, a imagem será aberta em nova aba.');
                        }, 100);
                    } catch (err) {
                        console.error('Erro ao baixar imagem:', err);
                        // Fallback: abrir em nova aba
                        window.open(imageUrl, '_blank');
                        showMessage('biblioteca-success-message', 'Imagem aberta em nova aba. Use "Salvar imagem como..." do navegador.');
                    }
                }
                
                // Copiar prompt
                if (e.target.closest('.btn-copy-thumbnail-prompt')) {
                    const btn = e.target.closest('.btn-copy-thumbnail-prompt');
                    const prompt = btn.getAttribute('data-prompt');
                    
                    if (!prompt) {
                        showMessage('biblioteca-error-message', 'Prompt não encontrado.', true);
                        return;
                    }
                    
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(prompt);
                            showMessage('biblioteca-success-message', 'Prompt copiado para a área de transferência!');
                        } else {
                            // Fallback para navegadores mais antigos
                            const textarea = document.createElement('textarea');
                            textarea.value = prompt;
                            textarea.style.position = 'fixed';
                            textarea.style.opacity = '0';
                            textarea.style.left = '-9999px';
                            document.body.appendChild(textarea);
                            textarea.select();
                            textarea.setSelectionRange(0, 99999); // Para mobile
                            const success = document.execCommand('copy');
                            document.body.removeChild(textarea);
                            if (success) {
                                showMessage('biblioteca-success-message', 'Prompt copiado para a área de transferência!');
                            } else {
                                throw new Error('Falha ao copiar');
                            }
                        }
                    } catch (err) {
                        console.error('Erro ao copiar prompt:', err);
                        showMessage('biblioteca-error-message', 'Erro ao copiar prompt. Tente selecionar e copiar manualmente.', true);
                    }
                }
            });

            const bibliotecaSearch = document.getElementById('biblioteca-search');
            const bibliotecaNicheFilter = document.getElementById('biblioteca-niche-filter');
            const bibliotecaViewsFilter = document.getElementById('biblioteca-views-filter');
            const bibliotecaFavoritesOnly = document.getElementById('biblioteca-favorites-only');
            const selectAllTitles = document.getElementById('select-all-titles');
            const deleteSelectedTitlesBtn = document.getElementById('delete-selected-titles');
            const bibliotecaTitlesLimit = document.getElementById('biblioteca-titles-limit');
            const selectAllThumbnails = document.getElementById('select-all-thumbnails');
            const deleteSelectedThumbnailsBtn = document.getElementById('delete-selected-thumbnails');
            const bibliotecaThumbnailsLimit = document.getElementById('biblioteca-thumbnails-limit');

            // Event listeners para seleção em lote
            if (selectAllTitles) {
                selectAllTitles.addEventListener('change', (e) => {
                    const checkboxes = document.querySelectorAll('.title-library-checkbox');
                    checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
                    updateBibliotecaSelection();
                });
            }

            if (deleteSelectedTitlesBtn) {
                deleteSelectedTitlesBtn.addEventListener('click', () => {
                    deleteSelectedTitles();
                });
            }

            // Event listener para limite de paginação
            if (bibliotecaTitlesLimit) {
                bibliotecaTitlesLimit.addEventListener('change', (e) => {
                    const newLimit = parseInt(e.target.value);
                    currentBibliotecaLimit = newLimit;
                    loadBibliotecaTitles(1, newLimit);
                });
            }

            // Seleção em lote - thumbnails
            if (selectAllThumbnails) {
                selectAllThumbnails.addEventListener('change', (e) => {
                    const cbs = document.querySelectorAll('.thumbnail-library-checkbox');
                    cbs.forEach(cb => cb.checked = e.target.checked);
                    updateBibliotecaThumbnailsSelection();
                });
            }
            if (deleteSelectedThumbnailsBtn) {
                deleteSelectedThumbnailsBtn.addEventListener('click', () => deleteSelectedThumbnails());
            }
            if (bibliotecaThumbnailsLimit) {
                bibliotecaThumbnailsLimit.addEventListener('change', (e) => {
                    const newLimit = parseInt(e.target.value);
                    currentBibliotecaThumbLimit = newLimit;
                    loadBibliotecaThumbnails(1, newLimit);
                });
            }

            if (bibliotecaSearch) {
                bibliotecaSearch.addEventListener('input', () => {
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles(1, currentBibliotecaLimit);
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails(1, currentBibliotecaThumbLimit);
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            if (bibliotecaNicheFilter) {
                bibliotecaNicheFilter.addEventListener('change', () => {
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles(1, currentBibliotecaLimit);
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails(1, currentBibliotecaThumbLimit);
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            if (bibliotecaViewsFilter) {
                bibliotecaViewsFilter.addEventListener('change', () => {
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles(1, currentBibliotecaLimit);
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails(1, currentBibliotecaThumbLimit);
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            if (bibliotecaFavoritesOnly) {
                bibliotecaFavoritesOnly.addEventListener('click', function() {
                    this.classList.toggle('active');
                    this.classList.toggle('bg-amber-600');
                    this.classList.toggle('text-white');
                    if (currentBibliotecaTab === 'titles') loadBibliotecaTitles(1, currentBibliotecaLimit);
                    else if (currentBibliotecaTab === 'thumbnails') loadBibliotecaThumbnails(1, currentBibliotecaThumbLimit);
                    else if (currentBibliotecaTab === 'agents') loadBibliotecaAgents();
                });
            }

            // === FUNCIONALIDADES DE INTEGRAÇÃO YOUTUBE ===
            // Variável para controlar atualização automática de canais
            let youtubeChannelsRefreshInterval = null;
            let lastQuickOverviewChannelKey = null; // `${id}:${updated_at?}` fallback: `${id}`
            let lastQuickOverviewLoadedAt = 0;

            // Permite que o popup do OAuth avise a janela principal para atualizar canais/seletores automaticamente
            window.addEventListener('message', (event) => {
                try {
                    if (event?.data?.type === 'youtubeChannelsConnected') {
                        loadYouTubeIntegrationStatus();
                        updateChannelSelects();
                        // Também atualizar a lista de canais do "Analytics e Performance" (usa /api/channels)
                        if (typeof loadChannels === 'function') loadChannels();
                        if (typeof loadAnalytics === 'function') loadAnalytics();
                    }
                } catch (e) {
                    // noop
                }
            });

            async function loadYouTubeIntegrationStatus() {
                try {
                    // Obter token dentro da função para garantir que está disponível
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        console.warn('[YouTube Integration] Token não encontrado');
                        const channelsList = document.getElementById('youtube-channels-list');
                        if (channelsList) {
                            channelsList.innerHTML = '<p class="text-red-400">Erro: Token de autenticação não encontrado. Faça login novamente.</p>';
                        }
                        return;
                    }
                    
                    if (typeof API_BASE === 'undefined') {
                        console.error('[YouTube Integration] API_BASE não está definido');
                        const channelsList = document.getElementById('youtube-channels-list');
                        if (channelsList) {
                            channelsList.innerHTML = '<p class="text-red-400">Erro: API_BASE não está definido. Recarregue a página.</p>';
                        }
                        return;
                    }
                    
                    // Buscar lista de canais
                    const response = await fetch(`${API_BASE}/api/youtube/channels`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Falha ao carregar canais');
                    }
                    
                    const data = await response.json();
                    const channelsList = document.getElementById('youtube-channels-list');
                    const btnConnect = document.getElementById('btn-connect-youtube');
                    
                    if (channelsList) {
                        if (data.channels && data.channels.length > 0) {
                            channelsList.innerHTML = data.channels.map(channel => `
                                <div class="bg-gray-800 border ${channel.isExpired ? 'border-yellow-700' : 'border-green-700'} rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3 flex-1">
                                            <i data-lucide="${channel.isExpired ? 'alert-circle' : 'check-circle'}" class="w-5 h-5 ${channel.isExpired ? 'text-yellow-500' : 'text-green-500'}"></i>
                                            <div class="flex-1">
                                                <p class="text-white font-semibold">${escapeHtml(channel.channelName || 'Canal do YouTube')}</p>
                                                <p class="text-gray-400 text-xs">ID: ${escapeHtml(channel.channelId || 'N/A')}</p>
                                                ${channel.niche || channel.subniche || channel.language || channel.country ? `
                                                    <div class="mt-2 flex flex-wrap gap-2">
                                                        ${channel.niche ? `<span class="px-2 py-1 bg-amber-600/20 text-amber-400 rounded text-xs border border-amber-600/30">📌 ${escapeHtml(channel.niche)}</span>` : ''}
                                                        ${channel.subniche ? `<span class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-xs border border-blue-600/30">🎯 ${escapeHtml(channel.subniche)}</span>` : ''}
                                                        ${channel.language || channel.country ? `<span class="px-2 py-1 bg-emerald-600/20 text-emerald-300 rounded text-xs border border-emerald-600/30">🌍 ${escapeHtml(channel.language || '—')}${channel.country ? ' • ' + escapeHtml(channel.country) : ''}</span>` : ''}
                                                    </div>
                                                ` : '<p class="text-gray-500 text-xs mt-1">⏳ Analisando nicho/idioma...</p>'}
                                                ${channel.isExpired ? '<p class="text-yellow-400 text-xs mt-1">⚠️ Token expirado</p>' : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="reanalyzeChannelNiche(${channel.id}, '${escapeHtml(channel.channelName)}')" class="py-2 px-3 rounded-lg bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold transition duration-300" title="Re-analisar nicho">
                                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="disconnectChannel(${channel.id})" class="py-2 px-3 rounded-lg bg-red-600 hover:bg-red-500 text-white text-sm font-semibold transition duration-300">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                            
                            // Mostrar contador
                            const statusDiv = document.getElementById('youtube-integration-status');
                            if (statusDiv) {
                                statusDiv.innerHTML = `<p class="text-gray-400 text-sm">${data.count} de ${data.maxChannels} canais conectados</p>`;
                            }
                            
                            // Desabilitar botão se atingiu o limite
                            if (btnConnect && data.count >= data.maxChannels) {
                                btnConnect.disabled = true;
                                btnConnect.innerHTML = '<i data-lucide="x"></i><span>Limite atingido (10 canais)</span>';
                            } else if (btnConnect) {
                                btnConnect.disabled = false;
                                btnConnect.innerHTML = '<i data-lucide="plus"></i><span>Adicionar Canal</span>';
                            }

                            // Resumo rápido (primeiro canal) — evitar “piscar” a cada refresh
                            if (data.channels && data.channels.length > 0) {
                                const ch = data.channels[0];
                                const key = `${ch.id}`;
                                const now = Date.now();
                                const shouldRefresh =
                                    !lastQuickOverviewChannelKey ||
                                    lastQuickOverviewChannelKey !== key ||
                                    (now - lastQuickOverviewLoadedAt) > 60000; // 60s
                                if (shouldRefresh) {
                                    lastQuickOverviewChannelKey = key;
                                    lastQuickOverviewLoadedAt = now;
                                    loadYouTubeQuickOverview(ch, { forceLoading: !document.getElementById('youtube-quick-overview')?.dataset?.hasData });
                                }
                            }
                        } else {
                            channelsList.innerHTML = '<p class="text-gray-400">Nenhum canal conectado. Clique em "Adicionar Canal" para começar.</p>';
                            const statusDiv = document.getElementById('youtube-integration-status');
                            if (statusDiv) {
                                statusDiv.innerHTML = '';
                            }
                            const overview = document.getElementById('youtube-quick-overview');
                            if (overview) overview.innerHTML = '<p>Nenhum canal conectado ainda.</p>';
                        }
                    }
                    
                    // Atualizar ícones do Lucide
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('[YouTube Integration] Erro ao carregar canais:', err);
                    const channelsList = document.getElementById('youtube-channels-list');
                    if (channelsList) {
                        channelsList.innerHTML = `<p class="text-red-400">Erro ao carregar canais: ${err.message}</p>`;
                    }
                    // Parar atualização automática em caso de erro
                    if (youtubeChannelsRefreshInterval) {
                        clearInterval(youtubeChannelsRefreshInterval);
                        youtubeChannelsRefreshInterval = null;
                    }
                }
            }

            async function loadYouTubeQuickOverview(channel, opts = {}) {
                const box = document.getElementById('youtube-quick-overview');
                if (!box) return;
                if (!channel || !channel.id) {
                    box.innerHTML = '<p class="text-gray-400">Conecte um canal para ver o resumo.</p>';
                    return;
                }
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        box.innerHTML = '<p class="text-red-400">Token não encontrado. Faça login novamente.</p>';
                        return;
                    }
                    const endDate = new Date();
                    const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    if (opts.forceLoading) {
                        box.innerHTML = '<p class="text-gray-400">Carregando resumo do canal...</p>';
                    }

                    const resp = await fetch(`${API_BASE}/api/youtube/channels/${channel.id}/analytics?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        throw new Error(err.msg || 'Falha ao carregar resumo');
                    }
                    const data = await resp.json();

                    let views = 0;
                    let watch = 0;
                    let subsGained = 0;
                    if (data.analytics?.rows?.length && data.analytics?.columnHeaders?.length) {
                        const row = data.analytics.rows[0];
                        const headers = data.analytics.columnHeaders.map(h => h.name);
                        const idxViews = headers.findIndex(h => h === 'views');
                        const idxWatch = headers.findIndex(h => h === 'estimatedMinutesWatched');
                        const idxSubs = headers.findIndex(h => h === 'subscribersGained');
                        views = idxViews >= 0 ? parseInt(row[idxViews] || 0) : 0;
                        watch = idxWatch >= 0 ? parseInt(row[idxWatch] || 0) : 0;
                        subsGained = idxSubs >= 0 ? parseInt(row[idxSubs] || 0) : 0;
                    }

                    const adv = data.advanced || {};
                    const ctrNum = (adv.impressionsCtr !== null && adv.impressionsCtr !== undefined && !isNaN(parseFloat(adv.impressionsCtr)))
                        ? parseFloat(adv.impressionsCtr)
                        : null;
                    const retNum = (adv.averageViewPercentage !== null && adv.averageViewPercentage !== undefined && !isNaN(parseFloat(adv.averageViewPercentage)))
                        ? parseFloat(adv.averageViewPercentage)
                        : null;
                    const ctrTxt = ctrNum !== null ? `${ctrNum.toFixed(2)}%` : 'N/A';
                    const retTxt = retNum !== null ? `${retNum.toFixed(1)}%` : 'N/A';

                    const estRevenue = parseFloat(data.estimatedRevenue || data.estimatedAdRevenue || 0);
                    const revTxt = estRevenue > 0 ? `$${estRevenue.toFixed(2)}` : 'N/A';

                    box.innerHTML = `
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                            <div class="flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <p class="text-white font-semibold truncate">${escapeHtml(channel.channelName || 'Canal')}</p>
                                    <p class="text-gray-400 text-xs">${channel.niche ? `📌 ${escapeHtml(channel.niche)}` : 'Sem nicho'}${channel.language ? ` • 🌍 ${escapeHtml(channel.language)}` : ''}</p>
                                </div>
                                <button class="px-3 py-2 bg-amber-600 hover:bg-amber-500 text-white text-xs font-semibold rounded-lg" onclick="
                                    switchYouTubeTab('analytics');
                                    updateChannelSelects().then(() => {
                                        const sel = document.getElementById('analytics-channel-select');
                                        if (sel) sel.value = '${channel.id}';
                                        if (typeof loadChannelAnalytics === 'function') loadChannelAnalytics();
                                    });
                                ">Ver métricas</button>
                            </div>
                            <div class="mt-3 grid grid-cols-2 md:grid-cols-6 gap-2 text-xs">
                                <div><span class="text-gray-400">Views (30d)</span><div class="text-white font-bold">${formatNumber(views)}</div></div>
                                <div><span class="text-gray-400">Watch</span><div class="text-white font-bold">${formatMinutes(watch)}</div></div>
                                <div><span class="text-gray-400">Inscritos +</span><div class="text-white font-bold">+${formatNumber(subsGained)}</div></div>
                                <div><span class="text-gray-400">CTR</span><div class="text-white font-bold">${ctrTxt}</div></div>
                                <div><span class="text-gray-400">Retenção</span><div class="text-white font-bold">${retTxt}</div></div>
                                <div><span class="text-gray-400">Receita (30d)</span><div class="text-white font-bold">${revTxt}</div></div>
                            </div>
                        </div>
                    `;
                    box.dataset.hasData = '1';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    box.innerHTML = `<p class="text-red-400">Erro ao carregar resumo: ${escapeHtml(err.message)}</p>`;
                }
            }
            
            // Função para preencher automaticamente campos de nicho/subniche quando um canal é selecionado
            function autoFillNicheFromChannel(channelId) {
                if (!channelId) return;
                
                // Buscar informações do canal
                fetch(`${API_BASE}/api/youtube/channels`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('core_token')}` }
                })
                .then(res => res.json())
                .then(data => {
                    const channel = data.channels?.find(c => c.id == channelId || c.channelId === channelId);
                    if (channel && (channel.niche || channel.subniche)) {
                        // Preencher todos os campos de nicho/subniche encontrados na página
                        const nicheInputs = document.querySelectorAll('input[id*="niche"], input[id*="Niche"]');
                        const subnicheInputs = document.querySelectorAll('input[id*="subniche"], input[id*="Subniche"]');
                        
                        nicheInputs.forEach(input => {
                            if (!input.value || input.value.trim() === '') {
                                input.value = channel.niche || '';
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        });
                        
                        subnicheInputs.forEach(input => {
                            if (!input.value || input.value.trim() === '') {
                                input.value = channel.subniche || '';
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        });
                        
                        console.log(`[Auto-fill] Nicho preenchido automaticamente: ${channel.niche} / ${channel.subniche}`);
                    }
                })
                .catch(err => {
                    console.warn('[Auto-fill] Erro ao buscar informações do canal:', err);
                });
            }

            // Função para carregar métricas do canal
            window.loadChannelAnalytics = async function() {
                const channelSelect = document.getElementById('analytics-channel-select');
                const periodSelect = document.getElementById('analytics-period-select');
                const loadingDiv = document.getElementById('analytics-loading');
                const contentDiv = document.getElementById('analytics-content');
                
                if (!channelSelect || !channelSelect.value) {
                    showMessage('youtube-integration-error-message', 'Selecione um canal primeiro.', true);
                    return;
                }
                
                const channelId = channelSelect.value;
                const days = parseInt(periodSelect?.value || 30);
                const endDate = new Date();
                const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
                
                try {
                    loadingDiv.classList.remove('hidden');
                    contentDiv.classList.add('hidden');
                    
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/channels/${channelId}/analytics?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar métricas');
                    }
                    
                    const data = await response.json();
                    
                    // Preencher resumo
                    if (data.analytics && data.analytics.rows && data.analytics.rows.length > 0) {
                        const row0 = data.analytics.rows[0];
                        const headers0 = data.analytics.columnHeaders?.map(h => h.name) || [];
                        const idxViews = headers0.findIndex(h => h === 'views');
                        const idxWatch = headers0.findIndex(h => h === 'estimatedMinutesWatched');
                        const totalViews = idxViews >= 0 ? parseInt(row0[idxViews] || 0) : 0;
                        const watchTime = idxWatch >= 0 ? parseInt(row0[idxWatch] || 0) : 0;
                        const summaryText = `Seu canal teve ${formatNumber(totalViews)} visualizações e ${formatMinutes(watchTime)} de tempo de visualização no período selecionado.`;
                        const headlineEl = document.getElementById('yt-analytics-headline');
                        const subheadlineEl = document.getElementById('yt-analytics-subheadline');
                        const hiddenSummaryEl = document.getElementById('analytics-summary-text');
                        if (headlineEl) headlineEl.textContent = `Seu canal teve ${formatNumber(totalViews)} visualizações nos últimos ${days} dias`;
                        if (subheadlineEl) subheadlineEl.textContent = `Tempo de exibição: ${formatMinutes(watchTime)} • Período: ${startDate.toLocaleDateString('pt-BR')} – ${endDate.toLocaleDateString('pt-BR')}`;
                        if (hiddenSummaryEl) hiddenSummaryEl.textContent = summaryText;
                    }
                    
                    // Preencher métricas principais
                    if (data.channelStats) {
                        const subscribers = parseInt(data.channelStats.subscriberCount || 0);
                        document.getElementById('analytics-subscribers').textContent = formatNumber(subscribers);
                        document.getElementById('analytics-subscribers-change').textContent = 'Total de inscritos';
                    }
                    
                    if (data.analytics && data.analytics.rows && data.analytics.rows.length > 0) {
                        const row = data.analytics.rows[0];
                        const headers = data.analytics.columnHeaders?.map(h => h.name) || [];
                        
                        // Extrair valores por nome da coluna
                        const getValue = (name) => {
                            const index = headers.findIndex(h => h === name);
                            return index >= 0 ? (row[index] || 0) : 0;
                        };
                        
                        const views = parseInt(getValue('views'));
                        const watchTime = parseInt(getValue('estimatedMinutesWatched'));
                        const subscribersGained = parseInt(getValue('subscribersGained'));
                        const likes = parseInt(getValue('likes'));
                        const comments = parseInt(getValue('comments'));
                        const shares = parseInt(getValue('shares'));
                        const estimatedRevenue = parseFloat(data.estimatedRevenue || data.estimatedAdRevenue || 0);
                        const adImpressions = parseInt(data.adImpressions || 0);
                        
                        document.getElementById('analytics-total-views').textContent = formatNumber(views);
                        document.getElementById('analytics-watch-time').textContent = formatMinutes(watchTime);
                        document.getElementById('analytics-subscribers-gained').textContent = '+' + formatNumber(subscribersGained);
                        document.getElementById('analytics-likes').textContent = formatNumber(likes);
                        document.getElementById('analytics-comments').textContent = formatNumber(comments);
                        document.getElementById('analytics-shares').textContent = formatNumber(shares);
                        
                        // Receita estimada
                        if (estimatedRevenue > 0) {
                            document.getElementById('analytics-estimated-revenue').textContent = '$' + estimatedRevenue.toFixed(2);
                        } else {
                            document.getElementById('analytics-estimated-revenue').textContent = 'N/A';
                        }
                        document.getElementById('analytics-ad-impressions').textContent = formatNumber(adImpressions);
                        
                        // Calcular RPM (Revenue per Mille - receita por 1000 views)
                        const rpm = views > 0 && estimatedRevenue > 0 ? (estimatedRevenue / (views / 1000)).toFixed(2) : '0.00';
                        document.getElementById('analytics-rpm').textContent = '$' + rpm;
                        
                        // Calcular taxa de engajamento
                        const engagementRate = views > 0 ? ((likes + comments + shares) / views * 100).toFixed(2) : '0.00';
                        document.getElementById('analytics-engagement-rate').textContent = engagementRate + '%';
                        
                        // Preencher mudanças (simulado - idealmente viria de comparação com período anterior)
                        document.getElementById('analytics-views-change').textContent = 'Período selecionado';
                        document.getElementById('analytics-watch-time-change').textContent = 'Período selecionado';
                        document.getElementById('analytics-subscribers-gained-change').textContent = 'Novos no período';
                    }
                    
                    // Métricas avançadas (reais quando disponíveis via YouTube Analytics API)
                    if (data.advanced) {
                        const avgDur = data.advanced.averageViewDurationFormatted;
                        const avpRaw = data.advanced.averageViewPercentage;
                        const ctrRaw = data.advanced.impressionsCtr;
                        const avp = (avpRaw !== null && avpRaw !== undefined && !isNaN(parseFloat(avpRaw))) ? parseFloat(avpRaw) : null;
                        const ctr = (ctrRaw !== null && ctrRaw !== undefined && !isNaN(parseFloat(ctrRaw))) ? parseFloat(ctrRaw) : null;
                        document.getElementById('analytics-avg-view-duration').textContent = avgDur || 'N/A';
                        document.getElementById('analytics-retention-rate').textContent = (avp !== null) ? `${avp.toFixed(1)}%` : 'N/A';
                        document.getElementById('analytics-ctr').textContent = (ctr !== null) ? `${ctr.toFixed(2)}%` : 'N/A';
                    } else {
                        document.getElementById('analytics-avg-view-duration').textContent = 'N/A';
                        document.getElementById('analytics-retention-rate').textContent = 'N/A';
                        document.getElementById('analytics-ctr').textContent = 'N/A';
                    }
                    
                    // Desenhar gráfico
                    if (data.daily && data.daily.rows && data.daily.rows.length > 0) {
                        drawAnalyticsChart(data.daily);
                    } else if (data.analytics && data.analytics.rows && data.analytics.rows.length > 0) {
                        drawAnalyticsChart(data.analytics);
                    }
                    
                    // Preencher vídeos recentes
                    if (data.recentVideos && data.recentVideos.length > 0) {
                        const videosHtml = data.recentVideos.map(video => `
                            <div class="bg-gray-700 border border-gray-600 rounded-lg p-3">
                                <h4 class="text-white font-semibold mb-2">${escapeHtml(video.title)}</h4>
                                <div class="grid grid-cols-3 gap-2 text-sm">
                                    <div>
                                        <p class="text-gray-400">Visualizações</p>
                                        <p class="text-white font-bold">${formatNumber(video.views)}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Curtidas</p>
                                        <p class="text-white font-bold">${formatNumber(video.likes)}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400">Comentários</p>
                                        <p class="text-white font-bold">${formatNumber(video.comments)}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        document.getElementById('analytics-recent-videos').innerHTML = videosHtml;
                    } else {
                        const errText = data?.recentVideosError?.status
                            ? ` (erro ${data.recentVideosError.status})`
                            : '';
                        document.getElementById('analytics-recent-videos').innerHTML = `<p class="text-gray-400">Nenhum vídeo encontrado${errText}.</p>`;
                    }

                    // Top 5 vídeos mais vistos + análise
                    const topVideosEl = document.getElementById('analytics-top-videos');
                    if (topVideosEl) {
                        if (data.topVideosAnalysis && data.topVideosAnalysis.length > 0) {
                            topVideosEl.innerHTML = data.topVideosAnalysis.map(v => `
                                <div class="bg-gray-700 border border-gray-600 rounded-lg p-4">
                                    <div class="flex items-start gap-3">
                                        ${v.thumbnail ? `<img src="${escapeHtml(v.thumbnail)}" alt="" class="w-16 h-10 object-cover rounded border border-gray-600 flex-shrink-0">` : ''}
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between gap-3">
                                                <h4 class="text-white font-semibold truncate">${escapeHtml(v.title || 'Sem título')}</h4>
                                                ${v.videoId ? `<a class="text-xs text-amber-400 hover:text-amber-300 whitespace-nowrap" target="_blank" href="https://www.youtube.com/watch?v=${encodeURIComponent(v.videoId)}">Abrir</a>` : ''}
                                            </div>
                                            <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                                                <div><span class="text-gray-400">Views</span><div class="text-white font-bold">${formatNumber(v.viewCount || 0)}</div></div>
                                                <div><span class="text-gray-400">Likes</span><div class="text-white font-bold">${formatNumber(v.likeCount || 0)}</div></div>
                                                <div><span class="text-gray-400">Comentários</span><div class="text-white font-bold">${formatNumber(v.commentCount || 0)}</div></div>
                                                <div><span class="text-gray-400">Views/dia</span><div class="text-white font-bold">${formatNumber(v.derived?.viewsPerDay || 0)}</div></div>
                                            </div>
                                            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                                                <div class="bg-gray-800/60 border border-gray-700 rounded p-3">
                                                    <p class="text-gray-300 text-xs font-semibold mb-2">Dicas valiosas</p>
                                                    <ul class="text-gray-200 text-xs space-y-1 list-disc list-inside">
                                                        ${(v.tips || []).slice(0, 4).map(t => `<li>${escapeHtml(t)}</li>`).join('')}
                                                    </ul>
                                                </div>
                                                <div class="bg-gray-800/60 border border-gray-700 rounded p-3">
                                                    <p class="text-gray-300 text-xs font-semibold mb-2">Próximos vídeos (inspirados)</p>
                                                    <ul class="text-gray-200 text-xs space-y-1 list-disc list-inside">
                                                        ${(v.nextVideoIdeas || []).slice(0, 3).map(t => `<li>${escapeHtml(t)}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            const errText = data?.topVideosError?.status
                                ? ` (erro ${data.topVideosError.status} — possivelmente quota da API do YouTube)`
                                : '';
                            topVideosEl.innerHTML = `<p class="text-gray-400">Não foi possível carregar o Top 5${errText}.</p>`;
                        }
                    }

                    // Breakdowns: fontes de tráfego e países
                    const trafficEl = document.getElementById('analytics-traffic-sources');
                    const countriesEl = document.getElementById('analytics-top-countries');
                    const insightsEl = document.getElementById('analytics-action-insights');

                    const renderBreakdown = (report, dimensionKey, metricKey, labelMapper) => {
                        const rows = report?.rows || [];
                        const headers = report?.columnHeaders?.map(h => h.name) || [];
                        const dimIdx = headers.findIndex(h => h === dimensionKey);
                        const metIdx = headers.findIndex(h => h === metricKey);
                        if (rows.length === 0 || dimIdx < 0 || metIdx < 0) return [];
                        return rows.slice(0, 6).map(r => ({
                            label: labelMapper ? labelMapper(r[dimIdx]) : String(r[dimIdx]),
                            value: parseInt(r[metIdx] || 0)
                        }));
                    };

                    const trafficName = (code) => {
                        const map = {
                            YT_SEARCH: 'Busca do YouTube',
                            SUGGESTED_VIDEO: 'Vídeos sugeridos',
                            BROWSE: 'Página inicial / Navegação',
                            EXTERNAL: 'Externo',
                            PLAYLIST: 'Playlists',
                            NOTIFICATIONS: 'Notificações',
                            CHANNEL: 'Páginas do canal',
                            OTHER: 'Outros'
                        };
                        return map[String(code || '').toUpperCase()] || String(code || 'Desconhecido');
                    };

                    const trafficItems = data.trafficSources ? renderBreakdown(data.trafficSources, 'insightTrafficSourceType', 'views', trafficName) : [];
                    if (trafficEl) {
                        trafficEl.innerHTML = trafficItems.length
                            ? trafficItems.map(i => `
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-300">${escapeHtml(i.label)}</span>
                                    <span class="text-white font-semibold">${formatNumber(i.value)}</span>
                                </div>
                            `).join('')
                            : '<p class="text-gray-400 text-sm">Sem dados suficientes.</p>';
                    }

                    const countryItems = data.topCountries ? renderBreakdown(data.topCountries, 'country', 'views') : [];
                    if (countriesEl) {
                        countriesEl.innerHTML = countryItems.length
                            ? countryItems.map(i => `
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-300">${escapeHtml(i.label)}</span>
                                    <span class="text-white font-semibold">${formatNumber(i.value)}</span>
                                </div>
                            `).join('')
                            : '<p class="text-gray-400 text-sm">Sem dados suficientes.</p>';
                    }

                    // Insights acionáveis (heurísticos)
                    if (insightsEl) {
                        const tips = [];
                        const adv = data.advanced || {};
                        if (typeof adv.impressionsCtr === 'number') {
                            if (adv.impressionsCtr < 4) tips.push(`CTR baixo (${adv.impressionsCtr.toFixed(2)}%). Priorize testes de título/thumbnail (2–3 variações) antes de publicar.`);
                            else if (adv.impressionsCtr >= 8) tips.push(`CTR forte (${adv.impressionsCtr.toFixed(2)}%). Mantenha o padrão visual e replique fórmulas vencedoras.`);
                        }
                        if (typeof adv.averageViewPercentage === 'number') {
                            if (adv.averageViewPercentage < 35) tips.push(`Retenção baixa (${adv.averageViewPercentage.toFixed(1)}%). Melhore o hook nos 15s iniciais e reduza enrolação.`);
                            else if (adv.averageViewPercentage >= 50) tips.push(`Retenção ótima (${adv.averageViewPercentage.toFixed(1)}%). Foque em aumentar distribuição (SEO + sugestão) para escalar.`);
                        }
                        if (trafficItems.length) {
                            const total = trafficItems.reduce((a, b) => a + (b.value || 0), 0) || 1;
                            const top = trafficItems[0];
                            const share = ((top.value / total) * 100);
                            tips.push(`Principal fonte: ${top.label} (${share.toFixed(0)}% do Top). Dobre a aposta na otimização específica dessa origem.`);
                            if (top.label.includes('Busca')) tips.push('Para ganhar do concorrente na Busca: títulos com keyword exata + descrição com 1º parágrafo bem SEO + tags focadas.');
                            if (top.label.includes('sugeridos') || top.label.includes('Página inicial')) tips.push('Para dominar Sugeridos/Home: aumente retenção e encadeie vídeos (séries + telas finais + playlists).');
                        }
                        if (data.analyticsMeta?.degraded) {
                            tips.push('Algumas métricas avançadas não estavam disponíveis para este canal/período; mostrando o melhor conjunto possível.');
                        }
                        insightsEl.innerHTML = tips.length
                            ? `<ul class="text-gray-200 text-sm space-y-2 list-disc list-inside">${tips.slice(0, 6).map(t => `<li>${escapeHtml(t)}</li>`).join('')}</ul>`
                            : '<p class="text-gray-400 text-sm">Sem insights suficientes neste período.</p>';
                    }
                    
                    loadingDiv.classList.add('hidden');
                    contentDiv.classList.remove('hidden');
                    
                    // Atualizar ícones
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                } catch (err) {
                    console.error('[Analytics] Erro:', err);
                    loadingDiv.classList.add('hidden');
                    showMessage('youtube-integration-error-message', 'Erro ao carregar métricas: ' + err.message, true);
                }
            };
            
            // Função para desenhar gráfico de analytics
            function drawAnalyticsChart(report) {
                const canvas = document.getElementById('analytics-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const width = canvas.parentElement.clientWidth - 48;
                const height = 300;
                canvas.width = width;
                canvas.height = height;
                
                // Limpar canvas
                ctx.clearRect(0, 0, width, height);
                
                const rows = report?.rows || [];
                const headers = report?.columnHeaders?.map(h => h.name) || [];
                
                if (!rows || rows.length === 0) {
                    ctx.fillStyle = '#9CA3AF';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Sem dados para exibir', width / 2, height / 2);
                    return;
                }
                
                // Extrair dados de visualizações
                const viewsIndex = headers.findIndex(h => h === 'views');
                const fallbackIndex = viewsIndex >= 0 ? viewsIndex : 0;
                const views = rows.map(row => parseInt(row[fallbackIndex] || 0));
                const maxViews = Math.max(...views, 1);
                
                // Configurações do gráfico
                const padding = 40;
                const chartWidth = width - padding * 2;
                const chartHeight = height - padding * 2;
                const barWidth = chartWidth / Math.max(views.length, 1);
                
                // Desenhar eixo Y
                ctx.strokeStyle = '#4B5563';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                ctx.stroke();
                
                // Desenhar eixo X
                ctx.beginPath();
                ctx.moveTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();
                
                // Desenhar barras
                views.forEach((value, index) => {
                    const barHeight = (value / maxViews) * chartHeight;
                    const x = padding + index * barWidth;
                    const y = height - padding - barHeight;
                    
                    // Gradiente
                    const gradient = ctx.createLinearGradient(x, y, x, height - padding);
                    gradient.addColorStop(0, '#F59E0B');
                    gradient.addColorStop(1, '#D97706');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
                    
                    // Valor no topo da barra
                    if (value > 0) {
                        ctx.fillStyle = '#FFFFFF';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(formatNumber(value), x + barWidth / 2, y - 5);
                    }
                });
            }
            
            // Função para alternar tipo de gráfico
            window.toggleChartType = function(type) {
                document.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-amber-600');
                    btn.classList.add('bg-gray-700');
                });
                const btn = document.querySelector(`[data-type="${type}"]`);
                if (btn) {
                    btn.classList.add('active', 'bg-amber-600');
                    btn.classList.remove('bg-gray-700');
                }
                // Recarregar gráfico com novo tipo (implementação simplificada)
                const channelSelect = document.getElementById('analytics-channel-select');
                if (channelSelect && channelSelect.value) {
                    loadChannelAnalytics();
                }
            };

            // Função auxiliar para formatar minutos
            function formatMinutes(minutes) {
                if (minutes < 60) return minutes + ' min';
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                if (hours < 24) return hours + 'h ' + mins + 'min';
                const days = Math.floor(hours / 24);
                const hrs = hours % 24;
                return days + 'd ' + hrs + 'h';
            }

            // Upload tabs (Detalhes / Visibilidade)
            window.switchUploadTab = function(tabName) {
                const panes = {
                    details: document.getElementById('upload-pane-details'),
                    visibility: document.getElementById('upload-pane-visibility'),
                };
                Object.values(panes).forEach(p => p && p.classList.add('hidden'));
                if (panes[tabName]) panes[tabName].classList.remove('hidden');

                const tabs = ['details', 'visibility'];
                tabs.forEach(t => {
                    const btn = document.getElementById(`upload-tab-${t}`);
                    if (!btn) return;
                    btn.classList.remove('border-amber-500', 'text-amber-500');
                    btn.classList.add('border-transparent', 'text-gray-400');
                });
                const activeBtn = document.getElementById(`upload-tab-${tabName}`);
                if (activeBtn) {
                    activeBtn.classList.add('border-amber-500', 'text-amber-500');
                    activeBtn.classList.remove('border-transparent', 'text-gray-400');
                }

                if (typeof lucide !== 'undefined') lucide.createIcons();
            };

            // Configurar campo de agendamento
            const publishTypeSelect = document.getElementById('upload-publish-type');
            const scheduleContainer = document.getElementById('schedule-datetime-container');
            const scheduleInput = document.getElementById('upload-schedule-datetime');
            const uploadButtonText = document.getElementById('upload-button-text');
            
            if (publishTypeSelect && scheduleContainer && scheduleInput) {
                // Definir data mínima como agora
                const now = new Date();
                now.setMinutes(now.getMinutes() + 1); // Mínimo 1 minuto no futuro
                scheduleInput.min = now.toISOString().slice(0, 16);
                
                // Garantir que required seja removido inicialmente se o campo estiver oculto
                if (scheduleContainer.classList.contains('hidden')) {
                    scheduleInput.removeAttribute('required');
                    scheduleInput.required = false;
                }
                
                publishTypeSelect.addEventListener('change', function() {
                    if (this.value === 'schedule') {
                        scheduleContainer.classList.remove('hidden');
                        scheduleInput.setAttribute('required', 'required');
                        scheduleInput.required = true;
                        if (uploadButtonText) uploadButtonText.textContent = 'Agendar Vídeo';
                    } else {
                        scheduleContainer.classList.add('hidden');
                        scheduleInput.removeAttribute('required');
                        scheduleInput.required = false;
                        scheduleInput.value = ''; // Limpar valor também
                        if (uploadButtonText) uploadButtonText.textContent = 'Enviar Vídeo para YouTube';
                    }
                });
            }

            // Função para fazer upload de vídeo diretamente para YouTube
            document.getElementById('youtube-upload-form')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const channelSelect = document.getElementById('upload-channel-select');
                const videoFile = document.getElementById('upload-video-file').files[0];
                const title = document.getElementById('upload-video-title').value;
                const description = document.getElementById('upload-video-description').value;
                const tags = document.getElementById('upload-video-tags').value;
                const thumbnailFile = document.getElementById('upload-video-thumbnail').files[0];
                const privacy = document.getElementById('upload-video-privacy').value;
                const publishTypeValue = document.getElementById('upload-publish-type')?.value || 'now';
                const scheduleDateTime = document.getElementById('upload-schedule-datetime')?.value;
                
                // Validar campo de agendamento apenas se estiver visível
                if (publishTypeValue === 'schedule' && (!scheduleDateTime || scheduleDateTime.trim() === '')) {
                    showMessage('youtube-integration-error-message', 'Selecione uma data e hora para o agendamento.', true);
                    return;
                }
                
                if (!channelSelect || !channelSelect.value || !videoFile) {
                    showMessage('youtube-integration-error-message', 'Preencha todos os campos obrigatórios.', true);
                    return;
                }
                
                // Validar agendamento
                if (publishTypeValue === 'schedule' && !scheduleDateTime) {
                    showMessage('youtube-integration-error-message', 'Selecione uma data e hora para agendamento.', true);
                    return;
                }
                
                if (publishTypeValue === 'schedule') {
                    const scheduleDate = new Date(scheduleDateTime);
                    const now = new Date();
                    if (scheduleDate <= now) {
                        showMessage('youtube-integration-error-message', 'A data de agendamento deve ser no futuro.', true);
                        return;
                    }
                }
                
                try {
                    const progressDiv = document.getElementById('upload-progress');
                    const progressBar = document.getElementById('upload-progress-bar');
                    const statusText = document.getElementById('upload-status');
                    
                    // Se for agendamento, usar endpoint diferente
                    if (publishTypeValue === 'schedule') {
                        progressDiv.classList.remove('hidden');
                        progressBar.style.width = '0%';
                        statusText.textContent = 'Preparando agendamento...';
                        
                        const token = localStorage.getItem('core_token');
                        
                        // Fazer upload do arquivo primeiro
                        const formData = new FormData();
                        formData.append('video', videoFile);
                        if (thumbnailFile) {
                            formData.append('thumbnail', thumbnailFile);
                        }
                        
                        progressBar.style.width = '30%';
                        statusText.textContent = 'Enviando arquivo...';
                        
                        // Upload temporário do arquivo
                        const uploadResponse = await fetch(`${API_BASE}/api/youtube/schedule/upload`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            const errorData = await uploadResponse.json().catch(() => ({}));
                            throw new Error(errorData.msg || 'Erro ao fazer upload do arquivo');
                        }
                        
                        const uploadData = await uploadResponse.json();
                        
                        progressBar.style.width = '60%';
                        statusText.textContent = 'Agendando publicação...';
                        
                        // Agendar publicação
                        const selectedOption = channelSelect.options[channelSelect.selectedIndex];
                        const scheduleResponse = await fetch(`${API_BASE}/api/youtube/schedule`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                youtubeIntegrationId: selectedOption?.dataset.integrationId || null,
                                channelId: channelSelect.value,
                                videoFilePath: uploadData.videoPath,
                                thumbnailPath: uploadData.thumbnailPath || null,
                                title: title,
                                description: description,
                                tags: tags ? tags.split(',').map(t => t.trim()) : [],
                                scheduledTime: scheduleDateTime,
                                privacy: privacy
                            })
                        });
                        
                        if (!scheduleResponse.ok) {
                            const errorData = await scheduleResponse.json().catch(() => ({}));
                            throw new Error(errorData.msg || 'Erro ao agendar publicação');
                        }
                        
                        progressBar.style.width = '100%';
                        statusText.textContent = 'Vídeo agendado com sucesso!';
                        
                        const result = await scheduleResponse.json();
                        showMessage('youtube-integration-success-message', `Vídeo agendado para ${new Date(scheduleDateTime).toLocaleString('pt-BR')}!`);
                        
                        // Limpar formulário
                        document.getElementById('youtube-upload-form').reset();
                        if (scheduleContainer) scheduleContainer.classList.add('hidden');
                        if (uploadButtonText) uploadButtonText.textContent = 'Enviar Vídeo para YouTube';
                        
                        // Recarregar lista de agendamentos
                        if (typeof loadScheduledPosts === 'function') {
                            loadScheduledPosts();
                        }
                        
                        setTimeout(() => {
                            progressDiv.classList.add('hidden');
                        }, 3000);
                        return; // Sair da função aqui para agendamento
                    }
                    
                    // Upload imediato - enviar arquivo via FormData para o servidor
                    progressDiv.classList.remove('hidden');
                    progressBar.style.width = '0%';
                    statusText.textContent = 'Preparando upload...';
                    
                    const token = localStorage.getItem('core_token');
                    
                    // Criar FormData com todos os dados
                    const formData = new FormData();
                    formData.append('video', videoFile);
                    if (thumbnailFile) {
                        formData.append('thumbnail', thumbnailFile);
                    }
                    formData.append('channelId', channelSelect.value);
                    formData.append('title', title);
                    formData.append('description', description);
                    formData.append('tags', JSON.stringify(tags ? tags.split(',').map(t => t.trim()) : []));
                    formData.append('privacy', privacy);
                    // Categoria removida do layout (mantemos padrão 22)
                    formData.append('categoryId', '22');
                    
                    // Simular progresso (upload via servidor não permite progresso real em chunks)
                    progressBar.style.width = '30%';
                    statusText.textContent = 'Enviando arquivo para o servidor...';
                    
                    // Fazer upload via servidor
                    const uploadResponse = await fetch(`${API_BASE}/api/youtube/upload/complete`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    progressBar.style.width = '80%';
                    statusText.textContent = 'Processando upload no servidor...';
                    
                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json().catch(() => ({}));
                        throw new Error(errorData.msg || 'Erro ao fazer upload do vídeo');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    
                    progressBar.style.width = '100%';
                    statusText.textContent = 'Upload concluído!';
                    showMessage('youtube-integration-success-message', `Vídeo enviado com sucesso! <a href="${uploadResult.videoUrl}" target="_blank" class="underline">Ver vídeo</a>`);
                    
                    // Limpar formulário
                    document.getElementById('youtube-upload-form').reset();
                    if (scheduleContainer) scheduleContainer.classList.add('hidden');
                    if (uploadButtonText) uploadButtonText.textContent = 'Enviar Vídeo para YouTube';
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                    }, 3000);
                    return;
                    
                } catch (err) {
                    console.error('[Upload] Erro:', err);
                    showMessage('youtube-integration-error-message', 'Erro ao fazer upload: ' + err.message, true);
                    document.getElementById('upload-progress').classList.add('hidden');
                }
            });

            // Atualizar lista de canais nos selects quando carregar
            async function updateChannelSelects() {
                // Retornar promise para permitir .then()
                return new Promise(async (resolve, reject) => {
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        console.warn('[Channel Selects] Token não encontrado');
                        resolve();
                        return;
                    }
                    
                    console.log('[Channel Selects] Buscando canais...');
                    const response = await fetch(`${API_BASE}/api/youtube/channels`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        console.error('[Channel Selects] Erro ao buscar canais:', response.status, response.statusText);
                        const errorText = await response.text().catch(() => '');
                        console.error('[Channel Selects] Resposta de erro:', errorText);
                        resolve();
                        return;
                    }
                    
                    const data = await response.json();
                    const channels = data.channels || [];
                    
                    console.log(`[Channel Selects] ${channels.length} canais encontrados:`, channels.map(c => c.channelName));
                    
                    // Atualizar select de upload
                    const uploadSelect = document.getElementById('upload-channel-select');
                    if (uploadSelect) {
                        // Clonar select para remover listeners antigos
                        const newSelect = uploadSelect.cloneNode(false);
                        newSelect.innerHTML = '<option value="">Selecione um canal...</option>' +
                            channels.map(c => `<option value="${c.channelId}" data-integration-id="${c.id}" data-niche="${c.niche || ''}" data-subniche="${c.subniche || ''}" data-language="${c.language || ''}" data-country="${c.country || ''}">${escapeHtml(c.channelName || 'Canal sem nome')}${c.language ? ' • ' + escapeHtml(c.language) : ''}</option>`).join('');
                        
                        // Substituir o select antigo pelo novo
                        uploadSelect.parentNode.replaceChild(newSelect, uploadSelect);
                        
                        // Adicionar listener para preencher automaticamente nicho quando selecionar canal
                        newSelect.addEventListener('change', function() {
                            const selectedOption = this.options[this.selectedIndex];
                            if (selectedOption && selectedOption.dataset.niche) {
                                autoFillNicheFromChannel(this.value);
                            }
                        });
                        
                        console.log('[Channel Selects] Select de upload atualizado com sucesso');
                    } else {
                        console.warn('[Channel Selects] Select de upload não encontrado no DOM');
                    }
                    
                    // Atualizar select de analytics
                    const analyticsSelect = document.getElementById('analytics-channel-select');
                    if (analyticsSelect) {
                        const currentValue = analyticsSelect.value; // Manter seleção atual se possível
                        
                        // Clonar select para remover listeners antigos
                        const newSelect = analyticsSelect.cloneNode(false);
                        newSelect.innerHTML = '<option value="">Selecione um canal...</option>' +
                            channels.map(c => `<option value="${c.id}" data-niche="${escapeHtml(c.niche || '')}" data-subniche="${escapeHtml(c.subniche || '')}" data-language="${escapeHtml(c.language || '')}" data-country="${escapeHtml(c.country || '')}">${escapeHtml(c.channelName || 'Canal sem nome')}${c.language ? ' • ' + escapeHtml(c.language) : ''}</option>`).join('');
                        
                        analyticsSelect.parentNode.replaceChild(newSelect, analyticsSelect);
                        
                        // Se havia uma seleção anterior e ainda existe, manter
                        if (currentValue && channels.some(c => c.id.toString() === currentValue)) {
                            newSelect.value = currentValue;
                        } else if (channels.length === 1) {
                            // Se há apenas um canal, selecionar automaticamente
                            newSelect.value = channels[0].id;
                            // Auto-carregar analytics se estiver na aba analytics
                            const analyticsTab = document.getElementById('youtube-tab-content-analytics');
                            if (analyticsTab && analyticsTab.style.display !== 'none') {
                                setTimeout(() => {
                                    if (typeof loadChannelAnalytics === 'function') {
                                        loadChannelAnalytics();
                                    }
                                }, 300);
                            }
                        }

                        // Atualizar meta do canal selecionado
                        const metaEl = document.getElementById('analytics-channel-meta');
                        const updateMeta = () => {
                            if (!metaEl) return;
                            const opt = newSelect.options[newSelect.selectedIndex];
                            if (!opt || !opt.value) {
                                metaEl.textContent = '';
                                return;
                            }
                            // Salvar canal principal (dashboard inicial) baseado na seleção
                            try {
                                localStorage.setItem('primary_youtube_integration_id', String(newSelect.value));
                            } catch (_) {}
                            const niche = opt.dataset.niche ? `📌 ${opt.dataset.niche}` : '';
                            const sub = opt.dataset.subniche ? `🎯 ${opt.dataset.subniche}` : '';
                            const lang = opt.dataset.language ? `🌍 ${opt.dataset.language}${opt.dataset.country ? ' • ' + opt.dataset.country : ''}` : '';
                            const parts = [niche, sub, lang].filter(Boolean);
                            metaEl.textContent = parts.join('  •  ');
                        };
                        newSelect.addEventListener('change', updateMeta);
                        updateMeta();
                    }
                    
                    // Atualizar select de insights
                    const insightsSelect = document.getElementById('insights-channel-select');
                    if (insightsSelect) {
                        insightsSelect.innerHTML = '<option value="">Selecione um canal...</option>' +
                            channels.map(c => `<option value="${c.id}">${escapeHtml(c.channelName || 'Canal sem nome')}</option>`).join('');
                    }
                    
                } catch (err) {
                    console.error('[Channel Selects] Erro ao atualizar:', err);
                    reject(err);
                }
                resolve();
                });
            }

            // Função para re-analisar nicho do canal
            window.reanalyzeChannelNiche = async function(integrationId, channelName) {
                const confirmed = await showCustomConfirm(
                    `Deseja re-analisar o nicho do canal "${channelName}"? A análise usará os últimos 10 vídeos do canal.`,
                    'Re-analisar Nicho'
                );
                if (!confirmed) return;
                
                try {
                    showMessage('youtube-integration-success-message', 'Iniciando re-análise do nicho...');
                    
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/channels/${integrationId}/reanalyze-niche`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.msg || 'Erro ao re-analisar nicho');
                    }
                    
                    const result = await response.json();
                    showMessage('youtube-integration-success-message', 'Re-análise iniciada! O nicho será atualizado em alguns segundos.');
                    
                    // Recarregar lista de canais após alguns segundos
                    setTimeout(() => {
                        loadYouTubeIntegrationStatus();
                    }, 5000);
                    
                } catch (err) {
                    console.error('[Re-analyze] Erro:', err);
                    showMessage('youtube-integration-error-message', 'Erro ao re-analisar nicho: ' + err.message, true);
                }
            };

            // Função para carregar insights do canal
            window.loadChannelInsights = async function() {
                const channelSelect = document.getElementById('insights-channel-select');
                const loadingDiv = document.getElementById('insights-loading');
                const contentDiv = document.getElementById('insights-content');
                
                if (!channelSelect || !channelSelect.value) {
                    showMessage('youtube-integration-error-message', 'Selecione um canal primeiro.', true);
                    return;
                }
                
                try {
                    loadingDiv.classList.remove('hidden');
                    contentDiv.classList.add('hidden');
                    
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/channels/${channelSelect.value}/insights`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.msg || 'Erro ao gerar insights');
                    }
                    
                    const data = await response.json();
                    
                    // Preencher insights
                    if (data.summary) {
                        document.getElementById('insights-summary').innerHTML = `<p class="text-gray-300">${escapeHtml(data.summary)}</p>`;
                    }
                    
                    if (data.frequency) {
                        document.getElementById('insights-frequency').innerHTML = `<p class="text-amber-400 font-semibold text-lg">${escapeHtml(data.frequency)}</p>`;
                    }
                    
                    if (data.duration) {
                        document.getElementById('insights-duration').innerHTML = `<p class="text-amber-400 font-semibold text-lg">${escapeHtml(data.duration)}</p>`;
                    }
                    
                    if (data.publishTime) {
                        document.getElementById('insights-publish-time').innerHTML = `<p class="text-amber-400 font-semibold text-lg">${escapeHtml(data.publishTime)}</p>`;
                    }
                    
                    if (data.contentType) {
                        document.getElementById('insights-content-type').innerHTML = `<p class="text-gray-300">${escapeHtml(data.contentType)}</p>`;
                    }
                    
                    if (data.strategies && Array.isArray(data.strategies)) {
                        const strategiesHtml = data.strategies.map((strategy, idx) => `
                            <div class="flex items-start space-x-3">
                                <span class="text-amber-500 font-bold">${idx + 1}.</span>
                                <p class="text-gray-300 flex-1">${escapeHtml(strategy)}</p>
                            </div>
                        `).join('');
                        document.getElementById('insights-strategies').innerHTML = strategiesHtml;
                    }
                    
                    if (data.titlePatterns && Array.isArray(data.titlePatterns)) {
                        const titlesHtml = data.titlePatterns.map(pattern => `
                            <div class="bg-gray-700 border border-gray-600 rounded p-3">
                                <p class="text-white font-medium">${escapeHtml(pattern)}</p>
                            </div>
                        `).join('');
                        document.getElementById('insights-titles').innerHTML = titlesHtml;
                    }
                    
                    if (data.thumbnailRecommendations) {
                        document.getElementById('insights-thumbnails').innerHTML = `<p class="text-gray-300">${escapeHtml(data.thumbnailRecommendations)}</p>`;
                    }
                    
                    loadingDiv.classList.add('hidden');
                    contentDiv.classList.remove('hidden');
                    
                    // Atualizar ícones
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    
                } catch (err) {
                    console.error('[Insights] Erro:', err);
                    loadingDiv.classList.add('hidden');
                    showMessage('youtube-integration-error-message', 'Erro ao gerar insights: ' + err.message, true);
                }
            };

            // Função para desconectar um canal
            window.disconnectChannel = async function(channelId) {
                const confirmed = await showCustomConfirm(
                    'Tem certeza que deseja desconectar este canal?',
                    'Confirmar Desconexão'
                );
                if (!confirmed) return;
                
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        showMessage('youtube-integration-error-message', 'Token de autenticação não encontrado.', true);
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/youtube/channels/${channelId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.msg || 'Falha ao desconectar canal');
                    }
                    
                    showMessage('youtube-integration-success-message', 'Canal desconectado com sucesso!');
                    await loadYouTubeIntegrationStatus(); // Recarregar lista
                } catch (err) {
                    console.error('[YouTube Integration] Erro ao desconectar:', err);
                    showMessage('youtube-integration-error-message', err.message, true);
                }
            }

            const btnConnectYouTube = document.getElementById('btn-connect-youtube');
            if (btnConnectYouTube) {
                btnConnectYouTube.addEventListener('click', async () => {
                    try {
                        // Obter token dentro da função
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            showMessage('youtube-integration-error-message', 'Token de autenticação não encontrado. Faça login novamente.', true);
                            return;
                        }
                        
                        if (typeof API_BASE === 'undefined') {
                            showMessage('youtube-integration-error-message', 'API_BASE não está definido. Recarregue a página.', true);
                            return;
                        }
                        
                        const response = await fetch(`${API_BASE}/api/youtube/oauth/authorize`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.msg || 'Falha ao obter URL de autorização.');
                        }
                        const data = await response.json();
                        window.open(data.authUrl, '_blank');
                        showMessage('youtube-integration-success-message', 'Autorize o acesso no popup que foi aberto.');
                    } catch (err) {
                        console.error('[YouTube Integration] Erro ao conectar:', err);
                        showMessage('youtube-integration-error-message', err.message, true);
                    }
                });
            }

            async function loadScheduledPosts() {
                try {
                    // Obter token dentro da função para garantir que está disponível
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        console.warn('[YouTube Integration] Token não encontrado');
                        const list = document.getElementById('scheduled-posts-list');
                        if (list) {
                            list.innerHTML = '<p class="text-red-400">Erro: Token de autenticação não encontrado. Faça login novamente.</p>';
                        }
                        return;
                    }
                    
                    if (typeof API_BASE === 'undefined') {
                        console.error('[YouTube Integration] API_BASE não está definido');
                        const list = document.getElementById('scheduled-posts-list');
                        if (list) {
                            list.innerHTML = '<p class="text-red-400">Erro: API_BASE não está definido. Recarregue a página.</p>';
                        }
                        return;
                    }
                    
                    console.log('[YouTube] Carregando publicações agendadas...', { API_BASE, hasToken: !!token });
                    console.log('[YouTube] Fazendo requisição para:', `${API_BASE}/api/youtube/scheduled`);
                    const response = await fetch(`${API_BASE}/api/youtube/scheduled`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    console.log('[YouTube] Resposta:', response.status);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ msg: 'Erro desconhecido' }));
                        throw new Error(errorData.msg || `Falha ao carregar publicações agendadas: ${response.status}`);
                    }
                    const scheduled = await response.json();
                    const scheduledArray = Array.isArray(scheduled) ? scheduled : [];
                    console.log('[YouTube] Publicações recebidas:', scheduledArray.length);

                    const list = document.getElementById('scheduled-posts-list');
                    if (list) {
                        if (scheduledArray.length > 0) {
                            list.innerHTML = scheduledArray.map(post => `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="flex-1 min-w-0">
                                            <h3 class="text-white font-semibold truncate">${escapeHtml(post.title || 'Sem título')}</h3>
                                            <p class="text-gray-400 text-sm">Agendado para: ${post.scheduled_time ? new Date(post.scheduled_time).toLocaleString('pt-BR') : 'N/A'}</p>
                                            <p class="text-gray-400 text-sm">Status: <span class="px-2 py-1 text-xs rounded ${post.status === 'published' ? 'bg-green-600' : post.status === 'failed' ? 'bg-red-600' : 'bg-yellow-600'}">${escapeHtml(post.status || 'pending')}</span></p>
                                            ${post.description ? `<p class="text-gray-500 text-xs mt-2 line-clamp-2">${escapeHtml(post.description)}</p>` : ''}
                                        </div>
                                        <div class="flex items-center gap-2 flex-shrink-0">
                                            <button onclick="deleteScheduledPost(${post.id})" class="py-2 px-3 rounded-lg bg-red-600 hover:bg-red-500 text-white text-sm font-semibold transition duration-300" title="Excluir agendamento">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            list.innerHTML = '<p class="text-gray-400">Nenhuma publicação agendada.</p>';
                        }
                    }
                } catch (err) {
                    console.error('Erro ao carregar publicações agendadas:', err);
                    const list = document.getElementById('scheduled-posts-list');
                    if (list) {
                        list.innerHTML = `<p class="text-red-400">Erro ao carregar publicações: ${err.message}</p>`;
                    }
                }
            }

            window.deleteScheduledPost = async function(postId) {
                const confirmed = await showCustomConfirm('Tem certeza que deseja excluir este agendamento? Esta ação não pode ser desfeita.', 'Confirmar Exclusão');
                if (!confirmed) return;
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/youtube/scheduled/${postId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.msg || 'Falha ao excluir agendamento.');
                    }
                    showMessage('youtube-integration-success-message', 'Agendamento excluído com sucesso!');
                    loadScheduledPosts();
                } catch (err) {
                    showMessage('youtube-integration-error-message', err.message, true);
                }
            };

            // ============================================
            // 🎨 PROMTPS E IMAGENS - Lógica Integrada
            // ============================================
            
            let scenePromptsData = [];
            
            // Função para calcular estimativa de cenas
            function calculateSceneEstimate() {
                const scriptText = document.getElementById('scene-script-text');
                const modeSelect = document.getElementById('scene-generation-mode');
                const wordsPerScene = document.getElementById('scene-words-per-scene');
                const unitSelect = document.getElementById('scene-unit-select');
                const estimateBox = document.getElementById('estimated-scenes-count');
                
                if (!scriptText || !modeSelect || !estimateBox) return;
                
                const text = scriptText.value.trim();
                const words = text.split(/\s+/).filter(Boolean).length;
                const mode = modeSelect.value;
                
                let estimatedScenes = 0;
                if (mode === 'automatic') {
                    // Modo automático: 1 cena a cada ~90 palavras
                    estimatedScenes = Math.max(1, Math.round(words / 90));
                } else {
                    // Modo manual: baseado no campo "Gerar a cada X palavras/segundos"
                    const unit = unitSelect?.value || 'words';
                    const value = parseInt(wordsPerScene?.value || 50);
                    
                    if (unit === 'seconds') {
                        // Calcular baseado em segundos: assumir ~130 palavras por minuto de narração (2.17 palavras/segundo) - mais rigoroso
                        const wordsPerSecond = 2.17;
                        const wordsPerInterval = value * wordsPerSecond;
                        estimatedScenes = Math.max(1, Math.round(words / wordsPerInterval));
                    } else {
                        // Baseado em palavras
                        estimatedScenes = Math.max(1, Math.round(words / value));
                    }
                }
                
                estimateBox.textContent = `${estimatedScenes} cena${estimatedScenes !== 1 ? 's' : ''}`;
            }
            
            // Contador de palavras e cálculo de estimativa
            const sceneScriptText = document.getElementById('scene-script-text');
            const sceneWordCount = document.getElementById('scene-word-count');
            const sceneGenerationMode = document.getElementById('scene-generation-mode');
            const sceneWordsPerScene = document.getElementById('scene-words-per-scene');
            const manualModeSettings = document.getElementById('manual-mode-settings');
            
            if (sceneScriptText && sceneWordCount) {
                sceneScriptText.addEventListener('input', () => {
                    const text = sceneScriptText.value.trim();
                    const words = text.split(/\s+/).filter(Boolean).length;
                    sceneWordCount.textContent = `${words} palavras`;
                    calculateSceneEstimate();
                });
            }
            
            // Mostrar/esconder campo manual baseado no modo
            if (sceneGenerationMode && manualModeSettings) {
                sceneGenerationMode.addEventListener('change', () => {
                    if (sceneGenerationMode.value === 'manual') {
                        manualModeSettings.classList.remove('hidden');
                    } else {
                        manualModeSettings.classList.add('hidden');
                    }
                    calculateSceneEstimate();
                });
            }
            
            // Atualizar estimativa quando mudar palavras por cena
            if (sceneWordsPerScene) {
                sceneWordsPerScene.addEventListener('input', () => {
                    // Validar valor mínimo baseado na unidade
                    const unitSelect = document.getElementById('scene-unit-select');
                    const unit = unitSelect?.value || 'words';
                    const value = parseInt(sceneWordsPerScene.value);
                    
                    if (unit === 'seconds') {
                        if (value < 8) {
                            sceneWordsPerScene.value = 8;
                        }
                    } else {
                        if (value < 25) {
                            sceneWordsPerScene.value = 25;
                        }
                    }
                    
                    calculateSceneEstimate();
                });
            }
            
            // Atualizar validação quando a unidade mudar
            const sceneUnitSelect = document.getElementById('scene-unit-select');
            if (sceneUnitSelect) {
                sceneUnitSelect.addEventListener('change', () => {
                    const unit = sceneUnitSelect.value;
                    const value = parseInt(sceneWordsPerScene?.value || 50);
                    
                    // Ajustar valor mínimo e máximo baseado na unidade
                    if (unit === 'seconds') {
                        sceneWordsPerScene.min = 8;
                        sceneWordsPerScene.max = 300;
                        sceneWordsPerScene.step = 1;
                        if (value < 8) {
                            sceneWordsPerScene.value = 8;
                        }
                    } else {
                        sceneWordsPerScene.min = 25;
                        sceneWordsPerScene.max = 500;
                        sceneWordsPerScene.step = 5;
                        if (value < 25) {
                            sceneWordsPerScene.value = 25;
                        }
                    }
                    
                    calculateSceneEstimate();
                });
            }
            
            // Funções do modal de agentes
            window.openAgentModal = function() {
                const modal = document.getElementById('select-agent-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    loadAgentsList();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            };
            
            window.closeAgentModal = function() {
                const modal = document.getElementById('select-agent-modal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            };
            
            async function loadAgentsList() {
                const agentsList = document.getElementById('agents-list');
                if (!agentsList) return;
                
                try {
                    agentsList.innerHTML = '<p class="text-gray-400 text-center py-8">Carregando agentes...</p>';
                    
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        agentsList.innerHTML = '<p class="text-red-400 text-center py-8">Token não encontrado.</p>';
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/script-agents`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao carregar agentes');
                    }
                    
                    const data = await response.json();
                    const agents = data.agents || [];
                    
                    if (agents.length === 0) {
                        agentsList.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhum agente encontrado. Crie um agente primeiro.</p>';
                        return;
                    }
                    
                    // Para cada agente, buscar seus roteiros
                    const agentsWithScripts = await Promise.all(agents.map(async (agent) => {
                        try {
                            const scriptsResponse = await fetch(`${API_BASE}/api/scripts?agentId=${agent.id}&limit=10`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            
                            if (scriptsResponse.ok) {
                                const scriptsData = await scriptsResponse.json();
                                return {
                                    ...agent,
                                    scripts: scriptsData.scripts || []
                                };
                            }
                        } catch (e) {
                            console.error(`Erro ao buscar roteiros do agente ${agent.id}:`, e);
                        }
                        return { ...agent, scripts: [] };
                    }));
                    
                    agentsList.innerHTML = agentsWithScripts.map(agent => {
                        if (agent.scripts.length === 0) {
                            return `
                                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                    <h4 class="text-white font-semibold mb-1">${escapeHtml(agent.name || 'Agente sem nome')}</h4>
                                    <p class="text-gray-400 text-sm">Nenhum roteiro gerado ainda</p>
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                                <h4 class="text-white font-semibold mb-2">${escapeHtml(agent.name || 'Agente sem nome')}</h4>
                                <p class="text-gray-400 text-xs mb-3">${agent.scripts.length} roteiro(s) disponível(is)</p>
                                <div class="space-y-2">
                                    ${agent.scripts.map(script => `
                                        <button onclick="importScriptFromAgent(${script.id}, '${escapeHtml(script.title || 'Sem título')}')" 
                                                class="w-full text-left px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-gray-200 transition duration-200">
                                            <div class="font-medium">${escapeHtml(script.title || 'Roteiro sem título')}</div>
                                            <div class="text-xs text-gray-400 mt-1">${new Date(script.created_at).toLocaleString('pt-BR')}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (err) {
                    console.error('[Load Agents] Erro:', err);
                    agentsList.innerHTML = '<p class="text-red-400 text-center py-8">Erro ao carregar agentes.</p>';
                }
            }
            
            window.importScriptFromAgent = async function(scriptId, scriptTitle) {
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        showMessage('prompts-imagens-error-message', 'Token não encontrado.', true);
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/scripts/${scriptId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar roteiro');
                    }
                    
                    const data = await response.json();
                    if (sceneScriptText) {
                        sceneScriptText.value = data.script?.script_content || data.script?.content || '';
                        sceneScriptText.dispatchEvent(new Event('input'));
                    }
                    
                    closeAgentModal();
                    showMessage('prompts-imagens-success-message', `Roteiro "${scriptTitle}" importado com sucesso!`);
                    
                } catch (err) {
                    console.error('[Import Script] Erro:', err);
                    showMessage('prompts-imagens-error-message', err.message || 'Erro ao importar roteiro.', true);
                }
            };
            
            // Botão importar roteiro do agente
            const btnImportLastScript = document.getElementById('btn-import-last-script');
            if (btnImportLastScript) {
                btnImportLastScript.addEventListener('click', () => {
                    openAgentModal();
                });
            }
            
            // Botão detectar personagens
            const btnDetectCharacters = document.getElementById('btn-detect-characters');
            if (btnDetectCharacters) {
                btnDetectCharacters.addEventListener('click', async () => {
                    const script = sceneScriptText?.value.trim();
                    const charactersField = document.getElementById('scene-characters');
                    
                    if (!script) {
                        showMessage('prompts-imagens-error-message', 'Cole o roteiro primeiro para detectar personagens.', true);
                        return;
                    }
                    
                    try {
                        btnDetectCharacters.disabled = true;
                        btnDetectCharacters.textContent = 'Detectando...';
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            throw new Error('Token de autenticação não encontrado.');
                        }
                        
                        // Verificar se laozhang.ai está configurada como padrão
                        let useLaozhang = false;
                        try {
                            const settingsResponse = await fetch(`${API_BASE}/api/admin/app-settings`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (settingsResponse.ok) {
                                const settings = await settingsResponse.json();
                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                            }
                        } catch (err) {
                            console.warn('[Detect Characters] Erro ao verificar configuração laozhang.ai:', err);
                        }
                        
                        // Usar rota /laozhang se configurada como padrão
                        const endpoint = useLaozhang ? '/api/detect/characters/laozhang' : '/api/detect/characters';
                        console.log(`[Detect Characters] Usando endpoint: ${endpoint} (laozhang: ${useLaozhang})`);
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                script: script,
                                model: useLaozhang ? null : (document.getElementById('scene-model-select')?.value || 'gpt-4o'),
                                selectedModel: document.getElementById('scene-model-select')?.value || 'gpt-4o'
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.msg || 'Erro ao detectar personagens');
                        }
                        
                        const data = await response.json();
                        
                        if (charactersField && data.characters) {
                            charactersField.value = data.characters;
                            showMessage('prompts-imagens-success-message', data.msg || `${data.charactersList?.length || 0} personagem(ns) detectado(s)!`);
                        } else {
                            throw new Error('Nenhum personagem foi detectado.');
                        }
                        
                    } catch (err) {
                        console.error('[Detect Characters] Erro:', err);
                        showMessage('prompts-imagens-error-message', err.message || 'Erro ao detectar personagens.', true);
                    } finally {
                        btnDetectCharacters.disabled = false;
                        btnDetectCharacters.textContent = 'Detectar Personagens (IA)';
                    }
                });
            }
            
            // Carregar histórico ao abrir a view
            async function loadScenePromptsHistory() {
                const historyContainer = document.getElementById('scene-prompts-history');
                if (!historyContainer) return;
                
                try {
                    historyContainer.innerHTML = '<p class="text-gray-400">Carregando histórico...</p>';
                    
                    const token = localStorage.getItem('core_token');
                    if (!token) {
                        historyContainer.innerHTML = '<p class="text-gray-400">Faça login para ver o histórico.</p>';
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/api/scene-prompts/history`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.msg || 'Erro ao carregar histórico');
                    }
                    
                    const data = await response.json();
                    const history = data.history || [];
                    
                    if (history.length === 0) {
                        historyContainer.innerHTML = '<p class="text-gray-400">Nenhum prompt gerado ainda.</p>';
                        return;
                    }
                    
                    // Função para formatar nome do modelo (sem mostrar fornecedor)
                    const formatModelName = (model) => {
                        if (!model) return 'N/A';
                        // CRÍTICO: Remover qualquer referência a fornecedores de API
                        let cleanModel = String(model)
                            .replace(/laozhang\.ai/gi, '')
                            .replace(/laozhang/gi, '')
                            .replace(/openai/gi, '')
                            .replace(/anthropic/gi, '')
                            .replace(/google/gi, '')
                            .trim();
                        // Remover prefixos de fornecedores
                        cleanModel = cleanModel.replace(/^(laozhang-|claude-|gemini-|gpt-|openai-|anthropic-)/i, '');
                        cleanModel = cleanModel.replace(/-(laozhang|claude|gemini|gpt|openai|anthropic)$/i, '');
                        // Mapear para nomes amigáveis
                        if (cleanModel.includes('gpt-4o') || model.includes('gpt-4o')) return 'GPT-4o';
                        if (cleanModel.includes('claude-3-7-sonnet') || model.includes('claude-3-7-sonnet') || model.includes('sonnet-3-7')) return 'Claude 3.7 Sonnet';
                        if (cleanModel.includes('claude-sonnet-4') || model.includes('claude-sonnet-4') || model.includes('sonnet-4')) return 'Claude Sonnet 4';
                        if (cleanModel.includes('claude-opus-4') || model.includes('claude-opus-4') || model.includes('opus-4')) return 'Claude Opus 4';
                        if (cleanModel.includes('claude-3-5-haiku') || model.includes('claude-3-5-haiku') || model.includes('haiku-3-5')) return 'Claude 3.5 Haiku';
                        if (model.includes('claude-3-opus') || model.includes('opus-3')) return '3 Opus';
                        if (model.includes('gemini-2.5-pro') || model.includes('2.5-pro')) return '2.5 Pro';
                        if (model.includes('gemini-2.5-flash') || model.includes('2.5-flash')) return '2.5 Flash';
                        if (model.includes('gemini-2.0-flash') || model.includes('2.0-flash')) return '2.0 Flash';
                        if (model.includes('gpt-4o')) return 'GPT-4o';
                        if (model.includes('gpt-4o-mini')) return 'GPT-4o Mini';
                        if (model.includes('gpt-4-turbo')) return 'GPT-4 Turbo';
                        // Se ainda contém fornecedor, remover
                        return cleanModel.replace(/^(claude|gemini|gpt|laozhang)-/i, '');
                    };
                    
                    historyContainer.innerHTML = history.map(item => `
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h4 class="text-white font-semibold">${escapeHtml(item.title || 'Prompts sem título')}</h4>
                                    <p class="text-gray-400 text-sm">${item.scene_count || 0} cenas • ${new Date(item.created_at).toLocaleString('pt-BR')}</p>
                                    <p class="text-gray-500 text-xs mt-1">Estilo: ${escapeHtml(item.style || 'N/A')} • Modelo: ${escapeHtml(formatModelName(item.model))}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="loadScenePromptHistory(${item.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm">
                                        Carregar
                                    </button>
                                    <button onclick="deleteScenePromptHistory(${item.id})" class="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm">
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (err) {
                    console.error('[Load History] Erro:', err);
                    historyContainer.innerHTML = `<p class="text-red-400">Erro ao carregar histórico: ${escapeHtml(err.message || 'Erro desconhecido')}</p>`;
                }
            }
            
            // Funções globais para histórico
            window.loadScenePromptHistory = async function(historyId) {
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) return;
                    
                    const response = await fetch(`${API_BASE}/api/scene-prompts/history/${historyId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao carregar prompt');
                    }
                    
                    const data = await response.json();
                    scenePromptsData = data.scenes || [];
                    
                    // Preencher campos
                    if (sceneScriptText) sceneScriptText.value = data.script || '';
                    if (document.getElementById('scene-model-select')) document.getElementById('scene-model-select').value = data.model || 'gpt-4o';
                    if (document.getElementById('scene-style-select')) document.getElementById('scene-style-select').value = data.style || 'photorealistic';
                    
                    // Renderizar prompts
                    renderScenePrompts(scenePromptsData);
                    
                    // Mostrar seção de gerar imagens
                    const generateSection = document.getElementById('generate-all-images-section');
                    if (generateSection) {
                        generateSection.style.display = 'block';
                    }
                    
                    showMessage('prompts-imagens-success-message', 'Prompt carregado com sucesso!');
                    
                } catch (err) {
                    console.error('[Load Prompt] Erro:', err);
                    showMessage('prompts-imagens-error-message', err.message || 'Erro ao carregar prompt.', true);
                }
            };
            
            window.deleteScenePromptHistory = async function(historyId) {
                if (!confirm('Tem certeza que deseja excluir este prompt do histórico?')) return;
                
                try {
                    const token = localStorage.getItem('core_token');
                    if (!token) return;
                    
                    const response = await fetch(`${API_BASE}/api/scene-prompts/history/${historyId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao excluir prompt');
                    }
                    
                    loadScenePromptsHistory();
                    
                } catch (err) {
                    console.error('[Delete Prompt] Erro:', err);
                    showMessage('prompts-imagens-error-message', err.message || 'Erro ao excluir prompt.', true);
                }
            };
            
            // Carregar histórico quando a view for aberta
            const originalNavigateToView = window.navigateToView;
            if (typeof originalNavigateToView === 'function') {
                // Interceptar navegação para carregar histórico
                const navLinks = document.querySelectorAll('a[data-view="prompts-imagens"]');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        setTimeout(() => {
                            loadScenePromptsHistory();
                            calculateSceneEstimate();
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }, 500);
                    });
                });
            }
            
            // Inicializar ícones quando a página carregar
            if (typeof lucide !== 'undefined') {
                setTimeout(() => lucide.createIcons(), 1000);
            }
            
            // ============================================
            // 🖼️ SISTEMA DE GERAÇÃO DE IMAGENS (ESTILO DARKSCRIPT)
            // ============================================
            
            // Inicializar objeto de resultados de imagens
            if (!window.imageFxResults) {
                window.imageFxResults = { images: [], lastClearedImages: [] };
            }
            
            // Função para renderizar o grid de imagens (estilo DARKSCRIPT)
            window.renderImageFxOutput = function() {
                const output = document.getElementById('generated-images-output');
                const actionsContainer = document.getElementById('imagefx-actions');
                const clearBtn = document.getElementById('clear-all-images-btn');
                
                if (!output) return;
                
                const images = window.imageFxResults.images || [];
                
                if (images.length === 0) {
                    output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>';
                    if (actionsContainer) actionsContainer.style.display = 'none';
                } else {
                    output.innerHTML = `
                        ${images.map((img, index) => {
                            const isPending = img.status === 'pending' || img.status === 'retrying';
                            const isFailed = img.status === 'failed';
                            const isRetrying = img.status === 'retrying';
                            
                            const aspectRatioClass = {
                                '16:9': 'aspect-video',
                                '9:16': 'aspect-[9/16]',
                                '1:1': 'aspect-square'
                            }[img.aspectRatio || '16:9'] || 'aspect-video';
                            
                            if (isPending) {
                                return `
                                    <div id="image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 relative flex flex-col ${aspectRatioClass}">
                                        <div class="w-full h-full flex items-center justify-center bg-gray-700 rounded-lg animate-pulse">
                                            <div class="text-center">
                                                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <p class="mt-2 text-sm font-semibold text-gray-300">A gerar Cena ${img.sceneNumber || index + 1}...</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else if (isFailed) {
                                const errorMessage = escapeHtml(img.error || 'Erro desconhecido');
                                const truncatedMessage = errorMessage.length > 150 ? errorMessage.substring(0, 150) + '...' : errorMessage;
                                
                                const errorLower = errorMessage.toLowerCase();
                                const isPolicyError = errorLower.includes('bloqueado') || 
                                                     errorLower.includes('inseguro') || 
                                                     errorLower.includes('unsafe') ||
                                                     errorLower.includes('policy');
                                
                                let helpMessage = '';
                                if (isRetrying) {
                                    helpMessage = '<div class="bg-blue-900/20 border border-blue-700 rounded p-2 mb-3"><p class="text-xs text-blue-300"><strong>🔄 A processar...</strong><br>A sua imagem está a ser regenerada automaticamente. Por favor aguarde.</p></div>';
                                } else if (isPolicyError) {
                                    helpMessage = '<div class="bg-orange-900/20 border border-orange-700 rounded p-2 mb-3"><p class="text-xs text-orange-300"><strong>🛡️ Prompt bloqueado</strong><br>O prompt violou as políticas de conteúdo. A IA irá <strong>reescrever automaticamente</strong> mantendo o estilo e história.</p></div>';
                                } else {
                                    helpMessage = '<div class="bg-yellow-900/20 border border-yellow-700 rounded p-2 mb-3"><p class="text-xs text-yellow-300"><strong>⚠️ Erro detectado</strong><br>Esta imagem será <strong>regenerada automaticamente</strong> após a conclusão das outras.</p></div>';
                                }
                                
                                return `
                                    <div id="image-container-${index}" class="bg-red-900/20 border border-red-700 rounded-lg p-4 relative flex flex-col ${aspectRatioClass}">
                                        <h4 class="font-bold text-red-300 mb-2 flex items-center gap-2">
                                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                            ${isRetrying ? 'A Gerar Novamente Cena' : 'Erro na Cena'} ${img.sceneNumber || index + 1}
                                        </h4>
                                        <div class="flex-grow">
                                            ${helpMessage}
                                            <details class="text-xs">
                                                <summary class="cursor-pointer text-red-400 hover:text-red-300 mb-2">Ver detalhes técnicos</summary>
                                                <p class="text-red-300 mt-2 overflow-wrap-anywhere bg-red-950/30 p-2 rounded" title="${errorMessage}">${truncatedMessage}</p>
                                            </details>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-auto">
                                            <button class="toggle-prompt-btn text-sm bg-red-800 text-red-200 px-3 py-1 rounded-md hover:bg-red-700" data-img-index="${index}" ${isRetrying ? 'disabled' : ''}>
                                                ${isRetrying ? '⏳ Aguarde...' : 'Ver Prompt / Editar'}
                                            </button>
                                            <div id="edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Imagem gerada com sucesso
                                const rewrittenIndicator = img.wasRewritten ? '<span class="text-yellow-500 font-bold text-lg" title="Este prompt foi reescrito pela IA">⚠️</span>' : '';
                                return `
                                    <div id="image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 group relative flex flex-col">
                                        <div class="relative ${aspectRatioClass} w-full" data-img-index="${index}">
                                            <input type="checkbox" class="absolute top-2 right-2 h-5 w-5 z-30 image-select-checkbox" data-img-index="${index}">
                                            <span class="absolute top-2 left-2 text-white bg-black/50 rounded-full px-2 py-0.5 text-xs font-semibold z-20 flex items-center gap-1">Cena ${img.sceneNumber || index + 1} ${rewrittenIndicator}</span>
                                            <img src="${img.url || img.image || 'data:image/png;base64,' + img.base64}" alt="Cena ${img.sceneNumber || index + 1}" class="w-full h-full rounded-lg object-cover image-lightbox-trigger cursor-pointer" data-img-index="${index}" data-img-url="${img.url || img.image || 'data:image/png;base64,' + img.base64}" data-img-scene="${img.sceneNumber || index + 1}">
                                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-4 gap-2 pointer-events-none">
                                                <button class="download-single-image-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg pointer-events-auto z-10" data-img-url="${img.url || ''}" data-img-base64="${img.base64 || ''}" data-img-scene="${img.sceneNumber || index + 1}">
                                                    Baixar Imagem
                                                </button>
                                                <button class="batch-animate-image-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg pointer-events-auto z-10" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}">
                                                    Animar (Parallax)
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-2">
                                            <button class="toggle-prompt-btn text-sm bg-gray-700 text-gray-200 px-3 py-1 rounded-md hover:bg-gray-600" data-img-index="${index}">
                                                Ver Prompt / Editar
                                            </button>
                                            <div id="edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    `;
                    if (actionsContainer) actionsContainer.style.display = 'block';
                }
                
                if (clearBtn && images.length > 0) {
                    clearBtn.style.display = 'block';
                } else if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
                
                // Configurar event listeners
                setupImageGeneratorEventListeners();
                
                // Configurar lightbox (apenas uma vez)
                if (!window._lightboxInitialized) {
                    setupImageLightbox();
                    window._lightboxInitialized = true;
                }
                
                // Atualizar ícones
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            };
            
            // Função para configurar lightbox de imagens
            function setupImageLightbox() {
                // Remover listeners antigos se existirem
                if (window._lightboxImageClickHandler) {
                    document.removeEventListener('click', window._lightboxImageClickHandler, true);
                }
                
                // Garantir que o lightbox esteja fora de views ocultas
                function ensureGlobalLightbox() {
                    const lb = document.getElementById('image-lightbox');
                    if (!lb) return;
                    const parentView = lb.closest('[id^="view-"]');
                    if (parentView && parentView.style.display === 'none') {
                        document.body.appendChild(lb);
                    }
                }

                // Usar event delegation para funcionar com imagens dinâmicas
                window._lightboxImageClickHandler = (e) => {
                    // Verificar se o clique foi diretamente na imagem ou no container
                    const imgElement = e.target.classList.contains('image-lightbox-trigger') 
                        ? e.target 
                        : e.target.closest('.image-lightbox-trigger');
                    
                    if (!imgElement) return;
                    
                    // Não abrir se clicou no botão de download, checkbox ou qualquer botão
                    if (e.target.closest('.download-single-image-btn') || 
                        e.target.closest('.image-select-checkbox') ||
                        e.target.tagName === 'BUTTON' ||
                        e.target.closest('button')) {
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const imgIndex = parseInt(imgElement.dataset.imgIndex);
                    const allImageTriggers = Array.from(document.querySelectorAll('.image-lightbox-trigger'));
                    
                    // Filtrar apenas imagens com sucesso (que têm URL válida)
                    const validImages = allImageTriggers.filter(img => {
                        const url = img.dataset.imgUrl || img.src;
                        return url && 
                               url !== '' && 
                               !url.includes('data:image/svg') &&
                               (url.startsWith('data:image/') || url.startsWith('http'));
                    });
                    
                    if (validImages.length === 0) {
                        console.warn('[Lightbox] Nenhuma imagem válida encontrada');
                        return;
                    }
                    
                    const allImages = validImages.map((img, idx) => ({
                        index: idx,
                        url: img.dataset.imgUrl || img.src,
                        scene: img.dataset.imgScene || (idx + 1)
                    }));
                    
                    let currentImageIndex = validImages.findIndex(img => parseInt(img.dataset.imgIndex) === imgIndex);
                    if (currentImageIndex === -1) currentImageIndex = 0;
                    
                    console.log('[Lightbox] Abrindo imagem', currentImageIndex + 1, 'de', allImages.length);
                    openLightbox(currentImageIndex, allImages);
                };
                
                // Usar capture phase para garantir que captura o clique antes de outros handlers
                document.addEventListener('click', window._lightboxImageClickHandler, true);
                
                // Variáveis globais para o lightbox
                window._lightboxImages = [];
                window._lightboxCurrentIndex = 0;
                
                function openLightbox(index, images) {
                    if (!images || images.length === 0) return;
                    ensureGlobalLightbox();
                    
                    window._lightboxImages = images;
                    window._lightboxCurrentIndex = index;
                    
                    const lightbox = document.getElementById('image-lightbox');
                    const lightboxImage = document.getElementById('lightbox-image');
                    const lightboxCounter = document.getElementById('lightbox-counter');
                    const lightboxInfo = document.getElementById('lightbox-info');
                    
                    if (!lightbox || !lightboxImage) return;
                    
                    const currentImage = images[index];
                    
                    // Limpar src anterior para forçar reload
                    lightboxImage.src = '';
                    setTimeout(() => {
                        lightboxImage.src = currentImage.url;
                    }, 10);
                    
                    if (lightboxCounter) lightboxCounter.textContent = `${index + 1} / ${images.length}`;
                    if (lightboxInfo) lightboxInfo.textContent = `Cena ${currentImage.scene}`;
                    
                    lightbox.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevenir scroll do body
                
                    // Atualizar botões de navegação
                    const prevBtn = document.getElementById('lightbox-prev');
                    const nextBtn = document.getElementById('lightbox-next');
                    
                    if (prevBtn) prevBtn.style.display = images.length > 1 ? 'flex' : 'none';
                    if (nextBtn) nextBtn.style.display = images.length > 1 ? 'flex' : 'none';
                    
                    // Atualizar ícones
                    if (typeof lucide !== 'undefined') {
                        setTimeout(() => lucide.createIcons(), 100);
                    }
                }
                
                function closeLightbox() {
                    const lightbox = document.getElementById('image-lightbox');
                    if (lightbox) {
                        lightbox.classList.add('hidden');
                        document.body.style.overflow = ''; // Restaurar scroll
                    }
                }
                
                function navigateLightbox(direction) {
                    if (!window._lightboxImages || window._lightboxImages.length === 0) return;
                    
                    if (direction === 'prev') {
                        window._lightboxCurrentIndex = (window._lightboxCurrentIndex - 1 + window._lightboxImages.length) % window._lightboxImages.length;
                    } else {
                        window._lightboxCurrentIndex = (window._lightboxCurrentIndex + 1) % window._lightboxImages.length;
                    }
                    
                    openLightbox(window._lightboxCurrentIndex, window._lightboxImages);
                }
                
                // Event listeners
                const closeBtn = document.getElementById('lightbox-close');
                const prevBtn = document.getElementById('lightbox-prev');
                const nextBtn = document.getElementById('lightbox-next');
                const lightbox = document.getElementById('image-lightbox');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeLightbox);
                }
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => navigateLightbox('prev'));
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => navigateLightbox('next'));
                }
                
                // Fechar com ESC e navegação com setas (apenas uma vez)
                if (!window._lightboxKeyHandler) {
                    window._lightboxKeyHandler = (e) => {
                        if (!lightbox || lightbox.classList.contains('hidden')) return;
                        
                        if (e.key === 'Escape') {
                            closeLightbox();
                        } else if (e.key === 'ArrowLeft') {
                            navigateLightbox('prev');
                        } else if (e.key === 'ArrowRight') {
                            navigateLightbox('next');
                        }
                    };
                    
                    document.addEventListener('keydown', window._lightboxKeyHandler);
                }
                
                // Fechar ao clicar no fundo (apenas uma vez)
                if (lightbox && !window._lightboxClickHandler) {
                    lightbox.addEventListener('click', (e) => {
                        if (e.target === lightbox || e.target.id === 'image-lightbox') {
                            closeLightbox();
                        }
                    });
                    window._lightboxClickHandler = true;
                }

                // Expor funções para uso externo (ex.: grid de imagens em lote)
                window._lbOpen = openLightbox;
                window._lbClose = closeLightbox;
                window._lbNavigate = navigateLightbox;
            }
            
            // Função para renderizar progresso (estilo DARKSCRIPT)
            window.renderImageGenerationProgress = function(status) {
                const panel = document.getElementById('image-gen-progress-panel');
                if (!panel) return;
                
                if (!status || !status.active) {
                    panel.style.display = 'none';
                    return;
                }
                
                panel.style.display = 'block';
                const { current, total, message } = status;
                const progress = total > 0 ? Math.round((current / total) * 100) : 0;
                const isComplete = current === total;
                
                let title, titleColor;
                if (isComplete) {
                    title = 'Geração Concluída';
                    titleColor = 'text-green-400';
                } else {
                    title = 'A gerar imagens...';
                    titleColor = 'text-blue-400';
                }
                
                panel.innerHTML = `
                    <h4 class="font-bold text-sm mb-2 ${titleColor} flex items-center justify-between">
                        ${title}
                        <button id="cancel-image-gen-btn" class="text-gray-400 hover:text-gray-200">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </h4>
                    <p class="text-xs text-gray-300 mb-2 truncate" title="${escapeHtml(message || '')}">${escapeHtml(message || '')}</p>
                    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                        <div class="h-2 rounded-full transition-all duration-300 ${isComplete ? 'bg-green-500' : 'bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500'}" style="width: ${progress}%; background-size: 200% 100%; animation: ${isComplete ? 'none' : 'shimmer 2s infinite'};"></div>
                    </div>
                    <p class="text-right text-xs text-gray-400 mt-1">${progress}% (${current}/${total})</p>
                `;
                
                // Botão cancelar
                const cancelBtn = document.getElementById('cancel-image-gen-btn');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        if (window.appState) {
                            window.appState.imageGenStatus = { ...window.appState.imageGenStatus, cancelled: true };
                        }
                        panel.style.display = 'none';
                    };
                }
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            };
            
            // Variável global para armazenar prompts do TXT
            let batchPromptsFromTxt = [];
            
            // Função para processar arquivo TXT
            async function processBatchTxtFile(file) {
                if (!file) {
                    console.warn('[Batch Upload] Nenhum arquivo fornecido');
                    showMessage('imagens-lote-error-message', 'Nenhum arquivo fornecido.', true);
                    return;
                }
                
                console.log('[Batch Upload] Processando arquivo:', file.name, 'Tipo:', file.type, 'Tamanho:', file.size);
                
                // Validar extensão e tipo (mais flexível)
                const isValidTxt = file.name.toLowerCase().endsWith('.txt') || 
                                  file.type === 'text/plain' || 
                                  file.type === '' || // Alguns navegadores não retornam tipo para TXT
                                  file.type === 'application/octet-stream'; // Fallback para alguns sistemas
                
                if (!isValidTxt) {
                    showMessage('imagens-lote-error-message', 'Por favor, selecione um arquivo TXT (.txt).', true);
                    return;
                }
                
                // Validar tamanho (máximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('imagens-lote-error-message', 'Arquivo muito grande. O tamanho máximo é 5MB.', true);
                    return;
                }
                
                try {
                    const text = await file.text();
                    console.log('[Batch Upload] Arquivo lido, tamanho:', text.length, 'caracteres');
                    
                    if (!text || text.trim().length === 0) {
                        showMessage('imagens-lote-error-message', 'O arquivo TXT está vazio.', true);
                        return;
                    }
                    
                    const textarea = document.getElementById('batch-image-prompts-textarea');
                    if (textarea) {
                        textarea.value = text;
                        // Disparar evento input para atualizar contagem
                        textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    
                    parsePromptsFromText(text);
                    
                    const promptCount = batchPromptsFromTxt.length;
                    if (promptCount > 0) {
                        showMessage('imagens-lote-success-message', `Arquivo "${file.name}" carregado com sucesso! ${promptCount} prompt${promptCount !== 1 ? 's' : ''} encontrado${promptCount !== 1 ? 's' : ''}.`, false);
                    } else {
                        showMessage('imagens-lote-error-message', 'Nenhum prompt válido encontrado no arquivo. Verifique se há pelo menos uma linha com conteúdo.', true);
                    }
                } catch (err) {
                    console.error('[Upload TXT] Erro:', err);
                    showMessage('imagens-lote-error-message', 'Erro ao ler arquivo TXT: ' + (err.message || 'Erro desconhecido'), true);
                }
            }
            
            // Configurar upload de TXT para prompts em lote
            // Flag para evitar múltiplas inicializações
            let batchTxtUploadInitialized = false;
            
            function setupBatchTxtUpload() {
                // Evitar múltiplas inicializações
                if (batchTxtUploadInitialized) {
                    console.log('[Batch Upload] Já inicializado, pulando...');
                    return;
                }
                
                console.log('[Batch Upload] Inicializando setupBatchTxtUpload...');
                
                const uploadBtn = document.getElementById('batch-upload-txt-btn');
                const txtInput = document.getElementById('batch-txt-file-input');
                const textarea = document.getElementById('batch-image-prompts-textarea');
                const dropZone = document.getElementById('batch-drop-zone');
                const promptsCountDisplay = document.getElementById('batch-prompts-count-display');
                const generateBtn = document.getElementById('batch-btn-generate-images');
                
                console.log('[Batch Upload] Elementos encontrados:', {
                    uploadBtn: !!uploadBtn,
                    txtInput: !!txtInput,
                    textarea: !!textarea,
                    dropZone: !!dropZone,
                    generateBtn: !!generateBtn
                });
                
                // Verificar se todos os elementos necessários existem
                if (!uploadBtn || !txtInput || !textarea || !generateBtn) {
                    console.error('[Batch Upload] Elementos essenciais não encontrados!');
                    return;
                }
                
                // Configurar botão de upload
                uploadBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[Batch Upload] Botão Upload TXT clicado');
                    txtInput.click();
                };
                
                // Configurar input de arquivo
                txtInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    console.log('[Batch Upload] Arquivo selecionado:', file ? file.name : 'nenhum');
                    if (file) {
                        await processBatchTxtFile(file);
                    }
                    // Limpar input para permitir selecionar o mesmo arquivo novamente
                    e.target.value = '';
                };
                
                // Recriar ícones do Lucide
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 50);
                }
                
                batchTxtUploadInitialized = true;
                
                // Configurar drag and drop
                const textareaContainer = document.getElementById('batch-textarea-container') || (textarea ? textarea.closest('.relative') : null);
                
                if (textareaContainer && dropZone) {
                    let isDragging = false;
                    
                    // Prevenir comportamento padrão em todos os eventos de drag
                    const preventDefaults = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    };
                    
                    // Função para mostrar área de drop
                    const showDropZone = () => {
                        if (!isDragging) {
                            isDragging = true;
                            dropZone.classList.remove('opacity-0');
                            dropZone.classList.add('opacity-100');
                            dropZone.style.pointerEvents = 'auto';
                            if (textarea) {
                                textarea.style.borderColor = '#3b82f6'; // Azul para indicar área de drop
                                textarea.style.borderWidth = '2px';
                            }
                        }
                    };
                    
                    // Função para esconder área de drop
                    const hideDropZone = () => {
                        isDragging = false;
                        dropZone.classList.remove('opacity-100');
                        dropZone.classList.add('opacity-0');
                        dropZone.style.pointerEvents = 'none';
                        if (textarea) {
                            textarea.style.borderColor = '';
                            textarea.style.borderWidth = '';
                        }
                    };
                    
                    // Adicionar eventos no container
                    textareaContainer.addEventListener('dragenter', (e) => {
                        preventDefaults(e);
                        showDropZone();
                    });
                    
                    textareaContainer.addEventListener('dragover', (e) => {
                        preventDefaults(e);
                        e.dataTransfer.dropEffect = 'copy'; // Mostrar cursor de cópia
                        showDropZone();
                    });
                    
                    textareaContainer.addEventListener('dragleave', (e) => {
                        preventDefaults(e);
                        // Verificar se realmente saiu do container (não apenas de um elemento filho)
                        const rect = textareaContainer.getBoundingClientRect();
                        const x = e.clientX;
                        const y = e.clientY;
                        
                        // Se o mouse saiu dos limites do container, esconder
                        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                            hideDropZone();
                        }
                    });
                    
                    // Processar arquivo quando soltar
                    textareaContainer.addEventListener('drop', async (e) => {
                        preventDefaults(e);
                        hideDropZone();
                        
                        const files = e.dataTransfer.files;
                        console.log('[Batch Upload] Drop detectado, arquivos:', files.length);
                        if (files && files.length > 0) {
                            const file = files[0];
                            console.log('[Batch Upload] Processando arquivo do drop:', file.name, 'Tipo:', file.type);
                            
                            // Validar se é arquivo TXT
                            if (!file.name.endsWith('.txt') && file.type !== 'text/plain' && file.type !== '') {
                                showMessage('imagens-lote-error-message', 'Por favor, solte apenas arquivos TXT.', true);
                                return;
                            }
                            
                            await processBatchTxtFile(file);
                        } else {
                            console.warn('[Batch Upload] Nenhum arquivo encontrado no drop');
                            showMessage('imagens-lote-error-message', 'Nenhum arquivo foi solto. Por favor, arraste um arquivo TXT.', true);
                        }
                    });
                    
                    // Também adicionar no textarea e dropZone para garantir que funcione
                    [textarea, dropZone].forEach(element => {
                        if (element) {
                            element.addEventListener('dragenter', preventDefaults);
                            element.addEventListener('dragover', preventDefaults);
                            element.addEventListener('drop', preventDefaults);
                        }
                    });
                }
                
                // Atualizar contagem quando o texto mudar
                textarea.oninput = () => {
                    parsePromptsFromText(textarea.value);
                };
                
                // Botão de gerar imagens em lote
                generateBtn.onclick = async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[Batch Generate] Botão Gerar Todas as Imagens clicado');
                    console.log('[Batch Generate] Prompts disponíveis:', batchPromptsFromTxt.length);
                    
                    if (batchPromptsFromTxt.length === 0) {
                        showMessage('imagens-lote-error-message', 'Adicione prompts primeiro! Cole no campo de texto ou faça upload de um arquivo TXT.', true);
                        return;
                    }
                    
                    // Usar a função existente de geração em lote
                    await generateBatchImagesFromPrompts(batchPromptsFromTxt);
                };
                
                console.log('[Batch Generate] Event listener adicionado ao botão de gerar');
                
                // Botões de ação para imagens em lote
                const selectAllBtn = document.getElementById('batch-select-all-images-btn');
                const deselectAllBtn = document.getElementById('batch-deselect-all-images-btn');
                const downloadSelectedBtn = document.getElementById('batch-download-selected-images-btn');
                const clearAllBtn = document.getElementById('batch-clear-all-images-btn');
                
                if (selectAllBtn) {
                    selectAllBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        checkboxes.forEach(cb => cb.checked = true);
                    };
                }
                
                if (deselectAllBtn) {
                    deselectAllBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        checkboxes.forEach(cb => cb.checked = false);
                    };
                }
                
                if (downloadSelectedBtn) {
                    downloadSelectedBtn.onclick = async () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox:checked');
                        if (checkboxes.length === 0) {
                            showMessage('imagens-lote-error-message', 'Selecione pelo menos uma imagem para baixar.', true);
                            return;
                        }
                        
                        for (const checkbox of checkboxes) {
                            const imgIndex = parseInt(checkbox.dataset.imgIndex);
                            const imgCard = checkbox.closest('.image-card');
                            const img = imgCard?.querySelector('img');
                            if (img && img.src) {
                                const a = document.createElement('a');
                                a.href = img.src;
                                a.download = `imagem-cena-${imgIndex}.png`;
                                a.click();
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                        }
                    };
                }
                
                if (clearAllBtn) {
                    clearAllBtn.onclick = () => {
                        if (confirm('Tem certeza que deseja limpar todas as imagens geradas?')) {
                            const output = document.getElementById('batch-generated-images-output');
                            if (output) {
                                output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>';
                            }
                            const actions = document.getElementById('batch-imagefx-actions');
                            if (actions) actions.style.display = 'none';
                            batchPromptsFromTxt = [];
                            updatePromptsCount(0);
                        }
                    };
                }
                
                // Event listeners dos modais
                const batchCloseModalBtn = document.getElementById('batch-close-image-gen-modal-btn');
                const batchViewImagesBtn = document.getElementById('batch-view-generated-images-btn');
                
                if (batchCloseModalBtn) {
                    batchCloseModalBtn.onclick = () => {
                        document.getElementById('batch-image-gen-complete-modal')?.classList.add('hidden');
                    };
                }
                
                if (batchViewImagesBtn) {
                    batchViewImagesBtn.onclick = () => {
                        document.getElementById('batch-image-gen-complete-modal')?.classList.add('hidden');
                        // Scroll para o grid de imagens
                        const output = document.getElementById('batch-generated-images-output');
                        if (output) {
                            output.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    };
                }
                
                console.log('[Batch Upload] Setup concluído com sucesso!');
            }
            
            // Parsear prompts do texto (um por linha)
            function parsePromptsFromText(text) {
                if (!text || !text.trim()) {
                    batchPromptsFromTxt = [];
                    updatePromptsCount(0);
                    return;
                }
                
                // Dividir por linhas e processar
                const lines = text.split(/\r?\n/)
                    .map(line => line.trim())
                    .filter(line => {
                        const trimmed = line.trim();
                        // Filtrar linhas vazias e comentários, mas manter linhas que começam com "CENA X:" se tiverem conteúdo
                        if (trimmed.length === 0) return false;
                        if (trimmed.startsWith('//') || trimmed.startsWith('#')) return false;
                        if (trimmed.toLowerCase().startsWith('prompts de cena gerados')) return false;
                        if (trimmed.toLowerCase().startsWith('data:')) return false;
                        if (trimmed.toLowerCase().startsWith('total de cenas:')) return false;
                        // Se começar com "CENA X:" mas tiver menos de 20 caracteres, provavelmente é só o cabeçalho
                        if (trimmed.match(/^cena \d+:\s*$/i)) return false;
                        return true;
                    });
                
                console.log('[Batch Parse] Linhas processadas:', lines.length);
                
                batchPromptsFromTxt = lines.map((line, index) => {
                    // Remover prefixo "CENA X:" se existir, mas manter o resto do conteúdo
                    const cleanLine = line.replace(/^CENA \d+:\s*/i, '').trim();
                    return {
                        scene_number: index + 1,
                        prompt_text: cleanLine,
                        style: document.getElementById('batch-image-style-select')?.value || 'photorealistic'
                    };
                });
                
                console.log('[Batch Parse] Prompts parseados:', batchPromptsFromTxt.length);
                updatePromptsCount(batchPromptsFromTxt.length);
            }
            
            // Atualizar contagem de prompts
            function updatePromptsCount(count) {
                const promptsCountDisplay = document.getElementById('batch-prompts-count-display');
                if (promptsCountDisplay) {
                    promptsCountDisplay.textContent = `${count} prompt${count !== 1 ? 's' : ''}`;
                }
            }
            
            // Gerar imagens em lote a partir dos prompts do TXT (igual a Prompts e Imagens)
            async function generateBatchImagesFromPrompts(prompts) {
                if (prompts.length === 0) {
                    showMessage('imagens-lote-error-message', 'Nenhum prompt encontrado!', true);
                    return;
                }
                
                try {
                    const token = safeLocalStorageGet('core_token');
                    if (!token) {
                        throw new Error('Token de autenticação não encontrado.');
                    }
                    
                    const style = document.getElementById('batch-image-style-select')?.value || 'photorealistic';
                    
                    // Mostrar modal de confirmação
                    const confirmModal = document.getElementById('batch-confirm-generation-modal');
                    const confirmMessage = document.getElementById('batch-confirm-modal-message');
                    const confirmCount = document.getElementById('batch-confirm-modal-count');
                    const confirmBtn = document.getElementById('batch-confirm-modal-confirm');
                    const cancelBtn = document.getElementById('batch-confirm-modal-cancel');
                    
                    if (confirmModal && confirmMessage && confirmCount) {
                        confirmCount.textContent = `${prompts.length} imagem${prompts.length !== 1 ? 'ns' : ''}`;
                        confirmMessage.textContent = `Você está prestes a gerar ${prompts.length} imagem${prompts.length !== 1 ? 'ns' : ''} em lote.`;
                        
                        if (typeof lucide !== 'undefined') {
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                        
                        confirmModal.classList.remove('hidden');
                        
                        const userConfirmed = await new Promise((resolve) => {
                            const handleConfirm = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(true);
                            };
                            
                            const handleCancel = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(false);
                            };
                            
                            confirmBtn.addEventListener('click', handleConfirm);
                            cancelBtn.addEventListener('click', handleCancel);
                            
                            const handleEsc = (e) => {
                                if (e.key === 'Escape') {
                                    document.removeEventListener('keydown', handleEsc);
                                    handleCancel();
                                }
                            };
                            document.addEventListener('keydown', handleEsc);
                        });
                        
                        if (!userConfirmed) return;
                    }
                    
                    // Limpar grid anterior
                    const output = document.getElementById('batch-generated-images-output');
                    if (output) {
                        output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Gerando imagens...</p>';
                    }
                    
                    // Inicializar resultados (IGUAL a window.imageFxResults)
                    if (!window.batchImageFxResults) {
                        window.batchImageFxResults = { images: [], lastClearedImages: [] };
                    }
                    window.batchImageFxResults.images = new Array(prompts.length).fill(null);
                    
                    // Inicializar status de geração
                    window.appState.imageGenStatus = {
                        active: true,
                        current: 0,
                        total: prompts.length,
                        message: 'Iniciando geração...',
                        cancelled: false
                    };
                    
                    // Mostrar e renderizar painel de progresso
                    const batchProgressPanel = document.getElementById('batch-image-gen-progress-panel');
                    if (batchProgressPanel) {
                        batchProgressPanel.style.display = 'block';
                    }
                    updateBatchProgressPanel();
                    
                    // Preparar tasks para geração (todas de uma vez)
                    const tasks = prompts.map((prompt, index) => ({
                        index: index,
                        prompt: prompt.prompt_text,
                        sceneNumber: prompt.scene_number || index + 1,
                        style: style
                    }));
                    
                    let completed = 0;
                    const totalPrompts = prompts.length;
                    
                    // Função para processar cada task
                    const processTask = async (task) => {
                        if (window.appState.imageGenStatus.cancelled) return;
                        
                        const currentImageIndex = task.index;
                        const currentPrompt = task.prompt;
                        const currentSceneNumber = task.sceneNumber;
                        
                        try {
                            // Chamar API de geração de imagem
                            const response = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    prompt: currentPrompt,
                                    style: style,
                                    aspectRatio: '16:9'
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.msg || 'Erro ao gerar imagem');
                            }
                            
                            const data = await response.json();
                            
                            if (data.image || data.base64 || data.imageUrl) {
                                const base64 = data.base64 || data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null);
                                const url = data.imageUrl || `data:image/png;base64,${base64}`;
                                
                                window.batchImageFxResults.images[currentImageIndex] = {
                                    status: 'success',
                                    url: url,
                                    base64: base64,
                                    prompt: data.prompt || currentPrompt,
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9',
                                    wasRewritten: data.wasRewritten || false
                                };
                            } else {
                                throw new Error('A API retornou uma resposta vazia.');
                            }
                            
                            completed++;
                            window.appState.imageGenStatus.current = completed;
                            window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                            updateBatchProgressPanel();
                            renderBatchImageFxOutput();
                            
                        } catch (error) {
                            console.error(`Erro na geração ImageFX para cena ${currentSceneNumber}:`, error);
                            const userFriendlyMessage = error.message || 'Erro desconhecido.';
                            const errorLower = userFriendlyMessage.toLowerCase();
                            
                            // Verificar se é erro de throttling (429)
                            const isThrottleError = errorLower.includes('throttled') || 
                                                   errorLower.includes('429') ||
                                                   errorLower.includes('limite de requisições') ||
                                                   errorLower.includes('rate limit');
                            
                            // Verificar se é erro de política (bloqueado)
                            const isPolicyError = errorLower.includes('bloqueado') || 
                                                 errorLower.includes('conteúdo inseguro') || 
                                                 errorLower.includes('conteudo inseguro') ||
                                                 errorLower.includes('unsafe') ||
                                                 errorLower.includes('policy');
                            
                            // Se for erro de throttling, aguardar e tentar novamente
                            if (isThrottleError) {
                                window.batchImageFxResults.images[currentImageIndex] = {
                                    status: 'retrying',
                                    prompt: currentPrompt,
                                    error: 'Limite de requisições atingido. Aguardando e tentando novamente...',
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9'
                                };
                                renderBatchImageFxOutput();
                                
                                // Aguardar 5-10 segundos antes de tentar novamente
                                await new Promise(resolve => setTimeout(resolve, 5000 + Math.random() * 5000));
                                
                                // Tentar gerar novamente
                                try {
                                    const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            prompt: currentPrompt,
                                            style: style,
                                            aspectRatio: '16:9'
                                        })
                                    });
                                    
                                    if (retryResponse.ok) {
                                        const retryData = await retryResponse.json();
                                        const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                        const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                        
                                        if (base64 || retryData.image || retryData.imageUrl) {
                                            window.batchImageFxResults.images[currentImageIndex] = {
                                                status: 'success',
                                                url: url,
                                                base64: base64,
                                                prompt: currentPrompt,
                                                sceneNumber: currentSceneNumber,
                                                aspectRatio: '16:9'
                                            };
                                            completed++;
                                            window.appState.imageGenStatus.current = completed;
                                            window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                            updateBatchProgressPanel();
                                            renderBatchImageFxOutput();
                                            return;
                                        }
                                    }
                                } catch (retryErr) {
                                    console.warn(`[Retry Throttle] Erro ao tentar novamente após throttling para cena ${currentSceneNumber}:`, retryErr);
                                }
                            }
                            
                            if (isPolicyError) {
                                // Marcar como retrying e tentar reescrever automaticamente
                                window.batchImageFxResults.images[currentImageIndex] = {
                                    status: 'retrying',
                                    prompt: currentPrompt,
                                    error: 'Prompt bloqueado. Reescrevendo automaticamente...',
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9'
                                };
                                renderBatchImageFxOutput();
                                
                                // Tentar reescrever o prompt usando IA
                                try {
                                    // Verificar se laozhang.ai está configurada como padrão
                                    let useLaozhang = false;
                                    try {
                                        const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                            headers: { 'Authorization': `Bearer ${token}` }
                                        });
                                        if (settingsResponse.ok) {
                                            const settings = await settingsResponse.json();
                                            useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                                        }
                                    } catch (err) {
                                        console.warn('[Rewrite Prompt] Erro ao verificar configuração laozhang.ai:', err);
                                    }
                                    
                                    const endpoint = useLaozhang ? '/api/rewrite/blocked-prompt/laozhang' : '/api/rewrite/blocked-prompt';
                                    const selectedModel = 'gpt-4o'; // Modelo padrão para reescrita
                                    
                                    const rewriteResponse = await fetch(`${API_BASE}${endpoint}`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            prompt: currentPrompt,
                                            model: useLaozhang ? null : selectedModel,
                                            selectedModel: selectedModel
                                        })
                                    });
                                    
                                    if (rewriteResponse.ok) {
                                        const rewriteData = await rewriteResponse.json();
                                        const rewrittenPrompt = rewriteData.rewrittenPrompt || currentPrompt;
                                        
                                        // Atualizar status
                                        window.batchImageFxResults.images[currentImageIndex] = {
                                            ...window.batchImageFxResults.images[currentImageIndex],
                                            error: 'Gerando com prompt reescrito...'
                                        };
                                        renderBatchImageFxOutput();
                                        
                                        // Aguardar antes de tentar novamente
                                        await new Promise(resolve => setTimeout(resolve, 2000));
                                        
                                        // Tentar gerar novamente com prompt reescrito
                                        const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({
                                                prompt: rewrittenPrompt,
                                                style: style,
                                                aspectRatio: '16:9'
                                            })
                                        });
                                        
                                        if (retryResponse.ok) {
                                            const retryData = await retryResponse.json();
                                            const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                            const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                            
                                            if (base64 || retryData.image || retryData.imageUrl) {
                                                window.batchImageFxResults.images[currentImageIndex] = {
                                                    status: 'success',
                                                    url: url,
                                                    base64: base64,
                                                    prompt: rewrittenPrompt,
                                                    sceneNumber: currentSceneNumber,
                                                    aspectRatio: '16:9',
                                                    wasRewritten: true,
                                                    originalPrompt: currentPrompt
                                                };
                                                completed++;
                                                window.appState.imageGenStatus.current = completed;
                                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                                updateBatchProgressPanel();
                                                renderBatchImageFxOutput();
                                                return;
                                            }
                                        }
                                    }
                                } catch (rewriteErr) {
                                    console.warn(`[Retry] Erro ao reescrever prompt para cena ${currentSceneNumber}:`, rewriteErr);
                                }
                            }
                            
                            // Se chegou aqui, falhou mesmo após retry
                            window.batchImageFxResults.images[currentImageIndex] = {
                                status: 'failed',
                                prompt: currentPrompt,
                                error: userFriendlyMessage,
                                sceneNumber: currentSceneNumber,
                                aspectRatio: '16:9'
                            };
                            
                            completed++;
                            window.appState.imageGenStatus.current = completed;
                            window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                            updateBatchProgressPanel();
                            renderBatchImageFxOutput();
                        }
                    };
                    
                    // Executar em paralelo (3 por vez)
                    await runTasksWithConcurrency(tasks, 3, processTask);
                    
                    if (window.appState.imageGenStatus.cancelled) {
                        window.appState.imageGenStatus.active = false;
                        window.appState.imageGenStatus.message = 'Geração cancelada pelo usuário.';
                        updateBatchProgressPanel();
                        showMessage('imagens-lote-success-message', 'Geração cancelada pelo usuário.');
                        return;
                    }
                    
                    // Processar imagens com erro automaticamente (retry em paralelo, 3 por vez)
                    let retryAttempt = 0;
                    const maxRetryAttempts = 5;
                    
                    while (retryAttempt < maxRetryAttempts) {
                        const failedImages = window.batchImageFxResults.images
                            .map((img, idx) => ({ ...img, originalIndex: idx }))
                            .filter(img => img && img.status === 'failed');
                        
                        if (failedImages.length === 0) break;
                        
                        retryAttempt++;
                        window.appState.imageGenStatus.message = `Tentativa ${retryAttempt}: Regenerando ${failedImages.length} imagem(ns) com erro...`;
                        updateBatchProgressPanel();
                        
                        // Processar falhas em paralelo (3 por vez)
                        const retryTasks = failedImages.map(failedImg => ({
                            img: failedImg,
                            index: failedImg.originalIndex
                        }));
                        
                        const processRetryTask = async (task) => {
                            if (window.appState.imageGenStatus.cancelled) return;
                            
                            const { img: failedImg, index: originalIndex } = task;
                            const { prompt: failedPrompt, sceneNumber: failedSceneNumber } = failedImg;
                            
                            try {
                                // Marcar como retrying
                                window.batchImageFxResults.images[originalIndex] = {
                                    ...window.batchImageFxResults.images[originalIndex],
                                    status: 'retrying',
                                    error: 'Regenerando automaticamente...'
                                };
                                renderBatchImageFxOutput();
                                
                                // Aguardar um pouco antes de tentar
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                
                                // Tentar gerar novamente
                                const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        prompt: failedPrompt,
                                        style: style,
                                        aspectRatio: '16:9'
                                    })
                                });
                                
                                if (retryResponse.ok) {
                                    const retryData = await retryResponse.json();
                                    const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                    const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                    
                                    if (base64 || retryData.image || retryData.imageUrl) {
                                        window.batchImageFxResults.images[originalIndex] = {
                                            status: 'success',
                                            url: url,
                                            base64: base64,
                                            prompt: failedPrompt,
                                            sceneNumber: failedSceneNumber,
                                            aspectRatio: '16:9'
                                        };
                                        completed++;
                                        window.appState.imageGenStatus.current = completed;
                                        window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                        updateBatchProgressPanel();
                                        renderBatchImageFxOutput();
                                    }
                                } else {
                                    throw new Error('Erro ao regenerar imagem');
                                }
                            } catch (retryErr) {
                                console.warn(`[Retry] Erro ao regenerar imagem ${originalIndex}:`, retryErr);
                                window.batchImageFxResults.images[originalIndex] = {
                                    ...window.batchImageFxResults.images[originalIndex],
                                    status: 'failed',
                                    error: retryErr.message || 'Erro ao regenerar'
                                };
                                renderBatchImageFxOutput();
                            }
                        };
                        
                        await runTasksWithConcurrency(retryTasks, 3, processRetryTask);
                        
                        // Aguardar antes da próxima tentativa
                        if (retryAttempt < maxRetryAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                    
                    // Finalizar
                    window.appState.imageGenStatus.active = false;
                    window.appState.imageGenStatus.message = 'Geração concluída!';
                    updateBatchProgressPanel();
                    
                    // Esconder painel de progresso
                    const batchProgressPanelFinal = document.getElementById('batch-image-gen-progress-panel');
                    if (batchProgressPanelFinal) {
                        batchProgressPanelFinal.style.display = 'none';
                    }
                    
                    // Mostrar modal de conclusão
                    const completeModal = document.getElementById('batch-image-gen-complete-modal');
                    if (completeModal) {
                        const successCount = window.batchImageFxResults.images.filter(img => img && img.status === 'success').length;
                        const failedCount = window.batchImageFxResults.images.filter(img => img && img.status === 'failed').length;
                        
                        document.getElementById('batch-image-gen-success-count').textContent = `${successCount} sucesso`;
                        document.getElementById('batch-image-gen-failed-count').textContent = `${failedCount} erros`;
                        
                        completeModal.classList.remove('hidden');

                        // Handlers para fechar e navegar
                        const closeBtn = document.getElementById('batch-close-image-gen-modal-btn');
                        const viewBtn = document.getElementById('batch-view-generated-images-btn');
                        const overlay = completeModal;
                        const grid = document.getElementById('batch-generated-images-output');

                        const hideModal = () => {
                            completeModal.classList.add('hidden');
                        };

                        if (closeBtn) {
                            closeBtn.onclick = hideModal;
                        }
                        if (viewBtn) {
                            viewBtn.onclick = () => {
                                hideModal();
                                if (grid) grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                // Abrir lightbox na primeira imagem válida, se existir
                                const triggers = Array.from(document.querySelectorAll('.image-lightbox-trigger'));
                                const valid = triggers.filter(img => {
                                    const url = img.dataset.imgUrl || img.src;
                                    return url && url !== '' && !url.includes('data:image/svg') && (url.startsWith('data:image/') || url.startsWith('http'));
                                });
                                if (valid.length > 0 && typeof window._lbOpen === 'function') {
                                    const images = valid.map((img, idx) => ({ index: idx, url: img.dataset.imgUrl || img.src, scene: img.dataset.imgScene || (idx + 1) }));
                                    window._lbOpen(0, images);
                                }
                            };
                        }
                        // Fechar ao clicar fora
                        if (!overlay._batchModalBound) {
                            overlay.addEventListener('click', (e) => {
                                if (e.target === overlay) hideModal();
                            });
                            document.addEventListener('keydown', (e) => {
                                if (!completeModal.classList.contains('hidden') && e.key === 'Escape') hideModal();
                            });
                            overlay._batchModalBound = true;
                        }
                        }
                    
                } catch (err) {
                    console.error('[Batch Images] Erro:', err);
                    showMessage('imagens-lote-error-message', err.message || 'Erro ao gerar imagens em lote.', true);
                    window.appState.imageGenStatus.active = false;
                    const batchProgressPanelError = document.getElementById('batch-image-gen-progress-panel');
                    if (batchProgressPanelError) {
                        batchProgressPanelError.style.display = 'none';
                    }
                }
            }
            
            // Garantir handlers ativos mesmo sem navegação explícita
            function ensureBatchImageHandlers() {
                const textarea = document.getElementById('batch-image-prompts-textarea');
                const uploadBtn = document.getElementById('batch-upload-txt-btn');
                const txtInput = document.getElementById('batch-txt-file-input');
                const generateBtn = document.getElementById('batch-btn-generate-images');

                if (textarea) {
                    textarea.addEventListener('input', () => {
                        parsePromptsFromText(textarea.value);
                    }, { once: true });
                }

                if (uploadBtn && txtInput) {
                    const newUpload = uploadBtn.cloneNode(true);
                    uploadBtn.parentNode.replaceChild(newUpload, uploadBtn);
                    newUpload.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        txtInput.click();
                    };
                    txtInput.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (file) await processBatchTxtFile(file);
                        e.target.value = '';
                    };
                }

                if (generateBtn) {
                    const newGen = generateBtn.cloneNode(true);
                    generateBtn.parentNode.replaceChild(newGen, generateBtn);
                    newGen.onclick = async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const text = textarea?.value || '';
                        if (text && (!window.batchPromptsFromTxt || window.batchPromptsFromTxt.length === 0)) {
                            parsePromptsFromText(text);
                        }
                        const prompts = batchPromptsFromTxt || [];
                        if (prompts.length === 0) {
                            showMessage('imagens-lote-error-message', 'Adicione prompts primeiro! Cole no campo de texto ou faça upload de um arquivo TXT.', true);
                            return;
                        }
                        await generateBatchImagesFromPrompts(prompts);
                    };
                }
            }

            // Inicialização defensiva
            setTimeout(ensureBatchImageHandlers, 300);

            // Função para atualizar painel de progresso
            function updateBatchProgressPanel() {
                const batchProgressPanel = document.getElementById('batch-image-gen-progress-panel');
                if (!batchProgressPanel || !window.appState.imageGenStatus) return;
                
                const status = window.appState.imageGenStatus;
                const progress = status.total > 0 ? Math.round((status.current / status.total) * 100) : 0;
                
                batchProgressPanel.innerHTML = `
                    <h4 class="font-bold text-sm mb-2 text-blue-400 flex items-center justify-between">
                        A gerar imagens...
                        <button id="batch-cancel-image-gen-btn" class="text-gray-400 hover:text-gray-200">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </h4>
                    <p class="text-xs text-gray-300 mb-2">${status.message || `Processando ${status.current}/${status.total} cenas...`}</p>
                    <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                        <div class="h-2 rounded-full transition-all duration-300 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500" style="width: ${progress}%; background-size: 200% 100%; animation: shimmer 2s infinite;"></div>
                    </div>
                    <p class="text-right text-xs text-gray-400 mt-1">${progress}% (${status.current}/${status.total})</p>
                `;
                
                const cancelBtn = document.getElementById('batch-cancel-image-gen-btn');
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        window.appState.imageGenStatus.cancelled = true;
                        batchProgressPanel.style.display = 'none';
                    };
                }
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            }
            
            // Função para renderizar output (IGUAL a renderImageFxOutput de Prompts e Imagens)
            function renderBatchImageFxOutput() {
                const output = document.getElementById('batch-generated-images-output');
                const actionsContainer = document.getElementById('batch-imagefx-actions');
                const clearBtn = document.getElementById('batch-clear-all-images-btn');
                
                if (!output) return;
                
                const images = window.batchImageFxResults.images || [];
                
                // Sempre renderizar todas as imagens do array, mesmo se algumas forem null
                if (images.length === 0) {
                    output.innerHTML = '<p class="text-center text-gray-400 col-span-full py-8">Nenhuma imagem foi gerada ainda.</p>';
                    if (actionsContainer) actionsContainer.style.display = 'none';
                } else {
                    // Renderizar TODAS as imagens do array (incluindo null/pending)
                    output.innerHTML = `
                        ${images.map((img, index) => {
                        if (!img) {
                                return `
                                    <div id="batch-image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 relative flex flex-col aspect-video">
                                        <div class="w-full h-full flex items-center justify-center bg-gray-700 rounded-lg animate-pulse">
                                            <div class="text-center">
                                                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <p class="mt-2 text-sm font-semibold text-gray-300">Aguardando geração...</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            const isPending = img.status === 'pending' || (img.status === 'retrying' && !img.error);
                            const isFailed = img.status === 'failed';
                            const isRetrying = img.status === 'retrying' && img.error;
                            
                            const aspectRatioClass = {
                                '16:9': 'aspect-video',
                                '9:16': 'aspect-[9/16]',
                                '1:1': 'aspect-square'
                            }[img.aspectRatio || '16:9'] || 'aspect-video';
                            
                            if (isPending) {
                                return `
                                    <div id="batch-image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 relative flex flex-col ${aspectRatioClass}">
                                        <div class="w-full h-full flex items-center justify-center bg-gray-700 rounded-lg animate-pulse">
                                            <div class="text-center">
                                                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <p class="mt-2 text-sm font-semibold text-gray-300">A gerar Cena ${img.sceneNumber || index + 1}...</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else if (isFailed || isRetrying) {
                                const errorMessage = escapeHtml(img.error || 'Erro desconhecido');
                                const truncatedMessage = errorMessage.length > 150 ? errorMessage.substring(0, 150) + '...' : errorMessage;
                                
                                const errorLower = errorMessage.toLowerCase();
                                const isPolicyError = errorLower.includes('bloqueado') || 
                                                     errorLower.includes('inseguro') || 
                                                     errorLower.includes('unsafe') ||
                                                     errorLower.includes('policy');
                                
                                let helpMessage = '';
                                if (isRetrying) {
                                    helpMessage = '<div class="bg-blue-900/20 border border-blue-700 rounded p-2 mb-3"><p class="text-xs text-blue-300"><strong>🔄 A processar...</strong><br>A sua imagem está a ser regenerada automaticamente. Por favor aguarde.</p></div>';
                                } else if (isPolicyError) {
                                    helpMessage = '<div class="bg-orange-900/20 border border-orange-700 rounded p-2 mb-3"><p class="text-xs text-orange-300"><strong>🛡️ Prompt bloqueado</strong><br>O prompt violou as políticas de conteúdo. A IA irá <strong>reescrever automaticamente</strong> mantendo o estilo e história.</p></div>';
                                } else {
                                    helpMessage = '<div class="bg-yellow-900/20 border border-yellow-700 rounded p-2 mb-3"><p class="text-xs text-yellow-300"><strong>⚠️ Erro detectado</strong><br>Esta imagem será <strong>regenerada automaticamente</strong> após a conclusão das outras.</p></div>';
                                }
                                
                                return `
                                    <div id="batch-image-container-${index}" class="bg-red-900/20 border border-red-700 rounded-lg p-4 relative flex flex-col ${aspectRatioClass}">
                                        <h4 class="font-bold text-red-300 mb-2 flex items-center gap-2">
                                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                            ${isRetrying ? 'A Gerar Novamente Cena' : 'Erro na Cena'} ${img.sceneNumber || index + 1}
                                        </h4>
                                        <div class="flex-grow">
                                            ${helpMessage}
                                            <details class="text-xs">
                                                <summary class="cursor-pointer text-red-400 hover:text-red-300 mb-2">Ver detalhes técnicos</summary>
                                                <p class="text-red-300 mt-2 overflow-wrap-anywhere bg-red-950/30 p-2 rounded" title="${errorMessage}">${truncatedMessage}</p>
                                            </details>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-auto">
                                            <button class="batch-toggle-prompt-btn text-sm bg-red-800 text-red-200 px-3 py-1 rounded-md hover:bg-red-700" data-img-index="${index}" ${isRetrying ? 'disabled' : ''}>
                                                ${isRetrying ? '⏳ Aguarde...' : 'Ver Prompt / Editar'}
                                            </button>
                                            <div id="batch-edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="batch-edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="batch-regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // Imagem gerada com sucesso
                                const rewrittenIndicator = img.wasRewritten ? '<span class="text-yellow-500 font-bold text-lg" title="Este prompt foi reescrito pela IA">⚠️</span>' : '';
                                return `
                                    <div id="batch-image-container-${index}" class="bg-gray-800 border border-gray-700 rounded-lg p-2 group relative flex flex-col">
                                        <div class="relative ${aspectRatioClass} w-full" data-img-index="${index}">
                                            <input type="checkbox" class="absolute top-2 right-2 h-5 w-5 z-30 image-select-checkbox" data-img-index="${index}">
                                            <span class="absolute top-2 left-2 text-white bg-black/50 rounded-full px-2 py-0.5 text-xs font-semibold z-20 flex items-center gap-1">Cena ${img.sceneNumber || index + 1} ${rewrittenIndicator}</span>
                                            <img src="${img.url || img.image || 'data:image/png;base64,' + img.base64}" alt="Cena ${img.sceneNumber || index + 1}" class="w-full h-full rounded-lg object-cover image-lightbox-trigger cursor-pointer" data-img-index="${index}" data-img-url="${img.url || img.image || 'data:image/png;base64,' + img.base64}" data-img-scene="${img.sceneNumber || index + 1}">
                                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center p-4 gap-2 pointer-events-none">
                                                <button class="download-single-image-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg pointer-events-auto z-10" data-img-url="${img.url || ''}" data-img-base64="${img.base64 || ''}" data-img-scene="${img.sceneNumber || index + 1}">
                                                    Baixar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2 mt-2">
                                            <button class="batch-toggle-prompt-btn text-sm bg-gray-700 text-gray-200 px-3 py-1 rounded-md hover:bg-gray-600" data-img-index="${index}">
                                                Ver Prompt / Editar
                                            </button>
                                            <div id="batch-edit-prompt-container-${index}" style="display:none;" class="mt-2 space-y-2">
                                                <textarea id="batch-edit-prompt-${index}" class="w-full h-24 px-3 py-2 rounded-lg bg-gray-900 border border-gray-600 text-gray-200 text-sm">${escapeHtml(img.prompt || '')}</textarea>
                                                <button class="batch-regenerate-image-btn w-full text-center py-2 px-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700" data-img-index="${index}" data-scene-number="${img.sceneNumber || index + 1}" data-img-aspect-ratio="${img.aspectRatio || '16:9'}">
                                                    Gerar Novamente
                                                </button>
                                                <div id="batch-animate-result-${index}" class="mt-2" style="display:none;"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    `;
                    if (actionsContainer) actionsContainer.style.display = 'block';
                    
                    // Garantir que todas as imagens sejam visíveis e o scroll funcione
                    setTimeout(() => {
                        const allImages = output.querySelectorAll('[id^="batch-image-container-"]');
                        console.log(`[Batch Images] Total de imagens no array: ${images.length}, renderizadas: ${allImages.length}`);
                        
                        // Verificar se todas as imagens foram renderizadas
                        if (allImages.length < images.length) {
                            console.warn(`[Batch Images] ⚠️ Algumas imagens não foram renderizadas! Esperado: ${images.length}, Encontrado: ${allImages.length}`);
                            // Forçar re-renderização
                            renderBatchImageFxOutput();
                        }
                        
                        // Remover qualquer limitação de altura do container e parent
                        const viewContainer = document.getElementById('view-imagens-lote');
                        if (viewContainer) {
                            viewContainer.style.overflowY = 'visible';
                            viewContainer.style.maxHeight = 'none';
                            viewContainer.style.height = 'auto';
                        }
                        
                        if (output.parentElement) {
                            output.parentElement.style.overflowY = 'visible';
                            output.parentElement.style.maxHeight = 'none';
                            output.parentElement.style.height = 'auto';
                        }
                        output.style.overflowY = 'visible';
                        output.style.maxHeight = 'none';
                        output.style.height = 'auto';

                        // Garantir que a página possa rolar para visualizar todas as imagens
                        document.documentElement.style.overflowY = 'auto';
                        document.body.style.overflow = 'auto';
                    }, 100);
                }
                
                if (clearBtn && images.length > 0 && images.some(img => img)) {
                    clearBtn.style.display = 'block';
                } else if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
                
                // Configurar event listeners
                setupBatchImageEventListeners();

                // Configurar lightbox (apenas uma vez)
                if (!window._batchLightboxInitialized) {
                    setupImageLightbox();
                    window._batchLightboxInitialized = true;
                }

                // Delegar clique diretamente no grid para garantir abertura do lightbox
                const grid = document.getElementById('batch-generated-images-output');
                if (grid && !grid._lightboxGridBound) {
                    grid.addEventListener('click', (e) => {
                        const imgElement = e.target.closest('.image-lightbox-trigger');
                        if (!imgElement) return;
                        e.preventDefault();
                        e.stopPropagation();

                        const allImageTriggers = Array.from(document.querySelectorAll('.image-lightbox-trigger'));
                        const validImages = allImageTriggers.filter(img => {
                            const url = img.dataset.imgUrl || img.src;
                            return url && url !== '' && !url.includes('data:image/svg') && (url.startsWith('data:image/') || url.startsWith('http'));
                        });
                        if (validImages.length === 0) return;

                        const images = validImages.map((img, idx) => ({
                            index: idx,
                            url: img.dataset.imgUrl || img.src,
                            scene: img.dataset.imgScene || (idx + 1)
                        }));
                        let index = validImages.findIndex(img => parseInt(img.dataset.imgIndex) === parseInt(imgElement.dataset.imgIndex));
                        if (index === -1) index = 0;
                        if (typeof window._lbOpen === 'function') window._lbOpen(index, images);
                    }, true);
                    grid._lightboxGridBound = true;
                }
                
                // Atualizar ícones
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            }
            
            // Função helper para escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Configurar event listeners para imagens em lote (IGUAL a setupImageGeneratorEventListeners)
            function setupBatchImageEventListeners() {
                // Selecionar tudo
                const selectAllBtn = document.getElementById('batch-select-all-images-btn');
                if (selectAllBtn) {
                    const newBtn = selectAllBtn.cloneNode(true);
                    selectAllBtn.parentNode.replaceChild(newBtn, selectAllBtn);
                    newBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        const isAnyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
                        checkboxes.forEach(cb => cb.checked = isAnyUnchecked);
                        newBtn.textContent = isAnyUnchecked ? 'Desselecionar Tudo' : 'Selecionar Tudo';
                    };
                }
                
                // Desmarcar todas
                const deselectAllBtn = document.getElementById('batch-deselect-all-images-btn');
                if (deselectAllBtn) {
                    const newBtn = deselectAllBtn.cloneNode(true);
                    deselectAllBtn.parentNode.replaceChild(newBtn, deselectAllBtn);
                    newBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox');
                        checkboxes.forEach(cb => cb.checked = false);
                    };
                }
                
                // Baixar selecionadas
                const downloadSelectedBtn = document.getElementById('batch-download-selected-images-btn');
                if (downloadSelectedBtn) {
                    const newBtn = downloadSelectedBtn.cloneNode(true);
                    downloadSelectedBtn.parentNode.replaceChild(newBtn, downloadSelectedBtn);
                    newBtn.onclick = async () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox:checked');
                        const selectedIndexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.imgIndex));
                        
                        let targets = [];
                        if (selectedIndexes.length === 0) {
                            // Se nada foi selecionado, baixar todas as imagens disponíveis
                            targets = window.batchImageFxResults.images
                                .map((img, idx) => ({ img, idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        } else {
                            targets = selectedIndexes
                                .map(idx => ({ img: window.batchImageFxResults.images[idx], idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        }
                        
                        if (targets.length === 0) {
                            showMessage('imagens-lote-error-message', 'Nenhuma imagem disponível para download.', true);
                            return;
                        }
                        
                        showMessage('imagens-lote-success-message', `Iniciando download de ${targets.length} imagem(ns)...`);
                        
                        for (const { img, idx } of targets) {
                            const dataUrl = img.url || `data:image/png;base64,${img.base64}`;
                            const filename = `cena-${img.sceneNumber || idx + 1}.png`;
                            downloadImage(dataUrl, filename);
                            await new Promise(resolve => setTimeout(resolve, 800)); // esperar 800ms entre downloads
                        }
                        
                        showMessage('imagens-lote-success-message', `Download de ${targets.length} imagem(ns) concluído!`);
                    };
                }

                // Animar selecionadas (fila)
                const animateSelectedBtn = document.getElementById('batch-animate-selected-images-btn');
                if (animateSelectedBtn) {
                    const newBtn = animateSelectedBtn.cloneNode(true);
                    animateSelectedBtn.parentNode.replaceChild(newBtn, animateSelectedBtn);
                    newBtn.onclick = async () => {
                        const checkboxes = document.querySelectorAll('#batch-generated-images-output .image-select-checkbox:checked');
                        let indexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.imgIndex));
                        const images = window.batchImageFxResults.images || [];
                        if (indexes.length === 0) {
                            indexes = images.map((_, i) => i);
                        }
                        const promptInput = document.getElementById('meta-animation-prompt-input');
                        const animationPrompt = promptInput?.value || '';
                        const token = safeLocalStorageGet('core_token');
                        if (!token) {
                            showMessage('imagens-lote-error-message', 'Token não encontrado.', true);
                            return;
                        }
                        const panel = document.getElementById('batch-animation-progress-panel');
                        const updateProgress = (current, total, msg) => {
                            if (!panel) return;
                            panel.style.display = 'block';
                            const progress = total > 0 ? Math.round((current / total) * 100) : 0;
                            panel.innerHTML = `
                                <h4 class="font-bold text-sm mb-2 text-purple-400 flex items-center justify-between">
                                    Animando imagens...
                                    <span class="text-xs text-gray-400">${current}/${total}</span>
                                </h4>
                                <p class="text-xs text-gray-300 mb-2">${msg || ''}</p>
                                <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                    <div class="h-2 rounded-full transition-all duration-300 bg-gradient-to-r from-purple-500 via-pink-500 to-purple-500" style="width: ${progress}%; background-size: 200% 100%; animation: shimmer 2s infinite;"></div>
                                </div>
                            `;
                        };
                        let current = 0;
                        const total = indexes.length;
                        updateProgress(current, total, 'Iniciando...');
                        for (const idx of indexes) {
                            const img = images[idx];
                            if (!img || !(img.url || img.base64)) {
                                current++;
                                updateProgress(current, total, `Cena ${idx + 1}: imagem indisponível`);
                                continue;
                            }
                            try {
                                // Usar HuMo para animação
                                const body = {
                                    sceneNumber: img.sceneNumber || idx + 1,
                                    base64: img.base64 ? `data:image/png;base64,${img.base64}` : null,
                                    imageUrl: img.url || null
                                };
                                let resp = await fetch(`${API_BASE}/api/animate/parallax`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                                    body: JSON.stringify(body)
                                });
                                const data = await resp.json();
                                if (resp.ok && data.videoBase64) {
                                    const container = document.getElementById(`batch-animate-result-${idx}`);
                                    if (container) {
                                        container.style.display = 'block';
                                        container.innerHTML = `<video controls class="w-full rounded-lg" src="${data.videoBase64}"></video>
                                            <div class="mt-2 flex gap-2">
                                                <a download="cena-${img.sceneNumber || idx + 1}.mp4" href="${data.videoBase64}" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Baixar Vídeo</a>
                                            </div>`;
                                    }
                                    updateProgress(++current, total, `Cena ${img.sceneNumber || idx + 1}: concluída`);
                                } else {
                                    updateProgress(++current, total, `Cena ${img.sceneNumber || idx + 1}: erro`);
                                }
                            } catch (err) {
                                updateProgress(++current, total, `Cena ${idx + 1}: ${err.message}`);
                            }
                        }
                        showMessage('imagens-lote-success-message', 'Animação concluída');
                        if (panel) setTimeout(() => { panel.style.display = 'none'; }, 1500);
                    };
                }
                
                // Limpar imagens
                const clearBtn = document.getElementById('batch-clear-all-images-btn');
                if (clearBtn) {
                    const newBtn = clearBtn.cloneNode(true);
                    clearBtn.parentNode.replaceChild(newBtn, clearBtn);
                    newBtn.onclick = () => {
                        if (confirm('Tem certeza de que deseja limpar todas as imagens geradas? Esta ação não pode ser desfeita.')) {
                            if (!window.batchImageFxResults) {
                                window.batchImageFxResults = { images: [], lastClearedImages: [] };
                            }
                            window.batchImageFxResults.lastClearedImages = [...window.batchImageFxResults.images];
                            window.batchImageFxResults.images = [];
                            renderBatchImageFxOutput();
                            showMessage('imagens-lote-success-message', 'Imagens limpas com sucesso!');
                        }
                    };
                }
                
                // Download individual
                document.querySelectorAll('#batch-generated-images-output .download-single-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const url = newBtn.dataset.imgUrl;
                        const base64 = newBtn.dataset.imgBase64;
                        const scene = newBtn.dataset.imgScene;
                        if (url) {
                            downloadImage(url, `cena-${scene}.png`);
                        } else if (base64) {
                            downloadImage(`data:image/png;base64,${base64}`, `cena-${scene}.png`);
                        }
                    };
                });
                
                // Toggle prompt (ver/editar)
                document.querySelectorAll('#batch-generated-images-output .batch-toggle-prompt-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const container = document.getElementById(`batch-edit-prompt-container-${index}`);
                        if (container) {
                            container.style.display = container.style.display === 'none' ? 'block' : 'none';
                        }
                    };
                });
                
                // Regenerar imagem com prompt editado
                document.querySelectorAll('#batch-generated-images-output .batch-regenerate-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = async () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const sceneNumber = newBtn.dataset.sceneNumber;
                        const aspectRatio = newBtn.dataset.imgAspectRatio;
                        const textarea = document.getElementById(`batch-edit-prompt-${index}`);
                        const editedPrompt = textarea?.value.trim();
                        
                        if (!editedPrompt) {
                            showMessage('imagens-lote-error-message', 'Por favor, edite o prompt antes de regenerar.', true);
                            return;
                        }
                        
                        try {
                            newBtn.disabled = true;
                            newBtn.textContent = 'Regenerando...';
                            
                            // Atualizar status da imagem
                            if (window.batchImageFxResults.images[index]) {
                                window.batchImageFxResults.images[index] = {
                                    ...window.batchImageFxResults.images[index],
                                    status: 'retrying',
                                    error: 'Regenerando com prompt editado...'
                                };
                                renderBatchImageFxOutput();
                            }
                            
                            const token = localStorage.getItem('core_token');
                            if (!token) {
                                throw new Error('Token não encontrado.');
                            }
                            
                            const style = document.getElementById('batch-image-style-select')?.value || 'photorealistic';
                            
                            const response = await fetch(`${API_BASE}/api/generate/imagefx/regenerate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    prompt: editedPrompt,
                                    aspectRatio: aspectRatio || '16:9',
                                    style: style
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.msg || 'Erro ao regenerar imagem');
                            }
                            
                            const data = await response.json();
                            
                            if (window.batchImageFxResults.images[index]) {
                                window.batchImageFxResults.images[index] = {
                                    status: 'success',
                                    url: data.imageUrl || `data:image/png;base64,${data.image}`,
                                    base64: data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null),
                                    prompt: editedPrompt,
                                    sceneNumber: sceneNumber,
                                    aspectRatio: aspectRatio || '16:9'
                                };
                                renderBatchImageFxOutput();
                                showMessage('imagens-lote-success-message', 'Imagem regenerada com sucesso!');
                            }
                            
                        } catch (err) {
                            console.error('[Regenerate Image] Erro:', err);
                            
                            if (window.batchImageFxResults.images[index]) {
                                window.batchImageFxResults.images[index] = {
                                    ...window.batchImageFxResults.images[index],
                                    status: 'failed',
                                    error: err.message || 'Erro ao regenerar imagem'
                                };
                                renderBatchImageFxOutput();
                            }
                            
                            showMessage('imagens-lote-error-message', err.message || 'Erro ao regenerar imagem.', true);
                        } finally {
                            newBtn.disabled = false;
                            newBtn.textContent = 'Gerar Novamente';
                        }
                    };
                });
            }
            
            
            // Configurar event listeners dos botões de imagem
            function setupImageGeneratorEventListeners() {
                // Selecionar tudo
                const selectAllBtn = document.getElementById('select-all-images-btn');
                if (selectAllBtn) {
                    const newBtn = selectAllBtn.cloneNode(true);
                    selectAllBtn.parentNode.replaceChild(newBtn, selectAllBtn);
                    newBtn.onclick = () => {
                        const checkboxes = document.querySelectorAll('.image-select-checkbox');
                        const isAnyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
                        checkboxes.forEach(cb => cb.checked = isAnyUnchecked);
                        newBtn.textContent = isAnyUnchecked ? 'Desselecionar Tudo' : 'Selecionar Tudo';
                    };
                }
                
                // Baixar selecionadas
                const downloadSelectedBtn = document.getElementById('download-selected-images-btn');
                if (downloadSelectedBtn) {
                    const newBtn = downloadSelectedBtn.cloneNode(true);
                    downloadSelectedBtn.parentNode.replaceChild(newBtn, downloadSelectedBtn);
                    newBtn.onclick = async () => {
                        const checkboxes = document.querySelectorAll('.image-select-checkbox:checked');
                        const selectedIndexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.imgIndex));
                        
                        let targets = [];
                        if (selectedIndexes.length === 0) {
                            // Se nada foi selecionado, baixar todas as imagens disponíveis
                            targets = window.imageFxResults.images
                                .map((img, idx) => ({ img, idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        } else {
                            targets = selectedIndexes
                                .map(idx => ({ img: window.imageFxResults.images[idx], idx }))
                                .filter(item => item.img && item.img.status === 'success' && (item.img.url || item.img.base64));
                        }
                        
                        if (targets.length === 0) {
                            showMessage('prompts-imagens-error-message', 'Nenhuma imagem disponível para download.', true);
                            return;
                        }
                        
                        showMessage('prompts-imagens-success-message', `Iniciando download de ${targets.length} imagem(ns)...`);
                        
                        for (const { img, idx } of targets) {
                            const dataUrl = img.url || `data:image/png;base64,${img.base64}`;
                            const filename = `cena-${img.sceneNumber || idx + 1}.png`;
                            downloadImage(dataUrl, filename);
                            await window.delay(800); // esperar 800ms entre downloads para evitar bloqueio do navegador
                        }
                        
                        showMessage('prompts-imagens-success-message', `Download de ${targets.length} imagem(ns) concluído!`);
                    };
                }
                
                // Limpar imagens
                const clearBtn = document.getElementById('clear-all-images-btn');
                if (clearBtn) {
                    const newBtn = clearBtn.cloneNode(true);
                    clearBtn.parentNode.replaceChild(newBtn, clearBtn);
                    newBtn.onclick = () => {
                        if (confirm('Tem certeza de que deseja limpar todas as imagens geradas? Esta ação não pode ser desfeita.')) {
                            window.imageFxResults.lastClearedImages = [...window.imageFxResults.images];
                            window.imageFxResults.images = [];
                            window.renderImageFxOutput();
                            showMessage('prompts-imagens-success-message', 'Imagens limpas com sucesso!');
                        }
                    };
                }
                
                // Download individual
                document.querySelectorAll('.download-single-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const url = newBtn.dataset.imgUrl;
                        const base64 = newBtn.dataset.imgBase64;
                        const scene = newBtn.dataset.imgScene;
                        if (url) {
                            downloadImage(url, `cena-${scene}.png`);
                        } else if (base64) {
                            downloadImage(`data:image/png;base64,${base64}`, `cena-${scene}.png`);
                        }
                    };
                });

                // Animar (Parallax) no grid principal
                const mainOutput = document.getElementById('generated-images-output');
                if (mainOutput && !mainOutput._animateBound) {
                    mainOutput.addEventListener('click', async (e) => {
                        const btn = e.target.closest('.batch-animate-image-btn');
                        if (!btn) return;
                        const idx = parseInt(btn.dataset.imgIndex);
                        const scene = parseInt(btn.dataset.sceneNumber || idx + 1);
                        const img = (window.imageFxResults.images || [])[idx];
                        if (!img || !(img.url || img.base64)) {
                            showMessage('prompts-imagens-error-message', 'Imagem não disponível para animar.', true);
                            return;
                        }
                        btn.disabled = true;
                        btn.textContent = 'Animando...';
                        try {
                            const token = localStorage.getItem('core_token');
                            const body = {
                                sceneNumber: scene,
                                base64: img.base64 ? `data:image/png;base64,${img.base64}` : null,
                                imageUrl: img.url || null
                            };
                            
                            let resp = await fetch(`${API_BASE}/api/animate/parallax`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                                body: JSON.stringify(body)
                            });
                            
                            const data = await resp.json();
                            if (!resp.ok) throw new Error(data.msg || 'Erro ao animar imagem');
                            
                            const container = document.getElementById(`edit-prompt-container-${idx}`);
                            if (container) {
                                container.style.display = 'block';
                                const resultDivId = `animate-result-${idx}`;
                                let resultDiv = document.getElementById(resultDivId);
                                if (!resultDiv) {
                                    resultDiv = document.createElement('div');
                                    resultDiv.id = resultDivId;
                                    resultDiv.className = 'mt-2';
                                    container.appendChild(resultDiv);
                                }
                                resultDiv.innerHTML = `<video controls class=\"w-full rounded-lg\" src=\"${data.videoBase64}\"></video>
                                    <div class=\"mt-2 flex gap-2\">
                                        <a download=\"cena-${scene}.mp4\" href=\"${data.videoBase64}\" class=\"px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg\">Baixar Vídeo</a>
                                    </div>`;
                            }
                            showMessage('prompts-imagens-success-message', `Cena ${scene} animada com sucesso.`);
                        } catch (err) {
                            console.error('[Animate] Erro:', err);
                            showMessage('prompts-imagens-error-message', err.message || 'Erro ao animar imagem.', true);
                        } finally {
                            btn.disabled = false;
                            btn.textContent = 'Animar (Parallax)';
                        }
                    });
                    mainOutput._animateBound = true;
                }
                
                // Toggle prompt (ver/editar)
                document.querySelectorAll('.toggle-prompt-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const container = document.getElementById(`edit-prompt-container-${index}`);
                        if (container) {
                            container.style.display = container.style.display === 'none' ? 'block' : 'none';
                        }
                    };
                });
                
                // Regenerar imagem com prompt editado
                document.querySelectorAll('.regenerate-image-btn').forEach(btn => {
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    newBtn.onclick = async () => {
                        const index = parseInt(newBtn.dataset.imgIndex);
                        const sceneNumber = newBtn.dataset.sceneNumber;
                        const aspectRatio = newBtn.dataset.imgAspectRatio;
                        const textarea = document.getElementById(`edit-prompt-${index}`);
                        const editedPrompt = textarea?.value.trim();
                        
                        if (!editedPrompt) {
                            showMessage('prompts-imagens-error-message', 'Por favor, edite o prompt antes de regenerar.', true);
                            return;
                        }
                        
                        try {
                            newBtn.disabled = true;
                            newBtn.textContent = 'Regenerando...';
                            
                            // Atualizar status da imagem
                            if (window.imageFxResults.images[index]) {
                                window.imageFxResults.images[index] = {
                                    ...window.imageFxResults.images[index],
                                    status: 'retrying',
                                    error: 'Regenerando com prompt editado...'
                                };
                                window.renderImageFxOutput();
                            }
                            
                            const token = localStorage.getItem('core_token');
                            if (!token) {
                                throw new Error('Token não encontrado.');
                            }
                            
                            const style = document.getElementById('scene-style-select')?.value || 'photorealistic';
                            
                            const response = await fetch(`${API_BASE}/api/generate/imagefx/regenerate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    prompt: editedPrompt,
                                    aspectRatio: aspectRatio || '16:9',
                                    style: style
                                })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.msg || 'Erro ao regenerar imagem');
                            }
                            
                            const data = await response.json();
                            
                            if (window.imageFxResults.images[index]) {
                                window.imageFxResults.images[index] = {
                                    status: 'success',
                                    url: data.imageUrl || `data:image/png;base64,${data.image}`,
                                    base64: data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null),
                                    prompt: editedPrompt,
                                    sceneNumber: sceneNumber,
                                    aspectRatio: aspectRatio || '16:9'
                                };
                                window.renderImageFxOutput();
                                showMessage('prompts-imagens-success-message', 'Imagem regenerada com sucesso!');
                            }
                            
                        } catch (err) {
                            console.error('[Regenerate Image] Erro:', err);
                            
                            if (window.imageFxResults.images[index]) {
                                window.imageFxResults.images[index] = {
                                    ...window.imageFxResults.images[index],
                                    status: 'failed',
                                    error: err.message || 'Erro ao regenerar imagem'
                                };
                                window.renderImageFxOutput();
                            }
                            
                            showMessage('prompts-imagens-error-message', err.message || 'Erro ao regenerar imagem.', true);
                        } finally {
                            newBtn.disabled = false;
                            newBtn.textContent = 'Gerar Novamente';
                        }
                    };
                });
            }
            
            // Formulário de gerar prompts de cena
            const scenePromptsForm = document.getElementById('scene-prompts-form');
            if (scenePromptsForm) {
                scenePromptsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const script = document.getElementById('scene-script-text')?.value.trim();
                    const model = document.getElementById('scene-model-select')?.value;
                    const style = document.getElementById('scene-style-select')?.value;
                    const mode = document.getElementById('scene-generation-mode')?.value;
                    const wordsPerScene = document.getElementById('scene-words-per-scene')?.value;
                    const unitSelect = document.getElementById('scene-unit-select')?.value || 'words';
                    const characters = document.getElementById('scene-characters')?.value.trim();
                    
                    if (!script || !model) {
                        showMessage('prompts-imagens-error-message', 'Por favor, preencha todos os campos.', true);
                        return;
                    }
                    
                    const btn = document.getElementById('btn-generate-scene-prompts');
                    const originalText = btn?.querySelector('span')?.textContent;
                    
                    // Calcular estimativa de cenas ANTES do try para garantir que está disponível em todo o escopo
                    const wordCount = script.trim().split(/\s+/).filter(Boolean).length;
                    let estimatedScenes = 0;
                    if (mode === 'manual' && wordsPerScene) {
                        const unitSelect = document.getElementById('scene-unit-select')?.value || 'words';
                        if (unitSelect === 'seconds') {
                            // Calcular baseado em segundos: ~2.5 palavras por segundo
                            const wordsPerSecond = 2.5;
                            const wordsPerInterval = parseInt(wordsPerScene) * wordsPerSecond;
                            estimatedScenes = Math.max(1, Math.round(wordCount / wordsPerInterval));
                        } else {
                            estimatedScenes = Math.max(1, Math.round(wordCount / parseInt(wordsPerScene)));
                        }
                    } else {
                        estimatedScenes = Math.max(1, Math.round(wordCount / 90));
                    }
                    
                    try {
                        if (btn) {
                            btn.disabled = true;
                            if (btn.querySelector('span')) btn.querySelector('span').textContent = 'Gerando...';
                        }
                        
                        // Mostrar modal de progresso
                        const progressModal = document.getElementById('scene-prompts-progress-modal');
                        const progressBar = document.getElementById('progress-modal-bar');
                        const progressPercentage = document.getElementById('progress-modal-percentage');
                        const progressCounter = document.getElementById('progress-modal-counter');
                        const progressStatus = document.getElementById('progress-modal-status');
                        const progressDetails = document.getElementById('progress-modal-details');
                        
                        if (progressModal) {
                            progressModal.classList.remove('hidden');
                            if (progressBar) progressBar.style.width = '0%';
                            if (progressPercentage) progressPercentage.textContent = '0%';
                            if (progressCounter) progressCounter.textContent = '0/0';
                            if (progressStatus) progressStatus.textContent = 'Iniciando geração...';
                            if (progressDetails) progressDetails.textContent = 'Preparando a IA...';
                            
                            // Criar ícones
                            if (typeof lucide !== 'undefined') {
                                setTimeout(() => lucide.createIcons(), 100);
                            }
                        }
                        
                        hideMessage('prompts-imagens-error-message');
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            throw new Error('Token de autenticação não encontrado. Faça login novamente.');
                        }
                        
                        // Simular progresso enquanto aguarda resposta
                        let progress = 0;
                        const progressInterval = setInterval(() => {
                            if (progress < 90) {
                                progress += Math.random() * 5;
                                if (progress > 90) progress = 90;
                                
                                // Calcular quantos prompts foram "gerados" baseado na porcentagem
                                const currentPromptCount = Math.max(1, Math.floor((progress / 100) * estimatedScenes));
                                
                                if (progressBar) progressBar.style.width = `${progress}%`;
                                if (progressPercentage) progressPercentage.textContent = `${Math.round(progress)}%`;
                                if (progressCounter) progressCounter.textContent = `${currentPromptCount}/${estimatedScenes}`;
                                if (progressStatus) progressStatus.textContent = 'Gerando prompts com IA...';
                                if (progressDetails) progressDetails.textContent = `Analisando roteiro e criando ${estimatedScenes} cenas...`;
                            }
                        }, 500);
                        
                        // Verificar se laozhang.ai está configurada como padrão
                        let useLaozhang = false;
                        try {
                            const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (settingsResponse.ok) {
                                const settings = await settingsResponse.json();
                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                            }
                        } catch (err) {
                            console.warn('[Scene Prompts] Erro ao verificar configuração laozhang.ai:', err);
                        }
                        
                        // Usar rota /laozhang se configurada como padrão
                        const endpoint = useLaozhang ? '/api/generate/scene-prompts/laozhang' : '/api/generate/scene-prompts';
                        console.log(`[Scene Prompts] Usando endpoint: ${endpoint} (laozhang: ${useLaozhang})`);
                        
                        const response = await fetch(`${API_BASE}${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                script,
                                model: useLaozhang ? null : model, // Não enviar model se usar laozhang, mas sempre capturar o modelo selecionado
                                style,
                                mode,
                                wordsPerScene: mode === 'manual' ? parseInt(wordsPerScene) : null,
                                unit: mode === 'manual' ? (unitSelect || 'words') : null, // 'words' ou 'seconds'
                                characters: characters || null,
                                imageModel: 'imageFx',
                                selectedModel: model, // Sempre enviar o modelo selecionado para salvar no histórico
                                isVO3: document.getElementById('scene-vo3-checkbox')?.checked || false,
                                expectedScenes: estimatedScenes // Enviar o número exato calculado no frontend
                            })
                        });
                        
                        clearInterval(progressInterval);
                        
                        // Atualizar progresso final
                        if (progressBar) progressBar.style.width = '100%';
                        if (progressPercentage) progressPercentage.textContent = '100%';
                        if (progressCounter) progressCounter.textContent = `${estimatedScenes}/${estimatedScenes}`;
                        if (progressStatus) progressStatus.textContent = 'Finalizando...';
                        if (progressDetails) progressDetails.textContent = 'Processando resposta da IA...';
                        
                        if (!response.ok) {
                            clearInterval(progressInterval);
                            const errorData = await response.json().catch(() => ({}));
                            
                            // Fechar modal e mostrar erro
                            if (progressModal) progressModal.classList.add('hidden');
                            throw new Error(errorData.msg || 'Erro ao gerar prompts de cena');
                        }
                        
                        const data = await response.json();
                        scenePromptsData = data.scenes || [];
                        
                        // Usar o modelo retornado pelo backend, ou o modelo selecionado como fallback
                        // O backend sempre retorna modelUsed com o modelo correto
                        let modelUsed = data.modelUsed;
                        if (!modelUsed) {
                            // Se não retornou modelUsed, usar o modelo do select (que foi capturado antes)
                            modelUsed = model || document.getElementById('scene-model-select')?.value || 'gpt-4o';
                        }
                        
                        console.log('[Scene Prompts] ✅ Modelo usado:', modelUsed, '| Modelo selecionado no frontend:', model, '| Modelo retornado pelo backend:', data.modelUsed);
                        
                        if (!scenePromptsData || scenePromptsData.length === 0) {
                            clearInterval(progressInterval);
                            if (progressModal) progressModal.classList.add('hidden');
                            throw new Error('Nenhum prompt foi gerado. Tente novamente.');
                        }
                        
                        // Verificar se gerou todas as cenas esperadas
                        const expectedScenes = data.expectedScenes || estimatedScenes;
                        const generatedScenes = data.generatedScenes || scenePromptsData.length;
                        
                        // Atualizar contador final
                        if (progressCounter) progressCounter.textContent = `${generatedScenes}/${expectedScenes}`;
                        if (progressStatus) progressStatus.textContent = generatedScenes === expectedScenes ? 'Concluído!' : 'Parcialmente concluído';
                        if (progressDetails) {
                            if (generatedScenes === expectedScenes) {
                                progressDetails.textContent = `${generatedScenes} prompts gerados com sucesso!`;
                            } else {
                                progressDetails.textContent = `${generatedScenes}/${expectedScenes} prompts gerados. Tentando gerar as cenas faltantes...`;
                            }
                        }
                        
                        // Fechar modal após 1.5 segundos
                        setTimeout(() => {
                            if (progressModal) progressModal.classList.add('hidden');
                        }, 1500);
                        
                        // Renderizar prompts
                        renderScenePrompts(scenePromptsData);
                        
                        // Mostrar seção de gerar imagens
                        const generateSection = document.getElementById('generate-all-images-section');
                        if (generateSection) {
                            generateSection.style.display = 'block';
                        }
                        
                        const countEl = document.getElementById('total-prompts-count');
                        if (countEl) {
                            // Mostrar o número esperado, não apenas o gerado
                            countEl.textContent = `${generatedScenes} prompts prontos${generatedScenes < expectedScenes ? ` (esperado: ${expectedScenes})` : ''}`;
                        }
                        
                        if (generatedScenes < expectedScenes) {
                            console.warn(`[Scene Prompts] ⚠️ Esperávamos ${expectedScenes} cenas, mas apenas ${generatedScenes} foram geradas.`);
                            showMessage('prompts-imagens-error-message', `Atenção: Esperávamos ${expectedScenes} cenas, mas apenas ${generatedScenes} foram geradas. O sistema tentará gerar as cenas faltantes automaticamente.`, true);
                        } else if (generatedScenes === expectedScenes) {
                            console.log(`[Scene Prompts] ✅ Todas as ${expectedScenes} cenas foram geradas com sucesso!`);
                        }
                        
                        showMessage('prompts-imagens-success-message', data.msg || `${scenePromptsData.length} prompts gerados com sucesso!`);
                        
                        // Salvar no histórico com o modelo correto
                        try {
                            const historyResponse = await fetch(`${API_BASE}/api/scene-prompts/history`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    script: script,
                                    scenes: scenePromptsData,
                                    model: modelUsed, // Usar o modelo retornado pelo backend
                                    style: style,
                                    mode: mode,
                                    wordsPerScene: mode === 'manual' ? parseInt(wordsPerScene) : null,
                                    characters: characters || null,
                                    title: `Prompts gerados em ${new Date().toLocaleString('pt-BR')}`
                                })
                            });
                            
                            if (!historyResponse.ok) {
                                const errorData = await historyResponse.json().catch(() => ({}));
                                console.warn('[Save History] Erro ao salvar no histórico:', errorData.msg || 'Erro desconhecido');
                            } else {
                                console.log('[Save History] Histórico salvo com sucesso!');
                            }
                        } catch (historyErr) {
                            console.error('[Save History] Erro ao salvar no histórico:', historyErr);
                        }
                        
                        // Recarregar histórico
                        loadScenePromptsHistory();
                        
                    } catch (err) {
                        console.error('[Scene Prompts] Erro:', err);
                        
                        // Garantir que o modal seja fechado em caso de erro
                        const progressModal = document.getElementById('scene-prompts-progress-modal');
                        if (progressModal) {
                            progressModal.classList.add('hidden');
                        }
                        
                        showMessage('prompts-imagens-error-message', err.message || 'Erro ao gerar prompts de cena.', true);
                    } finally {
                        if (btn) {
                            btn.disabled = false;
                            if (btn.querySelector('span') && originalText) {
                                btn.querySelector('span').textContent = originalText;
                            }
                        }
                    }
                });
            }
            
            // Função para renderizar prompts
            function renderScenePrompts(scenes) {
                const container = document.getElementById('scene-prompts-list');
                const resultsDiv = document.getElementById('scene-prompts-results');
                
                if (!container || !resultsDiv) return;
                
                if (scenes.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">Nenhum prompt gerado.</p>';
                    return;
                }
                
                container.innerHTML = scenes.map((scene, index) => `
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-white font-semibold">Cena ${scene.scene_number || index + 1}: ${scene.scene_description || 'Cena'}</h4>
                            <button onclick="copyToClipboard('scene-prompt-${index}')" class="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <textarea id="scene-prompt-${index}" class="w-full px-3 py-2 bg-gray-900 border border-gray-600 rounded text-gray-300 text-sm" rows="3" readonly>${escapeHtml(scene.prompt_text || '')}</textarea>
                    </div>
                `).join('');
                
                resultsDiv.classList.remove('hidden');
                
                // Configurar botão de download
                const downloadBtn = document.getElementById('download-prompts-btn');
                if (downloadBtn) {
                    const newBtn = downloadBtn.cloneNode(true);
                    downloadBtn.parentNode.replaceChild(newBtn, downloadBtn);
                    newBtn.onclick = () => {
                        downloadScenePrompts(scenes);
                    };
                }
                
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Animar (HuMo)
                const output = document.getElementById('batch-generated-images-output');
                if (output && !output._animateBound) {
                    output.addEventListener('click', async (e) => {
                        const btn = e.target.closest('.batch-animate-image-btn');
                        if (!btn) return;
                        const idx = parseInt(btn.dataset.imgIndex);
                        const scene = parseInt(btn.dataset.sceneNumber || idx + 1);
                        const img = (window.batchImageFxResults.images || [])[idx];
                        if (!img || !(img.url || img.base64)) {
                            showMessage('imagens-lote-error-message', 'Imagem não disponível para animar.', true);
                            return;
                        }
                        btn.disabled = true;
                        btn.textContent = 'Animando...';
                        try {
                            const token = safeLocalStorageGet('core_token');
                            const body = {
                                sceneNumber: scene,
                                base64: img.base64 ? `data:image/png;base64,${img.base64}` : null,
                                imageUrl: img.url || null
                            };
                            
                            let resp = await fetch(`${API_BASE}/api/animate/parallax`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                                body: JSON.stringify(body)
                            });
                            
                            const data = await resp.json();
                            if (!resp.ok) throw new Error(data.msg || 'Erro ao animar imagem');
                            
                            const container = document.getElementById(`batch-animate-result-${idx}`);
                            if (container) {
                                container.style.display = 'block';
                                container.innerHTML = `<video controls class="w-full rounded-lg" src="${data.videoBase64}"></video>
                                    <div class="mt-2 flex gap-2">
                                        <a download="cena-${scene}.mp4" href="${data.videoBase64}" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Baixar Vídeo</a>
                                    </div>`;
                            }
                            showMessage('imagens-lote-success-message', `Cena ${scene} animada com sucesso.`);
                        } catch (err) {
                            console.error('[Batch Animate] Erro:', err);
                            showMessage('imagens-lote-error-message', err.message || 'Erro ao animar imagem.', true);
                        } finally {
                            btn.disabled = false;
                            btn.textContent = 'Animar (Parallax)';
                        }
                    });
                    output._animateBound = true;
                }
            }
            
            // Função para baixar prompts de cena
            function downloadScenePrompts(scenes) {
                if (!scenes || scenes.length === 0) {
                    showMessage('prompts-imagens-error-message', 'Nenhum prompt disponível para download.', true);
                    return;
                }
                
                // Criar conteúdo do arquivo
                let content = `PROMPTS DE CENA GERADOS\n`;
                content += `Data: ${new Date().toLocaleString('pt-BR')}\n`;
                content += `Total de cenas: ${scenes.length}\n`;
                content += `\n${'='.repeat(60)}\n\n`;
                
                scenes.forEach((scene, index) => {
                    content += `CENA ${scene.scene_number || index + 1}`;
                    if (scene.scene_description) {
                        content += `: ${scene.scene_description}`;
                    }
                    content += `\n${'-'.repeat(60)}\n`;
                    content += `${scene.prompt_text || ''}\n\n`;
                });
                
                // Criar e baixar arquivo
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `prompts-cena-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showMessage('prompts-imagens-success-message', `${scenes.length} prompt(s) baixado(s) com sucesso!`);
            }
            
            // Inicializar appState para controle de geração
            if (!window.appState) {
                window.appState = { imageGenStatus: { active: false, current: 0, total: 0, message: '', cancelled: false } };
            }
            
            // Função para geração em paralelo (estilo DARKSCRIPT)
            const runTasksWithConcurrency = async (tasks, limit, processor) => {
                return new Promise((resolve) => {
                    let nextIndex = 0;
                    let active = 0;
                    
                    const launchNext = () => {
                        if (nextIndex >= tasks.length && active === 0) {
                            resolve();
                            return;
                        }
                        while (active < limit && nextIndex < tasks.length) {
                            const task = tasks[nextIndex++];
                            active++;
                            processor(task).finally(() => {
                                active--;
                                launchNext();
                            });
                        }
                    };
                    
                    launchNext();
                });
            };
            
            // Botão de gerar todas as imagens (estilo DARKSCRIPT)
            const btnGenerateAllImages = document.getElementById('btn-generate-all-images');
            if (btnGenerateAllImages) {
                btnGenerateAllImages.addEventListener('click', async () => {
                    if (scenePromptsData.length === 0) {
                        showMessage('prompts-imagens-error-message', 'Gere os prompts de cena primeiro!', true);
                        return;
                    }
                    
                    // Mostrar modal de confirmação customizado
                    const confirmModal = document.getElementById('confirm-generation-modal');
                    const confirmMessage = document.getElementById('confirm-modal-message');
                    const confirmCount = document.getElementById('confirm-modal-count');
                    const confirmBtn = document.getElementById('confirm-modal-confirm');
                    const cancelBtn = document.getElementById('confirm-modal-cancel');
                    
                    if (confirmModal && confirmMessage && confirmCount) {
                        confirmCount.textContent = `${scenePromptsData.length} imagem${scenePromptsData.length !== 1 ? 'ns' : ''}`;
                        confirmMessage.textContent = `Você está prestes a gerar ${scenePromptsData.length} imagem${scenePromptsData.length !== 1 ? 'ns' : ''} para o seu vídeo.`;
                        
                        if (typeof lucide !== 'undefined') {
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                        
                        confirmModal.classList.remove('hidden');
                        
                        // Aguardar confirmação
                        const userConfirmed = await new Promise((resolve) => {
                            const handleConfirm = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(true);
                            };
                            
                            const handleCancel = () => {
                                confirmModal.classList.add('hidden');
                                confirmBtn.removeEventListener('click', handleConfirm);
                                cancelBtn.removeEventListener('click', handleCancel);
                                resolve(false);
                            };
                            
                            confirmBtn.addEventListener('click', handleConfirm);
                            cancelBtn.addEventListener('click', handleCancel);
                            
                            // Fechar com ESC
                            const handleEsc = (e) => {
                                if (e.key === 'Escape') {
                                    document.removeEventListener('keydown', handleEsc);
                                    handleCancel();
                                }
                            };
                            document.addEventListener('keydown', handleEsc);
                        });
                        
                        if (!userConfirmed) return;
                    }
                    
                    try {
                        btnGenerateAllImages.disabled = true;
                        
                        const token = localStorage.getItem('core_token');
                        if (!token) {
                            throw new Error('Token de autenticação não encontrado.');
                        }
                        
                        const style = document.getElementById('scene-style-select')?.value || 'photorealistic';
                        const prompts = scenePromptsData.map(s => s.prompt_text).filter(Boolean);
                        const totalPrompts = prompts.length;
                        
                        // Limpar imagens anteriores
                        window.imageFxResults.images = [];
                        window.renderImageFxOutput();
                        
                        // Inicializar status de geração
                        window.appState.imageGenStatus = {
                            active: true,
                            current: 0,
                            total: totalPrompts,
                            message: `A iniciar ${totalPrompts} prompt(s)...`,
                            cancelled: false
                        };
                        window.renderImageGenerationProgress(window.appState.imageGenStatus);
                        
                        // Preparar tasks
                        const tasks = prompts.map((prompt, idx) => {
                            const sceneNumber = scenePromptsData[idx]?.scene_number || idx + 1;
                            const imageIndex = idx;
                            
                            // Adicionar placeholder
                            window.imageFxResults.images.push({
                                status: 'pending',
                                prompt: prompt,
                                error: 'A gerar...',
                                sceneNumber: sceneNumber,
                                aspectRatio: '16:9'
                            });
                            
                            return { prompt, sceneNumber, imageIndex };
                        });
                        
                        window.renderImageFxOutput();
                        
                        let completed = 0;
                        const generationStartTime = Date.now();
                        
                        const processTask = async (task) => {
                            if (window.appState.imageGenStatus.cancelled) {
                                return;
                            }
                            
                            const { prompt: currentPrompt, sceneNumber: currentSceneNumber, imageIndex: currentImageIndex } = task;
                            
                            try {
                                const response = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({
                                        prompt: currentPrompt,
                                        style: style,
                                        aspectRatio: '16:9'
                                    })
                                });
                                
                                if (!response.ok) {
                                    const errorData = await response.json().catch(() => ({}));
                                    throw new Error(errorData.msg || 'Erro ao gerar imagem');
                                }
                                
                                const data = await response.json();
                                
                                if (data.image || data.base64 || data.imageUrl) {
                                    const base64 = data.base64 || data.image || (data.imageUrl?.startsWith('data:') ? data.imageUrl.split(',')[1] : null);
                                    const url = data.imageUrl || `data:image/png;base64,${base64}`;
                                    
                                    window.imageFxResults.images[currentImageIndex] = {
                                        status: 'success',
                                        url: url,
                                        base64: base64,
                                        prompt: data.prompt || currentPrompt,
                                        sceneNumber: currentSceneNumber,
                                        aspectRatio: '16:9',
                                        wasRewritten: data.wasRewritten || false
                                    };
                                } else {
                                    throw new Error('A API retornou uma resposta vazia.');
                                }
                                
                                completed++;
                                window.appState.imageGenStatus.current = completed;
                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                window.renderImageFxOutput();
                                
                            } catch (error) {
                                console.error(`Erro na geração ImageFX para cena ${currentSceneNumber}:`, error);
                                const userFriendlyMessage = error.message || 'Erro desconhecido.';
                                const errorLower = userFriendlyMessage.toLowerCase();
                                
                                // Verificar se é erro de throttling (429)
                                const isThrottleError = errorLower.includes('throttled') || 
                                                       errorLower.includes('429') ||
                                                       errorLower.includes('limite de requisições') ||
                                                       errorLower.includes('rate limit');
                                
                                // Verificar se é erro de política (bloqueado)
                                const isPolicyError = errorLower.includes('bloqueado') || 
                                                     errorLower.includes('conteúdo inseguro') || 
                                                     errorLower.includes('conteudo inseguro') ||
                                                     errorLower.includes('unsafe') ||
                                                     errorLower.includes('policy');
                                
                                // Se for erro de throttling, aguardar e tentar novamente
                                if (isThrottleError) {
                                    window.imageFxResults.images[currentImageIndex] = {
                                        status: 'retrying',
                                        prompt: currentPrompt,
                                        error: 'Limite de requisições atingido. Aguardando e tentando novamente...',
                                        sceneNumber: currentSceneNumber,
                                        aspectRatio: '16:9'
                                    };
                                    window.renderImageFxOutput();
                                    
                                    // Aguardar 5-10 segundos antes de tentar novamente
                                    await new Promise(resolve => setTimeout(resolve, 5000 + Math.random() * 5000));
                                    
                                    // Tentar gerar novamente
                                    try {
                                        const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({
                                                prompt: currentPrompt,
                                                style: style,
                                                aspectRatio: '16:9'
                                            })
                                        });
                                        
                                        if (retryResponse.ok) {
                                            const retryData = await retryResponse.json();
                                            const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                            const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                            
                                            if (base64 || retryData.image || retryData.imageUrl) {
                                                window.imageFxResults.images[currentImageIndex] = {
                                                    status: 'success',
                                                    url: url,
                                                    base64: base64,
                                                    prompt: currentPrompt,
                                                    sceneNumber: currentSceneNumber,
                                                    aspectRatio: '16:9'
                                                };
                                                completed++;
                                                window.appState.imageGenStatus.current = completed;
                                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                                window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                                window.renderImageFxOutput();
                                                return;
                                            }
                                        }
                                    } catch (retryErr) {
                                        console.warn(`[Retry Throttle] Erro ao tentar novamente após throttling para cena ${currentSceneNumber}:`, retryErr);
                                    }
                                }
                                
                                if (isPolicyError) {
                                    // Marcar como retrying e tentar reescrever automaticamente
                                    window.imageFxResults.images[currentImageIndex] = {
                                        status: 'retrying',
                                        prompt: currentPrompt,
                                        error: 'Prompt bloqueado. Reescrevendo automaticamente...',
                                        sceneNumber: currentSceneNumber,
                                        aspectRatio: '16:9'
                                    };
                                    window.renderImageFxOutput();
                                    
                                    // Tentar reescrever o prompt usando IA
                                    try {
                                        // Verificar se laozhang.ai está configurada como padrão
                                        let useLaozhang = false;
                                        try {
                                            const settingsResponse = await fetch(`${API_BASE}/api/app-settings/laozhang-status`, {
                                                headers: { 'Authorization': `Bearer ${token}` }
                                            });
                                            if (settingsResponse.ok) {
                                                const settings = await settingsResponse.json();
                                                useLaozhang = settings.laozhang_use_as_default === true || settings.laozhang_use_as_default === 'true' || settings.laozhang_use_as_default === 1;
                                            }
                                        } catch (err) {
                                            console.warn('[Rewrite Prompt] Erro ao verificar configuração laozhang.ai:', err);
                                        }
                                        
                                        const endpoint = useLaozhang ? '/api/rewrite/blocked-prompt/laozhang' : '/api/rewrite/blocked-prompt';
                                        const selectedModel = document.getElementById('scene-model-select')?.value || 'gpt-4o';
                                        
                                        const rewriteResponse = await fetch(`${API_BASE}${endpoint}`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify({
                                                prompt: currentPrompt,
                                                model: useLaozhang ? null : selectedModel,
                                                selectedModel: selectedModel
                                            })
                                        });
                                        
                                        if (rewriteResponse.ok) {
                                            const rewriteData = await rewriteResponse.json();
                                            const rewrittenPrompt = rewriteData.rewrittenPrompt || currentPrompt;
                                            
                                            // Atualizar status
                                            window.imageFxResults.images[currentImageIndex] = {
                                                ...window.imageFxResults.images[currentImageIndex],
                                                error: 'Gerando com prompt reescrito...'
                                            };
                                            window.renderImageFxOutput();
                                            
                                            // Aguardar antes de tentar novamente
                                            await new Promise(resolve => setTimeout(resolve, 2000));
                                            
                                            // Tentar gerar novamente com prompt reescrito
                                            const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Authorization': `Bearer ${token}`
                                                },
                                                body: JSON.stringify({
                                                    prompt: rewrittenPrompt,
                                                    style: style,
                                                    aspectRatio: '16:9'
                                                })
                                            });
                                            
                                            if (retryResponse.ok) {
                                                const retryData = await retryResponse.json();
                                                const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                                const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                                
                                                if (base64 || retryData.image || retryData.imageUrl) {
                                                    window.imageFxResults.images[currentImageIndex] = {
                                                        status: 'success',
                                                        url: url,
                                                        base64: base64,
                                                        prompt: rewrittenPrompt,
                                                        sceneNumber: currentSceneNumber,
                                                        aspectRatio: '16:9',
                                                        wasRewritten: true,
                                                        originalPrompt: currentPrompt
                                                    };
                                                    completed++;
                                                    window.appState.imageGenStatus.current = completed;
                                                    window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                                    window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                                    window.renderImageFxOutput();
                                                    return;
                                                }
                                            }
                                        }
                                    } catch (rewriteErr) {
                                        console.warn(`[Retry] Erro ao reescrever prompt para cena ${currentSceneNumber}:`, rewriteErr);
                                    }
                                }
                                
                                // Se chegou aqui, falhou mesmo após retry
                                window.imageFxResults.images[currentImageIndex] = {
                                    status: 'failed',
                                    prompt: currentPrompt,
                                    error: userFriendlyMessage,
                                    sceneNumber: currentSceneNumber,
                                    aspectRatio: '16:9'
                                };
                                
                                completed++;
                                window.appState.imageGenStatus.current = completed;
                                window.appState.imageGenStatus.message = `Processando ${completed}/${totalPrompts} cenas...`;
                                window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                window.renderImageFxOutput();
                            }
                        };
                        
                        // Executar em paralelo (3 por vez)
                        await runTasksWithConcurrency(tasks, 3, processTask);
                        
                        if (window.appState.imageGenStatus.cancelled) {
                            window.appState.imageGenStatus.active = false;
                            window.appState.imageGenStatus.message = 'Geração cancelada pelo usuário.';
                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                            showMessage('prompts-imagens-success-message', 'Geração cancelada pelo usuário.');
                            return;
                        }
                        
                        // Processar imagens com erro automaticamente (retry em paralelo, 3 por vez)
                        let retryAttempt = 0;
                        const maxRetryAttempts = 5;
                        
                        while (retryAttempt < maxRetryAttempts) {
                            const failedImages = window.imageFxResults.images
                                .map((img, idx) => ({ ...img, originalIndex: idx }))
                                .filter(img => img.status === 'failed');
                            
                            if (failedImages.length === 0) break;
                            
                            retryAttempt++;
                            window.appState.imageGenStatus.message = `Tentativa ${retryAttempt}: Regenerando ${failedImages.length} imagem(ns) com erro...`;
                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                            
                            // Processar falhas em paralelo (3 por vez)
                            const retryTasks = failedImages.map(failedImg => ({
                                img: failedImg,
                                index: failedImg.originalIndex
                            }));
                            
                            const processRetryTask = async (task) => {
                                if (window.appState.imageGenStatus.cancelled) return;
                                
                                const { img: failedImg, index: originalIndex } = task;
                                const { prompt: failedPrompt, sceneNumber: failedSceneNumber } = failedImg;
                                
                                try {
                                    // Marcar como retrying
                                    window.imageFxResults.images[originalIndex] = {
                                        ...window.imageFxResults.images[originalIndex],
                                        status: 'retrying',
                                        error: 'Regenerando automaticamente...'
                                    };
                                    window.renderImageFxOutput();
                                    
                                    // Aguardar um pouco antes de tentar
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                    
                                    // Tentar gerar novamente
                                    const retryResponse = await fetch(`${API_BASE}/api/generate/imagefx`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            prompt: failedPrompt,
                                            style: style,
                                            aspectRatio: '16:9'
                                        })
                                    });
                                    
                                    if (retryResponse.ok) {
                                        const retryData = await retryResponse.json();
                                        const base64 = retryData.base64 || retryData.image || (retryData.imageUrl?.startsWith('data:') ? retryData.imageUrl.split(',')[1] : null);
                                        const url = retryData.imageUrl || `data:image/png;base64,${base64}`;
                                        
                                        if (base64 || retryData.image || retryData.imageUrl) {
                                            window.imageFxResults.images[originalIndex] = {
                                                status: 'success',
                                                url: url,
                                                base64: base64,
                                                prompt: retryData.prompt || failedPrompt,
                                                sceneNumber: failedSceneNumber,
                                                aspectRatio: '16:9',
                                                wasRewritten: retryData.wasRewritten || false
                                            };
                                            // Atualizar contador
                                            const currentSuccess = window.imageFxResults.images.filter(img => img.status === 'success').length;
                                            window.appState.imageGenStatus.current = currentSuccess;
                                            window.appState.imageGenStatus.message = `Regenerando... ${currentSuccess}/${totalPrompts}`;
                                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                                            window.renderImageFxOutput();
                                        }
                                    } else {
                                        throw new Error('Erro na resposta');
                                    }
                                } catch (retryErr) {
                                    console.warn(`[Auto Retry] Erro ao regenerar cena ${failedSceneNumber}:`, retryErr);
                                    // Manter como failed para próxima tentativa
                                    window.imageFxResults.images[originalIndex] = {
                                        ...window.imageFxResults.images[originalIndex],
                                        status: 'failed',
                                        error: retryErr.message || 'Erro ao regenerar'
                                    };
                                    window.renderImageFxOutput();
                                }
                            };
                            
                            await runTasksWithConcurrency(retryTasks, 3, processRetryTask);
                            
                            // Aguardar antes da próxima tentativa
                            if (retryAttempt < maxRetryAttempts) {
                                await new Promise(resolve => setTimeout(resolve, 2000));
                            }
                        }
                        
                        // Finalizar
                        const finalSuccessCount = window.imageFxResults.images.filter(img => img.status === 'success').length;
                        const finalFailedCount = window.imageFxResults.images.filter(img => img.status === 'failed').length;
                        const durationSeconds = Math.max(1, Math.round((Date.now() - generationStartTime) / 1000));
                        
                        window.appState.imageGenStatus.active = false;
                        window.appState.imageGenStatus.message = `Concluído. ${finalSuccessCount} sucesso, ${finalFailedCount} erro(s).`;
                        window.renderImageGenerationProgress(window.appState.imageGenStatus);
                        
                        // Mostrar modal de conclusão
                        if (typeof window.showImageGenCompleteModal === 'function') {
                            window.showImageGenCompleteModal(durationSeconds, finalSuccessCount, finalFailedCount);
                        } else {
                            // Fallback: mostrar mensagem
                            showMessage('prompts-imagens-success-message', `${finalSuccessCount} imagem(ns) gerada(s) com sucesso${finalFailedCount > 0 ? `, ${finalFailedCount} erro(s)` : ''} em ${durationSeconds} segundos!`);
                        }
                        
                        window.renderImageFxOutput();
                        
                    } catch (err) {
                        console.error('[Generate All Images] Erro:', err);
                        showMessage('prompts-imagens-error-message', err.message || 'Erro ao gerar imagens.', true);
                        if (window.appState) {
                            window.appState.imageGenStatus.active = false;
                            window.renderImageGenerationProgress(window.appState.imageGenStatus);
                        }
                    } finally {
                        btnGenerateAllImages.disabled = false;
                    }
                });
            }
            
            // Função para mostrar modal de conclusão
            window.showImageGenCompleteModal = function(durationInSeconds, successCount = 0, failedCount = 0) {
                const modal = document.getElementById('image-gen-complete-modal');
                if (!modal) return;

                const durationEl = document.getElementById('image-gen-duration');
                const successCountEl = document.getElementById('image-gen-success-count');
                const failedCountEl = document.getElementById('image-gen-failed-count');
                
                if (durationEl) {
                    const minutes = Math.floor(durationInSeconds / 60);
                    const seconds = durationInSeconds % 60;
                    durationEl.textContent = minutes > 0 
                        ? `Tempo total: ${minutes}min ${seconds}s`
                        : `Tempo total: ${durationInSeconds}s`;
                }
                
                if (successCountEl) {
                    successCountEl.textContent = `${successCount} sucesso`;
                }
                
                if (failedCountEl) {
                    failedCountEl.textContent = failedCount > 0 ? `${failedCount} erros` : '0 erros';
                    failedCountEl.style.display = failedCount > 0 ? 'block' : 'none';
                }

                modal.classList.remove('hidden');
                
                // Atualizar ícones
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }

                const closeBtn = document.getElementById('close-image-gen-modal-btn');
                const viewBtn = document.getElementById('view-generated-images-btn');

                if (closeBtn) {
                    const newCloseBtn = closeBtn.cloneNode(true);
                    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
                    newCloseBtn.onclick = () => modal.classList.add('hidden');
                }
                
                if (viewBtn) {
                    const newViewBtn = viewBtn.cloneNode(true);
                    viewBtn.parentNode.replaceChild(newViewBtn, viewBtn);
                    newViewBtn.onclick = () => {
                        modal.classList.add('hidden');
                        // Fazer scroll para as imagens
                        const output = document.getElementById('generated-images-output');
                        if (output) {
                            output.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    };
                }
            };
            
            // Função auxiliar para download de imagem
            window.downloadImage = function(dataUrl, filename) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            window.delay = function(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            };

            // ================================================
            // GERADOR DE VOZ (TTS) - FUNÇÕES
            // ================================================
            const TTS_PROVIDER_MODELS = {
                voice_premium: 'genaipro-default',
                genaipro: 'genaipro-default',
                openai: 'tts-1-hd',
                gemini: 'gemini-2.5-pro-preview-tts',
                laozhang: 'tts-1'
            };

            function getProviderDefaultTtsModel(provider) {
                return TTS_PROVIDER_MODELS[provider] || 'gemini-2.5-pro-preview-tts';
            }

            function getProviderFriendlyName(provider) {
                switch (provider) {
                    case 'voice_premium':
                    case 'genaipro':
                        return 'Voz Premium';
                    case 'openai':
                        return 'La Casa Dark Core IA';
                    case 'gemini':
                        return 'La Casa Dark Core IA';
                    case 'laozhang':
                        return 'DarkVoz';
                    default:
                        return 'La Casa Dark Core';
                }
            }
            
            let ttsJobId = null;
            let ttsPollInterval = null;
            
            // Cache de vozes por provedor
            const voicesCache = {
                voice_premium: null,
                genaipro: null,
                laozhang: null,
                openai: null,
                gemini: null
            };
            
            // Pré-carregar vozes premium em background
            async function preloadPremiumVoices() {
                const token = safeLocalStorageGet('core_token');
                if (!token) {
                    console.log('[TTS] Token não encontrado, pulando pré-carregamento de vozes premium');
                    return;
                }
                
                // Pré-carregar vozes premium em background (sem bloquear UI)
                console.log('[TTS] Pré-carregando vozes premium...');
                try {
                    const response = await fetch(`${API_BASE}/api/tts/voices?provider=voice_premium`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                            voicesCache.voice_premium = data.data;
                            voicesCache.genaipro = data.data; // Mesmo provedor
                            console.log(`[TTS] ✅ ${data.data.length} vozes premium pré-carregadas com sucesso`);
                        }
                    } else {
                        console.log('[TTS] Não foi possível pré-carregar vozes premium (pode não estar configurado)');
                    }
                } catch (error) {
                    console.log('[TTS] Erro ao pré-carregar vozes premium (não crítico):', error.message);
                }
            }
            
            // Pré-carregar vozes premium quando a página carrega (após 2 segundos para não sobrecarregar)
            if (userToken) {
                setTimeout(() => {
                    preloadPremiumVoices();
                }, 2000);
            }
            
            // Carregar vozes quando a view é exibida
            async function loadTtsVoices(useCache = true) {
                const voiceSelect = document.getElementById('tts-voice-select');
                const providerSelect = document.getElementById('tts-provider-select');
                
                if (!voiceSelect || !providerSelect) return;
                
                // Obter token do localStorage
                const token = safeLocalStorageGet('core_token');
                if (!token) {
                    console.error('[TTS] Token não encontrado');
                    voiceSelect.innerHTML = '<option value="">Erro: Token não encontrado. Faça login novamente.</option>';
                    return;
                }
                
                const provider = providerSelect.value || 'laozhang';
                const providerName = getProviderFriendlyName(provider);
                
                // Verificar cache primeiro para vozes premium
                if (useCache && (provider === 'voice_premium' || provider === 'genaipro')) {
                    const cachedVoices = voicesCache.voice_premium || voicesCache.genaipro;
                    if (cachedVoices && cachedVoices.length > 0) {
                        console.log(`[TTS] Usando ${cachedVoices.length} vozes premium do cache`);
                        voiceSelect.innerHTML = '<option value="">Selecione uma voz...</option>';
                        cachedVoices.forEach(voice => {
                            const option = document.createElement('option');
                            const voiceId = voice.id || voice.voice_id || voice.name || '';
                            option.value = voiceId;
                            option.textContent = voice.label || voice.name || voice.voice_name || voiceId || 'Voz';
                            option.setAttribute('data-voice-id', voiceId);
                            voiceSelect.appendChild(option);
                        });
                        // Atualizar cache em background (sem bloquear UI)
                        loadTtsVoicesFromServer(provider, token, providerName, true);
                        return;
                    }
                }
                
                // Carregar do servidor
                await loadTtsVoicesFromServer(provider, token, providerName, false);
            }
            
            // Função auxiliar para carregar vozes do servidor
            async function loadTtsVoicesFromServer(provider, token, providerName, background = false) {
                const voiceSelect = document.getElementById('tts-voice-select');
                
                try {
                    const response = await fetch(`${API_BASE}/api/tts/voices?provider=${provider}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (!background) {
                            voiceSelect.innerHTML = '<option value="">Selecione uma voz...</option>';
                        }
                        
                        console.log(`[TTS] Vozes recebidas do servidor (${provider}):`, data);
                        
                        if (data.data && Array.isArray(data.data)) {
                            if (data.data.length === 0) {
                                if (!background) {
                                    voiceSelect.innerHTML = '<option value="">Nenhuma voz disponível</option>';
                                    showMessage('tts-error-message', `Nenhuma voz disponível. Verifique se a chave de API do ${providerName} está configurada corretamente.`, true);
                                }
                            } else {
                                // Salvar no cache se for premium
                                if (provider === 'voice_premium' || provider === 'genaipro') {
                                    voicesCache.voice_premium = data.data;
                                    voicesCache.genaipro = data.data;
                                } else {
                                    voicesCache[provider] = data.data;
                                }
                                
                                if (!background) {
                                    data.data.forEach(voice => {
                                        const option = document.createElement('option');
                                        const voiceId = voice.id || voice.voice_id || voice.name || '';
                                        option.value = voiceId;
                                        option.textContent = voice.label || voice.name || voice.voice_name || voiceId || 'Voz';
                                        option.setAttribute('data-voice-id', voiceId);
                                        voiceSelect.appendChild(option);
                                    });
                                    console.log(`[TTS] ${data.data.length} vozes carregadas com sucesso`);
                                } else {
                                    // Atualizar select se ainda não foi preenchido
                                    if (voiceSelect.options.length <= 1) {
                                        data.data.forEach(voice => {
                                            const option = document.createElement('option');
                                            const voiceId = voice.id || voice.voice_id || voice.name || '';
                                            option.value = voiceId;
                                            option.textContent = voice.label || voice.name || voice.voice_name || voiceId || 'Voz';
                                            option.setAttribute('data-voice-id', voiceId);
                                            voiceSelect.appendChild(option);
                                        });
                                    }
                                }
                            }
                        } else {
                            if (!background) {
                                console.warn('[TTS] Formato de resposta inesperado:', data);
                                voiceSelect.innerHTML = '<option value="">Erro ao carregar vozes</option>';
                            }
                        }
                    } else {
                        if (!background) {
                            const errorData = await response.json().catch(() => ({ message: 'Erro ao carregar vozes' }));
                            console.error('[TTS] Erro ao carregar vozes:', errorData);
                            voiceSelect.innerHTML = '<option value="">Erro ao carregar vozes</option>';
                            showMessage('tts-error-message', errorData.message || `Erro ao carregar vozes. Verifique se a chave de API do ${providerName} está configurada no painel admin.`, true);
                        }
                    }
                } catch (error) {
                    if (!background) {
                        console.error('Erro ao carregar vozes:', error);
                        voiceSelect.innerHTML = '<option value="">Erro ao carregar vozes</option>';
                        showMessage('tts-error-message', `Erro ao carregar vozes (${providerName}): ${error.message || 'Erro desconhecido'}`, true);
                    }
                }
            }
            
            // Preview de voz - Abrir modal
            document.getElementById('tts-preview-btn')?.addEventListener('click', async () => {
                const voiceSelect = document.getElementById('tts-voice-select');
                const providerSelect = document.getElementById('tts-provider-select');
                
                const voice = voiceSelect?.value;
                const provider = providerSelect?.value || 'laozhang';
                
                if (!voice) {
                    showMessage('tts-error-message', 'Por favor, selecione uma voz para testar.');
                    return;
                }
                
                // Obter modelo e velocidade se for DarkVoz
                let model = getProviderDefaultTtsModel(provider);
                let speed = 1.0;
                if (provider === 'laozhang') {
                    const modelSelect = document.getElementById('tts-model-select');
                    const speedSelect = document.getElementById('tts-speed-select');
                    if (modelSelect) model = modelSelect.value || 'tts-1';
                    if (speedSelect) speed = parseFloat(speedSelect.value) || 1.0;
                }
                
                // Mostrar modal
                const modal = document.getElementById('tts-preview-modal');
                const loadingDiv = document.getElementById('tts-preview-loading');
                const player = document.getElementById('tts-preview-player');
                const errorDiv = document.getElementById('tts-preview-error');
                
                modal.classList.remove('hidden');
                loadingDiv.classList.remove('hidden');
                player.style.display = 'none';
                errorDiv.classList.add('hidden');
                errorDiv.textContent = '';
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                try {
                    // Obter token de forma segura
                    const userToken = safeLocalStorageGet('core_token');
                    if (!userToken || userToken === 'undefined') {
                        throw new Error('Token de autenticação não encontrado. Por favor, faça login novamente.');
                    }
                    
                    const response = await fetch(`${API_BASE}/api/tts/preview`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({
                            voice: voice,
                            provider: provider,
                            model: model,
                            speed: speed
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.audio && data.audio.base64) {
                            loadingDiv.classList.add('hidden');
                            player.src = `data:${data.audio.mimeType};base64,${data.audio.base64}`;
                            player.style.display = 'block';
                            player.play();
                        } else {
                            throw new Error('Áudio não retornado');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Erro ao gerar preview' }));
                        const errorMessage = errorData.message || errorData.details || `Erro ${response.status} ao gerar preview`;
                        throw new Error(errorMessage);
                    }
                } catch (error) {
                    loadingDiv.classList.add('hidden');
                    const errorMessage = error.message || 'Erro ao gerar preview.';
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.remove('hidden');
                    console.error('[TTS Preview] Erro:', error);
                }
            });
            
            // Fechar modal de preview
            document.getElementById('tts-preview-modal-close')?.addEventListener('click', () => {
                document.getElementById('tts-preview-modal').classList.add('hidden');
            });
            
            document.getElementById('tts-preview-modal-close-btn')?.addEventListener('click', () => {
                document.getElementById('tts-preview-modal').classList.add('hidden');
            });
            
            // Gerar narração completa
            document.getElementById('tts-generate-btn')?.addEventListener('click', async () => {
                const scriptInput = document.getElementById('tts-script-input');
                const voiceSelect = document.getElementById('tts-voice-select');
                const providerSelect = document.getElementById('tts-provider-select');
                const styleInstructions = document.getElementById('tts-style-instructions');
                
                const script = scriptInput?.value.trim();
                const voice = voiceSelect?.value;
                const provider = providerSelect?.value || 'laozhang';
                const style = styleInstructions?.value.trim() || '';
                
                if (!script || !voice) {
                    showMessage('tts-error-message', 'Por favor, preencha o roteiro e selecione uma voz.');
                    return;
                }
                
                // Obter velocidade se for DarkVoz (modelo será 'tts-1' por padrão)
                let model = getProviderDefaultTtsModel(provider);
                let speed = 1.0;
                if (provider === 'laozhang') {
                    const speedSelect = document.getElementById('tts-speed-select');
                    if (speedSelect) speed = parseFloat(speedSelect.value) || 1.0;
                    model = 'tts-1'; // Modelo fixo para laozhang
                }
                
                // Mostrar modal de progresso
                document.getElementById('tts-progress-modal').classList.remove('hidden');
                document.getElementById('tts-progress-status').textContent = 'Iniciando geração...';
                document.getElementById('tts-progress-counter').textContent = '0/0';
                document.getElementById('tts-progress-percentage').textContent = '0%';
                document.getElementById('tts-progress-bar').style.width = '0%';
                
                try {
                    const response = await fetch(`${API_BASE}/api/tts/generate-from-script`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            script: script,
                            voice: voice,
                            ttsModel: model,
                            styleInstructions: style,
                            provider: provider,
                            speed: speed
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        ttsJobId = data.jobId;
                        
                        // Iniciar polling (a cada 1 segundo para atualização mais rápida)
                        if (ttsPollInterval) clearInterval(ttsPollInterval);
                        ttsPollInterval = setInterval(pollTtsStatus, 1000);
                        
                        // Primeira atualização imediata
                        setTimeout(pollTtsStatus, 500);
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido' }));
                        const errorMessage = errorData.message || errorData.msg || `Erro ${response.status} ao iniciar geração`;
                        showMessage('tts-error-message', errorMessage, true);
                        document.getElementById('tts-progress-modal').classList.add('hidden');
                        console.error('[TTS Generate] Erro:', errorData);
                    }
                } catch (error) {
                    showMessage('tts-error-message', 'Erro ao iniciar geração: ' + error.message);
                    document.getElementById('tts-progress-modal').classList.add('hidden');
                }
            });
            
            // Polling de status
            async function pollTtsStatus() {
                if (!ttsJobId) return;
                
                try {
                    const response = await fetch(`${API_BASE}/api/tts/status/${ttsJobId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        const progress = data.progress || 0;
                        const total = data.total || 1;
                        const percentage = total > 0 ? Math.round((progress / total) * 100) : 0;
                        
                        // Atualizar status e mensagem
                        const statusEl = document.getElementById('tts-progress-status');
                        const detailsEl = document.getElementById('tts-progress-details');
                        if (statusEl) statusEl.textContent = data.message || 'Processando...';
                        if (detailsEl) detailsEl.textContent = data.message || `Gerando parte ${progress} de ${total}...`;
                        
                        // Atualizar contador e porcentagem
                        document.getElementById('tts-progress-counter').textContent = `${progress}/${total}`;
                        document.getElementById('tts-progress-percentage').textContent = `${percentage}%`;
                        
                        // Atualizar barra de progresso com animação suave
                        const progressBar = document.getElementById('tts-progress-bar');
                        if (progressBar) {
                            progressBar.style.width = `${percentage}%`;
                            progressBar.style.transition = 'width 0.5s ease-out';
                        }
                        
                        if (data.status === 'completed') {
                            clearInterval(ttsPollInterval);
                            ttsPollInterval = null;
                            
                            // Garantir 100% antes de fechar
                            document.getElementById('tts-progress-percentage').textContent = '100%';
                            document.getElementById('tts-progress-bar').style.width = '100%';
                            document.getElementById('tts-progress-status').textContent = 'Concluído!';
                            document.getElementById('tts-progress-details').textContent = 'Narração gerada com sucesso!';
                            
                            // Aguardar um pouco antes de fechar o modal
                            setTimeout(() => {
                            document.getElementById('tts-progress-modal').classList.add('hidden');
                            
                            // Mostrar modal de conclusão
                            if (data.downloadUrl) {
                                const downloadLink = document.getElementById('tts-download-link');
                                    if (downloadLink) {
                                downloadLink.href = data.downloadUrl;
                                downloadLink.download = `narracao_${Date.now()}.mp3`;
                                    }
                                    const completeModal = document.getElementById('tts-complete-modal');
                                    if (completeModal) completeModal.classList.remove('hidden');
                            }
                            
                            showMessage('tts-success-message', 'Narração gerada com sucesso!');
                            }, 1000);
                        } else if (data.status === 'partial') {
                            // FFmpeg não disponível - mostrar partes separadas
                            clearInterval(ttsPollInterval);
                            ttsPollInterval = null;
                            
                            // Garantir 100% antes de fechar
                            document.getElementById('tts-progress-percentage').textContent = '100%';
                            document.getElementById('tts-progress-bar').style.width = '100%';
                            document.getElementById('tts-progress-status').textContent = 'Partes geradas!';
                            document.getElementById('tts-progress-details').textContent = data.message || 'Partes geradas (FFmpeg não disponível)';
                            
                            // Aguardar um pouco antes de fechar o modal
                            setTimeout(() => {
                                document.getElementById('tts-progress-modal').classList.add('hidden');
                                
                                // Mostrar modal de partes
                                if (data.partDownloads && data.partDownloads.length > 0) {
                                    const partsList = document.getElementById('tts-parts-list');
                                    if (partsList) {
                                        partsList.innerHTML = '';
                                        data.partDownloads.forEach((part) => {
                                            const partDiv = document.createElement('div');
                                            partDiv.className = 'bg-gray-800/50 border border-gray-700 rounded-lg p-4 flex items-center justify-between';
                                            partDiv.innerHTML = `
                                                <div class="flex items-center gap-3">
                                                    <i data-lucide="file-audio" class="w-6 h-6 text-amber-400"></i>
                                                    <div>
                                                        <p class="text-white font-medium">Parte ${part.part}</p>
                                                        <p class="text-gray-400 text-xs">${part.filename}</p>
                                                    </div>
                                                </div>
                                                <a href="${part.downloadUrl}" download="${part.filename}" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-lg transition duration-200 text-sm">
                                                    Baixar
                                                </a>
                                            `;
                                            partsList.appendChild(partDiv);
                                        });
                                        // Re-inicializar ícones Lucide
                                        if (typeof lucide !== 'undefined') {
                                            lucide.createIcons();
                                        }
                                    }
                                    document.getElementById('tts-parts-modal').classList.remove('hidden');
                                    showMessage('tts-success-message', `${data.partDownloads.length} parte(s) gerada(s) com sucesso!`, false);
                                } else {
                                    showMessage('tts-error-message', data.message || 'Partes geradas mas não foi possível preparar downloads.', true);
                                }
                            }, 1000);
                        } else if (data.status === 'failed') {
                            clearInterval(ttsPollInterval);
                            ttsPollInterval = null;
                            document.getElementById('tts-progress-modal').classList.add('hidden');
                            showMessage('tts-error-message', data.message || 'Erro ao gerar narração.', true);
                        } else if (data.status === 'processing' || data.status === 'queued') {
                            // Continuar atualizando o progresso
                            // O progresso já foi atualizado acima
                        }
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }
            
            // Reset
            document.getElementById('tts-reset-btn')?.addEventListener('click', () => {
                document.getElementById('tts-script-input').value = '';
                document.getElementById('tts-voice-select').value = '';
                document.getElementById('tts-style-instructions').value = '';
                document.getElementById('tts-preview-player').style.display = 'none';
                document.getElementById('tts-char-count').textContent = '';
                document.getElementById('tts-duration-hint').textContent = 'Adicione o roteiro para calcular a duração.';
            });
            
            // Importar último roteiro
            document.getElementById('tts-import-last-script')?.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/scripts/last`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.script) {
                            document.getElementById('tts-script-input').value = data.script;
                            showMessage('tts-success-message', 'Roteiro importado com sucesso!');
                        } else {
                            showMessage('tts-error-message', 'Nenhum roteiro encontrado.');
                        }
                    }
                } catch (error) {
                    showMessage('tts-error-message', 'Erro ao importar roteiro.');
                }
            });
            
            // Calcular duração e caracteres
            document.getElementById('tts-script-input')?.addEventListener('input', (e) => {
                const text = e.target.value;
                const charCount = text.length;
                const wordCount = text.trim().split(/\s+/).filter(w => w).length;
                const estimatedDuration = Math.ceil(wordCount / 130); // 130 palavras por minuto (mais rigoroso)
                
                document.getElementById('tts-char-count').textContent = `${charCount} caracteres`;
                if (wordCount > 0) {
                    document.getElementById('tts-duration-hint').textContent = `Duração estimada: ~${estimatedDuration} minuto(s)`;
                } else {
                    document.getElementById('tts-duration-hint').textContent = 'Adicione o roteiro para calcular a duração.';
                }
            });
            
            // Fechar modais
            document.getElementById('tts-close-modal-btn')?.addEventListener('click', () => {
                document.getElementById('tts-complete-modal').classList.add('hidden');
            });
            
            document.getElementById('tts-parts-close-btn')?.addEventListener('click', () => {
                document.getElementById('tts-parts-modal').classList.add('hidden');
            });
            
            // Carregar vozes quando o provedor mudar
            document.getElementById('tts-provider-select')?.addEventListener('change', () => {
                loadTtsVoices();
                toggleDarkVozControls();
            });
            
            // Mostrar/ocultar controles do DarkVoz baseado no provedor
            function toggleDarkVozControls() {
                const providerSelect = document.getElementById('tts-provider-select');
                const darkVozControls = document.getElementById('darkvoz-controls');
                if (providerSelect && darkVozControls) {
                    if (providerSelect.value === 'laozhang') {
                        darkVozControls.style.display = 'block';
                    } else {
                        darkVozControls.style.display = 'none';
                    }
                }
            }
            
            // Inicializar controles do DarkVoz
            toggleDarkVozControls();
            
            // Carregar vozes quando a view é exibida
            const viewLinks = document.querySelectorAll('a[data-view]');
            viewLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const viewName = link.getAttribute('data-view');
                    if (viewName === 'gerador-voz') {
                        setTimeout(() => {
                            loadTtsVoices();
                        }, 100);
                    }
                    if (viewName === 'gerador-video') {
                        console.log('[Dashboard] Navegando para gerador de vídeo, inicializando...');
                        // Aguardar um pouco para garantir que o DOM está pronto
                        setTimeout(() => {
                            initVideoGenerator();
                        }, 200);
                    }
                    if (viewName === 'imagens-lote') {
                        console.log('[Dashboard] Navegando para imagens em lote, inicializando...');
                        // Resetar flag de inicialização quando a view é mostrada
                        batchTxtUploadInitialized = false;
                        
                        // Tentar múltiplas vezes para garantir que o DOM está pronto
                        let attempts = 0;
                        const maxAttempts = 10;
                        const trySetup = () => {
                            attempts++;
                            const uploadBtn = document.getElementById('batch-upload-txt-btn');
                            const generateBtn = document.getElementById('batch-btn-generate-images');
                            const textarea = document.getElementById('batch-image-prompts-textarea');
                            
                            console.log(`[Dashboard] Tentativa ${attempts}/${maxAttempts} - Elementos:`, {
                                uploadBtn: !!uploadBtn,
                                generateBtn: !!generateBtn,
                                textarea: !!textarea
                            });
                            
                            if ((uploadBtn && generateBtn && textarea) || attempts >= maxAttempts) {
                                try {
                                    setupBatchTxtUpload();
                                    if (typeof lucide !== 'undefined') lucide.createIcons();
                                    console.log('[Dashboard] Setup de imagens em lote concluído');
                                } catch (error) {
                                    console.error('[Dashboard] Erro ao inicializar imagens em lote:', error);
                                    console.error(error.stack);
                                }
                            } else {
                                setTimeout(trySetup, 200);
                            }
                        };
                        setTimeout(trySetup, 100);
                    }
                });
            });

            // === GERADOR DE VÍDEO ===
            let currentVideoOperationId = null;
            let currentVideoBlob = null;
            let currentVideoUri = null;
            let currentVideoConfig = null;
            let videoPollInterval = null;

            // Estado do gerador de vídeo
            const videoState = {
                mode: 'text-to-video',
                startFrame: null,
                endFrame: null,
                referenceImages: [],
                inputVideo: null,
                isLooping: false
            };

            // Função para converter arquivo para base64
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve({
                            base64: base64,
                            mimeType: file.type,
                            file: file
                        });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // Inicializar gerador de vídeo
            window.initVideoGenerator = function() {
                console.log('[Video Generator] ========== INICIANDO GERADOR DE VÍDEO ==========');
                
                // Verificar se a view está visível
                const viewElement = document.getElementById('view-gerador-video');
                if (!viewElement) {
                    console.error('[Video Generator] ❌ View não encontrada!');
                    return;
                }
                
                console.log('[Video Generator] View encontrada, display:', viewElement.style.display);
                
                // Aguardar um pouco para garantir que os elementos estão no DOM
                setTimeout(() => {
                    // Verificar elementos críticos antes de inicializar
                    const generateBtn = document.getElementById('video-generate-btn');
                    const settingsToggle = document.getElementById('video-settings-toggle');
                    const modelSelect = document.getElementById('video-model-select');
                    const promptInput = document.getElementById('video-prompt-input');
                    const settingsPanel = document.getElementById('video-settings-panel');
                    
                    console.log('[Video Generator] Verificando elementos:', {
                        view: !!viewElement,
                        viewDisplay: viewElement.style.display,
                        generateBtn: !!generateBtn,
                        generateBtnId: generateBtn?.id,
                        settingsToggle: !!settingsToggle,
                        settingsToggleId: settingsToggle?.id,
                        modelSelect: !!modelSelect,
                        modelSelectId: modelSelect?.id,
                        promptInput: !!promptInput,
                        settingsPanel: !!settingsPanel
                    });
                    
                    if (!generateBtn) {
                        console.error('[Video Generator] ❌ Botão Gerar Vídeo não encontrado!');
                    }
                    if (!settingsToggle) {
                        console.error('[Video Generator] ❌ Toggle de configurações não encontrado!');
                    }
                    if (!modelSelect) {
                        console.error('[Video Generator] ❌ Select de modelo não encontrado!');
                    }
                    
                    if (!generateBtn || !settingsToggle || !modelSelect) {
                        console.error('[Video Generator] ❌ Elementos críticos não encontrados! Tentando novamente em 500ms...');
                        setTimeout(() => initVideoGenerator(), 500);
                        return;
                    }
                    
                    // Atualizar UI baseado no modo
                    updateVideoModeUI();
                    
                    // Event listeners
                    setupVideoEventListeners();
                    
                    console.log('[Video Generator] ✅✅✅ GERADOR DE VÍDEO INICIALIZADO COM SUCESSO ✅✅✅');
                }, 300);
            }

            function updateVideoModeUI() {
                // Modo fixo: text-to-video
                const mode = 'text-to-video';
                const mediaUploads = document.getElementById('video-media-uploads');
                const framesSection = document.getElementById('frames-upload-section');
                const referencesSection = document.getElementById('references-upload-section');
                const extendSection = document.getElementById('extend-video-section');
                const aspectRatioSelect = document.getElementById('video-aspect-ratio-select');
                const resolutionSelect = document.getElementById('video-resolution-select');
                const modelSelect = document.getElementById('video-model-select');

                // Esconder todas as seções de upload
                if (framesSection) framesSection.classList.add('hidden');
                if (referencesSection) referencesSection.classList.add('hidden');
                if (extendSection) extendSection.classList.add('hidden');
                if (mediaUploads) mediaUploads.classList.add('hidden');

                // Text-to-video: habilitar proporção, resolução e modelo
                if (aspectRatioSelect) {
                    aspectRatioSelect.disabled = false;
                    aspectRatioSelect.removeAttribute('readonly');
                }
                if (resolutionSelect) {
                    resolutionSelect.disabled = false;
                    resolutionSelect.removeAttribute('readonly');
                }
                if (modelSelect) {
                    modelSelect.disabled = false;
                    modelSelect.removeAttribute('readonly');
                }

                videoState.mode = mode;
                console.log('[Video Generator] UI atualizada - modo:', mode);
            }

            function setupVideoEventListeners() {
                console.log('[Video Generator] Configurando event listeners...');
                
                // Modo fixo, não precisa de listener
                // document.getElementById('video-mode-select')?.addEventListener('change', updateVideoModeUI);

                // Toggle de configurações
                const settingsToggle = document.getElementById('video-settings-toggle');
                if (settingsToggle) {
                    // Remover listeners anteriores
                    const newToggle = settingsToggle.cloneNode(true);
                    settingsToggle.parentNode.replaceChild(newToggle, settingsToggle);
                    
                    newToggle.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Video Generator] ⚙️ Toggle de configurações clicado');
                        const panel = document.getElementById('video-settings-panel');
                        const toggleBtn = document.getElementById('video-settings-toggle');
                        const icon = toggleBtn?.querySelector('i');
                        if (panel) {
                            const isHidden = panel.classList.contains('hidden');
                            panel.classList.toggle('hidden');
                            console.log('[Video Generator] Painel de configurações:', isHidden ? 'expandido' : 'oculto');
                            if (icon) {
                                if (panel.classList.contains('hidden')) {
                                    icon.setAttribute('data-lucide', 'chevron-down');
                                } else {
                                    icon.setAttribute('data-lucide', 'chevron-up');
                                }
                                if (typeof lucide !== 'undefined') lucide.createIcons();
                            }
                        } else {
                            console.error('[Video Generator] ❌ Painel de configurações não encontrado!');
                        }
                    };
                    console.log('[Video Generator] ✅ Toggle de configurações configurado');
                } else {
                    console.error('[Video Generator] ❌ Botão de configurações não encontrado!');
                }

                // Upload de frame inicial
                document.getElementById('video-start-frame-btn')?.addEventListener('click', () => {
                    document.getElementById('video-start-frame').click();
                });
                document.getElementById('video-start-frame')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const base64Data = await fileToBase64(file);
                        videoState.startFrame = base64Data;
                        document.getElementById('video-start-frame-img').src = URL.createObjectURL(file);
                        document.getElementById('video-start-frame-preview').classList.remove('hidden');
                        document.getElementById('video-start-frame-btn').classList.add('hidden');
                    }
                });
                document.getElementById('video-start-frame-remove')?.addEventListener('click', () => {
                    videoState.startFrame = null;
                    document.getElementById('video-start-frame').value = '';
                    document.getElementById('video-start-frame-preview').classList.add('hidden');
                    document.getElementById('video-start-frame-btn').classList.remove('hidden');
                });

                // Upload de frame final
                document.getElementById('video-end-frame-btn')?.addEventListener('click', () => {
                    document.getElementById('video-end-frame').click();
                });
                document.getElementById('video-end-frame')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const base64Data = await fileToBase64(file);
                        videoState.endFrame = base64Data;
                        document.getElementById('video-end-frame-img').src = URL.createObjectURL(file);
                        document.getElementById('video-end-frame-preview').classList.remove('hidden');
                        document.getElementById('video-end-frame-btn').classList.add('hidden');
                    }
                });
                document.getElementById('video-end-frame-remove')?.addEventListener('click', () => {
                    videoState.endFrame = null;
                    document.getElementById('video-end-frame').value = '';
                    document.getElementById('video-end-frame-preview').classList.add('hidden');
                    document.getElementById('video-end-frame-btn').classList.remove('hidden');
                });

                // Checkbox de loop
                document.getElementById('video-loop-checkbox')?.addEventListener('change', (e) => {
                    videoState.isLooping = e.target.checked;
                });

                // Upload de referências
                document.getElementById('video-add-reference-btn')?.addEventListener('click', () => {
                    document.getElementById('video-reference-input').click();
                });
                document.getElementById('video-reference-input')?.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length + videoState.referenceImages.length > 3) {
                        showMessage('video-error-message', 'Máximo de 3 imagens de referência.', true);
                        return;
                    }
                    for (const file of files) {
                        const base64Data = await fileToBase64(file);
                        videoState.referenceImages.push(base64Data);
                        addReferenceImagePreview(base64Data, file);
                    }
                    e.target.value = '';
                });

                // Upload de vídeo de entrada (extend)
                document.getElementById('video-input-video-btn')?.addEventListener('click', () => {
                    document.getElementById('video-input-video').click();
                });
                document.getElementById('video-input-video')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const base64Data = await fileToBase64(file);
                        videoState.inputVideo = base64Data;
                        const preview = document.getElementById('video-input-video-preview-player');
                        preview.src = URL.createObjectURL(file);
                        document.getElementById('video-input-video-preview').classList.remove('hidden');
                        document.getElementById('video-input-video-btn').classList.add('hidden');
                    }
                });
                document.getElementById('video-input-video-remove')?.addEventListener('click', () => {
                    videoState.inputVideo = null;
                    document.getElementById('video-input-video').value = '';
                    document.getElementById('video-input-video-preview').classList.add('hidden');
                    document.getElementById('video-input-video-btn').classList.remove('hidden');
                });

                // Botão gerar
                const generateBtn = document.getElementById('video-generate-btn');
                if (generateBtn) {
                    // Remover listeners anteriores
                    const newGenerateBtn = generateBtn.cloneNode(true);
                    generateBtn.parentNode.replaceChild(newGenerateBtn, generateBtn);
                    
                    newGenerateBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Video Generator] 🎬 Botão Gerar Vídeo clicado');
                        if (typeof handleVideoGenerate === 'function') {
                            handleVideoGenerate();
                        } else {
                            console.error('[Video Generator] ❌ Função handleVideoGenerate não encontrada!');
                        }
                    };
                    console.log('[Video Generator] ✅ Botão Gerar Vídeo configurado');
                } else {
                    console.error('[Video Generator] ❌ Botão Gerar Vídeo não encontrado!');
                }

                // Botão reset
                const resetBtn = document.getElementById('video-reset-btn');
                if (resetBtn) {
                    // Remover listeners anteriores
                    const newResetBtn = resetBtn.cloneNode(true);
                    resetBtn.parentNode.replaceChild(newResetBtn, resetBtn);
                    
                    newResetBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('[Video Generator] 🗑️ Botão Limpar Tudo clicado');
                        if (typeof resetVideoGenerator === 'function') {
                            resetVideoGenerator();
                        } else {
                            console.error('[Video Generator] ❌ Função resetVideoGenerator não encontrada!');
                        }
                    };
                    console.log('[Video Generator] ✅ Botão Limpar Tudo configurado');
                } else {
                    console.warn('[Video Generator] ⚠️ Botão Limpar Tudo não encontrado');
                }

                // Botões de resultado
                document.getElementById('video-retry-btn')?.addEventListener('click', () => {
                    if (currentVideoConfig) {
                        handleVideoGenerate(currentVideoConfig);
                    }
                });
                document.getElementById('video-new-btn')?.addEventListener('click', resetVideoGenerator);
                document.getElementById('video-extend-btn')?.addEventListener('click', handleVideoExtend);
            }

            function addReferenceImagePreview(imageData, file) {
                const container = document.getElementById('video-reference-images');
                const preview = document.createElement('div');
                preview.className = 'relative w-32 h-32 group';
                preview.innerHTML = `
                    <img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover rounded-lg">
                    <button type="button" class="video-remove-reference absolute top-1 right-1 p-1 bg-red-600 rounded-full text-white opacity-0 group-hover:opacity-100 transition">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                const removeBtn = preview.querySelector('.video-remove-reference');
                removeBtn.addEventListener('click', () => {
                    const index = Array.from(container.children).indexOf(preview) - 1;
                    videoState.referenceImages.splice(index, 1);
                    preview.remove();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                });
                container.insertBefore(preview, container.lastElementChild);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // Esconder botão de adicionar se já tem 3
                if (videoState.referenceImages.length >= 3) {
                    document.getElementById('video-add-reference-btn').classList.add('hidden');
                }
            }

            async function handleVideoGenerate(config = null) {
                // Sempre pegar valores atuais do formulário
                const promptInput = document.getElementById('video-prompt-input');
                const prompt = promptInput ? promptInput.value.trim() : '';
                const mode = 'text-to-video'; // Modo fixo
                const model = document.getElementById('video-model-select').value;
                const aspectRatio = document.getElementById('video-aspect-ratio-select').value;
                const resolution = document.getElementById('video-resolution-select').value;

                console.log('[Frontend] Valores capturados:', { prompt: prompt ? `"${prompt.substring(0, 50)}..."` : 'VAZIO', mode, model, aspectRatio, resolution });

                // Validações - apenas text-to-video
                if (!prompt) {
                    showMessage('video-error-message', 'Por favor, descreva o vídeo que deseja criar.', true);
                    return;
                }

                // Sempre usar valores atuais do formulário, não o config passado
                currentVideoConfig = {
                    prompt: prompt || (config?.prompt || ''), // Usar prompt atual ou do config
                    model: model || config?.model || 'veo-3.1-fast',
                    aspectRatio: aspectRatio || config?.aspectRatio || '16:9',
                    resolution: resolution || config?.resolution || '720p',
                    mode: 'text-to-video', // Modo fixo
                    startFrame: null,
                    endFrame: null,
                    referenceImages: [],
                    inputVideo: null,
                    isLooping: false
                };

                console.log('[Frontend] Config final sendo enviado:', {
                    prompt: currentVideoConfig.prompt ? `"${currentVideoConfig.prompt.substring(0, 50)}..."` : 'VAZIO',
                    model: currentVideoConfig.model,
                    mode: currentVideoConfig.mode
                });

                // Mostrar modal de progresso
                const progressModal = document.getElementById('video-progress-modal');
                const progressStatus = document.getElementById('video-progress-status');
                const progressBar = document.getElementById('video-progress-bar');
                const progressPercentage = document.getElementById('video-progress-percentage');
                
                progressModal.classList.remove('hidden');
                if (progressStatus) progressStatus.textContent = 'Iniciando geração...';
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.classList.add('animate-pulse');
                }
                if (progressPercentage) progressPercentage.textContent = '0%';

                try {
                    const response = await fetch(`${API_BASE}/api/video/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(currentVideoConfig)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Erro ao iniciar geração');
                    }

                    const data = await response.json();
                    
                    // Se o vídeo já estiver pronto (resposta direta da Laozhang.ai)
                    if (data.status === 'completed' && data.videoUri) {
                        console.log('[Frontend] ✅ Vídeo recebido diretamente na resposta:', data.videoUri);
                        currentVideoOperationId = data.operationId || `direct-${Date.now()}`;
                        currentVideoUri = data.videoUri;
                        
                        // Exibir vídeo diretamente
                        displayVideoResult(data.videoUri);
                        return;
                    }
                    
                    currentVideoOperationId = data.operationId;

                    // Iniciar polling com intervalo menor para atualização em tempo real
                    if (videoPollInterval) clearInterval(videoPollInterval);
                    // Polling a cada 1 segundo para atualização mais rápida do progresso
                    pollVideoStatus(); // Primeira verificação imediata
                    videoPollInterval = setInterval(pollVideoStatus, 1000);

                } catch (error) {
                    console.error('Erro ao gerar vídeo:', error);
                    showMessage('video-error-message', error.message || 'Erro ao gerar vídeo.', true);
                    document.getElementById('video-progress-modal').classList.add('hidden');
                }
            }

            async function pollVideoStatus() {
                if (!currentVideoOperationId) return;

                try {
                    // Codificar o operationId para lidar com barras e caracteres especiais
                    const encodedOperationId = encodeURIComponent(currentVideoOperationId);
                    const response = await fetch(`${API_BASE}/api/video/status/${encodedOperationId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Erro ao verificar status');
                    }

                    const data = await response.json();
                    
                    console.log('[Frontend] Status recebido:', data.status, {
                        hasVideoUri: !!data.videoUri,
                        hasVideoBase64: !!data.videoBase64,
                        videoUri: data.videoUri ? data.videoUri.substring(0, 100) : null
                    });

                    if (data.status === 'completed') {
                        // Vídeo pronto!
                        clearInterval(videoPollInterval);
                        videoPollInterval = null;

                        // Salvar URI do vídeo para possível extensão
                        currentVideoUri = data.videoUri;

                        // Se tiver base64, usar para exibição
                        if (data.videoBase64) {
                            const videoBlob = base64ToBlob(data.videoBase64, data.videoMimeType || 'video/mp4');
                            currentVideoBlob = videoBlob;

                            const videoUrl = URL.createObjectURL(videoBlob);
                            document.getElementById('video-result-player').src = videoUrl;
                            document.getElementById('video-download-link').href = videoUrl;
                            document.getElementById('video-download-link').download = `video-${Date.now()}.mp4`;
                        } else if (data.videoUri) {
                            // Se não tiver base64 mas tiver URI, usar diretamente
                            // URLs da Laozhang.ai (aliyuncs.com) podem ser usadas diretamente
                            console.log('[Frontend] Usando vídeo URI diretamente:', data.videoUri);
                            displayVideoResult(data.videoUri);
                        }

                        // Atualizar barra de progresso para 100%
                        const progressBar = document.getElementById('video-progress-bar');
                        const progressPercentage = document.getElementById('video-progress-percentage');
                        if (progressBar) {
                            progressBar.style.width = '100%';
                            progressBar.style.animation = 'none';
                        }
                        if (progressPercentage) {
                            progressPercentage.textContent = '100%';
                        }

                        document.getElementById('video-progress-modal').classList.add('hidden');
                        document.getElementById('video-result-section').classList.remove('hidden');
                        document.getElementById('video-extend-btn').style.display = 
                            currentVideoConfig.resolution === '720p' ? 'inline-flex' : 'none';

                        showMessage('video-success-message', 'Vídeo gerado com sucesso!');
                    } else if (data.status === 'error') {
                        clearInterval(videoPollInterval);
                        videoPollInterval = null;
                        document.getElementById('video-progress-modal').classList.add('hidden');
                        showMessage('video-error-message', data.error || 'Erro ao gerar vídeo.', true);
                    } else {
                        // Ainda processando - atualizar com progresso se disponível
                        const progressStatus = document.getElementById('video-progress-status');
                        const progressBar = document.getElementById('video-progress-bar');
                        const progressDetails = document.getElementById('video-progress-details');
                        
                        if (data.progress !== undefined && data.progress !== null) {
                            const progressPercent = Math.min(100, Math.max(0, parseFloat(data.progress)));
                            const progressText = data.progressMessage || `Gerando vídeo... ${progressPercent.toFixed(1)}%`;
                            
                            // Atualizar texto de status
                            if (progressStatus) {
                                progressStatus.textContent = progressText;
                            }
                            
                            // Atualizar barra de progresso com gradiente laranja
                            if (progressBar) {
                                progressBar.style.width = `${progressPercent}%`;
                                progressBar.style.transition = 'width 0.5s ease-out';
                                // Remover animação de pulse quando há progresso real
                                progressBar.classList.remove('animate-pulse');
                                // Gradiente laranja conforme a porcentagem
                                progressBar.style.background = `linear-gradient(to right, #f59e0b, #fb923c, #f97316)`;
                                progressBar.style.backgroundSize = '200% 100%';
                                // Adicionar animação de gradiente se progresso > 0
                                if (progressPercent > 0 && progressPercent < 100) {
                                    progressBar.style.animation = 'gradient-shift 2s ease infinite';
                                } else {
                                    progressBar.style.animation = 'none';
                                }
                                console.log('[Video Generator] 📊 Progresso atualizado:', progressPercent.toFixed(1) + '%');
                            }
                            
                            // Atualizar porcentagem no centro da barra
                            const progressPercentage = document.getElementById('video-progress-percentage');
                            if (progressPercentage) {
                                progressPercentage.textContent = `${progressPercent.toFixed(1)}%`;
                                // Destacar quando próximo de 100%
                                if (progressPercent >= 95) {
                                    progressPercentage.classList.add('text-green-400', 'font-bold');
                                } else {
                                    progressPercentage.classList.remove('text-green-400', 'font-bold');
                                }
                            }
                            
                            // Atualizar detalhes
                            if (progressDetails) {
                                progressDetails.textContent = `${progressPercent.toFixed(1)}% concluído...`;
                            }
                        } else {
                            // Sem progresso específico, usar mensagem genérica
                            if (progressStatus) {
                                progressStatus.textContent = 'Gerando vídeo... Isso pode levar alguns minutos.';
                            }
                            if (progressBar) {
                                progressBar.style.width = '100%';
                            }
                            if (progressDetails) {
                                progressDetails.textContent = 'Processando...';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                }
            }

            function base64ToBlob(base64, mimeType) {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                return new Blob([byteArray], { type: mimeType });
            }

            function displayVideoResult(videoUri) {
                console.log('[Frontend] Exibindo vídeo:', videoUri);
                
                // Verificar se os elementos existem
                const videoPlayer = document.getElementById('video-result-player');
                const videoDownloadLink = document.getElementById('video-download-link');
                const videoResultSection = document.getElementById('video-result-section');
                const videoProgressModal = document.getElementById('video-progress-modal');
                
                if (!videoPlayer || !videoDownloadLink || !videoResultSection) {
                    console.error('[Frontend] Elementos do vídeo não encontrados!');
                    return;
                }
                
                // URLs da Laozhang.ai (aliyuncs.com) podem ser usadas diretamente
                // Não precisamos baixar via backend
                videoPlayer.src = videoUri;
                videoDownloadLink.href = videoUri;
                videoDownloadLink.download = `video-${Date.now()}.mp4`;
                
                // Salvar URI para possível extensão
                currentVideoUri = videoUri;
                
                // Esconder modal de progresso e mostrar resultado
                if (videoProgressModal) {
                    videoProgressModal.classList.add('hidden');
                }
                videoResultSection.classList.remove('hidden');
                
                // Ajustar botão de estender baseado na resolução
                const videoExtendBtn = document.getElementById('video-extend-btn');
                if (videoExtendBtn && currentVideoConfig) {
                    videoExtendBtn.style.display = 
                        currentVideoConfig.resolution === '720p' ? 'inline-flex' : 'none';
                }
                
                // Mostrar mensagem de sucesso
                showMessage('video-success-message', 'Vídeo gerado com sucesso!');
                
                // Parar polling se estiver ativo
                if (videoPollInterval) {
                    clearInterval(videoPollInterval);
                    videoPollInterval = null;
                }
                
                console.log('[Frontend] ✅ Vídeo exibido com sucesso!');
            }

            async function handleVideoExtend() {
                if (!currentVideoUri) {
                    showMessage('video-error-message', 'Nenhum vídeo disponível para estender. Você precisa ter gerado um vídeo anteriormente.', true);
                    return;
                }

                console.log('[Frontend] Preparando para estender vídeo:', currentVideoUri);

                // Mudar modo para extend-video
                videoState.mode = 'extend-video';
                // Modo fixo: text-to-video (não suporta extend-video)
                // Sugerir prompt que enfatiza continuar o vídeo
                document.getElementById('video-prompt-input').value = 'Continue o vídeo de forma natural e fluida, mantendo a mesma cena, personagens e estilo visual.';
                document.getElementById('video-prompt-input').placeholder = 'Descreva a continuação natural do vídeo (opcional - deixe vazio para continuação automática)...';
                updateVideoModeUI();
                
                // Configurar vídeo de entrada usando URI diretamente
                // O backend irá processar o vídeo e extrair o último frame se necessário
                videoState.inputVideo = {
                    uri: currentVideoUri
                };

                console.log('[Frontend] Vídeo de entrada configurado com URI:', currentVideoUri);

                // Mostrar preview do vídeo usando URI diretamente
                // Não tentamos baixar o vídeo no frontend devido a CORS
                    const preview = document.getElementById('video-input-video-preview-player');
                const previewContainer = document.getElementById('video-input-video-preview');
                const uploadBtn = document.getElementById('video-input-video-btn');
                
                if (preview && currentVideoUri) {
                    // Tentar usar blob local primeiro (sem problemas de CORS)
                    if (currentVideoBlob) {
                    preview.src = URL.createObjectURL(currentVideoBlob);
                        previewContainer.classList.remove('hidden');
                        uploadBtn.classList.add('hidden');
                    } else if (currentVideoUri) {
                        // Tentar usar URI diretamente - pode falhar por CORS, mas não é crítico
                        // O importante é que o backend receberá o URI corretamente
                        preview.src = currentVideoUri;
                        preview.crossOrigin = 'anonymous';
                        previewContainer.classList.remove('hidden');
                        uploadBtn.classList.add('hidden');
                        
                        // Se houver erro de CORS, não é crítico - o backend processará o vídeo
                        preview.onerror = () => {
                            console.warn('[Frontend] Erro ao carregar preview (CORS), mas o vídeo será processado pelo backend');
                            // Mostrar mensagem informativa
                            const errorMsg = document.createElement('div');
                            errorMsg.className = 'text-yellow-500 text-sm mt-2';
                            errorMsg.textContent = 'Preview não disponível (CORS), mas o vídeo será processado corretamente pelo backend.';
                            previewContainer.appendChild(errorMsg);
                        };
                    }
                }

                // Esconder seção de resultado e mostrar formulário
                document.getElementById('video-result-section').classList.add('hidden');
                
                // Scroll para o topo do formulário
                const videoSection = document.getElementById('view-video-generator');
                if (videoSection) {
                    videoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                showMessage('video-success-message', 'Vídeo carregado! Digite a descrição da continuação e clique em "Gerar Vídeo". O último frame será extraído automaticamente pelo backend.');
            }

            // Função para extrair o último frame de um vídeo
            function extractLastFrameFromVideo(videoBlob) {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.muted = true;
                    video.playsInline = true;

                    video.onloadedmetadata = () => {
                        // Ir para o último frame (99% do vídeo para garantir que pegamos o último frame visível)
                        video.currentTime = Math.max(0, video.duration * 0.99);
                    };

                    video.onseeked = () => {
                        try {
                            // Criar canvas para capturar o frame
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                            // Converter para base64
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    // Converter blob para base64
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                        const base64 = reader.result.split(',')[1];
                                        resolve(base64);
                                    };
                                    reader.onerror = reject;
                                    reader.readAsDataURL(blob);
                                } else {
                                    reject(new Error('Não foi possível capturar o frame'));
                                }
                            }, 'image/jpeg', 0.95);
                        } catch (error) {
                            reject(error);
                        }
                    };

                    video.onerror = (error) => {
                        reject(error);
                    };

                    video.src = URL.createObjectURL(videoBlob);
                });
            }

            function resetVideoGenerator() {
                videoState.mode = 'text-to-video';
                videoState.startFrame = null;
                videoState.endFrame = null;
                videoState.referenceImages = [];
                videoState.inputVideo = null;
                videoState.isLooping = false;
                currentVideoOperationId = null;
                currentVideoBlob = null;
                currentVideoUri = null;
                currentVideoConfig = null;

                if (videoPollInterval) {
                    clearInterval(videoPollInterval);
                    videoPollInterval = null;
                }

                // Modo fixo: text-to-video
                document.getElementById('video-prompt-input').value = '';
                document.getElementById('video-start-frame').value = '';
                document.getElementById('video-end-frame').value = '';
                document.getElementById('video-reference-input').value = '';
                document.getElementById('video-input-video').value = '';
                document.getElementById('video-loop-checkbox').checked = false;

                document.getElementById('video-start-frame-preview').classList.add('hidden');
                document.getElementById('video-start-frame-btn').classList.remove('hidden');
                document.getElementById('video-end-frame-preview').classList.add('hidden');
                document.getElementById('video-end-frame-btn').classList.remove('hidden');
                document.getElementById('video-input-video-preview').classList.add('hidden');
                document.getElementById('video-input-video-btn').classList.remove('hidden');

                const refContainer = document.getElementById('video-reference-images');
                while (refContainer.children.length > 1) {
                    refContainer.removeChild(refContainer.firstChild);
                }
                document.getElementById('video-add-reference-btn').classList.remove('hidden');

                document.getElementById('video-result-section').classList.add('hidden');
                document.getElementById('video-progress-modal').classList.add('hidden');

                updateVideoModeUI();
            }

            // ==================== FUNÇÕES PARA AGENTES VIRAIS ====================
            let currentViralAgent = null;
            let currentViralConversation = null;
            let editingViralField = null;

            async function loadViralAgents() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao carregar agentes');

                    const data = await response.json();
                    renderViralAgents(data.agents);
                } catch (error) {
                    console.error('Erro:', error);
                    document.getElementById('viral-agents-list').innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <p class="text-red-400">Erro ao carregar agentes: ${error.message}</p>
                        </div>
                    `;
                }
            }

            function renderViralAgents(agents) {
                const container = document.getElementById('viral-agents-list');
                if (agents.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <p class="text-gray-400 mb-4">Nenhum agente criado ainda</p>
                            <button onclick="openCreateViralAgentModal()" class="px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200">
                                Criar Primeiro Agente
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = agents.map(agent => `
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-lg p-6 cursor-pointer hover:border-amber-500 transition" onclick="openViralAgent(${agent.id})">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white mb-1">${escapeHtml(agent.name)}</h3>
                                ${agent.description ? `<p class="text-sm text-gray-400">${escapeHtml(agent.description)}</p>` : ''}
                                ${agent.niche || agent.subniche ? `
                                    <div class="flex items-center gap-2 mt-2">
                                        ${agent.niche ? `<span class="px-2 py-1 bg-amber-500/20 text-amber-400 text-xs rounded">${escapeHtml(agent.niche)}</span>` : ''}
                                        ${agent.subniche ? `<span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">${escapeHtml(agent.subniche)}</span>` : ''}
                                    </div>
                                ` : ''}
                                ${agent.formula_json ? `<span class="inline-block mt-2 px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">✓ Fórmula Viral</span>` : ''}
                            </div>
                            ${agent.is_favorite ? '<i data-lucide="star" class="text-amber-500 fill-amber-500"></i>' : ''}
                        </div>
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span><i data-lucide="file-text"></i> ${agent.file_count || 0} arquivos</span>
                            <span><i data-lucide="message-square"></i> ${agent.conversation_count || 0} conversas</span>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            ${formatDate(agent.updated_at)}
                        </div>
                    </div>
                `).join('');

                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Tornar função globalmente acessível
            window.openViralAgent = async function(agentId) {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${agentId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao carregar agente');

                    const data = await response.json();
                    currentViralAgent = data.agent;
                    
                    showViralAgentsDetailView();
                    loadViralAgentData();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao carregar agente');
                }
            };

            function loadViralAgentData() {
                if (!currentViralAgent) return;

                const nameHeader = document.getElementById('viral-agent-name-header');
                const descHeader = document.getElementById('viral-agent-description-header');
                const memoryEl = document.getElementById('viral-agent-memory');
                const instructionsEl = document.getElementById('viral-agent-instructions');
                
                if (nameHeader) nameHeader.textContent = currentViralAgent.name;
                if (descHeader) descHeader.textContent = currentViralAgent.description || '';
                if (memoryEl) {
                    memoryEl.textContent = currentViralAgent.memory || 'Nenhuma memória definida';
                    // Adicionar data de atualização se houver
                    const memoryUpdated = document.getElementById('viral-memory-updated');
                    if (memoryUpdated && currentViralAgent.updated_at) {
                        const daysAgo = Math.floor((new Date() - new Date(currentViralAgent.updated_at)) / (1000 * 60 * 60 * 24));
                        memoryUpdated.textContent = daysAgo === 0 ? 'Última atualização hoje' : `Última atualização há ${daysAgo} ${daysAgo === 1 ? 'dia' : 'dias'}`;
                    }
                }
                if (instructionsEl) instructionsEl.textContent = currentViralAgent.instructions || 'Nenhuma instrução definida';
                
                // Favorito
                const favoriteBtn = document.getElementById('viral-favorite-btn');
                if (favoriteBtn) {
                    const icon = favoriteBtn.querySelector('i');
                    if (icon) {
                        if (currentViralAgent.is_favorite) {
                            icon.classList.add('text-amber-500', 'fill-amber-500');
                        } else {
                            icon.classList.remove('text-amber-500', 'fill-amber-500');
                        }
                    }
                }

                // Arquivos
                renderViralFiles(currentViralAgent.files || []);
                
                // Conversas
                renderViralConversations(currentViralAgent.conversations || []);

                // Criar nova conversa se não houver
                if (!currentViralConversation && (!currentViralAgent.conversations || currentViralAgent.conversations.length === 0)) {
                    createNewViralConversation();
                } else if (currentViralAgent.conversations && currentViralAgent.conversations.length > 0) {
                    currentViralConversation = currentViralAgent.conversations[0].id;
                    loadViralMessages(currentViralConversation);
                }
            }

            function renderViralFiles(files) {
                const container = document.getElementById('viral-agent-files');
                if (!container) return;
                
                if (files.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Nenhum arquivo</p>';
                    return;
                }

                container.innerHTML = files.map(file => `
                    <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-white">${escapeHtml(file.file_name)}</p>
                            <p class="text-xs text-gray-500">${file.file_size || 0} bytes</p>
                        </div>
                        <button onclick="deleteViralFile(${file.id})" class="text-red-400 hover:text-red-300">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                `).join('');

                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            function renderViralConversations(conversations) {
                const container = document.getElementById('viral-conversations-list');
                if (!container) return;
                
                if (conversations.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Nenhuma conversa</p>';
                    return;
                }

                container.innerHTML = conversations.map(conv => `
                    <div class="p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition ${currentViralConversation === conv.id ? 'border border-amber-500' : ''} group relative" 
                         onclick="loadViralConversation(${conv.id})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-white">${escapeHtml(conv.title || 'Nova Conversa')}</p>
                                <p class="text-xs text-gray-500 mt-1">${formatDate(conv.updated_at)}</p>
                            </div>
                            <button onclick="event.stopPropagation(); deleteViralConversation(${conv.id})" class="opacity-0 group-hover:opacity-100 transition-opacity p-1.5 text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded" title="Deletar conversa">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            window.deleteViralConversation = async function(conversationId) {
                if (!currentViralAgent) return;
                if (!confirm('Tem certeza que deseja deletar esta conversa?')) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations/${conversationId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao deletar conversa');
                    }

                    // Se a conversa deletada era a atual, limpar chat
                    if (currentViralConversation === conversationId) {
                        currentViralConversation = null;
                        const container = document.getElementById('viral-chat-messages');
                        if (container) container.innerHTML = '';
                    }

                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao deletar conversa: ' + error.message);
                }
            };

            // Tornar funções globalmente acessíveis
            window.showViralAgentsListView = function() {
                document.getElementById('viral-agents-list-view').style.display = 'block';
                document.getElementById('viral-agents-detail-view').style.display = 'none';
                currentViralAgent = null;
                currentViralConversation = null;
            };

            window.showViralAgentsDetailView = function() {
                document.getElementById('viral-agents-list-view').style.display = 'none';
                document.getElementById('viral-agents-detail-view').style.display = 'block';
            };

            window.showViralChatTab = function() {
                document.getElementById('viral-tab-content-chat').style.display = 'block';
                document.getElementById('viral-tab-content-conversations').style.display = 'none';
                document.getElementById('viral-tab-chat').classList.add('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-chat').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('viral-tab-conversations').classList.remove('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-conversations').classList.add('border-transparent', 'text-gray-400');
            };

            window.showViralConversationsTab = function() {
                document.getElementById('viral-tab-content-chat').style.display = 'none';
                document.getElementById('viral-tab-content-conversations').style.display = 'block';
                document.getElementById('viral-tab-conversations').classList.add('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-conversations').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('viral-tab-chat').classList.remove('border-amber-500', 'text-amber-500');
                document.getElementById('viral-tab-chat').classList.add('border-transparent', 'text-gray-400');
            };

            // Tornar função globalmente acessível
            window.openCreateViralAgentModal = function() {
                // Criar modal de criação de agente
                const modalHTML = `
                    <div id="viral-agent-create-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Novo Agente Viral</h3>
                                <button onclick="closeViralAgentCreateModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <form id="viral-agent-create-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Agente *</label>
                                    <input type="text" id="viral-agent-name-input" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ex: Agente de Histórias Emocionantes">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Descrição</label>
                                    <input type="text" id="viral-agent-description-input" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ex: Roteiro viral para canal de histórias">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Memória</label>
                                    <textarea id="viral-agent-memory-input" rows="4" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="Informações que o agente deve lembrar..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Instruções</label>
                                    <textarea id="viral-agent-instructions-input" rows="6" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="Instruções para o agente..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo de IA</label>
                                    <select id="viral-agent-model-input" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="gpt-4o" selected>GPT-4o (2025)</option>
                                        <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (Fev/25)</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (2025)</option>
                                    </select>
                                </div>
                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" onclick="closeViralAgentCreateModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                    <button type="submit" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Criar Agente</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Remover modal existente se houver
                const existingModal = document.getElementById('viral-agent-create-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Adicionar modal ao body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Criar ícones
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // Adicionar event listener ao formulário
                document.getElementById('viral-agent-create-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveViralAgent();
                });
            };
            
            window.closeViralAgentCreateModal = function() {
                const modal = document.getElementById('viral-agent-create-modal');
                if (modal) {
                    modal.remove();
                }
            };
            
            async function saveViralAgent() {
                const name = document.getElementById('viral-agent-name-input').value.trim();
                if (!name) {
                    alert('Nome do agente é obrigatório');
                    return;
                }

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name,
                            description: document.getElementById('viral-agent-description-input').value.trim(),
                            memory: document.getElementById('viral-agent-memory-input').value.trim(),
                            instructions: document.getElementById('viral-agent-instructions-input').value.trim(),
                            model: document.getElementById('viral-agent-model-input').value
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao criar agente');
                    }

                    closeViralAgentCreateModal();
                    loadViralAgents();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao criar agente: ' + error.message);
                }
            }

            window.openEditViralAgentModal = function() {
                if (!currentViralAgent) return;
                
                const modalHTML = `
                    <div id="viral-edit-agent-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Editar Agente</h3>
                                <button onclick="closeViralEditAgentModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <form id="viral-edit-agent-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Agente *</label>
                                    <input type="text" id="viral-edit-agent-name" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" value="${escapeHtml(currentViralAgent.name)}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Descrição</label>
                                    <input type="text" id="viral-edit-agent-description" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" value="${escapeHtml(currentViralAgent.description || '')}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Modelo de IA</label>
                                    <select id="viral-edit-agent-model" class="styled-select w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500">
                                        <option value="gpt-4o" ${currentViralAgent.model === 'gpt-4o' ? 'selected' : ''}>GPT-4o (2025)</option>
                                        <option value="claude-3-7-sonnet-20250219" ${currentViralAgent.model === 'claude-3-7-sonnet-20250219' ? 'selected' : ''}>Claude 3.7 Sonnet (Fev/25)</option>
                                        <option value="gemini-2.5-pro" ${currentViralAgent.model === 'gemini-2.5-pro' ? 'selected' : ''}>Gemini 2.5 Pro (2025)</option>
                                    </select>
                                </div>
                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" onclick="closeViralEditAgentModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                    <button onclick="saveViralAgentEdit()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-edit-agent-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralEditAgentModal = function() {
                const modal = document.getElementById('viral-edit-agent-modal');
                if (modal) modal.remove();
            };
            
            window.saveViralAgentEdit = async function() {
                if (!currentViralAgent) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: document.getElementById('viral-edit-agent-name').value.trim(),
                            description: document.getElementById('viral-edit-agent-description').value.trim(),
                            model: document.getElementById('viral-edit-agent-model').value
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao salvar');
                    }

                    closeViralEditAgentModal();
                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao salvar: ' + error.message);
                }
            };

            window.deleteViralAgent = async function() {
                if (!currentViralAgent) return;
                const confirmed = await showCustomConfirm('Tem certeza que deseja deletar este agente?');
                if (!confirmed) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao deletar agente');

                    showViralAgentsListView();
                    loadViralAgents();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao deletar agente');
                }
            };

            window.toggleViralAgentFavorite = async function() {
                if (!currentViralAgent) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            is_favorite: !currentViralAgent.is_favorite
                        })
                    });

                    if (!response.ok) throw new Error('Erro ao atualizar favorito');

                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao atualizar favorito');
                }
            };

            window.editViralMemory = function() {
                if (!currentViralAgent) return;
                editingViralField = 'memory';
                
                const modalHTML = `
                    <div id="viral-edit-field-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Editar Memória</h3>
                                <button onclick="closeViralEditFieldModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <textarea id="viral-edit-field-content" rows="12" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none" placeholder="Informações que o agente deve lembrar...">${escapeHtml(currentViralAgent.memory || '')}</textarea>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeViralEditFieldModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                <button onclick="saveViralField()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Salvar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-edit-field-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };

            window.editViralInstructions = function() {
                if (!currentViralAgent) return;
                editingViralField = 'instructions';
                
                const modalHTML = `
                    <div id="viral-edit-field-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Editar Instruções</h3>
                                <button onclick="closeViralEditFieldModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <textarea id="viral-edit-field-content" rows="16" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none font-mono text-sm" placeholder="Instruções para o agente...">${escapeHtml(currentViralAgent.instructions || '')}</textarea>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeViralEditFieldModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                <button onclick="saveViralField()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Salvar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-edit-field-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralEditFieldModal = function() {
                const modal = document.getElementById('viral-edit-field-modal');
                if (modal) modal.remove();
                editingViralField = null;
            };
            
            window.saveViralField = async function() {
                if (!currentViralAgent || !editingViralField) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const content = document.getElementById('viral-edit-field-content').value.trim();
                    
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            [editingViralField]: content
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao salvar');
                    }

                    closeViralEditFieldModal();
                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao salvar: ' + error.message);
                }
            };

            window.addViralFile = function() {
                if (!currentViralAgent) return;
                
                const modalHTML = `
                    <div id="viral-add-file-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-white">Adicionar Arquivo</h3>
                                <button onclick="closeViralAddFileModal()" class="text-gray-400 hover:text-white">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Nome do Arquivo *</label>
                                    <input type="text" id="viral-file-name-input" required class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ex: exemplo.txt">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Conteúdo *</label>
                                    <textarea id="viral-file-content-input" rows="12" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none font-mono text-sm" placeholder="Cole ou digite o conteúdo do arquivo..."></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="closeViralAddFileModal()" class="py-2 px-4 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold">Cancelar</button>
                                <button onclick="saveViralFile()" class="py-2 px-4 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold">Adicionar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('viral-add-file-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralAddFileModal = function() {
                const modal = document.getElementById('viral-add-file-modal');
                if (modal) modal.remove();
            };
            
            window.saveViralFile = async function() {
                if (!currentViralAgent) return;

                const fileName = document.getElementById('viral-file-name-input').value.trim();
                const fileContent = document.getElementById('viral-file-content-input').value.trim();

                if (!fileName || !fileContent) {
                    alert('Nome e conteúdo do arquivo são obrigatórios');
                    return;
                }

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/files`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            file_name: fileName,
                            file_content: fileContent,
                            file_type: 'text/plain',
                            file_size: fileContent.length
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao adicionar arquivo');
                    }

                    closeViralAddFileModal();
                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao adicionar arquivo: ' + error.message);
                }
            };

            window.deleteViralFile = async function(fileId) {
                if (!confirm('Tem certeza que deseja deletar este arquivo?')) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/files/${fileId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao deletar arquivo');

                    await openViralAgent(currentViralAgent.id);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao deletar arquivo');
                }
            };

            window.createNewViralConversation = async function() {
                if (!currentViralAgent) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: 'Nova Conversa'
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao criar conversa');
                    }

                    const data = await response.json();
                    currentViralConversation = data.conversation.id;
                    await openViralAgent(currentViralAgent.id);
                    await loadViralMessages(currentViralConversation);
                    showViralChatTab();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao criar conversa: ' + error.message);
                }
            };

            window.loadViralConversation = async function(conversationId) {
                currentViralConversation = conversationId;
                await loadViralMessages(conversationId);
                showViralChatTab();
            };

            async function loadViralMessages(conversationId) {
                if (!currentViralAgent || !conversationId) return;

                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations/${conversationId}/messages`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) throw new Error('Erro ao carregar mensagens');

                    const data = await response.json();
                    renderViralMessages(data.messages);
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao carregar mensagens');
                }
            }

            // Armazenar mensagens globalmente para acesso na função de copiar
            let currentViralMessages = [];
            
            function renderViralMessages(messages) {
                const container = document.getElementById('viral-chat-messages');
                if (!container) return;
                
                // Armazenar mensagens para acesso posterior
                currentViralMessages = messages;
                
                container.innerHTML = messages.map((msg, index) => `
                    <div class="p-3 rounded-lg ${msg.role === 'user' ? 'bg-amber-500/20 border border-amber-500/30 ml-auto max-w-[80%]' : 'bg-gray-800 border border-gray-700 mr-auto max-w-[80%]'} relative group">
                        <p class="text-sm text-white whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                        ${msg.role === 'assistant' ? `
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                <button onclick="copyViralMessage(${index})" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Copiar roteiro">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                                <button onclick="openViralMarkdown()" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Ver roteiro completo em MD">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                container.scrollTop = container.scrollHeight;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            window.showViralRoteiroCompleteModal = function(nota, checklist, roteiro) {
                // Definir checklist padrão se não vier
                const checklistData = checklist || {
                    gancho_inicial: false,
                    estrutura_narrativa: false,
                    engajamento_emocional: false,
                    densidade_valor: false,
                    tecnicas_retencao: false,
                    linguagem_tom: false,
                    elementos_estruturais: false,
                    loops_abertos: false,
                    variacao_emocional: false,
                    final_satisfatorio: false
                };
                
                const checklistItems = [
                    { key: 'gancho_inicial', label: '1. GANCHO INICIAL (0-30 segundos)', desc: 'Abertura magnética que cria "lacuna de curiosidade". Promessa clara do valor do vídeo.' },
                    { key: 'estrutura_narrativa', label: '2. ESTRUTURA NARRATIVA', desc: 'Arco dramático completo, ritmo variado, transições fluidas.' },
                    { key: 'engajamento_emocional', label: '3. ENGAJAMENTO EMOCIONAL', desc: 'Apelo a emoções primárias, personagens identificáveis, stakes claros.' },
                    { key: 'densidade_valor', label: '4. DENSIDADE DE VALOR', desc: 'Informação surpreendente a cada 30-60s, especificidade, sem enchimento.' },
                    { key: 'tecnicas_retencao', label: '5. TÉCNICAS DE RETENÇÃO', desc: 'Pattern interrupts, foreshadowing, cliffhangers internos, payoff satisfatório.' },
                    { key: 'linguagem_tom', label: '6. LINGUAGEM E TOM', desc: 'Voz ativa, frases variadas, naturalidade, vocabulário acessível.' },
                    { key: 'elementos_estruturais', label: '7. ELEMENTOS ESTRUTURAIS', desc: 'Duração otimizada, CTA orgânica, final memorável.' },
                    { key: 'loops_abertos', label: '8. LOOPS ABERTOS', desc: 'Loops abertos sendo fechados no momento certo.' },
                    { key: 'variacao_emocional', label: '9. VARIAÇÃO EMOCIONAL', desc: 'A emoção varia ao longo do roteiro.' },
                    { key: 'final_satisfatorio', label: '10. FINAL SATISFATÓRIO', desc: 'Todas as promessas cumpridas, final memorável.' }
                ];
                
                const modalHTML = `
                    <div id="viral-roteiro-complete-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 overflow-y-auto">
                        <div class="bg-gray-900 border border-gray-700 rounded-lg p-8 max-w-2xl w-full mx-4 my-8">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="check-circle" class="w-10 h-10 text-amber-500"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Roteiro Finalizado!</h3>
                                <p class="text-gray-400">Seu roteiro foi gerado com sucesso</p>
                            </div>
                            
                            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                                <div class="flex items-center justify-between mb-6">
                                    <span class="text-gray-400 text-lg">Nota do Roteiro</span>
                                    <span class="text-4xl font-bold text-amber-500">${nota || 0}/10</span>
                                </div>
                                
                                <div class="border-t border-gray-700 pt-4">
                                    <h4 class="text-white font-semibold mb-4">Checklist de Avaliação</h4>
                                    <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${checklistItems.map(item => `
                                            <div class="flex items-start space-x-3 p-3 rounded-lg ${checklistData[item.key] ? 'bg-amber-500/10 border border-amber-500/30' : 'bg-gray-700/50 border border-gray-600/30'}">
                                                <div class="flex-shrink-0 mt-0.5">
                                                    <input type="checkbox" ${checklistData[item.key] ? 'checked' : ''} disabled class="w-5 h-5 rounded border-gray-600 bg-gray-800 text-amber-500 focus:ring-amber-500 focus:ring-offset-gray-900 cursor-not-allowed">
                                                </div>
                                                <div class="flex-1">
                                                    <label class="text-sm font-medium text-white cursor-not-allowed">${item.label}</label>
                                                    <p class="text-xs text-gray-400 mt-1">${item.desc}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="copyViralRoteiroFromModal()" class="flex-1 px-6 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-white font-semibold transition duration-200 flex items-center justify-center space-x-2">
                                    <i data-lucide="copy" class="w-5 h-5"></i>
                                    <span>Copiar</span>
                                </button>
                                <button onclick="downloadViralRoteiro()" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-lg transition duration-200 flex items-center justify-center space-x-2">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                    <span>Baixar</span>
                                </button>
                            </div>
                            
                            <button onclick="closeViralRoteiroCompleteModal()" class="w-full mt-4 px-4 py-2 text-gray-400 hover:text-white transition">
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                // Armazenar roteiro globalmente para acesso nos botões
                window.currentViralRoteiro = roteiro;
                
                const existingModal = document.getElementById('viral-roteiro-complete-modal');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            
            window.closeViralRoteiroCompleteModal = function() {
                const modal = document.getElementById('viral-roteiro-complete-modal');
                if (modal) modal.remove();
                window.currentViralRoteiro = null;
            };
            
            window.copyViralRoteiroFromModal = function() {
                if (!window.currentViralRoteiro) return;
                
                navigator.clipboard.writeText(window.currentViralRoteiro).then(() => {
                    showMessage('viral-agents-success-message', 'Roteiro copiado para a área de transferência!', false);
                    closeViralRoteiroCompleteModal();
                }).catch(err => {
                    console.error('Erro ao copiar:', err);
                    alert('Erro ao copiar roteiro');
                });
            };
            
            window.downloadViralRoteiro = function() {
                if (!window.currentViralRoteiro || !currentViralAgent || !currentViralConversation) return;
                
                // Abrir markdown em nova aba (já tem a funcionalidade)
                openViralMarkdown();
                closeViralRoteiroCompleteModal();
            };
            
            window.openViralMarkdown = async function() {
                if (!currentViralAgent || !currentViralConversation) return;
                try {
                    const token = localStorage.getItem('core_token');
                    const url = `${API_BASE}/api/viral-agents/${currentViralAgent.id}/conversations/${currentViralConversation}/markdown`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (!response.ok) throw new Error('Erro ao gerar documento');
                    const html = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao abrir documento: ' + error.message);
                }
            };
            
            window.copyViralMessage = function(messageIndex) {
                if (!currentViralMessages || !currentViralMessages[messageIndex]) return;
                
                const message = currentViralMessages[messageIndex];
                if (message.role !== 'assistant') return;
                
                const messageText = message.content;
                
                // Copiar para clipboard
                navigator.clipboard.writeText(messageText).then(() => {
                    // Mostrar feedback visual
                    const container = document.getElementById('viral-chat-messages');
                    if (container) {
                        const messages = container.querySelectorAll('.bg-gray-800');
                        if (messages[messageIndex]) {
                            const button = messages[messageIndex].querySelector('button');
                            if (button) {
                                const icon = button.querySelector('i');
                                if (icon) {
                                    icon.setAttribute('data-lucide', 'check');
                                    lucide.createIcons();
                                    setTimeout(() => {
                                        icon.setAttribute('data-lucide', 'copy');
                                        lucide.createIcons();
                                    }, 2000);
                                }
                            }
                        }
                    }
                    
                    // Mostrar notificação
                    showMessage('viral-agents-success-message', 'Roteiro copiado para a área de transferência!', false);
                }).catch(err => {
                    console.error('Erro ao copiar:', err);
                    // Fallback para navegadores mais antigos
                    const textArea = document.createElement('textarea');
                    textArea.value = messageText;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showMessage('viral-agents-success-message', 'Roteiro copiado para a área de transferência!', false);
                    } catch (e) {
                        alert('Erro ao copiar roteiro. Selecione o texto manualmente.');
                    }
                    document.body.removeChild(textArea);
                });
            };

            window.sendViralMessage = async function() {
                if (!currentViralAgent || !currentViralConversation) {
                    await createNewViralConversation();
                    if (!currentViralConversation) return;
                }

                const input = document.getElementById('viral-chat-input');
                const message = input.value.trim();
                if (!message) return;

                // Adicionar mensagem do usuário ao array
                currentViralMessages.push({
                    role: 'user',
                    content: message
                });

                // Adicionar mensagem do usuário na UI
                const container = document.getElementById('viral-chat-messages');
                container.innerHTML += `
                    <div class="p-3 rounded-lg bg-amber-500/20 border border-amber-500/30 ml-auto max-w-[80%]">
                        <p class="text-sm text-white whitespace-pre-wrap">${escapeHtml(message)}</p>
                    </div>
                `;
                container.scrollTop = container.scrollHeight;

                input.value = '';
                input.disabled = true;

                // Mostrar loading
                container.innerHTML += `
                    <div class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-[80%]">
                        <p class="text-sm text-gray-400">Pensando...</p>
                    </div>
                `;
                container.scrollTop = container.scrollHeight;

                try {
                    const token = localStorage.getItem('core_token');
                    const startTime = Date.now(); // Marcar início
                    
                    // Criar elemento de resposta que será atualizado em tempo real
                    const loadingDiv = container.querySelector('.bg-gray-800:last-child');
                    let responseDiv = null;
                    let fullResponse = '';
                    let roteiroFinal = '';
                    
                    if (loadingDiv && loadingDiv.textContent.includes('Pensando')) {
                        loadingDiv.outerHTML = `
                            <div id="viral-streaming-response" class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-[80%] relative group">
                                <p id="viral-streaming-text" class="text-sm text-white whitespace-pre-wrap"></p>
                                <div id="viral-streaming-buttons" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2" style="display: none;">
                                    <button onclick="copyViralMessage(${currentViralMessages.length})" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Copiar roteiro">
                                        <i data-lucide="copy" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="openViralMarkdown()" class="p-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 hover:text-white" title="Ver roteiro completo em MD">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        responseDiv = document.getElementById('viral-streaming-response');
                        container.scrollTop = container.scrollHeight;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                    
                    // Usar fetch com streaming
                    const response = await fetch(`${API_BASE}/api/viral-agents/${currentViralAgent.id}/chat`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            conversation_id: currentViralConversation,
                            message: message,
                            model: currentViralAgent.model || 'gpt-4o',
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.msg || 'Erro ao enviar mensagem');
                    }

                    // Ler stream
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    const streamingText = document.getElementById('viral-streaming-text');
                    let nota = null;
                    let pontosFortes = [];

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.done) {
                                        // Extrair nota e checklist se vieram do servidor
                                        let checklistData = null;
                                        if (data.nota) {
                                            nota = data.nota;
                                            checklistData = data.checklist || null;
                                        }
                                        
                                        // Remover JSON da resposta se houver
                                        roteiroFinal = fullResponse.replace(/\{[\s\S]*"nota"[\s\S]*\}/, '').trim();
                                        
                                        // Se não encontrou nota no JSON, tentar extrair do texto
                                        if (!nota) {
                                            const jsonMatch = fullResponse.match(/\{[\s\S]*"nota"[\s\S]*\}/);
                                            if (jsonMatch) {
                                                try {
                                                    const avaliacao = JSON.parse(jsonMatch[0]);
                                                    nota = avaliacao.nota;
                                                    checklistData = avaliacao.checklist || null;
                                                    roteiroFinal = fullResponse.replace(/\{[\s\S]*"nota"[\s\S]*\}/, '').trim();
                                                } catch (e) {
                                                    const notaMatch = fullResponse.match(/nota[:\s]*(\d+)\/10/i);
                                                    if (notaMatch) {
                                                        nota = parseInt(notaMatch[1]);
                                                        roteiroFinal = fullResponse.replace(/nota[:\s]*\d+\/10[\s\S]*/i, '').trim();
                                                    } else {
                                                        // Gerar nota padrão baseada no tamanho do roteiro
                                                        nota = Math.min(10, Math.max(7, Math.floor(roteiroFinal.length / 1000) + 7));
                                                    }
                                                }
                                            } else {
                                                // Gerar nota padrão baseada no tamanho do roteiro
                                                nota = Math.min(10, Math.max(7, Math.floor(roteiroFinal.length / 1000) + 7));
                                            }
                                        }
                                        
                                        // Atualizar texto final (sem a nota)
                                        if (streamingText) {
                                            streamingText.textContent = roteiroFinal;
                                        }
                                        
                                        if (responseDiv) {
                                            document.getElementById('viral-streaming-buttons').style.display = 'flex';
                                        }
                                        
                                        // Adicionar mensagem completa ao array (sem nota)
                                        currentViralMessages.push({
                                            role: 'assistant',
                                            content: roteiroFinal
                                        });
                                        
                                        // Mostrar popup de conclusão com checklist
                                        showViralRoteiroCompleteModal(nota, checklistData, roteiroFinal);
                                        
                                        // Recarregar conversas para atualizar timestamp
                                        await openViralAgent(currentViralAgent.id);
                                        break;
                                    }
                                    
                                    if (data.text) {
                                        fullResponse += data.text;
                                        if (streamingText) {
                                            streamingText.textContent = fullResponse;
                                            container.scrollTop = container.scrollHeight;
                                        }
                                    }
                                    
                                    if (data.error) {
                                        throw new Error(data.error);
                                    }
                                } catch (e) {
                                    // Ignorar erros de parsing
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    container.innerHTML = container.innerHTML.replace(
                        /<div class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-\[80%\]">[\s\S]*?Pensando\.\.\.[\s\S]*?<\/div>/,
                        `<div class="p-3 rounded-lg bg-gray-800 border border-gray-700 mr-auto max-w-[80%]">
                            <p class="text-sm text-red-400">Erro: ${escapeHtml(error.message)}</p>
                        </div>`
                    );
                } finally {
                    input.disabled = false;
                    input.focus();
                }
            };
            // ==================== FIM DAS FUNÇÕES PARA AGENTES VIRAIS ====================

            // --- FUNÇÕES PARA ANÁLISE DE CANAIS VIRAIS ---
            
            async function loadViralChannels() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-analysis/channels`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) throw new Error('Erro ao carregar canais');
                    
                    const data = await response.json();
                    const channelsList = document.getElementById('viral-channels-list');
                    
                    if (!channelsList) return;
                    
                    if (!data.channels || data.channels.length === 0) {
                        channelsList.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">Nenhum canal adicionado ainda. Adicione um canal para começar a análise.</p>';
                        return;
                    }
                    
                    channelsList.innerHTML = data.channels.map(channel => {
                        const ageYears = channel.channel_age_years ? channel.channel_age_years.toFixed(1) : 'N/A';
                        const ageDays = channel.channel_age_days || 0;
                        const rpmUsd = channel.avg_rpm_usd ? channel.avg_rpm_usd.toFixed(2) : 'N/A';
                        const rpmBrl = channel.avg_rpm_brl ? channel.avg_rpm_brl.toFixed(2) : 'N/A';
                        const niche = channel.niche ? `<span class="px-2 py-1 bg-amber-600/20 text-amber-300 rounded text-xs">${escapeHtml(channel.niche)}</span>` : '';
                        const subniche = channel.subniche ? `<span class="px-2 py-1 bg-blue-600/20 text-blue-300 rounded text-xs ml-2">${escapeHtml(channel.subniche)}</span>` : '';
                        const nicheDisplay = channel.niche || channel.subniche ? `<div class="flex flex-wrap items-center gap-2 mt-2">${niche}${subniche}</div>` : '';
                        
                        return `
                        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-white mb-2">${escapeHtml(channel.channel_name)}</h3>
                                    <p class="text-sm text-gray-400 mb-2">@${escapeHtml(channel.channel_handle || 'N/A')}</p>
                                    ${nicheDisplay || (niche ? `<div class="mb-2">${niche}</div>` : '')}
                                    <div class="flex flex-wrap gap-4 text-xs text-gray-500 mb-2">
                                        <span>👥 ${(channel.subscriber_count || 0).toLocaleString()} inscritos</span>
                                        <span>📹 ${(channel.total_videos || 0).toLocaleString()} vídeos</span>
                                        <span>👁️ ${(channel.total_views || 0).toLocaleString()} visualizações</span>
                                    </div>
                                    <div class="flex flex-wrap gap-4 text-xs text-gray-500">
                                        <span>⏱️ ${ageYears} anos (${ageDays} dias)</span>
                                        <span>💰 RPM: $${rpmUsd} USD / R$ ${rpmBrl} BRL</span>
                                    </div>
                                </div>
                                <button onclick="deleteViralChannel(${channel.id})" class="p-2 text-red-400 hover:text-red-300" title="Remover">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="analyzeViralChannel(${channel.id})" class="flex-1 py-2 px-4 bg-amber-600 hover:bg-amber-500 text-black font-bold rounded-lg transition">
                                    🔍 Analisar Canal
                                </button>
                                <button onclick="viewViralAnalysis(${channel.id})" class="flex-1 py-2 px-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition">
                                    📊 Ver Análise
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Analisado: ${new Date(channel.analyzed_at).toLocaleDateString('pt-BR')}</p>
                        </div>
                    `;
                    }).join('');
                    
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } catch (err) {
                    console.error('[Viral Analysis] Erro ao carregar canais:', err);
                    showCustomModal('Erro', 'Erro ao carregar canais: ' + err.message, 'error');
                }
            }
            
            async function addViralChannel() {
                const urlInput = document.getElementById('viral-channel-url');
                const url = urlInput?.value.trim();
                
                if (!url) {
                    showCustomModal('URL Obrigatória', 'Por favor, insira a URL do canal do YouTube.', 'warning');
                    return;
                }
                
                try {
                    const token = localStorage.getItem('core_token');
                    showLoadingModal('Adicionando canal...', 'default');
                    
                    // Não enviar nicho/subnicho - serão detectados durante a análise
                    const response = await fetch(`${API_BASE}/api/viral-analysis/channels`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ channelUrl: url })
                    });
                    
                    const data = await response.json();
                    document.getElementById('generic-loading-modal')?.remove();
                    
                    if (!response.ok) {
                        throw new Error(data.msg || 'Erro ao adicionar canal');
                    }
                    
                    urlInput.value = '';
                    // Limpar campos de nicho e subnicho
                    const nicheInput = document.getElementById('viral-channel-niche');
                    const subnicheInput = document.getElementById('viral-channel-subniche');
                    if (nicheInput) nicheInput.value = '';
                    if (subnicheInput) subnicheInput.value = '';
                    showCustomModal('Sucesso', data.msg || 'Canal adicionado com sucesso!', 'success');
                    loadViralChannels();
                } catch (err) {
                    document.getElementById('generic-loading-modal')?.remove();
                    showCustomModal('Erro', err.message || 'Erro ao adicionar canal', 'error');
                }
            }
            
            async function analyzeViralChannel(analysisId) {
                try {
                    const token = localStorage.getItem('core_token');
                    showLoadingModal('Analisando canal... Isso pode levar alguns minutos.', 'default');
                    
                    const response = await fetch(`${API_BASE}/api/viral-analysis/channels/${analysisId}/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ ai_model: 'auto' })
                    });
                    
                    const data = await response.json();
                    document.getElementById('generic-loading-modal')?.remove();
                    
                    if (!response.ok) {
                        throw new Error(data.msg || 'Erro ao analisar canal');
                    }
                    
                    showCustomModal('Análise Concluída', 'Análise do canal concluída com sucesso! O nicho e subnicho foram detectados automaticamente. Visualize os insights na seção de análise.', 'success');
                    loadViralChannels();
                    viewViralAnalysis(analysisId);
                } catch (err) {
                    document.getElementById('generic-loading-modal')?.remove();
                    showCustomModal('Erro', err.message || 'Erro ao analisar canal', 'error');
                }
            }
            
            async function viewViralAnalysis(analysisId) {
                try {
                    const token = localStorage.getItem('core_token');
                    showLoadingModal('Carregando análise...', 'default');
                    
                    const response = await fetch(`${API_BASE}/api/viral-analysis/channels/${analysisId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    const data = await response.json();
                    document.getElementById('generic-loading-modal')?.remove();
                    
                    if (!response.ok) {
                        throw new Error(data.msg || 'Erro ao carregar análise');
                    }
                    
                    const detailDiv = document.getElementById('viral-analysis-detail');
                    const channelInfo = data.analysis;
                    const videos = data.videos || [];
                    const insights = data.insights || [];
                    
                    console.log('[Viral Analysis Frontend] Dados recebidos:', {
                        hasAnalysis: !!data.analysis,
                        hasViralInsights: !!data.analysis?.viral_insights,
                        viralInsightsType: typeof data.analysis?.viral_insights,
                        viralInsightsValue: data.analysis?.viral_insights,
                        videosCount: videos.length,
                        insightsCount: insights.length,
                        fullAnalysis: data.analysis
                    });
                    
                    // Informações do canal
                    const analysisData = data.analysis;
                    const ageYears = analysisData.channel_age_years ? analysisData.channel_age_years.toFixed(1) : (channelInfo.yearsSinceCreation || 0).toFixed(1);
                    const ageDays = analysisData.channel_age_days || channelInfo.daysSinceCreation || 0;
                    const rpmUsd = analysisData.avg_rpm_usd ? analysisData.avg_rpm_usd.toFixed(2) : 'N/A';
                    const rpmBrl = analysisData.avg_rpm_brl ? analysisData.avg_rpm_brl.toFixed(2) : 'N/A';
                    const totalRevenueUSD = analysisData.total_revenue_usd ? parseFloat(analysisData.total_revenue_usd).toFixed(2) : 'N/A';
                    const totalRevenueBRL = analysisData.total_revenue_brl ? parseFloat(analysisData.total_revenue_brl).toFixed(2) : 'N/A';
                    
                    document.getElementById('viral-channel-info').innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-4">
                            <h4 class="text-white font-semibold mb-4">${escapeHtml(channelInfo.channel_name)}</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <p class="text-gray-400 text-sm">Inscritos</p>
                                    <p class="text-white text-2xl font-bold">${(channelInfo.subscriber_count || 0).toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">Videos</p>
                                    <p class="text-white text-2xl font-bold">${(channelInfo.total_videos || 0).toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">Visualizações</p>
                                    <p class="text-white text-2xl font-bold">${(channelInfo.total_views || 0).toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">Idade do Canal</p>
                                    <p class="text-white text-2xl font-bold">${ageYears} anos</p>
                                    <p class="text-gray-500 text-xs">${ageDays} dias</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <p class="text-gray-400 text-sm">RPM Médio (USD)</p>
                                    <p class="text-white text-2xl font-bold">$${rpmUsd}</p>
                                    <p class="text-gray-500 text-xs">por 1000 visualizações</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm">RPM Médio (BRL)</p>
                                    <p class="text-white text-2xl font-bold">R$ ${rpmBrl}</p>
                                    <p class="text-gray-500 text-xs">por 1000 visualizações</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 rounded-lg p-3 border border-green-700/50">
                                    <p class="text-gray-400 text-sm">💰 Valor Total Ganho (USD)</p>
                                    <p class="text-green-400 text-2xl font-bold">$${totalRevenueUSD !== 'N/A' ? parseFloat(totalRevenueUSD).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</p>
                                </div>
                                <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 rounded-lg p-3 border border-green-700/50">
                                    <p class="text-gray-400 text-sm">💰 Valor Total Ganho (BRL)</p>
                                    <p class="text-green-400 text-2xl font-bold">R$ ${totalRevenueBRL !== 'N/A' ? parseFloat(totalRevenueBRL).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Top vídeos - ordenar por visualizações e pegar top 10
                    const sortedVideos = videos.sort((a, b) => (b.view_count || 0) - (a.view_count || 0)).slice(0, 10);
                    const videosHtml = sortedVideos.map(video => {
                        // Calcular tempo no ar
                        const publishedAt = video.published_at ? new Date(video.published_at) : null;
                        let timeAgo = 'N/A';
                        let hoursAgo = 0;
                        if (publishedAt) {
                            const now = new Date();
                            const diffMs = now - publishedAt;
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffDays = Math.floor(diffHours / 24);
                            const diffMonths = Math.floor(diffDays / 30);
                            const diffYears = Math.floor(diffDays / 365);
                            
                            hoursAgo = diffHours;
                            
                            if (diffYears > 0) {
                                timeAgo = `${diffYears} ${diffYears === 1 ? 'ano' : 'anos'}`;
                            } else if (diffMonths > 0) {
                                timeAgo = `${diffMonths} ${diffMonths === 1 ? 'mês' : 'meses'}`;
                            } else if (diffDays > 0) {
                                timeAgo = `${diffDays} ${diffDays === 1 ? 'dia' : 'dias'}`;
                            } else if (diffHours > 0) {
                                timeAgo = `${diffHours} ${diffHours === 1 ? 'hora' : 'horas'}`;
                            } else {
                                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                                timeAgo = `${diffMinutes} ${diffMinutes === 1 ? 'minuto' : 'minutos'}`;
                            }
                        }
                        
                        // Calcular VPH (Views Per Hour)
                        const views = video.view_count || 0;
                        const vph = hoursAgo > 0 ? (views / hoursAgo).toFixed(0) : views.toFixed(0);
                        const vphFormatted = hoursAgo > 0 ? `${parseInt(vph).toLocaleString()}/h` : `${views.toLocaleString()} (recém publicado)`;
                        
                        // Calcular fórmula de estrutura do vídeo
                        const engagementRate = views > 0 ? (((video.like_count || 0) + (video.comment_count || 0)) / views * 100).toFixed(2) : '0.00';
                        const viewsPerDay = hoursAgo > 0 ? (views / (hoursAgo / 24)).toFixed(0) : views.toFixed(0);
                        
                        // Buscar fórmula de estrutura do título dos insights
                        let titleStructureFormula = '';
                        if (data.analysis?.viral_insights) {
                            try {
                                const viralInsights = typeof data.analysis.viral_insights === 'string' 
                                    ? JSON.parse(data.analysis.viral_insights) 
                                    : data.analysis.viral_insights;
                                if (viralInsights?.title_patterns?.structure && viralInsights.title_patterns.structure !== 'Estrutura não identificada') {
                                    titleStructureFormula = viralInsights.title_patterns.structure;
                                }
                            } catch (e) {
                                console.error('Erro ao parsear insights:', e);
                            }
                        }
                        
                        const structureFormula = titleStructureFormula 
                            ? `Estrutura do Título: ${escapeHtml(titleStructureFormula)} | VPH: ${vphFormatted} | Taxa Engajamento: ${engagementRate}% | Views/Dia: ${parseInt(viewsPerDay).toLocaleString()}`
                            : `VPH: ${vphFormatted} | Taxa Engajamento: ${engagementRate}% | Views/Dia: ${parseInt(viewsPerDay).toLocaleString()}`;
                        
                        // Escapar URL e título para uso seguro em onclick
                        const safeThumbnailUrl = (video.thumbnail_url || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const safeTitle = escapeHtml(video.title).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const safeVideoUrl = (video.video_url || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const safeVideoId = (video.video_id || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        
                        return `
                        <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-750 transition-colors">
                            <div class="flex gap-4">
                                <div class="relative">
                                    <img src="${video.thumbnail_url || ''}" class="w-32 h-20 object-cover rounded" onerror="this.style.display='none'">
                                    <button onclick="window.downloadThumbnail('${safeThumbnailUrl}', '${safeTitle}')" 
                                            class="absolute bottom-1 right-1 bg-amber-600 hover:bg-amber-700 text-white p-1.5 rounded text-xs flex items-center gap-1" 
                                            title="Baixar Thumbnail">
                                        <i data-lucide="download" class="w-3 h-3"></i>
                                    </button>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-white font-semibold mb-2 line-clamp-2">${escapeHtml(video.title)}</h4>
                                    <div class="flex flex-wrap gap-4 text-xs text-gray-400 mb-2">
                                        <span>👁️ ${views.toLocaleString()}</span>
                                        <span>👍 ${(video.like_count || 0).toLocaleString()}</span>
                                        <span>💬 ${(video.comment_count || 0).toLocaleString()}</span>
                                        <span>⭐ Score: ${(video.viral_score || 0).toFixed(2)}</span>
                                    </div>
                                    <div class="bg-gray-900 rounded p-2 mb-2">
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div>
                                                <span class="text-amber-400 font-semibold">⚡ VPH:</span>
                                                <span class="text-white ml-1">${vphFormatted}</span>
                                            </div>
                                            <div>
                                                <span class="text-amber-400 font-semibold">⏱️ No ar há:</span>
                                                <span class="text-white ml-1">${timeAgo}</span>
                                            </div>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-700">
                                            <span class="text-amber-400 font-semibold text-xs">📊 Fórmula:</span>
                                            <p class="text-gray-300 text-xs mt-1">${structureFormula}</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <a href="${video.video_url || '#'}" target="_blank" rel="noopener noreferrer" 
                                           class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs flex items-center gap-1">
                                            <i data-lucide="external-link" class="w-3 h-3"></i>
                                            Ver no YouTube
                                        </a>
                                        <button onclick="window.copyVideoLink('${safeVideoUrl}')" 
                                                class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded text-xs flex items-center gap-1"
                                                title="Copiar Link">
                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                            Copiar Link
                                        </button>
                                        <button onclick="window.analyzeVideoComments('${safeVideoId}')" 
                                                class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-xs flex items-center gap-1"
                                                title="Analisar Comentários e Gerar Títulos">
                                            <i data-lucide="message-square" class="w-3 h-3"></i>
                                            Analisar Comentários
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                    document.getElementById('viral-top-videos').innerHTML = videosHtml || '<p class="text-gray-400">Nenhum vídeo analisado ainda.</p>';
                    
                    // Inicializar ícones do Lucide após renderizar vídeos
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    
                    // Insights - Parsear se for string
                    let insightsData = {};
                    console.log('[Viral Analysis Frontend] channelInfo.viral_insights:', channelInfo.viral_insights);
                    
                    if (channelInfo.viral_insights) {
                        if (typeof channelInfo.viral_insights === 'string') {
                            try {
                                insightsData = JSON.parse(channelInfo.viral_insights);
                                console.log('[Viral Analysis Frontend] Insights parseados:', insightsData);
                            } catch (e) {
                                console.error('[Viral Analysis] Erro ao parsear insights:', e);
                                insightsData = {};
                            }
                        } else {
                            insightsData = channelInfo.viral_insights;
                            console.log('[Viral Analysis Frontend] Insights já são objeto:', insightsData);
                        }
                    } else {
                        console.warn('[Viral Analysis Frontend] Nenhum insight encontrado em channelInfo.viral_insights');
                    }
                    
                    // Formatar insights de forma mais legível
                    const formatInsightValue = (value) => {
                        if (typeof value === 'string') return value;
                        if (Array.isArray(value)) return value.map(v => `• ${v}`).join('<br>');
                        if (typeof value === 'object' && value !== null) {
                            return Object.entries(value).map(([k, v]) => {
                                if (Array.isArray(v)) {
                                    return `<strong>${k}:</strong> ${v.join(', ')}`;
                                }
                                return `<strong>${k}:</strong> ${v}`;
                            }).join('<br>');
                        }
                        return String(value);
                    };
                    
                    const insightsHtml = `
                        <div class="space-y-4">
                            ${insightsData.title_patterns && Object.keys(insightsData.title_patterns).length > 0 ? `
                                <div class="bg-gray-800 rounded-lg p-4">
                                    <h4 class="text-white font-semibold mb-3">📝 Padrões nos Títulos</h4>
                                    <div class="text-gray-300 text-sm space-y-2">
                                        ${insightsData.title_patterns.structure ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Estrutura:</span>
                                                <p class="text-gray-300 mt-1">${escapeHtml(insightsData.title_patterns.structure)}</p>
                                            </div>
                                        ` : ''}
                                        ${insightsData.title_patterns.keywords && Array.isArray(insightsData.title_patterns.keywords) && insightsData.title_patterns.keywords.length > 0 ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Palavras-chave recorrentes:</span>
                                                <div class="flex flex-wrap gap-2 mt-1">
                                                    ${insightsData.title_patterns.keywords.map(kw => `<span class="px-2 py-1 bg-amber-600/20 text-amber-300 rounded text-xs">${escapeHtml(kw)}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        ${insightsData.title_patterns.hook_techniques && Array.isArray(insightsData.title_patterns.hook_techniques) && insightsData.title_patterns.hook_techniques.length > 0 ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Técnicas de Hook:</span>
                                                <ul class="list-disc list-inside mt-1 space-y-1">
                                                    ${insightsData.title_patterns.hook_techniques.map(tech => `<li class="text-gray-300">${escapeHtml(tech)}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${insightsData.title_patterns.avg_length ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Comprimento médio:</span>
                                                <span class="text-gray-300 ml-2">${insightsData.title_patterns.avg_length} caracteres</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${insightsData.engagement_strategies && Object.keys(insightsData.engagement_strategies).length > 0 ? `
                                <div class="bg-gray-800 rounded-lg p-4">
                                    <h4 class="text-white font-semibold mb-3">💬 Estratégias de Engagement</h4>
                                    <div class="text-gray-300 text-sm space-y-2">
                                        ${insightsData.engagement_strategies.comment_triggers && Array.isArray(insightsData.engagement_strategies.comment_triggers) && insightsData.engagement_strategies.comment_triggers.length > 0 ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">O que gera comentários:</span>
                                                <ul class="list-disc list-inside mt-1 space-y-1">
                                                    ${insightsData.engagement_strategies.comment_triggers.map(trigger => `<li class="text-gray-300">${escapeHtml(trigger)}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${insightsData.engagement_strategies.like_triggers && Array.isArray(insightsData.engagement_strategies.like_triggers) && insightsData.engagement_strategies.like_triggers.length > 0 ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">O que gera likes:</span>
                                                <ul class="list-disc list-inside mt-1 space-y-1">
                                                    ${insightsData.engagement_strategies.like_triggers.map(trigger => `<li class="text-gray-300">${escapeHtml(trigger)}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${insightsData.engagement_strategies.best_posting_times ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Melhor horário de publicação:</span>
                                                <p class="text-gray-300 mt-1">${escapeHtml(insightsData.engagement_strategies.best_posting_times)}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${insightsData.viral_insights && Object.keys(insightsData.viral_insights).length > 0 ? `
                                <div class="bg-gray-800 rounded-lg p-4">
                                    <h4 class="text-white font-semibold mb-3">🔥 Insights Virais</h4>
                                    <div class="text-gray-300 text-sm space-y-2">
                                        ${insightsData.viral_insights.why_viral ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Por que viralizaram:</span>
                                                <p class="text-gray-300 mt-1">${escapeHtml(insightsData.viral_insights.why_viral)}</p>
                                            </div>
                                        ` : ''}
                                        ${insightsData.viral_insights.common_elements && Array.isArray(insightsData.viral_insights.common_elements) && insightsData.viral_insights.common_elements.length > 0 ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Elementos comuns:</span>
                                                <ul class="list-disc list-inside mt-1 space-y-1">
                                                    ${insightsData.viral_insights.common_elements.map(elem => `<li class="text-gray-300">${escapeHtml(elem)}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${insightsData.viral_insights.differences ? `
                                            <div>
                                                <span class="text-amber-400 font-semibold">Diferenças identificadas:</span>
                                                <p class="text-gray-300 mt-1">${escapeHtml(insightsData.viral_insights.differences)}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('viral-insights').innerHTML = insightsHtml || '<p class="text-gray-400">Execute a análise para ver os insights.</p>';
                    
                    // Recomendações
                    const recommendations = insightsData.recommendations || {};
                    const recommendationsHtml = `
                        <div class="bg-gray-800 rounded-lg p-4">
                            ${recommendations.suggested_titles && Array.isArray(recommendations.suggested_titles) && recommendations.suggested_titles.length > 0 ? `
                                <h4 class="text-white font-semibold mb-3">🎯 Títulos Sugeridos Baseados nos Padrões Virais:</h4>
                                <ul class="space-y-2">
                                    ${recommendations.suggested_titles.map(title => `
                                        <li class="text-gray-300 text-sm flex items-start gap-2">
                                            <span class="text-amber-500 mt-1">•</span>
                                            <span class="flex-1">${escapeHtml(title)}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                            ${recommendations.replication_strategy ? `
                                <div class="mt-4">
                                    <h4 class="text-white font-semibold mb-2">🔄 Estratégia de Replicação:</h4>
                                    <p class="text-gray-300 text-sm leading-relaxed">${escapeHtml(recommendations.replication_strategy)}</p>
                                </div>
                            ` : ''}
                            ${recommendations.content_strategies && Array.isArray(recommendations.content_strategies) && recommendations.content_strategies.length > 0 ? `
                                <div class="mt-4">
                                    <h4 class="text-white font-semibold mb-2">📋 Estratégias de Conteúdo:</h4>
                                    <ul class="space-y-2">
                                        ${recommendations.content_strategies.map(strategy => `
                                            <li class="text-gray-300 text-sm flex items-start gap-2">
                                                <span class="text-amber-500 mt-1">•</span>
                                                <span class="flex-1">${escapeHtml(strategy)}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('viral-recommendations').innerHTML = recommendationsHtml || '<p class="text-gray-400">Execute a análise para ver recomendações.</p>';
                    
                    // Insights para Novo Canal
                    const newChannelInsights = data.analysis.new_channel_insights;
                    if (newChannelInsights && Object.keys(newChannelInsights).length > 0) {
                        const newChannelHtml = `
                            ${newChannelInsights.cross_patterns ? `
                                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                    <h4 class="text-white font-semibold mb-3">🔀 Padrões Cruzados</h4>
                                    ${newChannelInsights.cross_patterns.common_elements && Array.isArray(newChannelInsights.cross_patterns.common_elements) && newChannelInsights.cross_patterns.common_elements.length > 0 ? `
                                        <div class="mb-3">
                                            <span class="text-amber-400 font-semibold text-sm">Elementos Comuns:</span>
                                            <ul class="list-disc list-inside mt-1 space-y-1">
                                                ${newChannelInsights.cross_patterns.common_elements.map(elem => `<li class="text-gray-300 text-sm">${escapeHtml(elem)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${newChannelInsights.cross_patterns.best_practices && Array.isArray(newChannelInsights.cross_patterns.best_practices) && newChannelInsights.cross_patterns.best_practices.length > 0 ? `
                                        <div class="mb-3">
                                            <span class="text-amber-400 font-semibold text-sm">Melhores Práticas:</span>
                                            <ul class="list-disc list-inside mt-1 space-y-1">
                                                ${newChannelInsights.cross_patterns.best_practices.map(practice => `<li class="text-gray-300 text-sm">${escapeHtml(practice)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${newChannelInsights.cross_patterns.key_differences ? `
                                        <div>
                                            <span class="text-amber-400 font-semibold text-sm">Diferenças-Chave:</span>
                                            <p class="text-gray-300 text-sm mt-1">${escapeHtml(newChannelInsights.cross_patterns.key_differences)}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${newChannelInsights.new_channel_strategy ? `
                                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                    <h4 class="text-white font-semibold mb-3">📋 Estratégia para Novo Canal</h4>
                                    ${newChannelInsights.new_channel_strategy.positioning ? `
                                        <div class="mb-3">
                                            <span class="text-amber-400 font-semibold text-sm">Posicionamento:</span>
                                            <p class="text-gray-300 text-sm mt-1">${escapeHtml(newChannelInsights.new_channel_strategy.positioning)}</p>
                                        </div>
                                    ` : ''}
                                    ${newChannelInsights.new_channel_strategy.replicate_elements && Array.isArray(newChannelInsights.new_channel_strategy.replicate_elements) && newChannelInsights.new_channel_strategy.replicate_elements.length > 0 ? `
                                        <div class="mb-3">
                                            <span class="text-amber-400 font-semibold text-sm">Elementos para Replicar:</span>
                                            <ul class="list-disc list-inside mt-1 space-y-1">
                                                ${newChannelInsights.new_channel_strategy.replicate_elements.map(elem => `<li class="text-gray-300 text-sm">${escapeHtml(elem)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${newChannelInsights.new_channel_strategy.avoid_elements && Array.isArray(newChannelInsights.new_channel_strategy.avoid_elements) && newChannelInsights.new_channel_strategy.avoid_elements.length > 0 ? `
                                        <div class="mb-3">
                                            <span class="text-amber-400 font-semibold text-sm">Elementos para Evitar:</span>
                                            <ul class="list-disc list-inside mt-1 space-y-1">
                                                ${newChannelInsights.new_channel_strategy.avoid_elements.map(elem => `<li class="text-gray-300 text-sm">${escapeHtml(elem)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${newChannelInsights.new_channel_strategy.launch_timing ? `
                                        <div>
                                            <span class="text-amber-400 font-semibold text-sm">Timing de Lançamento:</span>
                                            <p class="text-gray-300 text-sm mt-1">${escapeHtml(newChannelInsights.new_channel_strategy.launch_timing)}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${newChannelInsights.optimized_titles && Array.isArray(newChannelInsights.optimized_titles) && newChannelInsights.optimized_titles.length > 0 ? `
                                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                    <h4 class="text-white font-semibold mb-3">📝 Títulos Otimizados (${newChannelInsights.optimized_titles.length})</h4>
                                    <ul class="space-y-2">
                                        ${newChannelInsights.optimized_titles.map((title, idx) => `
                                            <li class="text-gray-300 text-sm flex items-start gap-2">
                                                <span class="text-amber-500 mt-1">${idx + 1}.</span>
                                                <span class="flex-1">${escapeHtml(title)}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${newChannelInsights.content_roadmap ? `
                                <div class="bg-gray-800 rounded-lg p-4">
                                    <h4 class="text-white font-semibold mb-3">🗺️ Roadmap de Conteúdo</h4>
                                    ${newChannelInsights.content_roadmap.first_10_videos && Array.isArray(newChannelInsights.content_roadmap.first_10_videos) && newChannelInsights.content_roadmap.first_10_videos.length > 0 ? `
                                        <div class="mb-3">
                                            <span class="text-amber-400 font-semibold text-sm">Primeiros 10 Vídeos:</span>
                                            <ol class="list-decimal list-inside mt-2 space-y-2">
                                                ${newChannelInsights.content_roadmap.first_10_videos.map(video => `
                                                    <li class="text-gray-300 text-sm">
                                                        <strong>${escapeHtml(video.title || 'Título não especificado')}</strong>
                                                        ${video.reason ? `<span class="text-gray-500 text-xs block ml-6">→ ${escapeHtml(video.reason)}</span>` : ''}
                                                    </li>
                                                `).join('')}
                                            </ol>
                                        </div>
                                    ` : ''}
                                    ${newChannelInsights.content_roadmap.growth_strategy ? `
                                        <div>
                                            <span class="text-amber-400 font-semibold text-sm">Estratégia de Crescimento:</span>
                                            <p class="text-gray-300 text-sm mt-1">${escapeHtml(newChannelInsights.content_roadmap.growth_strategy)}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        `;
                        const newChannelInsightsEl = document.getElementById('viral-new-channel-insights');
                        const newChannelInsightsSection = document.getElementById('viral-new-channel-insights-section');
                        
                        if (newChannelInsightsEl && newChannelInsightsSection) {
                            newChannelInsightsEl.innerHTML = newChannelHtml;
                            newChannelInsightsSection.style.display = 'block';
                        }
                    } else {
                        const newChannelInsightsSection = document.getElementById('viral-new-channel-insights-section');
                        if (newChannelInsightsSection) {
                            newChannelInsightsSection.style.display = 'none';
                        }
                    }
                    
                    detailDiv.classList.remove('hidden');
                    detailDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (err) {
                    document.getElementById('generic-loading-modal')?.remove();
                    showCustomModal('Erro', err.message || 'Erro ao carregar análise', 'error');
                }
            }
            
            async function deleteViralChannel(analysisId) {
                if (!confirm('Tem certeza que deseja remover este canal da análise?')) return;
                
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-analysis/channels/${analysisId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.msg || 'Erro ao remover canal');
                    }
                    
                    showCustomModal('Sucesso', 'Canal removido com sucesso!', 'success');
                    loadViralChannels();
                } catch (err) {
                    showCustomModal('Erro', err.message || 'Erro ao remover canal', 'error');
                }
            }
            
            // Funções globais para download e copiar link
            window.downloadThumbnail = async function(thumbnailUrl, videoTitle) {
                if (!thumbnailUrl) {
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Erro', 'URL da thumbnail não disponível', 'error');
                    } else {
                        alert('URL da thumbnail não disponível');
                    }
                    return;
                }
                
                try {
                    const response = await fetch(thumbnailUrl);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const sanitizedTitle = (videoTitle || 'thumbnail').replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                    a.download = `${sanitizedTitle}_thumbnail.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (err) {
                    console.error('Erro ao baixar thumbnail:', err);
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Erro', 'Erro ao baixar thumbnail. Tente abrir a imagem em uma nova aba e salvar manualmente.', 'error');
                    } else {
                        alert('Erro ao baixar thumbnail');
                    }
                }
            };
            
            window.copyVideoLink = function(videoUrl) {
                if (!videoUrl) {
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Erro', 'Link do vídeo não disponível', 'error');
                    } else {
                        alert('Link do vídeo não disponível');
                    }
                    return;
                }
                
                navigator.clipboard.writeText(videoUrl).then(() => {
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Sucesso', 'Link copiado para a área de transferência!', 'success');
                    } else {
                        alert('Link copiado!');
                    }
                }).catch(err => {
                    console.error('Erro ao copiar:', err);
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Erro', 'Erro ao copiar link', 'error');
                    } else {
                        alert('Erro ao copiar link');
                    }
                });
            };
            
            // Função helper para escape HTML (disponível globalmente)
            function escapeHtmlGlobal(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            }
            
            // Funções globais para cruzamento de análises
            window.showCrossAnalysisModal = async function() {
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-analysis/channels`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao carregar canais');
                    }
                    
                    const data = await response.json();
                    const channels = data.channels || [];
                    
                    if (channels.length < 2) {
                        showCustomModal('Aviso', 'Você precisa ter pelo menos 2 canais analisados para cruzar informações.', 'warning');
                        return;
                    }
                    
                    // Função helper local para escape
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = String(text);
                        return div.innerHTML;
                    };
                    
                    // Criar modal
                    const modalHtml = `
                        <div id="cross-analysis-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-800">
                                <div class="p-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-2xl font-bold text-white">🔀 Cruzar Análises e Gerar Conteúdo Viral</h2>
                                        <button onclick="window.closeCrossAnalysisModal()" class="text-gray-400 hover:text-white">
                                            <i data-lucide="x" class="w-6 h-6"></i>
                                        </button>
                                    </div>
                                    <p class="text-gray-400 mb-6">Selecione 2 ou mais canais para cruzar informações e gerar conteúdo inédito viral baseado nos padrões identificados.</p>
                                    
                                    <div class="space-y-3 mb-6 max-h-96 overflow-y-auto">
                                        ${channels.map(channel => `
                                            <label class="flex items-start gap-3 p-3 bg-gray-800 rounded-lg hover:bg-gray-750 cursor-pointer">
                                                <input type="checkbox" value="${channel.id}" class="mt-1 cross-analysis-channel" 
                                                       onchange="window.updateCrossAnalysisButton()">
                                                <div class="flex-1">
                                                    <div class="text-white font-semibold">${escapeHtml(channel.channel_name || 'Canal sem nome')}</div>
                                                    <div class="text-gray-400 text-sm">${(channel.subscriber_count || 0).toLocaleString()} inscritos • ${(channel.total_videos || 0)} vídeos</div>
                                                    <div class="text-gray-500 text-xs mt-1">Nicho: ${escapeHtml(channel.niche || 'Não identificado')}</div>
                                                </div>
                                            </label>
                                        `).join('')}
                                    </div>
                                    
                                    <div class="flex gap-3">
                                        <button onclick="window.closeCrossAnalysisModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-semibold">
                                            Cancelar
                                        </button>
                                        <button id="generate-cross-content-btn" onclick="window.generateCrossAnalysisContent()" 
                                                class="flex-1 bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                                                disabled>
                                            <span id="generate-cross-content-text">Gerar Conteúdo Viral</span>
                                            <span id="generate-cross-content-loading" class="hidden">Gerando...</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    window.updateCrossAnalysisButton();
                } catch (err) {
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Erro', err.message || 'Erro ao abrir modal', 'error');
                    } else {
                        alert('Erro ao abrir modal: ' + err.message);
                    }
                }
            };
            
            window.closeCrossAnalysisModal = function() {
                const modal = document.getElementById('cross-analysis-modal');
                if (modal) modal.remove();
            };
            
            window.updateCrossAnalysisButton = function() {
                const checkboxes = document.querySelectorAll('.cross-analysis-channel:checked');
                const btn = document.getElementById('generate-cross-content-btn');
                if (btn) {
                    btn.disabled = checkboxes.length < 2;
                }
            };
            
            window.generateCrossAnalysisContent = async function() {
                const checkboxes = document.querySelectorAll('.cross-analysis-channel:checked');
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
                
                if (selectedIds.length < 2) {
                    showCustomModal('Aviso', 'Selecione pelo menos 2 canais', 'warning');
                    return;
                }
                
                const btn = document.getElementById('generate-cross-content-btn');
                const btnText = document.getElementById('generate-cross-content-text');
                const btnLoading = document.getElementById('generate-cross-content-loading');
                
                btn.disabled = true;
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                
                try {
                    const token = localStorage.getItem('core_token');
                    const response = await fetch(`${API_BASE}/api/viral-analysis/cross-analyze`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ analysisIds: selectedIds })
                    });
                    
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.msg || 'Erro ao gerar conteúdo');
                    }
                    
                    const data = await response.json();
                    window.closeCrossAnalysisModal();
                    
                    // Exibir resultados
                    displayCrossAnalysisResults(data);
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Sucesso', 'Conteúdo viral gerado com sucesso!', 'success');
                    }
                } catch (err) {
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Erro', err.message || 'Erro ao gerar conteúdo', 'error');
                    } else {
                        alert('Erro ao gerar conteúdo: ' + err.message);
                    }
                } finally {
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }
            };
            
            function displayCrossAnalysisResults(data) {
                const resultsDiv = document.getElementById('cross-analysis-results');
                if (!resultsDiv) return;
                
                // Função helper local para escape
                const escapeHtml = (text) => {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = String(text);
                    return div.innerHTML;
                };
                
                const resultsHtml = `
                    <div class="bg-gray-800 rounded-lg p-6 space-y-6">
                        <h4 class="text-white font-semibold text-xl mb-4">📊 Análise Cruzada - Conteúdo Viral Inédito Gerado</h4>
                        
                        ${data.unexplored_opportunities ? `
                            <div class="bg-gradient-to-r from-amber-900/30 to-orange-900/30 rounded-lg p-4 border border-amber-700/50">
                                <h5 class="text-amber-400 font-semibold mb-3 flex items-center gap-2">
                                    <i data-lucide="lightbulb" class="w-5 h-5"></i>
                                    🎯 Oportunidades Inexploradas Identificadas
                                </h5>
                                ${data.unexplored_opportunities.subniches && Array.isArray(data.unexplored_opportunities.subniches) && data.unexplored_opportunities.subniches.length > 0 ? `
                                    <div class="mb-4">
                                        <span class="text-white font-semibold text-sm mb-2 block">Subnichos com Alta Demanda e Baixa Competição:</span>
                                        <div class="space-y-3">
                                            ${data.unexplored_opportunities.subniches.map((subniche, idx) => `
                                                <div class="bg-gray-900 rounded-lg p-3 border border-amber-600/30">
                                                    <div class="flex items-start justify-between mb-2">
                                                        <span class="text-amber-300 font-semibold text-sm">${idx + 1}. ${escapeHtml(subniche.name || 'Subnicho')}</span>
                                                        <div class="flex gap-2">
                                                            ${subniche.demand_level === 'alta' ? '<span class="px-2 py-0.5 bg-green-600/20 text-green-300 rounded text-xs">Alta Demanda</span>' : ''}
                                                            ${subniche.competition_level === 'baixa' ? '<span class="px-2 py-0.5 bg-blue-600/20 text-blue-300 rounded text-xs">Baixa Competição</span>' : ''}
                                                            ${subniche.monetization_potential === 'alto' ? '<span class="px-2 py-0.5 bg-amber-600/20 text-amber-300 rounded text-xs">Alto Potencial</span>' : ''}
                                                        </div>
                                                    </div>
                                                    ${subniche.why_unexplored ? `<p class="text-gray-300 text-xs mb-1">${escapeHtml(subniche.why_unexplored)}</p>` : ''}
                                                    ${subniche.trend_direction ? `<p class="text-gray-400 text-xs">Tendência: ${escapeHtml(subniche.trend_direction)}</p>` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${data.unexplored_opportunities.content_gaps && Array.isArray(data.unexplored_opportunities.content_gaps) && data.unexplored_opportunities.content_gaps.length > 0 ? `
                                    <div class="mb-3">
                                        <span class="text-white font-semibold text-sm mb-2 block">Gaps de Conteúdo Identificados:</span>
                                        <ul class="list-disc list-inside space-y-1">
                                            ${data.unexplored_opportunities.content_gaps.map(gap => `<li class="text-gray-300 text-sm">${escapeHtml(gap)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${data.unexplored_opportunities.unique_angles && Array.isArray(data.unexplored_opportunities.unique_angles) && data.unexplored_opportunities.unique_angles.length > 0 ? `
                                    <div>
                                        <span class="text-white font-semibold text-sm mb-2 block">Ângulos Únicos Identificados:</span>
                                        <ul class="list-disc list-inside space-y-1">
                                            ${data.unexplored_opportunities.unique_angles.map(angle => `<li class="text-gray-300 text-sm">${escapeHtml(angle)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${data.common_patterns ? `
                            <div class="bg-gray-900 rounded-lg p-4">
                                <h5 class="text-amber-400 font-semibold mb-3">🔍 Padrões Comuns Identificados</h5>
                                ${data.common_patterns.title_patterns ? `
                                    <div class="mb-3">
                                        <span class="text-white font-semibold text-sm">Padrões de Títulos:</span>
                                        <p class="text-gray-300 text-sm mt-1">${escapeHtml(data.common_patterns.title_patterns)}</p>
                                    </div>
                                ` : ''}
                                ${data.common_patterns.engagement_patterns ? `
                                    <div class="mb-3">
                                        <span class="text-white font-semibold text-sm">Padrões de Engagement:</span>
                                        <p class="text-gray-300 text-sm mt-1">${escapeHtml(data.common_patterns.engagement_patterns)}</p>
                                    </div>
                                ` : ''}
                                ${data.common_patterns.content_themes && Array.isArray(data.common_patterns.content_themes) ? `
                                    <div class="mb-3">
                                        <span class="text-white font-semibold text-sm">Temas de Conteúdo:</span>
                                        <ul class="list-disc list-inside mt-1 space-y-1">
                                            ${data.common_patterns.content_themes.map(theme => `<li class="text-gray-300 text-sm">${escapeHtml(theme)}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${data.common_patterns.thumbnail_patterns ? `
                                    <div class="mb-3">
                                        <span class="text-white font-semibold text-sm">Padrões de Thumbnails:</span>
                                        <p class="text-gray-300 text-sm mt-1">${escapeHtml(data.common_patterns.thumbnail_patterns)}</p>
                                    </div>
                                ` : ''}
                                ${data.common_patterns.viral_title_elements && Array.isArray(data.common_patterns.viral_title_elements) ? `
                                    <div>
                                        <span class="text-white font-semibold text-sm">Elementos de Títulos Virais:</span>
                                        <div class="flex flex-wrap gap-2 mt-1">
                                            ${data.common_patterns.viral_title_elements.map(elem => `<span class="px-2 py-1 bg-amber-600/20 text-amber-300 rounded text-xs">${escapeHtml(elem)}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${data.viral_title_analysis && data.viral_title_analysis.viral_titles && Array.isArray(data.viral_title_analysis.viral_titles) && data.viral_title_analysis.viral_titles.length > 0 ? `
                            <div class="bg-gray-900 rounded-lg p-4">
                                <h5 class="text-amber-400 font-semibold mb-3">📝 Análise de Títulos Virais</h5>
                                <div class="space-y-4">
                                    ${data.viral_title_analysis.viral_titles.map((analysis, idx) => `
                                        <div class="bg-gray-800 rounded-lg p-3">
                                            <div class="text-white font-semibold text-sm mb-2">"${escapeHtml(analysis.original_title || 'Título')}"</div>
                                            ${analysis.why_viral ? `
                                                <div class="mb-2">
                                                    <span class="text-amber-400 text-xs font-semibold">Por que viralizou:</span>
                                                    <p class="text-gray-300 text-xs mt-1">${escapeHtml(analysis.why_viral)}</p>
                                                </div>
                                            ` : ''}
                                            ${analysis.key_elements && Array.isArray(analysis.key_elements) && analysis.key_elements.length > 0 ? `
                                                <div class="mb-2">
                                                    <span class="text-amber-400 text-xs font-semibold">Elementos-chave:</span>
                                                    <div class="flex flex-wrap gap-1 mt-1">
                                                        ${analysis.key_elements.map(elem => `<span class="px-2 py-0.5 bg-blue-600/20 text-blue-300 rounded text-xs">${escapeHtml(elem)}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${analysis.variations && Array.isArray(analysis.variations) && analysis.variations.length > 0 ? `
                                                <div>
                                                    <span class="text-amber-400 text-xs font-semibold">Variações virais:</span>
                                                    <ul class="mt-1 space-y-1">
                                                        ${analysis.variations.map((variation, vIdx) => `
                                                            <li class="text-gray-300 text-xs flex items-start gap-2">
                                                                <span class="text-green-400 mt-0.5">•</span>
                                                                <span>${escapeHtml(variation)}</span>
                                                            </li>
                                                        `).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${data.thumbnail_analysis && data.thumbnail_analysis.viral_thumbnails && Array.isArray(data.thumbnail_analysis.viral_thumbnails) && data.thumbnail_analysis.viral_thumbnails.length > 0 ? `
                            <div class="bg-gray-900 rounded-lg p-4">
                                <h5 class="text-amber-400 font-semibold mb-3">🖼️ Análise de Thumbnails Virais</h5>
                                <div class="space-y-3">
                                    ${data.thumbnail_analysis.viral_thumbnails.map((thumb, idx) => `
                                        <div class="bg-gray-800 rounded-lg p-3">
                                            <div class="text-white font-semibold text-xs mb-2">"${escapeHtml(thumb.title || 'Título')}"</div>
                                            ${thumb.visual_elements && Array.isArray(thumb.visual_elements) && thumb.visual_elements.length > 0 ? `
                                                <div class="mb-2">
                                                    <span class="text-amber-400 text-xs font-semibold">Elementos visuais:</span>
                                                    <div class="flex flex-wrap gap-1 mt-1">
                                                        ${thumb.visual_elements.map(elem => `<span class="px-2 py-0.5 bg-purple-600/20 text-purple-300 rounded text-xs">${escapeHtml(elem)}</span>`).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${thumb.thumbnail_title_synergy ? `
                                                <div class="mb-2">
                                                    <span class="text-amber-400 text-xs font-semibold">Sinergia Thumbnail-Título:</span>
                                                    <p class="text-gray-300 text-xs mt-1">${escapeHtml(thumb.thumbnail_title_synergy)}</p>
                                                </div>
                                            ` : ''}
                                            ${thumb.adaptations && Array.isArray(thumb.adaptations) && thumb.adaptations.length > 0 ? `
                                                <div>
                                                    <span class="text-amber-400 text-xs font-semibold">Adaptações sugeridas:</span>
                                                    <ul class="mt-1 space-y-1">
                                                        ${thumb.adaptations.map(adaptation => `
                                                            <li class="text-gray-300 text-xs flex items-start gap-2">
                                                                <span class="text-green-400 mt-0.5">→</span>
                                                                <span>${escapeHtml(adaptation)}</span>
                                                            </li>
                                                        `).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${data.generated_content ? `
                            <div class="bg-gradient-to-r from-green-900/30 to-emerald-900/30 rounded-lg p-4 border border-green-700/50">
                                <h5 class="text-green-400 font-semibold mb-3 flex items-center gap-2">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    ✨ Conteúdo Inédito Viral Gerado
                                </h5>
                                ${data.generated_content.titles && Array.isArray(data.generated_content.titles) && data.generated_content.titles.length > 0 ? `
                                    <div class="mb-4">
                                        <span class="text-white font-semibold text-sm mb-2 block">Títulos Inéditos para Conteúdo Não Explorado (${data.generated_content.titles.length}):</span>
                                        <ul class="space-y-2">
                                            ${data.generated_content.titles.map((title, idx) => `
                                                <li class="text-gray-300 text-sm flex items-start gap-2 bg-gray-800/50 rounded p-2">
                                                    <span class="text-green-400 mt-1 font-bold">${idx + 1}.</span>
                                                    <span class="flex-1">${escapeHtml(title)}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${data.generated_content.unexplored_topics && Array.isArray(data.generated_content.unexplored_topics) && data.generated_content.unexplored_topics.length > 0 ? `
                                    <div class="mb-4">
                                        <span class="text-white font-semibold text-sm mb-2 block">Tópicos Inexplorados Identificados:</span>
                                        <ul class="space-y-1">
                                            ${data.generated_content.unexplored_topics.map(topic => `
                                                <li class="text-gray-300 text-sm flex items-start gap-2">
                                                    <span class="text-green-400 mt-1">•</span>
                                                    <span>${escapeHtml(topic)}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${data.generated_content.content_strategy ? `
                                    <div class="mb-4">
                                        <span class="text-white font-semibold text-sm mb-2 block">Estratégia de Conteúdo:</span>
                                        <p class="text-gray-300 text-sm">${escapeHtml(data.generated_content.content_strategy)}</p>
                                    </div>
                                ` : ''}
                                ${data.generated_content.hooks && Array.isArray(data.generated_content.hooks) && data.generated_content.hooks.length > 0 ? `
                                    <div>
                                        <span class="text-white font-semibold text-sm mb-2 block">Hooks Virais Identificados:</span>
                                        <ul class="space-y-2">
                                            ${data.generated_content.hooks.map((hook, idx) => `
                                                <li class="text-gray-300 text-sm flex items-start gap-2">
                                                    <span class="text-amber-500 mt-1">•</span>
                                                    <span class="flex-1">${escapeHtml(hook)}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${data.recommendations ? `
                            <div class="bg-gray-900 rounded-lg p-4">
                                <h5 class="text-amber-400 font-semibold mb-3">💡 Recomendações Estratégicas</h5>
                                ${typeof data.recommendations === 'object' ? `
                                    ${data.recommendations.strategic_recommendations ? `
                                        <div class="mb-3">
                                            <span class="text-white font-semibold text-sm mb-1 block">Recomendações Estratégicas:</span>
                                            <p class="text-gray-300 text-sm">${escapeHtml(data.recommendations.strategic_recommendations)}</p>
                                        </div>
                                    ` : ''}
                                    ${data.recommendations.monetization_strategy ? `
                                        <div class="mb-3">
                                            <span class="text-white font-semibold text-sm mb-1 block">Estratégia de Monetização:</span>
                                            <p class="text-gray-300 text-sm">${escapeHtml(data.recommendations.monetization_strategy)}</p>
                                        </div>
                                    ` : ''}
                                    ${data.recommendations.content_roadmap && Array.isArray(data.recommendations.content_roadmap) && data.recommendations.content_roadmap.length > 0 ? `
                                        <div class="mb-3">
                                            <span class="text-white font-semibold text-sm mb-1 block">Roadmap de Conteúdo:</span>
                                            <ol class="list-decimal list-inside space-y-1">
                                                ${data.recommendations.content_roadmap.map(item => `<li class="text-gray-300 text-sm">${escapeHtml(item)}</li>`).join('')}
                                            </ol>
                                        </div>
                                    ` : ''}
                                    ${data.recommendations.competitive_advantages && Array.isArray(data.recommendations.competitive_advantages) && data.recommendations.competitive_advantages.length > 0 ? `
                                        <div>
                                            <span class="text-white font-semibold text-sm mb-1 block">Vantagens Competitivas:</span>
                                            <ul class="list-disc list-inside space-y-1">
                                                ${data.recommendations.competitive_advantages.map(advantage => `<li class="text-gray-300 text-sm">${escapeHtml(advantage)}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                ` : `
                                    <p class="text-gray-300 text-sm">${escapeHtml(data.recommendations)}</p>
                                `}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                resultsDiv.innerHTML = resultsHtml;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Remover detecção automática de nicho - agora será detectado durante a análise
            // O nicho e subnicho serão preenchidos automaticamente após a análise do canal
            
            // Função para analisar comentários de um vídeo e gerar títulos
            window.analyzeVideoComments = async function(videoId) {
                try {
                    const token = localStorage.getItem('core_token');
                    showLoadingModal('Analisando comentários e gerando títulos... Isso pode levar alguns segundos.', 'default');
                    
                    const response = await fetch(`${API_BASE}/api/viral-analysis/videos/${videoId}/analyze-comments`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const data = await response.json();
                    document.getElementById('generic-loading-modal')?.remove();
                    
                    if (!response.ok) {
                        throw new Error(data.msg || 'Erro ao analisar comentários');
                    }
                    
                    // Exibir resultados em modal
                    displayCommentsAnalysisResults(data);
                } catch (err) {
                    document.getElementById('generic-loading-modal')?.remove();
                    if (typeof showCustomModal === 'function') {
                        showCustomModal('Erro', err.message || 'Erro ao analisar comentários', 'error');
                    } else {
                        alert('Erro ao analisar comentários: ' + err.message);
                    }
                }
            };
            
            function displayCommentsAnalysisResults(data) {
                const escapeHtml = (text) => {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = String(text);
                    return div.innerHTML;
                };
                
                const analysis = data.analysis || {};
                const insights = analysis.comment_insights || {};
                const titles = analysis.generated_titles || [];
                const formula = analysis.title_structure_formula || 'Não identificada';
                
                const modalHtml = `
                    <div id="comments-analysis-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div class="bg-gray-900 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-800">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold text-white">💬 Análise de Comentários - Títulos Gerados</h2>
                                    <button onclick="document.getElementById('comments-analysis-modal')?.remove()" class="text-gray-400 hover:text-white">
                                        <i data-lucide="x" class="w-6 h-6"></i>
                                    </button>
                                </div>
                                
                                <div class="mb-4 p-3 bg-gray-800 rounded">
                                    <p class="text-white font-semibold">${escapeHtml(data.video?.title || 'Vídeo')}</p>
                                    <p class="text-gray-400 text-sm">${(data.video?.view_count || 0).toLocaleString()} visualizações • ${data.comments_analyzed || 0} comentários analisados</p>
                                </div>
                                
                                ${insights.most_mentioned_topics && Array.isArray(insights.most_mentioned_topics) && insights.most_mentioned_topics.length > 0 ? `
                                    <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                        <h3 class="text-amber-400 font-semibold mb-2">🔍 Tópicos Mais Mencionados</h3>
                                        <div class="flex flex-wrap gap-2">
                                            ${insights.most_mentioned_topics.map(topic => `
                                                <span class="px-2 py-1 bg-amber-600/20 text-amber-300 rounded text-xs">${escapeHtml(topic)}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${insights.common_questions && Array.isArray(insights.common_questions) && insights.common_questions.length > 0 ? `
                                    <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                        <h3 class="text-blue-400 font-semibold mb-2">❓ Perguntas Frequentes</h3>
                                        <ul class="space-y-1">
                                            ${insights.common_questions.map(q => `
                                                <li class="text-gray-300 text-sm">• ${escapeHtml(q)}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${formula && formula !== 'Não identificada' ? `
                                    <div class="bg-gray-800 rounded-lg p-4 mb-4">
                                        <h3 class="text-green-400 font-semibold mb-2">📐 Fórmula de Estrutura do Título</h3>
                                        <p class="text-gray-300 text-sm">${escapeHtml(formula)}</p>
                                    </div>
                                ` : ''}
                                
                                ${titles.length > 0 ? `
                                    <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 rounded-lg p-4 border border-purple-700/50">
                                        <h3 class="text-purple-400 font-semibold mb-3">✨ Títulos Gerados Baseados nos Comentários (${titles.length})</h3>
                                        <ul class="space-y-2 max-h-96 overflow-y-auto">
                                            ${titles.map((title, idx) => `
                                                <li class="text-gray-300 text-sm flex items-start gap-2 bg-gray-800/50 rounded p-2">
                                                    <span class="text-purple-400 mt-1 font-bold">${idx + 1}.</span>
                                                    <span class="flex-1">${escapeHtml(title)}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <div class="mt-4">
                                    <button onclick="document.getElementById('comments-analysis-modal')?.remove()" 
                                            class="w-full bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-semibold">
                                        Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            
            // Event listeners
            document.getElementById('btn-add-viral-channel')?.addEventListener('click', addViralChannel);
            document.getElementById('viral-channel-url')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addViralChannel();
            });
            
            // Tornar funções globais para uso em onclick
            window.analyzeViralChannel = analyzeViralChannel;
            window.viewViralAnalysis = viewViralAnalysis;
            window.deleteViralChannel = deleteViralChannel;

            // Iniciar polling de notificações
            if (userToken && userToken !== 'undefined') {
                // Aguardar um pouco para garantir que tudo está carregado
                setTimeout(() => {
                    startNotificationPolling();
                }, 2000);
            }
            
            // Inicialização: Carregar dashboard e créditos quando a página carrega
            // Garantir que a view 'inicio' está visível por padrão
            const inicioView = document.getElementById('view-inicio');
            if (inicioView) {
                inicioView.style.display = 'block';
                inicioView.classList.add('active'); // Adicionar classe active para o CSS não esconder
                // Esconder todas as outras views
                views.forEach(view => {
                    if (view && view.id !== 'view-inicio') {
                        view.style.display = 'none';
                        view.classList.remove('active');
                    }
                });
            }
            
            setTimeout(async () => {
                loadDashboard();
                // Forçar recálculo do armazenamento ao carregar (opcional, não crítico)
                if (userToken) {
                    try {
                        const recalcResponse = await fetch(`${API_BASE}/api/storage/recalculate`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (recalcResponse.ok) {
                            const recalcData = await recalcResponse.json();
                            console.log('[STORAGE] Armazenamento recalculado:', recalcData);
                        }
                    } catch (err) {
                        // Não é crítico se falhar, o cálculo normal já acontece em loadCreditsBalance
                        console.warn('[STORAGE] Erro ao recalcular armazenamento (não crítico):', err.message);
                    }
                }
                loadCreditsBalance();
                loadCurrentPlan();
                startDashboardAutoRefresh();
            }, 500); // Pequeno delay para garantir que tudo está carregado

        });

    </script>

    <!-- Script de Proteção de Código -->
    <script>
        // Desativa o clique com o botão direito
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Desativa atalhos de teclado
        document.addEventListener('keydown', event => {
            // Bloqueia F12 (Dev Tools)
            if (event.key === 'F12') {
                event.preventDefault();
            }
            // Bloqueia Ctrl+Shift+I (Dev Tools)
            if (event.ctrlKey && event.shiftKey && event.key === 'I') {
                event.preventDefault();
            }
            // Bloqueia Ctrl+U (Ver código-fonte)
            if (event.ctrlKey && event.key === 'U') {
                event.preventDefault();
            }
            // Bloqueia Ctrl+C (Copiar)
            if (event.ctrlKey && event.key === 'C') {
                event.preventDefault();
            }
        });
    </script>

    <!-- Rodapé Elite (Sistema Fechado) -->
    <footer class="mt-12 pb-6 text-center">
        <p class="text-xs text-gray-600 font-light tracking-wider" style="letter-spacing: 0.1em; opacity: 0.5;">
            Sistema privado · Acesso controlado
        </p>
    </footer>

</body>
</html>
</html>

